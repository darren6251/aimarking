<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>darStudy | Admin Console</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'cyber-black': '#050505' },
                    fontFamily: { mono: ['monospace'] }
                }
            }
        }
    </script>
    <style>
        body { background: #050505; color: white; font-family: monospace; }
        .glass { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .glass-panel { background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .neon-input { background: black; border: 1px solid #333; color: white; padding: 10px; width: 100%; transition: 0.3s; outline: none; }
        .neon-input:focus { border-color: white; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .tree-line { border-left: 1px dashed #444; margin-left: 10px; padding-left: 20px; }
        .btn { border: 1px solid #444; padding: 5px 15px; transition: 0.2s; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; }
        .btn:hover { background: white; color: black; }
        .btn-danger { border-color: #522; color: #a55; }
        .btn-danger:hover { background: #500; color: white; border-color: #f00; }
        .loader { width: 40px; height: 40px; border: 2px solid #333; border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        /* Modal Animation */
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- Auth Wrapper (Full Login Flow) -->
    <div id="authWrapper" class="fixed inset-0 z-50 flex items-center justify-center bg-black transition-opacity duration-500">
        <div class="glass-panel p-8 rounded-2xl max-w-md w-full text-center border border-white/10 relative">
            <h1 class="text-3xl font-bold mb-2">dar<span class="text-gray-400">Study</span> ADMIN</h1>
            <p class="text-xs text-gray-500 mb-8 uppercase tracking-widest">Restricted Access</p>
            
            <div id="authContainer" class="flex flex-col gap-4">
                 <div class="loader mx-auto"></div>
            </div>
        </div>
    </div>

    <!-- Rick Roll Container -->
    <div id="rickRollContainer" class="fixed inset-0 z-40 bg-black hidden flex flex-col items-center justify-center">
        <h1 class="text-4xl text-white mb-4 font-bold">ACCESS DENIED</h1>
        <div class="w-full h-full max-w-4xl max-h-[80vh]">
            <iframe id="rickFrame" width="100%" height="100%" src="" frameborder="0" allow="autoplay; encrypted-media"></iframe>
        </div>
        <button id="logoutRickBtn" class="mt-8 btn border-red-500 text-red-500">LOGOUT</button>
    </div>

    <!-- Manager UI (Teacher Only) -->
    <main id="managerUI" class="hidden w-full max-w-5xl p-6">
        <header class="flex justify-between items-center mb-10 border-b border-white/20 pb-4">
            <h1 class="text-2xl font-bold tracking-widest">dar<span class="text-gray-500">Study</span>_ADMIN_CONSOLE</h1>
            <div class="flex gap-4 items-center">
                <span id="adminName" class="text-xs text-gray-400"></span>
                <a href="tutorials.html" class="btn">VIEWER_MODE</a>
                <button id="logoutBtn" class="btn text-red-500 border-red-900">LOGOUT</button>
            </div>
        </header>

        <!-- Access Code Settings -->
        <section class="glass p-6 rounded-lg mb-8">
            <h2 class="text-lg font-bold mb-4 border-l-2 border-white pl-3">DISTRIBUTION_KEY</h2>
            <div class="flex gap-4">
                <input id="teacherCodeInput" type="text" class="neon-input" placeholder="SET_STUDENT_ACCESS_CODE">
                <button id="saveCodeBtn" class="btn whitespace-nowrap px-8">UPDATE PROTOCOL</button>
            </div>
        </section>

        <!-- Content Tree -->
        <section class="glass p-6 rounded-lg min-h-[500px]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold border-l-2 border-white pl-3">DATABASE_STRUCTURE</h2>
                <button onclick="openModal('addSubject')" class="btn bg-white/5">+ INJECT SUBJECT</button>
            </div>
            
            <div id="contentTree" class="space-y-4"></div>
        </section>
    </main>

    <!-- Modals -->
    <div id="genericModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center backdrop-blur-sm">
        <div class="glass p-8 rounded-lg w-full max-w-md modal-enter">
            <h3 id="genericModalTitle" class="text-xl font-bold mb-6">INPUT_REQUIRED</h3>
            <input id="genericInput" type="text" class="neon-input mb-6" placeholder="ENTER_DESIGNATION">
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('genericModal')" class="btn text-gray-400">CANCEL</button>
                <button id="genericSaveBtn" class="btn bg-white text-black">EXECUTE</button>
            </div>
        </div>
    </div>

    <div id="videoModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center backdrop-blur-sm">
        <div class="glass p-8 rounded-lg w-full max-w-lg modal-enter max-h-[90vh] overflow-y-auto">
            <h3 id="videoModalTitle" class="text-xl font-bold mb-6">VIDEO_DATA_ENTRY</h3>
            <form id="videoForm" class="space-y-4">
                <div><label class="text-xs text-gray-500">SOURCE URL</label><input id="vidLink" type="text" class="neon-input" required placeholder="https://youtube.com..."></div>
                <div><label class="text-xs text-gray-500">TITLE</label><input id="vidTitle" type="text" class="neon-input" required></div>
                <div><label class="text-xs text-gray-500">DIFFICULTY</label>
                    <select id="vidDiff" class="neon-input"><option value="U">UNRATED</option><option value="1/5">LEVEL 1</option><option value="2/5">LEVEL 2</option><option value="3/5">LEVEL 3</option><option value="4/5">LEVEL 4</option><option value="5/5">LEVEL 5</option><option value="5/5*">LEVEL 5*</option><option value="5/5**">LEVEL 5** (LETHAL)</option></select>
                </div>
                <div><label class="text-xs text-gray-500">MATERIALS LINK</label><input id="vidMat" type="url" class="neon-input"></div>
                <div><label class="text-xs text-gray-500">NOTES</label><textarea id="vidNotes" class="neon-input h-24 resize-none"></textarea></div>
                <div class="flex justify-end gap-3 pt-4"><button type="button" onclick="closeModal('videoModal')" class="btn text-gray-400">CANCEL</button><button type="submit" class="btn bg-white text-black">UPLOAD</button></div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, where } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentUserProfile = null;

        // --- AUTH LOGIC (Identical Structure to Viewer) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const profileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                    const snap = await getDoc(profileRef);
                    
                    if (snap.exists() && snap.data().role) {
                        currentUserProfile = snap.data();
                        handleRole(currentUserProfile);
                    } else {
                        showCodeEntry(); // Allow them to register even from admin page
                    }
                } catch (e) { showLogin(); }
            } else {
                showLogin();
            }
        });

        // UI Functions
        const authWrapper = document.getElementById('authWrapper');
        const authContainer = document.getElementById('authContainer');
        const managerUI = document.getElementById('managerUI');
        const rickRoll = document.getElementById('rickRollContainer');

        function showLogin() {
            authWrapper.classList.remove('hidden');
            managerUI.classList.add('hidden');
            rickRoll.classList.add('hidden');
            authContainer.innerHTML = `
                <button id="googleSignInButton" class="w-full flex items-center justify-center gap-3 bg-white text-black font-bold py-3 rounded hover:bg-gray-200 transition">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                    <span>Sign in with Google</span>
                </button>
            `;
            document.getElementById('googleSignInButton').onclick = async () => {
                try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(e) { console.error(e); }
            };
        }

        function showCodeEntry() {
            authWrapper.classList.remove('hidden');
            authContainer.innerHTML = `
                <p class="text-sm text-gray-300 mb-2">Registration Required</p>
                <input type="text" id="accessCodeInput" placeholder="Enter Access Code" class="w-full bg-black border border-white/20 p-3 text-center text-white font-mono rounded focus:border-white outline-none">
                <button id="submitCodeButton" class="btn w-full py-3 mt-2 font-bold bg-white text-black">SUBMIT</button>
                <div id="codeError" class="text-red-500 text-xs mt-2 font-mono"></div>
                <button id="backToLogin" class="text-xs text-gray-500 mt-4 underline">Back to Sign In</button>
            `;
            document.getElementById('submitCodeButton').onclick = async () => {
                const code = document.getElementById('accessCodeInput').value.trim();
                let role = null;
                if(code === "Derren0625") role = 'teacher';
                else if(code === "STUDENT456") role = 'student';
                else { document.getElementById('codeError').textContent = 'Invalid Code'; return; }
                const p = { role, name: currentUser.displayName, email: currentUser.email, lastLogin: Date.now() };
                if(role === 'student') p.unlockedTeachers = [];
                await setDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/profile/data`), p, { merge: true });
                currentUserProfile = p;
                handleRole(p);
            };
            document.getElementById('backToLogin').onclick = () => signOut(auth);
        }

        function handleRole(profile) {
            authWrapper.classList.add('hidden');
            if (profile.role === 'teacher') {
                managerUI.classList.remove('hidden');
                document.getElementById('adminName').textContent = `ADMIN_ID: ${profile.name}`;
                if(profile.contentAccessCode) document.getElementById('teacherCodeInput').value = profile.contentAccessCode;
                loadSubjects();
            } else {
                // Rick Roll
                rickRoll.classList.remove('hidden');
                document.getElementById('rickFrame').src = "https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&controls=0";
            }
        }

        document.getElementById('logoutBtn').onclick = () => signOut(auth);
        document.getElementById('logoutRickBtn').onclick = () => signOut(auth);

        // --- TREE RENDERER ---
        async function loadSubjects() {
            const container = document.getElementById('contentTree');
            container.innerHTML = '<div class="text-xs animate-pulse">SYNCING...</div>';
            const q = query(collection(db, `artifacts/${appId}/public/data/tutorials`), where('teacherId', '==', currentUser.uid), orderBy('name'));
            const snap = await getDocs(q);
            container.innerHTML = '';
            if(snap.empty) { container.innerHTML = '<div class="text-gray-500">NO DATA FOUND. INJECT NEW SUBJECT.</div>'; return; }

            snap.forEach(doc => {
                const item = doc.data();
                const div = document.createElement('div');
                div.className = 'glass p-4 rounded mb-2';
                div.innerHTML = `
                    <div class="flex justify-between items-center group">
                        <div class="flex items-center gap-2 cursor-pointer" onclick="toggleExpand('${doc.id}', 1)">
                            <span id="arrow-${doc.id}" class="text-gray-500">►</span><span class="font-bold text-lg">${item.name}</span>
                        </div>
                        <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                            <button onclick="editItem('subject', '${doc.id}', '${item.name}')" class="btn text-xs">EDIT</button>
                            <button onclick="addItem('topic', '${doc.id}')" class="btn text-xs">+ TOPIC</button>
                            <button onclick="deleteItem('tutorials', '${doc.id}')" class="btn-danger text-xs">DEL</button>
                        </div>
                    </div>
                    <div id="children-${doc.id}" class="hidden tree-line mt-2 space-y-2"></div>
                `;
                container.appendChild(div);
            });
        }

        window.toggleExpand = async (id, level) => {
            const children = document.getElementById(`children-${id}`);
            const arrow = document.getElementById(`arrow-${id}`);
            if (!children.classList.contains('hidden')) { children.classList.add('hidden'); arrow.textContent = '►'; return; }
            arrow.textContent = '▼'; children.classList.remove('hidden'); children.innerHTML = '<div class="text-[10px] animate-pulse">FETCHING...</div>';

            let path = '';
            if (level === 1) path = `artifacts/${appId}/public/data/tutorials/${id}/topics`;
            else if (level === 2) {
                 const subjectId = children.parentElement.dataset.parentId;
                 path = `artifacts/${appId}/public/data/tutorials/${subjectId}/topics/${id}/videos`;
            }

            const q = query(collection(db, path), orderBy(level===1?'name':'title'));
            const snap = await getDocs(q);
            children.innerHTML = '';
            if(snap.empty) { children.innerHTML = '<div class="text-[10px] text-gray-600">EMPTY</div>'; return; }

            snap.forEach(d => {
                const item = d.data();
                const div = document.createElement('div');
                div.className = 'p-2 rounded hover:bg-white/5 border border-transparent hover:border-white/10';
                
                if (level === 1) { // Topic
                    div.dataset.parentId = id; 
                    div.innerHTML = `
                        <div class="flex justify-between items-center group">
                            <div class="flex items-center gap-2 cursor-pointer" onclick="toggleExpand('${d.id}', 2)">
                                <span id="arrow-${d.id}" class="text-gray-500 text-xs">►</span><span class="font-bold">${item.name}</span>
                            </div>
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                                <button onclick="editItem('topic', '${d.id}', '${item.name}', '${id}')" class="btn text-[10px]">EDIT</button>
                                <button onclick="addVideo('${id}', '${d.id}')" class="btn text-[10px]">+ VIDEO</button>
                                <button onclick="deleteItem('topic', '${d.id}', '${id}')" class="btn-danger text-[10px]">DEL</button>
                            </div>
                        </div>
                        <div id="children-${d.id}" class="hidden tree-line mt-1 space-y-1" data-parent-id="${id}"></div>
                    `;
                } else { // Video
                    div.innerHTML = `
                        <div class="flex justify-between items-center group">
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500 text-[10px]">●</span><span class="text-sm">${item.title}</span>
                                <span class="text-[10px] bg-white/10 px-1 rounded text-gray-400">${item.difficulty || 'U'}</span>
                            </div>
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                                <button onclick="editVideoData('${children.dataset.parentId}', '${id}', '${d.id}')" class="btn text-[10px]">EDIT</button>
                                <button onclick="deleteItem('video', '${d.id}', '${id}', '${children.dataset.parentId}')" class="btn-danger text-[10px]">DEL</button>
                            </div>
                        </div>
                    `;
                }
                children.appendChild(div);
            });
        };

        // Modal Helpers
        let currentModalAction = null, currentVideoAction = null;
        window.openModal = (type) => {
            if(type === 'addSubject') {
                currentModalAction = async (val) => { await addDoc(collection(db, `artifacts/${appId}/public/data/tutorials`), { name: val, teacherId: currentUser.uid, teacherName: currentUser.displayName }); loadSubjects(); };
                document.getElementById('genericModalTitle').textContent = 'INJECT SUBJECT'; document.getElementById('genericInput').value = ''; document.getElementById('genericModal').classList.replace('hidden', 'flex');
            }
        };
        window.addItem = (type, parentId) => {
             currentModalAction = async (val) => { await addDoc(collection(db, `artifacts/${appId}/public/data/tutorials/${parentId}/topics`), { name: val }); toggleExpand(parentId, 1); toggleExpand(parentId, 1); };
             document.getElementById('genericModalTitle').textContent = 'INJECT TOPIC'; document.getElementById('genericInput').value = ''; document.getElementById('genericModal').classList.replace('hidden', 'flex');
        }
        window.editItem = (type, id, currentName, parentId) => {
            currentModalAction = async (val) => {
                let path = `artifacts/${appId}/public/data/tutorials/${id}`;
                if(type === 'topic') path = `artifacts/${appId}/public/data/tutorials/${parentId}/topics/${id}`;
                await updateDoc(doc(db, path), { name: val });
                if(type === 'subject') loadSubjects(); else { toggleExpand(parentId, 1); toggleExpand(parentId, 1); }
            };
            document.getElementById('genericModalTitle').textContent = `EDIT ${type.toUpperCase()}`; document.getElementById('genericInput').value = currentName; document.getElementById('genericModal').classList.replace('hidden', 'flex');
        };
        document.getElementById('genericSaveBtn').onclick = async () => { const val = document.getElementById('genericInput').value.trim(); if(!val) return; await currentModalAction(val); document.getElementById('genericModal').classList.replace('flex', 'hidden'); };

        window.addVideo = (subjectId, topicId) => {
            document.getElementById('videoForm').reset(); document.getElementById('videoModalTitle').textContent = "UPLOAD VIDEO"; document.getElementById('videoModal').classList.replace('hidden', 'flex');
            currentVideoAction = async (data) => { await addDoc(collection(db, `artifacts/${appId}/public/data/tutorials/${subjectId}/topics/${topicId}/videos`), data); toggleExpand(topicId, 2); toggleExpand(topicId, 2); };
        };
        window.editVideoData = async (subjectId, topicId, videoId) => {
            const ref = doc(db, `artifacts/${appId}/public/data/tutorials/${subjectId}/topics/${topicId}/videos/${videoId}`);
            const data = (await getDoc(ref)).data();
            document.getElementById('vidLink').value = data.link||''; document.getElementById('vidTitle').value = data.title||''; document.getElementById('vidDiff').value = data.difficulty||'U'; document.getElementById('vidMat').value = data.materialsLink||''; document.getElementById('vidNotes').value = data.notes||'';
            document.getElementById('videoModalTitle').textContent = "EDIT VIDEO"; document.getElementById('videoModal').classList.replace('hidden', 'flex');
            currentVideoAction = async (newData) => { await updateDoc(ref, newData); toggleExpand(topicId, 2); toggleExpand(topicId, 2); };
        };
        document.getElementById('videoForm').onsubmit = async (e) => {
            e.preventDefault(); const link = document.getElementById('vidLink').value;
            let type = 'youtube', id = ''; if(link.includes('vimeo')) { type='vimeo'; id=link.split('/').pop(); } else if(link.includes('youtu')) { type='youtube'; id=link.match(/v=([^&]+)/)?.[1]||link.split('/').pop(); } else type='direct';
            const data = { link, videoType: type, videoId: id, title: document.getElementById('vidTitle').value, difficulty: document.getElementById('vidDiff').value, materialsLink: document.getElementById('vidMat').value, notes: document.getElementById('vidNotes').value, updatedAt: Date.now() };
            await currentVideoAction(data); document.getElementById('videoModal').classList.replace('flex', 'hidden');
        };
        window.deleteItem = async (type, id, parentId, grandParentId) => {
            if(!confirm("DELETE?")) return;
            let path; if(type === 'tutorials') path = `artifacts/${appId}/public/data/tutorials/${id}`; else if(type === 'topic') path = `artifacts/${appId}/public/data/tutorials/${parentId}/topics/${id}`; else path = `artifacts/${appId}/public/data/tutorials/${grandParentId}/topics/${parentId}/videos/${id}`;
            await deleteDoc(doc(db, path));
            if(type === 'tutorials') loadSubjects(); else if(type==='topic') { toggleExpand(parentId, 1); toggleExpand(parentId, 1); } else { toggleExpand(parentId, 2); toggleExpand(parentId, 2); }
        };
        window.closeModal = (id) => document.getElementById(id).classList.replace('flex', 'hidden');

        document.getElementById('saveCodeBtn').onclick = async () => {
            const code = document.getElementById('teacherCodeInput').value; if(!code) return;
            await setDoc(doc(db, `artifacts/${appId}/public/data/teacherAccessCodes`, currentUser.uid), { code, teacherName: currentUser.displayName });
            await updateDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/profile/data`), { contentAccessCode: code });
            alert("UPDATED");
        };
    </script>
</body>
</html>
