<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarStudy | Studio</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- PROFESSIONAL MONOCHROME THEME --- */
        :root {
            --bg-body: #ffffff;
            --bg-panel: #f5f5f5;
            --border: #e0e0e0;
            --text-dark: #111111;
            --text-light: #666666;
            --accent: #000000;
        }
        /* Dark Mode Override for consistency with Viewer */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #0a0a0a;
                --bg-panel: #111111;
                --border: #333333;
                --text-dark: #ffffff;
                --text-light: #999999;
                --accent: #ffffff;
            }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        
        body { background: var(--bg-body); color: var(--text-dark); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Auth/Rickroll Container */
        #blockerLayer {
            position: fixed; inset: 0; background: var(--bg-body); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box {
            text-align: center; border: 1px solid var(--border); padding: 40px;
            border-radius: 8px; background: var(--bg-panel); box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .google-btn {
            margin-top: 20px; padding: 10px 20px; background: var(--text-dark); color: var(--bg-body);
            border: none; cursor: pointer; font-weight: 600; border-radius: 4px;
        }

        /* Rickroll Frame */
        #rickrollFrame { position: absolute; inset: 0; width: 100%; height: 100%; border: none; display: none; }

        /* Main Studio UI */
        header {
            height: 60px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 24px;
            background: var(--bg-panel);
        }
        .logo { font-weight: 800; letter-spacing: -0.5px; font-size: 1.2rem; }
        
        main { flex: 1; display: flex; overflow: hidden; }
        
        /* Left Sidebar (Tree) */
        .sidebar { width: 300px; border-right: 1px solid var(--border); overflow-y: auto; background: var(--bg-panel); padding: 20px; }
        .sidebar h3 { font-size: 0.8rem; text-transform: uppercase; color: var(--text-light); margin-bottom: 16px; letter-spacing: 1px; }
        
        .tree-item { margin-bottom: 4px; }
        .tree-header {
            padding: 8px 12px; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9rem; font-weight: 500; transition: background 0.2s;
        }
        .tree-header:hover { background: rgba(128,128,128,0.1); }
        .tree-header.active { background: var(--accent); color: var(--bg-body); }
        
        .tree-actions button {
            background: none; border: none; color: inherit; opacity: 0.5; cursor: pointer; font-size: 1.1rem;
        }
        .tree-actions button:hover { opacity: 1; }

        .nested { margin-left: 16px; padding-left: 8px; border-left: 1px solid var(--border); display: none; margin-top: 4px; }
        .nested.open { display: block; }

        /* Right Content (Editor/List) */
        .editor-area { flex: 1; padding: 40px; overflow-y: auto; }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .btn-primary {
            background: var(--accent); color: var(--bg-body); border: none; padding: 10px 20px;
            border-radius: 4px; font-weight: 600; cursor: pointer;
        }
        
        .video-list { display: flex; flex-direction: column; gap: 12px; }
        .video-item {
            border: 1px solid var(--border); padding: 16px; border-radius: 6px; background: var(--bg-panel);
            display: flex; justify-content: space-between; align-items: center;
        }
        .vid-info h4 { font-size: 1rem; margin-bottom: 4px; }
        .vid-info span { font-size: 0.8rem; color: var(--text-light); }
        
        /* Modals */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: var(--bg-panel); width: 500px; padding: 30px; border-radius: 8px;
            border: 1px solid var(--border);
        }
        .modal-box h2 { margin-bottom: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px; background: var(--bg-body); border: 1px solid var(--border);
            color: var(--text-dark); border-radius: 4px;
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; }
        .btn-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-dark); padding: 10px 20px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <!-- BLOCKER / LOGIN -->
    <div id="blockerLayer">
        <div class="login-box" id="loginBox">
            <h1>DARSTUDY STUDIO</h1>
            <p>Instructors Only</p>
            <button id="loginBtn" class="google-btn">Sign In with Google</button>
            <p id="authMsg" style="margin-top:10px; color:#f00;"></p>
        </div>
        <!-- The Trap -->
        <iframe id="rickrollFrame" src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&controls=0&loop=1&playlist=dQw4w9WgXcQ" allow="autoplay"></iframe>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="mainInterface" style="display:none; height:100%;">
        <header>
            <div class="logo">STUDIO // MANAGE</div>
            <button class="btn-cancel" id="logoutBtn">Logout</button>
        </header>
        <main>
            <div class="sidebar">
                <h3>My Curriculum</h3>
                <div id="subjectList"></div>
                <button id="addSubjectBtn" style="margin-top:20px; width:100%; padding:8px; border:1px dashed var(--border); cursor:pointer;">+ New Subject</button>
            </div>
            
            <div class="editor-area">
                <div id="welcomeState" style="text-align:center; color:var(--text-light); margin-top:100px;">
                    <h2>Select a Topic to Manage Videos</h2>
                    <p>Use the sidebar to navigate your subjects.</p>
                </div>
                
                <div id="videoManagerState" style="display:none;">
                    <div class="header-row">
                        <h2 id="currentTopicTitle">Topic Name</h2>
                        <button class="btn-primary" id="addVideoBtn">+ Add Video</button>
                    </div>
                    <div id="videoList" class="video-list"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL: ADD/EDIT VIDEO -->
    <div id="videoModal" class="modal">
        <div class="modal-box">
            <h2 id="modalTitle">Add Video</h2>
            <form id="videoForm">
                <input type="hidden" id="v_id">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="v_title" required>
                </div>
                <div class="form-group">
                    <label>YouTube Link / URL</label>
                    <input type="text" id="v_link" required placeholder="https://youtube.com/...">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="v_notes" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Difficulty</label>
                    <select id="v_diff">
                        <option value="1/5">1/5 - Easy</option>
                        <option value="3/5">3/5 - Medium</option>
                        <option value="5/5">5/5 - Hard</option>
                        <option value="5/5**">5/5** - Nightmare</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Video</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, getDocs, addDoc, updateDoc, deleteDoc, where } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
          apiKey: "", 
          authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30", storageBucket: "ai-grading-9bb30.appspot.com",
          messagingSenderId: "298162112230", appId: "1:298162112230:web:529d3f95536991be685d27"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let selectedSubjectId = null;
        let selectedTopicId = null;

        // UI ELEMENTS
        const blocker = document.getElementById('blockerLayer');
        const loginBox = document.getElementById('loginBox');
        const rickroll = document.getElementById('rickrollFrame');
        const mainInterface = document.getElementById('mainInterface');
        const subjectList = document.getElementById('subjectList');
        const videoList = document.getElementById('videoList');
        const videoModal = document.getElementById('videoModal');

        // AUTH & ROLE CHECK
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Check Role
                const profileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                const snap = await getDoc(profileRef);
                const role = snap.exists() ? snap.data().role : 'student'; // Default to student if undefined

                if (role === 'student') {
                    // ACTIVATE TRAP
                    loginBox.style.display = 'none';
                    rickroll.style.display = 'block';
                } else if (role === 'teacher') {
                    // SHOW DASHBOARD
                    blocker.style.display = 'none';
                    mainInterface.style.display = 'flex';
                    loadSubjects();
                } else {
                    document.getElementById('authMsg').textContent = "Access denied. Role Unknown.";
                }
            } else {
                // RESET
                blocker.style.display = 'flex';
                loginBox.style.display = 'block';
                rickroll.style.display = 'none';
                mainInterface.style.display = 'none';
            }
        });

        document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        document.getElementById('logoutBtn').onclick = () => signOut(auth);

        // --- DASHBOARD LOGIC ---

        async function loadSubjects() {
            subjectList.innerHTML = 'Loading...';
            // Only fetch subjects created by this teacher
            const q = query(collection(db, `artifacts/${appId}/public/data/tutorials`), where('teacherId', '==', currentUser.uid), orderBy('name'));
            const snap = await getDocs(q);
            
            subjectList.innerHTML = '';
            snap.forEach(d => {
                const subId = d.id;
                const div = document.createElement('div');
                div.className = 'tree-item';
                div.innerHTML = `
                    <div class="tree-header">
                        <span>${d.data().name}</span>
                        <div class="tree-actions">
                            <button onclick="addTopic('${subId}')" title="Add Topic">+</button>
                        </div>
                    </div>
                    <div class="nested" id="subs-${subId}"></div>
                `;
                
                // Toggle expansion
                div.querySelector('.tree-header').onclick = (e) => {
                    if(e.target.tagName === 'BUTTON') return; // Ignore button clicks
                    const n = document.getElementById(`subs-${subId}`);
                    const isOpen = n.classList.contains('open');
                    document.querySelectorAll('.nested').forEach(x => x.classList.remove('open')); // Accordion style
                    if(!isOpen) {
                        n.classList.add('open');
                        loadTopics(subId);
                    }
                };
                subjectList.appendChild(div);
            });
        }

        async function loadTopics(subId) {
            const container = document.getElementById(`subs-${subId}`);
            container.innerHTML = 'Loading...';
            const q = query(collection(db, `artifacts/${appId}/public/data/tutorials/${subId}/topics`), orderBy('name'));
            const snap = await getDocs(q);
            
            container.innerHTML = '';
            snap.forEach(d => {
                const tId = d.id;
                const div = document.createElement('div');
                div.className = 'tree-header';
                div.style.paddingLeft = '24px';
                div.style.fontSize = '0.85rem';
                div.innerHTML = `<span>â€¢ ${d.data().name}</span>`;
                div.onclick = () => selectTopic(subId, tId, d.data().name);
                container.appendChild(div);
            });
            if(snap.empty) container.innerHTML = '<div style="padding:10px; font-size:0.8rem; color:#999;">No topics yet.</div>';
        }

        async function selectTopic(sId, tId, tName) {
            selectedSubjectId = sId; selectedTopicId = tId;
            document.getElementById('welcomeState').style.display = 'none';
            document.getElementById('videoManagerState').style.display = 'block';
            document.getElementById('currentTopicTitle').textContent = tName;
            
            loadVideos();
        }

        async function loadVideos() {
            if(!selectedSubjectId || !selectedTopicId) return;
            videoList.innerHTML = 'Loading videos...';
            
            const q = query(collection(db, `artifacts/${appId}/public/data/tutorials/${selectedSubjectId}/topics/${selectedTopicId}/videos`));
            const snap = await getDocs(q);
            
            videoList.innerHTML = '';
            snap.forEach(doc => {
                const v = doc.data();
                const el = document.createElement('div');
                el.className = 'video-item';
                el.innerHTML = `
                    <div class="vid-info">
                        <h4>${v.title}</h4>
                        <span>${v.difficulty} | ${v.videoType}</span>
                    </div>
                    <div class="tree-actions">
                        <button class="edit-btn" style="opacity:1; margin-right:10px;">âœŽ Edit</button>
                        <button class="del-btn" style="color:red; opacity:1;">ðŸ—‘</button>
                    </div>
                `;
                
                // Bind Edit
                el.querySelector('.edit-btn').onclick = () => openEditModal(doc.id, v);
                
                // Bind Delete
                el.querySelector('.del-btn').onclick = async () => {
                    if(confirm("Delete video?")) {
                        await deleteDoc(doc.id); // Need full path
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/tutorials/${selectedSubjectId}/topics/${selectedTopicId}/videos`, doc.id));
                        loadVideos();
                    }
                };
                
                videoList.appendChild(el);
            });
            if(snap.empty) videoList.innerHTML = '<p>No videos found.</p>';
        }

        // --- ADD/EDIT LOGIC (Fixing the issue) ---
        
        window.addTopic = async (subId) => {
            const n = prompt("Topic Name:");
            if(n) {
                await addDoc(collection(db, `artifacts/${appId}/public/data/tutorials/${subId}/topics`), { name: n });
                loadTopics(subId);
            }
        };

        document.getElementById('addSubjectBtn').onclick = async () => {
            const n = prompt("Subject Name:");
            if(n) {
                await addDoc(collection(db, `artifacts/${appId}/public/data/tutorials`), {
                    name: n, teacherId: currentUser.uid, teacherName: currentUser.displayName
                });
                loadSubjects();
            }
        };

        // Modal Open
        document.getElementById('addVideoBtn').onclick = () => {
            document.getElementById('videoForm').reset();
            document.getElementById('v_id').value = '';
            document.getElementById('modalTitle').textContent = 'Add Video';
            videoModal.style.display = 'flex';
        };

        window.openEditModal = (id, data) => {
            document.getElementById('v_id').value = id;
            document.getElementById('v_title').value = data.title;
            document.getElementById('v_link').value = data.link;
            document.getElementById('v_notes').value = data.notes || '';
            document.getElementById('v_diff').value = data.difficulty;
            document.getElementById('modalTitle').textContent = 'Edit Video';
            videoModal.style.display = 'flex';
        };

        window.closeModal = () => videoModal.style.display = 'none';

        // Form Submit
        document.getElementById('videoForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('v_id').value;
            const link = document.getElementById('v_link').value;
            
            // Parse Link
            let type = 'youtube', vidId = '';
            if(link.includes('vimeo')) { type='vimeo'; vidId=link.split('/').pop(); }
            else if(link.includes('youtu')) { type='youtube'; vidId=link.match(/v=([^&]+)/)?.[1]||link.split('/').pop(); }
            
            const data = {
                title: document.getElementById('v_title').value,
                link: link,
                videoType: type, videoId: vidId,
                notes: document.getElementById('v_notes').value,
                difficulty: document.getElementById('v_diff').value
            };

            const colRef = collection(db, `artifacts/${appId}/public/data/tutorials/${selectedSubjectId}/topics/${selectedTopicId}/videos`);

            if(id) {
                // Update
                await updateDoc(doc(colRef, id), data);
            } else {
                // Add
                await addDoc(colRef, data);
            }
            
            closeModal();
            loadVideos(); // Refresh list
        };

    </script>
</body>
</html>
