<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS // COMMAND</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- HIGH-TECH BLACK & WHITE THEME (MANAGER) --- */
        :root {
            --bg-deep: #050505;
            --bg-card: #0f0f0f;
            --border: #333;
            --text-main: #fff;
            --text-dim: #666;
            --accent-white: #ffffff;
            --danger: #ff3333;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-deep);
            color: var(--text-main);
            min-height: 100vh;
        }
        
        /* Headers */
        h1, h2, h3, button { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }

        /* Auth Container */
        #auth-check-layer {
            position: fixed; inset: 0; background: #000; z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* Main Layout */
        .dashboard-container {
            max-width: 1200px; margin: 0 auto; padding: 2rem;
            display: none; animation: fadeIn 0.5s ease-out;
        }
        
        header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); padding-bottom: 1.5rem; margin-bottom: 2rem;
        }
        
        .code-display {
            background: var(--bg-card); border: 1px solid var(--border);
            padding: 10px 20px; border-radius: 4px; font-family: monospace;
            color: var(--text-dim); display: flex; align-items: center; gap: 10px;
        }
        .code-display span { color: #fff; font-weight: bold; font-size: 1.1rem; }
        
        /* Buttons */
        .btn {
            background: transparent; border: 1px solid var(--border); color: #fff;
            padding: 8px 16px; cursor: pointer; text-transform: uppercase;
            font-size: 0.8rem; transition: 0.2s;
        }
        .btn:hover { background: #fff; color: #000; border-color: #fff; }
        .btn-danger:hover { background: var(--danger); color: #fff; border-color: var(--danger); }
        .btn-primary { background: #fff; color: #000; border-color: #fff; font-weight: bold; }
        .btn-primary:hover { background: #ccc; border-color: #ccc; }

        /* Tree/List Structure */
        .item-row {
            background: var(--bg-card); border: 1px solid var(--border);
            margin-bottom: 1rem; border-radius: 4px;
        }
        
        .row-header {
            padding: 1.2rem; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: 0.2s;
        }
        .row-header:hover { background: #1a1a1a; }
        
        .row-title { font-weight: 600; font-size: 1.1rem; }
        .row-actions { display: flex; gap: 0.5rem; }
        
        .nested-content {
            border-top: 1px solid var(--border);
            background: #0a0a0a;
            padding: 0 1.5rem;
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
        }
        .nested-content.expanded { max-height: 2000px; padding: 1.5rem; }

        /* Level 2 (Topics) */
        .topic-row {
            border: 1px dashed var(--border); margin-bottom: 0.8rem;
            background: var(--bg-deep); padding: 0.8rem; border-radius: 4px;
        }
        .topic-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .topic-videos { margin-top: 0.8rem; padding-left: 1rem; display: none; }
        .topic-videos.open { display: block; }
        
        /* Level 3 (Videos) */
        .video-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.5rem 0; border-bottom: 1px solid #222; font-size: 0.9rem; color: #ccc;
        }
        .video-item:last-child { border-bottom: none; }

        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: #111; border: 1px solid var(--border); width: 500px; max-width: 90%;
            padding: 2rem; box-shadow: 0 0 40px rgba(0,0,0,0.8);
        }
        .modal-title { margin-bottom: 1.5rem; font-size: 1.4rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; }
        .form-input, .form-select, textarea {
            width: 100%; background: #000; border: 1px solid var(--border); color: #fff;
            padding: 10px; font-family: 'Inter', sans-serif;
        }
        textarea { resize: vertical; min-height: 80px; }
        .form-input:focus { border-color: #fff; outline: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <!-- AUTH CHECK & RICKROLL LAYER -->
    <div id="auth-check-layer">
        <h2 style="animation: pulse 1s infinite;">VERIFYING CREDENTIALS...</h2>
    </div>

    <!-- MAIN DASHBOARD -->
    <div class="dashboard-container" id="dashboard">
        <header>
            <div>
                <h1>NEXUS // COMMAND</h1>
                <p style="color:var(--text-dim);">Content Management System</p>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <div class="code-display">
                    ACCESS CODE: <span id="display-access-code">LOADING</span>
                    <button class="btn" id="edit-code-btn" style="padding: 2px 8px; font-size:0.7rem;">EDIT</button>
                </div>
                <button class="btn" id="logout-btn">LOGOUT</button>
            </div>
        </header>

        <div style="margin-bottom: 2rem;">
            <button class="btn btn-primary" id="add-subject-btn">+ NEW SUBJECT</button>
        </div>

        <div id="content-tree">
            <!-- Dynamic Content -->
            <div style="text-align:center; color:#444; padding: 2rem;">INITIALIZING DATA STREAMS...</div>
        </div>
    </div>

    <!-- GENERIC MODAL -->
    <div id="modal-container" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title" id="modal-heading">TITLE</h3>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // FIREBASE INIT
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;
        let globalDataMap = new Map(); // Store video objects by ID for easy editing

        // --- AUTH & SECURITY ---
        onAuthStateChanged(auth, async (user) => {
            const layer = document.getElementById('auth-check-layer');
            if (user) {
                currentUser = user;
                // Check Role
                const pRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                try {
                    const snap = await getDoc(pRef);
                    
                    // If no role logic found, default to student (rickroll) or error
                    if (snap.exists() && snap.data().role === 'teacher') {
                        // ACCESS GRANTED
                        layer.style.display = 'none';
                        document.getElementById('dashboard').style.display = 'block';
                        loadDashboard(snap.data());
                    } else {
                        // RICK ROLL (Students or others)
                        document.body.innerHTML = `<iframe width="100%" height="100%" style="position:fixed; top:0; left:0; border:none;" src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&controls=0&loop=1" allow="autoplay"></iframe>`;
                    }
                } catch(e) { console.error(e); alert("Auth Error"); }
            } else {
                // Not logged in -> Show Google Login
                layer.innerHTML = `
                    <div style="text-align:center;">
                        <h2>RESTRICTED AREA</h2>
                        <button class="btn btn-primary" id="g-login" style="margin-top:2rem; padding:15px 30px; font-size:1rem;">ADMIN LOGIN (GOOGLE)</button>
                    </div>
                `;
                document.getElementById('g-login').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
            }
        });

        document.getElementById('logout-btn').onclick = () => signOut(auth);

        // --- DASHBOARD LOGIC ---
        function loadDashboard(profileData) {
            const codeSpan = document.getElementById('display-access-code');
            codeSpan.textContent = profileData.contentAccessCode || "NOT SET";
            
            document.getElementById('edit-code-btn').onclick = () => {
                const newCode = prompt("Set new Student Access Code:", codeSpan.textContent);
                if(newCode) {
                    // 1. Save to Profile
                    updateDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/profile/data`), { contentAccessCode: newCode });
                    // 2. Save to Public Lookup (so students can find it)
                    setDoc(doc(db, `artifacts/${appId}/public/data/teacherAccessCodes`, currentUser.uid), { code: newCode, teacherName: profileData.name });
                    codeSpan.textContent = newCode;
                }
            };
            
            refreshTree();
        }

        async function refreshTree() {
            const container = document.getElementById('content-tree');
            container.innerHTML = '<div style="text-align:center; padding:1rem;">SYNCING...</div>';
            
            const q = query(collection(db, `artifacts/${appId}/public/data/tutorials`), where("teacherId", "==", currentUser.uid), orderBy("name"));
            const snap = await getDocs(q);
            
            container.innerHTML = '';
            if(snap.empty) {
                container.innerHTML = '<div style="text-align:center; color:#666;">NO SUBJECTS FOUND. START BY ADDING ONE.</div>';
                return;
            }

            // Render Subjects
            for (const d of snap.docs) {
                const sub = d.data();
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <div class="row-header" onclick="toggleSubject('${d.id}')">
                        <div class="row-title">${sub.name}</div>
                        <div class="row-actions">
                            <button class="btn" onclick="event.stopPropagation(); addTopic('${d.id}')">ADD TOPIC</button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); deleteItem('tutorials', ['${d.id}'])">DEL</button>
                        </div>
                    </div>
                    <div class="nested-content" id="sub-${d.id}">
                        <!-- Topics Load Here -->
                    </div>
                `;
                container.appendChild(div);
            }
        }

        // Exposed functions for HTML onclick attributes
        window.toggleSubject = async (subId) => {
            const content = document.getElementById(`sub-${subId}`);
            if(content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                return;
            }
            
            // Load Topics
            content.innerHTML = 'Loading Topics...';
            const q = query(collection(db, `artifacts/${appId}/public/data/tutorials/${subId}/topics`), orderBy("name"));
            const snap = await getDocs(q);
            
            content.innerHTML = '';
            snap.forEach(t => {
                const topic = t.data();
                const tDiv = document.createElement('div');
                tDiv.className = 'topic-row';
                tDiv.innerHTML = `
                    <div class="topic-header" onclick="toggleTopic('${subId}', '${t.id}')">
                        <span>${topic.name}</span>
                        <div class="row-actions">
                            <button class="btn" onclick="event.stopPropagation(); addVideo('${subId}', '${t.id}')">+ VID</button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); deleteItem('tutorials', ['${subId}', '${t.id}', 'topics'])">DEL</button>
                        </div>
                    </div>
                    <div class="topic-videos" id="top-${t.id}"></div>
                `;
                content.appendChild(tDiv);
            });
            content.classList.add('expanded');
        };

        window.toggleTopic = async (subId, topId) => {
            const vCont = document.getElementById(`top-${topId}`);
            if(vCont.classList.contains('open')) {
                vCont.classList.remove('open');
                return;
            }
            
            // Load Videos
            vCont.innerHTML = 'Loading Videos...';
            const q = query(collection(db, `artifacts/${appId}/public/data/tutorials/${subId}/topics/${topId}/videos`)); // order manually?
            const snap = await getDocs(q);
            
            vCont.innerHTML = '';
            if(snap.empty) vCont.innerHTML = '<div style="font-size:0.8rem; color:#444; padding:5px;">No videos yet.</div>';
            
            snap.forEach(v => {
                const vid = v.data();
                globalDataMap.set(v.id, vid); // Store for editing
                
                const vRow = document.createElement('div');
                vRow.className = 'video-item';
                vRow.innerHTML = `
                    <span>${vid.title}</span>
                    <div class="row-actions">
                        <button class="btn" onclick="editVideo('${subId}', '${topId}', '${v.id}')">EDIT</button>
                        <button class="btn btn-danger" onclick="deleteItem('tutorials', ['${subId}', '${topId}', 'videos', '${v.id}'])">DEL</button>
                    </div>
                `;
                vCont.appendChild(vRow);
            });
            vCont.classList.add('open');
        };

        // --- CRUD ACTIONS ---

        // 1. ADD SUBJECT
        document.getElementById('add-subject-btn').onclick = () => {
            showFormModal('New Subject', [{id:'name', label:'Subject Name'}], async (data) => {
                await addDoc(collection(db, `artifacts/${appId}/public/data/tutorials`), {
                    name: data.name, teacherId: currentUser.uid, teacherName: currentUser.displayName
                });
                refreshTree();
            });
        };

        // 2. ADD TOPIC
        window.addTopic = (subId) => {
            showFormModal('New Topic', [{id:'name', label:'Topic Name'}], async (data) => {
                await addDoc(collection(db, `artifacts/${appId}/public/data/tutorials/${subId}/topics`), {
                    name: data.name
                });
                // Force reload of subject
                document.getElementById(`sub-${subId}`).classList.remove('expanded');
                toggleSubject(subId);
            });
        };

        // 3. ADD VIDEO
        window.addVideo = (subId, topId) => {
            const fields = [
                {id:'title', label:'Video Title'},
                {id:'link', label:'YouTube/Vimeo Link', type:'textarea'},
                {id:'notes', label:'Notes', type:'textarea'},
                {id:'diff', label:'Difficulty (1/5 - 5/5)', type:'select', opts:['1/5','2/5','3/5','4/5','5/5']}
            ];
            showFormModal('Add Video', fields, async (data) => {
                let type = 'direct', vId = '';
                if(data.link.includes('youtu')) { type='youtube'; vId=data.link.match(/v=([^&]+)/)?.[1]||data.link.split('/').pop(); }
                if(data.link.includes('vimeo')) { type='vimeo'; vId=data.link.split('/').pop(); }

                await addDoc(collection(db, `artifacts/${appId}/public/data/tutorials/${subId}/topics/${topId}/videos`), {
                    title: data.title, link: data.link, notes: data.notes, difficulty: data.diff,
                    videoType: type, videoId: vId, createdAt: Date.now()
                });
                // Reload Topic
                document.getElementById(`top-${topId}`).classList.remove('open');
                toggleTopic(subId, topId);
            });
        };

        // 4. EDIT VIDEO
        window.editVideo = (subId, topId, vidId) => {
            const v = globalDataMap.get(vidId);
            if(!v) return;
            
            const fields = [
                {id:'title', label:'Video Title', val: v.title},
                {id:'link', label:'YouTube/Vimeo Link', type:'textarea', val: v.link},
                {id:'notes', label:'Notes', type:'textarea', val: v.notes},
                {id:'diff', label:'Difficulty', type:'select', opts:['1/5','2/5','3/5','4/5','5/5'], val: v.difficulty}
            ];
            
            showFormModal('Edit Video', fields, async (data) => {
                 let type = 'direct', vId = '';
                if(data.link.includes('youtu')) { type='youtube'; vId=data.link.match(/v=([^&]+)/)?.[1]||data.link.split('/').pop(); }
                if(data.link.includes('vimeo')) { type='vimeo'; vId=data.link.split('/').pop(); }

                await updateDoc(doc(db, `artifacts/${appId}/public/data/tutorials/${subId}/topics/${topId}/videos`, vidId), {
                    title: data.title, link: data.link, notes: data.notes, difficulty: data.diff,
                    videoType: type, videoId: vId
                });
                document.getElementById(`top-${topId}`).classList.remove('open');
                toggleTopic(subId, topId);
            });
        };

        // 5. DELETE
        window.deleteItem = async (col, pathIds) => {
            if(!confirm("CONFIRM DELETION? This cannot be undone.")) return;
            
            // Logic to construct path based on nesting.
            // pathIds = [subId] OR [subId, topId, 'topics'] OR [subId, topId, 'videos', vidId]
            let ref;
            if(pathIds.length === 1) ref = doc(db, `artifacts/${appId}/public/data/tutorials`, pathIds[0]);
            else if(pathIds.length === 3) ref = doc(db, `artifacts/${appId}/public/data/tutorials/${pathIds[0]}/topics`, pathIds[1]);
            else ref = doc(db, `artifacts/${appId}/public/data/tutorials/${pathIds[0]}/topics/${pathIds[1]}/videos`, pathIds[3]);

            await deleteDoc(ref);
            
            // Refresh
            if(pathIds.length === 1) refreshTree();
            else if(pathIds.length === 3) { document.getElementById(`sub-${pathIds[0]}`).classList.remove('expanded'); toggleSubject(pathIds[0]); }
            else { document.getElementById(`top-${pathIds[1]}`).classList.remove('open'); toggleTopic(pathIds[0], pathIds[1]); }
        };

        // --- MODAL HELPER ---
        const modal = document.getElementById('modal-container');
        const mBody = document.getElementById('modal-body');
        const mTitle = document.getElementById('modal-heading');

        function showFormModal(title, fields, onSubmit) {
            mTitle.textContent = title;
            mBody.innerHTML = '';
            
            const form = document.createElement('form');
            form.onsubmit = (e) => { e.preventDefault(); const res={}; fields.forEach(f => res[f.id] = document.getElementById('in-'+f.id).value); onSubmit(res); modal.style.display='none'; };
            
            fields.forEach(f => {
                const div = document.createElement('div'); div.className='form-group';
                const label = document.createElement('label'); label.textContent = f.label;
                let input;
                if(f.type === 'textarea') {
                    input = document.createElement('textarea');
                } else if(f.type === 'select') {
                    input = document.createElement('select'); input.className='form-select';
                    f.opts.forEach(o => { 
                        const op = document.createElement('option'); op.value=o; op.textContent=o; 
                        if(f.val === o) op.selected = true;
                        input.appendChild(op); 
                    });
                } else {
                    input = document.createElement('input'); input.type = 'text'; input.className='form-input';
                }
                input.id = 'in-' + f.id;
                if(f.val && f.type !== 'select') input.value = f.val;
                
                div.appendChild(label); div.appendChild(input); form.appendChild(div);
            });
            
            const btns = document.createElement('div'); btns.style.display='flex'; btns.style.gap='1rem'; btns.style.marginTop='1.5rem';
            btns.innerHTML = `<button type="submit" class="btn btn-primary">SAVE</button><button type="button" class="btn" id="cancel-modal">CANCEL</button>`;
            
            form.appendChild(btns);
            mBody.appendChild(form);
            
            document.getElementById('cancel-modal').onclick = () => modal.style.display = 'none';
            modal.style.display = 'flex';
        }
    </script>
</body>
</html>
