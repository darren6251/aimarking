<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Marker - Dashboard</title>
  <!-- Chart.js for the nerd stats -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* #region 1. CORE VARIABLES & RESET */
    :root {
        /* Base Colors */
        --bg-body: #050505;
        --bg-card: rgba(20, 20, 20, 0.7);
        --bg-card-hover: rgba(30, 30, 30, 0.8);
        --bg-input: #111;
        
        /* Text */
        --text-main: #ffffff;
        --text-muted: #888888;
        --text-accent: #ffffff;
        
        /* Accents */
        --accent-glow: 0 0 20px rgba(255, 255, 255, 0.15);
        --border-color: rgba(255, 255, 255, 0.08);
        --border-hover: rgba(255, 255, 255, 0.2);
        --primary: #ffffff;
        --danger: #ff4d4d;
        --success: #00e676;
        --warning: #ffb74d;

        /* Glassmorphism */
        --glass-blur: blur(12px);
        --radius-lg: 24px;
        --radius-md: 16px;
        --radius-sm: 8px;
        
        /* Font */
        --font-main: 'Plus Jakarta Sans', sans-serif;
        --font-mono: 'JetBrains Mono', monospace;
    }

    body.light-theme {
        --bg-body: #f0f2f5;
        --bg-card: rgba(255, 255, 255, 0.8);
        --bg-card-hover: rgba(255, 255, 255, 1);
        --bg-input: #f5f5f5;
        --text-main: #111111;
        --text-muted: #666666;
        --text-accent: #000000;
        --accent-glow: 0 4px 20px rgba(0, 0, 0, 0.05);
        --border-color: rgba(0, 0, 0, 0.08);
        --border-hover: rgba(0, 0, 0, 0.2);
        --primary: #000000;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        font-family: var(--font-main);
        background-color: var(--bg-body);
        color: var(--text-main);
        min-height: 100vh;
        overflow-x: hidden;
        background-image: 
            radial-gradient(at 0% 0%, rgba(255,255,255,0.03) 0px, transparent 50%),
            radial-gradient(at 100% 100%, rgba(255,255,255,0.03) 0px, transparent 50%);
        transition: background-color 0.3s ease;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    /* #endregion */

    /* #region 2. COMPONENTS (Buttons, Inputs) */
    button { cursor: pointer; }
    
    .btn-primary {
        background: var(--primary);
        color: var(--bg-body);
        border: none;
        padding: 10px 20px;
        border-radius: var(--radius-sm);
        font-weight: 700;
        font-size: 0.95rem;
        transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--accent-glow); opacity: 0.9; }
    .btn-primary:active { transform: translateY(0); }

    .btn-ghost {
        background: transparent;
        color: var(--text-muted);
        border: 1px solid var(--border-color);
        padding: 8px 16px;
        border-radius: var(--radius-sm);
        font-weight: 600;
        transition: all 0.2s;
    }
    .btn-ghost:hover { border-color: var(--text-main); color: var(--text-main); background: rgba(255,255,255,0.03); }

    .card {
        background: var(--bg-card);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 24px;
        transition: transform 0.3s ease, border-color 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    .card:hover { border-color: var(--border-hover); }

    input, select {
        background: var(--bg-input);
        border: 1px solid var(--border-color);
        color: var(--text-main);
        padding: 10px 14px;
        border-radius: var(--radius-sm);
        font-family: inherit;
        font-size: 0.9rem;
        transition: 0.2s;
        width: 100%;
    }
    input:focus, select:focus { outline: none; border-color: var(--text-muted); }
    /* #endregion */

    /* #region 3. LAYOUT & HEADER */
    #appSection { display: none; flex-direction: column; height: 100vh; animation: fadeIn 0.5s ease-out; }

    /* Sticky Glass Header */
    header {
        position: sticky; top: 0; z-index: 100;
        display: flex; justify-content: space-between; align-items: center;
        padding: 16px 32px;
        background: rgba(5, 5, 5, 0.7);
        backdrop-filter: blur(15px);
        border-bottom: 1px solid var(--border-color);
    }
    
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand h1 { font-weight: 800; font-size: 1.4rem; letter-spacing: -0.5px; }
    .brand span { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; border: 1px solid var(--border-color); padding: 2px 6px; border-radius: 4px; }

    .nav-links { display: flex; gap: 2rem; align-items: center; }
    .nav-link { color: var(--text-muted); text-decoration: none; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
    .nav-link:hover, .nav-link.active { color: var(--text-main); }
    
    .user-controls { display: flex; gap: 12px; align-items: center; }
    
    /* Main Grid Layout - The Bento Box */
    .main-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 20px;
        padding: 30px;
        max-width: 1600px;
        margin: 0 auto;
        width: 100%;
        padding-bottom: 80px; /* Space for footer */
    }

    /* Grid Areas */
    .area-hero { grid-column: span 8; }
    .area-stats { grid-column: span 4; }
    .area-tools { grid-column: span 12; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .area-calendar { grid-column: span 7; }
    .area-todo { grid-column: span 5; }
    .area-xp { grid-column: span 12; }

    @media (max-width: 1024px) {
        .area-hero { grid-column: span 12; }
        .area-stats { grid-column: span 12; display: flex; gap: 20px; }
        .area-stats > * { flex: 1; }
        .area-tools { grid-template-columns: 1fr; }
        .area-calendar, .area-todo { grid-column: span 12; }
    }
    @media (max-width: 768px) {
        .area-stats { flex-direction: column; }
        .main-grid { padding: 15px; gap: 15px; display: flex; flex-direction: column; }
    }
    /* #endregion */

    /* #region 4. SECTIONS (Hero, Tools, Calendar) */
    
    /* Hero Card */
    .hero-card {
        background: linear-gradient(135deg, var(--bg-card) 0%, rgba(255,255,255,0.03) 100%);
        display: flex; flex-direction: column; justify-content: center; min-height: 240px;
    }
    .hero-greeting { font-size: 2.5rem; font-weight: 800; line-height: 1.1; margin-bottom: 10px; letter-spacing: -1px; }
    .hero-greeting span { color: var(--text-muted); }
    .hero-sub { color: var(--text-muted); font-size: 1.1rem; max-width: 600px; }
    .hero-actions { margin-top: 2rem; display: flex; gap: 10px; flex-wrap: wrap; }

    /* Stat Cards (Time & Countdown) */
    .stat-card { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    .stat-value { font-family: var(--font-mono); font-size: 2.5rem; font-weight: 700; letter-spacing: -1px; }
    .stat-label { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
    .stat-sub { font-size: 0.9rem; color: var(--text-muted); margin-top: 5px; }

    /* Tool Widgets (Stopwatch/Timer) */
    .tool-widget { 
        display: flex; flex-direction: column; align-items: center; padding: 20px; 
        border: 1px solid var(--border-color); background: rgba(10,10,10,0.5);
    }
    .tool-widget h3 { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 10px; }
    .digital-display {
        font-family: var(--font-mono); font-size: 3rem; font-weight: 700; 
        background: rgba(0,0,0,0.2); padding: 10px 20px; border-radius: 8px;
        margin-bottom: 15px; width: 100%; text-align: center;
        border: 1px solid rgba(255,255,255,0.05);
    }
    .tool-controls { display: flex; gap: 10px; width: 100%; justify-content: center; }
    .tool-btn { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: transparent; color: var(--text-main); font-weight: 600; font-size: 0.8rem; transition: 0.2s; }
    .tool-btn:hover { background: var(--text-main); color: var(--bg-body); }
    .tool-btn.primary { background: var(--text-main); color: var(--bg-body); }
    
    /* Timer Inputs */
    .timer-inputs { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; }
    .timer-inputs input { width: 50px; text-align: center; background: transparent; font-family: var(--font-mono); font-size: 1.2rem; border: none; border-bottom: 2px solid var(--border-color); border-radius: 0; padding: 0; }
    .timer-inputs input:focus { border-bottom-color: var(--text-main); }
    
    /* XP Section */
    .xp-bar-container { position: relative; height: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; margin: 15px 0; }
    .xp-bar-fill { height: 100%; background: var(--text-main); width: 0%; box-shadow: 0 0 15px rgba(255,255,255,0.3); transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1); }
    .xp-header { display: flex; justify-content: space-between; align-items: flex-end; }
    .xp-badge { background: var(--text-main); color: var(--bg-body); padding: 4px 8px; border-radius: 4px; font-weight: 800; font-size: 0.8rem; }
    
    /* Calendar & Todo */
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    .section-title { font-size: 1.2rem; font-weight: 700; }
    
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .cal-day-name { text-align: center; font-size: 0.8rem; color: var(--text-muted); padding-bottom: 10px; }
    .cal-day { 
        aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
        border-radius: 8px; font-size: 0.9rem; cursor: pointer; position: relative;
        transition: 0.2s; border: 1px solid transparent;
    }
    .cal-day:hover { background: var(--bg-card-hover); border-color: var(--border-color); }
    .cal-day.today { color: var(--success); font-weight: 800; border: 1px solid var(--success); }
    .cal-day.selected { background: var(--text-main); color: var(--bg-body); font-weight: 700; }
    .event-dot { width: 5px; height: 5px; background: var(--text-muted); border-radius: 50%; position: absolute; bottom: 6px; }
    .event-dot.public { background: var(--success); box-shadow: 0 0 5px var(--success); }
    
    /* Todo Items */
    .todo-list { max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    .todo-item { 
        background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; 
        display: flex; align-items: center; gap: 12px; border: 1px solid transparent; transition: 0.2s;
    }
    .todo-item:hover { border-color: var(--border-color); background: rgba(255,255,255,0.05); }
    .todo-status { width: 120px; padding: 4px; font-size: 0.8rem; border: none; background: transparent; color: var(--text-muted); font-weight: 600; text-align: right; cursor: pointer; }
    .todo-content { flex: 1; }
    .todo-text { display: block; font-weight: 500; font-size: 0.95rem; }
    .todo-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
    .todo-actions button { opacity: 0; transition: 0.2s; color: var(--text-muted); background: none; border: none; padding: 4px; }
    .todo-item:hover .todo-actions button { opacity: 1; }
    .todo-actions button:hover { color: var(--danger); transform: scale(1.1); }

    .status-done .todo-text { text-decoration: line-through; opacity: 0.5; }
    .is-due { color: var(--danger); font-weight: 700; }
    .is-due-soon { color: var(--warning); }
    /* #endregion */
    
    /* #region 5. MODALS & UTILS */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center; }
    .modal-content { background: #111; border: 1px solid var(--border-color); padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    #startupAnimation { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; pointer-events: none; }
    #animatedLogo { font-size: 3rem; font-weight: 800; letter-spacing: -2px; }
    .fade-out { opacity: 0; }
    
    #authWrapper { display: flex; height: 100vh; width: 100vw; align-items: center; justify-content: center; background: #050505; }
    .auth-box { width: 100%; max-width: 400px; padding: 40px; text-align: center; }
    .auth-box h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 800; letter-spacing: -1px; }
    /* #endregion */
  </style>
</head>
<body>

  <!-- Startup Loader -->
  <div id="startupAnimation"><div id="animatedLogo">AI MARKER</div></div>

  <!-- Login Screen -->
  <div id="authWrapper" style="display: none;">
    <div class="auth-box">
        <div id="authContainer"><!-- Injected JS --></div>
    </div>
  </div>

  <!-- Main App -->
  <div id="appSection">
    
    <!-- Navbar -->
    <header>
      <div class="brand">
        <h1>AI MARKER</h1>
        <span>BETA</span>
      </div>
      <nav class="nav-links">
        <a href="#" class="nav-link active">Dashboard</a>
        <a href="chat.html" class="nav-link">AI Chat</a>
        <a href="submissions.html" class="nav-link">Tasks</a>
        <a href="materials.html" class="nav-link">Resources</a>
      </nav>
      <div class="user-controls">
        <span id="userDisplayName" style="font-size: 0.9rem; font-weight: 600; cursor: pointer;">Guest</span>
        <button id="themeToggleButton" class="btn-ghost" title="Toggle Theme">‚óê</button>
        <button id="switchRoleButton" class="btn-ghost">Role</button>
        <button id="logoutButton" class="btn-ghost" style="color: var(--danger); border-color: rgba(255, 77, 77, 0.3);">Exit</button>
      </div>
    </header>

    <!-- Bento Grid Layout -->
    <div class="main-grid">
        
        <!-- 1. Hero Section -->
        <div class="card area-hero hero-card">
            <h2 class="hero-greeting">Welcome back, <br><span id="homeUserNamePlaceholder" style="color: var(--text-main);">Student</span>.</h2>
            <p class="hero-sub">Ready to crush the DSE? "You don't have to see the whole staircase, just take the first step."</p>
            <div class="hero-actions">
                <button id="viewAnalyticsBtn" class="btn-primary" style="background: rgba(255,255,255,0.1); border: 1px solid var(--border-color);">View Analytics üìà</button>
                <a href="chat.html" class="btn-primary">Ask AI Tutor ‚Üí</a>
            </div>
            
            <!-- XP System Integrated -->
            <div style="margin-top: auto; padding-top: 20px;">
                 <div class="xp-header">
                    <span style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">Current Progress</span>
                    <span id="xpProgressText" class="xp-badge">Lvl 1</span>
                 </div>
                 <div class="xp-bar-container">
                    <div id="xpProgressBar" class="xp-bar-fill"></div>
                 </div>
                 <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 id="xpBalanceDisplay" style="font-size: 1.5rem; font-weight: 700;">0 XP</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="log-study-btn" class="btn-ghost" style="font-size: 0.8rem;">+ Log Study</button>
                        <button id="redeemHalfDayBtn" class="btn-ghost" disabled style="font-size: 0.8rem;">Redeem</button>
                    </div>
                 </div>
                 <!-- Hidden inputs for logic compatibility -->
                 <div style="display:none;">
                    <input type="date" id="study-date">
                    <input type="number" id="study-hours-input">
                    <input type="number" id="study-minutes-input">
                    <button id="redeemFullDayBtn"></button>
                 </div>
            </div>
        </div>

        <!-- 2. Time & Countdown Stats -->
        <div class="card area-stats">
            <div class="stat-card" style="flex: 1; border-right: 1px solid var(--border-color);">
                <span class="stat-label">Current Time</span>
                <div id="currentTime" class="stat-value">00:00</div>
                <div id="currentDate" class="stat-sub">...</div>
            </div>
            <div class="stat-card" style="flex: 1;">
                <span class="stat-label">DSE Countdown</span>
                <div id="countdown" class="stat-value" style="color: var(--warning);">--:--:--</div>
                <div class="stat-sub">Remains</div>
                <!-- Hidden teacher controls -->
                <div id="teacher-controls" style="display: none; margin-top: 10px;">
                     <input type="datetime-local" id="countdown-datetime" style="font-size: 0.7rem; padding: 4px;">
                     <button id="set-countdown-btn" class="btn-ghost" style="font-size: 0.7rem; padding: 4px;">Set</button>
                </div>
            </div>
        </div>

        <!-- 3. Tools Row (Stopwatch / Timer) -->
        <div class="area-tools">
            <div class="card tool-widget">
                <h3>Stopwatch</h3>
                <div id="stopwatchDisplay" class="digital-display">00:00:00</div>
                <div class="tool-controls">
                    <button id="startStopwatchBtn" class="tool-btn primary">Start</button>
                    <button id="stopStopwatchBtn" class="tool-btn" style="display:none; color: var(--danger); border-color: var(--danger);">Stop</button>
                    <button id="resetStopwatchBtn" class="tool-btn">Reset</button>
                </div>
            </div>
            
            <div class="card tool-widget" style="grid-column: span 2;">
                <h3>Focus Timer</h3>
                <div style="display: flex; gap: 20px; width: 100%; align-items: center;">
                    <div style="flex: 1;">
                        <div id="timerDisplay" class="digital-display">00:00:00</div>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                        <div id="timerInputs" class="timer-inputs">
                            <input type="number" id="timerHours" placeholder="00" min="0"><span>:</span>
                            <input type="number" id="timerMinutes" placeholder="00" min="0" max="59"><span>:</span>
                            <input type="number" id="timerSeconds" placeholder="00" min="0" max="59">
                        </div>
                        <div class="tool-controls">
                            <button id="startTimerBtn" class="tool-btn primary">Start Timer</button>
                            <button id="stopTimerBtn" class="tool-btn" style="display:none; color: var(--danger); border-color: var(--danger);">Stop</button>
                            <button id="resetTimerBtn" class="tool-btn">Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Calendar Section -->
        <div class="card area-calendar">
            <div class="section-header">
                <span class="section-title">Schedule</span>
                <div style="display: flex; gap: 10px;">
                    <select id="month-select" style="width: auto; background: transparent; border: none; font-weight: 700; color: var(--text-main); cursor: pointer;"></select>
                    <select id="year-select" style="width: auto; background: transparent; border: none; font-weight: 700; color: var(--text-muted); cursor: pointer;"></select>
                    <button id="today-btn" class="btn-ghost" style="padding: 4px 10px;">Today</button>
                </div>
            </div>
            
            <div class="calendar-grid" id="calendar-grid">
                <!-- JS Injected -->
            </div>

            <div id="event-list-container" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                <h4 id="event-list-header" style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px;">Selected Date</h4>
                <div id="event-list" style="min-height: 50px;"></div>
                
                <form id="add-event-form" style="display: flex; gap: 10px; margin-top: 15px;">
                    <input type="time" id="event-time" style="width: auto;">
                    <input type="text" id="event-desc" placeholder="Add new event..." required>
                    <input type="date" id="event-date" style="display:none;"> <!-- Hidden, handled by JS -->
                    <button type="submit" id="add-event-btn" class="btn-primary" style="padding: 0 15px;">+</button>
                    <div id="public-event-container" style="display:none;"><input type="checkbox" id="public-event-checkbox"></div>
                </form>
            </div>
        </div>

        <!-- 5. Todo Section -->
        <div class="card area-todo">
             <div class="section-header">
                <span class="section-title">Tasks</span>
                <span class="btn-ghost" style="font-size: 0.7rem;">Sort: Auto</span>
            </div>
            
            <div id="todo-list" class="todo-list">
                <!-- JS Injected -->
            </div>
            
            <form id="add-todo-form" style="margin-top: 15px; display: flex; flex-direction: column; gap: 10px;">
                <input type="text" id="todo-input" placeholder="New task or note..." required style="background: rgba(255,255,255,0.05); border: none;">
                <div style="display: flex; gap: 10px;">
                    <input type="date" id="todo-deadline" title="Deadline">
                    <button type="submit" id="add-todo-btn" class="btn-primary">Add Task</button>
                </div>
            </form>
        </div>
        
        <!-- 6. XP History (Collapsed/Hidden usually, kept for logic) -->
        <div class="card area-xp" style="display: none;">
             <div id="study-history-container">
                 <div id="study-history-list"></div>
             </div>
        </div>
        
    </div> <!-- End Main Grid -->

  </div> <!-- End App Section -->

  <!-- Modals (Kept Functional) -->
  <div id="messageModal" class="modal">
      <div class="modal-content">
          <span class="close-button" style="float: right; cursor: pointer; font-size: 1.5rem;">&times;</span>
          <h3 id="modalTitle" style="margin-bottom: 15px; font-weight: 800;">Message</h3>
          <div id="modalMessage" style="color: var(--text-muted); margin-bottom: 20px;"></div>
          <div id="modalButtons" style="display: flex; justify-content: flex-end; gap: 10px;"></div>
      </div>
  </div>
  
  <div id="analyticsModal" class="modal">
      <div class="modal-content" style="max-width: 800px;">
          <span class="close-button analytics-close-button" style="float: right; cursor: pointer;">&times;</span>
          <h3>Study Analytics</h3>
          <div class="chart-container"><canvas id="studyChart"></canvas></div>
      </div>
  </div>
  
  <div id="profileEditModal" class="modal">
      <div class="modal-content">
          <span class="close-button profile-close-button" style="float: right; cursor: pointer;">&times;</span>
          <h3>Edit Profile</h3>
          <div style="display: flex; flex-direction: column; gap: 15px; margin: 20px 0;">
              <input type="text" id="editUserName" placeholder="Display Name">
              <input type="text" id="editUserEmail" disabled>
              <input type="text" id="editUserRole" disabled>
          </div>
          <div style="display: flex; justify-content: flex-end; gap: 10px;">
             <button id="cancelProfileButton" class="btn-ghost">Cancel</button>
             <button id="saveProfileButton" class="btn-primary">Save</button>
          </div>
      </div>
  </div>

  <!-- FIREBASE LOGIC (UNCHANGED) -->
  <script type="module">
    // #region FIREBASE IMPORTS
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, onSnapshot, addDoc, where, serverTimestamp, limit, increment } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";
    // #endregion

    // #region GLOBAL VARIABLES & CONFIG
    const TEACHER_CODE = "DDDDDDDD";
    const STUDENT_CODE = "STUDENT456";
    const firebaseConfig = {
      apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
      authDomain: "ai-grading-9bb30.firebaseapp.com",
      projectId: "ai-grading-9bb30",
      storageBucket: "ai-grading-9bb30.appspot.com",
      messagingSenderId: "298162112230",
      appId: "1:298162112230:web:529d3f95536991be685d27",
      measurementId: "G-CHKLKSM17S"
    };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let app, db, auth, storage;
    let currentUserId = null, currentUserEmail = null, currentUserRole = null, currentUserName = null;
    let countdownInterval;
    
    // State variables
    let currentSelectedDate = new Date();
    let currentMonth = currentSelectedDate.getMonth();
    let currentYear = currentSelectedDate.getFullYear();
    let personalEvents = [], publicEvents = [], todoItems = [];
    let unsubscribePersonalEvents = () => {}, unsubscribePublicEvents = () => {}, unsubscribeTodos = () => {};
    let xpBalance = 0, studyHistory = [];
    let unsubscribeProfile = () => {}, unsubscribeStudyHistory = () => {};

    // Timer State
    let stopwatchInterval = null, stopwatchStartTime = 0, stopwatchElapsedTime = 0, stopwatchRunning = false;
    let timerInterval = null, timerTotalTime = 0, timerTimeRemaining = 0, timerRunning = false, timerAudioContext = null, timerBeepNode = null;
    
    // Chart State
    let studyChart = null;
    // #endregion

    // #region INITIALIZATION & AUTH
    const authWrapper = document.getElementById('authWrapper');
    const appSection = document.getElementById('appSection');
    const authContainer = document.getElementById('authContainer');
    const userDisplayNameSpan = document.getElementById('userDisplayName');
    const startupAnimation = document.getElementById('startupAnimation');
    const headerLogo = document.querySelector('header .brand h1'); // UPDATED SELECTOR

    const googleSignInTemplate = `
        <h1>Sign In</h1>
        <button id="googleSignInButton" class="btn-primary" style="background: #fff; color: #000; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" height="20">
            <span>Continue with Google</span>
        </button>
        <p id="authError" style="color: var(--danger); margin-top: 10px; font-size: 0.9rem;"></p>
    `;

    const codeEntryTemplate = `
        <h1>Access Code</h1>
        <p style="color: var(--text-muted); margin-bottom: 20px;">Enter your student or teacher code</p>
        <input type="text" id="accessCodeInput" placeholder="Code..." style="margin-bottom: 15px; text-align: center; font-size: 1.2rem;">
        <button id="submitCodeButton" class="btn-primary" style="width:100%">Submit Code</button>
        <p id="codeError" style="color: var(--danger); margin-top: 10px; font-size: 0.9rem;"></p>
    `;

    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        storage = getStorage(app);
        console.log("Firebase initialized.");
    } catch (error) {
        console.error("Firebase Init Error:", error);
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserId = user.uid;
            currentUserEmail = user.email;
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            try {
                const userProfileDoc = await getDoc(userProfileRef);
                if (userProfileDoc.exists() && userProfileDoc.data().role) {
                    const profileData = userProfileDoc.data();
                    currentUserRole = profileData.role;
                    currentUserName = profileData.name || user.displayName;
                    const updateData = { name: currentUserName, email: currentUserEmail, lastLogin: Date.now() };
                    if (profileData.xpBalance === undefined) updateData.xpBalance = 0;
                    await setDoc(userProfileRef, updateData, { merge: true });
                    showApp();
                } else {
                    currentUserName = user.displayName;
                    currentUserRole = 'unassigned';
                    await setDoc(userProfileRef, { 
                        name: currentUserName, email: currentUserEmail, role: 'unassigned', xpBalance: 0, lastLogin: Date.now()
                    }, { merge: true });
                    showCodeEntry();
                }
            } catch (e) {
                 console.error("Profile Error:", e);
                 showLogin();
            }
        } else {
            currentUserId = null; currentUserRole = null; currentUserName = null; xpBalance = 0; studyHistory = [];
            unsubscribePersonalEvents(); unsubscribePublicEvents(); unsubscribeTodos(); unsubscribeProfile(); unsubscribeStudyHistory();
            personalEvents = []; publicEvents = []; todoItems = [];
            showLogin();
        }
    });

    function showLogin() {
        appSection.style.display = 'none';
        authWrapper.style.display = 'flex';
        startupAnimation.classList.add('fade-out'); // Quick fade
        setTimeout(() => startupAnimation.style.display = 'none', 500);
        
        authContainer.innerHTML = googleSignInTemplate;
        document.getElementById('googleSignInButton')?.addEventListener('click', handleGoogleSignIn);
    }

    function showCodeEntry() {
        appSection.style.display = 'none';
        authWrapper.style.display = 'flex';
        startupAnimation.classList.add('fade-out');
        setTimeout(() => startupAnimation.style.display = 'none', 500);

        authContainer.innerHTML = codeEntryTemplate;
        const submitCodeBtn = document.getElementById('submitCodeButton');
        const accessCodeInput = document.getElementById('accessCodeInput');
        submitCodeBtn?.addEventListener('click', () => handleSubmitCode());
        accessCodeInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); handleSubmitCode(); }
        });
        accessCodeInput?.focus();
    }

    async function showApp() {
        authWrapper.style.display = 'none';
        appSection.style.display = 'flex';
        userDisplayNameSpan.textContent = currentUserName;
        document.getElementById('homeUserNamePlaceholder').textContent = currentUserName;
        
        // Show teacher controls
        if (currentUserRole === 'teacher') {
            document.getElementById('teacher-controls').style.display = 'block';
            document.getElementById('public-event-container').style.display = 'block';
        } else {
             document.getElementById('teacher-controls').style.display = 'none';
             document.getElementById('public-event-container').style.display = 'none';
        }

        // Animation logic
        startupAnimation.style.display = 'flex';
        startupAnimation.classList.remove('fade-out');
        setTimeout(() => { startupAnimation.classList.add('fade-out'); setTimeout(() => startupAnimation.style.display = 'none', 500); }, 1500);

        startClocks();
        listenForCountdownChanges();
        initDashboard();
        
        if (currentUserId) {
            listenForPersonalEvents();
            listenForPublicEvents();
            listenForTodos();
            listenForProfileChanges();
            listenForStudyHistory();
        }
    }

    async function handleGoogleSignIn() {
        const provider = new GoogleAuthProvider();
        try { await signInWithPopup(auth, provider); } catch (error) { 
            document.getElementById('authError').textContent = `Error: ${error.message}`; 
        }
    }

    async function handleSubmitCode(codeValue) {
        const code = (codeValue || document.getElementById('accessCodeInput').value).trim();
        const codeError = document.getElementById('codeError');
        if(codeError) codeError.textContent = '';
        
        let roleToSet = null;
        if (code === TEACHER_CODE) roleToSet = 'teacher';
        else if (code === STUDENT_CODE) roleToSet = 'student';
        else { if(codeError) codeError.textContent = 'Invalid code.'; return; }
        
        try {
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            await setDoc(userProfileRef, { role: roleToSet }, { merge: true });
            currentUserRole = roleToSet;
            showApp();
        } catch (error) {
            if(codeError) codeError.textContent = `Error: ${error.message}`;
        }
    }

    document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));
    document.getElementById('switchRoleButton').addEventListener('click', () => {
        showInputModal('Switch Role', 'Enter new access code:', async (code) => { await handleSubmitCode(code); });
    });
    
    // Profile Edit
    userDisplayNameSpan.addEventListener('click', async () => {
        if (!currentUserId) return;
        const profileEditModal = document.getElementById('profileEditModal');
        const editUserNameInput = document.getElementById('editUserName');
        const editUserEmailInput = document.getElementById('editUserEmail');
        const editUserRoleInput = document.getElementById('editUserRole');
        const saveProfileButton = document.getElementById('saveProfileButton');
        const cancelProfileButton = document.getElementById('cancelProfileButton');

        editUserNameInput.value = currentUserName || '';
        editUserEmailInput.value = currentUserEmail || '';
        editUserRoleInput.value = currentUserRole || '';
        profileEditModal.style.display = 'flex';

        const saveHandler = async () => {
            const newName = editUserNameInput.value.trim();
            if (!newName) return;
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await updateDoc(userProfileRef, { name: newName });
                currentUserName = newName;
                userDisplayNameSpan.textContent = currentUserName;
                document.getElementById('homeUserNamePlaceholder').textContent = currentUserName;
                profileEditModal.style.display = 'none';
            } catch (error) { showModal('Error', error.message); }
            saveProfileButton.removeEventListener('click', saveHandler);
            cancelProfileButton.removeEventListener('click', cancelHandler);
        };
        const cancelHandler = () => {
            profileEditModal.style.display = 'none';
            saveProfileButton.removeEventListener('click', saveHandler);
            cancelProfileButton.removeEventListener('click', cancelHandler);
        };
        saveProfileButton.addEventListener('click', saveHandler);
        cancelProfileButton.addEventListener('click', cancelHandler);
        document.querySelector('.profile-close-button').addEventListener('click', cancelHandler);
    });
    // #endregion

    // #region TIME & COUNTDOWN
    function startClocks() {
        const currentTimeEl = document.getElementById('currentTime');
        const currentDateEl = document.getElementById('currentDate');
        setInterval(() => {
            const now = new Date();
            currentTimeEl.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            currentDateEl.textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }, 1000);
    }
    function updateCountdown(targetDate) {
        const countdownEl = document.getElementById('countdown');
        if (countdownInterval) clearInterval(countdownInterval);
        if (!targetDate) { countdownEl.textContent = "--:--:--"; return; }

        countdownInterval = setInterval(() => {
            const now = new Date().getTime();
            const distance = targetDate - now;
            if (distance < 0) { clearInterval(countdownInterval); countdownEl.textContent = "DONE"; return; }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            countdownEl.textContent = `${days}d ${hours}h`;
        }, 1000);
    }
    function listenForCountdownChanges() {
        const countdownRef = doc(db, `artifacts/${appId}/public/data/settings/countdown`);
        onSnapshot(countdownRef, (doc) => {
            if (doc.exists()) { updateCountdown(doc.data().target ? doc.data().target.toDate() : null); } 
            else { updateCountdown(null); }
        });
    }
    document.getElementById('set-countdown-btn').addEventListener('click', async () => {
        const datetimeInput = document.getElementById('countdown-datetime').value;
        if (!datetimeInput) return;
        const targetDate = new Date(datetimeInput);
        try {
            const countdownRef = doc(db, `artifacts/${appId}/public/data/settings/countdown`);
            await setDoc(countdownRef, { target: targetDate });
        } catch (error) { console.error(error); }
    });
    // #endregion

    // #region THEME
    const themeToggleButton = document.getElementById('themeToggleButton');
    function applyTheme(theme) { 
        document.body.classList.toggle('light-theme', theme === 'light'); 
        if(studyChart) renderAnalyticsChart();
    }
    function loadTheme() { applyTheme(localStorage.getItem('ai-marker-theme') || 'dark'); }
    themeToggleButton.addEventListener('click', () => {
        const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';
        applyTheme(newTheme); localStorage.setItem('ai-marker-theme', newTheme);
    });
    loadTheme();
    // #endregion

    // #region DASHBOARD (Calendar & Todo)
    const calendarGrid = document.getElementById('calendar-grid');
    const eventListHeader = document.getElementById('event-list-header');
    const eventList = document.getElementById('event-list');
    const addEventForm = document.getElementById('add-event-form');
    const eventDateInput = document.getElementById('event-date');
    const eventTimeInput = document.getElementById('event-time');
    const eventDescInput = document.getElementById('event-desc');
    const publicEventCheckbox = document.getElementById('public-event-checkbox');
    const todoList = document.getElementById('todo-list');
    const addTodoForm = document.getElementById('add-todo-form');
    const todoInput = document.getElementById('todo-input');
    const todoDeadlineInput = document.getElementById('todo-deadline');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    const todayBtn = document.getElementById('today-btn');
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    function initDashboard() {
        months.forEach((month, index) => { const option = document.createElement('option'); option.value = index; option.textContent = month; monthSelect.appendChild(option); });
        const currentYear = new Date().getFullYear();
        for (let i = currentYear - 2; i <= currentYear + 2; i++) { const option = document.createElement('option'); option.value = i; option.textContent = i; yearSelect.appendChild(option); }
        
        updateCalendarState(new Date());
        
        monthSelect.addEventListener('change', handleMonthYearChange);
        yearSelect.addEventListener('change', handleMonthYearChange);
        todayBtn.addEventListener('click', () => updateCalendarState(new Date()));
        addEventForm.addEventListener('submit', handleAddEvent);
        addTodoForm.addEventListener('submit', handleAddTodo);
        todoList.addEventListener('change', handleTodoStatusChange);
        
        // XP Listeners
        // NOTE: We now use showInputModal for logging to keep UI clean
        document.getElementById('log-study-btn').addEventListener('click', () => {
            showInputModal("Log Study Time", "Enter hours (e.g. 1.5):", (val) => {
               // Dirty hack to reuse existing logic
               const hours = parseFloat(val);
               if(isNaN(hours)) return;
               document.getElementById('study-date').value = toLocalISODate(new Date());
               document.getElementById('study-hours-input').value = Math.floor(hours);
               document.getElementById('study-minutes-input').value = (hours - Math.floor(hours)) * 60;
               handleLogStudy();
            });
        });
        
        document.getElementById('redeemHalfDayBtn').addEventListener('click', handleRedeemPoints);
        document.getElementById('viewAnalyticsBtn').addEventListener('click', openAnalyticsModal);
        document.querySelector('.analytics-close-button').addEventListener('click', () => document.getElementById('analyticsModal').style.display = 'none');

        // Timer Listeners
        document.getElementById('startStopwatchBtn').addEventListener('click', startStopwatch);
        document.getElementById('stopStopwatchBtn').addEventListener('click', stopStopwatch);
        document.getElementById('resetStopwatchBtn').addEventListener('click', resetStopwatch);
        document.getElementById('startTimerBtn').addEventListener('click', startTimer);
        document.getElementById('stopTimerBtn').addEventListener('click', stopTimer);
        document.getElementById('resetTimerBtn').addEventListener('click', resetTimer);
        
        const initAudio = () => { if (!timerAudioContext) timerAudioContext = new (window.AudioContext || window.webkitAudioContext)(); document.body.removeEventListener('click', initAudio); };
        document.body.addEventListener('click', initAudio, { once: true });
        document.body.addEventListener('keydown', initAudio, { once: true });
    }
    
    function handleMonthYearChange() {
        currentMonth = parseInt(monthSelect.value); currentYear = parseInt(yearSelect.value); renderCalendar();
    }
    function updateCalendarState(date) {
        currentSelectedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        currentMonth = currentSelectedDate.getMonth(); currentYear = currentSelectedDate.getFullYear();
        monthSelect.value = currentMonth; yearSelect.value = currentYear;
        eventDateInput.value = toLocalISODate(currentSelectedDate);
        document.getElementById('study-date').value = toLocalISODate(new Date()); 
        renderCalendar(); renderEventsForDay();
    }
    function renderCalendar() {
        while (calendarGrid.children.length > 7) calendarGrid.removeChild(calendarGrid.lastChild);
        
        // Add headers first (Mon, Tue...) if needed, but we use CSS grid now so maybe just raw days? 
        // Let's add simple day headers
        const days = ['S','M','T','W','T','F','S'];
        calendarGrid.innerHTML = ''; // Reset
        days.forEach(d => { const div = document.createElement('div'); div.className='cal-day-name'; div.textContent=d; calendarGrid.appendChild(div); });

        const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const today = new Date();

        for (let i = 0; i < firstDayOfMonth; i++) {
            const dayEl = document.createElement('div'); calendarGrid.appendChild(dayEl); // Empty slot
        }
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            const dayDate = new Date(currentYear, currentMonth, i);
            const dateStr = toLocalISODate(dayDate);
            dayEl.className = 'cal-day'; dayEl.textContent = i; dayEl.dataset.date = dateStr;

            if (isSameDay(dayDate, today)) dayEl.classList.add('today');
            if (isSameDay(dayDate, currentSelectedDate)) dayEl.classList.add('selected');
            
            const hasPublicEvent = publicEvents.some(e => e.date === dateStr);
            const hasPersonalEvent = personalEvents.some(e => e.date === dateStr);
            if (hasPublicEvent || hasPersonalEvent) {
                const marker = document.createElement('div'); marker.className = 'event-dot';
                if (hasPublicEvent) marker.classList.add('public');
                dayEl.appendChild(marker);
            }
            dayEl.addEventListener('click', () => updateCalendarState(dayDate));
            calendarGrid.appendChild(dayEl);
        }
    }
    function renderEventsForDay() {
        eventList.innerHTML = '';
        const selectedDateStr = toLocalISODate(currentSelectedDate);
        eventListHeader.textContent = `${currentSelectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}`;
        
        const dayEvents = [...personalEvents.filter(e => e.date === selectedDateStr), ...publicEvents.filter(e => e.date === selectedDateStr)];
        dayEvents.sort((a, b) => a.time.localeCompare(b.time));

        if (dayEvents.length === 0) { eventList.innerHTML = `<p style="color: var(--text-muted); font-size: 0.8rem; text-align: center; padding: 10px;">No events.</p>`; return; }

        dayEvents.forEach(event => {
            const isPublicEvent = event.isPublic; 
            const eventItem = document.createElement('div'); 
            // Simple row style
            eventItem.className = 'event-item';
            eventItem.dataset.id = event.id; eventItem.dataset.isPublic = isPublicEvent;
            
            eventItem.innerHTML = `
                <div style="flex:1;">
                    <div style="font-size:0.75rem; color:var(--text-muted);">${event.time} ${isPublicEvent ? '‚Ä¢ PUBLIC' : ''}</div>
                    <div style="font-weight:600;">${event.description}</div>
                </div>
                ${(currentUserRole === 'teacher' || !isPublicEvent) ? '<button class="delete-event" style="background:none; border:none; color:var(--text-muted); cursor:pointer;">&times;</button>' : ''}
            `;
            
            const delBtn = eventItem.querySelector('.delete-event');
            if(delBtn) delBtn.addEventListener('click', handleDeleteEvent);
            
            eventList.appendChild(eventItem);
        });
    }

    function renderTodos() {
        todoList.innerHTML = '';
        
        const sortedTodos = [...todoItems].sort((a, b) => {
            const statusOrder = { 'not-started': 1, 'half-done': 2, 'full-done': 3 };
            const statusDiff = (statusOrder[a.status] || 0) - (statusOrder[b.status] || 0);
            if (statusDiff !== 0) return statusDiff;
            if (!a.deadline && b.deadline) return -1;
            if (a.deadline && !b.deadline) return 1;
            if (a.deadline && b.deadline) return a.deadline.localeCompare(b.deadline);
            return 0;
        });
        
        if (sortedTodos.length === 0) { todoList.innerHTML = `<p style="color: var(--text-muted); font-size: 0.8rem; text-align: center;">No tasks active.</p>`; return; }

        sortedTodos.forEach(todo => {
            const todoItem = document.createElement('div'); todoItem.className = 'todo-item'; todoItem.dataset.id = todo.id;
            
            const isDone = todo.status === 'full-done';
            
            // Status Select as a minimal badge
            const statusSelect = document.createElement('select'); statusSelect.className = 'todo-status';
            [{value:'not-started',text:'TODO'},{value:'half-done',text:'IN PROGRESS'},{value:'full-done',text:'DONE'}].forEach(s => {
                const option = document.createElement('option'); option.value = s.value; option.textContent = s.text;
                if (s.value === todo.status) option.selected = true; statusSelect.appendChild(option);
            });
            
            const content = document.createElement('div'); content.className = 'todo-content';
            if (isDone) content.classList.add('status-done');
            
            const text = document.createElement('span'); text.className = 'todo-text'; text.textContent = todo.description;
            const meta = document.createElement('div'); meta.className = 'todo-meta';
            
            if (todo.deadline) {
                const diff = Math.ceil((new Date(todo.deadline) - new Date(toLocalISODate(new Date()))) / (86400000));
                let dueText = todo.deadline;
                let dueClass = '';
                if (!isDone) {
                    if (diff < 0) { dueText = 'OVERDUE'; dueClass = 'is-due'; }
                    else if (diff === 0) { dueText = 'Due Today'; dueClass = 'is-due-soon'; }
                    else if (diff <= 3) { dueText = `${diff} days left`; dueClass = 'is-due-soon'; }
                }
                meta.innerHTML = `<span class="${dueClass}">${dueText}</span>`;
            } else {
                meta.textContent = 'Note';
            }
            
            content.appendChild(text); content.appendChild(meta);
            
            const actions = document.createElement('div'); actions.className = 'todo-actions';
            const editBtn = document.createElement('button'); editBtn.innerHTML = '‚úé'; 
            editBtn.onclick = () => handleEditTodo(todoItem, text, todo);
            
            const delBtn = document.createElement('button'); delBtn.innerHTML = 'üóë'; 
            delBtn.onclick = () => handleDeleteTodo(todo.id);
            
            actions.appendChild(editBtn); actions.appendChild(delBtn);

            todoItem.appendChild(content); todoItem.appendChild(statusSelect); todoItem.appendChild(actions);
            todoList.appendChild(todoItem);
        });
    }

    function listenForPersonalEvents() {
        if (!currentUserId) return; unsubscribePersonalEvents();
        unsubscribePersonalEvents = onSnapshot(query(collection(db, `artifacts/${appId}/users/${currentUserId}/events`)), (snapshot) => {
            personalEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderCalendar(); renderEventsForDay();
        });
    }
    function listenForPublicEvents() {
        unsubscribePublicEvents();
        unsubscribePublicEvents = onSnapshot(query(collection(db, `artifacts/${appId}/public/data/public_events`)), (snapshot) => {
            publicEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderCalendar(); renderEventsForDay();
        });
    }
    function listenForTodos() {
        if (!currentUserId) return; unsubscribeTodos();
        unsubscribeTodos = onSnapshot(query(collection(db, `artifacts/${appId}/users/${currentUserId}/todos`)), (snapshot) => {
            todoItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderTodos();
        });
    }

    async function handleAddEvent(e) {
        e.preventDefault();
        const eventDesc = eventDescInput.value.trim(); const eventTime = eventTimeInput.value; const selectedDateStr = eventDateInput.value;
        if (!eventDesc || !eventTime || !selectedDateStr) return;
        const isPublic = publicEventCheckbox.checked && currentUserRole === 'teacher';
        try {
            const collectionPath = isPublic ? `artifacts/${appId}/public/data/public_events` : `artifacts/${appId}/users/${currentUserId}/events`;
            await addDoc(collection(db, collectionPath), { date: selectedDateStr, time: eventTime, description: eventDesc, isPublic, createdAt: serverTimestamp(), userId: currentUserId });
            eventDescInput.value = ''; eventTimeInput.value = ''; publicEventCheckbox.checked = false;
        } catch (error) { console.error(error); }
    }
    async function handleDeleteEvent(e) {
        const eventEl = e.target.closest('.event-item');
        if(!eventEl) return;
        try {
             const path = eventEl.dataset.isPublic === 'true' ? `artifacts/${appId}/public/data/public_events` : `artifacts/${appId}/users/${currentUserId}/events`;
             await deleteDoc(doc(db, path, eventEl.dataset.id));
        } catch (error) { console.error(error); }
    }
    async function handleAddTodo(e) {
        e.preventDefault();
        const description = todoInput.value.trim();
        if (!description) return;
        try {
            await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/todos`), { description, status: 'not-started', deadline: todoDeadlineInput.value || null, createdAt: serverTimestamp(), userId: currentUserId });
            todoInput.value = ''; todoDeadlineInput.value = '';
        } catch (error) { console.error(error); }
    }
    function handleTodoStatusChange(e) {
        if (!e.target.classList.contains('todo-status')) return;
        const todoItem = e.target.closest('.todo-item');
        handleUpdateTodoStatus(todoItem.dataset.id, e.target.value);
    }
    async function handleUpdateTodoStatus(docId, newStatus) {
        try { await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/todos`, docId), { status: newStatus }); } catch (e) { console.error(e); }
    }
    function handleEditTodo(todoItem, descriptionSpan, todo) {
        const contentDiv = todoItem.querySelector('.todo-content');
        if (contentDiv.classList.contains('is-editing')) return;
        contentDiv.classList.add('is-editing');
        
        const input = document.createElement('input'); input.type = 'text'; input.value = todo.description;
        // Replace span with input
        descriptionSpan.style.display = 'none';
        contentDiv.insertBefore(input, contentDiv.firstChild); 
        input.focus(); 
        
        const save = async () => {
            const newDesc = input.value.trim();
            if (newDesc && newDesc !== todo.description) {
                try { await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/todos`, todo.id), { description: newDesc }); } catch(e){}
            }
            // Cleanup
            if(contentDiv.contains(input)) contentDiv.removeChild(input);
            descriptionSpan.style.display = 'block';
            contentDiv.classList.remove('is-editing');
        };
        input.addEventListener('blur', save);
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') save(); });
    }
    async function handleDeleteTodo(docId) {
         try { await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/todos`, docId)); } catch (e) { console.error(e); }
    }
    // #endregion

    // #region XP SYSTEM
    function listenForProfileChanges() {
        if (!currentUserId) return; unsubscribeProfile();
        unsubscribeProfile = onSnapshot(doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`), (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                xpBalance = data.xpBalance || 0;
                document.getElementById('xpBalanceDisplay').textContent = `${parseFloat(xpBalance.toFixed(1))} XP`;
                
                // LEVEL CALCULATION
                const xpPerLevel = 1000;
                const currentLevel = Math.floor(xpBalance / xpPerLevel) + 1;
                const currentLevelStartXp = (currentLevel - 1) * xpPerLevel;
                const xpInCurrentLevel = xpBalance - currentLevelStartXp;
                let progressPercent = (xpInCurrentLevel / xpPerLevel) * 100;
                if (progressPercent > 100) progressPercent = 100;

                document.getElementById('xpProgressBar').style.width = `${progressPercent}%`;
                document.getElementById('xpProgressText').textContent = `LVL ${currentLevel}`;
                
                updateRedeemButtons();
            } else {
                xpBalance = 0; document.getElementById('xpBalanceDisplay').textContent = '0 XP';
            }
        });
    }
    function listenForStudyHistory() {
        if (!currentUserId) return; unsubscribeStudyHistory();
        unsubscribeStudyHistory = onSnapshot(query(collection(db, `artifacts/${appId}/users/${currentUserId}/studyHistory`), limit(50)), (snapshot) => {
            studyHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.date.localeCompare(a.date));
            renderStudyHistory();
        });
    }
    function renderStudyHistory() {
        // We aren't showing the list in the Bento UI by default to keep it clean, but logic exists
    }
    function updateRedeemButtons() {
        document.getElementById('redeemHalfDayBtn').disabled = xpBalance < 150;
        // We reuse the button style to indicate status
        if(xpBalance >= 150) document.getElementById('redeemHalfDayBtn').style.opacity = '1';
        else document.getElementById('redeemHalfDayBtn').style.opacity = '0.5';
    }
    async function handleLogStudy() {
        // Logic handled by modal inputs now
        const date = document.getElementById('study-date').value;
        const hours = parseFloat((parseInt(document.getElementById('study-hours-input').value||0) + (parseInt(document.getElementById('study-minutes-input').value||0)/60)).toFixed(2));
        
        if (!date || hours <= 0) return;
        
        // Simple duplicate check
        const todayLogs = studyHistory.filter(l => l.date === date && l.hours > 0);
        if (todayLogs.length > 0) { showModal('Ops', 'Already logged today.'); return; }
        
        try {
            const points = parseFloat((hours * 10).toFixed(1));
            // Bonus logic same as before...
            const bonus = await checkConsecutiveBonus({ date, hours }, studyHistory);
            const total = points + bonus;
            await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`), { xpBalance: increment(total) });
            await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/studyHistory`), { date, hours, pointsEarned: total, createdAt: serverTimestamp(), userId: currentUserId });
            showModal('Nice!', `+${total} XP logged.`);
        } catch (e) { showModal('Error', e.message); }
    }
    async function checkConsecutiveBonus(newLog, history) {
        if (newLog.hours < 3) return 0;
        const logs = [...history, newLog].filter(l => l.hours >= 3).sort((a,b) => b.date.localeCompare(a.date));
        const idx = logs.findIndex(l => l.date === newLog.date);
        let streak = 1; let lastDate = new Date(logs[idx].date);
        for (let i = idx + 1; i < logs.length; i++) {
            const curr = new Date(logs[i].date); const diff = Math.round((lastDate - curr)/(86400000));
            if (diff === 1) { streak++; lastDate = curr; } else if (diff > 1) break;
            if (streak === 5) return 50;
        }
        return 0;
    }
    async function handleRedeemPoints(e) {
        const cost = 150;
        if (xpBalance < cost) { showModal('Too poor', 'Need 150 XP'); return; }
        showModal('Redeem?', 'Spend 150 XP for Half Day Off?', [{ text: 'Cancel', className: 'btn-ghost' }, { text: 'Redeem', className: 'btn-primary', onClick: async () => {
             try {
                await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`), { xpBalance: increment(-cost) });
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/studyHistory`), { date: toLocalISODate(new Date()), hours: 0, pointsEarned: -cost, description: `Redeemed Reward`, createdAt: serverTimestamp(), userId: currentUserId });
             } catch (e) { console.error(e); }
        }}]);
    }
    // #endregion

    // #region CHART ANALYTICS
    function openAnalyticsModal() {
        document.getElementById('analyticsModal').style.display = 'flex';
        renderAnalyticsChart();
    }
    
    function renderAnalyticsChart() {
        const ctx = document.getElementById('studyChart').getContext('2d');
        if (studyChart) studyChart.destroy();
        
        const labels = [], dataPoints = [];
        const today = new Date();
        for (let i = 6; i >= 0; i--) {
            const d = new Date(today); d.setDate(today.getDate() - i);
            const dateStr = toLocalISODate(d);
            labels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
            const logsForDay = studyHistory.filter(l => l.date === dateStr && l.hours > 0);
            dataPoints.push(logsForDay.reduce((sum, log) => sum + log.hours, 0));
        }
        
        const isDark = !document.body.classList.contains('light-theme');
        const color = isDark ? '#fff' : '#000';
        
        studyChart = new Chart(ctx, {
            type: 'bar', // Changed to BAR for better bento look
            data: {
                labels: labels,
                datasets: [{
                    label: 'Hours',
                    data: dataPoints,
                    backgroundColor: isDark ? 'rgba(255,255,255,0.8)' : 'rgba(0,0,0,0.8)',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { display:false }, ticks: { color: color } },
                    x: { grid: { display: false }, ticks: { color: color } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }
    // #endregion

    // #region STUDY TOOLS (Stopwatch & Timer)
    function startStopwatch() {
        if (stopwatchRunning) return; stopwatchRunning = true; stopwatchStartTime = Date.now() - stopwatchElapsedTime;
        stopwatchInterval = setInterval(() => {
            const elapsed = Date.now() - stopwatchStartTime;
            let ms = elapsed % 1000, s = Math.floor((elapsed / 1000) % 60), m = Math.floor((elapsed / 60000) % 60), h = Math.floor(elapsed / 3600000);
            document.getElementById('stopwatchDisplay').textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }, 100);
        document.getElementById('startStopwatchBtn').style.display = 'none'; document.getElementById('stopStopwatchBtn').style.display = 'inline-block';
    }
    function stopStopwatch() {
        if (!stopwatchRunning) return; stopwatchRunning = false; clearInterval(stopwatchInterval); stopwatchElapsedTime = Date.now() - stopwatchStartTime;
        document.getElementById('startStopwatchBtn').style.display = 'inline-block'; document.getElementById('stopStopwatchBtn').style.display = 'none';
    }
    function resetStopwatch() { stopStopwatch(); stopwatchElapsedTime = 0; document.getElementById('stopwatchDisplay').textContent = '00:00:00'; }
    
    function startTimer() {
        if (timerRunning) return;
        if (!timerAudioContext) try { timerAudioContext = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}
        const h = parseInt(document.getElementById('timerHours').value)||0, m = parseInt(document.getElementById('timerMinutes').value)||0, s = parseInt(document.getElementById('timerSeconds').value)||0;
        timerTotalTime = (h * 3600) + (m * 60) + s;
        if (timerTotalTime <= 0) return;
        timerTimeRemaining = timerTimeRemaining > 0 ? timerTimeRemaining : timerTotalTime;
        timerRunning = true; 
        timerInterval = setInterval(() => {
            if (timerTimeRemaining <= 0) { stopTimer(); playTimerBeep(); timerTimeRemaining = 0; return; }
            timerTimeRemaining--;
            let r = timerTimeRemaining, th = Math.floor(r / 3600); r %= 3600; let tm = Math.floor(r / 60), ts = r % 60;
            document.getElementById('timerDisplay').textContent = `${String(th).padStart(2,'0')}:${String(tm).padStart(2,'0')}:${String(ts).padStart(2,'0')}`;
        }, 1000);
        document.getElementById('startTimerBtn').style.display = 'none'; document.getElementById('stopTimerBtn').style.display = 'inline-block';
    }
    function stopTimer() { if (!timerRunning) return; timerRunning = false; clearInterval(timerInterval); document.getElementById('startTimerBtn').style.display = 'inline-block'; document.getElementById('stopTimerBtn').style.display = 'none'; }
    function resetTimer() { stopTimer(); timerTimeRemaining = 0; document.getElementById('timerDisplay').textContent = '00:00:00'; }
    function playTimerBeep() {
        if (!timerAudioContext) return;
        timerBeepNode = timerAudioContext.createOscillator(); const g = timerAudioContext.createGain();
        timerBeepNode.connect(g); g.connect(timerAudioContext.destination);
        timerBeepNode.type = 'sine'; timerBeepNode.frequency.setValueAtTime(880, timerAudioContext.currentTime);
        g.gain.setValueAtTime(0.5, timerAudioContext.currentTime);
        timerBeepNode.start(timerAudioContext.currentTime); timerBeepNode.stop(timerAudioContext.currentTime + 0.5);
    }
    // #endregion

    // #region UTILS
    function toLocalISODate(date) { return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`; }
    function isSameDay(d1, d2) { return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate(); }
    
    function showModal(title, msg, buttons = []) {
        const m = document.getElementById('messageModal'); document.getElementById('modalTitle').textContent = title; document.getElementById('modalMessage').innerHTML = msg;
        const bDiv = document.getElementById('modalButtons'); bDiv.innerHTML = '';
        if (buttons.length === 0) buttons = [{ text: 'OK', className: 'btn-primary' }];
        buttons.forEach(b => {
            const btn = document.createElement('button'); btn.textContent = b.text; btn.className = b.className;
            btn.onclick = () => { m.style.display = 'none'; if(b.onClick) b.onClick(); }; bDiv.appendChild(btn);
        });
        m.style.display = 'flex';
    }
    function showInputModal(title, label, cb) {
        showModal(title, `<label style="color:var(--text-muted); margin-bottom:10px; display:block;">${label}</label><input id="mInput" style="background:var(--bg-input); border:1px solid var(--border-color); width:100%; padding:10px; color:#fff;">`, [
            { text: 'Confirm', className: 'btn-primary', onClick: () => { const v = document.getElementById('mInput').value.trim(); if(v) cb(v); } },
            { text: 'Cancel', className: 'btn-ghost' }
        ]);
        setTimeout(() => document.getElementById('mInput').focus(), 50);
    }
    document.querySelectorAll('.modal .close-button').forEach(btn => btn.onclick = () => btn.closest('.modal').style.display = 'none');
    // #endregion
  </script>
</body>
</html>
