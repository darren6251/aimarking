<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Marker - Home</title>
  <style>
    /* --- MODERN BLACK & WHITE THEME --- */
    :root {
        --bg-primary: #0a0a0a; /* Near black for main background */
        --bg-secondary: #1a1a1a; /* Dark gray for secondary elements */
        --bg-tertiary: #2a2a2a; /* Lighter gray for hovers */
        --text-primary: #f5f5f5; /* Off-white for primary text */
        --text-secondary: #a3a3a3; /* Muted gray for secondary text */
        --accent-primary: #ffffff; /* White for key actions and highlights */
        --accent-red: #ef4444; /* A modern, sharp red for destructive actions */
        --border-color: #333333; /* Subtle border color */
        --focus-ring-color: rgba(245, 245, 245, 0.5); /* Semi-transparent white for focus rings */

        /* Finder Window Specific Variables */
        --finder-bg-primary: #1c1c1c;
        --finder-bg-secondary: #0a0a0a;
        --finder-text-primary: #f5f5f5;
        --finder-text-secondary: #a3a3a3;
        --finder-border-color: #333333;
        --finder-titlebar-bg: #2a2a2a;
        --finder-hover-bg: #333333;
        --finder-active-bg: var(--accent-primary);
        --finder-active-text: #0a0a0a;
    }

    /* --- LIGHT THEME OVERRIDES --- */
    body.light-theme {
        --bg-primary: #ffffff;
        --bg-secondary: #f5f5f5;
        --bg-tertiary: #e5e5e5;
        --text-primary: #0a0a0a;
        --text-secondary: #737373;
        --accent-primary: #0a0a0a;
        --border-color: #d4d4d4;
        --focus-ring-color: rgba(10, 10, 10, 0.5);

        /* Finder Window Light Theme */
        --finder-bg-primary: #ffffff;
        --finder-bg-secondary: #f5f5f5;
        --finder-text-primary: #0a0a0a;
        --finder-text-secondary: #737373;
        --finder-border-color: #d4d4d4;
        --finder-titlebar-bg: #e5e5e5;
        --finder-hover-bg: #e5e5e5;
        --finder-active-bg: var(--accent-primary);
        --finder-active-text: #ffffff;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text-primary);
        background-color: var(--bg-primary);
        overflow-x: hidden;
        scroll-behavior: smooth;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        transition: background-color 0.3s, color 0.3s;
    }

    button,
    input,
    textarea,
    select {
        transition: all .2s ease-in-out;
        font-family: inherit;
        color: var(--text-primary);
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 8px 10px;
    }
    
    select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23a3a3a3' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
        padding-right: 30px;
    }
    
    body.light-theme select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23737373' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
    }

    input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px var(--focus-ring-color);
    }
    
    input[type="date"], input[type="time"] {
        color-scheme: var(--bg-primary) == #0a0a0a ? dark : light;
    }
    
    body.light-theme input[type="date"], body.light-theme input[type="time"] {
        color-scheme: light;
    }

    button:disabled {
        opacity: .5;
        cursor: not-allowed;
    }

    /* Keyframe animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideInUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    /* --- STARTUP ANIMATION --- */
    #startupAnimation {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: var(--bg-primary);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
        pointer-events: none;
        opacity: 0; /* Starts hidden */
    }
    
    #animatedLogo {
        font-size: 10vw; /* Starts large */
        font-weight: 700;
        color: var(--text-primary);
        transform: translate(0, 0) scale(1);
        opacity: 0;
    }
    
    #startupAnimation.run-animation {
        opacity: 1;
    }

    #startupAnimation.run-animation #animatedLogo {
        /*
          Animation: 
          1. Fade in and stay (0% to 20%)
          2. Hold (20% to 50%)
          3. Transform and fade (50% to 100%)
        */
        animation: shrinkToCorner 2.5s cubic-bezier(0.65, 0, 0.35, 1) forwards;
    }
    
    #startupAnimation.fade-out {
        opacity: 0;
        transition: opacity 0.5s ease-out;
    }
    
    /* Make the real logo start as invisible */
    header .logo-container h1 {
        opacity: 0;
    }

    @keyframes shrinkToCorner {
        0% {
            transform: translate(0, 0) scale(1);
            font-size: 10vw;
            opacity: 0;
        }
        20% {
            transform: translate(0, 0) scale(1);
            font-size: 10vw;
            opacity: 1;
        }
        50% {
            transform: translate(0, 0) scale(1);
            font-size: 10vw;
            opacity: 1;
        }
        100% {
            /* These transform values are approximations to get to the top left corner.
              They might need fine-tuning based on your exact header layout.
            */
            transform: translate(calc(-50vw + 90px), calc(-50vh + 34px));
            font-size: 1.25rem; /* Matches .logo-container h1 */
            opacity: 1;
        }
    }

    
    /* --- LOGIN PAGE --- */
    #authWrapper {
        display: flex;
        width: 100vw;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        opacity: 0; /* Starts hidden, fades in with JS */
        transition: opacity 0.5s ease-in-out;
        z-index: 1001;
    }

    .login-left-panel,
    .login-right-panel {
        width: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2rem;
    }

    .login-left-panel {
        background: var(--bg-primary);
        color: var(--text-primary);
        flex-direction: column;
        text-align: center;
    }

    .login-left-panel h1 {
        font-size: 3.5rem;
        font-weight: 700;
        letter-spacing: -1px;
        margin-bottom: 1rem;
    }

    .login-left-panel p {
        font-size: 1.25rem;
        font-weight: 400;
        line-height: 1.5;
        margin-bottom: .5rem;
        color: var(--text-secondary);
    }

    .login-right-panel {
        background: var(--bg-secondary);
        flex-direction: column;
    }
    
    #authContainer {
        width: 100%;
        max-width: 380px;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        background-color: var(--bg-primary);
        padding: 2.5rem;
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    #authContainer h2 {
        font-size: 2rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2rem;
        text-align: center;
    }

    .google-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: .75rem;
        cursor: pointer;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 1rem;
        font-weight: 500;
        margin-bottom: 1rem;
    }
    .google-btn:hover { background-color: var(--bg-tertiary); border-color: var(--text-secondary); }
    .google-btn img { height: 20px; }
    
    #accessCodeInput {
         background-color: var(--bg-secondary);
         border: 1px solid var(--border-color);
         color: var(--text-primary);
         padding: 12px;
         border-radius: 8px;
         width: 100%;
         margin-bottom: 1rem;
         text-align: center;
         font-size: 1rem;
    }
    #accessCodeInput:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px var(--focus-ring-color);
    }

    .btn-primary {
         background-color: var(--accent-primary);
         color: var(--bg-primary);
         padding: .75rem 1.5rem;
         border-radius: 8px;
         border: none;
         cursor: pointer;
         font-weight: 600;
         font-size: 1rem;
    }
    
    body.light-theme .btn-primary {
        color: var(--bg-primary);
    }

    .btn-primary:hover {
         opacity: 0.85;
         transform: translateY(-1px);
    }
    
    #appSection {
        display: none; /* Hidden until authenticated */
        flex-direction: column;
        height: 100vh;
        background-color: var(--bg-primary);
        animation: fadeIn .6s ease-out both;
    }
        
    /* --- HEADER --- */
    header {
        background: var(--bg-primary);
        color: var(--text-primary);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
        height: 64px;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
    }

    .logo-container {
        display: flex;
        flex-direction: column;
        line-height: 1.2;
    }
    .logo-container h1 {
        font-size: 1.25rem;
        font-weight: 700;
        transition: opacity 0.5s ease-out; /* For fade-in after animation */
    }
    .logo-container p {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    /* Navigation */
    .header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .header-actions .tab,
    .header-actions .dropdown-menu > button {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        color: var(--text-secondary);
        background: transparent;
        border: none;
        transition: background 0.2s, color 0.2s;
    }

    .header-actions .tab:hover,
    .header-actions .dropdown-menu > button:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .header-actions .tab.active,
    .header-actions .dropdown-menu > button.active {
        background: var(--bg-secondary);
        color: var(--accent-primary);
        font-weight: 600;
    }

    /* Dropdown Menu */
    .dropdown-menu {
        position: relative;
    }

    .dropdown-menu-content {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background-color: var(--bg-secondary);
        min-width: 180px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.3);
        border-radius: 8px;
        overflow: hidden;
        z-index: 20;
    }

    .dropdown-menu-content a, .dropdown-menu-content button {
        display: block;
        padding: 10px 14px;
        font-size: 0.9rem;
        color: var(--text-secondary);
        text-decoration: none;
        transition: background 0.2s, color 0.2s;
        background: none;
        border: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
    }

    .dropdown-menu-content a:hover, .dropdown-menu-content button:hover {
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
    }
    .dropdown-menu-content a.active {
        color: var(--accent-primary);
        font-weight: 600;
    }


    /* Show menu on hover */
    .dropdown-menu:hover .dropdown-menu-content {
        display: block;
    }

    .user-info { display: flex; align-items: center; gap: 1rem; margin-left: 1rem; }
    #userDisplayName { font-weight: 500; cursor: pointer; }
    .logout-btn { background: none; border: 1px solid var(--border-color); color: var(--text-secondary); cursor: pointer; padding: 6px 12px; border-radius: 8px; font-weight: 600; }
    .logout-btn:hover { background: var(--accent-red); border-color: var(--accent-red); color: var(--accent-primary); }

    #switchRoleButton {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        padding: 6px 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        cursor: pointer;
        font-weight: 600;
    }
    #switchRoleButton:hover {
        background-color: var(--bg-tertiary);
        border-color: var(--text-secondary);
    }
    
    /* --- MAIN CONTENT (HOME SPECIFIC) --- */
    main {
        flex: 1;
        display: flex;
        flex-direction: column; /* Changed to column for hero section */
        overflow-y: auto;
        padding: 32px;
        gap: 32px;
        align-items: center; /* Center content horizontally */
    }

    .hero {
        display: flex;
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
        align-items: center;
        justify-content: center;
        gap: 4rem;
        padding: 4rem 2rem;
        max-width: 1200px;
        width: 100%;
    }

    .hero-text {
        flex: 1;
        min-width: 300px;
        text-align: center;
    }

    .hero-text h2 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--text-primary);
    }

    .hero-text h2 span {
        color: var(--accent-primary);
    }

    .hero-text .buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .hero-text .buttons a {
        background-color: var(--accent-primary);
        color: var(--bg-primary);
        padding: 0.8rem 1.8rem;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: opacity 0.2s, transform 0.2s;
        font-size: 1rem;
    }

    .hero-text .buttons a:hover {
        opacity: 0.85;
        transform: translateY(-2px);
    }

    .hero-image {
        flex: 1;
        min-width: 300px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .hero-image img {
        max-width: 100%;
        height: auto;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    /* Modals */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; animation: fadeIn 0.3s ease-out; }
    .modal-content { background-color: var(--bg-secondary); padding: 30px; border-radius: 12px; border: 1px solid var(--border-color); max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; animation: slideInUp 0.3s ease-out; }
    #modalTitle { margin-bottom: 1rem; font-size: 1.5rem; font-weight: 600; }
    .close-button { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: var(--text-secondary); }
    .close-button:hover { color: var(--text-primary); }
    #modalButtons { display:flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
    
    .modal-input {
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 10px;
        border-radius: 6px;
        width: 100%;
        margin-top: 10px;
    }
    .modal-input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 2px var(--focus-ring-color);
    }

    /* --- Time and Countdown Section --- */
    .time-info-section {
        width: 100%;
        max-width: 1200px;
        padding: 2rem;
        background-color: var(--bg-secondary);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2rem;
    }
    .time-container {
        display: flex;
        justify-content: center;
        width: 100%;
        flex-wrap: wrap;
        gap: 2rem;
    }
    .time-box {
        background-color: var(--bg-primary);
        padding: 2rem;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        text-align: center;
        flex: 1;
        min-width: 300px;
    }
    .time-label {
        font-size: 1rem;
        color: var(--text-secondary);
        display: block;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 1.5px;
    }
    .time-display, .countdown-display {
        font-size: 3.5rem;
        font-weight: 600;
        letter-spacing: -1px;
        color: var(--text-primary);
        font-variant-numeric: tabular-nums;
        line-height: 1.1;
    }
    .date-display {
        font-size: 1.1rem;
        font-weight: 400;
        color: var(--text-secondary);
        margin-top: 0.75rem;
        letter-spacing: 0.5px;
    }
    #teacher-controls {
        display: none; /* Hidden by default */
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        padding: 1rem;
        background-color: var(--bg-primary);
        border-radius: 8px;
        width: 100%;
        max-width: 500px;
        justify-content: center;
    }
    #countdown-datetime {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 8px;
        border-radius: 6px;
    }
    #set-countdown-btn {
        background-color: var(--accent-primary);
        color: var(--bg-primary);
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
    }
    #set-countdown-btn:hover {
        opacity: 0.85;
    }
    body.light-theme #set-countdown-btn {
        color: var(--bg-primary);
    }
    
    /* --- DASHBOARD: CALENDAR & TODO --- */
    .dashboard-container {
        width: 100%;
        max-width: 1200px;
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
    }
    
    .dashboard-calendar, .dashboard-todo {
        flex: 1;
        background-color: var(--bg-secondary);
        border-radius: 12px;
        padding: 1.5rem;
        min-width: 300px;
    }

    .dashboard-calendar h3, .dashboard-todo h3, .xp-system-section h3 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 1rem;
        text-align: center;
    }
    
    .xp-system-section h3 {
        width: 100%;
    }

    /* Calendar Styling */
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        gap: 0.5rem;
    }
    .calendar-header select {
        flex: 1;
        padding: 8px;
        font-weight: 600;
    }
    .calendar-header .btn-secondary {
        padding: 8px 16px;
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        cursor: pointer;
    }
    .calendar-header .btn-secondary:hover {
        background-color: var(--bg-primary);
    }

    #calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }
    .calendar-header-day, .calendar-day {
        text-align: center;
        padding: 10px;
        border-radius: 6px;
    }
    .calendar-header-day {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
    }
    .calendar-day {
        cursor: pointer;
        font-weight: 500;
        position: relative;
        transition: background-color 0.2s;
    }
    .calendar-day:not(.other-month):hover {
        background-color: var(--bg-tertiary);
    }
    .calendar-day.other-month {
        opacity: 0.4;
        cursor: not-allowed;
    }
    .calendar-day.today {
        background-color: var(--bg-tertiary);
        color: var(--accent-primary);
        font-weight: 700;
    }
    .calendar-day.selected {
        background-color: var(--accent-primary);
        color: var(--bg-primary);
        font-weight: 700;
    }
    .calendar-day .event-marker {
        position: absolute;
        bottom: 5px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: var(--text-secondary);
    }
    .calendar-day .event-marker.public {
        background-color: var(--accent-primary);
    }
    /* When selected, the public marker should be dark */
    .calendar-day.selected .event-marker.public {
        background-color: var(--bg-primary);
    }

    /* Event List */
    #event-list-container { margin-top: 1.5rem; }
    #event-list-header {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    #event-list {
        max-height: 200px;
        overflow-y: auto;
        padding-right: 10px; /* For scrollbar */
    }
    .event-item {
        background-color: var(--bg-primary);
        padding: 10px 12px;
        border-radius: 6px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
    }
    .event-item-details { flex: 1; }
    .event-item-details span {
        font-weight: 600;
        font-size: 0.9rem;
        margin-right: 8px;
    }
    .event-item-details .tag {
        font-size: 0.75rem;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 4px;
        background-color: var(--text-secondary);
        color: var(--bg-primary);
        margin-right: 8px;
    }
    .event-item-details .tag.public {
        background-color: var(--accent-primary);
        color: var(--bg-primary);
    }
    .event-item .delete-event {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 1.1rem;
        padding: 4px;
    }
    .event-item .delete-event:hover { color: var(--accent-red); }

    /* Add Event Form */
    #add-event-form {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    #event-desc {
        grid-column: 1 / -1; /* Span full width */
    }
    #add-event-btn {
        grid-column: 1 / -1;
        background-color: var(--accent-primary);
        color: var(--bg-primary);
        font-weight: 600;
        padding: 10px;
        cursor: pointer;
    }
    body.light-theme #add-event-btn { color: var(--bg-primary); }
    #add-event-btn:hover { opacity: 0.85; }
    
    #public-event-container {
        grid-column: 1 / -1;
        display: none; /* Hidden by default */
        align-items: center;
        gap: 8px;
    }
    #public-event-container label {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    
    /* Todo List Styling */
    #todo-list {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 10px;
        margin-bottom: 1.5rem;
    }
    .todo-item {
        background-color: var(--bg-primary);
        padding: 10px 12px;
        border-radius: 6px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .todo-item select.status-select {
        flex-shrink: 0;
        width: 120px;
        padding: 6px;
        font-size: 0.85rem;
    }
    
    .todo-item-details {
        flex: 1;
        font-size: 0.95rem;
        /* Add transition for smoother visual change */
        transition: opacity 0.3s, text-decoration 0.3s;
    }
    .todo-item-details.status-half-done {
        text-decoration: line-through;
        opacity: 0.8;
    }
    .todo-item-details.status-full-done {
        text-decoration: line-through;
        opacity: 0.5;
    }
    
    .todo-item-details .todo-deadline {
        display: block;
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 2px;
    }
    
    .todo-item .delete-todo {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 1.1rem;
        padding: 4px;
    }
    .todo-item .delete-todo:hover { color: var(--accent-red); }
    
    #add-todo-form {
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
    }
    #todo-input {
        grid-column: 1 / -1;
    }
    #add-todo-btn {
        grid-column: 2 / 3;
        background-color: var(--accent-primary);
        color: var(--bg-primary);
        font-weight: 600;
        padding: 10px 20px;
        cursor: pointer;
    }
    body.light-theme #add-todo-btn { color: var(--bg-primary); }
    #add-todo-btn:hover { opacity: 0.85; }

    /* --- XP System Styles --- */
    .xp-balance-container {
        margin-top: 1.5rem; 
        text-align: center;
    }
    .xp-balance-container h4 {
        font-size: 1.2rem; 
        font-weight: 600; 
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    #xpBalanceDisplay {
        font-size: 2.5rem; 
        font-weight: 700; 
        color: var(--accent-primary); 
        line-height: 1.1;
    }
    
    .xp-system-section {
        width: 100%;
        max-width: 1200px;
        padding: 2rem;
        background-color: var(--bg-secondary);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
    }
    .xp-form-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        justify-content: center;
    }
    .xp-form-container label {
        color: var(--text-secondary);
    }
    .xp-form-container input[type="number"] {
        width: 80px; /* Reduced width to fit hours and minutes */
    }
    .xp-redeem-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
    }
    #study-history-container {
        width: 100%;
        max-width: 600px;
        margin-top: 1rem;
    }
    #study-history-container h4 {
        font-weight: 600;
        margin-bottom: 0.5rem;
        text-align: center;
    }
    #study-history-list {
        max-height: 200px;
        overflow-y: auto;
        background-color: var(--bg-primary);
        padding: 1rem;
        border-radius: 8px;
    }
    .study-log-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
    }
    .study-log-item:last-child {
        border-bottom: none;
    }
    .log-date { font-weight: 600; }
    .log-hours { color: var(--text-secondary); }
    .log-points { font-weight: 600; }
    .log-points.positive { color: #4ade80; } /* Green */
    .log-points.negative { color: var(--accent-red); } /* Red */

    /* Style for the new delete log button */
    .delete-log-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 1.1rem;
        padding: 0 4px;
        line-height: 1;
    }
    .delete-log-btn:hover {
        color: var(--accent-red);
    }


    /* Responsive Adjustments */
    @media (max-width: 900px) {
        .dashboard-container {
            flex-direction: column;
        }
    }
    
    @media (max-width: 768px) {
        #authWrapper { flex-direction: column; position: static; height: auto; }
        .login-left-panel, .login-right-panel { width: 100%; }
        header {
            flex-direction: column;
            height: auto;
            padding: 1rem;
            align-items: flex-start;
        }
        .header-actions {
            margin-left: 0;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .hero {
            flex-direction: column;
            text-align: center;
        }
        .hero-text h2 {
            font-size: 2.2rem;
        }
        .hero-text .buttons {
            flex-direction: column;
        }
        .hero-text .buttons a {
            width: 100%;
        }
        .time-container {
            flex-direction: column;
        }
        .time-display, .countdown-display {
            font-size: 2.5rem;
        }
        .date-display {
            font-size: 1rem;
        }
        .calendar-header { flex-wrap: wrap; }
        #add-todo-form {
            grid-template-columns: 1fr;
        }
        #add-todo-btn {
            grid-column: 1 / -1;
        }
    }

    /* --- FOOTER --- */
    footer { 
        text-align: right; 
        padding: 10px 20px; 
        color: var(--text-secondary); 
        font-size: 0.875rem; 
        z-index: 100; 
        width: 100%; 
        margin-top: auto;
    }
    footer a { 
        color: var(--text-secondary); 
        text-decoration: none; 
    }
    footer a:hover { 
        text-decoration: underline; 
        color: var(--text-primary); 
    }

  </style>
</head>
<body>

  <!-- Startup Animation -->
  <div id="startupAnimation">
      <div id="animatedLogo">AI Marker</div>
  </div>

  <!-- Auth Wrapper -->
  <div id="authWrapper" style="display: none;">
    <div class="login-left-panel">
      <h1>AI Marker</h1>
      <p>Mark with AI, learn better.</p>
    </div>
    <div class="login-right-panel">
      <div id="authContainer">
         <!-- JS will inject googleSignInTemplate or codeEntryTemplate -->
      </div>
    </div>
  </div>

  <div id="appSection" style="display: none;">
    <!-- HEADER -->
    <header>
      <div class="logo-container">
        <h1>AI Marker</h1>
        <p>Operated by Darren Ng</p>
      </div>
      <div class="header-actions">
        <a href="home.html" class="tab active">Home</a>
        <button id="themeToggleButton" class="logout-btn">Theme</button>

        <div class="dropdown-menu">
          <button class="tab">Work with AI ▾</button>
          <div class="dropdown-menu-content">
            <a href="exercises.html" class="tab">Exercise</a>
            <a href="chat.html" class="tab">Chat with Gemini</a>
            <a href="submissions.html" class="tab">Submissions</a>
          </div>
        </div>

        <div class="dropdown-menu">
          <button class="tab">Materials ▾</button>
          <div class="dropdown-menu-content">
            <a href="tutorials.html"tab">Tutorial Videos</a>
            <a href="pastpaper.html" class="tab">Past Papers</a>
            <a href="exercises.html" class="tab">Exercises for Sale</a>
            <a href="lessonhistory.html" class="tab">Lesson History</a>
          </div>
        </div>

        <div class="user-info">
          <span id="userDisplayName">Guest</span>
          <button id="switchRoleButton">Switch Role</button>
          <button id="logoutButton" class="logout-btn">Log Out</button>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main>
      <div id="homeSection">
        <section class="hero">
          <div class="hero-text">
            <h2>Hi <span id="homeUserNamePlaceholder"></span>, how are you today? Let's fight DSE together!</h2>
            <p class="helper" style="margin-top:0">You don't have to see the whole staircase, just take the first step.</p>
            
            <!-- XP BALANCE DISPLAY -->
            <div class="xp-balance-container">
                <h4>Your XP Balance</h4>
                <p id="xpBalanceDisplay">Loading...</p>
            </div>
            
            <div class="buttons" style="margin-top: 2rem;">
              <a href="materials.html?folder=tutorials" id="homeTutorialLink">Tutorial Video</a>
              <a href="lessonhistory.html" id="homeGraderLink">Lesson History</a>
              <a href="chat.html" id="homeChatLink">Chat with AI</a>
              <a href="submissions.html" id="homeSubmissionsLink" class="btn-primary">Submissions</a>
            </div>
          </div>
          <div class="hero-image">
            <img src="https://raw.githubusercontent.com/darren6251/aimarking/refs/heads/main/eaakill.png" alt="Darren Ng demonstrating AI Marker" onerror="this.src='https://placehold.co/600x400/1a1a1a/f5f5f5?text=AI+Marker'">
          </div>
        </section>
        
        <section class="time-info-section">
            <div class="time-container">
                <div class="time-box">
                    <span class="time-label">Current Time & Date</span>
                    <div id="currentTime" class="time-display">00:00:00</div>
                    <div id="currentDate" class="date-display">Loading date...</div>
                </div>
                <div class="time-box">
                    <span class="time-label">2026DSE from now</span>
                    <div id="countdown" class="countdown-display">--:--:--:--</div>
                </div>
            </div>
            <div id="teacher-controls">
                <input type="datetime-local" id="countdown-datetime">
                <button id="set-countdown-btn">Set</button>
            </div>
        </section>
        
        <!-- Dashboard Section -->
        <section class="dashboard-container">
            <!-- Calendar -->
            <div class="dashboard-calendar">
                <h3>Calendar & Events</h3>
                <div class="calendar-header">
                    <button id="today-btn" class="btn-secondary">Today</button>
                    <select id="month-select"></select>
                    <select id="year-select"></select>
                </div>
                <div class="calendar-week-header">
                    <div id="calendar-grid">
                        <div class="calendar-header-day">Sun</div>
                        <div class="calendar-header-day">Mon</div>
                        <div class="calendar-header-day">Tue</div>
                        <div class="calendar-header-day">Wed</div>
                        <div class="calendar-header-day">Thu</div>
                        <div class="calendar-header-day">Fri</div>
                        <div class="calendar-header-day">Sat</div>
                        <!-- Calendar days will be injected by JS -->
                    </div>
                </div>
                
                <div id="event-list-container">
                    <h4 id="event-list-header">Events for:</h4>
                    <div id="event-list">
                        <!-- Event items will be injected by JS -->
                    </div>
                    
                    <form id="add-event-form">
                        <h5 style="grid-column: 1 / -1; margin-bottom: 5px; font-weight: 600;">Add Event</h5>
                        <input type="date" id="event-date" required>
                        <input type="time" id="event-time" required>
                        <input type="text" id="event-desc" placeholder="Event description..." required>
                        <div id="public-event-container">
                            <input type="checkbox" id="public-event-checkbox" style="width: auto;">
                            <label for="public-event-checkbox">Add as Public Event (Visible to all)</label>
                        </div>
                        <button type="submit" id="add-event-btn">Add Event</button>
                    </form>
                </div>
            </div>
            
            <!-- Quick Notes & To-Do -->
            <div class="dashboard-todo">
                <h3>Quick Notes & To-Do</h3>
                <div id="todo-list">
                    <!-- Todo items will be injected by JS -->
                </div>
                
                <form id="add-todo-form">
                    <h5 style="grid-column: 1 / -1; margin-bottom: 5px; font-weight: 600;">Add Note / Task</h5>
                    <input type="text" id="todo-input" placeholder="New note or task..." required>
                    <input type="date" id="todo-deadline" title="Optional deadline">
                    <button type="submit"id="add-todo-btn">Add</button>
                </form>
            </div>
        </section>

        <!-- XP System Section -->
        <section class="xp-system-section">
            <h3>Study XP System</h3>
            <div class="xp-form-container">
                <label for="study-date">Date:</label>
                <input type="date" id="study-date" required>
                <label for="study-hours-input">Hours:</label>
                <input type="number" id="study-hours-input" min="0" step="1" placeholder="e.g., 1" style="width: 70px;">
                <label for="study-minutes-input">Minutes:</label>
                <input type="number" id="study-minutes-input" min="0" max="59" step="1" placeholder="e.g., 30" style="width: 70px;">
                <button id="log-study-btn" class="btn-primary">Log Study Time</button>
            </div>
            <div class="xp-redeem-container">
                <button id="redeemHalfDayBtn" class="logout-btn" data-cost="150" disabled>Redeem Half Day (150 XP)</button>
                <button id="redeemFullDayBtn" class="logout-btn" data-cost="300" disabled>Redeem Full Day (300 XP)</button>
            </div>
            <div id="study-history-container">
                <h4>Recent Study Logs</h4>
                <div id="study-history-list">
                    <p style="color: var(--text-secondary); text-align: center;">No study logs yet.</p>
                    <!-- Logs will be injected here -->
                </div>
            </div>
        </section>

      </div>
    </main>
    <!-- FOOTER -->
    <footer>
      <a href="mailto:darren_0625@mc-zero.com">Contact: darren_0625@mc-zero.com</a> | Copyright © 2025 Operated by Darren Ng
    </footer>
  </div>

  <!-- Universal Modal -->
  <div id="messageModal" class="modal">
      <div class="modal-content">
          <span class="close-button">&times;</span>
          <h3 id="modalTitle"></h3>
          <div id="modalMessage"></div>
          <div id="modalButtons"></div>
      </div>
  </div>
  
  <!-- Profile Edit Modal -->
  <div id="profileEditModal" class="modal">
      <div class="modal-content">
          <span class="close-button profile-close-button">&times;</span>
          <h3 id="profileModalTitle">Edit Profile</h3>
          <div id="profileModalMessage">
            <div class="form-group">
                <label for="editUserName">Display Name:</label>
                <input type="text" id="editUserName" class="modal-input">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="text" id="editUserEmail" class="modal-input" disabled>
            </div>
            <div class="form-group">
                <label>Role:</label>
                <input type="text" id="editUserRole" class="modal-input" disabled>
            </div>
          </div>
          <div id="profileModalButtons" style="display:flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem;">
             <button id="saveProfileButton" class="btn-primary">Save Changes</button>
             <button id="cancelProfileButton" class="logout-btn">Cancel</button>
          </div>
      </div>
  </div>


  <!-- Firebase & App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    // Added 'limit' and 'increment' for XP system query and updates
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, onSnapshot, addDoc, where, serverTimestamp, limit, increment } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";

    // --- IMPORTANT CONFIGURATION ---
    const TEACHER_CODE = "DDDDDDDD"; // Example teacher code
    const STUDENT_CODE = "STUDENT456"; // Example student code

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
      authDomain: "ai-grading-9bb30.firebaseapp.com",
      projectId: "ai-grading-9bb30",
      storageBucket: "ai-grading-9bb30.appspot.com",
      messagingSenderId: "298162112230",
      appId: "1:298162112230:web:529d3f95536991be685d27",
      measurementId: "G-CHKLKSM17S"
    };
    
    // Canvas provided global variables
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let app, db, auth, storage;
    let currentUserId = null, currentUserEmail = null, currentUserRole = null, currentUserName = null;
    let countdownInterval;
    
    // State for dashboard
    let currentSelectedDate = new Date();
    let currentMonth = currentSelectedDate.getMonth();
    let currentYear = currentSelectedDate.getFullYear();
    let personalEvents = [];
    let publicEvents = [];
    let todoItems = [];
    let unsubscribePersonalEvents = () => {};
    let unsubscribePublicEvents = () => {};
    let unsubscribeTodos = () => {};
    
    // State for XP System
    let xpBalance = 0;
    let studyHistory = [];
    let unsubscribeProfile = () => {};
    let unsubscribeStudyHistory = () => {};


    // --- AUTH & INITIALIZATION ---
    const authWrapper = document.getElementById('authWrapper');
    const appSection = document.getElementById('appSection');
    const authContainer = document.getElementById('authContainer');
    const userDisplayNameSpan = document.getElementById('userDisplayName');
    const startupAnimation = document.getElementById('startupAnimation');
    const headerLogo = document.querySelector('header .logo-container h1');

    const googleSignInTemplate = `
        <h2>Sign In</h2>
        <button id="googleSignInButton" class="google-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
            <span>Sign in with Google</span>
        </button>
        <p id="authError" class="error-message"></p>
    `;

    const codeEntryTemplate = `
        <h2>Enter Access Code</h2>
        <p style="color: var(--text-secondary); text-align: center; margin-bottom: 1rem;">Please enter the access code provided by your administrator.</p>
        <input type="text" id="accessCodeInput" placeholder="Enter code here">
        <button id="submitCodeButton" class="btn-primary" style="width:100%">Submit Code</button>
        <p id="codeError" class="error-message"></p>
    `;

    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        storage = getStorage(app);
        console.log("Firebase initialized successfully.");
    } catch (error)
    {
        console.error("Error initializing Firebase:", error);
        showModal('Firebase Configuration Error', `Failed to initialize Firebase. Error: ${error.message}`);
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserId = user.uid;
            currentUserEmail = user.email;
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            try {
                const userProfileDoc = await getDoc(userProfileRef);
                if (userProfileDoc.exists() && userProfileDoc.data().role) {
                    const profileData = userProfileDoc.data();
                    currentUserRole = profileData.role;
                    currentUserName = profileData.name || user.displayName;
                    // Ensure xpBalance exists on profile
                    const updateData = { name: currentUserName, email: currentUserEmail, lastLogin: Date.now() };
                    if (profileData.xpBalance === undefined) {
                        updateData.xpBalance = 0;
                    }
                    await setDoc(userProfileRef, updateData, { merge: true });
                    showApp();
                } else {
                    currentUserName = user.displayName;
                    currentUserRole = 'unassigned';
                    // Ensure profile doc is created with default xpBalance
                    await setDoc(userProfileRef, { 
                        name: currentUserName, 
                        email: currentUserEmail, 
                        role: 'unassigned',
                        xpBalance: 0,
                        lastLogin: Date.now()
                    }, { merge: true });
                    showCodeEntry();
                }
            } catch (e) {
                 console.error("Error checking user profile:", e);
                 showModal('Profile Error', `Could not load user profile. Error: ${e.message}`);
                 showLogin();
            }
        } else {
            currentUserId = null;
            currentUserRole = null;
            currentUserName = null;
            xpBalance = 0;
            studyHistory = [];
            
            // Detach listeners on logout
            unsubscribePersonalEvents();
            unsubscribePublicEvents();
            unsubscribeTodos();
            unsubscribeProfile();
            unsubscribeStudyHistory();

            personalEvents = [];
            publicEvents = [];
            todoItems = [];

            showLogin();
        }
    });

    function showLogin() {
        appSection.style.display = 'none';
        authWrapper.style.display = 'flex';
        authWrapper.style.opacity = '1';
        startupAnimation.classList.remove('run-animation', 'fade-out');
        headerLogo.style.opacity = '0';
        authContainer.innerHTML = googleSignInTemplate;
        document.getElementById('googleSignInButton')?.addEventListener('click', handleGoogleSignIn);
    }

    function showCodeEntry() {
        appSection.style.display = 'none';
        authWrapper.style.display = 'flex';
        authWrapper.style.opacity = '1';
        startupAnimation.classList.remove('run-animation', 'fade-out');
        headerLogo.style.opacity = '0';
        authContainer.innerHTML = codeEntryTemplate;
        const submitCodeBtn = document.getElementById('submitCodeButton');
        const accessCodeInput = document.getElementById('accessCodeInput');
        submitCodeBtn?.addEventListener('click', () => handleSubmitCode());
        accessCodeInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSubmitCode();
            }
        });
        accessCodeInput?.focus();
    }

    async function showApp() {
        authWrapper.style.display = 'none';
        appSection.style.display = 'flex';
        userDisplayNameSpan.textContent = `${currentUserName} (${currentUserRole})`;
        document.getElementById('homeUserNamePlaceholder').textContent = currentUserName;
        
        // Show teacher controls for countdown if applicable
        if (currentUserRole === 'teacher') {
            document.getElementById('teacher-controls').style.display = 'flex';
            document.getElementById('public-event-container').style.display = 'flex';
        } else {
             document.getElementById('teacher-controls').style.display = 'none';
             document.getElementById('public-event-container').style.display = 'none';
        }

        // --- Run Animation ---
        startupAnimation.classList.add('run-animation');
        
        // Wait for animation to finish (2.5s)
        setTimeout(() => {
            // Fade out overlay
            startupAnimation.classList.add('fade-out');
            // Fade in real logo
            headerLogo.style.opacity = '1';
        }, 2500); // Must match animation duration
        

        // Start clocks and listen for countdown changes
        startClocks();
        listenForCountdownChanges();
        
        // Init dashboard
        initDashboard();
        
        // Attach listeners
        if (currentUserId) {
            listenForPersonalEvents();
            listenForPublicEvents();
            listenForTodos();
            listenForProfileChanges(); // XP System
            listenForStudyHistory(); // XP System
        }
    }

    async function handleGoogleSignIn() {
        const provider = new GoogleAuthProvider();
        try { 
            await signInWithPopup(auth, provider); 
        } catch (error) { 
            document.getElementById('authError').textContent = `Sign-in failed. Error: ${error.message}`; 
            console.error("Google Sign-In Error:", error);
        }
    }

    async function handleSubmitCode(codeValue) {
        const code = (codeValue || document.getElementById('accessCodeInput').value).trim();
        const codeError = document.getElementById('codeError');
        if(codeError) codeError.textContent = '';
        
        let roleToSet = null;
        if (code === TEACHER_CODE) roleToSet = 'teacher';
        else if (code === STUDENT_CODE) roleToSet = 'student';
        else { 
            if(codeError) codeError.textContent = 'Invalid access code.';
            return; 
        }
        
        try {
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            await setDoc(userProfileRef, { role: roleToSet }, { merge: true });
            currentUserRole = roleToSet;
            showModal('Success', `Your role has been set to ${roleToSet}.`);
            showApp();
        } catch (error) {
            if(codeError) codeError.textContent = `Could not set role. Error: ${error.message}`;
            console.error("Submit Code Error:", error);
        }
    }

    document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));

    document.getElementById('switchRoleButton').addEventListener('click', () => {
        showInputModal('Switch Role', 'Enter new access code (Teacher or Student):', async (code) => {
            await handleSubmitCode(code);
        });
    });

    // --- PROFILE EDITING ---
    userDisplayNameSpan.addEventListener('click', async () => {
        if (!currentUserId) {
            showModal('Error', 'Please log in to edit your profile.');
            return;
        }

        const profileEditModal = document.getElementById('profileEditModal');
        const editUserNameInput = document.getElementById('editUserName');
        const editUserEmailInput = document.getElementById('editUserEmail');
        const editUserRoleInput = document.getElementById('editUserRole');
        const saveProfileButton = document.getElementById('saveProfileButton');
        const cancelProfileButton = document.getElementById('cancelProfileButton');

        editUserNameInput.value = currentUserName || '';
        editUserEmailInput.value = currentUserEmail || '';
        editUserRoleInput.value = currentUserRole || '';

        profileEditModal.style.display = 'flex';

        const saveHandler = async () => {
            const newName = editUserNameInput.value.trim();
            if (!newName) {
                editUserNameInput.style.border = '1px solid var(--accent-red)';
                editUserNameInput.focus();
                return;
            }

            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await updateDoc(userProfileRef, { name: newName });
                currentUserName = newName;
                userDisplayNameSpan.textContent = `${currentUserName} (${currentUserRole})`;
                document.getElementById('homeUserNamePlaceholder').textContent = currentUserName;
                profileEditModal.style.display = 'none';
                showModal('Success', 'Profile updated successfully!');
            } catch (error) {
                console.error("Error updating profile:", error);
                showModal('Error', `Failed to update profile: ${error.message}`);
            }
            saveProfileButton.removeEventListener('click', saveHandler);
            cancelProfileButton.removeEventListener('click', cancelHandler);
        };

        const cancelHandler = () => {
            profileEditModal.style.display = 'none';
            saveProfileButton.removeEventListener('click', saveHandler);
            cancelProfileButton.removeEventListener('click', cancelHandler);
        };

        saveProfileButton.addEventListener('click', saveHandler);
        cancelProfileButton.addEventListener('click', cancelHandler);
        document.querySelector('.profile-close-button').addEventListener('click', cancelHandler);
    });

    // --- TIME AND COUNTDOWN LOGIC ---
    function startClocks() {
        const currentTimeEl = document.getElementById('currentTime');
        const currentDateEl = document.getElementById('currentDate');

        setInterval(() => {
            const now = new Date();
            // Set Time with AM/PM
            currentTimeEl.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            
            // Set Date
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            currentDateEl.textContent = now.toLocaleDateString('en-US', dateOptions);
        }, 1000);
    }

    function updateCountdown(targetDate) {
        const countdownEl = document.getElementById('countdown');
        if (countdownInterval) clearInterval(countdownInterval);

        if (!targetDate) {
            countdownEl.textContent = "No Event";
            return;
        }

        countdownInterval = setInterval(() => {
            const now = new Date().getTime();
            const distance = targetDate - now;

            if (distance < 0) {
                clearInterval(countdownInterval);
                countdownEl.textContent = "EXPIRED";
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            countdownEl.textContent = `${String(days).padStart(2, '0')}:${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }, 1000);
    }

    function listenForCountdownChanges() {
        const countdownRef = doc(db, `artifacts/${appId}/public/data/settings/countdown`);
        onSnapshot(countdownRef, (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                const targetDate = data.target ? data.target.toDate() : null;
                updateCountdown(targetDate);
            } else {
                updateCountdown(null);
            }
        });
    }

    document.getElementById('set-countdown-btn').addEventListener('click', async () => {
        const datetimeInput = document.getElementById('countdown-datetime').value;
        if (!datetimeInput) {
            showModal('Error', 'Please select a date and time.');
            return;
        }

        const targetDate = new Date(datetimeInput);
        if (isNaN(targetDate)) {
            showModal('Error', 'Invalid date and time format.');
            return;
        }

        try {
            const countdownRef = doc(db, `artifacts/${appId}/public/data/settings/countdown`);
            await setDoc(countdownRef, { target: targetDate });
            showModal('Success', 'Countdown target has been set!');
        } catch (error) {
            showModal('Error', `Could not set countdown: ${error.message}`);
            console.error("Error setting countdown:", error);
        }
    });
    
     // --- THEME TOGGLE ---
    const themeToggleButton = document.getElementById('themeToggleButton');
    function applyTheme(theme) { 
        document.body.classList.toggle('light-theme', theme === 'light'); 
    }
    function loadTheme() { 
        const savedTheme = localStorage.getItem('ai-marker-theme') || 'dark';
        applyTheme(savedTheme); 
    }
    themeToggleButton.addEventListener('click', () => {
        const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';
        applyTheme(newTheme);
        localStorage.setItem('ai-marker-theme', newTheme);
    });
    loadTheme(); // Apply theme on load

    // --- DASHBOARD: CALENDAR & TODO LOGIC ---
    
    const calendarGrid = document.getElementById('calendar-grid');
    const eventListHeader = document.getElementById('event-list-header');
    const eventList = document.getElementById('event-list');
    const addEventForm = document.getElementById('add-event-form');
    const eventDateInput = document.getElementById('event-date');
    const eventTimeInput = document.getElementById('event-time');
    const eventDescInput = document.getElementById('event-desc');
    const publicEventCheckbox = document.getElementById('public-event-checkbox');
    const todoList = document.getElementById('todo-list');
    const addTodoForm = document.getElementById('add-todo-form');
    const todoInput = document.getElementById('todo-input');
    const todoDeadlineInput = document.getElementById('todo-deadline');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    const todayBtn = document.getElementById('today-btn');
    
    const months = [
        "January", "February", "March", "April", "May", "June", 
        "July", "August", "September", "October", "November", "December"
    ];

    function initDashboard() {
        // Populate Month Select
        months.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = month;
            monthSelect.appendChild(option);
        });
        
        // Populate Year Select
        const currentYear = new Date().getFullYear();
        for (let i = currentYear - 10; i <= currentYear + 10; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            yearSelect.appendChild(option);
        }
        
        // Set initial state
        const today = new Date();
        updateCalendarState(today);
        eventDateInput.value = toLocalISODate(today); // Default event date to today
        document.getElementById('study-date').value = toLocalISODate(today); // Default study date to today
        
        // Add event listeners
        monthSelect.addEventListener('change', handleMonthYearChange);
        yearSelect.addEventListener('change', handleMonthYearChange);
        todayBtn.addEventListener('click', () => updateCalendarState(new Date()));
        addEventForm.addEventListener('submit', handleAddEvent);
        addTodoForm.addEventListener('submit', handleAddTodo);
        
        // *** NEW: Add listener for immediate status changes on To-Do list
        todoList.addEventListener('change', handleTodoStatusChange);

        // *** NEW: Add listeners for XP System
        document.getElementById('log-study-btn').addEventListener('click', handleLogStudy);
        document.getElementById('redeemHalfDayBtn').addEventListener('click', handleRedeemPoints);
        document.getElementById('redeemFullDayBtn').addEventListener('click', handleRedeemPoints);
        // *** NEW: Add listener for deleting study logs
        document.getElementById('study-history-list').addEventListener('click', handleDeleteStudyLog);
    }
    
    function handleMonthYearChange() {
        currentMonth = parseInt(monthSelect.value);
        currentYear = parseInt(yearSelect.value);
        renderCalendar();
    }

    function updateCalendarState(date) {
        currentSelectedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        currentMonth = currentSelectedDate.getMonth();
        currentYear = currentSelectedDate.getFullYear();
        
        monthSelect.value = currentMonth;
        yearSelect.value = currentYear;
        
        eventDateInput.value = toLocalISODate(currentSelectedDate); // FIX: Use new local-aware function
        
        renderCalendar();
        renderEventsForDay();
    }

    function renderCalendar() {
        // Clear grid but keep headers
        while (calendarGrid.children.length > 7) {
            calendarGrid.removeChild(calendarGrid.lastChild);
        }

        const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const today = new Date();

        // Add blank days
        for (let i = 0; i < firstDayOfMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day other-month';
            calendarGrid.appendChild(dayEl);
        }

        // Add month days
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            const dayDate = new Date(currentYear, currentMonth, i);
            const dateStr = toLocalISODate(dayDate); // FIX: Use new local-aware function
            
            dayEl.className = 'calendar-day';
            dayEl.textContent = i;
            dayEl.dataset.date = dateStr;

            // Mark today
            if (isSameDay(dayDate, today)) {
                dayEl.classList.add('today');
            }
            
            // Mark selected
            if (isSameDay(dayDate, currentSelectedDate)) {
                dayEl.classList.add('selected');
            }
            
            // Check for events on this day
            const hasPublicEvent = publicEvents.some(e => e.date === dateStr);
            const hasPersonalEvent = personalEvents.some(e => e.date === dateStr);

            if (hasPublicEvent || hasPersonalEvent) {
                const marker = document.createElement('div');
                marker.className = 'event-marker';
                if (hasPublicEvent) {
                    marker.classList.add('public');
                }
                dayEl.appendChild(marker);
            }

            dayEl.addEventListener('click', () => {
                updateCalendarState(dayDate);
            });
            
            calendarGrid.appendChild(dayEl);
        }
    }
    
    function renderEventsForDay() {
        eventList.innerHTML = '';
        const selectedDateStr = toLocalISODate(currentSelectedDate); // FIX: Use new local-aware function
        eventListHeader.textContent = `Events for: ${currentSelectedDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
        
        const dayEvents = [
            ...personalEvents.filter(e => e.date === selectedDateStr),
            ...publicEvents.filter(e => e.date === selectedDateStr)
        ];
        
        // Sort events by time
        dayEvents.sort((a, b) => a.time.localeCompare(b.time));

        if (dayEvents.length === 0) {
            eventList.innerHTML = `<p style="color: var(--text-secondary); font-size: 0.9rem;">No events for this day.</p>`;
            return;
        }

        dayEvents.forEach(event => {
            const isPublicEvent = event.isPublic; 
            
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.dataset.id = event.id;
            eventItem.dataset.isPublic = isPublicEvent;

            const details = document.createElement('div');
            details.className = 'event-item-details';
            
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.textContent = isPublicEvent ? 'PUBLIC' : 'MY EVENT';
            if (isPublicEvent) tag.classList.add('public');

            details.appendChild(tag);
            details.innerHTML += `<span>${event.time}</span> ${event.description}`;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-event';
            deleteBtn.innerHTML = '&times;';
            deleteBtn.title = 'Delete event';
            deleteBtn.addEventListener('click', handleDeleteEvent);
            
            // Hide delete button if it's a public event and user is not a teacher
            if (isPublicEvent && currentUserRole !== 'teacher') {
                deleteBtn.style.display = 'none';
            }
            
            eventItem.appendChild(details);
            eventItem.appendChild(deleteBtn);
            eventList.appendChild(eventItem);
        });
    }

    function renderTodos() {
        todoList.innerHTML = '';
        
        // Sort todos: not-started and half-done first, then full-done
        const sortedTodos = [...todoItems].sort((a, b) => {
            const statusOrder = { 'not-started': 1, 'half-done': 2, 'full-done': 3 };
            return statusOrder[a.status] - statusOrder[b.status];
        });
        
        if (sortedTodos.length === 0) {
            todoList.innerHTML = `<p style="color: var(--text-secondary); font-size: 0.9rem;">No tasks added yet.</p>`;
            return;
        }

        sortedTodos.forEach(todo => {
            const todoItem = document.createElement('div');
            todoItem.className = 'todo-item';
            todoItem.dataset.id = todo.id;

            // Status Select
            const statusSelect = document.createElement('select');
            statusSelect.className = 'status-select';
            const statuses = [
                { value: 'not-started', text: 'Not Started' },
                { value: 'half-done', text: 'Half Done' },
                { value: 'full-done', text: 'Full Done' }
            ];
            statuses.forEach(s => {
                const option = document.createElement('option');
                option.value = s.value;
                option.textContent = s.text;
                if (s.value === todo.status) option.selected = true;
                statusSelect.appendChild(option);
            });
            
            // Details
            const details = document.createElement('div');
            details.className = 'todo-item-details';
            
            // Create a text node for the description and append it
            const descriptionNode = document.createTextNode(todo.description);
            details.appendChild(descriptionNode);
            
            if (todo.status === 'half-done') details.classList.add('status-half-done');
            if (todo.status === 'full-done') details.classList.add('status-full-done');

            // Deadline
            if (todo.deadline) {
                const deadlineEl = document.createElement('span');
                deadlineEl.className = 'todo-deadline';
                deadlineEl.textContent = `Deadline: ${todo.deadline}`;
                details.appendChild(deadlineEl);
            }

            // Delete Button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-todo';
            deleteBtn.innerHTML = '&times;';
            deleteBtn.title = 'Delete task';
            deleteBtn.addEventListener('click', () => handleDeleteTodo(todo.id));

            todoItem.appendChild(statusSelect);
            todoItem.appendChild(details);
            todoItem.appendChild(deleteBtn);
            todoList.appendChild(todoItem);
        });
    }
    
    // --- Firestore Listeners ---
    function listenForPersonalEvents() {
        if (!currentUserId) return;
        unsubscribePersonalEvents(); // Detach old listener
        
        const personalEventsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/events`);
        const q = query(personalEventsRef);
        
        unsubscribePersonalEvents = onSnapshot(q, (snapshot) => {
            personalEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderCalendar();
            renderEventsForDay();
        }, (error) => {
            console.error("Error listening to personal events:", error);
            showModal("Error", "Could not load personal events.");
        });
    }
    
    function listenForPublicEvents() {
        unsubscribePublicEvents(); // Detach old listener
        
        const publicEventsRef = collection(db, `artifacts/${appId}/public/data/public_events`);
        const q = query(publicEventsRef);
        
        unsubscribePublicEvents = onSnapshot(q, (snapshot) => {
            publicEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderCalendar();
            renderEventsForDay();
        }, (error) => {
            console.error("Error listening to public events:", error);
            showModal("Error", "Could not load public events.");
        });
    }

    function listenForTodos() {
        if (!currentUserId) return;
        unsubscribeTodos(); // Detach old listener
        
        const todosRef = collection(db, `artifacts/${appId}/users/${currentUserId}/todos`);
        const q = query(todosRef); // Add orderBy('createdAt', 'desc') if you add timestamps
        
        unsubscribeTodos = onSnapshot(q, (snapshot) => {
            todoItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTodos();
        }, (error) => {
            console.error("Error listening to todos:", error);
            showModal("Error", "Could not load tasks.");
        });
    }

    // --- Firestore Handlers (Write, Update, Delete) ---
    async function handleAddEvent(e) {
        e.preventDefault();
        const eventDesc = eventDescInput.value.trim();
        const eventTime = eventTimeInput.value;
        const selectedDateStr = eventDateInput.value;
        const isPublic = publicEventCheckbox.checked && currentUserRole === 'teacher';

        if (!eventDesc || !eventTime || !selectedDateStr) {
            showModal('Error', 'Please fill in all event fields.');
            return;
        }

        try {
            const newEvent = {
                date: selectedDateStr,
                time: eventTime,
                description: eventDesc,
                isPublic: isPublic,
                createdAt: serverTimestamp(),
                userId: currentUserId // Store creator ID even for public events
            };

            const collectionPath = isPublic 
                ? `artifacts/${appId}/public/data/public_events`
                : `artifacts/${appId}/users/${currentUserId}/events`;
            
            await addDoc(collection(db, collectionPath), newEvent);
            
            // Clear form
            eventDescInput.value = '';
            eventTimeInput.value = '';
            publicEventCheckbox.checked = false;
            
        } catch (error) {
            console.error("Error adding event:", error);
            showModal('Error', `Could not add event: ${error.message}`);
        }
    }
    
    async function handleDeleteEvent(e) {
        const eventEl = e.target.closest('.event-item');
        const eventId = eventEl.dataset.id;
        const isPublicEvent = eventEl.dataset.isPublic === 'true';

        if (!eventId) return;

        // Confirmation
        showModal(
            'Delete Event', 
            'Are you sure you want to delete this event?', 
            [
                { 
                    text: 'Cancel', 
                    className: 'logout-btn' 
                },
                { 
                    text: 'Delete', 
                    className: 'btn-primary', 
                    onClick: async () => {
                        try {
                            const collectionPath = isPublicEvent
                                ? `artifacts/${appId}/public/data/public_events`
                                : `artifacts/${appId}/users/${currentUserId}/events`;
                            
                            await deleteDoc(doc(db, collectionPath, eventId));
                        } catch (error) {
                            console.error("Error deleting event:", error);
                            showModal('Error', `Could not delete event: ${error.message}`);
                        }
                    }
                }
            ]
        );
    }
    
    async function handleAddTodo(e) {
        e.preventDefault();
        const description = todoInput.value.trim();
        const deadline = todoDeadlineInput.value || null; // Store as null if empty
        
        if (!description) {
            showModal('Error', 'Please enter a task description.');
            return;
        }

        try {
            const newTodo = {
                description: description,
                status: 'not-started', // Default status
                deadline: deadline,
                createdAt: serverTimestamp(),
                userId: currentUserId
            };
            
            const todosRef = collection(db, `artifacts/${appId}/users/${currentUserId}/todos`);
            await addDoc(todosRef, newTodo);
            
            todoInput.value = '';
            todoDeadlineInput.value = '';

        } catch (error) {
            console.error("Error adding todo:", error);
            showModal('Error', `Could not add task: ${error.message}`);
        }
    }

    // *** NEW: Handle immediate status change from dropdown
    function handleTodoStatusChange(e) {
        if (!e.target.classList.contains('status-select')) return;
        
        const todoItem = e.target.closest('.todo-item');
        const docId = todoItem.dataset.id;
        const newStatus = e.target.value;
        
        if (!docId) return;

        // Update visuals immediately
        const details = todoItem.querySelector('.todo-item-details');
        details.classList.remove('status-half-done', 'status-full-done');
        if (newStatus === 'half-done') details.classList.add('status-half-done');
        if (newStatus === 'full-done') details.classList.add('status-full-done');
        
        // Update Firestore in the background
        handleUpdateTodoStatus(docId, newStatus);
    }
    
    async function handleUpdateTodoStatus(docId, newStatus) {
        try {
            const todoRef = doc(db, `artifacts/${appId}/users/${currentUserId}/todos`, docId);
            await updateDoc(todoRef, { status: newStatus });
        } catch (error) {
            console.error("Error updating todo status:", error);
            showModal('Error', `Could not update task: ${error.message}`);
        }
    }

    async function handleDeleteTodo(docId) {
        if (!docId) return;
        
        // Confirmation
        showModal(
            'Delete Task', 
            'Are you sure you want to delete this task?', 
            [
                { 
                    text: 'Cancel', 
                    className: 'logout-btn' 
                },
                { 
                    text: 'Delete', 
                    className: 'btn-primary', 
                    onClick: async () => {
                        try {
                            const todoRef = doc(db, `artifacts/${appId}/users/${currentUserId}/todos`, docId);
                            await deleteDoc(todoRef);
                        } catch (error) {
                            console.error("Error deleting todo:", error);
                            showModal('Error', `Could not delete task: ${error.message}`);
                        }
                    }
                }
            ]
        );
    }

    // --- XP SYSTEM FUNCTIONS ---
    
    function listenForProfileChanges() {
        if (!currentUserId) return;
        unsubscribeProfile(); // Detach old listener
        
        const profileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
        
        unsubscribeProfile = onSnapshot(profileRef, (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                xpBalance = data.xpBalance || 0;
                document.getElementById('xpBalanceDisplay').textContent = xpBalance;
                updateRedeemButtons();
            } else {
                // This case should be handled by onAuthStateChanged, but as a fallback:
                xpBalance = 0;
                document.getElementById('xpBalanceDisplay').textContent = '0';
                updateRedeemButtons();
            }
        }, (error) => {
            console.error("Error listening to profile:", error);
            showModal("Error", "Could not load XP balance.");
        });
    }

    function listenForStudyHistory() {
        if (!currentUserId) return;
        unsubscribeStudyHistory(); // Detach old listener

        const studyHistoryRef = collection(db, `artifacts/${appId}/users/${currentUserId}/studyHistory`);
        // Get the latest 50 logs. We will sort them by date in JS.
        const q = query(studyHistoryRef, limit(50));
        
        unsubscribeStudyHistory = onSnapshot(q, (snapshot) => {
            studyHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // Sort by date descending (newest first)
            studyHistory.sort((a, b) => b.date.localeCompare(a.date));
            renderStudyHistory();
        }, (error) => {
            console.error("Error listening to study history:", error);
            showModal("Error", "Could not load study history.");
        });
    }

    function renderStudyHistory() {
        const listEl = document.getElementById('study-history-list');
        listEl.innerHTML = ''; // Clear list
        
        if (studyHistory.length === 0) {
            listEl.innerHTML = `<p style="color: var(--text-secondary); text-align: center;">No study logs yet.</p>`;
            return;
        }

        // Show only the 10 most recent logs from our sorted list
        const recentLogs = studyHistory.slice(0, 10);
        
        recentLogs.forEach(log => {
            const itemEl = document.createElement('div');
            itemEl.className = 'study-log-item';
            
            const isRedemption = log.description;
            const pointsClass = log.pointsEarned > 0 ? 'positive' : 'negative';
            const displayHours = log.hours ? log.hours.toFixed(2) : '0';
            const displayPoints = log.pointsEarned ? log.pointsEarned.toFixed(1) : '0';

            itemEl.innerHTML = `
                <div>
                    <span class="log-date">${log.date} ${isRedemption ? '- ' + log.description : ''}</span>
                    <span class="log-hours">${isRedemption ? '' : `(${displayHours} hrs)`}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="log-points ${pointsClass}">${log.pointsEarned > 0 ? '+' : ''}${displayPoints} XP</span>
                    ${isRedemption ? '' : `<button class="delete-log-btn" data-id="${log.id}" data-points="${log.pointsEarned}">&times;</button>`}
                </div>
            `;

            listEl.appendChild(itemEl);
        });
    }

    function updateRedeemButtons() {
        document.getElementById('redeemHalfDayBtn').disabled = xpBalance < 150;
        document.getElementById('redeemFullDayBtn').disabled = xpBalance < 300;
    }

    async function handleLogStudy() {
        const date = document.getElementById('study-date').value;
        const hoursInput = parseInt(document.getElementById('study-hours-input').value) || 0;
        const minutesInput = parseInt(document.getElementById('study-minutes-input').value) || 0;

        if (hoursInput < 0 || minutesInput < 0 || minutesInput > 59) {
            showModal('Error', 'Please enter valid hours (0 or more) and minutes (0-59).');
            return;
        }

        // Convert to decimal hours and round to 2 places
        const totalDecimalHours = hoursInput + (minutesInput / 60);
        const hours = parseFloat(totalDecimalHours.toFixed(2));

        if (!date || isNaN(hours) || hours <= 0) {
            showModal('Error', 'Please enter a valid date and a total time greater than 0 minutes.');
            return;
        }

        // Check if a log for this date already exists
        const existingLog = studyHistory.find(log => log.date === date && log.hours > 0);
        if (existingLog) {
            showModal('Error', 'A study log for this date already exists. You can only log study time once per day.');
            return;
        }

        try {
            // Calculate points from hours, rounded to 1 decimal place
            const pointsFromHours = parseFloat((hours * 10).toFixed(1));
            
            // Create a temporary log to pass to the bonus checker
            const tempLogForBonusCheck = {
                date: date,
                hours: hours,
                pointsEarned: pointsFromHours // This is temporary, just for the check
            };

            // Check for bonus. Pass the new log and the *current* history.
            const bonusPoints = await checkConsecutiveBonus(tempLogForBonusCheck, studyHistory);
            const totalPointsForThisLog = pointsFromHours + bonusPoints;

            // This is the final log object to be saved
            const newLog = {
                date: date,
                hours: hours,
                pointsEarned: totalPointsForThisLog, // Store the total (hours + bonus)
                createdAt: serverTimestamp(),
                userId: currentUserId
            };

            // Update profile balance
            const profileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            // Use increment for safer concurrent updates
            await updateDoc(profileRef, { xpBalance: increment(totalPointsForThisLog) });

            // Add the new log to history (this will trigger the listener to update the UI)
            await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/studyHistory`), newLog);

            let successMessage = `Logged ${hours.toFixed(2)} hours and earned ${pointsFromHours.toFixed(1)} XP!`;
            if (bonusPoints > 0) {
                successMessage = `Logged ${hours.toFixed(2)} hours, earned ${pointsFromHours.toFixed(1)} XP + ${bonusPoints} bonus for a 5-day streak! Total: ${totalPointsForThisLog.toFixed(1)} XP`;
            }
            showModal('Success', successMessage);
            
            // Clear inputs
            document.getElementById('study-hours-input').value = '';
            document.getElementById('study-minutes-input').value = '';

        } catch (error) {
            console.error("Error logging study time:", error);
            showModal('Error', `Could not log study time: ${error.message}`);
        }
    }

    async function checkConsecutiveBonus(newLog, currentHistory) {
        if (newLog.hours < 3) return 0; // No bonus if study time is less than 3 hours

        // Combine new log with history, filter for >3hr logs, and sort by date
        const allLogs = [...currentHistory, newLog]
            .filter(log => log.hours >= 3)
            .sort((a, b) => b.date.localeCompare(a.date));

        // Find the index of our new log
        const newLogIndex = allLogs.findIndex(log => log.date === newLog.date);
        
        // This should not happen, but as a safeguard
        if (newLogIndex === -1) return 0; 
        
        let consecutiveDays = 1; // Start with the new log
        let lastDate = new Date(allLogs[newLogIndex].date);

        // Iterate through older logs
        for (let i = newLogIndex + 1; i < allLogs.length; i++) {
            const currentDate = new Date(allLogs[i].date);
            const diffTime = lastDate.getTime() - currentDate.getTime();
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 1) {
                // This day is exactly 1 day before the last
                consecutiveDays++;
                lastDate = currentDate;
            } else if (diffDays > 1) {
                // Gap in days, break streak
                break;
            }
            // If diffDays is 0, it's a duplicate (should be filtered, but good to handle)
            
            if (consecutiveDays === 5) {
                // As soon as we hit 5, award bonus and stop.
                // This awards the bonus *on* the 5th day.
                return 50;
            }
        }
        
        return 0; // No 5-day streak found
    }

    function handleRedeemPoints(e) {
        const cost = parseInt(e.target.dataset.cost);
        const itemName = cost === 150 ? "Half Day Off" : "Full Day Off";

        if (xpBalance < cost) {
            showModal('Error', 'Not enough XP to redeem this item.');
            return;
        }

        showModal(
            'Confirm Redemption',
            `Are you sure you want to redeem a "${itemName}" for ${cost} XP?`,
            [
                { text: 'Cancel', className: 'logout-btn' },
                {
                    text: 'Redeem',
                    className: 'btn-primary',
                    onClick: async () => {
                        try {
                            // 1. Update profile balance
                            const profileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                            // Use increment (negative) for safer concurrent updates
                            await updateDoc(profileRef, { xpBalance: increment(-cost) });
                            
                            // 2. Add a redemption log to history
                            const redemptionLog = {
                                date: toLocalISODate(new Date()), // FIX: Use new local-aware function
                                hours: 0,
                                pointsEarned: -cost, // Negative points
                                description: `Redeemed ${itemName}`,
                                createdAt: serverTimestamp(),
                                userId: currentUserId
                            };
                            await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/studyHistory`), redemptionLog);

                            showModal('Success', `Redeemed ${itemName}! Your new balance is ${xpBalance - cost} XP.`);
                            // The listeners will handle updating the UI
                        } catch (error) {
                             console.error("Error redeeming points:", error);
                             showModal('Error', `Could not redeem item: ${error.message}`);
                        }
                    }
                }
            ]
        );
    }

    // *** NEW: Function to delete a study log
    function handleDeleteStudyLog(e) {
        if (!e.target.classList.contains('delete-log-btn')) return;

        const button = e.target;
        const logId = button.dataset.id;
        const pointsEarned = parseFloat(button.dataset.points);

        if (!logId || isNaN(pointsEarned)) return;

        showModal(
            'Delete Study Log',
            `Are you sure you want to delete this log? This will subtract ${pointsEarned.toFixed(1)} XP from your balance. This action cannot be undone.`,
            [
                { text: 'Cancel', className: 'logout-btn' },
                {
                    text: 'Delete',
                    className: 'btn-primary',
                    onClick: async () => {
                        try {
                            // 1. Remove the points from the user's profile
                            const profileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                            await updateDoc(profileRef, { xpBalance: increment(-pointsEarned) });

                            // 2. Delete the log document
                            const logRef = doc(db, `artifacts/${appId}/users/${currentUserId}/studyHistory`, logId);
                            await deleteDoc(logRef);

                            showModal('Success', 'Study log deleted and XP balance updated.');
                            // The listeners will automatically update the UI
                        } catch (error) {
                            console.error("Error deleting study log:", error);
                            showModal('Error', `Could not delete log: ${error.message}`);
                        }
                    }
                }
            ]
        );
    }


    // --- UTILITY FUNCTIONS ---
    
    // FIX: Replaced toISODate with a new function that correctly handles local dates
    // to avoid timezone conversion errors.
    function toLocalISODate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function isSameDay(date1, date2) {
        return date1.getFullYear() === date2.getFullYear() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getDate() === date2.getDate();
    }
    
    // --- MODAL FUNCTIONS ---
    function showModal(title, message, buttons = []) {
        const messageModal = document.getElementById('messageModal');
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').innerHTML = message;
        const modalButtons = document.getElementById('modalButtons');
        modalButtons.innerHTML = '';

        if (buttons.length === 0) {
             const okButton = document.createElement('button');
             okButton.textContent = 'OK';
             okButton.className = 'btn-primary';
             okButton.onclick = () => { messageModal.style.display = 'none'; };
             modalButtons.appendChild(okButton);
        } else {
             buttons.forEach(btnConfig => {
                const button = document.createElement('button');
                button.textContent = btnConfig.text;
                button.className = btnConfig.className;
                button.onclick = () => { 
                    messageModal.style.display = 'none';
                    if (btnConfig.onClick) btnConfig.onClick();
                };
                modalButtons.appendChild(button);
            });
        }
        messageModal.style.display = 'flex';
    }
    
    function showInputModal(title, label, callback) {
        const messageModal = document.getElementById('messageModal');
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').innerHTML = `<label for="modalInput" style="display:block; margin-bottom:8px;">${label}</label><input type="text" id="modalInput" class="modal-input" required>`;
        const modalButtons = document.getElementById('modalButtons');
        modalButtons.innerHTML = ''; 

        const modalInput = document.getElementById('modalInput');
        const saveButton = document.createElement('button');
        saveButton.textContent = 'Save';
        saveButton.className = 'btn-primary';
        saveButton.onclick = () => {
            const value = modalInput.value.trim();
            if (value) {
                messageModal.style.display = 'none';
                callback(value);
            } else {
                modalInput.style.border = '1px solid var(--accent-red)';
                modalInput.focus();
            }
        };
        modalButtons.appendChild(saveButton);

        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'Cancel';
        cancelButton.className = 'logout-btn';
        cancelButton.onclick = () => { messageModal.style.display = 'none'; };
        modalButtons.appendChild(cancelButton);

        messageModal.style.display = 'flex';
        modalInput.focus();
        modalInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); saveButton.click(); } });
    }

    document.querySelectorAll('.modal .close-button').forEach(btn => btn.onclick = () => { 
        const modal = btn.closest('.modal');
        modal.style.display = 'none'; 
    });
  </script>
</body>
</html>
