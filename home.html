<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Marker - Home</title>
  <style>
    /* #region CORE THEME & VARIABLES */
    :root {
        --bg-primary: #0a0a0a; /* Near black for main background */
        --bg-secondary: #1a1a1a; /* Dark gray for secondary elements */
        --bg-tertiary: #2a2a2a; /* Lighter gray for hovers */
        --text-primary: #f5f5f5; /* Off-white for primary text */
        --text-secondary: #a3a3a3; /* Muted gray for secondary text */
        --accent-primary: #ffffff; /* White for key actions and highlights */
        --accent-red: #ef4444; /* A modern, sharp red for destructive actions */
        --border-color: #333333; /* Subtle border color */
        --focus-ring-color: rgba(245, 245, 245, 0.5); /* Semi-transparent white for focus rings */

        /* Finder Window Specific Variables */
        --finder-bg-primary: #1c1c1c;
        --finder-bg-secondary: #0a0a0a;
        --finder-text-primary: #f5f5f5;
        --finder-text-secondary: #a3a3a3;
        --finder-border-color: #333333;
        --finder-titlebar-bg: #2a2a2a;
        --finder-hover-bg: #333333;
        --finder-active-bg: var(--accent-primary);
        --finder-active-text: #0a0a0a;
    }

    body.light-theme {
        --bg-primary: #ffffff;
        --bg-secondary: #f5f5f5;
        --bg-tertiary: #e5e5e5;
        --text-primary: #0a0a0a;
        --text-secondary: #737373;
        --accent-primary: #0a0a0a;
        --border-color: #d4d4d4;
        --focus-ring-color: rgba(10, 10, 10, 0.5);

        --finder-bg-primary: #ffffff;
        --finder-bg-secondary: #f5f5f5;
        --finder-text-primary: #0a0a0a;
        --finder-text-secondary: #737373;
        --finder-border-color: #d4d4d4;
        --finder-titlebar-bg: #e5e5e5;
        --finder-hover-bg: #e5e5e5;
        --finder-active-bg: var(--accent-primary);
        --finder-active-text: #ffffff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text-primary);
        background-color: var(--bg-primary);
        overflow-x: hidden;
        scroll-behavior: smooth;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        transition: background-color 0.3s, color 0.3s;
    }
    /* #endregion */

    /* #region UI ELEMENTS (Buttons, Inputs, Modals) */
    button, input, textarea, select {
        transition: all .2s ease-in-out;
        font-family: inherit;
        color: var(--text-primary);
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 8px 10px;
    }
    
    select {
        -webkit-appearance: none; -moz-appearance: none; appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23a3a3a3' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
        padding-right: 30px;
    }
    
    body.light-theme select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23737373' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
    }

    input:focus, select:focus, textarea:focus {
        outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--focus-ring-color);
    }
    
    input[type="date"], input[type="time"] { color-scheme: dark; }
    body.light-theme input[type="date"], body.light-theme input[type="time"] { color-scheme: light; }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .btn-primary {
         background-color: var(--accent-primary); color: var(--bg-primary); padding: .75rem 1.5rem;
         border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 1rem;
    }
    body.light-theme .btn-primary { color: var(--bg-primary); }
    .btn-primary:hover { opacity: 0.85; transform: translateY(-1px); }

    /* Modals */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; animation: fadeIn 0.3s ease-out; }
    .modal-content { background-color: var(--bg-secondary); padding: 30px; border-radius: 12px; border: 1px solid var(--border-color); max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; animation: slideInUp 0.3s ease-out; }
    #modalTitle { margin-bottom: 1rem; font-size: 1.5rem; font-weight: 600; }
    .close-button { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: var(--text-secondary); }
    .close-button:hover { color: var(--text-primary); }
    #modalButtons { display:flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
    .modal-input { background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px; border-radius: 6px; width: 100%; margin-top: 10px; }
    .modal-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 2px var(--focus-ring-color); }
    /* #endregion */

    /* #region ANIMATIONS */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    #startupAnimation {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: var(--bg-primary); z-index: 2000;
        display: flex; justify-content: center; align-items: center;
        pointer-events: none; opacity: 0;
    }
    #animatedLogo { font-size: 10vw; font-weight: 700; color: var(--text-primary); transform: translate(0, 0) scale(1); opacity: 0; }
    #startupAnimation.run-animation { opacity: 1; }
    #startupAnimation.run-animation #animatedLogo { animation: shrinkToCorner 2.5s cubic-bezier(0.65, 0, 0.35, 1) forwards; }
    #startupAnimation.fade-out { opacity: 0; transition: opacity 0.5s ease-out; }
    header .logo-container h1 { opacity: 0; }

    @keyframes shrinkToCorner {
        0% { transform: translate(0, 0) scale(1); font-size: 10vw; opacity: 0; }
        20% { transform: translate(0, 0) scale(1); font-size: 10vw; opacity: 1; }
        50% { transform: translate(0, 0) scale(1); font-size: 10vw; opacity: 1; }
        100% { transform: translate(calc(-50vw + 90px), calc(-50vh + 34px)); font-size: 1.25rem; opacity: 1; }
    }
    /* #endregion */

    /* #region LOGIN & AUTH */
    #authWrapper {
        display: flex; width: 100vw; height: 100vh; position: fixed; top: 0; left: 0;
        opacity: 0; transition: opacity 0.5s ease-in-out; z-index: 1001;
    }
    .login-left-panel, .login-right-panel { width: 50%; display: flex; justify-content: center; align-items: center; padding: 2rem; }
    .login-left-panel { background: var(--bg-primary); color: var(--text-primary); flex-direction: column; text-align: center; }
    .login-left-panel h1 { font-size: 3.5rem; font-weight: 700; letter-spacing: -1px; margin-bottom: 1rem; }
    .login-left-panel p { font-size: 1.25rem; font-weight: 400; line-height: 1.5; margin-bottom: .5rem; color: var(--text-secondary); }
    .login-right-panel { background: var(--bg-secondary); flex-direction: column; }
    
    #authContainer {
        width: 100%; max-width: 380px; display: flex; flex-direction: column; align-items: stretch;
        background-color: var(--bg-primary); padding: 2.5rem; border-radius: 12px; border: 1px solid var(--border-color);
    }
    #authContainer h2 { font-size: 2rem; font-weight: 600; color: var(--text-primary); margin-bottom: 2rem; text-align: center; }
    .google-btn {
        display: flex; align-items: center; justify-content: center; gap: 12px;
        border: 1px solid var(--border-color); border-radius: 8px; padding: .75rem;
        cursor: pointer; background: var(--bg-secondary); color: var(--text-primary);
        font-size: 1rem; font-weight: 500; margin-bottom: 1rem;
    }
    .google-btn:hover { background-color: var(--bg-tertiary); border-color: var(--text-secondary); }
    .google-btn img { height: 20px; }
    #accessCodeInput {
         background-color: var(--bg-secondary); border: 1px solid var(--border-color);
         color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%;
         margin-bottom: 1rem; text-align: center; font-size: 1rem;
    }
    #accessCodeInput:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--focus-ring-color); }
    /* #endregion */

    /* #region HEADER & NAV */
    #appSection { display: none; flex-direction: column; height: 100vh; background-color: var(--bg-primary); animation: fadeIn .6s ease-out both; }
    header {
        background: var(--bg-primary); color: var(--text-primary); display: flex;
        align-items: center; justify-content: space-between; padding: 0 24px; height: 64px;
        border-bottom: 1px solid var(--border-color); flex-shrink: 0;
    }
    .logo-container { display: flex; flex-direction: column; line-height: 1.2; }
    .logo-container h1 { font-size: 1.25rem; font-weight: 700; transition: opacity 0.5s ease-out; }
    .logo-container p { font-size: 0.8rem; color: var(--text-secondary); }

    .header-actions { display: flex; align-items: center; gap: 1rem; }
    .header-actions .tab, .header-actions .dropdown-menu > button {
        padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 500; cursor: pointer;
        color: var(--text-secondary); background: transparent; border: none; transition: background 0.2s, color 0.2s;
    }
    .header-actions .tab:hover, .header-actions .dropdown-menu > button:hover { background: var(--bg-secondary); color: var(--text-primary); }
    .header-actions .tab.active, .header-actions .dropdown-menu > button.active { background: var(--bg-secondary); color: var(--accent-primary); font-weight: 600; }

    .dropdown-menu { position: relative; }
    .dropdown-menu-content {
        display: none; position: absolute; top: 100%; left: 0; background-color: var(--bg-secondary);
        min-width: 180px; box-shadow: 0 6px 18px rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden; z-index: 20;
    }
    .dropdown-menu-content a, .dropdown-menu-content button {
        display: block; padding: 10px 14px; font-size: 0.9rem; color: var(--text-secondary);
        text-decoration: none; transition: background 0.2s, color 0.2s; background: none; border: none;
        width: 100%; text-align: left; cursor: pointer;
    }
    .dropdown-menu-content a:hover, .dropdown-menu-content button:hover { background-color: var(--bg-tertiary); color: var(--text-primary); }
    .dropdown-menu:hover .dropdown-menu-content { display: block; }
    .user-info { display: flex; align-items: center; gap: 1rem; margin-left: 1rem; }
    #userDisplayName { font-weight: 500; cursor: pointer; }
    .logout-btn { background: none; border: 1px solid var(--border-color); color: var(--text-secondary); cursor: pointer; padding: 6px 12px; border-radius: 8px; font-weight: 600; }
    .logout-btn:hover { background: var(--accent-red); border-color: var(--accent-red); color: var(--accent-primary); }
    #switchRoleButton { background-color: var(--bg-secondary); color: var(--text-primary); padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer; font-weight: 600; }
    #switchRoleButton:hover { background-color: var(--bg-tertiary); border-color: var(--text-secondary); }
    /* #endregion */

    /* #region HERO & MAIN LAYOUT */
    main {
        flex: 1; display: flex; flex-direction: column; overflow-y: auto;
        padding: 32px; gap: 32px; align-items: center;
    }
    .hero {
        display: flex; flex-wrap: wrap; align-items: center; justify-content: center;
        gap: 4rem; padding: 4rem 2rem; max-width: 1200px; width: 100%;
    }
    .hero-text { flex: 1; min-width: 300px; text-align: center; }
    .hero-text h2 { font-size: 3rem; font-weight: 700; margin-bottom: 1rem; color: var(--text-primary); }
    .hero-text h2 span { color: var(--accent-primary); }
    .hero-text .buttons { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
    .hero-text .buttons a {
        background-color: var(--accent-primary); color: var(--bg-primary); padding: 0.8rem 1.8rem;
        border-radius: 8px; text-decoration: none; font-weight: 600; transition: opacity 0.2s, transform 0.2s; font-size: 1rem;
    }
    .hero-text .buttons a:hover { opacity: 0.85; transform: translateY(-2px); }
    .hero-image { flex: 1; min-width: 300px; display: flex; justify-content: center; align-items: center; }
    .hero-image img { max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }
    /* #endregion */

    /* #region STUDY TOOLS (Time, Stopwatch, Timer) */
    .time-info-section, .study-tools-section, .xp-system-section, .dashboard-container { width: 100%; max-width: 1200px; }
    .time-info-section, .study-tools-section, .xp-system-section {
        padding: 2rem; background-color: var(--bg-secondary); border-radius: 12px;
        display: flex; flex-wrap: wrap; justify-content: center; gap: 2rem;
    }
    .time-container { display: flex; justify-content: center; width: 100%; flex-wrap: wrap; gap: 2rem; }
    .time-box, .study-tool-box {
        background-color: var(--bg-primary); padding: 2rem; border-radius: 12px; border: 1px solid var(--border-color);
        text-align: center; flex: 1; min-width: 300px; display: flex; flex-direction: column; align-items: center;
    }
    .time-label { font-size: 1rem; color: var(--text-secondary); display: block; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 1.5px; }
    .time-display, .countdown-display { font-size: 3.5rem; font-weight: 600; letter-spacing: -1px; color: var(--text-primary); font-variant-numeric: tabular-nums; line-height: 1.1; }
    .date-display { font-size: 1.1rem; font-weight: 400; color: var(--text-secondary); margin-top: 0.75rem; letter-spacing: 0.5px; }
    
    #teacher-controls { display: none; align-items: center; gap: 0.5rem; margin-top: 1rem; padding: 1rem; background-color: var(--bg-primary); border-radius: 8px; width: 100%; max-width: 500px; justify-content: center; }
    #countdown-datetime { background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; }
    #set-countdown-btn { background-color: var(--accent-primary); color: var(--bg-primary); padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
    body.light-theme #set-countdown-btn { color: var(--bg-primary); }

    .study-tool-box h3 { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; text-align: center; }
    .study-tool-display { font-size: 2.75rem; font-weight: 600; letter-spacing: -1px; color: var(--text-primary); font-variant-numeric: tabular-nums; line-height: 1.1; margin: 0.5rem 0; }
    .timer-inputs { display: flex; gap: 5px; align-items: center; justify-content: center; }
    .timer-inputs input { width: 60px; text-align: center; font-size: 1rem; padding: 8px; }
    .timer-inputs input:disabled { background-color: var(--bg-tertiary); opacity: 0.7; }
    .timer-inputs span { font-size: 1.2rem; font-weight: 600; color: var(--text-secondary); }
    .study-tool-controls { display: flex; gap: 0.75rem; justify-content: center; margin-top: 0.5rem; }
    .study-tool-btn { padding: 8px 16px; font-weight: 600; }
    /* #endregion */

    /* #region DASHBOARD (Calendar & Todo) */
    .dashboard-container { display: flex; flex-wrap: wrap; gap: 2rem; }
    .dashboard-calendar, .dashboard-todo { flex: 1; background-color: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; min-width: 300px; }
    .dashboard-calendar h3, .dashboard-todo h3, .xp-system-section h3 { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; text-align: center; }
    
    /* Calendar */
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 0.5rem; }
    .calendar-header select { flex: 1; padding: 8px; font-weight: 600; }
    .calendar-header .btn-secondary { padding: 8px 16px; background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); cursor: pointer; }
    .calendar-header .btn-secondary:hover { background-color: var(--bg-primary); }
    #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .calendar-header-day, .calendar-day { text-align: center; padding: 10px; border-radius: 6px; }
    .calendar-header-day { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); }
    .calendar-day { cursor: pointer; font-weight: 500; position: relative; transition: background-color 0.2s; }
    .calendar-day:not(.other-month):hover { background-color: var(--bg-tertiary); }
    .calendar-day.other-month { opacity: 0.4; cursor: not-allowed; }
    .calendar-day.today { background-color: var(--bg-tertiary); color: var(--accent-primary); font-weight: 700; }
    .calendar-day.selected { background-color: var(--accent-primary); color: var(--bg-primary); font-weight: 700; }
    .calendar-day .event-marker { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; border-radius: 50%; background-color: var(--text-secondary); }
    .calendar-day .event-marker.public { background-color: var(--accent-primary); }
    .calendar-day.selected .event-marker.public { background-color: var(--bg-primary); }
    
    /* Event List */
    #event-list-container { margin-top: 1.5rem; }
    #event-list-header { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; }
    #event-list { max-height: 200px; overflow-y: auto; padding-right: 10px; }
    .event-item { background-color: var(--bg-primary); padding: 10px 12px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .event-item-details { flex: 1; }
    .event-item-details span { font-weight: 600; font-size: 0.9rem; margin-right: 8px; }
    .event-item-details .tag { font-size: 0.75rem; font-weight: 700; padding: 2px 6px; border-radius: 4px; background-color: var(--text-secondary); color: var(--bg-primary); margin-right: 8px; }
    .event-item-details .tag.public { background-color: var(--accent-primary); color: var(--bg-primary); }
    .event-item .delete-event { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.1rem; padding: 4px; }
    .event-item .delete-event:hover { color: var(--accent-red); }

    /* Forms */
    #add-event-form, #add-todo-form { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: grid; gap: 10px; }
    #add-event-form { grid-template-columns: 1fr 1fr; }
    #add-todo-form { grid-template-columns: 1fr auto; }
    #event-desc, #todo-input { grid-column: 1 / -1; }
    #add-event-btn, #add-todo-btn { grid-column: 1 / -1; background-color: var(--accent-primary); color: var(--bg-primary); font-weight: 600; padding: 10px; cursor: pointer; }
    #add-todo-btn { grid-column: 2 / 3; padding: 10px 20px; }
    body.light-theme #add-event-btn, body.light-theme #add-todo-btn { color: var(--bg-primary); }
    #public-event-container { grid-column: 1 / -1; display: none; align-items: center; gap: 8px; }
    #public-event-container label { font-size: 0.9rem; color: var(--text-secondary); }

    /* Todo List */
    #todo-list { max-height: 400px; overflow-y: auto; padding-right: 10px; margin-bottom: 1.5rem; }
    .todo-item { background-color: var(--bg-primary); padding: 10px 12px; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
    .todo-item select.status-select { flex-shrink: 0; width: 120px; padding: 6px; font-size: 0.85rem; }
    .todo-item-details { flex: 1; font-size: 0.95rem; transition: opacity 0.3s, text-decoration 0.3s; }
    .todo-item-details.status-half-done { opacity: 0.8; }
    .todo-item-details.status-half-done .todo-description-text { text-decoration: line-through; }
    .todo-item-details.status-full-done { opacity: 0.5; }
    .todo-item-details.status-full-done .todo-description-text { text-decoration: line-through; }
    .todo-item-details .todo-deadline { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px; }
    .todo-item-details .todo-deadline.is-due { color: var(--accent-red); font-weight: 600; }
    .todo-item-details .todo-deadline.is-due-soon { color: #f59e0b; font-weight: 600; }
    .todo-item .delete-todo, .todo-item .edit-todo-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.1rem; padding: 4px; line-height: 1; }
    .todo-item .delete-todo:hover { color: var(--accent-red); }
    .todo-item .edit-todo-btn:hover { color: var(--accent-primary); }
    .todo-item-details input.edit-input { width: 100%; font-size: 0.95rem; padding: 4px; margin: -4px 0; background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; }
    .todo-item-details.is-editing .todo-deadline, .todo-item-details.is-editing .todo-description-text { display: none; }
    /* #endregion */

    /* #region XP SYSTEM & PROGRESS BAR */
    .xp-balance-container { margin-top: 1.5rem; text-align: center; }
    .xp-balance-container h4 { font-size: 1.2rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
    #xpBalanceDisplay { font-size: 2.5rem; font-weight: 700; color: var(--accent-primary); line-height: 1.1; }
    
    /* XP Bar Styles */
    .xp-container {
        width: 100%; background-color: var(--bg-primary); border-radius: 10px; height: 24px;
        margin-top: 12px; border: 1px solid var(--border-color); overflow: hidden; position: relative;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
    }
    .xp-fill {
        height: 100%; background-color: var(--accent-primary); width: 0%; 
        transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .xp-text {
        position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
        top: 0; left: 0; font-size: 0.8rem; color: var(--text-secondary); font-weight: 700; z-index: 2;
        mix-blend-mode: difference; pointer-events: none;
    }

    .xp-system-section { flex-direction: column; align-items: center; gap: 1.5rem; }
    .xp-system-section h3 { width: 100%; }
    .xp-form-container { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: center; }
    .xp-form-container label { color: var(--text-secondary); }
    .xp-form-container input[type="number"] { width: 80px; }
    .xp-redeem-container { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 1rem; }
    #study-history-container { width: 100%; max-width: 600px; margin-top: 1rem; }
    #study-history-container h4 { font-weight: 600; margin-bottom: 0.5rem; text-align: center; }
    #study-history-list { max-height: 200px; overflow-y: auto; background-color: var(--bg-primary); padding: 1rem; border-radius: 8px; }
    .study-log-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
    .study-log-item:last-child { border-bottom: none; }
    .log-date { font-weight: 600; }
    .log-hours { color: var(--text-secondary); }
    .log-points { font-weight: 600; }
    .log-points.positive { color: #4ade80; }
    .log-points.negative { color: var(--accent-red); }
    .delete-log-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.1rem; padding: 0 4px; line-height: 1; }
    .delete-log-btn:hover { color: var(--accent-red); }
    /* #endregion */

    /* #region MEDIA QUERIES */
    @media (max-width: 900px) { .dashboard-container { flex-direction: column; } }
    @media (max-width: 768px) {
        #authWrapper { flex-direction: column; position: static; height: auto; }
        .login-left-panel, .login-right-panel { width: 100%; }
        header { flex-direction: column; height: auto; padding: 1rem; align-items: flex-start; }
        .header-actions { margin-left: 0; margin-top: 1rem; flex-wrap: wrap; }
        .hero { flex-direction: column; text-align: center; }
        .hero-text h2 { font-size: 2.2rem; }
        .hero-text .buttons { flex-direction: column; }
        .hero-text .buttons a { width: 100%; }
        .time-container { flex-direction: column; }
        .time-display, .countdown-display { font-size: 2.5rem; }
        .study-tool-display { font-size: 2.2rem; }
        .date-display { font-size: 1rem; }
        .calendar-header { flex-wrap: wrap; }
        #add-todo-form { grid-template-columns: 1fr; }
        #add-todo-btn { grid-column: 1 / -1; }
    }
    /* #endregion */
    
    /* #region FOOTER */
    footer { text-align: right; padding: 10px 20px; color: var(--text-secondary); font-size: 0.875rem; z-index: 100; width: 100%; margin-top: auto; }
    footer a { color: var(--text-secondary); text-decoration: none; }
    footer a:hover { text-decoration: underline; color: var(--text-primary); }
    /* #endregion */
  </style>
</head>
<body>

  <!-- Startup Animation -->
  <div id="startupAnimation">
      <div id="animatedLogo">AI Marker</div>
  </div>

  <!-- Auth Wrapper -->
  <div id="authWrapper" style="display: none;">
    <div class="login-left-panel">
      <h1>AI Marker</h1>
      <p>Mark with AI, learn better.</p>
    </div>
    <div class="login-right-panel">
      <div id="authContainer">
         <!-- JS will inject googleSignInTemplate or codeEntryTemplate -->
      </div>
    </div>
  </div>

  <div id="appSection" style="display: none;">
    <!-- HEADER -->
    <header>
      <div class="logo-container">
        <h1>AI Marker</h1>
        <p>Operated by Darren Ng</p>
      </div>
      <div class="header-actions">
        <a href="home.html" class="tab active">Home</a>
        <button id="themeToggleButton" class="logout-btn">Theme</button>

        <div class="dropdown-menu">
          <button class="tab">Work with AI ▾</button>
          <div class="dropdown-menu-content">
            <a href="exercises.html" class="tab">Exercise</a>
            <a href="chat.html" class="tab">Chat with Gemini</a>
            <a href="submissions.html" class="tab">Submissions</a>
          </div>
        </div>

        <div class="dropdown-menu">
          <button class="tab">Materials ▾</button>
          <div class="dropdown-menu-content">
            <a href="tutorials.html"tab">Tutorial Videos</a>
            <a href="pastpaper.html" class="tab">Past Papers</a>
            <a href="exercises.html" class="tab">Exercises for Sale</a>
            <a href="lessonhistory.html" class="tab">Lesson History</a>
          </div>
        </div>

        <div class="user-info">
          <span id="userDisplayName">Guest</span>
          <button id="switchRoleButton">Switch Role</button>
          <button id="logoutButton" class="logout-btn">Log Out</button>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main>
      <div id="homeSection">
        <section class="hero">
          <div class="hero-text">
            <h2>Hi <span id="homeUserNamePlaceholder"></span>, how are you today? Let's fight DSE together!</h2>
            <p class="helper" style="margin-top:0">You don't have to see the whole staircase, just take the first step.</p>
            
            <!-- XP BALANCE DISPLAY -->
            <div class="xp-balance-container">
                <h4>Your XP Balance</h4>
                <p id="xpBalanceDisplay">Loading...</p>
                <!-- NEW XP PROGRESS BAR -->
                <div class="xp-container">
                    <div id="xpProgressBar" class="xp-fill"></div>
                    <div id="xpProgressText" class="xp-text">Lvl 1: 0 / 1000 XP</div>
                </div>
            </div>
            
            <div class="buttons" style="margin-top: 2rem;">
              <a href="materials.html?folder=tutorials" id="homeTutorialLink">Tutorial Video</a>
              <a href="lessonhistory.html" id="homeGraderLink">Lesson History</a>
              <a href="chat.html" id="homeChatLink">Chat with AI</a>
              <a href="submissions.html" id="homeSubmissionsLink" class="btn-primary">Submissions</a>
            </div>
          </div>
          <div class="hero-image">
            <img src="https://raw.githubusercontent.com/darren6251/aimarking/refs/heads/main/eaakill.png" alt="Darren Ng demonstrating AI Marker" onerror="this.src='https://placehold.co/600x400/1a1a1a/f5f5f5?text=AI+Marker'">
          </div>
        </section>
        
        <!-- TIME SECTION -->
        <section class="time-info-section">
            <div class="time-container">
                <div class="time-box">
                    <span class="time-label">Current Time & Date</span>
                    <div id="currentTime" class="time-display">00:00:00</div>
                    <div id="currentDate" class="date-display">Loading date...</div>
                </div>
                <div class="time-box">
                    <span class="time-label">2026DSE from now</span>
                    <div id="countdown" class="countdown-display">--:--:--:--</div>
                </div>
            </div>
            <div id="teacher-controls">
                <input type="datetime-local" id="countdown-datetime">
                <button id="set-countdown-btn">Set</button>
            </div>
        </section>
        
        <!-- STOPWATCH & TIMER SECTION -->
        <section class="study-tools-section">
            <div class="study-tool-box">
                <h3>Stopwatch</h3>
                <div id="stopwatchDisplay" class="study-tool-display">00:00:00.000</div>
                <div class="study-tool-controls">
                    <button id="startStopwatchBtn" class="btn-primary study-tool-btn">Start</button>
                    <button id="stopStopwatchBtn" class="logout-btn study-tool-btn" style="display: none;">Stop</button>
                    <button id="resetStopwatchBtn" class="logout-btn study-tool-btn">Reset</button>
                </div>
            </div>
            <div class="study-tool-box">
                <h3>Timer</h3>
                <div id="timerDisplay" class="study-tool-display">00:00:00</div>
                <div id="timerInputs" class="timer-inputs">
                    <input type="number" id="timerHours" min="0" placeholder="HH" value="0">
                    <span>:</span>
                    <input type="number" id="timerMinutes" min="0" max="59" placeholder="MM" value="0">
                    <span>:</span>
                    <input type="number" id="timerSeconds" min="0" max="59" placeholder="SS" value="0">
                </div>
                <div class="study-tool-controls">
                    <button id="startTimerBtn" class="btn-primary study-tool-btn">Start</button>
                    <button id="stopTimerBtn" class="logout-btn study-tool-btn" style="display: none;">Stop</button>
                    <button id="resetTimerBtn" class="logout-btn study-tool-btn">Reset</button>
                </div>
            </div>
        </section>

        <!-- DASHBOARD SECTION -->
        <section class="dashboard-container">
            <!-- Calendar -->
            <div class="dashboard-calendar">
                <h3>Calendar & Events</h3>
                <div class="calendar-header">
                    <button id="today-btn" class="btn-secondary">Today</button>
                    <select id="month-select"></select>
                    <select id="year-select"></select>
                </div>
                <div class="calendar-week-header">
                    <div id="calendar-grid">
                        <div class="calendar-header-day">Sun</div>
                        <div class="calendar-header-day">Mon</div>
                        <div class="calendar-header-day">Tue</div>
                        <div class="calendar-header-day">Wed</div>
                        <div class="calendar-header-day">Thu</div>
                        <div class="calendar-header-day">Fri</div>
                        <div class="calendar-header-day">Sat</div>
                        <!-- Calendar days will be injected by JS -->
                    </div>
                </div>
                <div id="event-list-container">
                    <h4 id="event-list-header">Events for:</h4>
                    <div id="event-list"></div>
                    <form id="add-event-form">
                        <h5 style="grid-column: 1 / -1; margin-bottom: 5px; font-weight: 600;">Add Event</h5>
                        <input type="date" id="event-date" required>
                        <input type="time" id="event-time" required>
                        <input type="text" id="event-desc" placeholder="Event description..." required>
                        <div id="public-event-container">
                            <input type="checkbox" id="public-event-checkbox" style="width: auto;">
                            <label for="public-event-checkbox">Add as Public Event (Visible to all)</label>
                        </div>
                        <button type="submit" id="add-event-btn">Add Event</button>
                    </form>
                </div>
            </div>
            
            <!-- Quick Notes & To-Do -->
            <div class="dashboard-todo">
                <h3>Quick Notes & To-Do</h3>
                <div id="todo-list"></div>
                <form id="add-todo-form">
                    <h5 style="grid-column: 1 / -1; margin-bottom: 5px; font-weight: 600;">Add Note / Task</h5>
                    <input type="text" id="todo-input" placeholder="New note or task..." required>
                    <input type="date" id="todo-deadline" title="Optional deadline">
                    <button type="submit"id="add-todo-btn">Add</button>
                </form>
            </div>
        </section>

        <!-- XP System Section -->
        <section class="xp-system-section">
            <h3>Study XP System</h3>
            <div class="xp-form-container">
                <label for="study-date">Date:</label>
                <input type="date" id="study-date" required>
                <label for="study-hours-input">Hours:</label>
                <input type="number" id="study-hours-input" min="0" step="1" placeholder="e.g., 1" style="width: 70px;">
                <label for="study-minutes-input">Minutes:</label>
                <input type="number" id="study-minutes-input" min="0" max="59" step="1" placeholder="e.g., 30" style="width: 70px;">
                <button id="log-study-btn" class="btn-primary">Log Study Time</button>
            </div>
            <div class="xp-redeem-container">
                <button id="redeemHalfDayBtn" class="logout-btn" data-cost="150" disabled>Redeem Half Day (150 XP)</button>
                <button id="redeemFullDayBtn" class="logout-btn" data-cost="300" disabled>Redeem Full Day (300 XP)</button>
            </div>
            <div id="study-history-container">
                <h4>Recent Study Logs</h4>
                <div id="study-history-list">
                    <p style="color: var(--text-secondary); text-align: center;">No study logs yet.</p>
                </div>
            </div>
        </section>

      </div>
    </main>
    <!-- FOOTER -->
    <footer>
      <a href="mailto:darren_0625@mc-zero.com">Contact: darren_0625@mc-zero.com</a> | Copyright © 2025 Operated by Darren Ng
    </footer>
  </div>

  <!-- Universal Modal -->
  <div id="messageModal" class="modal">
      <div class="modal-content">
          <span class="close-button">&times;</span>
          <h3 id="modalTitle"></h3>
          <div id="modalMessage"></div>
          <div id="modalButtons"></div>
      </div>
  </div>
  
  <!-- Profile Edit Modal -->
  <div id="profileEditModal" class="modal">
      <div class="modal-content">
          <span class="close-button profile-close-button">&times;</span>
          <h3 id="profileModalTitle">Edit Profile</h3>
          <div id="profileModalMessage">
            <div class="form-group">
                <label for="editUserName">Display Name:</label>
                <input type="text" id="editUserName" class="modal-input">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="text" id="editUserEmail" class="modal-input" disabled>
            </div>
            <div class="form-group">
                <label>Role:</label>
                <input type="text" id="editUserRole" class="modal-input" disabled>
            </div>
          </div>
          <div id="profileModalButtons" style="display:flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem;">
             <button id="saveProfileButton" class="btn-primary">Save Changes</button>
             <button id="cancelProfileButton" class="logout-btn">Cancel</button>
          </div>
      </div>
  </div>


  <!-- Firebase & App Script -->
  <script type="module">
    // #region FIREBASE IMPORTS
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, onSnapshot, addDoc, where, serverTimestamp, limit, increment } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";
    // #endregion

    // #region GLOBAL VARIABLES & CONFIG
    const TEACHER_CODE = "DDDDDDDD";
    const STUDENT_CODE = "STUDENT456";
    const firebaseConfig = {
      apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
      authDomain: "ai-grading-9bb30.firebaseapp.com",
      projectId: "ai-grading-9bb30",
      storageBucket: "ai-grading-9bb30.appspot.com",
      messagingSenderId: "298162112230",
      appId: "1:298162112230:web:529d3f95536991be685d27",
      measurementId: "G-CHKLKSM17S"
    };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let app, db, auth, storage;
    let currentUserId = null, currentUserEmail = null, currentUserRole = null, currentUserName = null;
    let countdownInterval;
    
    // State variables
    let currentSelectedDate = new Date();
    let currentMonth = currentSelectedDate.getMonth();
    let currentYear = currentSelectedDate.getFullYear();
    let personalEvents = [], publicEvents = [], todoItems = [];
    let unsubscribePersonalEvents = () => {}, unsubscribePublicEvents = () => {}, unsubscribeTodos = () => {};
    let xpBalance = 0, studyHistory = [];
    let unsubscribeProfile = () => {}, unsubscribeStudyHistory = () => {};

    // Timer State
    let stopwatchInterval = null, stopwatchStartTime = 0, stopwatchElapsedTime = 0, stopwatchRunning = false;
    let timerInterval = null, timerTotalTime = 0, timerTimeRemaining = 0, timerRunning = false, timerAudioContext = null, timerBeepNode = null;
    // #endregion

    // #region INITIALIZATION & AUTH
    const authWrapper = document.getElementById('authWrapper');
    const appSection = document.getElementById('appSection');
    const authContainer = document.getElementById('authContainer');
    const userDisplayNameSpan = document.getElementById('userDisplayName');
    const startupAnimation = document.getElementById('startupAnimation');
    const headerLogo = document.querySelector('header .logo-container h1');

    const googleSignInTemplate = `
        <h2>Sign In</h2>
        <button id="googleSignInButton" class="google-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
            <span>Sign in with Google</span>
        </button>
        <p id="authError" class="error-message"></p>
    `;

    const codeEntryTemplate = `
        <h2>Enter Access Code</h2>
        <p style="color: var(--text-secondary); text-align: center; margin-bottom: 1rem;">Please enter the access code provided by your administrator.</p>
        <input type="text" id="accessCodeInput" placeholder="Enter code here">
        <button id="submitCodeButton" class="btn-primary" style="width:100%">Submit Code</button>
        <p id="codeError" class="error-message"></p>
    `;

    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        storage = getStorage(app);
        console.log("Firebase initialized successfully.");
    } catch (error) {
        console.error("Error initializing Firebase:", error);
        showModal('Firebase Configuration Error', `Failed to initialize Firebase. Error: ${error.message}`);
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserId = user.uid;
            currentUserEmail = user.email;
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            try {
                const userProfileDoc = await getDoc(userProfileRef);
                if (userProfileDoc.exists() && userProfileDoc.data().role) {
                    const profileData = userProfileDoc.data();
                    currentUserRole = profileData.role;
                    currentUserName = profileData.name || user.displayName;
                    const updateData = { name: currentUserName, email: currentUserEmail, lastLogin: Date.now() };
                    if (profileData.xpBalance === undefined) updateData.xpBalance = 0;
                    await setDoc(userProfileRef, updateData, { merge: true });
                    showApp();
                } else {
                    currentUserName = user.displayName;
                    currentUserRole = 'unassigned';
                    await setDoc(userProfileRef, { 
                        name: currentUserName, email: currentUserEmail, role: 'unassigned', xpBalance: 0, lastLogin: Date.now()
                    }, { merge: true });
                    showCodeEntry();
                }
            } catch (e) {
                 console.error("Error checking user profile:", e);
                 showModal('Profile Error', `Could not load user profile. Error: ${e.message}`);
                 showLogin();
            }
        } else {
            currentUserId = null; currentUserRole = null; currentUserName = null; xpBalance = 0; studyHistory = [];
            unsubscribePersonalEvents(); unsubscribePublicEvents(); unsubscribeTodos(); unsubscribeProfile(); unsubscribeStudyHistory();
            personalEvents = []; publicEvents = []; todoItems = [];
            showLogin();
        }
    });

    function showLogin() {
        appSection.style.display = 'none';
        authWrapper.style.display = 'flex';
        authWrapper.style.opacity = '1';
        startupAnimation.classList.remove('run-animation', 'fade-out');
        headerLogo.style.opacity = '0';
        authContainer.innerHTML = googleSignInTemplate;
        document.getElementById('googleSignInButton')?.addEventListener('click', handleGoogleSignIn);
    }

    function showCodeEntry() {
        appSection.style.display = 'none';
        authWrapper.style.display = 'flex';
        authWrapper.style.opacity = '1';
        startupAnimation.classList.remove('run-animation', 'fade-out');
        headerLogo.style.opacity = '0';
        authContainer.innerHTML = codeEntryTemplate;
        const submitCodeBtn = document.getElementById('submitCodeButton');
        const accessCodeInput = document.getElementById('accessCodeInput');
        submitCodeBtn?.addEventListener('click', () => handleSubmitCode());
        accessCodeInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); handleSubmitCode(); }
        });
        accessCodeInput?.focus();
    }

    async function showApp() {
        authWrapper.style.display = 'none';
        appSection.style.display = 'flex';
        userDisplayNameSpan.textContent = `${currentUserName} (${currentUserRole})`;
        document.getElementById('homeUserNamePlaceholder').textContent = currentUserName;
        
        if (currentUserRole === 'teacher') {
            document.getElementById('teacher-controls').style.display = 'flex';
            document.getElementById('public-event-container').style.display = 'flex';
        } else {
             document.getElementById('teacher-controls').style.display = 'none';
             document.getElementById('public-event-container').style.display = 'none';
        }

        startupAnimation.classList.add('run-animation');
        setTimeout(() => { startupAnimation.classList.add('fade-out'); headerLogo.style.opacity = '1'; }, 2500);

        startClocks();
        listenForCountdownChanges();
        initDashboard();
        
        if (currentUserId) {
            listenForPersonalEvents();
            listenForPublicEvents();
            listenForTodos();
            listenForProfileChanges();
            listenForStudyHistory();
        }
    }

    async function handleGoogleSignIn() {
        const provider = new GoogleAuthProvider();
        try { await signInWithPopup(auth, provider); } catch (error) { 
            document.getElementById('authError').textContent = `Sign-in failed. Error: ${error.message}`; 
        }
    }

    async function handleSubmitCode(codeValue) {
        const code = (codeValue || document.getElementById('accessCodeInput').value).trim();
        const codeError = document.getElementById('codeError');
        if(codeError) codeError.textContent = '';
        
        let roleToSet = null;
        if (code === TEACHER_CODE) roleToSet = 'teacher';
        else if (code === STUDENT_CODE) roleToSet = 'student';
        else { if(codeError) codeError.textContent = 'Invalid access code.'; return; }
        
        try {
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            await setDoc(userProfileRef, { role: roleToSet }, { merge: true });
            currentUserRole = roleToSet;
            showModal('Success', `Your role has been set to ${roleToSet}.`);
            showApp();
        } catch (error) {
            if(codeError) codeError.textContent = `Could not set role. Error: ${error.message}`;
        }
    }

    document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));
    document.getElementById('switchRoleButton').addEventListener('click', () => {
        showInputModal('Switch Role', 'Enter new access code (Teacher or Student):', async (code) => { await handleSubmitCode(code); });
    });
    
    // Profile Edit
    userDisplayNameSpan.addEventListener('click', async () => {
        if (!currentUserId) { showModal('Error', 'Please log in to edit your profile.'); return; }
        const profileEditModal = document.getElementById('profileEditModal');
        const editUserNameInput = document.getElementById('editUserName');
        const editUserEmailInput = document.getElementById('editUserEmail');
        const editUserRoleInput = document.getElementById('editUserRole');
        const saveProfileButton = document.getElementById('saveProfileButton');
        const cancelProfileButton = document.getElementById('cancelProfileButton');

        editUserNameInput.value = currentUserName || '';
        editUserEmailInput.value = currentUserEmail || '';
        editUserRoleInput.value = currentUserRole || '';
        profileEditModal.style.display = 'flex';

        const saveHandler = async () => {
            const newName = editUserNameInput.value.trim();
            if (!newName) { editUserNameInput.style.border = '1px solid var(--accent-red)'; editUserNameInput.focus(); return; }
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await updateDoc(userProfileRef, { name: newName });
                currentUserName = newName;
                userDisplayNameSpan.textContent = `${currentUserName} (${currentUserRole})`;
                document.getElementById('homeUserNamePlaceholder').textContent = currentUserName;
                profileEditModal.style.display = 'none';
                showModal('Success', 'Profile updated successfully!');
            } catch (error) { showModal('Error', `Failed to update profile: ${error.message}`); }
            saveProfileButton.removeEventListener('click', saveHandler);
            cancelProfileButton.removeEventListener('click', cancelHandler);
        };
        const cancelHandler = () => {
            profileEditModal.style.display = 'none';
            saveProfileButton.removeEventListener('click', saveHandler);
            cancelProfileButton.removeEventListener('click', cancelHandler);
        };
        saveProfileButton.addEventListener('click', saveHandler);
        cancelProfileButton.addEventListener('click', cancelHandler);
        document.querySelector('.profile-close-button').addEventListener('click', cancelHandler);
    });
    // #endregion

    // #region TIME & COUNTDOWN
    function startClocks() {
        const currentTimeEl = document.getElementById('currentTime');
        const currentDateEl = document.getElementById('currentDate');
        setInterval(() => {
            const now = new Date();
            currentTimeEl.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            currentDateEl.textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }, 1000);
    }
    function updateCountdown(targetDate) {
        const countdownEl = document.getElementById('countdown');
        if (countdownInterval) clearInterval(countdownInterval);
        if (!targetDate) { countdownEl.textContent = "No Event"; return; }

        countdownInterval = setInterval(() => {
            const now = new Date().getTime();
            const distance = targetDate - now;
            if (distance < 0) { clearInterval(countdownInterval); countdownEl.textContent = "EXPIRED"; return; }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            countdownEl.textContent = `${String(days).padStart(2, '0')}:${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }, 1000);
    }
    function listenForCountdownChanges() {
        const countdownRef = doc(db, `artifacts/${appId}/public/data/settings/countdown`);
        onSnapshot(countdownRef, (doc) => {
            if (doc.exists()) { updateCountdown(doc.data().target ? doc.data().target.toDate() : null); } 
            else { updateCountdown(null); }
        });
    }
    document.getElementById('set-countdown-btn').addEventListener('click', async () => {
        const datetimeInput = document.getElementById('countdown-datetime').value;
        if (!datetimeInput) { showModal('Error', 'Please select a date and time.'); return; }
        const targetDate = new Date(datetimeInput);
        if (isNaN(targetDate)) { showModal('Error', 'Invalid date and time format.'); return; }
        try {
            const countdownRef = doc(db, `artifacts/${appId}/public/data/settings/countdown`);
            await setDoc(countdownRef, { target: targetDate });
            showModal('Success', 'Countdown target has been set!');
        } catch (error) { showModal('Error', `Could not set countdown: ${error.message}`); }
    });
    // #endregion

    // #region THEME
    const themeToggleButton = document.getElementById('themeToggleButton');
    function applyTheme(theme) { document.body.classList.toggle('light-theme', theme === 'light'); }
    function loadTheme() { applyTheme(localStorage.getItem('ai-marker-theme') || 'dark'); }
    themeToggleButton.addEventListener('click', () => {
        const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';
        applyTheme(newTheme); localStorage.setItem('ai-marker-theme', newTheme);
    });
    loadTheme();
    // #endregion

    // #region DASHBOARD (Calendar & Todo)
    const calendarGrid = document.getElementById('calendar-grid');
    const eventListHeader = document.getElementById('event-list-header');
    const eventList = document.getElementById('event-list');
    const addEventForm = document.getElementById('add-event-form');
    const eventDateInput = document.getElementById('event-date');
    const eventTimeInput = document.getElementById('event-time');
    const eventDescInput = document.getElementById('event-desc');
    const publicEventCheckbox = document.getElementById('public-event-checkbox');
    const todoList = document.getElementById('todo-list');
    const addTodoForm = document.getElementById('add-todo-form');
    const todoInput = document.getElementById('todo-input');
    const todoDeadlineInput = document.getElementById('todo-deadline');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    const todayBtn = document.getElementById('today-btn');
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    function initDashboard() {
        months.forEach((month, index) => { const option = document.createElement('option'); option.value = index; option.textContent = month; monthSelect.appendChild(option); });
        const currentYear = new Date().getFullYear();
        for (let i = currentYear - 10; i <= currentYear + 10; i++) { const option = document.createElement('option'); option.value = i; option.textContent = i; yearSelect.appendChild(option); }
        
        updateCalendarState(new Date());
        
        monthSelect.addEventListener('change', handleMonthYearChange);
        yearSelect.addEventListener('change', handleMonthYearChange);
        todayBtn.addEventListener('click', () => updateCalendarState(new Date()));
        addEventForm.addEventListener('submit', handleAddEvent);
        addTodoForm.addEventListener('submit', handleAddTodo);
        todoList.addEventListener('change', handleTodoStatusChange);
        
        // XP Listeners
        document.getElementById('log-study-btn').addEventListener('click', handleLogStudy);
        document.getElementById('redeemHalfDayBtn').addEventListener('click', handleRedeemPoints);
        document.getElementById('redeemFullDayBtn').addEventListener('click', handleRedeemPoints);
        document.getElementById('study-history-list').addEventListener('click', handleDeleteStudyLog);

        // Timer Listeners
        document.getElementById('startStopwatchBtn').addEventListener('click', startStopwatch);
        document.getElementById('stopStopwatchBtn').addEventListener('click', stopStopwatch);
        document.getElementById('resetStopwatchBtn').addEventListener('click', resetStopwatch);
        document.getElementById('startTimerBtn').addEventListener('click', startTimer);
        document.getElementById('stopTimerBtn').addEventListener('click', stopTimer);
        document.getElementById('resetTimerBtn').addEventListener('click', resetTimer);
        
        const initAudio = () => { if (!timerAudioContext) timerAudioContext = new (window.AudioContext || window.webkitAudioContext)(); document.body.removeEventListener('click', initAudio); };
        document.body.addEventListener('click', initAudio, { once: true });
        document.body.addEventListener('keydown', initAudio, { once: true });
    }
    
    function handleMonthYearChange() {
        currentMonth = parseInt(monthSelect.value); currentYear = parseInt(yearSelect.value); renderCalendar();
    }
    function updateCalendarState(date) {
        currentSelectedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        currentMonth = currentSelectedDate.getMonth(); currentYear = currentSelectedDate.getFullYear();
        monthSelect.value = currentMonth; yearSelect.value = currentYear;
        eventDateInput.value = toLocalISODate(currentSelectedDate);
        document.getElementById('study-date').value = toLocalISODate(new Date()); // Default study date to today
        renderCalendar(); renderEventsForDay();
    }
    function renderCalendar() {
        while (calendarGrid.children.length > 7) calendarGrid.removeChild(calendarGrid.lastChild);
        const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const today = new Date();

        for (let i = 0; i < firstDayOfMonth; i++) {
            const dayEl = document.createElement('div'); dayEl.className = 'calendar-day other-month'; calendarGrid.appendChild(dayEl);
        }
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            const dayDate = new Date(currentYear, currentMonth, i);
            const dateStr = toLocalISODate(dayDate);
            dayEl.className = 'calendar-day'; dayEl.textContent = i; dayEl.dataset.date = dateStr;

            if (isSameDay(dayDate, today)) dayEl.classList.add('today');
            if (isSameDay(dayDate, currentSelectedDate)) dayEl.classList.add('selected');
            
            const hasPublicEvent = publicEvents.some(e => e.date === dateStr);
            const hasPersonalEvent = personalEvents.some(e => e.date === dateStr);
            if (hasPublicEvent || hasPersonalEvent) {
                const marker = document.createElement('div'); marker.className = 'event-marker';
                if (hasPublicEvent) marker.classList.add('public');
                dayEl.appendChild(marker);
            }
            dayEl.addEventListener('click', () => updateCalendarState(dayDate));
            calendarGrid.appendChild(dayEl);
        }
    }
    function renderEventsForDay() {
        eventList.innerHTML = '';
        const selectedDateStr = toLocalISODate(currentSelectedDate);
        eventListHeader.textContent = `Events for: ${currentSelectedDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
        
        const dayEvents = [...personalEvents.filter(e => e.date === selectedDateStr), ...publicEvents.filter(e => e.date === selectedDateStr)];
        dayEvents.sort((a, b) => a.time.localeCompare(b.time));

        if (dayEvents.length === 0) { eventList.innerHTML = `<p style="color: var(--text-secondary); font-size: 0.9rem;">No events for this day.</p>`; return; }

        dayEvents.forEach(event => {
            const isPublicEvent = event.isPublic; 
            const eventItem = document.createElement('div'); eventItem.className = 'event-item';
            eventItem.dataset.id = event.id; eventItem.dataset.isPublic = isPublicEvent;
            
            const details = document.createElement('div'); details.className = 'event-item-details';
            details.innerHTML = `<span class="tag ${isPublicEvent ? 'public' : ''}">${isPublicEvent ? 'PUBLIC' : 'MY EVENT'}</span><span>${event.time}</span> ${event.description}`;
            
            const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-event';
            deleteBtn.innerHTML = '&times;'; deleteBtn.title = 'Delete event';
            deleteBtn.addEventListener('click', handleDeleteEvent);
            if (isPublicEvent && currentUserRole !== 'teacher') deleteBtn.style.display = 'none';
            
            eventItem.appendChild(details); eventItem.appendChild(deleteBtn); eventList.appendChild(eventItem);
        });
    }

    function renderTodos() {
        todoList.innerHTML = '';
        
        // SORTING LOGIC: Notes > Active > Done
        const sortedTodos = [...todoItems].sort((a, b) => {
            const statusOrder = { 'not-started': 1, 'half-done': 2, 'full-done': 3 };
            const statusDiff = (statusOrder[a.status] || 0) - (statusOrder[b.status] || 0);
            if (statusDiff !== 0) return statusDiff;
            // Notes (no deadline) float to top
            if (!a.deadline && b.deadline) return -1;
            if (a.deadline && !b.deadline) return 1;
            // Both have deadline -> compare
            if (a.deadline && b.deadline) return a.deadline.localeCompare(b.deadline);
            return 0;
        });
        
        if (sortedTodos.length === 0) { todoList.innerHTML = `<p style="color: var(--text-secondary); font-size: 0.9rem;">No tasks added yet.</p>`; return; }

        sortedTodos.forEach(todo => {
            const todoItem = document.createElement('div'); todoItem.className = 'todo-item'; todoItem.dataset.id = todo.id;
            const statusSelect = document.createElement('select'); statusSelect.className = 'status-select';
            [{value:'not-started',text:'Not Started'},{value:'half-done',text:'Half Done'},{value:'full-done',text:'Full Done'}].forEach(s => {
                const option = document.createElement('option'); option.value = s.value; option.textContent = s.text;
                if (s.value === todo.status) option.selected = true; statusSelect.appendChild(option);
            });
            
            const details = document.createElement('div'); details.className = 'todo-item-details';
            if (todo.status === 'half-done') details.classList.add('status-half-done');
            if (todo.status === 'full-done') details.classList.add('status-full-done');
            
            const descriptionSpan = document.createElement('span'); descriptionSpan.className = 'todo-description-text'; descriptionSpan.textContent = todo.description;
            details.appendChild(descriptionSpan);

            if (todo.deadline) {
                const deadlineEl = document.createElement('span'); deadlineEl.className = 'todo-deadline'; deadlineEl.textContent = `Deadline: ${todo.deadline}`;
                if (todo.status !== 'full-done') {
                    const diff = Math.ceil((new Date(todo.deadline) - new Date(toLocalISODate(new Date()))) / (86400000));
                    if (diff < 0) { deadlineEl.classList.add('is-due'); deadlineEl.textContent += ' (OVERDUE)'; }
                    else if (diff === 0) { deadlineEl.classList.add('is-due-soon'); deadlineEl.textContent += ' (DUE TODAY)'; }
                    else if (diff <= 3) { deadlineEl.classList.add('is-due-soon'); deadlineEl.textContent += ` (DUE IN ${diff} DAYS)`; }
                }
                details.appendChild(deadlineEl);
            }

            const editBtn = document.createElement('button'); editBtn.className = 'edit-todo-btn'; editBtn.innerHTML = '&#9998;'; editBtn.title = 'Edit task';
            editBtn.addEventListener('click', () => handleEditTodo(todoItem, descriptionSpan, todo));
            
            const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-todo'; deleteBtn.innerHTML = '&times;'; deleteBtn.title = 'Delete task';
            deleteBtn.addEventListener('click', () => handleDeleteTodo(todo.id));

            todoItem.appendChild(statusSelect); todoItem.appendChild(details); todoItem.appendChild(editBtn); todoItem.appendChild(deleteBtn);
            todoList.appendChild(todoItem);
        });
    }

    function listenForPersonalEvents() {
        if (!currentUserId) return; unsubscribePersonalEvents();
        unsubscribePersonalEvents = onSnapshot(query(collection(db, `artifacts/${appId}/users/${currentUserId}/events`)), (snapshot) => {
            personalEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderCalendar(); renderEventsForDay();
        });
    }
    function listenForPublicEvents() {
        unsubscribePublicEvents();
        unsubscribePublicEvents = onSnapshot(query(collection(db, `artifacts/${appId}/public/data/public_events`)), (snapshot) => {
            publicEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderCalendar(); renderEventsForDay();
        });
    }
    function listenForTodos() {
        if (!currentUserId) return; unsubscribeTodos();
        unsubscribeTodos = onSnapshot(query(collection(db, `artifacts/${appId}/users/${currentUserId}/todos`)), (snapshot) => {
            todoItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderTodos();
        });
    }

    async function handleAddEvent(e) {
        e.preventDefault();
        const eventDesc = eventDescInput.value.trim(); const eventTime = eventTimeInput.value; const selectedDateStr = eventDateInput.value;
        if (!eventDesc || !eventTime || !selectedDateStr) { showModal('Error', 'Please fill in all event fields.'); return; }
        const isPublic = publicEventCheckbox.checked && currentUserRole === 'teacher';
        try {
            const collectionPath = isPublic ? `artifacts/${appId}/public/data/public_events` : `artifacts/${appId}/users/${currentUserId}/events`;
            await addDoc(collection(db, collectionPath), { date: selectedDateStr, time: eventTime, description: eventDesc, isPublic, createdAt: serverTimestamp(), userId: currentUserId });
            eventDescInput.value = ''; eventTimeInput.value = ''; publicEventCheckbox.checked = false;
        } catch (error) { showModal('Error', `Could not add event: ${error.message}`); }
    }
    async function handleDeleteEvent(e) {
        const eventEl = e.target.closest('.event-item');
        showModal('Delete Event', 'Are you sure?', [{ text: 'Cancel', className: 'logout-btn' }, { text: 'Delete', className: 'btn-primary', onClick: async () => {
            try {
                const path = eventEl.dataset.isPublic === 'true' ? `artifacts/${appId}/public/data/public_events` : `artifacts/${appId}/users/${currentUserId}/events`;
                await deleteDoc(doc(db, path, eventEl.dataset.id));
            } catch (error) { showModal('Error', `Error: ${error.message}`); }
        }}]);
    }
    async function handleAddTodo(e) {
        e.preventDefault();
        const description = todoInput.value.trim();
        if (!description) { showModal('Error', 'Please enter a task description.'); return; }
        try {
            await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/todos`), { description, status: 'not-started', deadline: todoDeadlineInput.value || null, createdAt: serverTimestamp(), userId: currentUserId });
            todoInput.value = ''; todoDeadlineInput.value = '';
        } catch (error) { showModal('Error', `Error: ${error.message}`); }
    }
    function handleTodoStatusChange(e) {
        if (!e.target.classList.contains('status-select')) return;
        const todoItem = e.target.closest('.todo-item');
        handleUpdateTodoStatus(todoItem.dataset.id, e.target.value);
        renderTodos(); // Immediate UI update
    }
    async function handleUpdateTodoStatus(docId, newStatus) {
        try { await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/todos`, docId), { status: newStatus }); } catch (e) { console.error(e); }
    }
    function handleEditTodo(todoItem, descriptionSpan, todo) {
        const detailsDiv = todoItem.querySelector('.todo-item-details');
        if (detailsDiv.classList.contains('is-editing')) return;
        detailsDiv.classList.add('is-editing');
        const input = document.createElement('input'); input.type = 'text'; input.className = 'edit-input'; input.value = todo.description;
        detailsDiv.insertBefore(input, descriptionSpan); input.focus(); input.select();
        const save = async () => {
            if (!detailsDiv.contains(input)) return;
            const newDesc = input.value.trim();
            detailsDiv.classList.remove('is-editing'); detailsDiv.removeChild(input);
            if (newDesc && newDesc !== todo.description) {
                try { await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/todos`, todo.id), { description: newDesc }); }
                catch (e) { showModal('Error', e.message); }
            }
        };
        input.addEventListener('blur', save);
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') save(); else if (e.key === 'Escape') { detailsDiv.classList.remove('is-editing'); detailsDiv.removeChild(input); } });
    }
    async function handleDeleteTodo(docId) {
        showModal('Delete Task', 'Sure?', [{ text: 'Cancel', className: 'logout-btn' }, { text: 'Delete', className: 'btn-primary', onClick: async () => {
             try { await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/todos`, docId)); } catch (e) { showModal('Error', e.message); }
        }}]);
    }
    // #endregion

    // #region XP SYSTEM
    function listenForProfileChanges() {
        if (!currentUserId) return; unsubscribeProfile();
        unsubscribeProfile = onSnapshot(doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`), (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                xpBalance = data.xpBalance || 0;
                document.getElementById('xpBalanceDisplay').textContent = parseFloat(xpBalance.toFixed(1));
                
                // LEVEL CALCULATION
                const xpPerLevel = 1000;
                const currentLevel = Math.floor(xpBalance / xpPerLevel) + 1;
                const currentLevelStartXp = (currentLevel - 1) * xpPerLevel;
                const xpInCurrentLevel = xpBalance - currentLevelStartXp;
                let progressPercent = (xpInCurrentLevel / xpPerLevel) * 100;
                if (progressPercent > 100) progressPercent = 100;

                document.getElementById('xpProgressBar').style.width = `${progressPercent}%`;
                document.getElementById('xpProgressText').textContent = `Lvl ${currentLevel}: ${Math.floor(xpInCurrentLevel)} / ${xpPerLevel} XP`;
                
                updateRedeemButtons();
            } else {
                xpBalance = 0; document.getElementById('xpBalanceDisplay').textContent = '0';
                document.getElementById('xpProgressBar').style.width = `0%`;
                document.getElementById('xpProgressText').textContent = `Lvl 1: 0 / 1000 XP`;
            }
        });
    }
    function listenForStudyHistory() {
        if (!currentUserId) return; unsubscribeStudyHistory();
        unsubscribeStudyHistory = onSnapshot(query(collection(db, `artifacts/${appId}/users/${currentUserId}/studyHistory`), limit(50)), (snapshot) => {
            studyHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.date.localeCompare(a.date));
            renderStudyHistory();
        });
    }
    function renderStudyHistory() {
        const listEl = document.getElementById('study-history-list'); listEl.innerHTML = '';
        if (studyHistory.length === 0) { listEl.innerHTML = `<p style="color: var(--text-secondary); text-align: center;">No study logs yet.</p>`; return; }
        studyHistory.slice(0, 10).forEach(log => {
            const itemEl = document.createElement('div'); itemEl.className = 'study-log-item';
            const isRedemption = log.pointsEarned < 0;
            itemEl.innerHTML = `<div><span class="log-date">${log.date} ${isRedemption ? '- ' + log.description : ''}</span><span class="log-hours">${isRedemption ? '' : `(${log.hours.toFixed(2)} hrs)`}</span></div>
            <div style="display: flex; align-items: center; gap: 8px;"><span class="log-points ${log.pointsEarned > 0 ? 'positive' : 'negative'}">${log.pointsEarned > 0 ? '+' : ''}${log.pointsEarned.toFixed(1)} XP</span>
            ${isRedemption ? '' : `<button class="delete-log-btn" data-id="${log.id}" data-points="${log.pointsEarned}">&times;</button>`}</div>`;
            listEl.appendChild(itemEl);
        });
    }
    function updateRedeemButtons() {
        document.getElementById('redeemHalfDayBtn').disabled = xpBalance < 150;
        document.getElementById('redeemFullDayBtn').disabled = xpBalance < 300;
    }
    async function handleLogStudy() {
        const date = document.getElementById('study-date').value;
        const hours = parseFloat((parseInt(document.getElementById('study-hours-input').value||0) + (parseInt(document.getElementById('study-minutes-input').value||0)/60)).toFixed(2));
        if (!date || hours <= 0) { showModal('Error', 'Invalid time.'); return; }
        if (studyHistory.find(log => log.date === date && log.hours > 0)) { showModal('Error', 'Already logged today.'); return; }
        try {
            const points = parseFloat((hours * 10).toFixed(1));
            const bonus = await checkConsecutiveBonus({ date, hours }, studyHistory);
            const total = points + bonus;
            await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`), { xpBalance: increment(total) });
            await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/studyHistory`), { date, hours, pointsEarned: total, createdAt: serverTimestamp(), userId: currentUserId });
            showModal('Success', bonus > 0 ? `Logged! ${points} XP + ${bonus} Bonus!` : `Logged! ${points} XP.`);
            document.getElementById('study-hours-input').value = ''; document.getElementById('study-minutes-input').value = '';
        } catch (e) { showModal('Error', e.message); }
    }
    async function checkConsecutiveBonus(newLog, history) {
        if (newLog.hours < 3) return 0;
        const logs = [...history, newLog].filter(l => l.hours >= 3).sort((a,b) => b.date.localeCompare(a.date));
        const idx = logs.findIndex(l => l.date === newLog.date);
        let streak = 1; let lastDate = new Date(logs[idx].date);
        for (let i = idx + 1; i < logs.length; i++) {
            const curr = new Date(logs[i].date); const diff = Math.round((lastDate - curr)/(86400000));
            if (diff === 1) { streak++; lastDate = curr; } else if (diff > 1) break;
            if (streak === 5) return 50;
        }
        return 0;
    }
    async function handleRedeemPoints(e) {
        const cost = parseInt(e.target.dataset.cost);
        if (xpBalance < cost) { showModal('Error', 'Not enough XP.'); return; }
        showModal('Confirm', `Redeem for ${cost} XP?`, [{ text: 'Cancel', className: 'logout-btn'}, { text: 'Redeem', className: 'btn-primary', onClick: async () => {
             try {
                await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`), { xpBalance: increment(-cost) });
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/studyHistory`), { date: toLocalISODate(new Date()), hours: 0, pointsEarned: -cost, description: `Redeemed Reward`, createdAt: serverTimestamp(), userId: currentUserId });
                showModal('Success', 'Redeemed!');
             } catch (e) { showModal('Error', e.message); }
        }}]);
    }
    async function handleDeleteStudyLog(e) {
        if (!e.target.classList.contains('delete-log-btn')) return;
        const pts = parseFloat(e.target.dataset.points); const id = e.target.dataset.id;
        showModal('Delete Log', `Remove log and deduct ${pts} XP?`, [{ text: 'Cancel', className: 'logout-btn' }, { text: 'Delete', className: 'btn-primary', onClick: async () => {
            try {
                await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`), { xpBalance: increment(-pts) });
                await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/studyHistory`, id));
                showModal('Success', 'Deleted.');
            } catch (e) { showModal('Error', e.message); }
        }}]);
    }
    // #endregion

    // #region STUDY TOOLS (Stopwatch & Timer)
    function startStopwatch() {
        if (stopwatchRunning) return; stopwatchRunning = true; stopwatchStartTime = Date.now() - stopwatchElapsedTime;
        stopwatchInterval = setInterval(() => {
            const elapsed = Date.now() - stopwatchStartTime;
            let ms = elapsed % 1000, s = Math.floor((elapsed / 1000) % 60), m = Math.floor((elapsed / 60000) % 60), h = Math.floor(elapsed / 3600000);
            document.getElementById('stopwatchDisplay').textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(ms).padStart(3,'0')}`;
        }, 10);
        document.getElementById('startStopwatchBtn').style.display = 'none'; document.getElementById('stopStopwatchBtn').style.display = 'inline-block';
    }
    function stopStopwatch() {
        if (!stopwatchRunning) return; stopwatchRunning = false; clearInterval(stopwatchInterval); stopwatchElapsedTime = Date.now() - stopwatchStartTime;
        document.getElementById('startStopwatchBtn').style.display = 'inline-block'; document.getElementById('stopStopwatchBtn').style.display = 'none';
    }
    function resetStopwatch() { stopStopwatch(); stopwatchElapsedTime = 0; document.getElementById('stopwatchDisplay').textContent = '00:00:00.000'; }
    
    function startTimer() {
        if (timerRunning) return;
        if (!timerAudioContext) try { timerAudioContext = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}
        const h = parseInt(document.getElementById('timerHours').value)||0, m = parseInt(document.getElementById('timerMinutes').value)||0, s = parseInt(document.getElementById('timerSeconds').value)||0;
        timerTotalTime = (h * 3600) + (m * 60) + s;
        if (timerTotalTime <= 0) { showModal('Error', 'Set time > 0'); return; }
        timerTimeRemaining = timerTimeRemaining > 0 ? timerTimeRemaining : timerTotalTime;
        timerRunning = true; toggleTimerInputs(false);
        timerInterval = setInterval(() => {
            if (timerTimeRemaining <= 0) { stopTimer(); document.getElementById('timerDisplay').textContent = '00:00:00'; showModal('Done', 'Timer Finished!'); playTimerBeep(); timerTimeRemaining = 0; return; }
            timerTimeRemaining--;
            let r = timerTimeRemaining, th = Math.floor(r / 3600); r %= 3600; let tm = Math.floor(r / 60), ts = r % 60;
            document.getElementById('timerDisplay').textContent = `${String(th).padStart(2,'0')}:${String(tm).padStart(2,'0')}:${String(ts).padStart(2,'0')}`;
        }, 1000);
        document.getElementById('startTimerBtn').style.display = 'none'; document.getElementById('stopTimerBtn').style.display = 'inline-block';
    }
    function stopTimer() { if (!timerRunning) return; timerRunning = false; clearInterval(timerInterval); document.getElementById('startTimerBtn').style.display = 'inline-block'; document.getElementById('stopTimerBtn').style.display = 'none'; }
    function resetTimer() { stopTimer(); timerTimeRemaining = 0; document.getElementById('timerDisplay').textContent = '00:00:00'; toggleTimerInputs(true); }
    function toggleTimerInputs(en) { document.querySelectorAll('.timer-inputs input').forEach(i => i.disabled = !en); }
    function playTimerBeep() {
        if (!timerAudioContext) return;
        if (timerBeepNode) try { timerBeepNode.stop(); } catch(e){}
        timerBeepNode = timerAudioContext.createOscillator(); const g = timerAudioContext.createGain();
        timerBeepNode.connect(g); g.connect(timerAudioContext.destination);
        timerBeepNode.type = 'sine'; timerBeepNode.frequency.setValueAtTime(880, timerAudioContext.currentTime);
        g.gain.setValueAtTime(0.5, timerAudioContext.currentTime);
        timerBeepNode.start(timerAudioContext.currentTime); timerBeepNode.stop(timerAudioContext.currentTime + 0.5);
    }
    // #endregion

    // #region UTILS & MODALS
    function toLocalISODate(date) { return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`; }
    function isSameDay(d1, d2) { return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate(); }
    
    function showModal(title, msg, buttons = []) {
        const m = document.getElementById('messageModal'); document.getElementById('modalTitle').textContent = title; document.getElementById('modalMessage').innerHTML = msg;
        const bDiv = document.getElementById('modalButtons'); bDiv.innerHTML = '';
        if (buttons.length === 0) buttons = [{ text: 'OK', className: 'btn-primary' }];
        buttons.forEach(b => {
            const btn = document.createElement('button'); btn.textContent = b.text; btn.className = b.className;
            btn.onclick = () => { m.style.display = 'none'; if(b.onClick) b.onClick(); }; bDiv.appendChild(btn);
        });
        m.style.display = 'flex';
    }
    function showInputModal(title, label, cb) {
        showModal(title, `<label>${label}</label><input id="mInput" class="modal-input">`, [
            { text: 'Save', className: 'btn-primary', onClick: () => { const v = document.getElementById('mInput').value.trim(); if(v) cb(v); } },
            { text: 'Cancel', className: 'logout-btn' }
        ]);
        setTimeout(() => document.getElementById('mInput').focus(), 50);
    }
    document.querySelectorAll('.modal .close-button').forEach(btn => btn.onclick = () => btn.closest('.modal').style.display = 'none');
    // #endregion
  </script>
</body>
</html>
