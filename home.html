<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>darStudy - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
        --bg-body: #050505; --bg-header: rgba(5,5,5,0.7); --bg-card: rgba(20,20,20,0.7);
        --bg-card-hover: rgba(30,30,30,0.8); --bg-tool: rgba(10,10,10,0.5); --bg-input: #111;
        --bg-dropdown: #000; --text-main: #ffffff; --text-muted: #888; --text-accent: #fff;
        --accent-glow: 0 0 20px rgba(255,255,255,0.15); --border-color: rgba(255,255,255,0.08);
        --border-hover: rgba(255,255,255,0.2); --primary: #ffffff; --danger: #ff4d4d;
        --success: #00e676; --warning: #ffb74d; --glass-blur: blur(12px);
        --radius-lg: 24px; --radius-md: 16px; --radius-sm: 8px;
        --font-main: 'Plus Jakarta Sans', sans-serif; --font-mono: 'JetBrains Mono', monospace;
    }
    body.light-theme {
        --bg-body: #f0f2f5; --bg-header: rgba(255,255,255,0.85); --bg-card: rgba(255,255,255,0.8);
        --bg-card-hover: #fff; --bg-tool: rgba(255,255,255,0.6); --bg-input: #f5f5f5;
        --bg-dropdown: #fff; --text-main: #111; --text-muted: #666; --text-accent: #000;
        --accent-glow: 0 4px 20px rgba(0,0,0,0.05); --border-color: rgba(0,0,0,0.08); --primary: #000;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; overflow-x: hidden; transition: background-color 0.3s, color 0.3s; background-image: radial-gradient(at 0% 0%, rgba(255,255,255,0.03) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(255,255,255,0.03) 0px, transparent 50%); }
    ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
    button { cursor: pointer; }
    .btn-primary { background: var(--primary); color: var(--bg-body); border: none; padding: 10px 20px; border-radius: var(--radius-sm); font-weight: 700; font-size: 0.95rem; transition: all 0.2s; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--accent-glow); opacity: 0.9; }
    .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: var(--radius-sm); font-weight: 600; transition: all 0.2s; }
    .btn-ghost:hover { border-color: var(--text-main); color: var(--text-main); background: rgba(255,255,255,0.03); }
    .card { background: var(--bg-card); backdrop-filter: var(--glass-blur); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 24px; transition: 0.3s; position: relative; overflow: hidden; }
    .card:hover { border-color: var(--border-hover); }
    input, select, textarea { background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-main); padding: 10px 14px; border-radius: var(--radius-sm); font-family: inherit; font-size: 0.9rem; transition: 0.2s; width: 100%; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--text-muted); }
    #appSection { display: none; flex-direction: column; min-height: 100vh; animation: fadeIn 0.5s ease-out; }
    header { position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; padding: 16px 32px; background: var(--bg-header); backdrop-filter: blur(15px); border-bottom: 1px solid var(--border-color); }
    .brand h1 { font-weight: 800; font-size: 1.4rem; letter-spacing: -0.5px; }
    .nav-links { display: flex; gap: 2rem; align-items: center; }
    .nav-link { color: var(--text-muted); text-decoration: none; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
    .nav-link:hover, .nav-link.active { color: var(--text-main); }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { display: none; position: absolute; top: 100%; left: 0; background: var(--bg-dropdown); min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); border: 1px solid var(--border-color); border-radius: var(--radius-sm); z-index: 1; padding: 5px 0; }
    .dropdown:hover .dropdown-content { display: block; }
    .dropdown-content a { color: var(--text-muted); padding: 10px 16px; display: block; text-decoration: none; font-size: 0.85rem; }
    .dropdown-content a:hover { background: var(--bg-card-hover); color: var(--text-main); }
    .user-controls { display: flex; gap: 12px; align-items: center; }
    .nav-clock { font-family: var(--font-mono); font-size: 0.8rem; background: rgba(125,125,125,0.1); padding: 4px 12px; border-radius: 4px; border: 1px solid var(--border-color); white-space: nowrap; }
    .mobile-menu-btn { display: none; background: none; border: none; font-size: 1.5rem; color: var(--text-main); }
    .main-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; padding: 30px; max-width: 1600px; margin: 0 auto; width: 100%; padding-bottom: 80px; }
    .area-hero { grid-column: span 8; } .area-stats { grid-column: span 4; }
    .area-tools { grid-column: span 12; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .area-calendar { grid-column: span 7; } .area-todo { grid-column: span 5; }
    .area-smart { grid-column: span 12; }
    @media (max-width: 1024px) { .area-hero, .area-stats, .area-tools, .area-calendar, .area-todo, .area-smart { grid-column: span 12; } .area-stats { display: flex; gap: 20px; } .area-tools { grid-template-columns: 1fr; } }
    @media (max-width: 768px) { .area-stats { flex-direction: column; } .mobile-menu-btn { display: block; } .nav-links { display: none; position: absolute; top: 100%; left: 0; width: 100%; background: var(--bg-card); padding: 20px; flex-direction: column; border-bottom: 1px solid var(--border-color); } .nav-links.active { display: flex; } .user-controls { display: none; } }
    .hero-card { background: linear-gradient(135deg, var(--bg-card) 0%, rgba(255,255,255,0.03) 100%); display: flex; flex-direction: column; justify-content: center; min-height: 240px; }
    .hero-greeting { font-size: 2.5rem; font-weight: 800; line-height: 1.1; margin-bottom: 10px; letter-spacing: -1px; }
    #heroChatSection { max-height: 0; opacity: 0; overflow: hidden; transition: 0.5s; display: flex; flex-direction: column; }
    #heroChatSection.open { max-height: 800px; opacity: 1; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }
    .chat-history { height: 500px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: var(--radius-sm); margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; }
    .chat-msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; line-height: 1.4; }
    .chat-msg.user { align-self: flex-end; background: var(--text-main); color: var(--bg-body); }
    .chat-msg.ai { align-self: flex-start; background: var(--bg-tool); border: 1px solid var(--border-color); }
    .stat-card { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    .stat-value { font-family: var(--font-mono); font-size: 2.5rem; font-weight: 700; }
    .stat-label { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
    .tool-widget { display: flex; flex-direction: column; align-items: center; padding: 20px; background: var(--bg-tool); }
    .digital-display { font-family: var(--font-mono); font-size: 3rem; font-weight: 700; background: rgba(125,125,125,0.1); padding: 10px 20px; border-radius: 8px; margin-bottom: 15px; width: 100%; text-align: center; border: 1px solid var(--border-color); }
    .tool-controls { display: flex; gap: 10px; width: 100%; justify-content: center; }
    .tool-btn { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: transparent; color: var(--text-main); font-weight: 600; }
    .tool-btn:hover { background: var(--text-main); color: var(--bg-body); }
    .xp-bar-container { position: relative; height: 12px; background: rgba(125,125,125,0.1); border-radius: 10px; overflow: hidden; margin: 15px 0; }
    .xp-bar-fill { height: 100%; background: var(--text-main); width: 0%; transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1); }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .cal-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
    .cal-day:hover { background: var(--bg-card-hover); border-color: var(--border-color); }
    .cal-day.today { color: var(--success); font-weight: 800; border: 1px solid var(--success); }
    .cal-day.selected { background: var(--text-main); color: var(--bg-body); font-weight: 700; }
    .event-dot { width: 5px; height: 5px; background: var(--text-muted); border-radius: 50%; position: absolute; bottom: 6px; }
    .event-dot.public { background: var(--success); box-shadow: 0 0 5px var(--success); }
    .todo-list { max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    .todo-item { background: rgba(125,125,125,0.05); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
    .todo-item:hover { background: rgba(125,125,125,0.1); }
    .status-done .todo-text { text-decoration: line-through; opacity: 0.5; }
    .is-due { color: var(--danger); font-weight: 700; }
    .is-due-soon { color: var(--warning); font-weight: 700; }
    /* Smart Plan Styles */
    .smart-btn-container { grid-column: span 12; margin-top: -10px; display: flex; justify-content: center; }
    #smartPlanBtn { background: linear-gradient(90deg, #00C9FF 0%, #92FE9D 100%); color: #000; font-weight: 800; border: none; padding: 15px 40px; border-radius: 30px; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(0,201,255,0.3); transition: transform 0.2s; }
    #smartPlanBtn:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0,201,255,0.5); }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center; }
    .modal-content { background: var(--bg-body); border: 1px solid var(--border-color); padding: 30px; border-radius: 20px; width: 90%; max-width: 600px; animation: scaleIn 0.3s; color: var(--text-main); position: relative; }
    @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #startupAnimation { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; pointer-events: none; }
    #animatedLogo { font-size: 3rem; font-weight: 800; letter-spacing: -2px; color: #fff; }
    .fade-out { opacity: 0; pointer-events: none; }
    #authWrapper { display: flex; height: 100vh; width: 100vw; align-items: center; justify-content: center; background: #050505; position: fixed; z-index: 5000; }
    .loading-spinner { border: 3px solid rgba(125,125,125,0.3); border-radius: 50%; border-top: 3px solid var(--text-main); width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="startupAnimation"><div id="animatedLogo">darStudy</div></div>

  <div id="authWrapper" style="display: none;">
    <div class="auth-box" style="text-align: center;">
        <h1 style="font-size: 2.5rem; margin-bottom: 20px;">darStudy</h1>
        <div id="authContainer"></div>
    </div>
  </div>

  <div id="appSection">
    <header>
      <div class="brand">
        <button id="mobileMenuBtn" class="mobile-menu-btn">‚ò∞</button>
        <h1>darStudy</h1>
      </div>
      <nav class="nav-links" id="navLinks">
        <a href="#" class="nav-link active">Dashboard</a>
        <a href="submissions.html" class="nav-link">Tasks</a>
        <div class="dropdown">
            <a href="#" class="nav-link">Resources ‚ñæ</a>
            <div class="dropdown-content">
                <a href="tutorials.html">Tutorials</a>
                <a href="pastpaper.html">Past Papers</a>
                <a href="materials.html">All Materials</a>
            </div>
        </div>
      </nav>
      <div class="user-controls d-none d-md-flex">
        <span id="navClock" class="nav-clock">00:00:00</span>
        <span id="userDisplayName" style="font-size: 0.9rem; font-weight: 600; cursor: pointer;">Guest</span>
        <button id="themeToggleButton" class="btn-ghost">‚óê</button>
        <button id="logoutButton" class="btn-ghost" style="color: var(--danger);">Exit</button>
      </div>
    </header>

    <div class="main-grid">
        <!-- Hero -->
        <div class="card area-hero hero-card" id="heroCard">
            <h2 id="dynamicGreeting" class="hero-greeting">Welcome back, <br><span id="homeUserNamePlaceholder" style="color: var(--text-main);">Student</span>.</h2>
            <p class="hero-sub">"You don't have to see the whole staircase, just take the first step."</p>
            <div class="hero-actions">
                <button id="viewAnalyticsBtn" class="btn-primary" style="background: rgba(125,125,125,0.2); border: 1px solid var(--border-color);">View Analytics üìà</button>
                <button id="toggleChatBtn" class="btn-primary">Ask AI Tutor ‚Üí</button>
            </div>
            <div id="heroChatSection">
                <div id="chatHistory" class="chat-history"></div>
                <div class="chat-input-area" style="display: flex; gap: 10px;">
                    <input type="file" id="chatImageInput" accept="image/*" style="display:none;">
                    <button id="chatAttachBtn" class="btn-ghost" style="width:40px;">üìé</button>
                    <input type="text" id="chatInput" placeholder="Type your question..." autocomplete="off">
                    <button id="chatSendBtn" class="btn-primary">Send</button>
                </div>
                <div id="chatImagePreview" style="display:none; color: var(--success);">Image attached!</div>
            </div>
            <div style="margin-top: auto; padding-top: 20px;">
                 <div class="xp-header" style="display: flex; justify-content: space-between;">
                    <span style="font-size: 0.8rem; color: var(--text-muted);">Current Progress</span>
                    <span id="xpProgressText" class="xp-badge" style="background:var(--text-main); color:var(--bg-body); padding:4px 8px; border-radius:4px;">Lvl 1</span>
                 </div>
                 <div class="xp-bar-container"><div id="xpProgressBar" class="xp-bar-fill"></div></div>
                 <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 id="xpBalanceDisplay" style="font-size: 1.5rem; font-weight: 700;">0 XP</h3>
                    <button id="openLogStudyBtn" class="btn-ghost">+ Log Study</button>
                 </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="card area-stats">
            <div class="stat-card" style="flex: 1; border-right: 1px solid var(--border-color);">
                <span class="stat-label">Current Time</span>
                <div id="currentTime" class="stat-value">00:00</div>
                <div id="currentDate" class="stat-sub">...</div>
            </div>
            <div class="stat-card" style="flex: 1;">
                <span class="stat-label">DSE 2026</span>
                <div id="countdown" class="stat-value" style="color: var(--warning);">--:--:--</div>
                <div class="stat-sub">Until Exams</div>
                <div id="teacher-controls" style="display: none; margin-top: 10px;">
                     <input type="datetime-local" id="countdown-datetime" style="font-size: 0.7rem;">
                     <button id="set-countdown-btn" class="btn-ghost" style="font-size: 0.7rem;">Set</button>
                </div>
            </div>
        </div>

        <!-- Tools -->
        <div class="area-tools">
            <div class="card tool-widget">
                <h3>Stopwatch</h3>
                <div id="stopwatchDisplay" class="digital-display">00:00:00</div>
                <div class="tool-controls">
                    <button id="startStopwatchBtn" class="tool-btn">Start</button>
                    <button id="stopStopwatchBtn" class="tool-btn" style="display:none; color:var(--danger); border-color:var(--danger);">Stop</button>
                    <button id="resetStopwatchBtn" class="tool-btn">Reset</button>
                </div>
            </div>
            <div class="card tool-widget" style="grid-column: span 2;">
                <h3>Focus Timer</h3>
                <div style="display: flex; gap: 20px; width: 100%; align-items: center;">
                    <div id="timerDisplay" class="digital-display" style="flex:1;">00:00:00</div>
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                        <div class="timer-inputs" style="display: flex; gap:5px; margin-bottom:10px;">
                            <input type="number" id="timerHours" placeholder="00" style="width:50px;">:
                            <input type="number" id="timerMinutes" placeholder="00" style="width:50px;">:
                            <input type="number" id="timerSeconds" placeholder="00" style="width:50px;">
                        </div>
                        <div class="tool-controls">
                            <button id="startTimerBtn" class="tool-btn">Start</button>
                            <button id="stopTimerBtn" class="tool-btn" style="display:none; color:var(--danger); border-color:var(--danger);">Stop</button>
                            <button id="resetTimerBtn" class="tool-btn">Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="card area-calendar">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <span style="font-size: 1.2rem; font-weight: 700;">Schedule</span>
                <div>
                    <select id="month-select" style="width:auto; background:transparent; border:none; color:var(--text-main); font-weight:700;"></select>
                    <select id="year-select" style="width:auto; background:transparent; border:none; color:var(--text-muted);"></select>
                    <button id="today-btn" class="btn-ghost" style="padding:4px 10px;">Today</button>
                </div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
            <div id="event-list-container" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                <h4 id="event-list-header" style="color:var(--text-muted); margin-bottom: 10px;">Selected Date</h4>
                <div id="event-list" style="min-height: 50px;"></div>
                <form id="add-event-form" style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <label style="font-size:0.7rem; color:var(--text-muted)">Start</label>
                        <input type="time" id="event-time" style="width: auto;">
                    </div>
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <label style="font-size:0.7rem; color:var(--text-muted)">End (Opt)</label>
                        <input type="time" id="event-end-time" style="width: auto;">
                    </div>
                    <input type="text" id="event-desc" placeholder="Event..." required style="flex:1;">
                    <input type="date" id="event-date" style="display:none;">
                    <div id="public-event-container" style="display:none; align-self:center;"><label><input type="checkbox" id="public-event-checkbox"> Public</label></div>
                    <button type="submit" class="btn-primary" style="align-self:flex-end;">+</button>
                </form>
            </div>
        </div>

        <!-- Todo -->
        <div class="card area-todo">
             <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <span style="font-size: 1.2rem; font-weight: 700;">Tasks</span>
            </div>
            <div id="todo-list" class="todo-list"></div>
            <form id="add-todo-form" style="margin-top: 15px; display: flex; flex-direction: column; gap: 10px;">
                <input type="text" id="todo-input" placeholder="New task..." required>
                <div style="display: flex; gap: 10px;">
                    <input type="date" id="todo-deadline">
                    <button type="submit" class="btn-primary">Add</button>
                </div>
            </form>
        </div>

        <!-- NEW: SMART PLAN BUTTON -->
        <div class="smart-btn-container">
            <button id="smartPlanBtn">‚ö° Smart Plan (Lazy Mode)</button>
        </div>
        
    </div>
  </div>

  <!-- Smart Plan Modal -->
  <div id="smartPlanModal" class="modal">
      <div class="modal-content">
          <span class="close-button smart-close" style="float: right; cursor: pointer; font-size: 1.5rem;">&times;</span>
          <h2 style="font-weight: 800; margin-bottom: 10px;">Smart Plan üß†</h2>
          <p style="color: var(--text-muted); margin-bottom: 15px;">Just type what you want to do. We'll handle the dates.</p>
          <textarea id="smartPlanInput" rows="5" placeholder="Eg: 'I have a meeting on Thursday from 2pm to 4pm, and assignment due tomorrow 2359. Also exam next Wednesday.'" style="width:100%; resize: none; margin-bottom: 15px;"></textarea>
          <div style="display:flex; justify-content: flex-end;">
              <button id="submitSmartPlanBtn" class="btn-primary">Do Magic ‚ú®</button>
          </div>
          <div id="smartPlanStatus" style="margin-top:10px; font-weight:bold;"></div>
      </div>
  </div>

  <!-- Smart Plan Success Modal -->
  <div id="smartSuccessModal" class="modal">
      <div class="modal-content" style="text-align: center;">
          <h2 style="color: var(--success); font-weight: 800; margin-bottom: 10px;">Done! üéâ</h2>
          <p style="color: var(--text-muted);">Here is what I added for you:</p>
          <div id="smartSuccessContent" style="text-align: left; background: rgba(125,125,125,0.1); padding: 15px; border-radius: 10px; margin: 20px 0; max-height: 300px; overflow-y: auto;"></div>
          <button class="btn-primary" onclick="document.getElementById('smartSuccessModal').style.display='none'">Awesome</button>
      </div>
  </div>

  <!-- Other Modals -->
  <div id="logStudyModal" class="modal">
      <div class="modal-content">
          <span class="close-button study-close" style="float: right; cursor: pointer;">&times;</span>
          <h3>Log Study Session</h3>
          <input type="file" id="studyScreenshotInput" accept="image/*" style="margin: 15px 0;">
          <div id="aiAnalysisStatus" style="margin-bottom:10px; font-size:0.8rem;"></div>
          <div style="display:flex; gap:10px;">
              <input type="number" id="log-hours" placeholder="Hrs">
              <input type="number" id="log-minutes" placeholder="Mins">
          </div>
          <input type="date" id="study-date-visible" style="margin: 10px 0;">
          <button id="confirmLogStudyBtn" class="btn-primary" style="width:100%;">Log Time</button>
      </div>
  </div>
  
  <div id="analyticsModal" class="modal">
      <div class="modal-content" style="max-width: 800px;">
          <span class="close-button analytics-close" style="float: right; cursor: pointer;">&times;</span>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
              <h3>Analytics</h3>
              <div style="display:flex; gap:10px;"><button id="analyticsPrevWeek" class="btn-ghost">&lt;</button><span id="analyticsDateRange">...</span><button id="analyticsNextWeek" class="btn-ghost">&gt;</button></div>
          </div>
          <canvas id="studyChart"></canvas>
          <button id="analyzeWithAiBtn" class="btn-primary" style="width:100%; margin-top:10px;">‚ú® Analyze with AI</button>
      </div>
  </div>
  
  <div id="profileEditModal" class="modal">
      <div class="modal-content">
          <span class="close-button profile-close" style="float: right; cursor: pointer;">&times;</span>
          <h3>Edit Profile</h3>
          <input type="text" id="editUserName" placeholder="Display Name" style="margin:10px 0;">
          <button id="saveProfileButton" class="btn-primary">Save</button>
      </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, limit, getDocs, deleteDoc, onSnapshot, addDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
      authDomain: "ai-grading-9bb30.firebaseapp.com",
      projectId: "ai-grading-9bb30",
      storageBucket: "ai-grading-9bb30.appspot.com",
      messagingSenderId: "298162112230",
      appId: "1:298162112230:web:529d3f95536991be685d27"
    };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    let app, db, auth, currentUserId = null, currentUserRole = 'student', currentUserName = null;
    let personalEvents=[], publicEvents=[], todoItems=[], studyHistory=[], xpBalance=0;
    let stopwatchInterval, stopwatchStartTime=0, stopwatchRunning=false;
    let timerInterval, timerTimeRemaining=0, timerRunning=false;
    let studyChart, analyticsWeekOffset=0;
    
    try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch (e) { console.error(e); }

    const startupAnimation = document.getElementById('startupAnimation');
    const appSection = document.getElementById('appSection');
    const authWrapper = document.getElementById('authWrapper');

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserId = user.uid;
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    currentUserRole = snap.data().role || 'student';
                    currentUserName = snap.data().name || user.displayName;
                } else {
                    currentUserName = user.displayName;
                    await setDoc(docRef, { name: currentUserName, email: user.email, role: 'student', xpBalance: 0 }, { merge: true });
                }
                showApp();
            } catch (e) { showLogin(); }
        } else { showLogin(); }
    });

    function showLogin() {
        appSection.style.display = 'none'; authWrapper.style.display = 'flex'; startupAnimation.style.display = 'none';
        document.getElementById('authContainer').innerHTML = `<button id="gLogin" class="btn-primary" style="background:#fff; color:#000;">Sign in with Google</button>`;
        document.getElementById('gLogin').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
    }

    function showApp() {
        authWrapper.style.display = 'none'; appSection.style.display = 'flex';
        document.getElementById('userDisplayName').textContent = currentUserName;
        document.getElementById('homeUserNamePlaceholder').textContent = currentUserName;
        if(currentUserRole === 'teacher') document.getElementById('teacher-controls').style.display='block';
        startupAnimation.classList.add('fade-out'); setTimeout(() => startupAnimation.style.display='none', 500);
        
        initDashboard();
        listenData();
        setInterval(updateClock, 1000);
    }

    function listenData() {
        onSnapshot(collection(db, `artifacts/${appId}/users/${currentUserId}/events`), s => { personalEvents = s.docs.map(d=>({id:d.id,...d.data()})); refreshCal(); });
        onSnapshot(collection(db, `artifacts/${appId}/public/data/public_events`), s => { publicEvents = s.docs.map(d=>({id:d.id,...d.data()})); refreshCal(); });
        onSnapshot(collection(db, `artifacts/${appId}/users/${currentUserId}/todos`), s => { todoItems = s.docs.map(d=>({id:d.id,...d.data()})); renderTodos(); });
        onSnapshot(doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`), d => { 
            if(d.exists()) { xpBalance = d.data().xpBalance||0; document.getElementById('xpBalanceDisplay').textContent=`${xpBalance} XP`; document.getElementById('xpProgressBar').style.width=`${(xpBalance%1000)/10}%`; }
        });
        onSnapshot(query(collection(db, `artifacts/${appId}/users/${currentUserId}/studyHistory`), limit(100)), s => studyHistory = s.docs.map(d=>d.data()));
        onSnapshot(doc(db, `artifacts/${appId}/public/data/settings/countdown`), d => { if(d.exists()&&d.data().target) startCountdown(d.data().target.toDate()); });
    }

    function initDashboard() {
        // Calendar setup
        const mSel = document.getElementById('month-select');
        ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].forEach((m,i)=>mSel.add(new Option(m,i)));
        const ySel = document.getElementById('year-select');
        const yr = new Date().getFullYear();
        for(let i=yr-2; i<=yr+2; i++) ySel.add(new Option(i,i));
        
        let d = new Date();
        mSel.value = d.getMonth(); ySel.value = d.getFullYear();
        refreshCal();
        
        mSel.onchange = refreshCal; ySel.onchange = refreshCal;
        document.getElementById('today-btn').onclick = () => { let n = new Date(); mSel.value=n.getMonth(); ySel.value=n.getFullYear(); refreshCal(); };
        
        // Event Listeners
        document.getElementById('add-event-form').onsubmit = async (e) => {
            e.preventDefault();
            const date = document.getElementById('event-date').value;
            const desc = document.getElementById('event-desc').value;
            const time = document.getElementById('event-time').value;
            const endTime = document.getElementById('event-end-time').value;
            const isPub = document.getElementById('public-event-checkbox').checked;
            if(!date||!desc) return;
            const col = isPub ? `artifacts/${appId}/public/data/public_events` : `artifacts/${appId}/users/${currentUserId}/events`;
            await addDoc(collection(db, col), { description:desc, date, time, endTime, isPublic:isPub });
            document.getElementById('event-desc').value='';
        };
        
        document.getElementById('add-todo-form').onsubmit = async (e) => {
            e.preventDefault();
            const desc = document.getElementById('todo-input').value;
            const dl = document.getElementById('todo-deadline').value;
            await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/todos`), { description:desc, deadline:dl, status:'not-started' });
            document.getElementById('todo-input').value='';
        };
        
        // Smart Plan
        document.getElementById('smartPlanBtn').onclick = () => document.getElementById('smartPlanModal').style.display='flex';
        document.querySelector('.smart-close').onclick = () => document.getElementById('smartPlanModal').style.display='none';
        document.getElementById('submitSmartPlanBtn').onclick = handleSmartPlan;

        // Modals
        document.getElementById('openLogStudyBtn').onclick = () => document.getElementById('logStudyModal').style.display='flex';
        document.querySelector('.study-close').onclick = () => document.getElementById('logStudyModal').style.display='none';
        document.getElementById('confirmLogStudyBtn').onclick = handleLogStudy;
        document.getElementById('studyScreenshotInput').onchange = handleStudyScreenshot;
        
        document.getElementById('viewAnalyticsBtn').onclick = () => { document.getElementById('analyticsModal').style.display='flex'; renderChart(); };
        document.querySelector('.analytics-close').onclick = () => document.getElementById('analyticsModal').style.display='none';
        document.getElementById('analyzeWithAiBtn').onclick = handleAnalyzeAI;

        document.getElementById('themeToggleButton').onclick = () => document.body.classList.toggle('light-theme');
        document.getElementById('logoutButton').onclick = () => signOut(auth);
        
        // Tools
        document.getElementById('startStopwatchBtn').onclick = startStopwatch;
        document.getElementById('stopStopwatchBtn').onclick = () => { clearInterval(stopwatchInterval); stopwatchRunning=false; toggleStopwatchBtns(); };
        document.getElementById('resetStopwatchBtn').onclick = () => { clearInterval(stopwatchInterval); stopwatchRunning=false; stopwatchStartTime=0; document.getElementById('stopwatchDisplay').textContent='00:00:00'; toggleStopwatchBtns(); };
        
        document.getElementById('startTimerBtn').onclick = startTimer;
        document.getElementById('stopTimerBtn').onclick = () => { clearInterval(timerInterval); timerRunning=false; toggleTimerBtns(); };
        document.getElementById('resetTimerBtn').onclick = () => { clearInterval(timerInterval); timerRunning=false; timerTimeRemaining=0; document.getElementById('timerDisplay').textContent='00:00:00'; toggleTimerBtns(); };
        
        // Chat
        document.getElementById('toggleChatBtn').onclick = () => document.getElementById('heroChatSection').classList.toggle('open');
        document.getElementById('chatSendBtn').onclick = sendChat;
        document.getElementById('chatAttachBtn').onclick = () => document.getElementById('chatImageInput').click();
        document.getElementById('chatImageInput').onchange = () => document.getElementById('chatImagePreview').style.display='block';
        
        document.getElementById('userDisplayName').onclick = () => document.getElementById('profileEditModal').style.display='flex';
        document.querySelector('.profile-close').onclick = () => document.getElementById('profileEditModal').style.display='none';
        document.getElementById('saveProfileButton').onclick = async () => {
             const n = document.getElementById('editUserName').value;
             if(n) { await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`), {name:n}); document.getElementById('profileEditModal').style.display='none'; }
        }
    }

    // === SMART PLAN LOGIC ===
    async function handleSmartPlan() {
        const text = document.getElementById('smartPlanInput').value;
        const statusEl = document.getElementById('smartPlanStatus');
        if(!text) return;
        
        statusEl.innerHTML = '<span class="loading-spinner"></span> Thinking...';
        
        const prompt = `
            User Input: "${text}"
            Current Date/Time: ${new Date().toISOString()}
            
            Task: Extract Calendar Events and To-Do items from the user input.
            - If it implies a specific time/meeting/appointment, make it an Event.
            - If it implies a deadline/submission/exam, make it a Todo (set deadline).
            - For events, try to infer start and end time.
            - Return JSON ONLY: { "events": [{ "description": "", "date": "YYYY-MM-DD", "time": "HH:MM", "endTime": "HH:MM" (optional) }], "todos": [{ "description": "", "deadline": "YYYY-MM-DD" }] }
        `;
        
        try {
            const res = await fetch("https://gemini-proxy-513372702506.us-central1.run.app/proxy", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await res.json();
            const raw = data.candidates?.[0]?.content?.parts?.[0]?.text;
            const jsonStr = raw.replace(/```json/g, '').replace(/```/g, '').trim();
            const plan = JSON.parse(jsonStr);
            
            let summaryHtml = "";
            
            // Add Events
            if(plan.events) {
                for(const ev of plan.events) {
                    await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/events`), {
                        description: ev.description,
                        date: ev.date,
                        time: ev.time || "00:00",
                        endTime: ev.endTime || "",
                        isPublic: false
                    });
                    summaryHtml += `<div>üìÖ <b>Event:</b> ${ev.description} (${ev.date} ${ev.time} ${ev.endTime ? '- '+ev.endTime : ''})</div>`;
                }
            }
            
            // Add Todos
            if(plan.todos) {
                for(const td of plan.todos) {
                    await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/todos`), {
                        description: td.description,
                        deadline: td.deadline,
                        status: 'not-started'
                    });
                    summaryHtml += `<div>‚úÖ <b>Task:</b> ${td.description} (Due: ${td.deadline || 'None'})</div>`;
                }
            }
            
            document.getElementById('smartPlanModal').style.display='none';
            document.getElementById('smartPlanInput').value = '';
            statusEl.innerHTML = '';
            document.getElementById('smartSuccessContent').innerHTML = summaryHtml || "No actionable items found.";
            document.getElementById('smartSuccessModal').style.display='flex';
            
        } catch(e) {
            console.error(e);
            statusEl.textContent = "Error parsing plan. Try being more specific.";
        }
    }

    // === CALENDAR & TODOS ===
    function refreshCal() {
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';
        ['S','M','T','W','T','F','S'].forEach(d=>grid.innerHTML+=`<div style="text-align:center;font-size:0.8rem;color:var(--text-muted)">${d}</div>`);
        
        const m = parseInt(document.getElementById('month-select').value);
        const y = parseInt(document.getElementById('year-select').value);
        const firstDay = new Date(y, m, 1).getDay();
        const daysInMonth = new Date(y, m+1, 0).getDate();
        
        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
        
        for(let i=1; i<=daysInMonth; i++) {
            const dateStr = `${y}-${pad(m+1)}-${pad(i)}`;
            const el = document.createElement('div');
            el.className = 'cal-day'; el.textContent = i;
            if(dateStr === document.getElementById('event-date').value) el.classList.add('selected');
            const evs = [...personalEvents, ...publicEvents].filter(e=>e.date===dateStr);
            if(evs.length) {
                const dot = document.createElement('div'); dot.className='event-dot';
                if(evs.some(e=>e.isPublic)) dot.classList.add('public');
                el.appendChild(dot);
            }
            el.onclick = () => {
                document.getElementById('event-date').value = dateStr;
                refreshCal(); renderEventList(dateStr);
            };
            grid.appendChild(el);
        }
        
        // Auto select today if not set
        if(!document.getElementById('event-date').value) {
            const now = new Date();
            document.getElementById('event-date').value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
            renderEventList(document.getElementById('event-date').value);
        } else {
             renderEventList(document.getElementById('event-date').value);
        }
    }

    function renderEventList(date) {
        const list = document.getElementById('event-list');
        list.innerHTML = '';
        const evs = [...personalEvents, ...publicEvents].filter(e=>e.date===date).sort((a,b)=>a.time.localeCompare(b.time));
        document.getElementById('event-list-header').textContent = new Date(date).toDateString();
        
        if(!evs.length) list.innerHTML = `<p style="color:var(--text-muted);font-size:0.8rem;">No events</p>`;
        evs.forEach(e => {
            const div = document.createElement('div');
            const timeStr = e.endTime ? `${e.time} - ${e.endTime}` : e.time;
            div.innerHTML = `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid var(--border-color);">
                <div><div style="font-size:0.75rem; color:var(--text-muted)">${timeStr} ${e.isPublic?'‚Ä¢ PUB':''}</div><div style="font-weight:600;">${e.description}</div></div>
                <button onclick="window.delEvent('${e.id}',${e.isPublic})" style="background:none;border:none;color:var(--text-muted);">&times;</button>
            </div>`;
            list.appendChild(div);
        });
    }

    window.delEvent = async (id, pub) => {
        const col = pub ? `artifacts/${appId}/public/data/public_events` : `artifacts/${appId}/users/${currentUserId}/events`;
        await deleteDoc(doc(db, col, id));
    };

    function renderTodos() {
        const list = document.getElementById('todo-list');
        list.innerHTML = '';
        const sorted = todoItems.sort((a,b) => {
             if(a.status === 'full-done' && b.status !== 'full-done') return 1;
             if(a.status !== 'full-done' && b.status === 'full-done') return -1;
             return (a.deadline||'9999') > (b.deadline||'9999') ? 1 : -1;
        });
        
        sorted.forEach(t => {
            const el = document.createElement('div'); el.className = 'todo-item';
            if(t.status==='full-done') el.classList.add('status-done');
            
            // Deadline logic
            let dueText = t.deadline || '';
            if(t.deadline && t.status!=='full-done') {
                const diff = Math.ceil((new Date(t.deadline) - new Date()) / (1000*60*60*24));
                if(diff < 0) dueText = `<span class="is-due">Overdue</span>`;
                else if(diff <= 2) dueText = `<span class="is-due-soon">Due Soon</span>`;
            }

            el.innerHTML = `
                <div style="flex:1;">
                    <div class="todo-text">${t.description}</div>
                    <div style="font-size:0.75rem;color:var(--text-muted)">${dueText}</div>
                </div>
                <select onchange="window.updTodo('${t.id}',this.value)" style="width:auto; border:none; background:transparent;">
                    <option value="not-started" ${t.status==='not-started'?'selected':''}>TODO</option>
                    <option value="half-done" ${t.status==='half-done'?'selected':''}>DOING</option>
                    <option value="full-done" ${t.status==='full-done'?'selected':''}>DONE</option>
                </select>
                <button onclick="window.delTodo('${t.id}')" style="background:none;border:none;color:var(--text-muted)">üóë</button>
            `;
            list.appendChild(el);
        });
    }
    window.delTodo = async (id) => deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/todos`, id));
    window.updTodo = async (id, val) => updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/todos`, id), { status: val });

    // === UTILS ===
    function pad(n) { return n.toString().padStart(2,'0'); }
    function updateClock() {
        const now = new Date();
        document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US',{hour12:false, hour:'2-digit', minute:'2-digit'});
        document.getElementById('currentDate').textContent = now.toDateString();
        document.getElementById('navClock').textContent = now.toLocaleString('en-US', {weekday:'short', hour:'2-digit', minute:'2-digit'});
    }
    
    // === TOOLS ===
    function startStopwatch() {
        stopwatchRunning=true; toggleStopwatchBtns();
        stopwatchStartTime = Date.now() - (stopwatchStartTime ? stopwatchStartTime : 0);
        stopwatchInterval = setInterval(() => {
            const e = Date.now() - stopwatchStartTime;
            document.getElementById('stopwatchDisplay').textContent = new Date(e).toISOString().slice(11,19);
        }, 100);
        // Fix for stopwatch reset logic in UI
        stopwatchStartTime = Date.now(); 
    }
    function toggleStopwatchBtns() {
        document.getElementById('startStopwatchBtn').style.display=stopwatchRunning?'none':'inline-block';
        document.getElementById('stopStopwatchBtn').style.display=stopwatchRunning?'inline-block':'none';
    }
    
    function startTimer() {
        if(!timerTimeRemaining) {
            const h=document.getElementById('timerHours').value||0, m=document.getElementById('timerMinutes').value||0, s=document.getElementById('timerSeconds').value||0;
            timerTimeRemaining = (h*3600)+(m*60)+(s*1);
        }
        if(timerTimeRemaining>0) {
            timerRunning=true; toggleTimerBtns();
            timerInterval = setInterval(() => {
                timerTimeRemaining--;
                const h=Math.floor(timerTimeRemaining/3600), m=Math.floor((timerTimeRemaining%3600)/60), s=timerTimeRemaining%60;
                document.getElementById('timerDisplay').textContent = `${pad(h)}:${pad(m)}:${pad(s)}`;
                if(timerTimeRemaining<=0) { clearInterval(timerInterval); timerRunning=false; toggleTimerBtns(); alert("Time's up!"); }
            }, 1000);
        }
    }
    function toggleTimerBtns() {
        document.getElementById('startTimerBtn').style.display=timerRunning?'none':'inline-block';
        document.getElementById('stopTimerBtn').style.display=timerRunning?'inline-block':'none';
    }

    // === STUDY LOG ===
    async function handleLogStudy() {
        const h=parseInt(document.getElementById('log-hours').value)||0;
        const m=parseInt(document.getElementById('log-minutes').value)||0;
        const d=document.getElementById('study-date-visible').value;
        if(!d || (h+m)===0) return alert('Invalid Input');
        
        const pts = (h + m/60) * 10;
        await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`), { xpBalance: increment(pts) });
        await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/studyHistory`), { date:d, hours:h+(m/60), createdAt:serverTimestamp() });
        document.getElementById('logStudyModal').style.display='none';
        alert(`Logged! +${pts.toFixed(1)} XP`);
    }

    async function handleStudyScreenshot() {
        const file = document.getElementById('studyScreenshotInput').files[0];
        if(!file) return;
        document.getElementById('aiAnalysisStatus').innerHTML = '<span class="loading-spinner"></span> Scanning...';
        
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onloadend = async () => {
            try {
                const res = await fetch("https://gemini-proxy-513372702506.us-central1.run.app/proxy", {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: "Extract total study time from image. Return JSON: {hours: 0, minutes: 0}" }, { inlineData: { mimeType: file.type, data: reader.result.split(',')[1] } }] }] })
                });
                const data = await res.json();
                const json = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, ''));
                document.getElementById('log-hours').value = json.hours;
                document.getElementById('log-minutes').value = json.minutes;
                document.getElementById('aiAnalysisStatus').textContent = `Found: ${json.hours}h ${json.minutes}m`;
            } catch(e) { document.getElementById('aiAnalysisStatus').textContent = 'Could not read image.'; }
        }
    }

    // === CHAT ===
    async function sendChat() {
        const txt = document.getElementById('chatInput').value;
        const imgInput = document.getElementById('chatImageInput');
        if(!txt && !imgInput.files.length) return;
        
        const history = document.getElementById('chatHistory');
        const userMsg = document.createElement('div'); userMsg.className='chat-msg user'; userMsg.textContent=txt; history.appendChild(userMsg);
        
        let parts = [{ text: txt }];
        if(imgInput.files.length) {
             const reader = new FileReader();
             reader.readAsDataURL(imgInput.files[0]);
             await new Promise(r => reader.onloadend = r);
             parts.push({ inlineData: { mimeType: imgInput.files[0].type, data: reader.result.split(',')[1] } });
        }

        const aiMsg = document.createElement('div'); aiMsg.className='chat-msg ai'; aiMsg.textContent='...'; history.appendChild(aiMsg);
        document.getElementById('chatInput').value='';
        
        try {
            const res = await fetch("https://gemini-proxy-513372702506.us-central1.run.app/proxy", {
                method: 'POST', body: JSON.stringify({ contents: [{ parts }] }), headers: {'Content-Type':'application/json'}
            });
            const data = await res.json();
            aiMsg.innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
            renderMathInElement(aiMsg);
        } catch(e) { aiMsg.textContent="Error."; }
    }
  </script>
</body>
</html>
