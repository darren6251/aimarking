<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materials</title>
    <!-- Firebase Libraries -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"></script>
    <!-- PDF.js library for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- Stripe.js for payments -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Custom styles -->
    <style>
        /* --- MODERN BLACK & WHITE THEME --- */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --accent-primary: #ffffff;
            --accent-red: #ef4444;
            --border-color: #333333;
            --focus-ring-color: rgba(245, 245, 245, 0.5);

            --finder-bg-primary: #1c1c1c;
            --finder-bg-secondary: #0a0a0a;
            --finder-border-color: #444;
            --finder-text-color: #f5f5f5;
            --finder-heading-color: #fff;
            --finder-hover-bg: #2a2a2a;
            --finder-selected-bg: #444;
            --finder-selected-text: #fff;
        }

        /* --- THEME TOGGLE --- */
        body.light-theme {
            --bg-primary: #f0f2f5;
            --bg-secondary: #e0e4eb;
            --bg-tertiary: #d0d5dc;
            --text-primary: #1c1c1c;
            --text-secondary: #5a5a5a;
            --accent-primary: #000000;
            --accent-red: #cc0000;
            --border-color: #b0b0b0;
            --focus-ring-color: rgba(0, 0, 0, 0.2);

            --finder-bg-primary: #d0d5dc;
            --finder-bg-secondary: #f0f2f5;
            --finder-border-color: #b0b0b0;
            --finder-text-color: #1c1c1c;
            --finder-heading-color: #000;
            --finder-hover-bg: #e0e4eb;
            --finder-selected-bg: #ccc;
            --finder-selected-text: #000;
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
        }

        /* Loading state overlay */
        .loading-state {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-primary);
            z-index: 1000;
            transition: opacity 0.5s ease-in-out;
            opacity: 1;
        }

        .loading-state h2 {
            font-size: 2rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--text-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-primary);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .btn:hover {
            background-color: var(--bg-tertiary);
        }

        .btn.btn-primary {
            background-color: var(--accent-primary);
            color: var(--bg-primary);
            border-color: var(--accent-primary);
        }

        .btn.btn-primary:hover {
            background-color: var(--text-primary);
        }

        .btn.logout-btn {
            color: var(--accent-red);
            border-color: var(--accent-red);
        }

        .btn.logout-btn:hover {
            background-color: var(--accent-red);
            color: var(--text-primary);
        }

        .content-area {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* --- TABS --- */
        .tabs {
            display: flex;
            gap: 0.5rem;
            padding: 1rem 2rem 0;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-primary);
        }

        .tab-button {
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .tab-button.active {
            color: var(--text-primary);
            border-bottom: 2px solid var(--accent-primary);
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background-color: var(--bg-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .item-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }

        .item-list.list-mode {
            grid-template-columns: 1fr;
        }

        .item-card {
            background-color: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            border: 1px solid transparent;
            transition: border-color 0.2s, transform 0.2s, box-shadow 0.2s;
        }

        .item-card:hover {
            border-color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .item-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .item-card.placeholder {
            border: 2px dashed var(--accent-primary);
            background-color: transparent;
            min-height: 100px;
            transition: all 0.2s;
            visibility: hidden;
        }
        
        .item-card.placeholder.visible {
            visibility: visible;
        }


        .item-info h4 {
            margin: 0 0 0.5rem;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .item-info p {
            margin: 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        .item-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .item-meta span {
            background-color: var(--bg-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        
        .item-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .item-actions button {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .item-actions button:hover {
            background-color: var(--bg-tertiary);
        }

        /* --- CRUD & Finder Interface --- */
        .finder-interface {
            display: flex;
            height: 100%;
            background-color: var(--finder-bg-primary);
        }

        .finder-sidebar {
            width: 250px;
            padding: 1rem;
            border-right: 1px solid var(--finder-border-color);
            overflow-y: auto;
            background-color: var(--finder-bg-primary);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .finder-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--finder-heading-color);
        }

        .finder-toggle {
            background-color: var(--finder-bg-secondary);
            color: var(--finder-text-color);
            border: 1px solid var(--finder-border-color);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .finder-toggle:hover {
            background-color: var(--finder-bg-primary);
        }

        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-section h3 {
            font-size: 1rem;
            color: var(--finder-heading-color);
            margin-top: 0;
            margin-bottom: 0.5rem;
        }

        .filter-section select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--finder-border-color);
            background-color: var(--finder-bg-secondary);
            color: var(--finder-text-color);
            appearance: none;
        }

        .finder-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .finder-item {
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .finder-item.active {
            background-color: var(--finder-selected-bg);
            color: var(--finder-selected-text);
        }

        .finder-item:hover {
            background-color: var(--finder-hover-bg);
        }

        .finder-item.drag-over {
            border: 1px dashed var(--accent-primary);
        }

        .crud-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* --- MODAL STYLES --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            position: relative;
            max-height: 90%;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .modal-body {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .close-button {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
        }

        .full-preview-modal-content {
            width: 90%;
            height: 90%;
            max-width: 1200px;
            max-height: 900px;
            background-color: #000;
            padding: 0;
        }

        .full-preview-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .full-preview-container > * {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        #pdfCanvas {
            border: 1px solid var(--border-color);
        }
        
        #pdfNav {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        #pdfNav button {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
        }
        #pdfNav button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .drop-zone {
            border: 2px dashed var(--border-color);
            padding: 2rem;
            text-align: center;
            border-radius: 8px;
            margin-top: 1rem;
            color: var(--text-secondary);
            transition: border-color 0.2s;
        }
        
        .drop-zone.drag-over {
            border-color: var(--accent-primary);
            background-color: var(--bg-tertiary);
        }

    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-state">
        <div class="spinner"></div>
        <h2>Loading...</h2>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="main-container">
        <header>
            <div class="logo">AI Marker</div>
            <div class="nav-buttons">
                <button id="themeToggleButton" class="btn">Toggle Theme</button>
                <button id="logoutButton" class="btn logout-btn" style="display:none;">Logout</button>
            </div>
        </header>

        <div class="content-area">
            <!-- Finder Sidebar -->
            <aside class="finder-sidebar">
                <div class="sidebar-header">
                    <h2 class="finder-title">Finder</h2>
                    <button id="listModeToggle" class="finder-toggle">List</button>
                </div>
                
                <div class="filter-section">
                    <h3>Subject</h3>
                    <select id="subjectFilter">
                        <option value="">All Subjects</option>
                    </select>
                </div>

                <div class="filter-section">
                    <h3>Year</h3>
                    <select id="yearFilter">
                        <option value="">All Years</option>
                    </select>
                </div>
                
                <div class="filter-section">
                    <h3>Topic</h3>
                    <select id="topicFilter">
                        <option value="">All Topics</option>
                    </select>
                </div>

                <div class="crud-buttons">
                    <button id="addMaterialButton" class="btn" style="display:none;">Add New Material</button>
                </div>

                <ul id="finderList" class="finder-list">
                    <!-- Finder items will be dynamically added here -->
                </ul>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content">
                <div class="tabs">
                    <button class="tab-button active" data-tab-id="tutorials">Tutorials</button>
                    <button class="tab-button" data-tab-id="pastPapers">Past Papers</button>
                    <button class="tab-button" data-tab-id="exercises">Exercises</button>
                </div>

                <div id="tutorialsTab" class="tab-content active">
                    <div id="tutorialsList" class="item-list"></div>
                </div>

                <div id="pastPapersTab" class="tab-content">
                    <div id="pastPapersList" class="item-list"></div>
                </div>

                <div id="exercisesTab" class="tab-content">
                    <div id="exercisesList" class="item-list"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->

    <!-- Main Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" class="modal-title"></h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modalMessage"></p>
                <div id="modalForm" style="display:none;">
                    <input type="text" id="modalInput" class="btn" placeholder="Enter promo code">
                </div>
            </div>
            <div id="modalButtons" class="modal-buttons"></div>
        </div>
    </div>

    <!-- Full Preview Modal -->
    <div id="fullPreviewModal" class="modal">
        <div class="modal-content full-preview-modal-content">
            <div class="modal-header">
                <h2 id="fullPreviewTitle" class="modal-title"></h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="full-preview-container">
                <img id="fullPreviewImage" style="display:none;">
                <video id="fullPreviewVideo" controls style="display:none;"></video>
                <div id="pdfViewer" style="display:none; width: 100%; height: 100%; overflow: auto;">
                    <canvas id="pdfCanvas"></canvas>
                    <div id="pdfNav">
                        <button id="prevPdfPageBtn">Previous</button>
                        <span>Page <span id="pageNum"></span> of <span id="pageCount"></span></span>
                        <button id="nextPdfPageBtn">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Material Modal -->
    <div id="crudModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="crudModalTitle" class="modal-title"></h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <form id="crudForm">
                    <label for="materialName">Name:</label>
                    <input type="text" id="materialName" required><br><br>
                    <label for="materialSubject">Subject:</label>
                    <input type="text" id="materialSubject" required><br><br>
                    <label for="materialYear">Year:</label>
                    <input type="text" id="materialYear"><br><br>
                    <label for="materialTopic">Topic:</label>
                    <input type="text" id="materialTopic"><br><br>
                    <label for="materialUrl">URL:</label>
                    <input type="url" id="materialUrl"><br><br>
                    <div id="promoCodeContainer" style="display:none;">
                        <label for="materialPromoCode">Promo Code:</label>
                        <input type="text" id="materialPromoCode"><br><br>
                    </div>
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" id="cancelCrud" class="btn">Cancel</button>
                </form>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Global variables for Firebase configuration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization ---
        let app, db, auth, storage, userId;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showModal('Firebase Error', 'Failed to initialize Firebase. Please check the configuration.');
        }

        const materialsCollections = {
            'tutorials': 'tutorials',
            'pastPapers': 'past_papers',
            'exercises': 'exercises'
        };

        let isTeacher = false;
        let allMaterials = {
            tutorials: [],
            pastPapers: [],
            exercises: []
        };
        let filteredMaterials = { ...allMaterials };
        let currentTab = 'tutorials';
        let currentFilters = { subject: '', year: '', topic: '' };
        let purchasedItems = [];

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const mainContent = document.getElementById('mainContent');
        const logoutButton = document.getElementById('logoutButton');
        const themeToggleButton = document.getElementById('themeToggleButton');
        const tabButtons = document.querySelectorAll('.tab-button');
        const lists = {
            tutorials: document.getElementById('tutorialsList'),
            pastPapers: document.getElementById('pastPapersList'),
            exercises: document.getElementById('exercisesList')
        };
        const finderSidebar = document.querySelector('.finder-sidebar');
        const listModeToggle = document.getElementById('listModeToggle');
        const finderList = document.getElementById('finderList');
        const subjectFilter = document.getElementById('subjectFilter');
        const yearFilter = document.getElementById('yearFilter');
        const topicFilter = document.getElementById('topicFilter');
        const addMaterialButton = document.getElementById('addMaterialButton');

        // Modal Elements
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalForm = document.getElementById('modalForm');
        const modalInput = document.getElementById('modalInput');
        const modalButtons = document.getElementById('modalButtons');
        const fullPreviewModal = document.getElementById('fullPreviewModal');
        const fullPreviewTitle = document.getElementById('fullPreviewTitle');
        const fullPreviewImage = document.getElementById('fullPreviewImage');
        const fullPreviewVideo = document.getElementById('fullPreviewVideo');
        const pdfViewer = document.getElementById('pdfViewer');
        const pdfCanvas = document.getElementById('pdfCanvas');
        const pageNumSpan = document.getElementById('pageNum');
        const pageCountSpan = document.getElementById('pageCount');
        const prevPdfPageBtn = document.getElementById('prevPdfPageBtn');
        const nextPdfPageBtn = document.getElementById('nextPdfPageBtn');
        const crudModal = document.getElementById('crudModal');
        const crudModalTitle = document.getElementById('crudModalTitle');
        const crudForm = document.getElementById('crudForm');
        const materialNameInput = document.getElementById('materialName');
        const materialSubjectInput = document.getElementById('materialSubject');
        const materialYearInput = document.getElementById('materialYear');
        const materialTopicInput = document.getElementById('materialTopic');
        const materialUrlInput = document.getElementById('materialUrl');
        const promoCodeContainer = document.getElementById('promoCodeContainer');
        const materialPromoCodeInput = document.getElementById('materialPromoCode');

        // PDF.js variables
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        const pdfContext = pdfCanvas.getContext('2d');
        const maxPdfWidth = 800;

        // Drag and drop variables
        let draggedItem = null;
        let placeholder = null;
        let dropTargetList = null;

        // --- Core Functions ---
        async function fetchInitialData() {
            try {
                // Fetch user data including purchased items
                const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    purchasedItems = userData.purchasedItems || [];
                    if (userData.role === 'teacher') {
                        isTeacher = true;
                        addMaterialButton.style.display = 'block';
                    }
                }

                // Listen for changes to materials
                for (const key in materialsCollections) {
                    const collectionName = materialsCollections[key];
                    const collectionRef = collection(db, `/artifacts/${appId}/public/data/${collectionName}`);
                    onSnapshot(collectionRef, (snapshot) => {
                        const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        allMaterials[key] = items;
                        applyFiltersAndRender();
                    }, (error) => {
                        console.error("Error listening to collection:", collectionName, error);
                        showModal('Data Error', `Failed to load ${key}: ${error.message}`);
                    });
                }

                // Initial load is successful
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                    mainContent.style.opacity = '1';
                    mainContent.style.display = 'flex';
                }, 500);

            } catch (error) {
                console.error("Initial data fetch error:", error);
                showModal('Initialization Error', `Failed to load data: ${error.message}`);
            }
        }

        function applyFiltersAndRender() {
            // Get selected filter values
            const selectedSubject = subjectFilter.value;
            const selectedYear = yearFilter.value;
            const selectedTopic = topicFilter.value;

            // Update filter options
            updateFilterOptions();

            for (const tab in allMaterials) {
                filteredMaterials[tab] = allMaterials[tab].filter(item => {
                    const matchesSubject = !selectedSubject || item.subject === selectedSubject;
                    const matchesYear = !selectedYear || item.year === parseInt(selectedYear);
                    const matchesTopic = !selectedTopic || item.topic === selectedTopic;
                    return matchesSubject && matchesYear && matchesTopic;
                });
                renderMaterials(tab, filteredMaterials[tab]);
            }
        }

        function updateFilterOptions() {
            const allSubjects = new Set();
            const allYears = new Set();
            const allTopics = new Set();

            for (const tab in allMaterials) {
                allMaterials[tab].forEach(item => {
                    if (item.subject) allSubjects.add(item.subject);
                    if (item.year) allYears.add(item.year);
                    if (item.topic) allTopics.add(item.topic);
                });
            }

            // Populate subject filter
            const currentSubject = subjectFilter.value;
            subjectFilter.innerHTML = '<option value="">All Subjects</option>';
            Array.from(allSubjects).sort().forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectFilter.appendChild(option);
            });
            subjectFilter.value = currentSubject;

            // Populate year filter
            const currentYear = yearFilter.value;
            yearFilter.innerHTML = '<option value="">All Years</option>';
            Array.from(allYears).sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
            yearFilter.value = currentYear;

            // Populate topic filter
            const currentTopic = topicFilter.value;
            topicFilter.innerHTML = '<option value="">All Topics</option>';
            Array.from(allTopics).sort().forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicFilter.appendChild(option);
            });
            topicFilter.value = currentTopic;
        }

        function renderMaterials(tabId, materials) {
            const listEl = lists[tabId];
            if (!listEl) return;
            listEl.innerHTML = '';
            
            // Re-render finder sidebar list for the current active tab
            if (tabId === currentTab) {
                finderList.innerHTML = '';
            }

            if (materials.length === 0) {
                listEl.innerHTML = `<p style="color:var(--text-secondary); text-align:center;">No materials found for this section.</p>`;
                return;
            }

            materials.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                const isPurchased = purchasedItems.includes(item.id);
                const isAssignment = item.path && item.path.includes('assignments');
                const isLocked = item.isPaid && !isPurchased;
                const card = createMaterialCard(item, tabId, isLocked, isAssignment);
                listEl.appendChild(card);
                
                // Add to finder sidebar list
                if (tabId === currentTab) {
                    const finderItem = createFinderItem(item);
                    finderList.appendChild(finderItem);
                }
            });
        }
        
        function createFinderItem(item) {
            const li = document.createElement('li');
            li.className = 'finder-item';
            li.textContent = item.name;
            li.dataset.id = item.id;
            li.onclick = () => {
                // Scroll to the card
                const card = document.querySelector(`.item-card[data-id="${item.id}"]`);
                if (card) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Briefly highlight the card
                    card.style.transition = 'none';
                    card.style.backgroundColor = '#444';
                    setTimeout(() => {
                        card.style.transition = 'background-color 0.3s';
                        card.style.backgroundColor = '';
                    }, 500);
                }
            };
            return li;
        }

        function createMaterialCard(item, tabId, isLocked, isAssignment) {
            const card = document.createElement('li');
            card.className = 'item-card';
            card.dataset.id = item.id;
            card.dataset.tabId = tabId;
            card.dataset.name = item.name;

            if (isTeacher) {
                card.draggable = true;
                addDragEvents(card);
            }

            let actionsHtml = `<button class="preview-btn">Preview</button>`;
            if (item.isPaid && !isAssignment) {
                actionsHtml += `<button class="purchase-btn">${isLocked ? 'Purchase' : 'Purchased'}</button>`;
            }
            if (isTeacher) {
                actionsHtml += `<button class="edit-btn">Edit</button>`;
                actionsHtml += `<button class="delete-btn">Delete</button>`;
                if (item.path) {
                    actionsHtml += `<button class="move-btn">Move</button>`;
                }
            }
            
            card.innerHTML = `
                <div class="item-info">
                    <h4>${item.name}</h4>
                    <p>${item.description || 'No description provided.'}</p>
                </div>
                <div class="item-meta">
                    ${item.subject ? `<span>Subject: ${item.subject}</span>` : ''}
                    ${item.year ? `<span>Year: ${item.year}</span>` : ''}
                    ${item.topic ? `<span>Topic: ${item.topic}</span>` : ''}
                    ${item.isPaid ? `<span>${isLocked ? 'Locked' : 'Unlocked'}</span>` : '<span>Free</span>'}
                </div>
                <div class="item-actions">
                    ${actionsHtml}
                </div>
            `;
            
            // Add event listeners to buttons
            card.querySelector('.preview-btn').onclick = () => previewMaterial(item);
            const purchaseBtn = card.querySelector('.purchase-btn');
            if (purchaseBtn) {
                if (isLocked) {
                    purchaseBtn.onclick = () => handlePurchase(item);
                } else {
                    purchaseBtn.disabled = true;
                }
            }
            const editBtn = card.querySelector('.edit-btn');
            if (editBtn) editBtn.onclick = () => editMaterial(item);
            const deleteBtn = card.querySelector('.delete-btn');
            if (deleteBtn) deleteBtn.onclick = () => deleteMaterial(item);
            const moveBtn = card.querySelector('.move-btn');
            if (moveBtn) moveBtn.onclick = () => moveMaterial(item);

            return card;
        }

        function addDragEvents(card) {
            card.addEventListener('dragstart', (e) => {
                draggedItem = e.target;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedItem.dataset.id);
                setTimeout(() => {
                    draggedItem.classList.add('dragging');
                    // Create a visual placeholder
                    placeholder = document.createElement('li');
                    placeholder.className = 'item-card placeholder';
                    placeholder.style.height = `${draggedItem.offsetHeight}px`;
                    draggedItem.parentNode.insertBefore(placeholder, draggedItem);
                    placeholder.classList.add('visible');
                }, 0);
            });

            card.addEventListener('dragend', () => {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
                if (placeholder) {
                    placeholder.remove();
                    placeholder = null;
                }
                if (dropTargetList) {
                    dropTargetList.classList.remove('drag-over');
                    dropTargetList = null;
                }
            });
        }
        
        // Add drop event listeners to all lists
        Object.values(lists).forEach(listEl => {
            listEl.addEventListener('dragover', (e) => {
                e.preventDefault();
                listEl.classList.add('drag-over');
                dropTargetList = listEl;
                
                // Find the best drop location
                const afterElement = getDragAfterElement(listEl, e.clientY);
                if (placeholder) {
                    if (afterElement == null) {
                        listEl.appendChild(placeholder);
                    } else {
                        listEl.insertBefore(placeholder, afterElement);
                    }
                }
            });
            listEl.addEventListener('dragleave', () => {
                listEl.classList.remove('drag-over');
                if (placeholder) {
                    placeholder.classList.remove('visible');
                }
            });
            listEl.addEventListener('drop', (e) => {
                e.preventDefault();
                listEl.classList.remove('drag-over');
                if (!draggedItem) return;
                
                const dragId = draggedItem.dataset.id;
                const sourceTab = draggedItem.dataset.tabId;
                const destinationTab = listEl.id.replace('List', '');
                
                // Get the old and new positions
                const siblings = Array.from(listEl.children).filter(el => el.dataset.id !== dragId);
                const newIndex = siblings.indexOf(placeholder);

                // Perform the move logic
                if (sourceTab === destinationTab) {
                    // Reorder within the same collection
                    const oldIndex = allMaterials[sourceTab].findIndex(item => item.id === dragId);
                    if (oldIndex !== newIndex) {
                         const itemToMove = allMaterials[sourceTab].splice(oldIndex, 1)[0];
                         allMaterials[sourceTab].splice(newIndex, 0, itemToMove);
                         showModal('Reorder Success', 'Material reordered successfully.');
                    }
                } else {
                    // Move to a different collection
                    const itemToMove = allMaterials[sourceTab].find(item => item.id === dragId);
                    if (itemToMove) {
                        moveMaterialToCollection(itemToMove, sourceTab, destinationTab);
                    }
                }
                
                if (placeholder) {
                    placeholder.remove();
                    placeholder = null;
                }
                draggedItem.classList.remove('dragging');
                draggedItem = null;
                applyFiltersAndRender();
            });
        });

        // Helper function for drag-and-drop
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.item-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- CRUD Functions ---
        let currentCrudItem = null;
        function showCrudModal(item = null) {
            currentCrudItem = item;
            crudModalTitle.textContent = item ? 'Edit Material' : 'Add New Material';
            crudForm.reset();
            
            // Show promo code field only for exercises
            const exercisesTab = document.querySelector('.tab-button[data-tab-id="exercises"]');
            if (exercisesTab.classList.contains('active')) {
                promoCodeContainer.style.display = 'block';
            } else {
                promoCodeContainer.style.display = 'none';
            }

            if (item) {
                materialNameInput.value = item.name || '';
                materialSubjectInput.value = item.subject || '';
                materialYearInput.value = item.year || '';
                materialTopicInput.value = item.topic || '';
                materialUrlInput.value = item.url || '';
                if (materialPromoCodeInput) {
                    materialPromoCodeInput.value = item.promoCode || '';
                }
            }
            crudModal.style.display = 'flex';
        }

        crudForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: materialNameInput.value,
                subject: materialSubjectInput.value,
                year: parseInt(materialYearInput.value) || null,
                topic: materialTopicInput.value || null,
                url: materialUrlInput.value || null,
                promoCode: materialPromoCodeInput ? materialPromoCodeInput.value : null
            };
            
            const collectionName = materialsCollections[currentTab];
            const collectionRef = collection(db, `/artifacts/${appId}/public/data/${collectionName}`);
            
            try {
                if (currentCrudItem) {
                    // Update existing document
                    const docRef = doc(db, collectionRef.path, currentCrudItem.id);
                    await updateDoc(docRef, data);
                    showModal('Update Success', 'Material updated successfully.');
                } else {
                    // Add new document
                    await addDoc(collectionRef, data);
                    showModal('Add Success', 'New material added successfully.');
                }
                crudModal.style.display = 'none';
            } catch (error) {
                console.error("CRUD operation failed:", error);
                showModal('Error', `Operation failed: ${error.message}`);
            }
        });
        
        document.getElementById('cancelCrud').onclick = () => {
            crudModal.style.display = 'none';
        };

        function editMaterial(item) {
            showCrudModal(item);
        }

        async function deleteMaterial(item) {
            if (confirm(`Are you sure you want to delete "${item.name}"?`)) {
                try {
                    const collectionName = materialsCollections[currentTab];
                    const docRef = doc(db, `/artifacts/${appId}/public/data/${collectionName}/${item.id}`);
                    await deleteDoc(docRef);
                    showModal('Delete Success', 'Material deleted successfully.');
                } catch (error) {
                    console.error("Delete failed:", error);
                    showModal('Error', `Delete failed: ${error.message}`);
                }
            }
        }
        
        async function moveMaterialToCollection(item, sourceTab, destinationTab) {
            try {
                const sourceCollectionRef = collection(db, `/artifacts/${appId}/public/data/${materialsCollections[sourceTab]}`);
                const destinationCollectionRef = collection(db, `/artifacts/${appId}/public/data/${materialsCollections[destinationTab]}`);
                
                const itemRef = doc(sourceCollectionRef, item.id);
                const newDocRef = doc(destinationCollectionRef);
                
                await runTransaction(db, async (transaction) => {
                    const itemDoc = await transaction.get(itemRef);
                    if (!itemDoc.exists()) {
                        throw "Document does not exist!";
                    }
                    const data = itemDoc.data();
                    transaction.set(newDocRef, data);
                    transaction.delete(itemRef);
                });
                
                showModal('Move Success', `Material moved from ${sourceTab} to ${destinationTab}.`);
            } catch (error) {
                console.error("Move failed:", error);
                showModal('Error', `Move failed: ${error.message}`);
            }
        }

        function moveMaterial(item) {
            let otherTabs = Object.keys(materialsCollections).filter(tab => tab !== currentTab);
            const buttonsHtml = otherTabs.map(tab => 
                `<button class="btn" onclick="performMove('${item.id}', '${tab}')">${tab.charAt(0).toUpperCase() + tab.slice(1)}</button>`
            ).join('');
            
            showModal('Move Material', `Select a new location for "${item.name}":<br><br>${buttonsHtml}`);
        }
        
        window.performMove = async (itemId, destinationTab) => {
            const itemToMove = allMaterials[currentTab].find(item => item.id === itemId);
            if (itemToMove) {
                await moveMaterialToCollection(itemToMove, currentTab, destinationTab);
            }
            messageModal.style.display = 'none';
        };

        // --- Stripe & Purchase Logic ---
        async function handlePurchase(item) {
            modalTitle.textContent = 'Purchase Exercise';
            modalMessage.textContent = `Are you sure you want to purchase "${item.name}"? Price: $${item.price}.`;
            modalForm.style.display = 'block';
            modalButtons.innerHTML = '';

            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'btn btn-primary';
            confirmBtn.textContent = 'Confirm Purchase';
            confirmBtn.onclick = () => redirectToStripe(item);
            modalButtons.appendChild(confirmBtn);

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn logout-btn';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => messageModal.style.display = 'none';
            modalButtons.appendChild(cancelBtn);

            messageModal.style.display = 'flex';
        }

        async function redirectToStripe(item) {
            const promoCode = modalInput.value;
            const docRef = await addDoc(collection(db, `checkout_sessions`), {
                priceId: item.stripePriceId, // Assuming item has a Stripe price ID
                success_url: window.location.href,
                cancel_url: window.location.href,
                metadata: { itemId: item.id },
                promo_code: promoCode || null
            });
            onSnapshot(docRef, async (snap) => {
                const { error, url } = snap.data();
                if (error) {
                    showModal('Stripe Error', `Checkout failed: ${error.message}`);
                } else if (url) {
                    window.location.assign(url);
                }
            });
        }
        
        async function checkStripeStatus() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            if (sessionId) {
                try {
                    const docRef = doc(db, `/artifacts/${appId}/public/data/checkout_sessions/${sessionId}`);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists() && docSnap.data().payment_status === 'paid') {
                        const { itemId } = docSnap.data().metadata;
                        await runTransaction(db, async (transaction) => {
                            const userRef = doc(db, `/artifacts/${appId}/users/${userId}`);
                            const userDoc = await transaction.get(userRef);
                            if (userDoc.exists()) {
                                const newPurchasedItems = [...(userDoc.data().purchasedItems || []), itemId];
                                transaction.update(userRef, { purchasedItems: newPurchasedItems });
                            }
                        });
                        showModal('Purchase Successful', 'Thank you for your purchase!');
                        purchasedItems.push(itemId);
                        applyFiltersAndRender();
                    }
                } catch (error) {
                    console.error('Stripe status check failed:', error);
                }
            }
        }

        // --- UI & Event Listeners ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tabId;
                switchTab(tabId);
            });
        });

        function switchTab(tabId) {
            document.querySelector('.tab-button.active').classList.remove('active');
            document.querySelector(`.tab-button[data-tab-id="${tabId}"]`).classList.add('active');
            document.querySelector('.tab-content.active').classList.remove('active');
            document.getElementById(`${tabId}Tab`).classList.add('active');
            currentTab = tabId;
            applyFiltersAndRender();
        }

        listModeToggle.addEventListener('click', () => {
            const list = document.getElementById(`${currentTab}List`);
            list.classList.toggle('list-mode');
            listModeToggle.textContent = list.classList.contains('list-mode') ? 'Grid' : 'List';
        });

        subjectFilter.addEventListener('change', applyFiltersAndRender);
        yearFilter.addEventListener('change', applyFiltersAndRender);
        topicFilter.addEventListener('change', applyFiltersAndRender);
        addMaterialButton.addEventListener('click', () => showCrudModal());

        // --- Modals ---
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            modalForm.style.display = 'none';
            modalButtons.innerHTML = '';
            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn';
            closeBtn.textContent = 'Close';
            closeBtn.onclick = () => messageModal.style.display = 'none';
            modalButtons.appendChild(closeBtn);
            messageModal.style.display = 'flex';
        }

        function showFullPreviewModal(item) {
            fullPreviewTitle.textContent = item.name;
            const fileUrl = item.url;
            fullPreviewImage.style.display = 'none';
            fullPreviewVideo.style.display = 'none';
            pdfViewer.style.display = 'none';

            if (!fileUrl) {
                showModal('Preview Error', 'No file URL provided for this item.');
                return;
            }

            const fileExtension = fileUrl.split('.').pop().toLowerCase();

            if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
                fullPreviewImage.src = fileUrl;
                fullPreviewImage.style.display = 'block';
            } else if (['mp4', 'webm', 'ogg'].includes(fileExtension)) {
                fullPreviewVideo.src = fileUrl;
                fullPreviewVideo.style.display = 'block';
            } else if (fileExtension === 'pdf') {
                pdfViewer.style.display = 'block';
                loadPdf(fileUrl);
            } else {
                showModal('Unsupported Format', 'This file type cannot be previewed.');
                return;
            }
            fullPreviewModal.style.display = 'flex';
        }

        // Event listeners for preview buttons
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('preview-btn')) {
                const card = e.target.closest('.item-card');
                const tabId = card.dataset.tabId;
                const itemId = card.dataset.id;
                const item = allMaterials[tabId].find(i => i.id === itemId);
                if (item) {
                    showFullPreviewModal(item);
                }
            }
        });
        
        document.querySelectorAll('.modal .close-button').forEach(btn => btn.onclick = () => {
            const modal = btn.closest('.modal');
            modal.style.display = 'none';
        });
        
        // --- PDF Viewer Functions ---
        function loadPdf(url) {
            pdfjsLib.getDocument(url).promise.then(pdf => {
                pdfDoc = pdf;
                pageCountSpan.textContent = pdf.numPages;
                pageNum = 1;
                renderPage(pageNum);
                updatePdfNavButtons();
            }).catch(error => {
                console.error('Error loading PDF:', error);
                showModal('PDF Error', `Failed to load PDF file: ${error.message}`);
            });
        }

        function renderPage(num) {
            pageRendering = true;
            pageNumSpan.textContent = num;
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale: 1.5 });
                const scaledViewport = viewport.clone({ scale: Math.min(1, maxPdfWidth / viewport.width) });
                pdfCanvas.width = scaledViewport.width;
                pdfCanvas.height = scaledViewport.height;

                const renderContext = {
                    canvasContext: pdfContext,
                    viewport: scaledViewport
                };
                const renderTask = page.render(renderContext);

                renderTask.promise.then(() => {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                    updatePdfNavButtons();
                });
            }).catch(error => {
                console.error('Error rendering PDF page:', error);
                showModal('PDF Render Error', `Failed to render page ${num}: ${error.message}`);
                pageRendering = false;
                pageNumPending = null;
                updatePdfNavButtons();
            });
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function updatePdfNavButtons() {
            prevPdfPageBtn.disabled = pageNum <= 1;
            nextPdfPageBtn.disabled = pageNum >= pdfDoc.numPages;
        }

        prevPdfPageBtn.onclick = () => {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        };

        nextPdfPageBtn.onclick = () => {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        };
        
        // --- THEME TOGGLE ---\n
        function applyTheme(theme) {
            document.body.classList.toggle('light-theme', theme === 'light');
        }
        function loadTheme() {
            const savedTheme = localStorage.getItem('ai-marker-theme') || 'dark';
            applyTheme(savedTheme);
        }
        if (themeToggleButton) {
            themeToggleButton.addEventListener('click', () => {
                const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';
                applyTheme(newTheme);
                localStorage.setItem('ai-marker-theme', newTheme);
            });
        }
        loadTheme();

        // --- Authentication & Initialization ---
        async function authenticateAndLoad() {
            try {
                // Sign in with custom token if provided, otherwise anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showModal('Authentication Error', `Could not sign in: ${error.message}`);
            }
        }
        
        // This is the login gate. It's commented out as requested.
        // Uncomment the lines below to re-enable the login requirement.
        // onAuthStateChanged(auth, user => {
        //     if (user) {
        //         userId = user.uid;
        //         fetchInitialData();
        //     } else {
        //         // This is where you would show the login/signup UI
        //         showModal('Login Required', 'Please log in to view materials.');
        //     }
        // });

        // Direct load for testing purposes
        window.addEventListener('load', () => {
            authenticateAndLoad().then(() => {
                userId = auth.currentUser.uid;
                fetchInitialData();
            });
        });
        
    </script>
</body>
</html>
