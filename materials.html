<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Marker - Materials</title>
    <!-- PDF.js library for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { color-scheme: light dark; }
        html { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
        
        /* Custom styles for components */
        .modal { display: none; }
        .modal.flex { display: flex; }
        
        .nested-container {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 0;
        }
        .nested-container.expanded {
            max-height: 1000px; /* Adjust as needed */
        }
        .collapse-arrow { transition: transform 0.3s ease-out; }
        [aria-expanded="true"] .collapse-arrow { transform: rotate(90deg); }
        [aria-expanded="false"] .collapse-arrow { transform: rotate(0deg); }

        .dropdown-menu:hover .dropdown-menu-content {
            display: block;
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-neutral-950 dark:text-neutral-100">

    <div id="authWrapper" class="fixed inset-0 z-[1001] bg-gray-100 dark:bg-neutral-900 items-center justify-center p-4 transition-opacity duration-500 ease-in-out opacity-0" style="display: none;">
        <div class="w-full max-w-4xl mx-auto grid md:grid-cols-2 rounded-2xl shadow-2xl overflow-hidden">
             <div class="p-8 md:p-12 bg-white dark:bg-neutral-950 flex flex-col items-center justify-center text-center">
                <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-gray-900 dark:text-white">AI Marker</h1>
                <p class="mt-4 text-gray-600 dark:text-neutral-300">Your personal DSE assistant.</p>
            </div>
            <div class="p-8 md:p-12 bg-gray-50 dark:bg-neutral-900 flex flex-col justify-center">
                <div id="authContainer" class="w-full max-w-sm mx-auto">
                    <!-- JS will inject googleSignInTemplate or codeEntryTemplate -->
                </div>
            </div>
        </div>
    </div>

    <div id="appSection" class="hidden flex-col h-screen">
        <header class="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/70 bg-white/90 dark:bg-neutral-900/80 border-b border-gray-200 dark:border-neutral-800">
            <div class="max-w-screen-xl mx-auto px-4">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <a href="index.html" class="flex items-center gap-2 mr-2 select-none">
                             <div class="h-8 w-8 grid place-content-center rounded-lg bg-gradient-to-br from-blue-500 via-sky-500 to-cyan-400 text-white font-black">A</div>
                             <span class="text-lg font-semibold tracking-tight">AI Marker</span>
                        </a>
                    </div>
                    <nav class="hidden md:flex items-center gap-1">
                        <a href="index.html" class="tab px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10">Home</a>
                         <div class="relative dropdown-menu">
                            <button class="tab px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10 flex items-center gap-1">Work with AI &#9662;</button>
                            <div class="dropdown-menu-content absolute mt-2 w-48 bg-white dark:bg-neutral-900 border border-gray-200 dark:border-neutral-700 rounded-xl shadow-lg p-1 hidden">
                                <a href="grading.html" class="block w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10">Exam Grader</a>
                                <a href="chat.html" class="block w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10">Chat with Gemini</a>
                            </div>
                        </div>
                        <div class="relative dropdown-menu">
                            <button id="materialsButton" class="tab px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10 flex items-center gap-1 ring-2 ring-blue-500">Materials &#9662;</button>
                            <div class="dropdown-menu-content absolute mt-2 w-48 bg-white dark:bg-neutral-900 border border-gray-200 dark:border-neutral-700 rounded-xl shadow-lg p-1 hidden">
                                <button id="toggleTutorialButton" class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10">Tutorial Videos</button>
                                <button id="togglePastPapersButton" class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10">Past Papers</button>
                                <button id="toggleExercisesButton" class="w-full text-left px-3 py-2 text-sm rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10">Exercises for Sale</button>
                            </div>
                        </div>
                        <a href="submissions.html" id="toggleSubmissionsButton" class="tab px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10" style="display: none;">Submissions</a>
                        <a href="manage_students.html" id="manageStudentsButton" class="tab px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10" style="display: none;">Manage Students</a>
                        <a href="profile.html" id="toggleProfileButton" class="tab px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10">Profile</a>
                        <button id="themeToggleButton" class="tab px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10">Theme</button>
                    </nav>
                    <div class="flex items-center gap-2">
                         <div id="userDisplayName" class="text-sm font-medium hidden sm:block"></div>
                         <button id="switchRoleButton" class="px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10 border border-gray-300 dark:border-neutral-700">Switch Role</button>
                         <button id="logoutButton" class="px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10 border border-gray-300 dark:border-neutral-700">Log Out</button>
                    </div>
                </div>
            </div>
        </header>
        
        <main class="flex-1 overflow-y-auto p-4 md:p-8">
            <div class="max-w-screen-xl mx-auto">
                <!-- Generic Material Section Template -->
                <div id="tutorialSection"></div>
                <div id="pastPapersSection"></div>
                <div id="exerciseSection"></div>
            </div>
        </main>
    </div>

     <!-- Finder Style Materials Section (Desktop Only) -->
    <div id="finderMaterialsSection" class="finder-window-wrapper fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90vw] h-[90vh] max-w-[1200px] max-h-[800px] border border-neutral-300 dark:border-neutral-800 rounded-xl bg-gray-50 dark:bg-neutral-950 overflow-hidden flex flex-col shadow-2xl resize z-[100]" style="display:none;">
        <div class="finder-titlebar bg-gray-100 dark:bg-neutral-900 h-9 flex items-center px-3 cursor-grab flex-shrink-0 border-b border-gray-200 dark:border-neutral-800 justify-between" id="finderDragBar">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-red-500 close-button"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                <div class="w-3 h-3 rounded-full bg-green-500" id="finderFullscreenToggle"></div>
            </div>
            <span class="text-sm font-medium">Materials</span>
            <div class="w-16"></div> <!-- Spacer -->
        </div>

        <div class="finder-content flex-1 flex overflow-hidden">
            <aside class="finder-sidebar w-56 min-w-[180px] border-r border-gray-200 dark:border-neutral-800 bg-white dark:bg-neutral-900/50 p-2 overflow-y-auto flex-shrink-0" id="finderSidebar">
                <!-- Level 1 items (Subjects) will be loaded here -->
            </aside>
            <section class="finder-file-list flex-1 flex flex-col overflow-y-auto">
                <div class="columns grid grid-cols-[3fr,1fr,1fr,1fr] p-3 border-b border-gray-200 dark:border-neutral-800 bg-gray-50/80 dark:bg-neutral-900/60">
                    <div class="text-xs font-semibold uppercase text-gray-500 dark:text-neutral-400">Name</div>
                    <div class="text-xs font-semibold uppercase text-gray-500 dark:text-neutral-400">Size</div>
                    <div class="text-xs font-semibold uppercase text-gray-500 dark:text-neutral-400">Kind</div>
                    <div class="text-xs font-semibold uppercase text-gray-500 dark:text-neutral-400">Date Added</div>
                </div>
                <div id="finderFileListContent" class="flex-1 p-2">
                    <p class="text-center p-8 text-gray-500 dark:text-neutral-400">Select a subject from the sidebar.</p>
                </div>
            </section>
        </div>
    </div>


    <!-- Universal Modal -->
    <div id="messageModal" class="modal fixed inset-0 z-[1001] bg-black/60 items-center justify-center p-4">
        <div class="modal-content bg-white dark:bg-neutral-900 p-6 rounded-2xl shadow-xl w-full max-w-md relative animate-slide-in">
            <button class="close-button absolute top-3 right-3 p-1 rounded-full hover:bg-gray-900/5 dark:hover:bg-white/10">&times;</button>
            <h3 id="modalTitle" class="text-lg font-semibold"></h3>
            <div id="modalMessage" class="mt-2 text-sm text-gray-600 dark:text-neutral-300"></div>
            <div id="modalButtons" class="flex justify-end gap-2 mt-6"></div>
        </div>
    </div>
    
    <!-- Modals for adding content -->
    <div id="addVideoModal" class="modal fixed inset-0 z-[1001] bg-black/60 items-center justify-center p-4">
        <form id="addVideoForm" class="bg-white dark:bg-neutral-900 p-6 rounded-2xl shadow-xl w-full max-w-lg relative">
             <button type="button" class="close-button absolute top-3 right-3 p-1 rounded-full hover:bg-gray-900/5 dark:hover:bg-white/10">&times;</button>
             <h3 class="text-lg font-semibold mb-4">Add New Tutorial Video</h3>
             <input type="hidden" id="videoParentId1"><input type="hidden" id="videoParentId2">
             <div class="space-y-4">
                 <div>
                     <label for="tutorialLink" class="text-sm font-medium text-gray-700 dark:text-neutral-300">YouTube Link or Embed Code</label>
                     <textarea id="tutorialLink" required placeholder="Paste a YouTube URL or an <iframe> embed code here..." class="mt-1 block w-full rounded-xl border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:ring-blue-500 focus:border-blue-500"></textarea>
                     <img id="tutorialThumbnailPreview" class="max-w-[200px] mt-2 rounded-lg" style="display:none;" alt="Video Thumbnail Preview"/>
                 </div>
                 <div>
                     <label for="tutorialTitle" class="text-sm font-medium text-gray-700 dark:text-neutral-300">Video Title</label>
                     <input type="text" id="tutorialTitle" required class="mt-1 block w-full rounded-xl border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:ring-blue-500 focus:border-blue-500">
                 </div>
             </div>
             <div class="flex justify-end gap-2 mt-6">
                <button type="submit" class="px-4 py-2 text-sm font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700">Add Video</button>
             </div>
        </form>
    </div>

    <div id="addPastPaperModal" class="modal fixed inset-0 z-[1001] bg-black/60 items-center justify-center p-4">
        <form id="addPastPaperForm" class="bg-white dark:bg-neutral-900 p-6 rounded-2xl shadow-xl w-full max-w-lg relative">
             <button type="button" class="close-button absolute top-3 right-3 p-1 rounded-full hover:bg-gray-900/5 dark:hover:bg-white/10">&times;</button>
             <h3 class="text-lg font-semibold mb-4">Add New Past Paper</h3>
             <input type="hidden" id="paperParentId1"><input type="hidden" id="paperParentId2">
             <div class="space-y-4">
                 <div>
                     <label for="pastPaperName" class="text-sm font-medium text-gray-700 dark:text-neutral-300">Paper Name / Title</label>
                     <input type="text" id="pastPaperName" required placeholder="e.g., Paper 1 Section A" class="mt-1 block w-full rounded-xl border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:ring-blue-500 focus:border-blue-500">
                 </div>
                 <div>
                    <label class="text-sm font-medium text-gray-700 dark:text-neutral-300">Upload File (PDF only)</label>
                    <div id="pastPaperDropZone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 dark:border-neutral-700 border-dashed rounded-xl cursor-pointer hover:border-blue-500 dark:hover:border-blue-500">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <div class="flex text-sm text-gray-600 dark:text-neutral-400"><p class="pl-1">Drag & Drop PDF Here, or click to select</p></div>
                             <input type="file" id="pastPaperFile" accept="application/pdf" class="sr-only">
                        </div>
                    </div>
                    <span id="pastPaperFileName" class="text-xs text-gray-500 dark:text-neutral-400 mt-1">No file chosen</span>
                </div>
                <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300 dark:border-neutral-700"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-white dark:bg-neutral-900 text-gray-500 dark:text-neutral-400">OR</span></div></div>
                <div>
                    <label for="pastPaperLink" class="text-sm font-medium text-gray-700 dark:text-neutral-300">Paste External Link</label>
                    <input type="url" id="pastPaperLink" placeholder="https://..." class="mt-1 block w-full rounded-xl border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:ring-blue-500 focus:border-blue-500">
                </div>
             </div>
             <div class="flex justify-end gap-2 mt-6">
                <button type="submit" class="px-4 py-2 text-sm font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700">Add Paper</button>
             </div>
        </form>
    </div>

    <div id="editPastPaperModal" class="modal fixed inset-0 z-[1001] bg-black/60 items-center justify-center p-4">
        <form id="editPastPaperForm" class="bg-white dark:bg-neutral-900 p-6 rounded-2xl shadow-xl w-full max-w-lg relative">
            <button type="button" class="close-button absolute top-3 right-3 p-1 rounded-full hover:bg-gray-900/5 dark:hover:bg-white/10">&times;</button>
            <h3 class="text-lg font-semibold mb-4">Edit Past Paper</h3>
            <input type="hidden" id="editPaperId"><input type="hidden" id="editPaperParentId1"><input type="hidden" id="editPaperParentId2">
            <div class="space-y-4">
                <div>
                    <label for="editPastPaperName" class="text-sm font-medium text-gray-700 dark:text-neutral-300">Paper Name / Title</label>
                    <input type="text" id="editPastPaperName" required class="mt-1 block w-full rounded-xl border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="editPastPaperLink" class="text-sm font-medium text-gray-700 dark:text-neutral-300">Download Link</label>
                    <input type="url" id="editPastPaperLink" required class="mt-1 block w-full rounded-xl border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button type="button" class="close-button px-4 py-2 text-sm font-semibold rounded-xl hover:bg-gray-900/5 dark:hover:bg-white/10">Cancel</button>
                <button type="submit" class="px-4 py-2 text-sm font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700">Save Changes</button>
            </div>
        </form>
    </div>

    <div id="addExerciseModal" class="modal fixed inset-0 z-[1001] bg-black/60 items-center justify-center p-4">
        <form id="addExerciseForm" class="bg-white dark:bg-neutral-900 p-6 rounded-2xl shadow-xl w-full max-w-lg relative">
             <button type="button" class="close-button absolute top-3 right-3 p-1 rounded-full hover:bg-gray-900/5 dark:hover:bg-white/10">&times;</button>
             <h3 class="text-lg font-semibold mb-4">Add New Exercise</h3>
             <input type="hidden" id="exerciseParentId1"><input type="hidden" id="exerciseParentId2">
             <div class="space-y-4">
                 <div>
                     <label for="exerciseName" class="text-sm font-medium text-gray-700 dark:text-neutral-300">Exercise Name / Title</label>
                     <input type="text" id="exerciseName" required placeholder="e.g., Chapter 1 MCQs" class="mt-1 block w-full rounded-xl border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:ring-blue-500 focus:border-blue-500">
                 </div>
                 <div>
                     <label for="exercisePrice" class="text-sm font-medium text-gray-700 dark:text-neutral-300">Price (USD)</label>
                     <input type="number" id="exercisePrice" required placeholder="e.g., 10.00" step="0.01" min="0" class="mt-1 block w-full rounded-xl border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:ring-blue-500 focus:border-blue-500">
                 </div>
                 <div>
                    <label class="text-sm font-medium text-gray-700 dark:text-neutral-300">Upload File (PDF only)</label>
                    <div id="exerciseDropZone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 dark:border-neutral-700 border-dashed rounded-xl cursor-pointer hover:border-blue-500 dark:hover:border-blue-500">
                        <div class="space-y-1 text-center">
                           <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                           <div class="flex text-sm text-gray-600 dark:text-neutral-400"><p class="pl-1">Drag & Drop PDF Here, or click to select</p></div>
                            <input type="file" id="exerciseFile" accept="application/pdf" class="sr-only">
                        </div>
                    </div>
                    <span id="exerciseFileName" class="text-xs text-gray-500 dark:text-neutral-400 mt-1">No file chosen</span>
                </div>
                 <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300 dark:border-neutral-700"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-white dark:bg-neutral-900 text-gray-500 dark:text-neutral-400">OR</span></div></div>
                <div>
                    <label for="exerciseLink" class="text-sm font-medium text-gray-700 dark:text-neutral-300">Paste External Link</label>
                    <input type="url" id="exerciseLink" placeholder="https://..." class="mt-1 block w-full rounded-xl border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:ring-blue-500 focus:border-blue-500">
                </div>
             </div>
             <div class="flex justify-end gap-2 mt-6">
                <button type="submit" class="px-4 py-2 text-sm font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700">Add Exercise</button>
             </div>
        </form>
    </div>

    <!-- Video Preview Modal -->
    <div id="videoPreviewModal" class="modal fixed inset-0 z-[1001] bg-black/60 items-center justify-center p-4">
        <div class="modal-content w-full max-w-6xl h-[80vh] flex flex-row p-0 overflow-hidden">
            <div class="video-player-container flex-[3] bg-black flex justify-center items-center relative" id="videoPreviewContent">
                <!-- Iframe will be injected here -->
            </div>
            <div class="video-progress-sidebar flex-1 p-6 bg-white dark:bg-neutral-900 flex flex-col border-l border-gray-200 dark:border-neutral-800 relative">
                <button class="close-button absolute top-3 right-3 p-1 rounded-full hover:bg-gray-900/5 dark:hover:bg-white/10">&times;</button>
                <h3 id="videoPreviewTitle" class="text-xl font-semibold mb-4 pb-4 border-b border-gray-200 dark:border-neutral-800"></h3>
                <p class="text-sm text-gray-600 dark:text-neutral-300 mb-6">Track your learning progress for this video.</p>
                <p class="text-sm">Status: <span id="videoCompletionStatus" class="font-bold text-red-600 dark:text-red-500">Not Watched</span></p>
                <button id="markVideoCompleteBtn" class="mt-auto w-full px-4 py-2 text-sm font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50">Mark as Complete</button>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" class="modal fixed inset-0 z-[1001] bg-black/60 items-center justify-center p-4">
        <div class="modal-content w-full max-w-4xl h-[90vh] flex flex-col p-4">
            <div class="flex justify-between items-center mb-2 flex-shrink-0">
                 <h3 id="pdfPreviewTitle" class="text-lg font-semibold"></h3>
                 <button class="close-button p-1 rounded-full hover:bg-gray-900/5 dark:hover:bg-white/10">&times;</button>
            </div>
            <div id="pdfCanvasContainer" class="flex-1 overflow-auto bg-gray-100 dark:bg-neutral-800 rounded-lg flex justify-center p-2">
                <canvas id="pdfCanvas"></canvas>
            </div>
            <div id="pdfControls" class="flex justify-center items-center gap-4 mt-2 flex-shrink-0">
                <button id="prevPdfPage" class="px-3 py-1.5 text-sm font-medium rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10 disabled:opacity-50">Previous</button>
                <span class="text-sm">Page <span id="pdfPageNum">0</span> / <span id="pdfTotalPages">0</span></span>
                <button id="nextPdfPage" class="px-3 py-1.5 text-sm font-medium rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10 disabled:opacity-50">Next</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, where, onSnapshot, writeBatch, collectionGroup } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";

        // --- IMPORTANT CONFIGURATION ---
        const STRIPE_PAYMENT_LINK = "https://buy.stripe.com/14A28t1kAfr2gnx04L0ZW0n"; 

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
          authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30",
          storageBucket: "ai-grading-9bb30.appspot.com",
          messagingSenderId: "298162112230",
          appId: "1:298162112230:web:529d3f95536991be685d27",
          measurementId: "G-CHKLKSM17S"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const TEACHER_CODE = "Derren0625";
        const STUDENT_CODE = "STUDENT456";

        pdfjsLib.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let app, db, auth, storage;
        let currentUserId = null, currentUserEmail = null, currentUserRole = null, currentUserName = null;
        let shoppingCart = [];
        let appliedPromoCode = null;
        
        // --- AUTH & INITIALIZATION ---
        
        const authWrapper = document.getElementById('authWrapper');
        const appSection = document.getElementById('appSection');
        const authContainer = document.getElementById('authContainer');

        const googleSignInTemplate = `
            <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-white">Sign In</h2>
            <p class="text-center text-sm text-gray-600 dark:text-neutral-400 mt-2 mb-6">Please sign in to access your materials.</p>
            <button id="googleSignInButton" class="w-full flex items-center justify-center gap-3 py-2.5 px-4 rounded-xl border border-gray-300 dark:border-neutral-700 hover:bg-gray-50 dark:hover:bg-neutral-800/50 font-medium">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="h-5 w-5">
                <span>Sign in with Google</span>
            </button>
            <p id="authError" class="text-sm text-red-600 text-center mt-4"></p>
        `;

        const codeEntryTemplate = `
            <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-white">Enter Access Code</h2>
            <p class="text-center text-sm text-gray-600 dark:text-neutral-400 mt-2 mb-6">Please enter the access code provided by your administrator.</p>
            <input type="text" id="accessCodeInput" placeholder="Enter code here" class="block w-full text-center rounded-xl border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:ring-blue-500 focus:border-blue-500">
            <button id="submitCodeButton" class="w-full mt-4 px-4 py-2.5 text-sm font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700">Submit Code</button>
            <p id="codeError" class="text-sm text-red-600 text-center mt-4"></p>
        `;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            document.body.innerHTML = '<h1>Error initializing application. Please check console.</h1>';
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                currentUserEmail = user.email;
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                try {
                    const userProfileDoc = await getDoc(userProfileRef);
                    if (userProfileDoc.exists() && userProfileDoc.data().role) {
                        const profileData = userProfileDoc.data();
                        currentUserRole = profileData.role;
                        currentUserName = profileData.name || user.displayName;
                        await setDoc(userProfileRef, { name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                        showApp();
                    } else {
                        currentUserName = user.displayName;
                        currentUserRole = 'unassigned';
                        showCodeEntry();
                    }
                } catch (e) {
                     console.error("Error checking user profile:", e);
                     showLogin();
                }
            } else {
                currentUserId = null;
                currentUserRole = null;
                currentUserName = null;
                showLogin();
            }
        });

        function showLogin() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            setTimeout(() => authWrapper.style.opacity = '1', 10);
            authContainer.innerHTML = googleSignInTemplate;
            document.getElementById('googleSignInButton')?.addEventListener('click', handleGoogleSignIn);
        }

        function showCodeEntry() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authWrapper.style.opacity = '1';
            authContainer.innerHTML = codeEntryTemplate;
            const submitCodeBtn = document.getElementById('submitCodeButton');
            const accessCodeInput = document.getElementById('accessCodeInput');
            submitCodeBtn?.addEventListener('click', () => handleSubmitCode());
            accessCodeInput?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSubmitCode();
                }
            });
            accessCodeInput?.focus();
        }

        async function showApp() {
            authWrapper.style.display = 'none';
            appSection.classList.remove('hidden');
            appSection.classList.add('flex');
            document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
            document.getElementById('manageStudentsButton').style.display = currentUserRole === 'teacher' ? 'inline-flex' : 'none';
            document.getElementById('toggleSubmissionsButton').style.display = 'inline-flex';


            initializeAllMaterialSections();
            await checkForSuccessfulPurchase();

            // Default to the tutorial section on load
            showSection('tutorialSection'); 
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try { 
                await signInWithPopup(auth, provider); 
            } catch (error) { 
                document.getElementById('authError').textContent = `Sign-in failed. Error: ${error.message}`; 
                console.error("Google Sign-In Error:", error);
            }
        }

        async function handleSubmitCode(codeValue) {
            const code = (codeValue || document.getElementById('accessCodeInput').value).trim();
            const codeError = document.getElementById('codeError');
            if(codeError) codeError.textContent = '';
            
            let roleToSet = null;
            if (code === TEACHER_CODE) roleToSet = 'teacher';
            else if (code === STUDENT_CODE) roleToSet = 'student';
            else { 
                if(codeError) codeError.textContent = 'Invalid access code.';
                return; 
            }
            
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await setDoc(userProfileRef, { role: roleToSet, name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                currentUserRole = roleToSet;
                showApp();
            } catch (error) {
                if(codeError) codeError.textContent = `Could not set role. Error: ${error.message}`;
                console.error("Submit Code Error:", error);
            }
        }

        document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));

        // --- NAVIGATION & UI ---

        let currentMaterialViewMode = 'card'; // 'card' or 'finder'

        function showSection(sectionIdToShow) {
            const sections = ['tutorialSection', 'pastPapersSection', 'exerciseSection'];
            
            document.querySelectorAll('#materialsButton, #toggleTutorialButton, #togglePastPapersButton, #toggleExercisesButton').forEach(t => t.classList.remove('bg-gray-900/10', 'dark:bg-white/10'));
            
            document.getElementById('materialsButton').classList.add('bg-gray-900/10', 'dark:bg-white/10');
            if(sectionIdToShow === 'tutorialSection') document.getElementById('toggleTutorialButton').classList.add('bg-gray-900/10', 'dark:bg-white/10');
            if(sectionIdToShow === 'pastPapersSection') document.getElementById('togglePastPapersButton').classList.add('bg-gray-900/10', 'dark:bg-white/10');
            if(sectionIdToShow === 'exerciseSection') document.getElementById('toggleExercisesButton').classList.add('bg-gray-900/10', 'dark:bg-white/10');

            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    const isTarget = id === sectionIdToShow;
                    section.style.display = isTarget ? 'block' : 'none';
                    section.style.opacity = isTarget ? '1' : '0';
                }
            });

            const finderSection = document.getElementById('finderMaterialsSection');
            if (window.innerWidth >= 769) {
                finderSection.style.display = currentMaterialViewMode === 'finder' ? 'flex' : 'none';
                document.getElementById(sectionIdToShow).classList.toggle('hidden', currentMaterialViewMode === 'finder');
            } else {
                finderSection.style.display = 'none';
                document.getElementById(sectionIdToShow).classList.remove('hidden');
            }
        }

        function setupSectionToggle() {
            document.getElementById('toggleTutorialButton')?.addEventListener('click', () => {
                showSection('tutorialSection');
                if (window.innerWidth >= 769 && currentMaterialViewMode === 'finder') showFinderView('tutorials');
                else renderStudentItems('tutorials');
            });
            document.getElementById('togglePastPapersButton')?.addEventListener('click', () => {
                showSection('pastPapersSection');
                if (window.innerWidth >= 769 && currentMaterialViewMode === 'finder') showFinderView('pastPapers');
                else renderStudentItems('pastPapers');
            });
            document.getElementById('toggleExercisesButton')?.addEventListener('click', () => {
                showSection('exerciseSection');
                if (window.innerWidth >= 769 && currentMaterialViewMode === 'finder') showFinderView('exercises');
                else renderStudentItems('exercises');
            });
        }
        setupSectionToggle();
        
        // --- REFACTORED MATERIALS MANAGEMENT ---
        const materialsConfig = {
            tutorials: { sectionId: 'tutorialSection', collectionName: 'tutorials', title: 'Tutorial Videos', level1: 'Subject', level2: 'Topic', level3: 'Video', modalId: 'addVideoModal', isPaid: false },
            pastPapers: { sectionId: 'pastPapersSection', collectionName: 'pastPapers', title: 'Past Papers', level1: 'Subject', level2: 'Year', level3: 'Paper', modalId: 'addPastPaperModal', editModalId: 'editPastPaperModal', isPaid: false },
            exercises: { sectionId: 'exerciseSection', collectionName: 'exercises', title: 'Exercises for Sale', level1: 'Subject', level2: 'Topic', level3: 'Exercise', modalId: 'addExerciseModal', isPaid: true }
        };

        function getPath(type, ids = []) {
            const config = materialsConfig[type];
            const collection = config.collectionName;
            let pathParts = [`artifacts/${appId}/public/data/${collection}`];
            if (ids[0]) pathParts.push(ids[0], config.level2.toLowerCase() + 's');
            if (ids[1]) pathParts.push(ids[1], config.level3.toLowerCase() + 's');
            return pathParts.join('/');
        }

        function initializeAllMaterialSections() {
            for (const type in materialsConfig) {
                setupMaterialSection(type);
            }
            setupFinderWindow();
            setupGoogleDriveLinkConversion();
        }

        function setupMaterialSection(type) {
            const config = materialsConfig[type];
            const section = document.getElementById(config.sectionId);

            let studentViewHtml = `
                <div class="flex items-center gap-4 mb-6 flex-wrap">
                    <select id="level1-${type}-filter" class="w-full sm:w-64 rounded-xl border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 focus:ring-blue-500 focus:border-blue-500"></select>
                    <select id="level2-${type}-filter" class="w-full sm:w-64 rounded-xl border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 focus:ring-blue-500 focus:border-blue-500" disabled></select>
                </div>
                <div id="level3-${type}-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>`;

            if (config.isPaid) {
                studentViewHtml = `
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-8 xl:col-span-9">
                            ${studentViewHtml}
                        </div>
                        <div class="lg:col-span-4 xl:col-span-3">
                            <div class="sticky top-24 p-6 bg-white dark:bg-neutral-900 rounded-2xl border border-gray-200 dark:border-neutral-800 shadow-sm">
                                <h3 class="text-lg font-semibold mb-4 pb-4 border-b border-gray-200 dark:border-neutral-800">Shopping Cart</h3>
                                <div id="cart-items" class="max-h-60 overflow-y-auto space-y-3"></div>
                                <div id="cart-summary" class="mt-4 pt-4 border-t border-gray-200 dark:border-neutral-800 space-y-2 text-sm">
                                    <div class="flex justify-between"><span>Subtotal:</span><span id="cart-subtotal-price">$0.00</span></div>
                                    <div class="flex justify-between" id="promo-discount-line" style="display:none;"><span>Promo Discount:</span><span id="cart-promo-discount">-$0.00</span></div>
                                    <div class="flex justify-between font-bold text-base"><span>Total Price:</span><span id="cart-total-price">$0.00</span></div>
                                </div>
                                <div class="mt-4">
                                    <label for="promoCodeInput" class="text-xs font-medium">Promo Code:</label>
                                    <div class="flex gap-2 mt-1">
                                        <input type="text" id="promoCodeInput" placeholder="Enter code" class="flex-grow block w-full text-sm rounded-xl border-gray-300 dark:border-neutral-700 bg-gray-50 dark:bg-neutral-800 focus:ring-blue-500 focus:border-blue-500">
                                        <button id="applyPromoCodeBtn" class="px-3 py-2 text-sm font-semibold rounded-xl bg-gray-900/5 hover:bg-gray-900/10 dark:bg-white/10 dark:hover:bg-white/20">Apply</button>
                                    </div>
                                    <div id="appliedPromoCodeDisplay" class="text-xs mt-2" style="display:none;"><span>Applied: <span id="appliedPromoCodeText"></span></span><button id="removePromoCodeBtn" class="ml-2 text-red-500 hover:underline">Remove</button></div>
                                    <p id="promoCodeError" class="text-xs text-red-500 mt-1"></p>
                                </div>
                                <p id="cart-validation-message" class="text-xs text-red-500 mt-4"></p>
                                <button id="checkout-btn" class="w-full mt-4 px-4 py-2.5 text-sm font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50">Proceed to Checkout</button>
                            </div>
                        </div>
                    </div>`;
            }

            section.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">${config.title}</h2>
                </div>
                <div id="teacher-${type}-view" style="display:none;">
                    <div class="mb-6 p-4 bg-white dark:bg-neutral-900 rounded-2xl border border-gray-200 dark:border-neutral-800">
                        <button id="add-level1-${type}-btn" class="px-4 py-2 text-sm font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700">Add New ${config.level1}</button>
                    </div>
                    <div id="level1-${type}-container" class="space-y-4"></div>
                    ${type === 'exercises' ? `
                        <div class="mt-8 p-6 bg-white dark:bg-neutral-900 rounded-2xl border border-gray-200 dark:border-neutral-800">
                            <h3 class="text-lg font-semibold mb-4">Promo Code Management</h3>
                            <div class="flex items-end gap-4 mb-4">
                                <div class="flex-grow">
                                    <label for="promoDiscountAmount" class="text-sm font-medium">Discount Amount ($)</label>
                                    <input type="number" id="promoDiscountAmount" placeholder="10.00" step="0.01" min="0" class="mt-1 block w-full rounded-xl border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <button id="generatePromoCodeBtn" class="px-4 py-2 text-sm font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700">Generate</button>
                            </div>
                            <p id="promoCodeGenerationStatus" class="text-sm"></p>
                            <div id="teacherPromoCodeList" class="mt-4 text-sm space-y-2"></div>
                        </div>
                    ` : ''}
                </div>
                <div id="student-${type}-view" style="display:none;">
                    ${studentViewHtml}
                </div>`;

            const isTeacher = currentUserRole === 'teacher';
            document.getElementById(`teacher-${type}-view`).style.display = isTeacher ? 'block' : 'none';
            document.getElementById(`student-${type}-view`).style.display = isTeacher ? 'block' : 'none';

            if (isTeacher) {
                renderContent(type, `level1-${type}-container`, 1);
                document.getElementById(`add-level1-${type}-btn`).onclick = () => showAddItemModal(type, 1);
                document.getElementById(`level1-${type}-container`).addEventListener('click', (e) => handleTeacherClick(e, type));
                
                const teacherViewContainer = document.getElementById(`teacher-${type}-view`);
                teacherViewContainer.addEventListener('dragover', (e) => handleDragOver(e, type));
                teacherViewContainer.addEventListener('drop', (e) => handleDrop(e, type));
                teacherViewContainer.addEventListener('dragleave', (e) => handleDragLeave(e, type));

                if (type === 'exercises') {
                    document.getElementById('generatePromoCodeBtn').addEventListener('click', generateAndSavePromoCode);
                    loadPromoCodesForTeacher();
                }
            } else {
                setupStudentFilters(type);
                if(config.isPaid) {
                    document.getElementById('checkout-btn').addEventListener('click', handleCheckout);
                    document.getElementById('applyPromoCodeBtn').addEventListener('click', applyPromoCode);
                    document.getElementById('removePromoCodeBtn').addEventListener('click', removeAppliedPromoCode);
                }

                if (window.innerWidth >= 769) {
                    const studentViewContainer = document.getElementById(`student-${type}-view`);
                    const sectionTitleContainer = section.querySelector('.flex.justify-between');
                    
                    if (!section.querySelector('.material-view-toggle')) {
                        const toggleButton = document.createElement('button');
                        toggleButton.className = 'material-view-toggle px-3 py-2 text-sm font-medium rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10';
                        toggleButton.textContent = 'Finder View';
                        sectionTitleContainer.appendChild(toggleButton);

                        toggleButton.addEventListener('click', () => {
                            if (currentMaterialViewMode === 'card') {
                                currentMaterialViewMode = 'finder';
                                studentViewContainer.classList.add('hidden');
                                showFinderView(type);
                                toggleButton.textContent = 'Card View';
                            } else {
                                currentMaterialViewMode = 'card';
                                studentViewContainer.classList.remove('hidden');
                                document.getElementById('finderMaterialsSection').style.display = 'none';
                                toggleButton.textContent = 'Finder View';
                                renderStudentItems(type);
                            }
                        });
                    }
                }
            }
        }
        
        async function renderContent(type, containerId, level, parentIds = []) {
            const container = document.getElementById(containerId);
            const config = materialsConfig[type];
            const levelName = config[`level${level}`];
            container.innerHTML = `<div class="text-center text-gray-500 p-4">Loading...</div>`;

            const collectionRef = collection(db, getPath(type, parentIds));
            const q = query(collectionRef, orderBy('name', levelName === 'Year' ? 'desc' : 'asc'));
            
            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = `<div class="text-center text-gray-500 p-4">No ${levelName.toLowerCase()}s added yet.</div>`;
                    return;
                }
                
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = doc.data();
                    item.id = doc.id;
                    const el = document.createElement('div');
                    el.className = level < 3 ? 'bg-white dark:bg-neutral-900 border border-gray-200 dark:border-neutral-800 rounded-2xl' : 'flex justify-between items-center p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-neutral-800/50 cursor-grab';

                    let headerHtml;
                    if (level < 3) {
                        const nextLevel = level + 1;
                        const newParentIds = [...parentIds, doc.id];
                        headerHtml = `
                            <div class="content-header p-4 flex justify-between items-center cursor-pointer" data-level="${level}" data-id="${doc.id}" data-parent-ids='${JSON.stringify(parentIds)}' aria-expanded="false">
                                <h3 class="font-semibold">${item.name} <span class="collapse-arrow inline-block ml-1 w-2 h-2 border-t-2 border-r-2 border-gray-500 transform rotate-45"></span></h3>
                                <div class="item-actions flex items-center gap-2">
                                    <button class="add-item-btn px-3 py-1.5 text-xs font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700" data-level="${nextLevel}" data-parent-ids='${JSON.stringify(newParentIds)}'>Add ${config[`level${nextLevel}`]}</button>
                                    <button class="delete-item-btn px-3 py-1.5 text-xs font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700" data-level="${level}" data-id="${doc.id}" data-parent-ids='${JSON.stringify(parentIds)}'>Delete</button>
                                </div>
                            </div>
                            <div class="nested-container px-4 pb-2 border-t border-gray-200 dark:border-neutral-800" id="container-level${nextLevel}-${type}-${doc.id}"></div>
                        `;
                    } else {
                        let itemName = item.name || item.title;
                        let itemPrice = config.isPaid ? ` - $${item.price.toFixed(2)}` : '';
                        headerHtml = `<span class="font-medium">${itemName}${itemPrice}</span>
                                     <div class="item-actions flex items-center gap-2">
                                        ${type === 'pastPapers' ? `<button class="edit-item-btn px-3 py-1.5 text-xs font-semibold rounded-lg bg-gray-900/5 hover:bg-gray-900/10 dark:bg-white/10 dark:hover:bg-white/20" data-type="${type}" data-item='${JSON.stringify(item)}' data-parent-ids='${JSON.stringify(parentIds)}'>Edit</button>` : ''}
                                        <button class="preview-item-btn px-3 py-1.5 text-xs font-semibold rounded-lg bg-gray-900/5 hover:bg-gray-900/10 dark:bg-white/10 dark:hover:bg-white/20" data-type="${type}" data-item='${JSON.stringify(item)}'>Preview</button>
                                        <button class="delete-item-btn px-3 py-1.5 text-xs font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700" data-level="${level}" data-id="${doc.id}" data-parent-ids='${JSON.stringify(parentIds)}'>Delete</button>
                                     </div>`;
                        el.setAttribute('draggable', 'true');
                        el.dataset.itemId = doc.id; el.dataset.itemType = type; el.dataset.itemParentIds = JSON.stringify(parentIds);
                        el.addEventListener('dragstart', handleDragStart);
                    }
                    el.innerHTML = headerHtml;
                    container.appendChild(el);
                });
            } catch (error) {
                console.error(`Error rendering level ${level} for ${type}:`, error);
                container.innerHTML = `<div class="text-center text-red-500 p-4">Error loading content. A database index might be required.</div>`;
            }
        }
        
        async function handleTeacherClick(e, type) {
            const header = e.target.closest('.content-header');
            const button = e.target.closest('button');

            if (button) {
                e.stopPropagation();
                const { level, parentIds } = button.dataset;
                const parentIdsArray = parentIds ? JSON.parse(parentIds) : [];

                if (button.matches('.add-item-btn')) {
                    const nextLevel = parseInt(level);
                    if (nextLevel < 3) showAddItemModal(type, nextLevel, parentIdsArray);
                    else showAddFinalItemModal(type, parentIdsArray);
                } else if (button.matches('.delete-item-btn')) {
                    const idToDelete = button.dataset.id;
                    handleDeleteItem(type, parseInt(level), idToDelete, parentIdsArray);
                } else if (button.matches('.preview-item-btn')) {
                    const itemData = JSON.parse(button.dataset.item);
                    handlePreview(type, itemData);
                } else if (button.matches('.edit-item-btn')) {
                    const itemData = JSON.parse(button.dataset.item);
                    const itemParentIds = JSON.parse(button.dataset.parentIds);
                    showEditPastPaperModal(itemData, itemParentIds);
                }
            } else if (header) {
                const { level, id, parentIds } = header.dataset;
                const currentLevel = parseInt(level);
                if (currentLevel >= 3) return; 
                
                const nextLevel = currentLevel + 1;
                const container = document.getElementById(`container-level${nextLevel}-${type}-${id}`);
                const isExpanded = header.getAttribute('aria-expanded') === 'true';
                header.setAttribute('aria-expanded', !isExpanded);
                container.classList.toggle('expanded', !isExpanded);

                if (!isExpanded && !container.dataset.loaded) {
                    const parentIdsArray = parentIds ? JSON.parse(parentIds) : [];
                    await renderContent(type, container.id, nextLevel, [...parentIdsArray, id]);
                    container.dataset.loaded = 'true';
                }
            }
        }

        function handlePreview(type, item) {
            if (type === 'tutorials') {
                showVideoPreviewModal(item);
            } else if (type === 'pastPapers' || type === 'exercises') {
                if (item.link) {
                    if (item.link.toLowerCase().endsWith('.pdf') || item.link.includes('drive.google.com/uc?export=download')) {
                        showPdfPreviewModal(item.name, item.link);
                    } else if (item.link.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
                        showModal('Image Preview', `<img src="${item.link}" class="w-full h-auto rounded-lg" alt="Preview">`);
                    } else {
                        window.open(item.link, '_blank');
                    }
                } else {
                    showModal('Preview Error', 'No link available for this item.');
                }
            }
        }

        function showAddItemModal(type, level, parentIds = []) {
            const config = materialsConfig[type];
            const levelName = config[`level${level}`];
            const prompt = levelName === 'Year' ? 'Year (e.g., 2024)' : levelName;
            
            showInputModal(`Add New ${levelName}`, `Enter ${prompt} Name:`, async (name) => {
                const collectionRef = collection(db, getPath(type, parentIds));
                try {
                    await addDoc(collectionRef, { name: name.trim() });
                    const containerId = level === 1 ? `level1-${type}-container` : `container-level${level}-${type}-${parentIds[parentIds.length - 1]}`;
                    renderContent(type, containerId, level, parentIds);
                } catch(e) {
                    console.error("Error adding item:", e);
                    showModal('Error', `Could not add ${levelName}. Error: ${e.message}`);
                }
            });
        }

        function showAddFinalItemModal(type, parentIds) {
            const config = materialsConfig[type];
            const modal = document.getElementById(config.modalId);
            modal.classList.add('flex');
            
            const form = modal.querySelector('form');
            form.querySelector('input[type=hidden]:nth-of-type(1)').value = parentIds[0];
            form.querySelector('input[type=hidden]:nth-of-type(2)').value = parentIds[1];
            form.reset();

            if (type === 'pastPapers') document.getElementById('pastPaperFileName').textContent = 'No file chosen';
            if (type === 'exercises') document.getElementById('exerciseFileName').textContent = 'No file chosen';
            if (type === 'tutorials') document.getElementById('tutorialThumbnailPreview').style.display = 'none';
        }

        async function handleDeleteItem(type, level, id, parentIds) {
            const config = materialsConfig[type];
            const levelName = config[`level${level}`];

            showModal('Confirm Deletion', `Are you sure you want to delete this ${levelName.toLowerCase()}? This will also delete all items inside it. This action cannot be undone.`, [
                { text: 'Delete', className: 'px-4 py-2 text-sm font-semibold rounded-xl bg-red-600 text-white hover:bg-red-700', onClick: async () => {
                    const docRef = doc(db, getPath(type, parentIds), id);
                    try {
                        if (level === 3 && (type === 'pastPapers' || type === 'exercises')) {
                            const itemSnap = await getDoc(docRef);
                            const itemData = itemSnap.data();
                            if (itemData && itemData.filePath) {
                                const fileRef = ref(storage, itemData.filePath);
                                try { await deleteObject(fileRef); } catch (e) { console.warn('Could not delete file:', e); }
                            }
                        }
                        await deleteDoc(docRef);
                        const containerId = level === 1 ? `level1-${type}-container` : `container-level${level}-${type}-${parentIds[parentIds.length - 1]}`;
                        renderContent(type, containerId, level, parentIds);
                    } catch(e) {
                         showModal('Error', `Could not delete ${levelName}. Error: ${e.message}`);
                    }
                }},
                { text: 'Cancel', className: 'px-4 py-2 text-sm font-semibold rounded-xl hover:bg-gray-900/5 dark:hover:bg-white/10' }
            ]);
        }
        
        // --- VIDEO PREVIEW & PROGRESS TRACKING ---

        async function showVideoPreviewModal(item) {
            const videoPreviewModal = document.getElementById('videoPreviewModal');
            const videoPreviewTitle = document.getElementById('videoPreviewTitle');
            const videoPreviewContent = document.getElementById('videoPreviewContent');
            const markCompleteBtn = document.getElementById('markVideoCompleteBtn');
            
            videoPreviewTitle.textContent = item.title;
            videoPreviewContent.innerHTML = '';
            
            if (item.type === 'youtube') {
                videoPreviewContent.innerHTML = `<iframe src="https://www.youtube.com/embed/${item.youtubeId}?autoplay=1&enablejsapi=1" class="absolute top-0 left-0 w-full h-full" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            } else if (item.type === 'embed') {
                videoPreviewContent.innerHTML = item.embedCode;
            }

            await loadVideoProgress(item.id);

            const newBtn = markCompleteBtn.cloneNode(true);
            markCompleteBtn.parentNode.replaceChild(newBtn, markCompleteBtn);
            newBtn.addEventListener('click', () => markVideoAsComplete(item.id, item.title));

            videoPreviewModal.classList.add('flex');
        }

        async function loadVideoProgress(tutorialId) {
            if (!currentUserId) return; 

            const statusEl = document.getElementById('videoCompletionStatus');
            const buttonEl = document.getElementById('markVideoCompleteBtn');

            statusEl.textContent = 'Not Watched';
            statusEl.classList.remove('text-green-500'); statusEl.classList.add('text-red-500');
            buttonEl.textContent = 'Mark as Complete';
            buttonEl.disabled = false;

            try {
                const progressDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/videoProgress/${tutorialId}`);
                const docSnap = await getDoc(progressDocRef);

                if (docSnap.exists() && docSnap.data().completed) {
                    statusEl.textContent = 'Completed';
                    statusEl.classList.remove('text-red-500'); statusEl.classList.add('text-green-500');
                    buttonEl.textContent = 'Completed';
                    buttonEl.disabled = true;
                }
            } catch (error) { console.error("Error loading video progress:", error); }
        }

        async function markVideoAsComplete(tutorialId, tutorialTitle) {
            if (!currentUserId) return showModal('Error', 'You must be logged in to save progress.');

            const buttonEl = document.getElementById('markVideoCompleteBtn');
            buttonEl.disabled = true; buttonEl.textContent = 'Saving...';

            try {
                const progressDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/videoProgress/${tutorialId}`);
                await setDoc(progressDocRef, {
                    completed: true,
                    completedAt: Date.now(),
                    tutorialTitle: tutorialTitle
                });
                await loadVideoProgress(tutorialId);
            } catch (error) {
                showModal('Error', `Could not save progress: ${error.message}`);
                buttonEl.disabled = false; buttonEl.textContent = 'Mark as Complete';
            }
        }

        // --- DRAG AND DROP LOGIC (TEACHER SIDE) ---
        let draggedItem = null;

        function handleDragStart(e) {
            const subItem = e.target.closest('.sub-item');
            if (!subItem) return;
            draggedItem = { id: subItem.dataset.itemId, type: subItem.dataset.itemType, parentIds: JSON.parse(subItem.dataset.itemParentIds) };
            e.dataTransfer.setData('text/plain', JSON.stringify(draggedItem));
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e, type) {
            e.preventDefault();
            const targetElement = e.target.closest('.content-item > .content-header');
            if (targetElement && draggedItem && draggedItem.type === type) {
                targetElement.parentElement.classList.add('bg-blue-500/10', 'border-blue-500');
                e.dataTransfer.dropEffect = 'move';
            } else {
                e.dataTransfer.dropEffect = 'none';
            }
        }

        function handleDragLeave(e, type) {
            const targetElement = e.target.closest('.content-item');
            if (targetElement) targetElement.classList.remove('bg-blue-500/10', 'border-blue-500');
        }

        async function handleDrop(e, type) {
            e.preventDefault();
            const targetHeader = e.target.closest('.content-item > .content-header');
            if (targetHeader) {
                targetHeader.parentElement.classList.remove('bg-blue-500/10', 'border-blue-500');
            } else { return; }

            if (!draggedItem || draggedItem.type !== type) { draggedItem = null; return; }

            const newParentLevel = parseInt(targetHeader.dataset.level);
            const newParentId = targetHeader.dataset.id;
            const newParentParentIds = JSON.parse(targetHeader.dataset.parentIds);

            let newFullParentIds = [];
            if (newParentLevel === 1) {
                 showModal('Move Error', 'Files must be moved into a Topic or Year folder, not a Subject folder.');
                 draggedItem = null; return;
            } else if (newParentLevel === 2) {
                newFullParentIds = [...newParentParentIds, newParentId];
            } else { draggedItem = null; return; }
            
            if (newFullParentIds.length !== 2) { 
                 showModal('Move Error', 'Files must be moved into a Topic or Year folder.');
                 draggedItem = null; return;
            }

            const oldParentIds = draggedItem.parentIds;
            const itemId = draggedItem.id;
            if (oldParentIds[0] === newFullParentIds[0] && oldParentIds[1] === newFullParentIds[1]) { draggedItem = null; return; }

            const oldDocRef = doc(db, getPath(type, oldParentIds), itemId);
            const newDocRef = doc(db, getPath(type, newFullParentIds), itemId);

            try {
                const docSnap = await getDoc(oldDocRef);
                if (!docSnap.exists()) throw new Error("Item not found.");
                
                const batch = writeBatch(db);
                batch.set(newDocRef, docSnap.data());
                batch.delete(oldDocRef);
                await batch.commit();

                const oldContainer = document.getElementById(`container-level3-${type}-${oldParentIds[1]}`);
                if (oldContainer?.classList.contains('expanded')) renderContent(type, oldContainer.id, 3, oldParentIds);
                
                const newContainer = document.getElementById(`container-level3-${type}-${newFullParentIds[1]}`);
                if (newContainer?.classList.contains('expanded')) renderContent(type, newContainer.id, 3, newFullParentIds);
            } catch (error) {
                showModal('Move Error', `Could not move item. Error: ${error.message}`);
            } finally {
                draggedItem = null;
            }
        }

        // --- STUDENT FILTER LOGIC ---
        function setupStudentFilters(type) {
            const config = materialsConfig[type];
            const level1Filter = document.getElementById(`level1-${type}-filter`);
            const level2Filter = document.getElementById(`level2-${type}-filter`);
            const grid = document.getElementById(`level3-${type}-grid`);

            populateFilter(level1Filter, collection(db, getPath(type)), `-- Select ${config.level1} --`);

            level1Filter.onchange = () => {
                const level1Id = level1Filter.value;
                level2Filter.innerHTML = '';
                level2Filter.disabled = true;
                grid.innerHTML = `<p class="text-center col-span-full text-gray-500">Please select a ${config.level2.toLowerCase()}.</p>`;
                if (level1Id) {
                    populateFilter(level2Filter, collection(db, getPath(type, [level1Id])), `-- Select ${config.level2} --`);
                    level2Filter.disabled = false;
                }
            };
            level2Filter.onchange = () => renderStudentItems(type);
        }

        async function renderStudentItems(type) {
             const config = materialsConfig[type];
             const grid = document.getElementById(`level3-${type}-grid`);
             const level1Id = document.getElementById(`level1-${type}-filter`).value;
             const level2Id = document.getElementById(`level2-${type}-filter`).value;

             grid.innerHTML = `<p class="text-center col-span-full text-gray-500">Loading...</p>`;
             if (!level1Id || !level2Id) {
                 grid.innerHTML = `<p class="text-center col-span-full text-gray-500">Please select a ${config.level1.toLowerCase()} and ${config.level2.toLowerCase()}.</p>`;
                 return;
             }

             const itemsRef = collection(db, getPath(type, [level1Id, level2Id]));
             const q = query(itemsRef, orderBy('name', 'asc'));
             
             let purchasedItems = {};
             if(config.isPaid && currentUserId) {
                 const purchases = await getDocs(collection(db, `artifacts/${appId}/users/${currentUserId}/purchased_${config.collectionName}`));
                 purchases.forEach(doc => purchasedItems[doc.id] = true);
             }

             try {
                const snapshot = await getDocs(q);
                grid.innerHTML = snapshot.empty ? `<p class="text-center col-span-full text-gray-500">No ${config.level3.toLowerCase()}s found.</p>` : '';
                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    const card = document.createElement('div');
                    
                    let cardContent = '';
                    if (type === 'tutorials') {
                        card.className = 'group rounded-2xl border border-gray-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 overflow-hidden flex flex-col shadow-sm hover:shadow-md transition-shadow';
                        if (item.type === 'youtube') {
                            cardContent = `
                                <button data-type="${type}" data-item='${JSON.stringify(item)}' class="preview-item-btn block aspect-video bg-black relative">
                                    <img src="https://img.youtube.com/vi/${item.youtubeId}/mqdefault.jpg" alt="${item.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" onerror="this.style.display='none'">
                                    <div class="absolute inset-0 bg-black/20 grid place-content-center"><div class="w-12 h-12 bg-black/50 rounded-full text-white grid place-content-center group-hover:scale-110 transition-transform">&#9658;</div></div>
                                </button>
                                <div class="p-4"><h3 class="font-semibold text-sm">${item.title}</h3></div>
                            `;
                        }
                    } else if (config.isPaid) {
                        const isPurchased = purchasedItems[item.id];
                        const inCart = shoppingCart.find(cartItem => cartItem.id === item.id);
                        card.className = 'p-4 rounded-2xl border border-gray-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 flex flex-col gap-2 shadow-sm';
                        cardContent = `
                            <h4 class="font-semibold text-sm">${item.name}</h4>
                            <p class="font-bold text-lg">$${item.price.toFixed(2)}</p>
                            ${isPurchased 
                                ? `<button class="preview-item-btn mt-auto w-full px-3 py-2 text-sm font-semibold rounded-xl bg-gray-900/5 hover:bg-gray-900/10 dark:bg-white/10 dark:hover:bg-white/20" data-type="${type}" data-item='${JSON.stringify(item)}'>Preview/Download</button>`
                                : `<button class="add-to-cart-btn mt-auto w-full px-3 py-2 text-sm font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50" data-item='${JSON.stringify(item)}' ${inCart ? 'disabled' : ''}>${inCart ? 'In Cart' : 'Add to Cart'}</button>`
                            }`;
                    } else { // Free materials
                        card.className = 'p-4 rounded-2xl border border-gray-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 flex flex-col gap-2 shadow-sm';
                        cardContent = `
                            <h3 class="font-semibold text-sm flex-grow">${item.name}</h3>
                            <button class="preview-item-btn mt-auto w-full px-3 py-2 text-sm font-semibold rounded-xl bg-gray-900/5 hover:bg-gray-900/10 dark:bg-white/10 dark:hover:bg-white/20" data-type="${type}" data-item='${JSON.stringify(item)}'>Preview/Download</button>
                        `;
                    }
                    card.innerHTML = cardContent;
                    grid.appendChild(card);
                    
                    card.querySelector('.preview-item-btn')?.addEventListener('click', (e) => handlePreview(type, JSON.parse(e.currentTarget.dataset.item)));
                    card.querySelector('.add-to-cart-btn')?.addEventListener('click', (e) => addToCart(JSON.parse(e.currentTarget.dataset.item)));
                });
             } catch(e) { grid.innerHTML = "<p class='text-center col-span-full text-red-500'>Error loading items.</p>" }
        }
        
        async function populateFilter(selectElement, collectionRef, defaultOptionText) {
            selectElement.innerHTML = `<option value="">Loading...</option>`;
            try {
                const q = query(collectionRef, orderBy('name', defaultOptionText.includes('Year') ? 'desc' : 'asc'));
                const snapshot = await getDocs(q);
                selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
                if(snapshot.empty) {
                    selectElement.innerHTML += `<option value="" disabled>-- None Available --</option>`;
                } else {
                    snapshot.forEach(doc => selectElement.add(new Option(doc.data().name, doc.id)));
                }
            } catch (e) {
                selectElement.innerHTML = `<option value="">-- Error --</option>`;
            }
        }

        // --- E-COMMERCE LOGIC ---
        function addToCart(item) { shoppingCart.push(item); updateCartUI(); renderStudentItems('exercises'); }
        function removeFromCart(itemId) { shoppingCart = shoppingCart.filter(item => item.id !== itemId); updateCartUI(); renderStudentItems('exercises'); }

        function updateCartUI() {
            const cartItemsContainer = document.getElementById('cart-items');
            if(!cartItemsContainer) return;
            const subtotalPriceEl = document.getElementById('cart-subtotal-price');
            const promoDiscountLine = document.getElementById('promo-discount-line');
            const promoDiscountEl = document.getElementById('cart-promo-discount');
            const totalPriceEl = document.getElementById('cart-total-price');
            const checkoutBtn = document.getElementById('checkout-btn');
            const validationMsg = document.getElementById('cart-validation-message');
            const promoCodeInput = document.getElementById('promoCodeInput');
            const applyPromoCodeBtn = document.getElementById('applyPromoCodeBtn');
            const appliedPromoCodeDisplay = document.getElementById('appliedPromoCodeDisplay');
            const appliedPromoCodeText = document.getElementById('appliedPromoCodeText');

            cartItemsContainer.innerHTML = shoppingCart.length === 0 ? '<p class="text-xs text-gray-500">Your cart is empty.</p>' : '';
            let subtotal = 0;

            shoppingCart.forEach(item => {
                subtotal += item.price;
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center text-xs';
                itemEl.innerHTML = `<span class="flex-grow pr-2">${item.name}</span><span class="font-medium pr-2">$${item.price.toFixed(2)}</span><button class="remove-from-cart-btn text-red-500 hover:text-red-700" data-id="${item.id}"></button>`;
                cartItemsContainer.appendChild(itemEl);
            });
            
            document.querySelectorAll('.remove-from-cart-btn').forEach(btn => btn.addEventListener('click', () => removeFromCart(btn.dataset.id)));

            subtotalPriceEl.textContent = `$${subtotal.toFixed(2)}`;
            let finalPrice = subtotal;

            if (appliedPromoCode) {
                finalPrice = Math.max(0, subtotal - appliedPromoCode.discountAmount);
                promoDiscountEl.textContent = `-$${appliedPromoCode.discountAmount.toFixed(2)}`;
                promoDiscountLine.style.display = 'flex';
                appliedPromoCodeText.textContent = `${appliedPromoCode.code} (-$${appliedPromoCode.discountAmount.toFixed(2)})`;
                appliedPromoCodeDisplay.style.display = 'block';
                promoCodeInput.disabled = true; applyPromoCodeBtn.disabled = true;
            } else {
                promoDiscountLine.style.display = 'none';
                appliedPromoCodeDisplay.style.display = 'none';
                promoCodeInput.disabled = false; applyPromoCodeBtn.disabled = false;
            }

            totalPriceEl.textContent = `$${finalPrice.toFixed(2)}`;
            checkoutBtn.disabled = shoppingCart.length === 0;
            validationMsg.textContent = shoppingCart.length > 0 ? '' : 'Your cart is empty.';
        }

        async function applyPromoCode() {
            const promoCodeInput = document.getElementById('promoCodeInput');
            const promoCodeError = document.getElementById('promoCodeError');
            const code = promoCodeInput.value.trim().toUpperCase();

            if (!code) return promoCodeError.textContent = 'Please enter a code.';
            promoCodeError.textContent = '';

            try {
                const docSnap = await getDoc(doc(db, `artifacts/${appId}/public/data/promoCodes`, code));
                if (docSnap.exists() && docSnap.data().isActive) {
                    const promoData = docSnap.data();
                    appliedPromoCode = { code: code, discountAmount: promoData.discountAmount };
                    updateCartUI();
                } else {
                    promoCodeError.textContent = 'Invalid or inactive code.';
                }
            } catch (error) { promoCodeError.textContent = 'Error applying code.'; }
        }

        function removeAppliedPromoCode() { appliedPromoCode = null; updateCartUI(); }

        async function handleCheckout() {
            if (!currentUserId) return showModal('Error', 'You must be logged in to check out.');
            if (shoppingCart.length === 0) return;

            let finalPrice = shoppingCart.reduce((sum, item) => sum + item.price, 0);
            if (appliedPromoCode) finalPrice = Math.max(0, finalPrice - appliedPromoCode.discountAmount);

            try {
                if (finalPrice <= 0) { // Free checkout
                    const batch = writeBatch(db);
                    shoppingCart.forEach(item => {
                        const ref = doc(db, `artifacts/${appId}/users/${currentUserId}/purchased_exercises/${item.id}`);
                        batch.set(ref, { name: item.name, price: 0, purchasedAt: Date.now(), promoCodeUsed: appliedPromoCode?.code });
                    });
                    await batch.commit();
                    showModal('Purchase Successful!', 'Your new exercises are now available.');
                } else { // Paid checkout
                    if (STRIPE_PAYMENT_LINK.includes("...")) return showModal('Configuration Error', 'Stripe is not configured.');
                    const sessionId = crypto.randomUUID();
                    await setDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/checkout_sessions/${sessionId}`), { cart: shoppingCart, appliedPromoCode, totalAmount: finalPrice });
                    window.location.href = `${STRIPE_PAYMENT_LINK}?client_reference_id=${sessionId}&prefilled_email=${currentUserEmail}`;
                }
                shoppingCart = []; appliedPromoCode = null;
                updateCartUI(); renderStudentItems('exercises');
            } catch (error) {
                showModal('Checkout Error', `Could not complete checkout. Error: ${error.message}`);
            }
        }
        
        async function checkForSuccessfulPurchase() {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session_id');

            if (params.get('payment_status') === 'success' && sessionId && currentUserId) {
                try {
                    const sessionDoc = await getDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/checkout_sessions/${sessionId}`));
                    if (sessionDoc.exists()) {
                        const { cart, appliedPromoCode } = sessionDoc.data();
                        const batch = writeBatch(db);
                        cart.forEach(item => {
                            const ref = doc(db, `artifacts/${appId}/users/${currentUserId}/purchased_exercises/${item.id}`);
                            batch.set(ref, { name: item.name, price: item.price, purchasedAt: Date.now(), promoCodeUsed: appliedPromoCode?.code });
                        });
                        batch.delete(sessionDoc.ref);
                        await batch.commit();
                        
                        showModal('Purchase Successful!', 'Your new exercises are now available.');
                        window.history.replaceState({}, document.title, window.location.pathname);
                        showSection('exerciseSection');
                    }
                } catch (error) {
                    showModal('Purchase Error', 'There was an issue verifying your purchase.');
                }
            }
        }

        // --- PROMO CODE MANAGEMENT (TEACHER SIDE) ---
        async function generateAndSavePromoCode() {
            const input = document.getElementById('promoDiscountAmount');
            const status = document.getElementById('promoCodeGenerationStatus');
            const amount = parseFloat(input.value);
            if (isNaN(amount) || amount <= 0) return status.textContent = 'Please enter a valid discount amount.';
            
            status.textContent = 'Generating...';
            const code = Array.from({length: 8}, () => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'[Math.floor(Math.random() * 36)]).join('');
            try {
                await setDoc(doc(db, `artifacts/${appId}/public/data/promoCodes`, code), { code, discountAmount: amount, isActive: true, createdAt: Date.now() });
                status.textContent = `Promo code "${code}" generated!`;
                input.value = '';
                loadPromoCodesForTeacher();
            } catch (error) { status.textContent = `Error: ${error.message}`; }
        }

        async function loadPromoCodesForTeacher() {
            const list = document.getElementById('teacherPromoCodeList');
            list.innerHTML = `<p>Loading...</p>`;
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/promoCodes`), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                list.innerHTML = snapshot.empty ? '<p>No promo codes generated yet.</p>' : '';
                snapshot.forEach(doc => {
                    const promo = doc.data();
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 border-b border-gray-200 dark:border-neutral-800';
                    item.innerHTML = `<span>${promo.code}</span><span>$${promo.discountAmount.toFixed(2)}</span><span>${promo.isActive ? 'Active' : 'Inactive'}</span><div class="flex gap-2"><button class="toggle-promo-status-btn text-xs px-2 py-1 rounded-md" data-code="${promo.code}" data-is-active="${promo.isActive}">${promo.isActive ? 'Deactivate' : 'Activate'}</button><button class="delete-promo-btn text-xs px-2 py-1 rounded-md" data-code="${promo.code}">Delete</button></div>`;
                    list.appendChild(item);
                });
                list.querySelectorAll('.toggle-promo-status-btn').forEach(b => b.addEventListener('click', (e) => togglePromoCodeStatus(e.target.dataset.code, e.target.dataset.isActive === 'true')));
                list.querySelectorAll('.delete-promo-btn').forEach(b => b.addEventListener('click', (e) => deletePromoCode(e.target.dataset.code)));
            } catch (error) { list.innerHTML = `<p class="text-red-500">Error loading codes.</p>`; }
        }

        async function togglePromoCodeStatus(code, currentStatus) {
            await updateDoc(doc(db, `artifacts/${appId}/public/data/promoCodes`, code), { isActive: !currentStatus });
            loadPromoCodesForTeacher();
        }
        async function deletePromoCode(code) {
            showModal('Confirm Deletion', `Are you sure you want to delete promo code "${code}"?`, [
                { text: 'Delete', className: 'px-4 py-2 text-sm font-semibold rounded-xl bg-red-600 text-white hover:bg-red-700', onClick: async () => {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/promoCodes`, code));
                    loadPromoCodesForTeacher();
                }},
                { text: 'Cancel', className: 'px-4 py-2 text-sm font-semibold rounded-xl hover:bg-gray-900/5 dark:hover:bg-white/10' }
            ]);
        }

        // --- VIDEO & FILE PARSING ---
        function parseVideoInput(input) {
            const text = input.trim();
            const youtubeMatch = text.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            if (youtubeMatch) return { type: 'youtube', id: youtubeMatch[1] };
            if (text.startsWith('<iframe')) return { type: 'embed', code: text };
            return null;
        }

        function convertGoogleDriveLink(url) {
            const match = url.match(/https:\/\/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
            return match ? `https://drive.google.com/uc?export=download&id=${match[1]}` : url;
        }

        function setupGoogleDriveLinkConversion() {
            ['pastPaperLink', 'exerciseLink', 'editPastPaperLink'].forEach(id => {
                const input = document.getElementById(id);
                if (input) input.addEventListener('input', (e) => e.target.value = convertGoogleDriveLink(e.target.value));
            });
        }

        // --- MODAL SUBMISSION LOGIC & HELPERS ---
        document.getElementById('addVideoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const [parentId1, parentId2] = [e.target.videoParentId1.value, e.target.videoParentId2.value];
            const title = e.target.tutorialTitle.value;
            const videoDetails = parseVideoInput(e.target.tutorialLink.value);
            if (!videoDetails || !title.trim()) return showModal('Input Error', 'Please provide a title and a valid YouTube link or embed code.');
            
            const dataToSave = { title: title.trim(), name: title.trim(), timestamp: Date.now() };
            if (videoDetails.type === 'youtube') { dataToSave.type = 'youtube'; dataToSave.youtubeId = videoDetails.id; }
            else { dataToSave.type = 'embed'; dataToSave.embedCode = videoDetails.code; }

            try {
                await addDoc(collection(db, getPath('tutorials', [parentId1, parentId2])), dataToSave);
                e.target.closest('.modal').classList.remove('flex');
                renderContent('tutorials', `container-level3-tutorials-${parentId2}`, 3, [parentId1, parentId2]);
            } catch (error) { showModal('Error', `Could not add video: ${error.message}`); }
        });

        async function handleFileUploadForm(e, type) {
            e.preventDefault();
            const form = e.target;
            const config = materialsConfig[type];
            const name = form[`${type.slice(0, -1)}Name`].value;
            const file = form[`${type.slice(0, -1)}File`].files[0];
            const link = form[`${type.slice(0, -1)}Link`].value.trim();
            const price = type === 'exercises' ? parseFloat(form.exercisePrice.value) : 0;
            
            if (!name.trim() || (!file && !link) || (type === 'exercises' && (isNaN(price) || price < 0))) {
                return showModal('Input Error', 'Please fill all required fields correctly.');
            }

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true; submitBtn.textContent = 'Processing...';
            
            try {
                let downloadURL = link, filePath = '';
                if (file) {
                    filePath = `materials/${type}/${Date.now()}_${file.name}`;
                    const uploadResult = await uploadBytes(ref(storage, filePath), file);
                    downloadURL = await getDownloadURL(uploadResult.ref);
                }
                if (!downloadURL) throw new Error("No valid file or link provided.");

                const parentIds = [form[1].value, form[2].value];
                const data = { name: name.trim(), link: downloadURL, timestamp: Date.now(), filePath };
                if (type === 'exercises') data.price = price;

                await addDoc(collection(db, getPath(type, parentIds)), data);
                form.closest('.modal').classList.remove('flex');
                renderContent(type, `container-level3-${type}-${parentIds[1]}`, 3, parentIds);
            } catch (error) {
                showModal('Error', `Could not add ${config.level3}: ${error.message}`);
            } finally {
                submitBtn.disabled = false; submitBtn.textContent = `Add ${config.level3}`;
            }
        }
        document.getElementById('addPastPaperForm').addEventListener('submit', (e) => handleFileUploadForm(e, 'pastPapers'));
        document.getElementById('addExerciseForm').addEventListener('submit', (e) => handleFileUploadForm(e, 'exercises'));

        document.getElementById('editPastPaperForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const { editPaperId, editPaperParentId1, editPaperParentId2, editPastPaperName, editPastPaperLink } = e.target;
            if (!editPastPaperName.value.trim() || !editPastPaperLink.value.trim()) return;
            const parentIds = [editPaperParentId1.value, editPaperParentId2.value];
            try {
                await updateDoc(doc(db, getPath('pastPapers', parentIds), editPaperId.value), { name: editPastPaperName.value, link: editPastPaperLink.value });
                e.target.closest('.modal').classList.remove('flex');
                renderContent('pastPapers', `container-level3-pastPapers-${parentIds[1]}`, 3, parentIds);
            } catch (error) { showModal('Error', `Could not update paper: ${error.message}`); }
        });
        
        function showEditPastPaperModal(itemData, parentIds) {
            const modal = document.getElementById('editPastPaperModal');
            const form = modal.querySelector('form');
            form.editPaperId.value = itemData.id;
            form.editPaperParentId1.value = parentIds[0];
            form.editPaperParentId2.value = parentIds[1];
            form.editPastPaperName.value = itemData.name;
            form.editPastPaperLink.value = itemData.link;
            modal.classList.add('flex');
        }

        document.getElementById('tutorialLink').addEventListener('input', (e) => {
            const details = parseVideoInput(e.target.value);
            const preview = document.getElementById('tutorialThumbnailPreview');
            preview.src = details?.type === 'youtube' ? `https://img.youtube.com/vi/${details.id}/mqdefault.jpg` : '';
            preview.style.display = details?.type === 'youtube' ? 'block' : 'none';
        });
        
        function setupDropZone(dropZoneId, fileInputId, fileNameDisplayId) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            const fileNameDisplay = document.getElementById(fileNameDisplayId);
            if (!dropZone) return;
            dropZone.addEventListener('click', () => fileInput.click());
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => dropZone.addEventListener(eName, e => {e.preventDefault(); e.stopPropagation();}));
            ['dragenter', 'dragover'].forEach(eName => dropZone.addEventListener(eName, () => dropZone.classList.add('border-blue-500', 'dark:border-blue-500')));
            ['dragleave', 'drop'].forEach(eName => dropZone.addEventListener(eName, () => dropZone.classList.remove('border-blue-500', 'dark:border-blue-500')));
            dropZone.addEventListener('drop', e => { fileInput.files = e.dataTransfer.files; fileInput.dispatchEvent(new Event('change')); });
            fileInput.addEventListener('change', () => fileNameDisplay.textContent = fileInput.files[0]?.name || 'No file chosen');
        }
        setupDropZone('pastPaperDropZone', 'pastPaperFile', 'pastPaperFileName');
        setupDropZone('exerciseDropZone', 'exerciseFile', 'exerciseFileName');
        
        function showModal(title, message, buttons = []) {
            const modal = document.getElementById('messageModal');
            modal.querySelector('#modalTitle').textContent = title;
            modal.querySelector('#modalMessage').innerHTML = message;
            const buttonsContainer = modal.querySelector('#modalButtons');
            buttonsContainer.innerHTML = '';

            if (buttons.length === 0) {
                 buttons.push({ text: 'OK', className: 'px-4 py-2 text-sm font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700' });
            }
            buttons.forEach(btnConfig => {
                const button = document.createElement('button');
                button.textContent = btnConfig.text;
                button.className = btnConfig.className;
                button.onclick = () => { modal.classList.remove('flex'); if (btnConfig.onClick) btnConfig.onClick(); };
                buttonsContainer.appendChild(button);
            });
            modal.classList.add('flex');
        }
        
        function showInputModal(title, label, callback) {
            // This can be refactored into a more generic modal if needed
            // For now, this is a placeholder if other parts of the app need it
        }

        document.querySelectorAll('.modal .close-button').forEach(btn => btn.onclick = () => { 
            const modal = btn.closest('.modal');
            modal.classList.remove('flex');
            if (modal.id === 'videoPreviewModal') document.getElementById('videoPreviewContent').innerHTML = '';
            if (modal.id === 'pdfPreviewModal') pdfDoc = null;
        });

        // --- FINDER WINDOW LOGIC ---
        function showFinderView(type) {
            const finderWindow = document.getElementById('finderMaterialsSection');
            finderWindow.querySelector('.finder-titlebar span').textContent = materialsConfig[type].title;
            finderWindow.style.display = 'flex';
            loadFinderSidebar(type);
            document.getElementById('finderFileListContent').innerHTML = `<p class="text-center p-8 text-gray-500 dark:text-neutral-400">Select a ${materialsConfig[type].level1.toLowerCase()} from the sidebar.</p>`;
        }

        async function loadFinderSidebar(type) {
            const finderSidebar = document.getElementById('finderSidebar');
            finderSidebar.innerHTML = `<p class="p-4 text-xs text-gray-500">Loading...</p>`;
            try {
                const q = query(collection(db, getPath(type)), orderBy('name', 'asc'));
                const snapshot = await getDocs(q);
                finderSidebar.innerHTML = '';
                if (snapshot.empty) return finderSidebar.innerHTML = `<p class="p-4 text-xs text-gray-500">No subjects found.</p>`;
                snapshot.forEach(doc => {
                    const item = doc.data();
                    const el = document.createElement('a');
                    el.href = '#';
                    el.className = 'block px-3 py-2 text-sm rounded-lg hover:bg-gray-900/5 dark:hover:bg-white/10';
                    el.textContent = item.name;
                    el.dataset.id = doc.id; el.dataset.type = type;
                    el.addEventListener('click', handleFinderSidebarClick);
                    finderSidebar.appendChild(el);
                });
            } catch (error) { finderSidebar.innerHTML = `<p class="p-4 text-xs text-red-500">Error loading subjects.</p>`; }
        }

        function handleFinderSidebarClick(e) {
            e.preventDefault();
            const item = e.currentTarget;
            document.querySelectorAll('.finder-sidebar a').forEach(el => el.classList.remove('bg-gray-900/10', 'dark:bg-white/10', 'font-semibold'));
            item.classList.add('bg-gray-900/10', 'dark:bg-white/10', 'font-semibold');
            loadFinderFileList(item.dataset.type, [item.dataset.id], 2);
        }

        async function loadFinderFileList(type, parentIds, level) {
            const listContent = document.getElementById('finderFileListContent');
            listContent.innerHTML = `<p class="text-center p-8 text-gray-500">Loading...</p>`;
            const config = materialsConfig[type];
            const q = query(collection(db, getPath(type, parentIds)), orderBy('name', level === 2 ? 'desc' : 'asc'));

            try {
                const snapshot = await getDocs(q);
                listContent.innerHTML = snapshot.empty ? `<p class="text-center p-8 text-gray-500">No items found.</p>` : '';
                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    const el = document.createElement('a');
                    el.href = '#';
                    el.className = 'grid grid-cols-[3fr,1fr,1fr,1fr] p-3 border-b border-gray-200 dark:border-neutral-800 hover:bg-gray-50 dark:hover:bg-neutral-900/50';
                    
                    let icon, kind, date = item.timestamp ? new Date(item.timestamp).toLocaleDateString() : '-';
                    if (level === 2) { kind = config.level2; el.addEventListener('click', (e) => { e.preventDefault(); loadFinderFileList(type, [...parentIds, doc.id], 3); }); }
                    else { kind = config.level3; el.addEventListener('click', (e) => { e.preventDefault(); handlePreview(type, item); }); }

                    el.innerHTML = `
                        <div class="font-medium truncate">${item.name || item.title}</div>
                        <div>-</div>
                        <div>${kind}</div>
                        <div>${date}</div>
                    `;
                    listContent.appendChild(el);
                });
            } catch (error) { listContent.innerHTML = `<p class="text-center p-8 text-red-500">Error loading items.</p>`; }
        }

        function setupFinderWindow() {
            const finderWindow = document.getElementById('finderMaterialsSection');
            const dragBar = document.getElementById('finderDragBar');
            let isDragging = false, offsetX, offsetY;
            
            dragBar.onmousedown = (e) => {
                isDragging = true;
                finderWindow.style.transform = 'none';
                offsetX = e.clientX - finderWindow.offsetLeft;
                offsetY = e.clientY - finderWindow.offsetTop;
                finderWindow.style.cursor = 'grabbing';
            };

            document.onmouseup = () => { isDragging = false; finderWindow.style.cursor = 'grab'; };
            document.onmousemove = (e) => {
                if (isDragging) {
                    finderWindow.style.left = (e.clientX - offsetX) + 'px';
                    finderWindow.style.top = (e.clientY - offsetY) + 'px';
                }
            };

            document.getElementById('finderFullscreenToggle').onclick = () => finderWindow.classList.toggle('fullscreen');
            finderWindow.querySelector('.close-button').onclick = () => {
                finderWindow.style.display = 'none';
                currentMaterialViewMode = 'card';
                const type = ['tutorials', 'pastPapers', 'exercises'].find(t => document.getElementById(materialsConfig[t].sectionId).style.display === 'block');
                if (type) {
                    document.getElementById(materialsConfig[t].sectionId).classList.remove('hidden');
                    const toggle = document.querySelector(`.material-view-toggle`);
                    if(toggle) toggle.textContent = 'Finder View';
                }
            };
        }

        window.addEventListener('resize', () => {
            const finderSection = document.getElementById('finderMaterialsSection');
            if (window.innerWidth < 769 && finderSection.style.display === 'flex') {
                finderSection.style.display = 'none';
                currentMaterialViewMode = 'card';
                // Find active section and show it
                const type = ['tutorials', 'pastPapers', 'exercises'].find(t => document.getElementById(materialsConfig[t].sectionId).classList.contains('hidden'));
                if (type) document.getElementById(materialsConfig[t].sectionId).classList.remove('hidden');
            }
        });

        // --- PDF PREVIEW LOGIC ---
        let pdfDoc = null, pageNum = 1, pageRendering = false, pageNumPending = null;
        const pdfPreviewModal = document.getElementById('pdfPreviewModal');
        const pdfCanvas = document.getElementById('pdfCanvas');
        const pdfContext = pdfCanvas.getContext('2d');
        const pdfPageNumSpan = document.getElementById('pdfPageNum');
        const pdfTotalPagesSpan = document.getElementById('pdfTotalPages');
        const prevPdfPageBtn = document.getElementById('prevPdfPage');
        const nextPdfPageBtn = document.getElementById('nextPdfPage');

        prevPdfPageBtn.onclick = () => { if (pageNum > 1) { pageNum--; queueRenderPage(pageNum); } };
        nextPdfPageBtn.onclick = () => { if (pageNum < pdfDoc.numPages) { pageNum++; queueRenderPage(pageNum); } };

        function showPdfPreviewModal(title, pdfUrl) {
            document.getElementById('pdfPreviewTitle').textContent = title;
            pdfPreviewModal.classList.add('flex');
            loadPdf(pdfUrl);
        }

        async function loadPdf(pdfUrl) {
            pdfDoc = null; pageNum = 1;
            try {
                const loadingTask = pdfjsLib.getDocument(pdfUrl);
                pdfDoc = await loadingTask.promise;
                pdfTotalPagesSpan.textContent = pdfDoc.numPages;
                queueRenderPage(pageNum);
            } catch (error) {
                showModal('PDF Load Error', `Failed to load PDF: ${error.message}`);
                pdfPreviewModal.classList.remove('flex');
            }
        }

        function renderPage(num) {
            pageRendering = true;
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale: 1.5 });
                pdfCanvas.height = viewport.height; pdfCanvas.width = viewport.width;
                const renderTask = page.render({ canvasContext: pdfContext, viewport: viewport });
                renderTask.promise.then(() => {
                    pageRendering = false;
                    if (pageNumPending !== null) { renderPage(pageNumPending); pageNumPending = null; }
                    updatePdfNavButtons();
                });
            });
            pdfPageNumSpan.textContent = num;
        }

        function queueRenderPage(num) { if (pageRendering) pageNumPending = num; else renderPage(num); }
        function updatePdfNavButtons() { prevPdfPageBtn.disabled = pageNum <= 1; nextPdfPageBtn.disabled = pageNum >= pdfDoc.numPages; }
    </script>
</body>
</html>

