<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI Marker — Submissions</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* --- MODERN BLACK & WHITE THEME (Adapted from index (8).html) --- */
:root {
    --bg-primary: #0a0a0a; /* Near black for main background */
    --bg-secondary: #1a1a1a; /* Dark gray for secondary elements */
    --bg-tertiary: #2a2a2a; /* Lighter gray for hovers */
    --text-primary: #f5f5f5; /* Off-white for primary text */
    --text-secondary: #a3a3a3; /* Muted gray for secondary text */
    --accent-primary: #ffffff; /* White for key actions and highlights */
    --accent-red: #ef4444; /* A modern, sharp red for destructive actions */
    --border-color: #333333; /* Subtle border color */
    --focus-ring-color: rgba(245, 245, 245, 0.5);
}

body.light-theme {
    --bg-primary: #ffffff;
    --bg-secondary: #f5f5f5;
    --bg-tertiary: #e5e5e5;
    --text-primary: #0a0a0a;
    --text-secondary: #737373;
    --accent-primary: #0a0a0a;
    --border-color: #d4d4d4;
    --focus-ring-color: rgba(10, 10, 10, 0.5);
}

*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg-primary); color:var(--text-primary); transition: background-color 0.3s, color 0.3s;}

/* --- LOGIN PAGE STYLES (From index (8).html) --- */
#authWrapper {
    display: none; /* Initially hidden */
    width: 100vw;
    height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1001;
    animation: fadeIn .5s ease-in-out;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.login-left-panel,
.login-right-panel {
    width: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 2rem;
}

.login-left-panel {
    background: var(--bg-primary);
    color: var(--text-primary);
    flex-direction: column;
    text-align: center;
}

.login-left-panel h1 {
    font-size: 3.5rem;
    font-weight: 700;
    letter-spacing: -1px;
    margin-bottom: 1rem;
}

.login-left-panel p {
    font-size: 1.25rem;
    font-weight: 400;
    line-height: 1.5;
    margin-bottom: .5rem;
    color: var(--text-secondary);
    max-width: 450px;
}

.login-right-panel {
    background: var(--bg-secondary);
    flex-direction: column;
}

.login-card {
    width: 100%;
    max-width: 380px;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    background-color: var(--bg-primary);
    padding: 2.5rem;
    border-radius: 12px;
    border: 1px solid var(--border-color);
}

.login-card h2 {
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    text-align: center;
}
.helper{font-size:14px;color:var(--text-secondary); margin-bottom: 1.5rem; text-align: center;}
.google-btn{display:flex;align-items:center;justify-content:center;gap:12px;border:1px solid var(--border-color);border-radius:8px;padding:.75rem;cursor:pointer;background:var(--bg-secondary);color:var(--text-primary);font-size:1rem;font-weight:500;margin-bottom:1rem; width: 100%; transition: all .2s;}
.google-btn:hover { background-color: var(--bg-tertiary); border-color: var(--text-secondary); }

/* --- HEADER --- */
header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;height:64px;padding:0 24px;background:var(--bg-primary);border-bottom:1px solid var(--border-color)}
header .logo-container h1{font-size:22px;margin:0; font-weight: 700;}
header .logo-container p{margin:0;color:var(--text-secondary);font-size:12px}
.header-actions{display:flex;gap:.5rem;align-items:center}
.tab{background:transparent;color:var(--text-secondary);border:none;border-radius:8px;padding:8px 16px;cursor:pointer; font-weight: 500; font-size: 14px; text-decoration: none; transition: all .2s;}
.tab:hover{background:var(--bg-secondary);color:var(--text-primary)}
.tab.active{background:var(--bg-secondary);color:var(--accent-primary);font-weight:600}
.logout-btn{background:none; border: 1px solid var(--border-color); color: var(--text-secondary); cursor: pointer; padding: 6px 12px; border-radius: 8px; font-weight: 600; transition: all .2s;}
.logout-btn:hover { background: var(--accent-red); border-color: var(--accent-red); color: var(--accent-primary); }

/* --- GENERAL LAYOUT & COMPONENTS --- */
button, input, select, textarea { font-family: inherit; transition: all .2s ease-in-out; }
button:disabled{opacity:.6;cursor:not-allowed}
.btn-primary{background:var(--accent-primary);color:var(--bg-primary);border:none;padding:10px 16px;border-radius:8px;cursor:pointer; font-weight: 600; font-size: 14px; text-decoration: none; display: inline-block; text-align: center;}
body.light-theme .btn-primary { color: var(--bg-primary); }
.btn-primary:hover:not(:disabled) { opacity: 0.85; transform: translateY(-1px); }
.btn-secondary{background:transparent;color:var(--text-primary);border:1px solid var(--border-color);padding:10px 16px;border-radius:8px;cursor:pointer; font-weight: 500;}

main{display:flex;gap:24px;max-width:1200px;margin:32px auto;padding:0 24px}
.sidebar{width:280px;flex-shrink:0;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:24px;height:fit-content;position:sticky;top:88px}
.content{flex:1;min-width:0}

.card{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-bottom:24px}
.section-title{font-size:24px;font-weight:700;letter-spacing:-.5px;margin:0 0 16px}
.label{display:block;font-size:12px;font-weight: 500; color:var(--text-secondary);margin:12px 0 8px; text-transform: uppercase; letter-spacing: .5px;}
.input, select, textarea{width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-color);background:var(--bg-primary);color:var(--text-primary);font-size: 1rem;}
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--focus-ring-color); }
.row{display:flex;gap:12px}
.row > *{flex:1}

.list{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.tile{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:8px; transition: all .2s;}
.tile:hover { transform: translateY(-4px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
.tile .muted{color:var(--text-secondary);font-size:13px; line-height: 1.5;}
.badge{border:1px solid var(--border-color);border-radius:999px;padding:4px 10px;font-size:11px;color:var(--text-secondary);width:max-content; font-weight: 500;}

/* --- MODALS --- */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);align-items:center;justify-content:center;padding:16px; z-index: 1002;}
.modal .dialog{width:min(500px,96vw);background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:16px;padding:24px;animation: slideInUp .3s ease-out both;}
@keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; }}
.modal .dialog header{position:static;height:auto;padding:0;background:transparent;border:none;display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.modal .dialog header h3 { margin: 0; font-size: 20px; font-weight: 600;}
.close-button{background:transparent;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer; padding: 0;}
.modal .dialog .footer{display:flex;gap:8px;justify-content:flex-end;margin-top:24px}

/* --- PROGRESS BAR --- */
#progressWrapper { display: none; margin-top: 16px; }
#uploadProgress {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    border: none;
    background-color: var(--bg-tertiary);
}
#uploadProgress::-webkit-progress-bar { background-color: var(--bg-tertiary); border-radius: 4px; }
#uploadProgress::-webkit-progress-value { background-color: var(--accent-primary); border-radius: 4px; transition: width 0.3s ease; }
#uploadProgress::-moz-progress-bar { background-color: var(--accent-primary); border-radius: 4px; }
.progress-text { font-size: 12px; color: var(--text-secondary); margin-top: 4px; text-align: right; }

@media (max-width: 900px){ main{flex-direction:column} .sidebar{position:static;width:auto} }
@media (max-width: 768px) {
    #authWrapper { flex-direction: column; }
    .login-left-panel, .login-right-panel { width: 100%; height: 50%; }
    .login-left-panel h1 { font-size: 2.5rem; }
    .login-left-panel p { font-size: 1rem; }
}
</style>
</head>
<body>
  <div id="authWrapper">
    <div class="login-card">
      <h2 style="margin:0 0 8px">Sign in</h2>
      <p class="helper" style="margin-top:0">Use Google to continue.</p>
      <p class="helper" style="margin-top:0">A journey of a thousand miles begins with a single step.</p>
      <button id="googleSignInButton" class="google-btn">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" width="18" height="18"/>
        <span>Sign in with Google</span>
      </button>
      <div id="codeEntry" style="margin-top:12px;display:none">
        <label class="label">Enter Access Code</label>
        <input id="accessCodeInput" class="input" placeholder="Teacher or Student code"/>
        <button id="submitCodeButton" class="btn-primary" style="width:100%;margin-top:8px">Submit Code</button>
        <p id="codeError" class="helper" style="color:var(--accent-red)"></p>
      </div>
      <p id="authError" class="helper" style="color:var(--accent-red)"></p>
    </div>
  </div>

  <div id="app" style="display:none">
    <header>
      <div class="logo-container">
        <h1>AI Marker</h1>
        <p>Operated by Darren Ng</p>
      </div>
      <div class="header-actions">
        <a href="index.html" class="tab">Home</a>
        <button id="themeToggleButton" class="tab">Theme</button>
        <span id="userDisplayName" class="helper"></span>
        <button id="switchRoleButton" class="tab">Switch Role</button>
        <button id="logoutButton" class="logout-btn">Log Out</button>
      </div>
    </header>

    <main>
      <!-- Left: Teacher builder + Filters -->
      <aside class="sidebar">
        <h3 class="section-title">Setup Tasks</h3>
        <p class="helper" id="roleNote">Only teachers can create or edit.</p>
        <label class="label">Subject</label>
        <div class="row">
          <select id="subjectSelect"></select>
          <button id="addSubjectBtn" class="btn-secondary" title="Create Subject">＋</button>
        </div>
        <label class="label">Topic</label>
        <div class="row">
          <select id="topicSelect" disabled></select>
          <button id="addTopicBtn" class="btn-secondary" title="Create Topic">＋</button>
        </div>
        <button id="addTaskBtn" class="btn-primary" style="width:100%;margin-top:8px" disabled>Create Task</button>
        <hr style="border:none;border-top:1px solid var(--border-color);margin:16px 0">
        <h3 class="section-title">For Students</h3>
        <p class="helper">Pick a subject & topic to submit.</p>
        <div class="row">
          <select id="studentSubjectFilter"></select>
          <select id="studentTopicFilter" disabled></select>
        </div>
      </aside>

      <!-- Right: Task list + Submission + Dashboards -->
      <section class="content">
        <div class="card">
          <h3 class="section-title">Open Tasks</h3>
          <div id="taskList" class="list"></div>
        </div>

        <div class="card">
          <h3 class="section-title">My Submissions</h3>
          <div id="mySubmissions" class="list"></div>
        </div>

        <div class="card" id="teacherDashboard" style="display:none">
          <h3 class="section-title">Teacher Dashboard — Submissions</h3>
          <div class="row">
            <select id="tdSubject"></select>
            <select id="tdTopic" disabled></select>
            <select id="tdTask" disabled></select>
          </div>
          <div id="submissionsList" style="margin-top:12px"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modals -->
  <div id="subjectModal" class="modal"><div class="dialog">
    <header><h3>Create Subject</h3><button class="close-button" data-close>×</button></header>
    <label class="label">Subject name</label>
    <input id="subjectName" class="input" placeholder="e.g., Mathematics"/>
    <div class="footer">
      <button class="btn-secondary" data-close>Cancel</button>
      <button id="saveSubject" class="btn-primary">Save</button>
    </div>
  </div></div>

  <div id="topicModal" class="modal"><div class="dialog">
    <header><h3>Create Topic</h3><button class="close-button" data-close>×</button></header>
    <p class="helper" id="topicModalSubject"></p>
    <label class="label">Topic name</label>
    <input id="topicName" class="input" placeholder="e.g., Algebra"/>
    <div class="footer">
      <button class="btn-secondary" data-close>Cancel</button>
      <button id="saveTopic" class="btn-primary">Save</button>
    </div>
  </div></div>

  <div id="taskModal" class="modal"><div class="dialog">
    <header><h3 id="taskModalTitle">Create Task</h3><button class="close-button" data-close>×</button></header>
    <div class="row"><input id="taskTitle" class="input" placeholder="Task title"><input id="taskDue" class="input" type="date"></div>
    <label class="label">Description</label>
    <textarea id="taskDesc" class="input" rows="5" placeholder="Brief instructions for this task"></textarea>
    
    <!-- NEW: Submission URL Field -->
    <label class="label">Submission Link (Optional)</label>
    <input id="taskSubmissionUrl" class="input" placeholder="e.g., https://forms.gle/your-link"/>
    
    <label class="label">Solution (Optional)</label>
    <div id="taskExistingSolution" class="helper" style="text-align:left; margin-bottom: 8px; font-size: 13px; line-height: 1.6;"></div>
    
    <label class="label" style="margin-top:0;">Upload File</label>
    <input id="taskSolutionFile" type="file" class="input"/>
    <div id="solutionProgressWrapper" style="display: none; margin-top: 8px;">
        <progress id="solutionUploadProgress" value="0" max="100" style="width: 100%;"></progress>
        <p class="progress-text" id="solutionProgressText">Uploading 0%</p>
    </div>

    <label class="label">Or Enter Text</label>
    <textarea id="taskSolutionText" class="input" rows="4" placeholder="Type or paste solution text here"></textarea>

    <div class="footer">
      <button class="btn-secondary" data-close>Cancel</button>
      <button id="saveTask" class="btn-primary">Save</button>
    </div>
  </div></div>

  <div id="submitModal" class="modal"><div class="dialog">
    <header><h3 id="submitModalTitle">Submit Homework</h3><button class="close-button" data-close>×</button></header>
    <div id="submitTaskMeta" class="helper" style="margin-bottom:8px"></div>
    <label class="label">Upload file (PDF/Image) or paste an external link</label>
    <input id="submissionFile" type="file" accept="application/pdf,image/*" class="input"/>
    <label class="label">or Link</label>
    <input id="submissionLink" class="input" placeholder="https://..."/>
    <label class="label">Optional Text Answer</label>
    <textarea id="submissionText" class="input" rows="4" placeholder="Paste your answer here (optional)"></textarea>
    <div class="footer">
      <button class="btn-secondary" data-close>Cancel</button>
      <button id="sendSubmission" class="btn-primary">Submit</button>
    </div>
  </div></div>

  <div id="previewModal" class="modal"><div class="dialog">
    <header><h3 id="previewTitle">Preview</h3><button class="close-button" data-close>×</button></header>
    <div class="preview" id="previewBody">No preview</div>
    <div class="footer"><button class="btn-secondary" data-close>Close</button></div>
  </div></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, getDocs, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // --- Firebase Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
      authDomain: "ai-grading-9bb30.firebaseapp.com",
      projectId: "ai-grading-9bb30",
      storageBucket: "ai-grading-9bb30.appspot.com",
      messagingSenderId: "298162112230",
      appId: "1:298162112230:web:529d3f95536991be685d27",
      measurementId: "G-CHKLKSM17S"
    };
    const TEACHER_CODE = "Derren0625";
    const STUDENT_CODE = "STUDENT456";
    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // UI helpers
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const modals = $$('.modal');
    modals.forEach(m=> m.addEventListener('click', (e)=>{ if(e.target===m || e.target.dataset.close!==undefined){ m.style.display='none'; }}));
    const open = (m)=> m.style.display='flex';

    // Theme
    const themeToggleButton = $('#themeToggleButton');
    const applyTheme = (t)=> document.body.classList.toggle('light-theme', t==='light');
    const loadTheme = ()=> { const t=localStorage.getItem('ai-marker-theme')||'dark'; applyTheme(t); };
    loadTheme(); themeToggleButton?.addEventListener('click', ()=>{ const t=document.body.classList.contains('light-theme')?'dark':'light'; localStorage.setItem('ai-marker-theme', t); applyTheme(t); });

    // State
    let currentUser = null; let currentRole = null; let currentProfileRef = null;
    let selectedSubjectId = null; let selectedTopicId = null; let editingTask = null;

    // Paths
    const subjectsCol = () => collection(db, `artifacts/${appId}/public/data/subjects`);
    const topicsCol   = (subjectId) => collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics`);
    const tasksCol    = (subjectId, topicId) => collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics/${topicId}/tasks`);
    const allSubsCol  = () => collection(db, `artifacts/${appId}/public/data/all_submissions`);

    // Auth UI elements
    const authWrapper = $('#authWrapper');
    const appRoot = $('#app');
    const googleBtn = $('#googleSignInButton');
    const codeEntry = $('#codeEntry');
    const codeInput = $('#accessCodeInput');
    const codeSubmit = $('#submitCodeButton');
    const codeError = $('#codeError');
    const userNameSpan = $('#userDisplayName');

    googleBtn.addEventListener('click', async ()=>{
      try{
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      }catch(e){ $('#authError').textContent = e.message; }
    });

    codeSubmit.addEventListener('click', ()=> handleSubmitCode());
    codeInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); handleSubmitCode(); }});

    async function handleSubmitCode(){
      codeError.textContent=''; const code=(codeInput.value||'').trim();
      if(!code) { codeError.textContent='Enter a code.'; return; }
      const role = (code===TEACHER_CODE) ? 'teacher' : (code===STUDENT_CODE ? 'student' : null);
      if(!role){ codeError.textContent='Invalid code.'; return; }
      if(!currentUser){ codeError.textContent='Sign in first.'; return; }
      try{
        await setDoc(currentProfileRef, { role, name: currentUser.displayName || '', email: currentUser.email || '', updatedAt: Date.now() }, { merge:true });
        currentRole = role; renderAfterAuth();
      }catch(e){ codeError.textContent = e.message; }
    }

    $('#logoutButton').addEventListener('click', ()=> signOut(auth));
    $('#switchRoleButton').addEventListener('click', ()=>{ codeEntry.style.display='block'; codeInput.focus(); });

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUser = user; currentProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
        const snap = await getDoc(currentProfileRef);
        if(snap.exists() && snap.data().role){ currentRole = snap.data().role; }
        authWrapper.style.display='none'; appRoot.style.display='block';
        userNameSpan.textContent = `${user.displayName||user.email} (${currentRole||'unassigned'})`;
        if(!currentRole){ codeEntry.style.display='block'; }
        renderAfterAuth();
      }else{
        currentUser=null; currentRole=null; authWrapper.style.display='flex'; appRoot.style.display='none'; codeEntry.style.display='none';
      }
    });

    function canTeach(){ return currentRole==='teacher'; }

    // Populate selects
    async function loadSubjects(selectEl){
      selectEl.innerHTML = '<option value="">— Select Subject —</option>';
      const qSnap = await getDocs(query(subjectsCol(), orderBy('name','asc'))).catch(()=>({docs:[]}));
      qSnap.docs.forEach(d=>{ const opt=document.createElement('option'); opt.value=d.id; opt.textContent=d.data().name; selectEl.appendChild(opt); });
    }
    async function loadTopics(subjectId, selectEl){
      selectEl.innerHTML = '<option value="">— Select Topic —</option>';
      if(!subjectId){ selectEl.disabled = true; return; }
      const qSnap = await getDocs(query(topicsCol(subjectId), orderBy('name','asc'))).catch(()=>({docs:[]}));
      qSnap.docs.forEach(d=>{ const opt=document.createElement('option'); opt.value=d.id; opt.textContent=d.data().name; selectEl.appendChild(opt); });
      selectEl.disabled = false;
    }

    // Sidebar binds
    const subjectSelect = $('#subjectSelect');
    const topicSelect = $('#topicSelect');
    const addSubjectBtn = $('#addSubjectBtn');
    const addTopicBtn = $('#addTopicBtn');
    const addTaskBtn = $('#addTaskBtn');
    const sFilter = $('#studentSubjectFilter');
    const tFilter = $('#studentTopicFilter');
    const tdSubject = $('#tdSubject');
    const tdTopic = $('#tdTopic');
    const tdTask = $('#tdTask');

    addSubjectBtn.addEventListener('click', ()=>{ if(!canTeach()) return alert('Teachers only'); $('#subjectName').value=''; open($('#subjectModal')); });
    addTopicBtn.addEventListener('click', ()=>{ if(!canTeach()) return alert('Teachers only'); if(!selectedSubjectId) return alert('Pick a subject first'); $('#topicName').value=''; $('#topicModalSubject').textContent = `Under: ${subjectSelect.options[subjectSelect.selectedIndex]?.textContent||''}`; open($('#topicModal')); });
    addTaskBtn.addEventListener('click', ()=> openTaskModal());

    $('#saveSubject').addEventListener('click', async ()=>{
      const name = ($('#subjectName').value||'').trim(); if(!name) return;
      await addDoc(subjectsCol(), { name, createdAt: Date.now() });
      $('#subjectModal').style.display='none'; await Promise.all([loadSubjects(subjectSelect), loadSubjects(sFilter), loadSubjects(tdSubject)]);
    });

    $('#saveTopic').addEventListener('click', async ()=>{
      const name = ($('#topicName').value||'').trim(); if(!name || !selectedSubjectId) return;
      await addDoc(topicsCol(selectedSubjectId), { name, createdAt: Date.now() });
      $('#topicModal').style.display='none'; await Promise.all([loadTopics(selectedSubjectId, topicSelect), loadTopics(selectedSubjectId, tFilter), loadTopics(selectedSubjectId, tdTopic)]);
    });

    // Task modal
    function openTaskModal(task = null){
      if(!canTeach()){ alert('Teachers only'); return; }
      if(!selectedSubjectId || !selectedTopicId){ alert('Pick subject & topic first'); return; }
      editingTask = task;
      $('#taskModalTitle').textContent = editingTask ? 'Edit Task' : 'Create Task';
      $('#taskTitle').value = editingTask?.title || '';
      $('#taskDesc').value = editingTask?.description || '';
      const d = editingTask?.dueDate ? new Date(editingTask.dueDate) : null;
      $('#taskDue').value = d? new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10) : '';
      
      // MODIFIED: Populate submission URL
      $('#taskSubmissionUrl').value = editingTask?.submissionUrl || '';

      // Handle solution file and text display
      $('#taskSolutionFile').value = '';
      $('#taskSolutionText').value = editingTask?.solutionText || '';
      $('#solutionProgressWrapper').style.display = 'none';
      const existingSolutionDiv = $('#taskExistingSolution');
      existingSolutionDiv.innerHTML = ''; // Clear previous

      if (editingTask?.solutionUrl && editingTask?.solutionFileName) {
        existingSolutionDiv.innerHTML += `<div>Current File: <a href="${editingTask.solutionUrl}" target="_blank">${editingTask.solutionFileName}</a> <button data-act="remove-file-solution" style="color:var(--accent-red); background:none; border:none; cursor:pointer; font-weight:bold;">&times;</button></div>`;
      }
      if (editingTask?.solutionText) {
        existingSolutionDiv.innerHTML += `<div>Current Text: <em>"${editingTask.solutionText.substring(0, 50)}..."</em> <button data-act="remove-text-solution" style="color:var(--accent-red); background:none; border:none; cursor:pointer; font-weight:bold;">&times;</button></div>`;
      }
      
      if (existingSolutionDiv.innerHTML === '') {
        existingSolutionDiv.innerHTML = 'No solution provided yet.';
      }

      existingSolutionDiv.querySelector('[data-act="remove-file-solution"]')?.addEventListener('click', removeFileSolution);
      existingSolutionDiv.querySelector('[data-act="remove-text-solution"]')?.addEventListener('click', removeTextSolution);
      
      open($('#taskModal'));
    }

    async function removeFileSolution(e) {
        e.preventDefault();
        if (!editingTask || !editingTask.solutionFilePath) return;
        if (!confirm('Are you sure you want to remove the solution file?')) return;
        
        try {
            await deleteObject(ref(storage, editingTask.solutionFilePath));
        } catch (error) {
            console.error("Error removing old solution file:", error);
        }

        const taskRef = doc(db, tasksCol(selectedSubjectId, selectedTopicId).path, editingTask.id);
        await updateDoc(taskRef, {
            solutionUrl: null,
            solutionFileName: null,
            solutionFilePath: null
        });
        
        editingTask.solutionUrl = null;
        editingTask.solutionFileName = null;
        editingTask.solutionFilePath = null;
        openTaskModal(editingTask); // Re-render modal content
        renderTasksForFilters();
    }
    
    async function removeTextSolution(e) {
        e.preventDefault();
        if (!editingTask) return;
        if (!confirm('Are you sure you want to remove the solution text?')) return;
        
        const taskRef = doc(db, tasksCol(selectedSubjectId, selectedTopicId).path, editingTask.id);
        await updateDoc(taskRef, { solutionText: null });

        editingTask.solutionText = null;
        openTaskModal(editingTask); // Re-render modal content
        renderTasksForFilters();
    }
    
    $('#saveTask').addEventListener('click', async ()=>{
      const title = ($('#taskTitle').value||'').trim(); if(!title) return;
      const description = ($('#taskDesc').value||'').trim();
      const due = ($('#taskDue').value||'').trim();
      const dueMs = due? new Date(due+'T23:59:59').getTime() : null;
      const solutionFile = $('#taskSolutionFile').files[0];
      const solutionText = ($('#taskSolutionText').value || '').trim();

      // MODIFIED: Get submission URL
      const submissionUrl = ($('#taskSubmissionUrl').value || '').trim();
      
      const payload = { 
        title, 
        description, 
        dueDate: dueMs,
        submissionUrl: submissionUrl || null, // Add to payload
        updatedAt: serverTimestamp(),
        ...(editingTask ? {} : { createdAt: serverTimestamp() }),
        solutionUrl: editingTask?.solutionUrl || null,
        solutionFileName: editingTask?.solutionFileName || null,
        solutionFilePath: editingTask?.solutionFilePath || null,
        solutionText: solutionText || (editingTask ? editingTask.solutionText : null),
      };

      if (solutionText) {
          payload.solutionText = solutionText;
      } else if (editingTask) {
          payload.solutionText = null; // Explicitly clear if field is empty
      }

      const taskRef = editingTask ? doc(db, tasksCol(selectedSubjectId, selectedTopicId).path, editingTask.id) : doc(collection(tasksCol(selectedSubjectId, selectedTopicId)));
      
      const saveButton = $('#saveTask');
      saveButton.disabled = true;
      saveButton.textContent = 'Saving...';

      const finishSave = (isSuccess) => {
        if (isSuccess) {
            $('#taskModal').style.display = 'none';
            renderTasksForFilters();
            loadTasksForTD();
        }
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
      };

      try {
        if (solutionFile) {
            if (editingTask?.solutionFilePath) {
                try { await deleteObject(ref(storage, editingTask.solutionFilePath)); } catch(e) { console.warn("Old solution not found, continuing.", e); }
            }

            const filePath = `solutions/${selectedSubjectId}/${selectedTopicId}/${taskRef.id}/${solutionFile.name}`;
            const storageRef = ref(storage, filePath);
            const uploadTask = uploadBytesResumable(storageRef, solutionFile);

            $('#solutionProgressWrapper').style.display = 'block';
            
            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    $('#solutionUploadProgress').value = progress;
                    $('#solutionProgressText').textContent = `Uploading ${Math.round(progress)}%`;
                }, 
                (error) => {
                    console.error("Upload failed:", error);
                    alert('Solution upload failed.');
                    finishSave(false);
                }, 
                async () => {
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                    payload.solutionUrl = downloadURL;
                    payload.solutionFileName = solutionFile.name;
                    payload.solutionFilePath = filePath;
                    await setDoc(taskRef, payload, { merge: true });
                    finishSave(true);
                }
            );
        } else {
            if(editingTask) { await updateDoc(taskRef, payload); } else { await setDoc(taskRef, payload); }
            finishSave(true);
        }
      } catch (e) {
          console.error("Error saving task:", e);
          alert('Failed to save task.');
          finishSave(false);
      }
    });

    // Select changes
    subjectSelect.addEventListener('change', async (e)=>{ selectedSubjectId = e.target.value||null; await loadTopics(selectedSubjectId, topicSelect); topicSelect.disabled=!selectedSubjectId; addTaskBtn.disabled = true; });
    topicSelect.addEventListener('change', (e)=>{ selectedTopicId = e.target.value||null; addTaskBtn.disabled = !selectedTopicId; });
    sFilter.addEventListener('change', async (e)=>{ await loadTopics(e.target.value, tFilter); tFilter.disabled = !e.target.value; renderTasksForFilters(); });
    tFilter.addEventListener('change', ()=> renderTasksForFilters());
    tdSubject.addEventListener('change', async (e)=>{ await loadTopics(e.target.value, tdTopic); tdTopic.disabled = !e.target.value; tdTask.disabled = true; $('#submissionsList').innerHTML=''; });
    tdTopic.addEventListener('change', ()=>{ tdTask.disabled = !tdTopic.value; loadTasksForTD(); });
    tdTask.addEventListener('change', ()=> loadSubmissionsForTD());

    // Render tasks
    async function renderTasksForFilters(){
      const container = $('#taskList'); container.innerHTML='';
      const subj = sFilter.value; const top = tFilter.value; if(!subj || !top){ container.innerHTML='<p class="helper">Pick a subject & topic.</p>'; return; }
      const qSnap = await getDocs(query(tasksCol(subj, top), orderBy('createdAt','desc'))).catch(()=>({docs:[]}));
      if(qSnap.docs.length===0){ container.innerHTML='<p class="helper">No tasks yet.</p>'; return; }
      qSnap.docs.forEach(d=>{
        const t = d.data(); t.id = d.id;
        const dueTxt = t.dueDate? new Date(t.dueDate).toLocaleDateString() : '—';
        const tile = document.createElement('div'); tile.className='tile';
        
        // MODIFIED: Conditional submit button/link
        let submitActionHtml = '';
        if (t.submissionUrl) {
            submitActionHtml = `<a href="${t.submissionUrl}" target="_blank" rel="noopener noreferrer" class="btn-primary">Go to Submission Link</a>`;
        } else {
            submitActionHtml = `<button class="btn-primary" data-act="submit">Submit Here</button>`;
        }

        tile.innerHTML = `
          <div class="badge">Due: ${dueTxt}</div>
          <strong>${t.title}</strong>
          <div class="muted">${(t.description||'').substring(0,160)}</div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:auto;padding-top:8px;">
            ${submitActionHtml}
            ${canTeach()? '<button class="btn-secondary" data-act="edit">Edit</button><button class="logout-btn" data-act="delete">Delete</button>' : ''}
          </div>`;
        
        // MODIFIED: Only add listener if it's the modal button
        if (!t.submissionUrl) {
          tile.querySelector('[data-act="submit"]').addEventListener('click', ()=> openSubmission(t, subj, top));
        }

        if(canTeach()){
          tile.querySelector('[data-act="edit"]').addEventListener('click', ()=> { selectedSubjectId = subj; selectedTopicId = top; openTaskModal(t); });
          tile.querySelector('[data-act="delete"]').addEventListener('click', async ()=>{
            if(!confirm('Delete this task?')) return; 
            if (t.solutionFilePath) {
                try { await deleteObject(ref(storage, t.solutionFilePath)); } catch(e){ console.warn("Could not delete solution file", e); }
            }
            await deleteDoc(doc(db, tasksCol(subj, top).path, d.id)); 
            renderTasksForFilters(); 
            loadTasksForTD();
          });
        }
        container.appendChild(tile);
      });
    }

    let submittingTaskCtx = null;
    function openSubmission(task, subjectId, topicId){
      submittingTaskCtx = { task, subjectId, topicId };
      $('#submitModalTitle').textContent = `Submit: ${task.title}`;
      const dueTxt = task.dueDate? new Date(task.dueDate).toLocaleString() : '—';
      $('#submitTaskMeta').textContent = `Subject: ${$('#studentSubjectFilter').selectedOptions[0]?.textContent || ''} • Topic: ${$('#studentTopicFilter').selectedOptions[0]?.textContent || ''} • Due: ${dueTxt}`;
      $('#submissionFile').value = ''; $('#submissionLink').value=''; $('#submissionText').value='';
      open($('#submitModal'));
    }

    $('#sendSubmission').addEventListener('click', async ()=>{
      if(!submittingTaskCtx || !currentUser) return;
      const file = $('#submissionFile').files[0] || null;
      const link = ($('#submissionLink').value||'').trim();
      const text = ($('#submissionText').value||'').trim();
      if(!file && !link && !text){ alert('Attach a file, link, or enter text.'); return; }
      
      const sendBtn = $('#sendSubmission');
      sendBtn.disabled = true;
      sendBtn.textContent = 'Submitting...';

      let fileLink = '', filePath = '';
      if(file){
        const path = `submissions/${currentUser.uid}/${Date.now()}_${file.name}`;
        try {
            const uploadTask = uploadBytesResumable(ref(storage, path), file);
            await uploadTask;
            fileLink = await getDownloadURL(uploadTask.snapshot.ref); 
            filePath = path;
        } catch(e) {
            console.error(e);
            alert('File upload failed.');
            sendBtn.disabled = false; sendBtn.textContent = 'Submit';
            return;
        }
      }
      const payloadUser = {
        assignmentTitle: submittingTaskCtx.task.title,
        subjectId: submittingTaskCtx.subjectId,
        topicId: submittingTaskCtx.topicId,
        taskId: submittingTaskCtx.task.id,
        submittedAt: Date.now(),
        fileLink: fileLink || (link||''),
        fileName: file? file.name : (link? 'External Link' : ''),
        filePath: filePath,
        textAnswer: text||''
      };
      const userSubRef = await addDoc(collection(db, `artifacts/${appId}/users/${currentUser.uid}/submissions`), payloadUser);
      await addDoc(allSubsCol(), {
        ...payloadUser,
        submissionId: userSubRef.id,
        studentId: currentUser.uid,
        studentName: currentUser.displayName || currentUser.email || 'Student',
        status: 'submitted',
        score: null,
        feedback: '',
        createdAt: serverTimestamp()
      });
      $('#submitModal').style.display='none';
      sendBtn.disabled = false; sendBtn.textContent = 'Submit';
      renderMySubmissions();
      alert('Submitted!');
    });

    async function renderMySubmissions(){
      const list = $('#mySubmissions'); list.innerHTML='';
      if(!currentUser) return;
      const subSnap = await getDocs(query(collection(db, `artifacts/${appId}/users/${currentUser.uid}/submissions`), orderBy('submittedAt','desc'))).catch(()=>({docs:[]}));
      if(subSnap.docs.length===0){ list.innerHTML = '<p class="helper">No submissions yet.</p>'; return; }
      
      const tasksToFetch = {};
      subSnap.docs.forEach(doc => {
          const sub = doc.data();
          if (!tasksToFetch[sub.topicId]) {
              tasksToFetch[sub.topicId] = { subjectId: sub.subjectId, tasks: new Set() };
          }
          tasksToFetch[sub.topicId].tasks.add(sub.taskId);
      });

      const taskDataMap = new Map();
      for (const topicId in tasksToFetch) {
          const { subjectId } = tasksToFetch[topicId];
          const tasksSnap = await getDocs(tasksCol(subjectId, topicId));
          tasksSnap.forEach(doc => taskDataMap.set(doc.id, doc.data()));
      }

      subSnap.docs.forEach(d=>{
        const s = d.data();
        const taskInfo = taskDataMap.get(s.taskId);
        
        const card = document.createElement('div'); card.className='tile';
        card.innerHTML = `
          <strong>${s.assignmentTitle}</strong>
          <div class="muted">${new Date(s.submittedAt).toLocaleString()}</div>
          <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;">
            ${s.fileLink? `<a class="btn-secondary" href="${s.fileLink}" target="_blank">Open Submission</a>`: ''}
            ${s.textAnswer? `<button class="btn-secondary" data-act="view-text">View Text</button>`: ''}
            ${taskInfo?.solutionUrl ? `<a href="${taskInfo.solutionUrl}" target="_blank" class="btn-secondary">Solution File</a>` : ''}
            ${taskInfo?.solutionText ? `<button class="btn-primary" data-act="view-solution-text">Solution Text</button>` : ''}
          </div>
          <div style="margin-top:auto; padding-top:8px;">
            <button class="logout-btn" data-act="delete">Delete</button>
          </div>`;
        card.querySelector('[data-act="delete"]').addEventListener('click', async ()=>{
          if(!confirm('Delete this submission?')) return;
          if(s.filePath){ try{ await deleteObject(ref(storage, s.filePath)); }catch(_){} }
          await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/submissions`, d.id));
          renderMySubmissions();
        });
        if(s.textAnswer){ card.querySelector('[data-act="view-text"]').addEventListener('click', ()=>{ $('#previewTitle').textContent=s.assignmentTitle; $('#previewBody').textContent=s.textAnswer; open($('#previewModal')); }); }
        if(taskInfo?.solutionText){ card.querySelector('[data-act="view-solution-text"]').addEventListener('click', ()=>{ $('#previewTitle').textContent=`Solution: ${s.assignmentTitle}`; $('#previewBody').textContent=taskInfo.solutionText; open($('#previewModal')); }); }
        list.appendChild(card);
      });
    }

    // Teacher dashboard
    async function loadTasksForTD(){
      tdTask.innerHTML = '<option value="">— Task —</option>';
      if(!tdSubject.value || !tdTopic.value){ tdTask.disabled=true; return; }
      const snap = await getDocs(query(tasksCol(tdSubject.value, tdTopic.value), orderBy('createdAt','desc'))).catch(()=>({docs:[]}));
      snap.docs.forEach(d=>{ const opt=document.createElement('option'); opt.value=d.id; opt.textContent=d.data().title; tdTask.appendChild(opt); });
      tdTask.disabled = false; loadSubmissionsForTD();
    }

    async function loadSubmissionsForTD(){
      const container = $('#submissionsList'); container.innerHTML='';
      if(!tdSubject.value || !tdTopic.value || !tdTask.value){ return; }
      const snap = await getDocs(query(allSubsCol(), where('taskId', '==', tdTask.value), orderBy('createdAt','desc'))).catch(()=>({docs:[]}));
      if(snap.docs.length===0){ container.innerHTML = '<p class="helper">No submissions for this task yet.</p>'; return; }
      snap.docs.forEach(d=>{
        const s = d.data();
        const row = document.createElement('div'); row.className='card';
        row.innerHTML = `
          <div class="row" style="align-items:center">
            <div style="flex:2">
              <strong>${s.studentName}</strong>
              <div class="muted">${new Date(s.submittedAt).toLocaleString()}</div>
              ${s.fileLink? `<a class="btn-secondary" href="${s.fileLink}" target="_blank">Open File/Link</a>`: ''}
              ${s.textAnswer? `<button class="btn-secondary" data-act="view-text">View Text</button>`: ''}
            </div>
            <div style="flex:1">
              <label class="label">Status</label>
              <select data-field="status" class="input">
                ${['submitted','reviewing','graded'].map(v=>`<option value="${v}" ${s.status===v?'selected':''}>${v}</option>`).join('')}
              </select>
            </div>
            <div style="flex:1">
              <label class="label">Score</label>
              <input data-field="score" class="input" type="number" step="1" min="0" max="100" value="${s.score??''}"/>
            </div>
          </div>
          <label class="label">Feedback</label>
          <textarea data-field="feedback" class="input" rows="2">${s.feedback||''}</textarea>
          <div class="footer" style="justify-content:flex-start">
            <button class="btn-primary" data-act="save">Save</button>
            <button class="logout-btn" data-act="delete">Delete (log)</button>
          </div>`;
        if(s.textAnswer){ row.querySelector('[data-act="view-text"]').addEventListener('click', ()=>{ $('#previewTitle').textContent=`${s.studentName} — Text`; $('#previewBody').textContent=s.textAnswer; open($('#previewModal')); }); }
        row.querySelector('[data-act="save"]').addEventListener('click', async ()=>{
          await updateDoc(doc(db, allSubsCol().path, d.id), {
            status: row.querySelector('[data-field="status"]').value,
            score: row.querySelector('[data-field="score"]').value || null,
            feedback: row.querySelector('[data-field="feedback"]').value
          });
          alert('Saved');
        });
        row.querySelector('[data-act="delete"]').addEventListener('click', async ()=>{
          if(!confirm('Delete this log entry?')) return; await deleteDoc(doc(db, allSubsCol().path, d.id)); loadSubmissionsForTD();
        });
        container.appendChild(row);
      });
    }

    function renderAfterAuth(){
      $('#teacherDashboard').style.display = canTeach()? 'block':'none';
      $('#roleNote').textContent = canTeach()? 'You are a teacher.' : 'Only teachers can create or edit.';
      Promise.all([
        loadSubjects(subjectSelect), loadSubjects(sFilter), loadSubjects(tdSubject)
      ]).then(()=>{
        if(subjectSelect.value){ loadTopics(subjectSelect.value, topicSelect); }
        if(sFilter.value){ loadTopics(sFilter.value, tFilter); }
        if(tdSubject.value){ loadTopics(tdSubject.value, tdTopic); }
      });
      renderTasksForFilters();
      renderMySubmissions();
    }
  </script>
</body>
</html>
