<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI Marker â€” Submissions</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* --- MODERN BLACK & WHITE THEME (Adapted from index (8).html) --- */
:root {
    --bg-primary: #0a0a0a; /* Near black for main background */
    --bg-secondary: #1a1a1a; /* Dark gray for secondary elements */
    --bg-tertiary: #2a2a2a; /* Lighter gray for hovers */
    --text-primary: #f5f5f5; /* Off-white for primary text */
    --text-secondary: #a3a3a3; /* Muted gray for secondary text */
    --accent-primary: #ffffff; /* White for key actions and highlights */
    --accent-red: #ef4444; /* A modern, sharp red for destructive actions */
    --border-color: #333333; /* Subtle border color */
    --focus-ring-color: rgba(245, 245, 245, 0.5);
}

body.light-theme {
    --bg-primary: #ffffff;
    --bg-secondary: #f5f5f5;
    --bg-tertiary: #e5e5e5;
    --text-primary: #0a0a0a;
    --text-secondary: #737373;
    --accent-primary: #0a0a0a;
    --border-color: #d4d4d4;
    --focus-ring-color: rgba(10, 10, 10, 0.5);
}

*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg-primary); color:var(--text-primary); transition: background-color 0.3s, color 0.3s;}

/* --- LOGIN PAGE STYLES (From index (8).html) --- */
#authWrapper {
    display: none; /* Initially hidden */
    width: 100vw;
    height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1001;
    animation: fadeIn .5s ease-in-out;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.login-left-panel,
.login-right-panel {
    width: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 2rem;
}

.login-left-panel {
    background: var(--bg-primary);
    color: var(--text-primary);
    flex-direction: column;
    text-align: center;
}

.login-left-panel h1 {
    font-size: 3.5rem;
    font-weight: 700;
    letter-spacing: -1px;
    margin-bottom: 1rem;
}

.login-left-panel p {
    font-size: 1.25rem;
    font-weight: 400;
    line-height: 1.5;
    margin-bottom: .5rem;
    color: var(--text-secondary);
    max-width: 450px;
}

.login-right-panel {
    background: var(--bg-secondary);
    flex-direction: column;
}

.login-card {
    width: 100%;
    max-width: 380px;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    background-color: var(--bg-primary);
    padding: 2.5rem;
    border-radius: 12px;
    border: 1px solid var(--border-color);
}

.login-card h2 {
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    text-align: center;
}
.helper{font-size:14px;color:var(--text-secondary); margin-bottom: 1.5rem; text-align: center;}
.google-btn{display:flex;align-items:center;justify-content:center;gap:12px;border:1px solid var(--border-color);border-radius:8px;padding:.75rem;cursor:pointer;background:var(--bg-secondary);color:var(--text-primary);font-size:1rem;font-weight:500;margin-bottom:1rem; width: 100%; transition: all .2s;}
.google-btn:hover { background-color: var(--bg-tertiary); border-color: var(--text-secondary); }

/* --- HEADER --- */
header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;height:64px;padding:0 24px;background:var(--bg-primary);border-bottom:1px solid var(--border-color)}
header .logo-container h1{font-size:22px;margin:0; font-weight: 700;}
header .logo-container p{margin:0;color:var(--text-secondary);font-size:12px}
.header-actions{display:flex;gap:.5rem;align-items:center}
.tab{background:transparent;color:var(--text-secondary);border:none;border-radius:8px;padding:8px 16px;cursor:pointer; font-weight: 500; font-size: 14px; text-decoration: none; transition: all .2s;}
.tab:hover{background:var(--bg-secondary);color:var(--text-primary)}
.tab.active{background:var(--bg-secondary);color:var(--accent-primary);font-weight:600}
.logout-btn{background:none; border: 1px solid var(--border-color); color: var(--text-secondary); cursor: pointer; padding: 6px 12px; border-radius: 8px; font-weight: 600; transition: all .2s;}
.logout-btn:hover { background: var(--accent-red); border-color: var(--accent-red); color: var(--accent-primary); }

/* --- GENERAL LAYOUT & COMPONENTS --- */
button, input, select, textarea { font-family: inherit; transition: all .2s ease-in-out; }
button:disabled{opacity:.6;cursor:not-allowed}
.btn-primary{background:var(--accent-primary);color:var(--bg-primary);border:none;padding:10px 16px;border-radius:8px;cursor:pointer; font-weight: 600; font-size: 14px;}
body.light-theme .btn-primary { color: var(--bg-primary); }
.btn-primary:hover:not(:disabled) { opacity: 0.85; transform: translateY(-1px); }
.btn-secondary{background:transparent;color:var(--text-primary);border:1px solid var(--border-color);padding:10px 16px;border-radius:8px;cursor:pointer; font-weight: 500;}

main{display:flex;gap:24px;max-width:1200px;margin:32px auto;padding:0 24px}
.sidebar{width:280px;flex-shrink:0;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:24px;height:fit-content;position:sticky;top:88px}
.content{flex:1;min-width:0}

.card{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-bottom:24px}
.section-title{font-size:24px;font-weight:700;letter-spacing:-.5px;margin:0 0 16px}
.label{display:block;font-size:12px;font-weight: 500; color:var(--text-secondary);margin:12px 0 8px; text-transform: uppercase; letter-spacing: .5px;}
.input, select, textarea{width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-color);background:var(--bg-primary);color:var(--text-primary);font-size: 1rem;}
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--focus-ring-color); }
.row{display:flex;gap:12px}
.row > *{flex:1}

.list{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.tile{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:8px; transition: all .2s;}
.tile:hover { transform: translateY(-4px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
.tile .muted{color:var(--text-secondary);font-size:13px; line-height: 1.5;}
.badge{border:1px solid var(--border-color);border-radius:999px;padding:4px 10px;font-size:11px;color:var(--text-secondary);width:max-content; font-weight: 500;}

/* --- MODALS --- */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);align-items:center;justify-content:center;padding:16px; z-index: 1002;}
.modal .dialog{width:min(500px,96vw);background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:16px;padding:24px;animation: slideInUp .3s ease-out both;}
@keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; }}
.modal .dialog header{position:static;height:auto;padding:0;background:transparent;border:none;display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.modal .dialog header h3 { margin: 0; font-size: 20px; font-weight: 600;}
.close-button{background:transparent;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer; padding: 0;}
.modal .dialog .footer{display:flex;gap:8px;justify-content:flex-end;margin-top:24px}

/* --- PROGRESS BAR --- */
#progressWrapper { display: none; margin-top: 16px; }
#uploadProgress {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    border: none;
    background-color: var(--bg-tertiary);
}
#uploadProgress::-webkit-progress-bar { background-color: var(--bg-tertiary); border-radius: 4px; }
#uploadProgress::-webkit-progress-value { background-color: var(--accent-primary); border-radius: 4px; transition: width 0.3s ease; }
#uploadProgress::-moz-progress-bar { background-color: var(--accent-primary); border-radius: 4px; }
.progress-text { font-size: 12px; color: var(--text-secondary); margin-top: 4px; text-align: right; }

@media (max-width: 900px){ main{flex-direction:column} .sidebar{position:static;width:auto} }
@media (max-width: 768px) {
    #authWrapper { flex-direction: column; }
    .login-left-panel, .login-right-panel { width: 100%; height: 50%; }
    .login-left-panel h1 { font-size: 2.5rem; }
    .login-left-panel p { font-size: 1rem; }
}
</style>
</head>
<body>
  <!-- Login Screen -->
  <div id="authWrapper">
    <div class="login-left-panel">
        <h1>Submissions</h1>
        <p>Your dedication today is an investment in your future. Let's get this done!</p>
    </div>
    <div class="login-right-panel">
        <div class="login-card">
            <div id="signInContainer">
                <h2>Sign In</h2>
                <p class="helper">Use your school Google account to continue.</p>
                <button id="googleSignInButton" class="google-btn">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" width="18" height="18"/>
                    <span>Sign in with Google</span>
                </button>
                <p id="authError" class="helper" style="color:var(--accent-red)"></p>
            </div>
            <div id="codeEntryContainer" style="display:none">
                <h2>Enter Access Code</h2>
                <p class="helper">Enter the code provided by your teacher or administrator.</p>
                <input id="accessCodeInput" class="input" placeholder="Teacher or Student code" style="text-align: center;"/>
                <button id="submitCodeButton" class="btn-primary" style="width:100%;margin-top:8px">Submit Code</button>
                <p id="codeError" class="helper" style="color:var(--accent-red); margin-top: 8px;"></p>
            </div>
        </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" style="display:none">
    <header>
      <div class="logo-container">
        <h1>AI Marker</h1>
        <p>Operated by Darren Ng</p>
      </div>
      <div class="header-actions">
        <a href="index (8).html" class="tab">Home</a>
        <button id="themeToggleButton" class="tab">Theme</button>
        <span id="userDisplayName" class="helper" style="margin-bottom: 0;"></span>
        <button id="switchRoleButton" class="tab">Switch Role</button>
        <button id="logoutButton" class="logout-btn">Log Out</button>
      </div>
    </header>

    <main>
      <!-- Left: Teacher builder + Student Filters -->
      <aside class="sidebar">
        <h3 class="section-title">Setup Tasks</h3>
        <p class="helper" id="roleNote" style="text-align: left; margin-bottom: 1rem;">Only teachers can create or edit.</p>
        <label class="label">Subject</label>
        <div class="row">
          <select id="subjectSelect" class="input"></select>
          <button id="addSubjectBtn" class="btn-secondary" title="Create Subject">ï¼‹</button>
        </div>
        <label class="label">Topic</label>
        <div class="row">
          <select id="topicSelect" class="input" disabled></select>
          <button id="addTopicBtn" class="btn-secondary" title="Create Topic">ï¼‹</button>
        </div>
        <button id="addTaskBtn" class="btn-primary" style="width:100%;margin-top:16px" disabled>Create Task</button>
        <hr style="border:none;border-top:1px solid var(--border-color);margin:24px 0">
        <h3 class="section-title">Find Tasks</h3>
        <p class="helper" style="text-align: left; margin-bottom: 1rem;">Pick a subject & topic to view tasks and submit your work.</p>
        <label class="label">Filter by Subject</label>
        <select id="studentSubjectFilter" class="input"></select>
        <label class="label">Filter by Topic</label>
        <select id="studentTopicFilter" class="input" disabled></select>
      </aside>

      <!-- Right: Task list + Submission + Dashboards -->
      <section class="content">
        <div class="card">
          <h3 class="section-title">Open Tasks</h3>
          <div id="taskList" class="list"></div>
        </div>

        <div class="card">
          <h3 class="section-title">My Submissions</h3>
          <div id="mySubmissions" class="list"></div>
        </div>

        <div class="card" id="teacherDashboard" style="display:none">
          <h3 class="section-title">Teacher Dashboard â€” Submissions</h3>
          <div class="row">
            <select id="tdSubject" class="input"></select>
            <select id="tdTopic" class="input" disabled></select>
            <select id="tdTask" class="input" disabled></select>
          </div>
          <div id="submissionsList" style="margin-top:12px"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modals -->
  <div id="subjectModal" class="modal"><div class="dialog">
    <header><h3>Create Subject</h3><button class="close-button" data-close>Ã—</button></header>
    <label class="label">Subject name</label>
    <input id="subjectName" class="input" placeholder="e.g., Mathematics"/>
    <div class="footer">
      <button class="btn-secondary" data-close>Cancel</button>
      <button id="saveSubject" class="btn-primary">Save</button>
    </div>
  </div></div>

  <div id="topicModal" class="modal"><div class="dialog">
    <header><h3>Create Topic</h3><button class="close-button" data-close>Ã—</button></header>
    <p class="helper" id="topicModalSubject" style="text-align: left; margin-bottom: 1rem;"></p>
    <label class="label">Topic name</label>
    <input id="topicName" class="input" placeholder="e.g., Algebra"/>
    <div class="footer">
      <button class="btn-secondary" data-close>Cancel</button>
      <button id="saveTopic" class="btn-primary">Save</button>
    </div>
  </div></div>

  <div id="taskModal" class="modal"><div class="dialog">
    <header><h3 id="taskModalTitle">Create Task</h3><button class="close-button" data-close>Ã—</button></header>
    <div class="row"><input id="taskTitle" class="input" placeholder="Task title"><input id="taskDue" class="input" type="date"></div>
    <label class="label">Description</label>
    <textarea id="taskDesc" class="input" rows="5" placeholder="Brief instructions for this task"></textarea>
    <div class="footer">
      <button class="btn-secondary" data-close>Cancel</button>
      <button id="saveTask" class="btn-primary">Save</button>
    </div>
  </div></div>

  <div id="submitModal" class="modal"><div class="dialog">
    <header><h3 id="submitModalTitle">Submit Homework</h3><button class="close-button" data-close>Ã—</button></header>
    <div id="submitTaskMeta" class="helper" style="text-align: left; margin-bottom: 1rem;"></div>
    <label class="label">Upload file (PDF/Image)</label>
    <input id="submissionFile" type="file" accept="application/pdf,image/*" class="input"/>
    <label class="label">or Paste an External Link</label>
    <input id="submissionLink" class="input" placeholder="https://..."/>
    <label class="label">Optional Text Answer</label>
    <textarea id="submissionText" class="input" rows="4" placeholder="Paste your answer here (optional)"></textarea>
    
    <!-- Upload Progress Bar -->
    <div id="progressWrapper">
      <progress id="uploadProgress" value="0" max="100"></progress>
      <p id="progressText" class="progress-text">0%</p>
    </div>

    <p id="submitError" class="helper" style="color:var(--accent-red); text-align: left; display: none;"></p>

    <div class="footer">
      <button class="btn-secondary" data-close>Cancel</button>
      <button id="sendSubmission" class="btn-primary">Submit</button>
    </div>
  </div></div>

  <div id="previewModal" class="modal"><div class="dialog" style="width: min(720px, 96vw);">
    <header><h3 id="previewTitle">Preview</h3><button class="close-button" data-close>Ã—</button></header>
    <div class="preview" id="previewBody" style="background: var(--bg-primary); border-radius: 8px; padding: 16px; min-height: 120px; color: var(--text-secondary); white-space: pre-wrap; max-height: 60vh; overflow-y: auto;">No preview</div>
    <div class="footer"><button class="btn-secondary" data-close>Close</button></div>
  </div></div>

  <div id="notificationModal" class="modal"><div class="dialog">
      <header><h3 id="notificationTitle">Notification</h3><button class="close-button" data-close>Ã—</button></header>
      <p id="notificationMessage" style="color: var(--text-primary); line-height: 1.6;"></p>
      <div class="footer"><button class="btn-primary" data-close>OK</button></div>
  </div></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, getDocs, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // --- Firebase Configuration (from index (8)) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
      authDomain: "ai-grading-9bb30.firebaseapp.com",
      projectId: "ai-grading-9bb30",
      storageBucket: "ai-grading-9bb30.appspot.com",
      messagingSenderId: "298162112230",
      appId: "1:298162112230:web:529d3f95536991be685d27",
      measurementId: "G-CHKLKSM17S"
    };
    const TEACHER_CODE = "Derren0625";
    const STUDENT_CODE = "STUDENT456";
    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // UI helpers
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const modals = $$('.modal');
    modals.forEach(m=> m.addEventListener('click', (e)=>{ if(e.target===m || e.target.closest('[data-close]')){ m.style.display='none'; }}));
    const open = (m)=> m.style.display='flex';
    const showNotification = (title, message) => {
        $('#notificationTitle').textContent = title;
        $('#notificationMessage').textContent = message;
        open($('#notificationModal'));
    };

    // Theme
    const themeToggleButton = $('#themeToggleButton');
    const applyTheme = (t)=> document.body.classList.toggle('light-theme', t==='light');
    const loadTheme = ()=> { const t=localStorage.getItem('ai-marker-theme')||'dark'; applyTheme(t); };
    loadTheme(); themeToggleButton?.addEventListener('click', ()=>{ const t=document.body.classList.contains('light-theme')?'dark':'light'; localStorage.setItem('ai-marker-theme', t); applyTheme(t); });

    // State
    let currentUser = null; let currentRole = null; let currentProfileRef = null;
    let selectedSubjectId = null; let selectedTopicId = null; let editingTaskId = null; let submittingTaskCtx = null;

    // Firestore Paths
    const subjectsCol = () => collection(db, `artifacts/${appId}/public/data/subjects`);
    const topicsCol   = (subjectId) => collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics`);
    const tasksCol    = (subjectId, topicId) => collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics/${topicId}/tasks`);
    const allSubsCol  = () => collection(db, `artifacts/${appId}/public/data/all_submissions`);

    // Auth UI elements
    const authWrapper = $('#authWrapper');
    const appRoot = $('#app');
    const googleBtn = $('#googleSignInButton');
    const signInContainer = $('#signInContainer');
    const codeEntryContainer = $('#codeEntryContainer');
    const codeInput = $('#accessCodeInput');
    const codeSubmit = $('#submitCodeButton');
    const codeError = $('#codeError');
    const userNameSpan = $('#userDisplayName');

    googleBtn.addEventListener('click', async ()=>{
      try{
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      }catch(e){ $('#authError').textContent = e.message; }
    });

    codeSubmit.addEventListener('click', () => handleSubmitCode());
    codeInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); handleSubmitCode(); }});

    async function handleSubmitCode(){
      codeError.textContent=''; const code=(codeInput.value||'').trim();
      if(!code) { codeError.textContent='Please enter a code.'; return; }
      const role = (code===TEACHER_CODE) ? 'teacher' : (code===STUDENT_CODE ? 'student' : null);
      if(!role){ codeError.textContent='The code you entered is invalid.'; return; }
      if(!currentUser){ codeError.textContent='You need to sign in first.'; return; }
      try{
        await setDoc(currentProfileRef, { role, name: currentUser.displayName || '', email: currentUser.email || '', updatedAt: Date.now() }, { merge:true });
        currentRole = role; renderAfterAuth();
      }catch(e){ codeError.textContent = e.message; }
    }

    $('#logoutButton').addEventListener('click', ()=> signOut(auth));
    $('#switchRoleButton').addEventListener('click', ()=>{
        authWrapper.style.display = 'flex';
        appRoot.style.display = 'none';
        signInContainer.style.display = 'none';
        codeEntryContainer.style.display = 'block';
        codeInput.focus();
    });

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUser = user; currentProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
        const snap = await getDoc(currentProfileRef);
        
        if(snap.exists() && snap.data().role){
            currentRole = snap.data().role;
            renderAfterAuth();
        } else {
            authWrapper.style.display = 'flex';
            appRoot.style.display = 'none';
            signInContainer.style.display = 'none';
            codeEntryContainer.style.display = 'block';
        }
      }else{
        currentUser=null; currentRole=null;
        authWrapper.style.display = 'flex';
        appRoot.style.display = 'none';
        signInContainer.style.display = 'block';
        codeEntryContainer.style.display = 'none';
      }
    });

    function canTeach(){ return currentRole==='teacher'; }

    async function loadSubjects(selectEl){
      selectEl.innerHTML = '<option value="">â€” Select Subject â€”</option>';
      const qSnap = await getDocs(query(subjectsCol(), orderBy('name','asc'))).catch(()=>({docs:[]}));
      qSnap.docs.forEach(d=>{ const opt=document.createElement('option'); opt.value=d.id; opt.textContent=d.data().name; selectEl.appendChild(opt); });
    }
    async function loadTopics(subjectId, selectEl){
      selectEl.innerHTML = '<option value="">â€” Select Topic â€”</option>';
      selectEl.disabled = true;
      if(!subjectId) return;
      const qSnap = await getDocs(query(topicsCol(subjectId), orderBy('name','asc'))).catch(()=>({docs:[]}));
      qSnap.docs.forEach(d=>{ const opt=document.createElement('option'); opt.value=d.id; opt.textContent=d.data().name; selectEl.appendChild(opt); });
      selectEl.disabled = false;
    }

    const subjectSelect = $('#subjectSelect');
    const topicSelect = $('#topicSelect');
    const addSubjectBtn = $('#addSubjectBtn');
    const addTopicBtn = $('#addTopicBtn');
    const addTaskBtn = $('#addTaskBtn');
    const sFilter = $('#studentSubjectFilter');
    const tFilter = $('#studentTopicFilter');
    const tdSubject = $('#tdSubject');
    const tdTopic = $('#tdTopic');
    const tdTask = $('#tdTask');

    addSubjectBtn.addEventListener('click', ()=>{ if(!canTeach()) return showNotification('Permission Denied', 'Only teachers can perform this action.'); $('#subjectName').value=''; open($('#subjectModal')); });
    addTopicBtn.addEventListener('click', ()=>{ if(!canTeach()) return showNotification('Permission Denied', 'Only teachers can perform this action.'); if(!selectedSubjectId) return showNotification('Incomplete Selection', 'Please pick a subject first.'); $('#topicName').value=''; $('#topicModalSubject').textContent = `Under: ${subjectSelect.options[subjectSelect.selectedIndex]?.textContent||''}`; open($('#topicModal')); });
    addTaskBtn.addEventListener('click', ()=> openTaskModal());

    $('#saveSubject').addEventListener('click', async ()=>{
      const name = ($('#subjectName').value||'').trim(); if(!name) return;
      await addDoc(subjectsCol(), { name, createdAt: Date.now() });
      $('#subjectModal').style.display='none'; await Promise.all([loadSubjects(subjectSelect), loadSubjects(sFilter), loadSubjects(tdSubject)]);
    });

    $('#saveTopic').addEventListener('click', async ()=>{
      const name = ($('#topicName').value||'').trim(); if(!name || !selectedSubjectId) return;
      await addDoc(topicsCol(selectedSubjectId), { name, createdAt: Date.now() });
      $('#topicModal').style.display='none'; await Promise.all([loadTopics(selectedSubjectId, topicSelect), loadTopics(selectedSubjectId, tFilter), loadTopics(selectedSubjectId, tdTopic)]);
    });

    function openTaskModal(task){
      if(!canTeach()){ showNotification('Permission Denied', 'Only teachers can perform this action.'); return; }
      if(!selectedSubjectId || !selectedTopicId){ showNotification('Incomplete Selection', 'Please pick a subject and topic first.'); return; }
      editingTaskId = task?.id || null;
      $('#taskModalTitle').textContent = editingTaskId? 'Edit Task' : 'Create Task';
      $('#taskTitle').value = task?.title || '';
      $('#taskDesc').value = task?.description || '';
      const d = task?.dueDate ? new Date(task.dueDate) : null;
      $('#taskDue').value = d? new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10) : '';
      open($('#taskModal'));
    }

    $('#saveTask').addEventListener('click', async ()=>{
      const title = ($('#taskTitle').value||'').trim(); if(!title) return;
      const description = ($('#taskDesc').value||'').trim();
      const due = ($('#taskDue').value||'').trim();
      const dueMs = due? new Date(due+'T23:59:59').getTime() : null;
      const payload = { title, description, dueDate: dueMs, createdAt: serverTimestamp() };
      if(editingTaskId){ await updateDoc(doc(db, tasksCol(selectedSubjectId, selectedTopicId).path, editingTaskId), payload); }
      else { await addDoc(tasksCol(selectedSubjectId, selectedTopicId), payload); }
      $('#taskModal').style.display='none'; renderTasksForFilters(); loadTasksForTD();
    });

    subjectSelect.addEventListener('change', async (e)=>{ selectedSubjectId = e.target.value||null; await loadTopics(selectedSubjectId, topicSelect); addTaskBtn.disabled = true; });
    topicSelect.addEventListener('change', (e)=>{ selectedTopicId = e.target.value||null; addTaskBtn.disabled = !selectedTopicId; });
    sFilter.addEventListener('change', async (e)=>{ await loadTopics(e.target.value, tFilter); renderTasksForFilters(); });
    tFilter.addEventListener('change', ()=> renderTasksForFilters());
    tdSubject.addEventListener('change', async (e)=>{ await loadTopics(e.target.value, tdTopic); tdTask.disabled = true; $('#submissionsList').innerHTML=''; });
    tdTopic.addEventListener('change', ()=>{ tdTask.disabled = !tdTopic.value; loadTasksForTD(); });
    tdTask.addEventListener('change', ()=> loadSubmissionsForTD());

    async function renderTasksForFilters(){
      const container = $('#taskList'); container.innerHTML='';
      const subj = sFilter.value; const top = tFilter.value; if(!subj || !top){ container.innerHTML='<p class="helper">Pick a subject & topic to see tasks.</p>'; return; }
      const qSnap = await getDocs(query(tasksCol(subj, top), orderBy('createdAt','desc'))).catch(()=>({docs:[]}));
      if(qSnap.docs.length===0){ container.innerHTML='<p class="helper">No tasks found for this topic.</p>'; return; }
      qSnap.docs.forEach(d=>{
        const t = d.data(); t.id = d.id;
        const dueTxt = t.dueDate? new Date(t.dueDate).toLocaleDateString() : 'No due date';
        const tile = document.createElement('div'); tile.className='tile';
        tile.innerHTML = `
          <div class="badge">Due: ${dueTxt}</div>
          <strong style="font-size: 16px;">${t.title}</strong>
          <div class="muted">${(t.description||'').substring(0,160)}</div>
          <div style="display:flex;gap:8px;margin-top:auto; padding-top: 12px;">
            <button class="btn-primary" data-act="submit">Submit Work</button>
            ${canTeach()? '<button class="btn-secondary" data-act="edit">Edit</button><button class="logout-btn" data-act="delete">Delete</button>' : ''}
          </div>`;
        tile.querySelector('[data-act="submit"]').addEventListener('click', ()=> openSubmission(t, subj, top));
        if(canTeach()){
          tile.querySelector('[data-act="edit"]').addEventListener('click', ()=> openTaskModal(t));
          tile.querySelector('[data-act="delete"]').addEventListener('click', async ()=>{
             if (window.confirm('Are you sure you want to delete this task? This cannot be undone.')) {
                await deleteDoc(doc(db, tasksCol(subj, top).path, d.id));
                renderTasksForFilters();
                loadTasksForTD();
             }
          });
        }
        container.appendChild(tile);
      });
    }

    function openSubmission(task, subjectId, topicId){
      submittingTaskCtx = { task, subjectId, topicId };
      $('#submitModalTitle').textContent = `Submit: ${task.title}`;
      const dueTxt = task.dueDate? new Date(task.dueDate).toLocaleString() : 'â€”';
      $('#submitTaskMeta').textContent = `Subject: ${sFilter.selectedOptions[0]?.textContent || ''} â€¢ Topic: ${tFilter.selectedOptions[0]?.textContent || ''} â€¢ Due: ${dueTxt}`;
      $('#submissionFile').value = ''; $('#submissionLink').value=''; $('#submissionText').value='';
      $('#progressWrapper').style.display = 'none';
      $('#uploadProgress').value = 0;
      $('#progressText').textContent = '0%';
      $('#submitError').style.display = 'none';
      open($('#submitModal'));
    }
    
    // --- REBUILT SUBMISSION FUNCTION WITH PROGRESS ---
    const submitBtn = $('#sendSubmission');
    submitBtn.addEventListener('click', () => handleSubmission());

    function handleSubmission() {
        if (!submittingTaskCtx || !currentUser) return;
        const file = $('#submissionFile').files[0] || null;
        const link = ($('#submissionLink').value || '').trim();
        const text = ($('#submissionText').value || '').trim();
        const errorEl = $('#submitError');

        if (!file && !link && !text) {
            errorEl.textContent = 'You must attach a file, provide a link, or enter a text answer.';
            errorEl.style.display = 'block';
            return;
        }
        errorEl.style.display = 'none';

        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';

        if (file) {
            uploadFileAndSave(file, link, text);
        } else {
            saveSubmissionData({ fileLink: (link || ''), filePath: '', fileName: (link ? 'External Link' : ''), textAnswer: text });
        }
    }

    function uploadFileAndSave(file, link, text) {
        const progressWrapper = $('#progressWrapper');
        const progressBar = $('#uploadProgress');
        const progressText = $('#progressText');
        progressWrapper.style.display = 'block';

        const path = `submissions/${currentUser.uid}/${Date.now()}_${file.name}`;
        const storageRef = ref(storage, path);
        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on('state_changed',
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progressBar.value = progress;
                progressText.textContent = `${Math.round(progress)}%`;
                submitBtn.textContent = 'Uploading...';
            },
            (error) => {
                console.error('Upload failed:', error);
                const errorEl = $('#submitError');
                errorEl.textContent = `Upload failed: ${error.message}. Please try again.`;
                errorEl.style.display = 'block';
                resetSubmitButton();
            },
            () => {
                getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                    saveSubmissionData({
                        fileLink: downloadURL,
                        filePath: path,
                        fileName: file.name,
                        textAnswer: text
                    });
                });
            }
        );
    }
    
    async function saveSubmissionData(payload) {
        const fullPayload = {
            assignmentTitle: submittingTaskCtx.task.title,
            subjectId: submittingTaskCtx.subjectId,
            topicId: submittingTaskCtx.topicId,
            taskId: submittingTaskCtx.task.id,
            submittedAt: Date.now(),
            ...payload
        };
        
        try {
            // Write to user's private submissions
            const userSubRef = await addDoc(collection(db, `artifacts/${appId}/users/${currentUser.uid}/submissions`), fullPayload);
            
            // Write to central log
            await addDoc(allSubsCol(), {
                ...fullPayload,
                submissionId: userSubRef.id,
                studentId: currentUser.uid,
                studentName: currentUser.displayName || currentUser.email || 'Student',
                status: 'submitted',
                score: null,
                feedback: '',
                createdAt: serverTimestamp()
            });

            $('#submitModal').style.display = 'none';
            showNotification('Success!', 'Your work has been submitted.');
            renderMySubmissions();
        } catch(e) {
            console.error("Firestore save error:", e);
            const errorEl = $('#submitError');
            errorEl.textContent = `Could not save submission: ${e.message}. Please try again.`;
            errorEl.style.display = 'block';
        } finally {
            resetSubmitButton();
        }
    }
    
    function resetSubmitButton() {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
    }


    async function renderMySubmissions(){
      const list = $('#mySubmissions'); list.innerHTML='';
      if(!currentUser) return;
      const snap = await getDocs(query(collection(db, `artifacts/${appId}/users/${currentUser.uid}/submissions`), orderBy('submittedAt','desc'))).catch(()=>({docs:[]}));
      if(snap.docs.length===0){ list.innerHTML = '<p class="helper">You haven\'t submitted any work yet.</p>'; return; }
      snap.docs.forEach(d=>{
        const s = d.data();
        const card = document.createElement('div'); card.className='tile';
        card.innerHTML = `
          <strong>${s.assignmentTitle}</strong>
          <div class="muted">${new Date(s.submittedAt).toLocaleString()}</div>
          ${s.fileLink? `<a class="btn-secondary" href="${s.fileLink}" target="_blank" style="width: 100%; text-align:center;">Open File/Link</a>`: ''}
          ${s.textAnswer? `<button class="btn-secondary" data-act="view-text" style="width: 100%;">View Text</button>`: ''}
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="logout-btn" data-act="delete" style="width: 100%;">Delete</button>
          </div>`;
        card.querySelector('[data-act="delete"]').addEventListener('click', async ()=>{
          if(window.confirm('Are you sure you want to delete this submission?')){
            if(s.filePath){ try{ await deleteObject(ref(storage, s.filePath)); }catch(_){} }
            await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/submissions`, d.id));
            renderMySubmissions();
          }
        });
        if(s.textAnswer){ card.querySelector('[data-act="view-text"]').addEventListener('click', ()=>{ $('#previewTitle').textContent=s.assignmentTitle; $('#previewBody').textContent=s.textAnswer; open($('#previewModal')); }); }
        list.appendChild(card);
      });
    }

    async function loadTasksForTD(){
      tdTask.innerHTML = '<option value="">â€” Task â€”</option>';
      tdTask.disabled=true;
      if(!tdSubject.value || !tdTopic.value) return;
      const snap = await getDocs(query(tasksCol(tdSubject.value, tdTopic.value), orderBy('createdAt','desc'))).catch(()=>({docs:[]}));
      snap.docs.forEach(d=>{ const opt=document.createElement('option'); opt.value=d.id; opt.textContent=d.data().title; tdTask.appendChild(opt); });
      tdTask.disabled = false; loadSubmissionsForTD();
    }

    async function loadSubmissionsForTD(){
      const container = $('#submissionsList'); container.innerHTML='';
      if(!tdSubject.value || !tdTopic.value || !tdTask.value) return;
      const snap = await getDocs(query(allSubsCol(), where('taskId', '==', tdTask.value), orderBy('createdAt','desc'))).catch(()=>({docs:[]}));
      if(snap.docs.length===0){ container.innerHTML = '<p class="helper">No submissions for this task yet.</p>'; return; }
      snap.docs.forEach(d=>{
        const s = { id:d.id, ...d.data() };
        const row = document.createElement('div'); row.className='card';
        row.innerHTML = `
          <div class="row" style="align-items:center; gap: 16px;">
            <div style="flex:2">
              <strong>${s.studentName}</strong>
              <div class="muted">${new Date(s.submittedAt).toLocaleString()}</div>
              ${s.fileLink? `<a class="btn-secondary" href="${s.fileLink}" target="_blank">Open</a>`: ''}
              ${s.textAnswer? `<button class="btn-secondary" data-act="view-text">Text</button>`: ''}
            </div>
            <div style="flex:1">
              <label class="label">Status</label>
              <select data-field="status" class="input">${['submitted','reviewing','graded'].map(v=>`<option value="${v}" ${s.status===v?'selected':''}>${v}</option>`).join('')}</select>
            </div>
            <div style="flex:1">
              <label class="label">Score</label>
              <input data-field="score" class="input" type="number" step="1" min="0" max="100" value="${s.score??''}"/>
            </div>
          </div>
          <label class="label">Feedback</label>
          <textarea data-field="feedback" class="input" rows="2">${s.feedback||''}</textarea>
          <div class="footer" style="justify-content:flex-start">
            <button class="btn-primary" data-act="save">Save</button>
            <button class="logout-btn" data-act="delete">Delete Log</button>
          </div>`;
        if(s.textAnswer){ row.querySelector('[data-act="view-text"]').addEventListener('click', ()=>{ $('#previewTitle').textContent=`${s.studentName} â€” Text`; $('#previewBody').textContent=s.textAnswer; open($('#previewModal')); }); }
        row.querySelector('[data-act="save"]').addEventListener('click', async ()=>{
          await updateDoc(doc(db, allSubsCol().path, s.id), { status: row.querySelector('[data-field="status"]').value, score: Number(row.querySelector('[data-field="score"]').value) || null, feedback: row.querySelector('[data-field="feedback"]').value });
          showNotification('Saved', 'Feedback and score have been updated.');
        });
        row.querySelector('[data-act="delete"]').addEventListener('click', async ()=>{
          if(window.confirm('Delete this log entry? This does not delete the student\'s original file.')) {
            await deleteDoc(doc(db, allSubsCol().path, s.id));
            loadSubmissionsForTD();
          }
        });
        container.appendChild(row);
      });
    }

    function renderAfterAuth(){
      authWrapper.style.display='none';
      appRoot.style.display='block';
      userNameSpan.textContent = `${currentUser.displayName||currentUser.email} (${currentRole})`;
      $('#teacherDashboard').style.display = canTeach()? 'block':'none';
      $('#roleNote').textContent = canTeach()? 'You are in Teacher Mode.' : 'You are in Student Mode.';
      
      Promise.all([
        loadSubjects(subjectSelect), loadSubjects(sFilter), loadSubjects(tdSubject)
      ]).then(()=>{
        if(subjectSelect.value){ loadTopics(subjectSelect.value, topicSelect); }
        if(sFilter.value){ loadTopics(sFilter.value, tFilter); }
        if(tdSubject.value){ loadTopics(tdSubject.value, tdTopic); }
      });
      renderMySubmissions();
      renderTasksForFilters();
    }
  </script>
</body>
</html>

