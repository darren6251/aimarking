<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI Marker — Submissions</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* --- THEME & STYLING (Inspired by Google Classroom) --- */
:root {
  --bg-primary: #ffffff;
  --bg-secondary: #f8f9fa;
  --bg-tertiary: #f1f3f4;
  --surface-outline: #dadce0;
  --text-primary: #202124;
  --text-secondary: #5f6368;
  --accent-primary: #1a73e8;
  --accent-primary-hover: #185abc;
  --accent-red: #d93025;
  --font-family: "Inter", "Google Sans", Roboto, Arial, sans-serif;
  --border-radius: 8px;
  --transition-speed: 0.2s;
}

body.dark-theme {
  --bg-primary: #1f1f1f;
  --bg-secondary: #282828;
  --bg-tertiary: #303030;
  --surface-outline: #4d4d4d;
  --text-primary: #e8eaed;
  --text-secondary: #9aa0a6;
  --accent-primary: #8ab4f8;
  --accent-primary-hover: #a6c9fa;
  --accent-red: #f28b82;
}

/* --- BASE STYLES --- */
* { box-sizing: border-box; }

html, body { height: 100%; }

body {
  margin: 0;
  font-family: var(--font-family);
  background: var(--bg-primary);
  color: var(--text-primary);
  transition: background-color var(--transition-speed), color var(--transition-speed);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* --- LAYOUT & HEADER --- */
#app, #authWrapper {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

header {
  position: sticky;
  top: 0;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 64px;
  padding: 0 24px;
  background: var(--bg-primary);
  border-bottom: 1px solid var(--surface-outline);
  transition: background-color var(--transition-speed), border-bottom var(--transition-speed);
}

header .logo-container {
  display: flex;
  flex-direction: column;
  line-height: 1.2;
}

header .logo-container h1 {
  font-size: 20px;
  font-weight: 600;
  margin: 0;
}

header .logo-container p {
  margin: 0;
  color: var(--text-secondary);
  font-size: 12px;
}

.header-actions {
  display: flex;
  gap: 1rem;
  align-items: center;
}

main {
  display: flex;
  gap: 24px;
  max-width: 1200px;
  width: 100%;
  margin: 24px auto;
  padding: 0 24px;
  flex-grow: 1;
}

.sidebar {
  width: 280px;
  flex-shrink: 0;
  position: sticky;
  top: 88px; /* header height + margin */
  height: fit-content;
}

.content {
  flex: 1;
  min-width: 0;
}

/* --- COMPONENTS --- */
.card {
  background: var(--bg-secondary);
  border: 1px solid var(--surface-outline);
  border-radius: var(--border-radius);
  padding: 24px;
  margin-bottom: 24px;
  transition: background-color var(--transition-speed), border var(--transition-speed);
}
.card > h3:first-child { margin-top: 0; }

.section-title {
  font-size: 20px;
  font-weight: 500;
  color: var(--text-primary);
  margin: 0 0 16px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--surface-outline);
}

.label {
  display: block;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  margin: 16px 0 8px;
}

.input, select, textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: var(--border-radius);
  border: 1px solid var(--surface-outline);
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: var(--font-family);
  font-size: 14px;
  transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
}
textarea { resize: vertical; min-height: 80px; }
.input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-primary) 25%, transparent);
}

.btn, .tab {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-family);
  font-size: 14px;
  font-weight: 500;
  border-radius: var(--border-radius);
  padding: 8px 16px;
  border: 1px solid transparent;
  cursor: pointer;
  text-decoration: none;
  transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
}
.btn-primary {
  background-color: var(--accent-primary);
  color: var(--bg-primary);
}
.btn-primary:hover { background-color: var(--accent-primary-hover); }
.btn-secondary {
  background-color: transparent;
  color: var(--accent-primary);
  border-color: var(--surface-outline);
}
.btn-secondary:hover { background-color: var(--bg-tertiary); }
.logout-btn {
  background-color: transparent;
  color: var(--accent-red);
  border-color: var(--surface-outline);
}
.logout-btn:hover { background-color: color-mix(in srgb, var(--accent-red) 10%, transparent); }
.tab {
  color: var(--text-secondary);
  border-color: transparent;
  background-color: transparent;
}
.tab:hover {
  background-color: var(--bg-tertiary);
  color: var(--text-primary);
}
button:disabled { opacity: 0.5; cursor: not-allowed; }

.helper { font-size: 12px; color: var(--text-secondary); margin: 8px 0; }
.error-message { font-size: 12px; color: var(--accent-red); margin-top: 4px; min-height: 1em; }

.list {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
}

.tile {
  background: var(--bg-primary);
  border: 1px solid var(--surface-outline);
  border-radius: var(--border-radius);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.tile-header { display: flex; justify-content: space-between; align-items: flex-start; }
.tile-header strong { font-weight: 500; }
.tile-body { font-size: 14px; color: var(--text-secondary); }
.tile-actions { display: flex; gap: 8px; margin-top: auto; padding-top: 8px; }
.badge {
  background-color: var(--bg-tertiary);
  border-radius: 999px;
  padding: 4px 10px;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  width: max-content;
}

/* --- LOGIN PAGE --- */
#authWrapper {
  display: none; /* Initially hidden */
  flex-direction: row;
  width: 100vw;
  height: 100vh;
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1001;
}
.login-left-panel {
  width: 50%;
  background: var(--bg-secondary);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 3rem;
  text-align: center;
}
.login-left-panel h1 {
  font-size: 3rem;
  font-weight: 700;
  margin-bottom: 1rem;
}
.login-left-panel p {
  font-size: 1.25rem;
  color: var(--text-secondary);
  max-width: 400px;
}
.login-right-panel {
  width: 50%;
  background: var(--bg-primary);
  display: flex;
  justify-content: center;
  align-items: center;
}
.login-card {
  max-width: 400px;
  width: 100%;
  padding: 2rem;
}
.google-btn {
  display: flex;
  align-items: center;
  gap: 12px;
  justify-content: center;
  border: 1px solid var(--surface-outline);
  background: transparent;
  color: var(--text-primary);
  padding: 10px 12px;
  cursor: pointer;
  width: 100%;
  font-size: 14px;
  margin-top: 1.5rem;
}

/* --- MODALS --- */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  align-items: center;
  justify-content: center;
  padding: 16px;
  z-index: 200;
}
.modal .dialog {
  width: min(500px, 95vw);
  background: var(--bg-primary);
  border-radius: var(--border-radius);
  padding: 24px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}
.modal .dialog header {
  position: static;
  height: auto;
  padding: 0;
  background: transparent;
  border: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.modal .dialog header h3 { margin: 0; font-size: 18px; font-weight: 500; }
.close-button {
  background: transparent;
  border: none;
  color: var(--text-secondary);
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  line-height: 1;
}
.modal .dialog .footer {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 24px;
}
.preview {
  border: 1px dashed var(--surface-outline);
  border-radius: var(--border-radius);
  padding: 16px;
  min-height: 120px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  font-size: 14px;
  text-align: center;
  word-break: break-word;
}
.preview img { max-width: 100%; max-height: 200px; border-radius: 4px; }
.preview a { color: var(--accent-primary); }

/* --- PROGRESS BAR --- */
.progress-container {
  width: 100%;
  background-color: var(--bg-tertiary);
  border-radius: 4px;
  overflow: hidden;
  margin-top: 16px;
}
.progress-bar {
  width: 0%;
  height: 8px;
  background-color: var(--accent-primary);
  transition: width 0.3s ease-in-out;
}

/* --- RESPONSIVE --- */
@media (max-width: 900px) {
  main { flex-direction: column; }
  .sidebar { position: static; width: auto; }
  .login-left-panel { display: none; }
  .login-right-panel { width: 100%; }
}
</style>
</head>
<body>

  <!-- AUTHENTICATION WRAPPER -->
  <div id="authWrapper">
    <div class="login-left-panel">
        <h1>AI Marker</h1>
        <p>"The beautiful thing about learning is that no one can take it away from you." <br>— B.B. King</p>
    </div>
    <div class="login-right-panel">
      <div class="login-card">
        <h2 style="margin:0 0 8px; font-weight: 500;">Welcome</h2>
        <p class="helper" style="margin-top:0">Sign in with Google to access your submissions.</p>
        <button id="googleSignInButton" class="google-btn">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" width="18" height="18"/>
          <span>Sign in with Google</span>
        </button>
        <div id="codeEntry" style="margin-top:24px; display:none;">
          <label class="label">Enter Access Code</label>
          <input id="accessCodeInput" class="input" placeholder="Provided by your teacher"/>
          <button id="submitCodeButton" class="btn btn-primary" style="width:100%; margin-top:8px">Submit</button>
          <p id="codeError" class="error-message"></p>
        </div>
        <p id="authError" class="error-message"></p>
      </div>
    </div>
  </div>

  <!-- MAIN APPLICATION -->
  <div id="app" style="display:none">
    <header>
      <div class="logo-container">
        <h1>Submissions</h1>
        <p>AI Marker by Darren Ng</p>
      </div>
      <div class="header-actions">
        <!-- Home button added here -->
        <a href="index (8).html" class="tab">Home</a>
        <button id="themeToggleButton" class="tab">Theme</button>
        <span id="userDisplayName" class="helper" style="margin:0;"></span>
        <button id="switchRoleButton" class="tab">Switch Role</button>
        <button id="logoutButton" class="logout-btn">Log Out</button>
      </div>
    </header>

    <main>
      <aside class="sidebar">
        <div class="card" style="padding: 16px;">
            <div id="teacherControls">
                <h3 class="section-title">Setup Tasks</h3>
                <p class="helper" id="roleNote">Only teachers can create or edit.</p>
                <label class="label">Subject</label>
                <div style="display:flex; gap:8px;">
                  <select id="subjectSelect" class="input"></select>
                  <button id="addSubjectBtn" class="btn btn-secondary" title="Create Subject">＋</button>
                </div>
                <label class="label">Topic</label>
                <div style="display:flex; gap:8px;">
                  <select id="topicSelect" class="input" disabled></select>
                  <button id="addTopicBtn" class="btn btn-secondary" title="Create Topic">＋</button>
                </div>
                <button id="addTaskBtn" class="btn btn-primary" style="width:100%; margin-top:16px" disabled>Create Task</button>
            </div>
            <hr style="border:none; border-top:1px solid var(--surface-outline); margin:24px 0;">
            <div id="studentControls">
                <h3 class="section-title">Find Tasks</h3>
                <p class="helper">Select a subject & topic to view tasks.</p>
                <label class="label">Subject</label>
                <select id="studentSubjectFilter" class="input"></select>
                <label class="label">Topic</label>
                <select id="studentTopicFilter" class="input" disabled></select>
            </div>
        </div>
      </aside>

      <section class="content">
        <div class="card">
          <h3 class="section-title">Open Tasks</h3>
          <div id="taskList" class="list"></div>
        </div>

        <div class="card">
          <h3 class="section-title">My Submissions</h3>
          <div id="mySubmissions" class="list"></div>
        </div>

        <div class="card" id="teacherDashboard" style="display:none;">
          <h3 class="section-title">Teacher Dashboard — Submissions</h3>
          <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
            <div><label class="label">Subject</label><select id="tdSubject" class="input"></select></div>
            <div><label class="label">Topic</label><select id="tdTopic" class="input" disabled></select></div>
            <div><label class="label">Task</label><select id="tdTask" class="input" disabled></select></div>
          </div>
          <div id="submissionsList" style="margin-top:16px; display:flex; flex-direction: column; gap:12px;"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODALS -->
  <div id="subjectModal" class="modal"><div class="dialog">
    <header><h3>Create Subject</h3><button class="close-button" data-close>×</button></header>
    <label class="label">Subject name</label>
    <input id="subjectName" class="input" placeholder="e.g., Mathematics"/>
    <div class="footer"><button class="btn btn-secondary" data-close>Cancel</button><button id="saveSubject" class="btn btn-primary">Save</button></div>
  </div></div>

  <div id="topicModal" class="modal"><div class="dialog">
    <header><h3>Create Topic</h3><button class="close-button" data-close>×</button></header>
    <p class="helper" id="topicModalSubject"></p>
    <label class="label">Topic name</label>
    <input id="topicName" class="input" placeholder="e.g., Algebra"/>
    <div class="footer"><button class="btn btn-secondary" data-close>Cancel</button><button id="saveTopic" class="btn btn-primary">Save</button></div>
  </div></div>

  <div id="taskModal" class="modal"><div class="dialog">
    <header><h3 id="taskModalTitle">Create Task</h3><button class="close-button" data-close>×</button></header>
    <div style="display:flex; gap:12px;"><div style="flex:2"><label class="label">Task Title</label><input id="taskTitle" class="input"/></div><div style="flex:1"><label class="label">Due Date</label><input id="taskDue" class="input" type="date"></div></div>
    <label class="label">Description</label>
    <textarea id="taskDesc" class="input" rows="4" placeholder="Brief instructions for this task"></textarea>
    <div class="footer"><button class="btn btn-secondary" data-close>Cancel</button><button id="saveTask" class="btn btn-primary">Save</button></div>
  </div></div>

  <div id="submitModal" class="modal"><div class="dialog">
    <header><h3 id="submitModalTitle">Submit Homework</h3><button class="close-button" data-close>×</button></header>
    <div id="submitTaskMeta" class="helper" style="margin-bottom:8px"></div>
    <label class="label">Upload file (PDF/Image)</label>
    <input id="submissionFile" type="file" accept="application/pdf,image/*" class="input"/>
    <label class="label">or Paste a Link</label>
    <input id="submissionLink" class="input" placeholder="https://..."/>
    <label class="label">Or Type an Answer</label>
    <textarea id="submissionText" class="input" rows="4" placeholder="Paste your answer here"></textarea>
    
    <!-- Upload Progress Bar -->
    <div id="progressContainer" class="progress-container" style="display: none;">
      <div id="progressBar" class="progress-bar"></div>
    </div>
    <p id="uploadStatus" class="helper"></p>

    <div class="footer"><button class="btn btn-secondary" data-close>Cancel</button><button id="sendSubmission" class="btn btn-primary">Submit</button></div>
  </div></div>

  <div id="previewModal" class="modal"><div class="dialog">
    <header><h3 id="previewTitle">Preview</h3><button class="close-button" data-close>×</button></header>
    <div class="preview" id="previewBody">No preview</div>
    <div class="footer"><button class="btn btn-secondary" data-close>Close</button></div>
  </div></div>


  <!-- FIREBASE SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, getDocs, query, where, orderBy, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
      authDomain: "ai-grading-9bb30.firebaseapp.com",
      projectId: "ai-grading-9bb30",
      storageBucket: "ai-grading-9bb30.appspot.com",
      messagingSenderId: "298162112230",
      appId: "1:298162112230:web:529d3f95536991be685d27",
    };
    const TEACHER_CODE = "Derren0625";
    const STUDENT_CODE = "STUDENT456";
    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // --- UI HELPERS & STATE ---
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    
    let currentUser = null; 
    let currentRole = null; 
    let currentProfileRef = null;
    let selectedSubjectId = null; 
    let selectedTopicId = null; 
    let editingTaskId = null; 
    let submittingTaskCtx = null;

    // --- THEME ---
    const themeToggleButton = $('#themeToggleButton');
    const applyTheme = (t)=> document.body.classList.toggle('dark-theme', t==='dark');
    const loadTheme = ()=> { const t=localStorage.getItem('ai-marker-theme')||'dark'; applyTheme(t); };
    loadTheme();
    themeToggleButton?.addEventListener('click', ()=>{ 
        const t=document.body.classList.contains('dark-theme')?'light':'dark'; 
        localStorage.setItem('ai-marker-theme', t); 
        applyTheme(t); 
    });
    
    // --- MODALS ---
    const modals = $$('.modal');
    modals.forEach(m=> m.addEventListener('click', (e)=>{ 
        if(e.target === m || e.target.closest('[data-close]')){ 
            m.style.display='none'; 
        }
    }));
    const openModal = (m) => $(m).style.display='flex';

    // --- AUTHENTICATION ---
    const authWrapper = $('#authWrapper');
    const appRoot = $('#app');
    const googleBtn = $('#googleSignInButton');
    const codeEntry = $('#codeEntry');
    const codeInput = $('#accessCodeInput');
    const codeSubmit = $('#submitCodeButton');
    const codeError = $('#codeError');
    const userNameSpan = $('#userDisplayName');

    googleBtn.addEventListener('click', async () => {
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch(e) { $('#authError').textContent = e.message; }
    });

    codeSubmit.addEventListener('click', handleSubmitCode);
    codeInput.addEventListener('keydown', (e) => { if(e.key === 'Enter'){ e.preventDefault(); handleSubmitCode(); }});

    async function handleSubmitCode(){
      codeError.textContent = ''; 
      const code = (codeInput.value || '').trim();
      if(!code) { codeError.textContent = 'Please enter a code.'; return; }
      
      const role = (code === TEACHER_CODE) ? 'teacher' : (code === STUDENT_CODE ? 'student' : null);
      if(!role){ codeError.textContent = 'Invalid access code.'; return; }
      if(!currentUser){ codeError.textContent = 'Please sign in first.'; return; }
      
      try {
        await setDoc(currentProfileRef, { 
            role, 
            name: currentUser.displayName || '', 
            email: currentUser.email || '', 
            updatedAt: Date.now() 
        }, { merge:true });
        currentRole = role;
        renderAfterAuth();
      } catch(e) { codeError.textContent = e.message; }
    }

    $('#logoutButton').addEventListener('click', () => signOut(auth));
    $('#switchRoleButton').addEventListener('click', () => { codeEntry.style.display='block'; codeInput.focus(); });

    onAuthStateChanged(auth, async (user) => {
      if(user){
        currentUser = user; 
        currentProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
        
        const snap = await getDoc(currentProfileRef);
        if(snap.exists() && snap.data().role){
          currentRole = snap.data().role;
          authWrapper.style.display = 'none';
          appRoot.style.display = 'flex';
          renderAfterAuth();
        } else {
          authWrapper.style.display = 'flex';
          appRoot.style.display = 'none';
          codeEntry.style.display = 'block';
        }
        userNameSpan.textContent = `${user.displayName || user.email}`;
      } else {
        currentUser=null; currentRole=null;
        authWrapper.style.display = 'flex';
        appRoot.style.display = 'none';
        codeEntry.style.display = 'none';
      }
    });

    function canTeach(){ return currentRole === 'teacher'; }

    // --- DATA PATHS ---
    const subjectsCol = () => collection(db, `artifacts/${appId}/public/data/subjects`);
    const topicsCol = (subjectId) => collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics`);
    const tasksCol = (subjectId, topicId) => collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics/${topicId}/tasks`);
    const allSubsCol = () => collection(db, `artifacts/${appId}/public/data/all_submissions`);
    const userSubsCol = (userId) => collection(db, `artifacts/${appId}/users/${userId}/submissions`);

    // --- UI RENDERING & DATA LOADING ---
    async function populateSelect(selectEl, collectionRef, placeholder) {
      selectEl.innerHTML = `<option value="">— ${placeholder} —</option>`;
      try {
        const qSnap = await getDocs(query(collectionRef, orderBy('name','asc')));
        qSnap.docs.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.textContent = d.data().name;
            selectEl.appendChild(opt);
        });
      } catch (e) { console.error(`Failed to load ${placeholder}`, e); }
    }

    const subjectSelect = $('#subjectSelect'), topicSelect = $('#topicSelect');
    const sFilter = $('#studentSubjectFilter'), tFilter = $('#studentTopicFilter');
    const tdSubject = $('#tdSubject'), tdTopic = $('#tdTopic'), tdTask = $('#tdTask');

    subjectSelect.addEventListener('change', async (e) => { 
        selectedSubjectId = e.target.value || null; 
        await populateSelect(topicSelect, topicsCol(selectedSubjectId), 'Select Topic');
        topicSelect.disabled = !selectedSubjectId; 
        addTaskBtn.disabled = true; 
    });
    topicSelect.addEventListener('change', (e) => { 
        selectedTopicId = e.target.value || null; 
        addTaskBtn.disabled = !selectedTopicId; 
    });
    sFilter.addEventListener('change', async (e) => { 
        await populateSelect(tFilter, topicsCol(e.target.value), 'Select Topic');
        tFilter.disabled = !e.target.value; 
        renderTasksForFilters(); 
    });
    tFilter.addEventListener('change', renderTasksForFilters);
    tdSubject.addEventListener('change', async (e) => { 
        await populateSelect(tdTopic, topicsCol(e.target.value), 'Select Topic');
        tdTopic.disabled = !e.target.value; 
        tdTask.disabled = true; 
        $('#submissionsList').innerHTML = ''; 
    });
    tdTopic.addEventListener('change', () => { 
        tdTask.disabled = !tdTopic.value; 
        populateSelect(tdTask, tasksCol(tdSubject.value, tdTopic.value), 'Select Task');
    });
    tdTask.addEventListener('change', loadSubmissionsForTD);

    // --- CRUD OPERATIONS ---
    $('#addSubjectBtn').addEventListener('click', () => { if(!canTeach()) return; $('#subjectName').value=''; openModal('#subjectModal'); });
    $('#addTopicBtn').addEventListener('click', () => { 
        if(!canTeach() || !selectedSubjectId) return;
        $('#topicName').value=''; 
        $('#topicModalSubject').textContent = `Under: ${subjectSelect.options[subjectSelect.selectedIndex]?.textContent||''}`; 
        openModal('#topicModal'); 
    });
    $('#addTaskBtn').addEventListener('click', () => openTaskModal());

    $('#saveSubject').addEventListener('click', async () => {
      const name = ($('#subjectName').value||'').trim(); if(!name) return;
      await addDoc(subjectsCol(), { name, createdAt: serverTimestamp() });
      $('#subjectModal').style.display='none'; 
      await Promise.all([
        populateSelect(subjectSelect, subjectsCol(), 'Select Subject'), 
        populateSelect(sFilter, subjectsCol(), 'Select Subject'),
        populateSelect(tdSubject, subjectsCol(), 'Select Subject')
      ]);
    });
    $('#saveTopic').addEventListener('click', async () => {
      const name = ($('#topicName').value||'').trim(); if(!name || !selectedSubjectId) return;
      await addDoc(topicsCol(selectedSubjectId), { name, createdAt: serverTimestamp() });
      $('#topicModal').style.display='none'; 
      await Promise.all([
          populateSelect(topicSelect, topicsCol(selectedSubjectId), 'Select Topic'),
          populateSelect(tFilter, topicsCol(selectedSubjectId), 'Select Topic'),
          populateSelect(tdTopic, topicsCol(selectedSubjectId), 'Select Topic')
      ]);
    });

    function openTaskModal(task){
      if(!canTeach() || !selectedSubjectId || !selectedTopicId) return;
      editingTaskId = task?.id || null;
      $('#taskModalTitle').textContent = editingTaskId ? 'Edit Task' : 'Create Task';
      $('#taskTitle').value = task?.title || '';
      $('#taskDesc').value = task?.description || '';
      const d = task?.dueDate ? new Date(task.dueDate) : null;
      $('#taskDue').value = d ? new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10) : '';
      openModal('#taskModal');
    }

    $('#saveTask').addEventListener('click', async () => {
      const title = ($('#taskTitle').value||'').trim(); if(!title) return;
      const description = ($('#taskDesc').value||'').trim();
      const due = ($('#taskDue').value||'').trim();
      const dueMs = due ? new Date(due+'T23:59:59').getTime() : null;
      const payload = { title, description, dueDate: dueMs, updatedAt: serverTimestamp() };
      
      const taskCollection = tasksCol(selectedSubjectId, selectedTopicId);
      if(editingTaskId){ 
        await updateDoc(doc(db, taskCollection.path, editingTaskId), payload); 
      } else { 
        payload.createdAt = serverTimestamp();
        await addDoc(taskCollection, payload); 
      }
      
      $('#taskModal').style.display = 'none'; 
      renderTasksForFilters(); 
      populateSelect(tdTask, tasksCol(tdSubject.value, tdTopic.value), 'Select Task');
    });
    
    // --- RENDER TASKS FOR STUDENTS ---
    async function renderTasksForFilters(){
      const container = $('#taskList'); container.innerHTML = '';
      const subjId = sFilter.value; const topicId = tFilter.value; 
      if(!subjId || !topicId){ container.innerHTML='<p class="helper">Select a subject and topic to see tasks.</p>'; return; }
      
      const qSnap = await getDocs(query(tasksCol(subjId, topicId), orderBy('createdAt','desc')));
      if(qSnap.empty){ container.innerHTML='<p class="helper">No tasks found for this topic.</p>'; return; }

      qSnap.docs.forEach(d => {
        const t = d.data(); t.id = d.id;
        const dueTxt = t.dueDate ? new Date(t.dueDate).toLocaleDateString() : 'No due date';
        const tile = document.createElement('div'); tile.className='tile';
        tile.innerHTML = `
          <div class="tile-header">
            <strong>${t.title}</strong>
            <div class="badge">Due: ${dueTxt}</div>
          </div>
          <p class="tile-body">${(t.description||'').substring(0,160)}</p>
          <div class="tile-actions">
            <button class="btn btn-primary" data-act="submit">Submit Work</button>
            ${canTeach()? '<button class="btn btn-secondary" data-act="edit">Edit</button><button class="logout-btn" data-act="delete">Delete</button>' : ''}
          </div>`;
        tile.querySelector('[data-act="submit"]').addEventListener('click', () => openSubmission(t, subjId, topicId));
        if(canTeach()){
          tile.querySelector('[data-act="edit"]').addEventListener('click', () => openTaskModal(t));
          tile.querySelector('[data-act="delete"]').addEventListener('click', async () => {
            if(!confirm('Are you sure you want to delete this task and ALL its submissions?')) return;
            // A more robust implementation would use a Cloud Function for recursive deletes.
            // Here, we'll just delete the task doc. Submissions will be orphaned.
            await deleteDoc(doc(db, tasksCol(subjId, topicId).path, d.id)); 
            renderTasksForFilters();
            populateSelect(tdTask, tasksCol(tdSubject.value, tdTopic.value), 'Select Task');
          });
        }
        container.appendChild(tile);
      });
    }

    // --- SUBMISSION LOGIC ---
    function openSubmission(task, subjectId, topicId){
      submittingTaskCtx = { task, subjectId, topicId };
      $('#submitModalTitle').textContent = `Submit: ${task.title}`;
      const dueTxt = task.dueDate ? new Date(task.dueDate).toLocaleString() : '—';
      $('#submitTaskMeta').textContent = `Due: ${dueTxt}`;
      
      // Reset form
      $('#submissionFile').value = ''; 
      $('#submissionLink').value=''; 
      $('#submissionText').value='';
      $('#progressContainer').style.display = 'none';
      $('#uploadStatus').textContent = '';
      $('#sendSubmission').disabled = false;
      
      openModal('#submitModal');
    }

    $('#sendSubmission').addEventListener('click', () => {
      if(!submittingTaskCtx || !currentUser) return;
      
      const file = $('#submissionFile').files[0] || null;
      const link = ($('#submissionLink').value||'').trim();
      const text = ($('#submissionText').value||'').trim();

      if(!file && !link && !text){ 
        $('#uploadStatus').textContent = 'Please attach a file, provide a link, or enter text.';
        return; 
      }

      const submitBtn = $('#sendSubmission');
      submitBtn.disabled = true;
      
      if(file){
        uploadFileAndSubmit(file, link, text);
      } else {
        submitData(null, null, link, text);
      }
    });

    function uploadFileAndSubmit(file, link, text) {
      const progressContainer = $('#progressContainer');
      const progressBar = $('#progressBar');
      const uploadStatus = $('#uploadStatus');

      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      uploadStatus.textContent = 'Preparing to upload...';

      const filePath = `submissions/${currentUser.uid}/${Date.now()}_${file.name}`;
      const storageRef = ref(storage, filePath);
      const uploadTask = uploadBytesResumable(storageRef, file);

      uploadTask.on('state_changed', 
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          progressBar.style.width = progress + '%';
          uploadStatus.textContent = `Uploading... ${Math.round(progress)}%`;
        }, 
        (error) => {
          console.error("Upload failed:", error);
          uploadStatus.textContent = `Upload failed: ${error.message}`;
          $('#sendSubmission').disabled = false;
        }, 
        async () => {
          uploadStatus.textContent = 'Upload complete! Saving submission...';
          try {
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
            await submitData(downloadURL, filePath, link, text, file.name);
          } catch(e) {
             uploadStatus.textContent = `Error saving submission: ${e.message}`;
             $('#sendSubmission').disabled = false;
          }
        }
      );
    }
    
    async function submitData(fileLink, filePath, externalLink, text, fileName = null) {
      const { task, subjectId, topicId } = submittingTaskCtx;
      const payload = {
        assignmentTitle: task.title, subjectId, topicId, taskId: task.id,
        submittedAt: serverTimestamp(),
        fileLink: fileLink || externalLink || '',
        fileName: fileName || (externalLink ? 'External Link' : 'Text Submission'),
        filePath: filePath || '',
        textAnswer: text || '',
        studentId: currentUser.uid,
        studentName: currentUser.displayName || currentUser.email,
        status: 'submitted',
        score: null,
        feedback: ''
      };

      const batch = writeBatch(db);
      // 1. Write to user's private collection
      const userSubRef = doc(userSubsCol(currentUser.uid));
      batch.set(userSubRef, payload);
      // 2. Write to the central public log for the teacher
      const centralSubRef = doc(allSubsCol());
      batch.set(centralSubRef, { ...payload, userSubmissionId: userSubRef.id });

      await batch.commit();

      $('#submitModal').style.display='none';
      renderMySubmissions();
    }

    async function renderMySubmissions(){
      const list = $('#mySubmissions'); list.innerHTML='';
      if(!currentUser) return;
      const snap = await getDocs(query(userSubsCol(currentUser.uid), orderBy('submittedAt','desc')));
      if(snap.empty){ list.innerHTML = '<p class="helper">You have no submissions.</p>'; return; }
      
      snap.forEach(d => {
        const s = d.data();
        const card = document.createElement('div'); card.className='tile';
        card.innerHTML = `
          <div class="tile-header"><strong>${s.assignmentTitle}</strong></div>
          <div class="tile-body muted">${new Date(s.submittedAt.seconds * 1000).toLocaleString()}</div>
          <div class="tile-actions">
            <button class="btn btn-secondary" data-act="preview">Preview</button>
            <button class="logout-btn" data-act="delete">Delete</button>
          </div>`;
        
        card.querySelector('[data-act="preview"]').addEventListener('click', () => {
            $('#previewTitle').textContent = s.assignmentTitle;
            let previewHTML = '';
            if (s.fileLink) previewHTML += `<p><strong>File:</strong> <a href="${s.fileLink}" target="_blank" rel="noopener noreferrer">${s.fileName}</a></p>`;
            if (s.textAnswer) previewHTML += `<p><strong>Answer:</strong><br>${s.textAnswer.replace(/\n/g, '<br>')}</p>`;
            $('#previewBody').innerHTML = previewHTML || 'No content to preview.';
            openModal('#previewModal');
        });

        card.querySelector('[data-act="delete"]').addEventListener('click', async () => {
          if(!confirm('Are you sure you want to delete this submission?')) return;
          if(s.filePath){ try { await deleteObject(ref(storage, s.filePath)); } catch(_){} }
          await deleteDoc(d.ref);
          // Teacher log entry remains but can be deleted from their dashboard.
          renderMySubmissions();
        });
        list.appendChild(card);
      });
    }

    // --- TEACHER DASHBOARD ---
    async function loadSubmissionsForTD(){
      const container = $('#submissionsList'); container.innerHTML = '';
      const taskId = tdTask.value;
      if(!canTeach() || !taskId) return;
      
      const q = query(allSubsCol(), where("taskId", "==", taskId), orderBy('submittedAt','desc'));
      const snap = await getDocs(q);
      
      if(snap.empty) { container.innerHTML = '<p class="helper">No submissions for this task yet.</p>'; return; }

      snap.forEach(d => {
        const s = d.data(); s.id = d.id;
        const row = document.createElement('div'); row.className='tile';
        row.innerHTML = `
          <strong>${s.studentName}</strong>
          <div class="muted">${new Date(s.submittedAt.seconds * 1000).toLocaleString()}</div>
          <button class="btn btn-secondary" data-act="preview" style="margin-top:8px;">Preview Submission</button>
          <div style="display:flex; gap:12px; margin-top:8px;">
            <div style="flex:1"><label class="label">Status</label><select data-field="status" class="input">${['submitted','reviewing','graded'].map(v=>`<option value="${v}" ${s.status===v?'selected':''}>${v}</option>`).join('')}</select></div>
            <div style="flex:1"><label class="label">Score (100)</label><input data-field="score" class="input" type="number" min="0" max="100" value="${s.score??''}"/></div>
          </div>
          <label class="label">Feedback</label>
          <textarea data-field="feedback" class="input" rows="2">${s.feedback||''}</textarea>
          <div class="tile-actions">
            <button class="btn btn-primary" data-act="save">Save Feedback</button>
            <button class="logout-btn" data-act="delete">Delete Log</button>
          </div>`;

        row.querySelector('[data-act="preview"]').addEventListener('click', () => {
            $('#previewTitle').textContent = `Submission by ${s.studentName}`;
            let previewHTML = '';
            if (s.fileLink) previewHTML += `<p><strong>File:</strong> <a href="${s.fileLink}" target="_blank" rel="noopener noreferrer">${s.fileName}</a></p>`;
            if (s.textAnswer) previewHTML += `<p><strong>Answer:</strong><br>${s.textAnswer.replace(/\n/g, '<br>')}</p>`;
            $('#previewBody').innerHTML = previewHTML || 'No content to preview.';
            openModal('#previewModal');
        });
        
        row.querySelector('[data-act="save"]').addEventListener('click', async () => {
          await updateDoc(d.ref, {
            status: row.querySelector('[data-field="status"]').value,
            score: Number(row.querySelector('[data-field="score"]').value) || null,
            feedback: row.querySelector('[data-field="feedback"]').value
          });
        });
        
        row.querySelector('[data-act="delete"]').addEventListener('click', async () => {
          if(!confirm('Delete this submission log entry? This does not delete the student\'s file.')) return; 
          await deleteDoc(d.ref); 
          loadSubmissionsForTD();
        });
        
        container.appendChild(row);
      });
    }

    // --- INITIAL APP LOAD ---
    function renderAfterAuth(){
      const isTeacher = canTeach();
      $('#teacherDashboard').style.display = isTeacher ? 'block' : 'none';
      $('#teacherControls').style.display = isTeacher ? 'block' : 'none';
      $('#roleNote').textContent = isTeacher ? 'You are a teacher.' : 'Select a subject to begin.';
      
      Promise.all([
        populateSelect(subjectSelect, subjectsCol(), 'Select Subject'), 
        populateSelect(sFilter, subjectsCol(), 'Select Subject'), 
        populateSelect(tdSubject, subjectsCol(), 'Select Subject')
      ]);
      
      renderMySubmissions();
      renderTasksForFilters();
    }

  </script>
</body>
</html>
