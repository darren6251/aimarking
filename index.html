<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Marker</title>
    <!-- PDF.js library for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- Custom styles -->
    <style>
        /* Base Dark Theme Variables */
        :root {
            --bg-primary: #0d1117; /* Black */
            --bg-secondary: #161b22; /* Dark Gray */
            --text-primary: #c9d1d9; /* Light Gray */
            --text-secondary: #8b949e; /* Muted gray for secondary text */
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --border-color: #30363d;
            --button-hover-darken: #21262d;
            --button-primary-lighten: #2ea043; /* Green hover */
            --button-blue-lighten: #4c9aff; /* Blue hover */
            --button-red-lighten: rgba(248, 81, 73, 0.1); /* Red hover */
            --neon-glow-color: #58a6ff; /* Neon blue for dark theme */
        }

        /* Light Theme Variables - Overrides for .light-theme class */
        body.light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f2f5;
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent-blue: #007bff;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --border-color: #cccccc;
            --button-hover-darken: #e2e6ea;
            --button-primary-lighten: #218838;
            --button-blue-lighten: #0069d9;
            --button-red-lighten: rgba(220, 53, 69, 0.1);
            --neon-glow-color: #007bff; /* Neon blue for light theme */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", sans-serif;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            overflow-x: hidden;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        button,
        input,
        textarea,
        select {
            transition: all .2s ease-out;
            font-family: inherit;
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        /* Keyframe animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* LOGIN PAGE: Full screen wrapper */
        #authWrapper {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1001;
        }

        .login-left-panel,
        .login-right-panel {
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .login-left-panel {
            background: var(--bg-primary);
            color: var(--text-primary);
            flex-direction: column;
            text-align: center;
        }

        .login-left-panel h1 {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 1rem;
        }

        .login-left-panel p {
            font-size: 1.75rem;
            font-weight: 400;
            line-height: 1.3;
            margin-bottom: .5rem;
            color: var(--text-secondary);
        }

        .login-right-panel {
            background: var(--bg-secondary);
            flex-direction: column;
        }
        
        #authContainer {
            width: 100%;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            background-color: var(--bg-primary);
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #authContainer h2 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: .75rem;
            cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        .google-btn:hover { background-color: var(--button-hover-darken); border-color: var(--text-secondary); }
        .google-btn img { height: 20px; }
        
        #accessCodeInput {
             background-color: var(--bg-secondary);
             border: 1px solid var(--border-color);
             color: var(--text-primary);
             padding: 12px;
             border-radius: 6px;
             width: 100%;
             margin-bottom: 1rem;
             text-align: center;
        }
        #accessCodeInput:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
        }

        .btn-primary {
             background-color: var(--accent-green);
             color: #fff;
             padding: .75rem 1.5rem;
             border-radius: 6px;
             border: none;
             cursor: pointer;
             font-weight: 600;
        }
        .btn-primary:hover {
             background-color: var(--button-primary-lighten);
             transform: translateY(-1px);
        }
        
        #appSection {
            display: none;
            flex-direction: column;
            height: 100vh;
            background-color: var(--bg-primary);
            animation: fadeIn .6s ease-out both;
        }
        
        header {
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            padding: 0 24px;
            height: 64px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .logo-container { display: flex; align-items: center; gap: 1rem; }
        .logo-container h1 { font-size: 1.5rem; font-weight: 700; }
        .logo-container p { font-weight: 400; color: var(--text-secondary); }
        
        .header-actions { margin-left: auto; display: flex; align-items: center; gap: 1rem; }

        /* --- START: NEON BUTTON STYLES --- */
        .header-actions .tab.neon-button {
            position: relative;
            display: inline-block;
            padding: 10px 18px; /* Adjusted padding */
            color: var(--neon-glow-color);
            text-decoration: none;
            overflow: hidden;
            transition: .5s;
            border: 1px solid var(--neon-glow-color);
            border-radius: 6px;
            background: transparent;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.875rem; /* Adjusted font size */
        }
        
        .header-actions .tab.neon-button:hover,
        .header-actions .tab.neon-button.active {
            background: var(--neon-glow-color);
            color: var(--bg-secondary);
            border-radius: 66px;
            box-shadow: 0 0 5px var(--neon-glow-color),
                        0 0 25px var(--neon-glow-color),
                        0 0 50px var(--neon-glow-color),
                        0 0 100px var(--neon-glow-color);
        }

        .header-actions .tab.neon-button span {
            position: absolute;
            display: block;
        }

        .header-actions .tab.neon-button span:nth-child(1) {
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--neon-glow-color));
            animation: btn-anim1 1.5s linear infinite;
        }

        @keyframes btn-anim1 {
            0% { left: -100%; }
            50%,100% { left: 100%; }
        }

        .header-actions .tab.neon-button span:nth-child(2) {
            top: -100%;
            right: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, transparent, var(--neon-glow-color));
            animation: btn-anim2 1.5s linear infinite;
            animation-delay: .375s
        }

        @keyframes btn-anim2 {
            0% { top: -100%; }
            50%,100% { top: 100%; }
        }

        .header-actions .tab.neon-button span:nth-child(3) {
            bottom: 0;
            right: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(270deg, transparent, var(--neon-glow-color));
            animation: btn-anim3 1.5s linear infinite;
            animation-delay: .75s
        }

        @keyframes btn-anim3 {
            0% { right: -100%; }
            50%,100% { right: 100%; }
        }

        .header-actions .tab.neon-button span:nth-child(4) {
            bottom: -100%;
            left: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(360deg, transparent, var(--neon-glow-color));
            animation: btn-anim4 1.5s linear infinite;
            animation-delay: 1.125s
        }

        @keyframes btn-anim4 {
            0% { bottom: -100%; }
            50%,100% { bottom: 100%; }
        }
        /* --- END: NEON BUTTON STYLES --- */


        .user-info { display: flex; align-items: center; gap: 1rem; }
        #userDisplayName { font-weight: 500; cursor: pointer; }
        .logout-btn { background: none; border: 1px solid var(--accent-red); color: var(--accent-red); cursor: pointer; padding: 6px 12px; border-radius: 6px; font-weight: 600; }
        .logout-btn:hover { background: var(--button-red-lighten); }
        /* Style for Switch Role button */
        #switchRoleButton {
            background-color: var(--accent-blue);
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        #switchRoleButton:hover {
            background-color: var(--button-blue-lighten);
        }

        /* --- START: DROPDOWN STYLES --- */
        .dropdown-menu {
            position: relative;
            display: inline-block;
            padding-bottom: 10px;
            margin-bottom: -10px; 
        }
        
        .dropdown-menu-content {
            display: none;
            position: absolute;
            top: 100%; 
            left: 0;
            background-color: var(--bg-secondary);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
            z-index: 10;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding: 4px;
        }

        .dropdown-menu-content button {
            color: var(--text-primary);
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .dropdown-menu-content button:hover {
            background-color: var(--button-hover-darken);
            color: var(--accent-blue);
        }

        .dropdown-menu:hover .dropdown-menu-content {
            display: block;
        }
        /* --- END: DROPDOWN STYLES --- */


        main {
            flex: 1;
            display: flex;
            overflow-y: auto;
            padding: 24px;
            gap: 24px;
            padding-bottom: 100px;
        }
        
        /* Content Sections */
        #homeSection, #gradingSection, #chatSection, #studentManagementSection, #profileSection, #tutorialSection, #pastPapersSection, #exerciseSection {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            width: 100%;
        }
        #profileSection { max-width: 800px; margin: 0 auto; }

        /* Form elements */
        label { display: block; font-weight: 600; margin-bottom: 8px; }
        input[type="text"], input[type="number"], input[type="email"], select, input[type="url"] {
            width: 100%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 12px; border-radius: 6px; margin-bottom: 1rem;
        }
        textarea {
            width: 100%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 12px; border-radius: 6px; margin-bottom: 1rem; resize: vertical; min-height: 120px;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3); }
        
        .drop-zone { border: 2px dashed var(--border-color); border-radius: 6px; min-height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 1rem; margin-bottom: 1.5rem; cursor: pointer; word-wrap: break-word; padding: 1rem; text-align: center; }
        .drop-zone.highlight { border-color: var(--accent-blue); background: rgba(88, 166, 255, .1); }
        
        .file-preview { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; max-height: 200px; object-fit: contain; }
        .error-message { color: var(--accent-red); font-size: 0.875rem; margin-top: -0.5rem; margin-bottom: 1rem; }

        #gradeButton { background-color: var(--accent-green); color: #fff; }
        #gradeButton:hover { background-color: var(--button-primary-lighten); }

        #resultContainer { margin-top: 1.5rem; padding: 1rem; border-radius: 6px; background-color: var(--bg-secondary); border: 1px solid var(--border-color); min-height: 100px; white-space: pre-wrap; }
        #pastSubmissions { margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .submission-card { background-color: var(--bg-secondary); padding: 1rem; border-radius: 6px; border: 1px solid var(--border-color); }

        /* Chat styles */
        #chatSection, #studentManagementSection { display: none; flex-direction: column; gap: 1rem; }
        #chatDisplay { flex: 1; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { max-width: 85%; padding: 10px 14px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; }
        .chat-message.user { background-color: var(--accent-blue); color: var(--bg-primary); align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-message.gemini { background-color: var(--button-hover-darken); align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-input-wrapper { display: flex; gap: .5rem; flex-shrink: 0; }
        #chatInput { flex: 1; padding: .75rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-secondary); color: var(--text-primary); }
        #sendChatButton { padding: .5rem 1rem; border: none; background: var(--accent-blue); color: var(--bg-primary); border-radius: 6px; font-weight: 600; cursor: pointer; }
        #sendChatButton:hover { background-color: var(--button-blue-lighten); }
        
        .loading-indicator { text-align: center; padding: 1rem; color: var(--text-secondary); }

        /* Universal Section Title */
        .section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; }

        /* Form container */
        .form-container { max-width: 600px; margin-bottom: 2rem; background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color); }
        
        /* Student Management Styles */
        #authorizedStudentsList { display: flex; flex-direction: column; gap: 0.5rem; }
        .student-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-secondary); padding: 0.75rem 1rem; border-radius: 6px; border: 1px solid var(--border-color); }
        .delete-student-btn { background: none; border: none; color: var(--accent-red); cursor: pointer; padding: 4px; }
        .delete-student-btn:hover { background-color: var(--button-red-lighten); border-radius: 50%; }

        /* Universal Filter Styles */
        .filters-container { display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap; }
        
        /* Universal Grid Styles */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        
        /* Card Styles (for Tutorials, Papers, Exercises) */
        .material-card { background-color: var(--bg-secondary); border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); display: flex; flex-direction: column; position:relative; text-decoration: none; color: var(--text-primary); }
        .material-card-thumbnail { position: relative; cursor: pointer; }
        .material-card-thumbnail img { width: 100%; display: block; aspect-ratio: 16/9; object-fit: cover; }
        .material-card-content { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; }
        .material-card-content h3 { font-size: 1.1rem; margin-bottom: 0.5rem; }
        
        /* Teacher Content Management Styles (Tutorials, Papers, Exercises) */
        .content-item { 
            padding: 1rem; 
            border: 1px solid var(--border-color); 
            border-radius: 6px; 
            margin-bottom: 1rem; 
            background: var(--bg-primary); 
            /* Add styles for drag-and-drop targets */
            transition: background-color 0.2s ease-in-out;
        }
        .content-item.drag-over {
            background-color: rgba(88, 166, 255, 0.2); /* Highlight on drag over */
            border-color: var(--accent-blue);
        }

        .content-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            padding: 0.5rem 0; /* Add padding for click area */
        }
        .content-header h3, .content-header h4 { margin: 0; }
        .item-actions button { margin-left: 0.5rem; padding: 4px 8px; font-size: 0.8rem; }
        
        /* Nested container for collapsible content */
        .nested-container { 
            padding-left: 1.5rem; 
            margin-top: 0.5rem; /* Reduced margin */
            border-left: 2px solid var(--border-color); 
            overflow: hidden; /* For smooth transition */
            transition: max-height 0.3s ease-out; /* Smooth slide effect */
            max-height: 0; /* Initially collapsed */
        }
        .nested-container.expanded {
            max-height: 1000px; /* Arbitrary large value to allow full expansion */
        }

        .sub-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0.5rem; 
            border-radius: 4px; 
            cursor: grab; /* Indicate draggable */
        }
        .sub-item:hover { background-color: var(--button-hover-darken); }
        .sub-item a { color: var(--accent-blue); text-decoration: none; }
        .sub-item a:hover { text-decoration: underline; }

        /* Collapse/Expand Arrow */
        .collapse-arrow {
            margin-left: 10px;
            transition: transform 0.3s ease-out;
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid var(--text-secondary);
        }
        .content-header[aria-expanded="true"] .collapse-arrow {
            transform: rotate(90deg); /* Point right when expanded */
        }
        .content-header[aria-expanded="false"] .collapse-arrow {
            transform: rotate(0deg); /* Point down when collapsed */
        }


        /* Video Embedding Styles */
        .video-embed-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            border-radius: 8px 8px 0 0;
        }
        .video-embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .play-button-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            pointer-events: none; /* So it doesn't block the click on the container */
            transition: all 0.2s ease;
        }
        .material-card-thumbnail:hover .play-button-overlay {
            color: #fff;
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* --- E-COMMERCE STYLES --- */
        .store-layout {
            display: flex;
            gap: 24px;
            width: 100%;
        }
        .product-grid {
            flex-grow: 1;
        }
        .shopping-cart {
            width: 320px;
            flex-shrink: 0;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            height: fit-content;
        }
        .shopping-cart h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        #cart-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
        .cart-item-name {
            flex-grow: 1;
            margin-right: 1rem;
        }
        .cart-item-price {
            font-weight: 600;
            color: var(--accent-green);
        }
        .remove-from-cart-btn {
            background: none;
            border: none;
            color: var(--accent-red);
            cursor: pointer;
            font-size: 1rem;
            margin-left: 0.5rem;
        }
        #cart-summary {
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            margin-top: 1rem;
        }
        .summary-line {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        #cart-validation-message {
            font-size: 0.875rem;
            color: var(--accent-red);
            text-align: center;
            margin-top: 1rem;
            min-height: 20px;
        }
        #checkout-btn {
            width: 100%;
            margin-top: 1rem;
        }
        .product-card {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .product-card h4 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        .product-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 1rem;
        }
        .add-to-cart-btn, .download-btn {
            width: 100%;
        }
        .download-btn {
            background-color: var(--accent-blue);
        }
        .download-btn:hover {
            background-color: var(--button-blue-lighten);
        }

        /* Promo code styles */
        .promo-code-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        .promo-input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .promo-input-group input {
            flex-grow: 1;
            margin-bottom: 0; /* Override default input margin */
        }
        .promo-input-group button {
            flex-shrink: 0;
            padding: 8px 12px;
            font-size: 0.875rem;
        }
        .promo-display {
            font-size: 0.875rem;
            color: var(--accent-green);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .promo-display .remove-promo-btn {
            color: var(--accent-red);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }
        .promo-display .remove-promo-btn:hover {
            text-decoration: underline;
        }
        .promo-error {
            color: var(--accent-red);
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .promo-code-list {
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }
        .promo-code-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--border-color);
            font-size: 0.9rem;
        }
        .promo-code-item:last-child {
            border-bottom: none;
        }
        .promo-code-item span:first-child {
            font-weight: 600;
        }
        .promo-code-item .actions button {
            margin-left: 0.5rem;
            padding: 4px 8px;
            font-size: 0.75rem;
        }

        /* Teacher Purchase History Styles */
        .purchase-history-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .purchase-history-section h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .student-purchase-entry {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-primary);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        .student-purchase-entry strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--accent-blue);
        }
        .purchased-item-detail {
            font-size: 0.9rem;
            margin-left: 1rem;
            color: var(--text-secondary);
        }


        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; animation: fadeIn 0.3s ease-out; }
        .modal-content { background-color: var(--bg-secondary); padding: 30px; border-radius: 8px; border: 1px solid var(--border-color); max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; animation: slideInUp 0.3s ease-out; }
        #modalTitle { margin-bottom: 1rem; font-size: 1.5rem; font-weight: 600; }
        #modalMessage { line-height: 1.5; }
        .close-button { position: absolute; top: 10px; right: 15px; font-size: 28px; cursor: pointer; color: var(--text-secondary); }
        .close-button:hover { color: var(--text-primary); }
        #modalButtons { display:flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }

        /* Video Preview Modal Specific Styles */
        #videoPreviewModal .modal-content {
            max-width: 900px;
            width: 95%;
            padding: 15px;
        }
        #videoPreviewModal iframe {
            width: 100%;
            height: 500px; /* Adjust as needed or use aspect ratio trick */
            border-radius: 8px;
        }
        @media (max-width: 768px) {
            #videoPreviewModal iframe {
                height: 300px;
            }
        }


        /* Footer */
        footer { position: fixed; bottom: 0; right: 0; text-align: right; padding: 10px 20px; color: var(--text-secondary); font-size: 0.875rem; z-index: 100; pointer-events: none; }
        footer a { color: var(--accent-blue); text-decoration: none; pointer-events: all;}
        footer a:hover { text-decoration: underline; }

        /* Mobile responsiveness */
        @media (max-width: 992px) {
            .store-layout {
                flex-direction: column;
            }
            .shopping-cart {
                width: 100%;
                position: sticky;
                bottom: 0;
                border-radius: 8px 8px 0 0;
            }
        }
        @media (max-width: 768px) {
            #authWrapper { flex-direction: column; position: static; height: auto; }
            .login-left-panel, .login-right-panel { width: 100%; }
            header { flex-direction: column; height: auto; padding: 1rem; align-items: flex-start; }
            .header-actions { margin-left: 0; margin-top: 1rem; flex-wrap: wrap; }
            main { flex-direction: column; }
            .hero { flex-direction: column-reverse; text-align: center; }
            .hero-text, .hero-image { max-width: 100%; }
            .buttons { justify-content: center; }

            /* Hide finder view on mobile */
            .finder-window-wrapper { display: none !important; }
            .material-view-toggle { display: none !important; } /* Hide toggle on mobile */
        }

        /* Desktop responsiveness - show finder view */
        @media (min-width: 769px) {
            /* Hide card view on desktop when finder view is active */
            .material-card-view.hidden-on-desktop { display: none !important; }
            .finder-window-wrapper.hidden-on-desktop { display: none !important; }
        }


        /* Hero */
        .hero {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2rem 1.5rem;
            position: relative;
            overflow: hidden;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .hero-text {
            max-width: 50%;
            font-size: 2rem;
            font-weight: bold;
            opacity: 0;
            animation: slideInLeft 1s ease-out forwards;
        }
        .hero-text span {
            display: block;
            font-size: 1.5rem;
            font-weight: normal;
            margin-top: 0.5rem;
            color: var(--accent-blue);
        }
        .hero-image {
            max-width: 40%;
            opacity: 0;
            animation: slideInRight 1s ease-out forwards;
        }
        .hero-image img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* Buttons (on Home Page Hero) */
        .buttons {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
        }
        .buttons a {
            padding: 0.6rem 1.2rem;
            border: 2px solid var(--accent-blue);
            border-radius: 4px;
            font-size: 1rem;
            transition: background 0.2s, color 0.2s;
            color: var(--accent-blue);
            text-decoration: none;
        }
        .buttons a:hover {
            background: var(--accent-blue);
            color: #fff;
        }

        /* Why AI Section */
        .why-ai {
            padding: 2rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            margin-top: 2rem;
            border-radius: 8px;
        }
        .why-ai h2 {
            font-size: 1.75rem;
            margin-bottom: 1rem;
            color: var(--accent-green);
        }
        .why-ai p {
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Animations */
        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to   { transform: translateX(0);    opacity: 1; }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to   { transform: translateX(0);    opacity: 1; }
        }

        /* Finder Window Styles (from finder_style_materials.html) */
        .finder-window-wrapper {
            position: fixed; /* Use fixed to overlay content */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 960px;
            height: 600px;
            border: 1px solid #aaa;
            border-radius: 6px;
            background: #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 100; /* Ensure it's above other content */
            resize: both;
            min-width: 300px; /* Added for resizability */
            min-height: 200px; /* Added for resizability */
            color: #333; /* Default text color for finder window */
        }

        .finder-window-wrapper.fullscreen {
            top: 0 !important;
            left: 0 !important;
            transform: none !important;
            width: 100vw !important;
            height: 100vh !important;
            border-radius: 0 !important;
        }

        .finder-titlebar {
            background: #f2f2f2;
            height: 28px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            cursor: move;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .finder-titlebar .buttons {
            display: flex;
            gap: 6px;
        }
        .finder-circle {
            width: 12px; height: 12px; border-radius: 50%;
        }
        .finder-circle.close { background: #ff5f57; }
        .finder-circle.min { background: #ffbd2e; }
        .finder-circle.max { background: #28c840; cursor: pointer; }

        .finder-content {
            flex: 1;
            display: flex;
            overflow: hidden; /* Ensure content inside is scrollable if needed */
        }
        .finder-sidebar {
            width: 200px;
            min-width: 150px; /* Allow sidebar to shrink a bit */
            border-right: 1px solid #ddd;
            background: #fafafa;
            padding: 10px 0;
            overflow-y: auto; /* Enable scrolling for sidebar content */
            flex-shrink: 0;
        }
        .finder-sidebar-item {
            padding: 8px 15px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .finder-sidebar-item:hover {
            background: #e0e0e0;
        }
        .finder-sidebar-item.active {
            background: #007bff;
            color: #fff;
        }

        .finder-file-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Enable scrolling for file list content */
            background: #fff;
        }
        .finder-file-list .columns, .finder-file-list .row {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr; /* Name, Size, Kind, Date Added */
            padding: 8px 12px;
            border-bottom: 1px solid #ddd;
            align-items: center;
        }
        .finder-file-list .columns { background: #f7f7f7; font-size: 12px; color: #666; font-weight: 600;}
        .finder-file-list .row { font-size: 14px; color: #333; cursor: pointer; }
        .finder-file-list .row:hover { background: #f0f8ff; }
        .finder-file-list .row.folder { font-weight: bold; color: #007bff; } /* Style for folders */
        .finder-file-list .row.folder::before { content: '📁 '; margin-right: 5px; } /* Folder icon */
        .finder-file-list .row.file::before { content: '📄 '; margin-right: 5px; } /* File icon */
        .finder-file-list .row.video::before { content: '🎬 '; margin-right: 5px; } /* Video icon */
        .finder-file-list .row.exercise::before { content: '📝 '; margin-right: 5px; } /* Exercise icon */
        .finder-file-list .row.purchased { color: var(--accent-green); } /* Purchased item */

        .finder-footer {
            text-align: right;
            font-size: 11px;
            color: #999;
            padding: 5px 10px;
            border-top: 1px solid #ddd;
            background: #fafafa;
            flex-shrink: 0;
        }

        /* Hide the finder window by default, show via JS */
        #finderMaterialsSection {
            display: none;
            position: fixed; /* Position within main content area */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 960px;
            height: 600px;
            justify-content: center;
            align-items: center;
        }

        /* Toggle button for view mode */
        .material-view-toggle {
            margin-left: 1rem;
            padding: 6px 12px;
            font-size: 0.875rem;
            border-radius: 6px;
            background-color: var(--accent-blue);
            color: #fff;
            border: none;
            cursor: pointer;
        }
        .material-view-toggle:hover {
            background-color: var(--button-blue-lighten);
        }

    </style>
</head>
<body>

    <div id="authWrapper" style="display: none;">
        <div class="login-left-panel">
            <h1>Let AI mark your work.</h1>
            <p>Let AI assist you, not replace you</p>
            <p>Mark with AI, learn better</p>
        </div>
        <div class="login-right-panel">
            <div id="authContainer">
                 <!-- JS will inject googleSignInTemplate or codeEntryTemplate -->
            </div>
        </div>
    </div>

    <div id="appSection" style="display: none;">
        <header>
            <div class="logo-container">
                <h1>AI Marker</h1>
                <p>Operated by Darren Ng</p>
            </div>
            <div class="header-actions">
                <button id="toggleHomeButton" class="tab neon-button active">
                    <span></span><span></span><span></span><span></span>
                    Home
                </button>
                
                <div class="dropdown-menu">
                    <button class="tab neon-button" id="workWithAIButton">
                        <span></span><span></span><span></span><span></span>
                        Work with AI
                    </button>
                    <div class="dropdown-menu-content">
                        <button id="toggleGradingButton" class="tab">Exam Grader</button>
                        <button id="toggleChatButton" class="tab">Chat with Gemini</button>
                    </div>
                </div>

                <div class="dropdown-menu">
                    <button class="tab neon-button" id="materialsButton">
                        <span></span><span></span><span></span><span></span>
                        Materials
                    </button>
                    <div class="dropdown-menu-content">
                        <button id="toggleTutorialButton" class="tab">Tutorial Videos</button>
                        <button id="togglePastPapersButton" class="tab">Past Papers</button>
                        <button id="toggleExercisesButton" class="tab">Exercises for Sale</button>
                    </div>
                </div>

                <button id="manageStudentsButton" class="tab neon-button" style="display: none;">
                    <span></span><span></span><span></span><span></span>
                    Manage Students
                </button>
                <button id="toggleProfileButton" class="tab neon-button">
                    <span></span><span></span><span></span><span></span>
                    Profile
                </button>
                <button id="themeToggleButton" class="tab neon-button">
                    <span></span><span></span><span></span><span></span>
                    Theme
                </button>
                <div class="user-info">
                     <span id="userDisplayName"></span>
                     <button id="switchRoleButton" class="btn-primary">Switch Role</button>
                     <button id="logoutButton" class="logout-btn">Log Out</button>
                </div>
            </div>
        </header>
        
        <main>
            <!-- Home Section -->
            <div id="homeSection" style="display: block; opacity: 1;">
                <section class="hero">
                    <div class="hero-text">
                        AI helps you learn better
                        <span>to fight DSE</span>
                        <div class="buttons">
                            <a href="#tutorial" id="homeTutorialLink">Tutorial Video</a>
                            <a href="#grader" id="homeGraderLink">Exam Grader</a>
                            <a href="#chat" id="homeChatLink">Chat with AI</a>
                        </div>
                    </div>
                    <div class="hero-image">
                        <img src="https://drive.google.com/uc?export=download&id=1wdjIr6SjqlgEjulvbpuNa08HHSMX623t" alt="Darren Ng demonstrating AI Marker">
                    </div>
                </section>

                <section class="why-ai" id="why-ai">
                    <h2>Why AI</h2>
                    <p>
                        AI serves as a powerful assistant in your studies, especially when preparing for challenging exams like DSE. It can provide instant feedback on your work, identify areas where you need improvement, and offer personalized explanations. Unlike traditional methods, AI can analyze vast amounts of information and adapt to your learning style, making your study sessions more efficient and effective. It helps you grasp complex concepts, practice critical thinking, and build confidence, ultimately empowering you to perform your best.
                    </p>
                </section>
            </div>

            <!-- Grading Section -->
            <div id="gradingSection">
                <h2 class="section-title">Exam Grader</h2>
                <div class="mb-4">
                    <label>Upload Student's Work (Image or PDF):</label>
                    <div id="studentDropZone" class="drop-zone">
                        <span>Drag & Drop Student's Work Here or click to select</span>
                        <input type="file" id="studentAnswerFile" accept="image/*,application/pdf" hidden>
                    </div>
                     <span id="studentFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                    <img id="studentFilePreview" class="file-preview mx-auto" style="display: none;" alt="Student Work Preview">
                    <label for="studentAnswer">Or type Student's Answer:</label>
                    <textarea id="studentAnswer" placeholder="Enter student's answer here..."></textarea>
                    <p id="studentAnswerError" class="error-message"></p>
                </div>

                <div class="mb-6">
                    <label>Upload Answer Key (Image or PDF):</label>
                    <div id="answerKeyDropZone" class="drop-zone">
                        <span>Drag & Drop Answer Key Here or click to select</span>
                         <input type="file" id="answerKeyFile" accept="image/*,application/pdf" hidden>
                    </div>
                    <span id="answerKeyFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                    <img id="answerKeyFilePreview" class="file-preview mx-auto" style="display: none;" alt="Answer Key Preview">
                    <label for="answerKey">Or type Answer Key:</label>
                    <textarea id="answerKey" placeholder="Enter the correct answer key here..."></textarea>
                    <p id="answerKeyError" class="error-message"></p>
                </div>

                <button id="gradeButton" class="btn-primary">Grade Work</button>
                <p id="gradingLoadingIndicator" class="loading-indicator"></p>
                <div id="resultContainer">
                    <h2>Grading Results:</h2>
                    <p id="gradeResult">Your grading results will appear here.</p>
                </div>

                <div style="margin-top: 2rem;">
                    <h2>Past Submissions:</h2>
                    <div id="pastSubmissions">
                        <p id="noSubmissions">No past submissions found.</p>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="chatSection">
                <div id="chatDisplay">
                    <div class="chat-message gemini">Hello! How can I help you today?</div>
                </div>
                <div class="chat-input-wrapper">
                    <input type="text" id="chatInput" placeholder="Type a message…">
                    <button id="sendChatButton">Send</button>
                </div>
                 <p id="chatLoadingIndicator" class="loading-indicator"></p>
            </div>

            <!-- Student Management Section -->
            <div id="studentManagementSection">
                <h2 class="section-title">Manage Authorized Students</h2>
                <div class="add-student-form form-container">
                    <input type="email" id="studentEmailInput" placeholder="Enter student's Gmail address">
                    <button id="addStudentButton" class="btn-primary">Add Student</button>
                </div>
                <p id="studentManagementLoading" class="loading-indicator"></p>
                <div id="authorizedStudentsList">
                    <p id="noAuthorizedStudents">No authorized students yet.</p>
                </div>
            </div>

            <!-- Generic Material Section Template -->
            <div id="tutorialSection"></div>
            <div id="pastPapersSection"></div>
            <div id="exerciseSection"></div>
            
            <!-- Profile Section -->
            <div id="profileSection">
                <h2 class="section-title">Edit Your Profile</h2>
                <form id="profileForm" class="form-container">
                    <div style="margin-bottom: 1rem;">
                        <label for="profileName">Display Name</label>
                        <input type="text" id="profileName" name="name" required>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileAge">Age</label>
                        <input type="number" id="profileAge" name="age">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileGrade">Year/Grade</label>
                        <input type="text" id="profileGrade" name="grade">
                    </div>
                     <div style="margin-bottom: 1rem;">
                        <label for="profileSchool">School</label>
                        <input type="text" id="profileSchool" name="school">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileElectives">Elective Subjects</label>
                        <textarea id="profileElectives" name="electives" placeholder="e.g., Physics, Computer Science, Art"></textarea>
                    </div>
                    <button type="submit" id="saveProfileButton" class="btn-primary">Save Profile</button>
                </form>
            </div>

            <!-- Finder Style Materials Section (Desktop Only) -->
            <div id="finderMaterialsSection" class="finder-window-wrapper">
                <div class="finder-titlebar" id="finderDragBar">
                    <div class="buttons">
                        <div class="finder-circle close"></div>
                        <div class="finder-circle min"></div>
                        <div class="finder-circle max" id="finderFullscreenToggle"></div>
                    </div>
                    <span style="margin-left: 10px; font-weight: bold;">Materials</span>
                </div>

                <div class="finder-content">
                    <aside class="finder-sidebar" id="finderSidebar">
                        <!-- Level 1 items (Subjects) will be loaded here -->
                    </aside>
                    <section class="finder-file-list">
                        <div class="columns">
                            <div>Name</div><div>Size</div><div>Kind</div><div>Date Added</div>
                        </div>
                        <div id="finderFileListContent">
                            <!-- Level 2 items (Topics/Years) or Level 3 items (Files) will be loaded here -->
                            <p style="text-align:center; padding:20px; color:#666;">Select a subject from the sidebar.</p>
                        </div>
                    </section>
                </div>

                <div class="finder-footer">Contact: darren_0625@mc-zero.com | © 2025 Darren Ng</div>
            </div>

        </main>
    </div>

    <footer>
        <a href="mailto:darren_0625@mc-zero.com">Contact: darren_0625@mc-zero.com</a> | Copyright © 2025 Operated by Darren Ng
    </footer>

    <!-- Universal Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle"></h3>
            <div id="modalMessage"></div>
            <div id="modalButtons"></div>
        </div>
    </div>
    
    <!-- Modals for adding content -->
    <div id="addVideoModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3>Add New Tutorial Video</h3>
             <form id="addVideoForm">
                <input type="hidden" id="videoParentId1">
                <input type="hidden" id="videoParentId2">
                 <div style="margin-bottom: 1rem;">
                     <label for="tutorialLink">YouTube Link or Embed Code</label>
                     <textarea id="tutorialLink" required placeholder="Paste a YouTube URL or an <iframe> embed code here..."></textarea>
                     <img id="tutorialThumbnailPreview" style="max-width:200px; margin-top:10px; border-radius:8px; display:none;" alt="Video Thumbnail Preview"/>
                 </div>
                 <div style="margin-bottom: 1rem;">
                     <label for="tutorialTitle">Video Title</label>
                     <input type="text" id="tutorialTitle" required>
                 </div>
                 <div class="modal-form-buttons">
                    <button type="submit" class="btn-primary">Add Video</button>
                 </div>
             </form>
        </div>
    </div>

    <div id="addPastPaperModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3>Add New Past Paper</h3>
             <form id="addPastPaperForm">
                <input type="hidden" id="paperParentId1">
                <input type="hidden" id="paperParentId2">
                 <div style="margin-bottom: 1rem;">
                     <label for="pastPaperName">Paper Name / Title</label>
                     <input type="text" id="pastPaperName" required placeholder="e.g., Paper 1 Section A">
                 </div>
                 <div style="margin-bottom: 1rem;">
                    <label>Upload File (PDF only)</label>
                    <div id="pastPaperDropZone" class="drop-zone">
                        <span>Drag & Drop PDF Here or click to select</span>
                        <input type="file" id="pastPaperFile" accept="application/pdf" hidden>
                    </div>
                    <span id="pastPaperFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                </div>
                <p style="text-align:center; margin-bottom: 1rem; color: var(--text-secondary);">OR</p>
                <div style="margin-bottom: 1rem;">
                    <label for="pastPaperLink">Paste External Link (for large files)</label>
                    <input type="url" id="pastPaperLink" placeholder="https://example.com/document.pdf">
                </div>
                 <div class="modal-form-buttons">
                    <button type="submit" class="btn-primary">Add Paper</button>
                 </div>
             </form>
        </div>
    </div>

    <div id="addExerciseModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3>Add New Exercise</h3>
             <form id="addExerciseForm">
                <input type="hidden" id="exerciseParentId1">
                <input type="hidden" id="exerciseParentId2">
                 <div style="margin-bottom: 1rem;">
                     <label for="exerciseName">Exercise Name / Title</label>
                     <input type="text" id="exerciseName" required placeholder="e.g., Chapter 1 MCQs">
                 </div>
                 <div style="margin-bottom: 1rem;">
                     <label for="exercisePrice">Price (USD)</label>
                     <input type="number" id="exercisePrice" required placeholder="e.g., 10.00" step="0.01" min="0">
                 </div>
                 <div style="margin-bottom: 1rem;">
                    <label>Upload File (PDF only)</label>
                    <div id="exerciseDropZone" class="drop-zone">
                        <span>Drag & Drop PDF Here or click to select</span>
                        <input type="file" id="exerciseFile" accept="application/pdf" hidden>
                    </div>
                    <span id="exerciseFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                </div>
                <p style="text-align:center; margin-bottom: 1rem; color: var(--text-secondary);">OR</p>
                <div style="margin-bottom: 1rem;">
                    <label for="exerciseLink">Paste External Link (for large files)</label>
                    <input type="url" id="exerciseLink" placeholder="https://example.com/document.pdf">
                </div>
                 <div class="modal-form-buttons">
                    <button type="submit" class="btn-primary">Add Exercise</button>
                 </div>
             </form>
        </div>
    </div>

    <!-- Video Preview Modal -->
    <div id="videoPreviewModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="videoPreviewTitle"></h3>
            <div id="videoPreviewContent"></div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, where, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";

        // --- IMPORTANT CONFIGURATION ---
        // TODO: PASTE YOUR STRIPE PAYMENT LINK HERE
        // Create a product in Stripe with a price, then create a payment link for it.
        const STRIPE_PAYMENT_LINK = "https://buy.stripe.com/14A28t1kAfr2gnx04L0ZW0n"; 

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
          authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30",
          storageBucket: "ai-grading-9bb30.appspot.com", // Corrected storage bucket URL
          messagingSenderId: "298162112230",
          appId: "1:298162112230:web:529d3f95536991be685d27",
          measurementId: "G-CHKLKSM17S"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const CLOUDFLARE_WORKER_URL = "https://ai-marker-gemini-proxy.darren-xie11.workers.dev/";
        const TEACHER_CODE = "TEACHER123";
        const STUDENT_CODE = "STUDENT456";

        pdfjsLib.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let app, db, auth, storage;
        let currentUserId = null, currentUserEmail = null, currentUserRole = null, currentUserName = null;
        let geminiChatHistory = [{ role: "user", parts: [{text: "You are an AI assistant."}]}, { role: "model", parts: [{text: "Hello! How can I assist you?"}]}];
        let shoppingCart = [];
        let appliedPromoCode = null; // New variable to store applied promo code details

        // --- AUTH & INITIALIZATION ---
        
        const authWrapper = document.getElementById('authWrapper');
        const appSection = document.getElementById('appSection');
        const authContainer = document.getElementById('authContainer');

        const googleSignInTemplate = `
            <h2>Sign In</h2>
            <button id="googleSignInButton" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
                <span>Sign in with Google</span>
            </button>
            <p id="authError" class="error-message"></p>
        `;

        const codeEntryTemplate = `
            <h2>Enter Access Code</h2>
            <p style="color: var(--text-secondary); text-align: center; margin-bottom: 1rem;">Please enter the access code provided by your administrator.</p>
            <input type="text" id="accessCodeInput" placeholder="Enter code here">
            <button id="submitCodeButton" class="btn-primary" style="width:100%">Submit Code</button>
            <p id="codeError" class="error-message"></p>
        `;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showModal('Firebase Configuration Error', `Failed to initialize Firebase. Error: ${error.message}`);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                currentUserEmail = user.email;
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                try {
                    const userProfileDoc = await getDoc(userProfileRef);
                    if (userProfileDoc.exists() && userProfileDoc.data().role) {
                        const profileData = userProfileDoc.data();
                        currentUserRole = profileData.role;
                        currentUserName = profileData.name || user.displayName;
                        await setDoc(userProfileRef, { name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                        showApp();
                    } else {
                        currentUserName = user.displayName;
                        currentUserRole = 'unassigned';
                        showCodeEntry();
                    }
                } catch (e) {
                     console.error("Error checking user profile:", e);
                     showModal('Profile Error', `Could not load user profile. Error: ${e.message}`);
                     showLogin();
                }
            } else {
                currentUserId = null;
                currentUserRole = null;
                currentUserName = null;
                showLogin();
            }
        });

        function showLogin() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authWrapper.style.opacity = '1';
            authContainer.innerHTML = googleSignInTemplate;
            document.getElementById('googleSignInButton')?.addEventListener('click', handleGoogleSignIn);
        }

        function showCodeEntry() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authWrapper.style.opacity = '1';
            authContainer.innerHTML = codeEntryTemplate;
            const submitCodeBtn = document.getElementById('submitCodeButton');
            const accessCodeInput = document.getElementById('accessCodeInput');
            submitCodeBtn?.addEventListener('click', () => handleSubmitCode());
            accessCodeInput?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSubmitCode();
                }
            });
            accessCodeInput?.focus();
        }

        async function showApp() {
            authWrapper.style.display = 'none';
            appSection.style.display = 'flex';
            document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
            document.getElementById('manageStudentsButton').style.display = currentUserRole === 'teacher' ? 'block' : 'none';
            
            initializeAllMaterialSections();
            await checkForSuccessfulPurchase();

            showSection('homeSection');
            loadPastSubmissions();
            if(currentUserRole === 'teacher') {
                loadAuthorizedStudents();
                loadStudentPurchasesForTeacher(); // Load purchase history for teacher
            }

            document.getElementById('homeTutorialLink')?.addEventListener('click', (e) => { e.preventDefault(); showSection('tutorialSection'); });
            document.getElementById('homeGraderLink')?.addEventListener('click', (e) => { e.preventDefault(); showSection('gradingSection'); });
            document.getElementById('homeChatLink')?.addEventListener('click', (e) => { e.preventDefault(); showSection('chatSection'); });
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try { 
                await signInWithPopup(auth, provider); 
            } catch (error) { 
                document.getElementById('authError').textContent = `Sign-in failed. Error: ${error.message}`; 
                console.error("Google Sign-In Error:", error);
            }
        }

        async function handleSubmitCode(codeValue) {
            const code = (codeValue || document.getElementById('accessCodeInput').value).trim();
            const codeError = document.getElementById('codeError');
            if(codeError) codeError.textContent = '';
            
            let roleToSet = null;
            if (code === TEACHER_CODE) roleToSet = 'teacher';
            else if (code === STUDENT_CODE) roleToSet = 'student';
            else { 
                if(codeError) codeError.textContent = 'Invalid access code.';
                return; 
            }
            
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await setDoc(userProfileRef, { role: roleToSet, name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                currentUserRole = roleToSet;
                showModal('Success!', `Your role has been set to ${roleToSet}.`);
                showApp();
            } catch (error) {
                if(codeError) codeError.textContent = `Could not set role. Error: ${e.message}`;
                console.error("Submit Code Error:", error);
            }
        }

        document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));

        document.getElementById('switchRoleButton').addEventListener('click', () => {
            showInputModal('Switch Role', 'Enter new access code (Teacher or Student):', async (code) => {
                await handleSubmitCode(code);
            });
        });

        // --- NAVIGATION & UI ---

        let currentMaterialViewMode = 'card'; // 'card' or 'finder'

        function showSection(sectionIdToShow) {
            const sections = ['homeSection', 'gradingSection', 'chatSection', 'studentManagementSection', 'profileSection', 'tutorialSection', 'pastPapersSection', 'exerciseSection'];
            const buttons = {
                toggleHomeButton: 'homeSection',
                workWithAIButton: ['gradingSection', 'chatSection'],
                materialsButton: ['tutorialSection', 'pastPapersSection', 'exerciseSection'],
                manageStudentsButton: 'studentManagementSection',
                toggleProfileButton: 'profileSection'
            };
            
            document.querySelectorAll('.header-actions .tab.neon-button').forEach(t => t.classList.remove('active'));

            let activeButtonId = null;
            for (const [btnId, secId] of Object.entries(buttons)) {
                if (Array.isArray(secId) && secId.includes(sectionIdToShow)) {
                    activeButtonId = btnId;
                    break;
                }
                if (secId === sectionIdToShow) {
                    activeButtonId = btnId;
                    break;
                }
            }
            if (activeButtonId) {
                document.getElementById(activeButtonId)?.classList.add('active');
            }

            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    const isTarget = id === sectionIdToShow;
                    section.style.display = isTarget ? (id === 'chatSection' || id === 'studentManagementSection' ? 'flex' : 'block') : 'none';
                    setTimeout(() => section.style.opacity = isTarget ? '1' : '0', 10);
                }
            });

            // Handle visibility of finder window based on section and screen size
            const finderSection = document.getElementById('finderMaterialsSection');
            const isMaterialSection = ['tutorialSection', 'pastPapersSection', 'exerciseSection'].includes(sectionIdToShow);
            
            if (isMaterialSection && window.innerWidth >= 769) { // Desktop
                finderSection.style.display = currentMaterialViewMode === 'finder' ? 'flex' : 'none';
                // Hide card view if finder is active
                document.getElementById(sectionIdToShow).classList.toggle('hidden-on-desktop', currentMaterialViewMode === 'finder');
            } else { // Mobile or non-material section
                finderSection.style.display = 'none';
                document.getElementById(sectionIdToShow).classList.remove('hidden-on-desktop');
            }


            if (sectionIdToShow === 'profileSection') loadProfileData();
            if (sectionIdToShow === 'exerciseSection' && currentUserRole === 'teacher') {
                loadPromoCodesForTeacher(); // Load promo codes when teacher views exercises
                loadStudentPurchasesForTeacher(); // Also load student purchases
            }
        }

        function setupSectionToggle() {
            document.getElementById('toggleHomeButton')?.addEventListener('click', () => showSection('homeSection'));
            document.getElementById('toggleGradingButton')?.addEventListener('click', () => showSection('gradingSection'));
            document.getElementById('toggleChatButton')?.addEventListener('click', () => showSection('chatSection'));
            document.getElementById('manageStudentsButton')?.addEventListener('click', () => showSection('studentManagementSection'));
            document.getElementById('toggleProfileButton')?.addEventListener('click', () => showSection('profileSection'));
            
            // Materials dropdown buttons
            document.getElementById('toggleTutorialButton')?.addEventListener('click', () => {
                showSection('tutorialSection');
                if (window.innerWidth >= 769) { // On desktop, default to finder view if it's active
                    if (currentMaterialViewMode === 'finder') showFinderView('tutorials');
                    else renderStudentItems('tutorials'); // Re-render card view if that's active
                } else {
                    renderStudentItems('tutorials'); // Always card view on mobile
                }
            });
            document.getElementById('togglePastPapersButton')?.addEventListener('click', () => {
                showSection('pastPapersSection');
                if (window.innerWidth >= 769) {
                    if (currentMaterialViewMode === 'finder') showFinderView('pastPapers');
                    else renderStudentItems('pastPapers');
                } else {
                    renderStudentItems('pastPapers');
                }
            });
            document.getElementById('toggleExercisesButton')?.addEventListener('click', () => {
                showSection('exerciseSection');
                if (window.innerWidth >= 769) {
                    if (currentMaterialViewMode === 'finder') showFinderView('exercises');
                    else renderStudentItems('exercises');
                } else {
                    renderStudentItems('exercises');
                }
            });
            
            document.getElementById('userDisplayName')?.addEventListener('click', () => showSection('profileSection'));
        }
        setupSectionToggle();
        
        // --- PROFILE MANAGEMENT ---

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) { showModal('Error', 'You must be logged in to save your profile.'); return; }
            
            const formData = new FormData(e.target);
            const profileData = Object.fromEntries(formData.entries());
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            try {
                await setDoc(userProfileRef, profileData, { merge: true });
                currentUserName = profileData.name;
                document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
                showModal('Success', 'Your profile has been updated!');
            } catch (error) {
                console.error("Error saving profile:", error);
                showModal('Error', `Could not save profile: ${error.message}`);
            }
        });

        async function loadProfileData() {
            if (!currentUserId) return;
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            const docSnap = await getDoc(userProfileRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('profileName').value = data.name || '';
                document.getElementById('profileAge').value = data.age || '';
                document.getElementById('profileGrade').value = data.grade || '';
                document.getElementById('profileSchool').value = data.school || '';
                document.getElementById('profileElectives').value = data.electives || '';
            }
        }
        
        // --- REFACTORED MATERIALS MANAGEMENT ---

        const materialsConfig = {
            tutorials: {
                sectionId: 'tutorialSection',
                collectionName: 'tutorials',
                title: 'Tutorial Videos',
                level1: 'Subject',
                level2: 'Topic',
                level3: 'Video',
                modalId: 'addVideoModal',
                isPaid: false
            },
            pastPapers: {
                sectionId: 'pastPapersSection',
                collectionName: 'pastPapers',
                title: 'Past Papers',
                level1: 'Subject',
                level2: 'Year',
                level3: 'Paper',
                modalId: 'addPastPaperModal',
                isPaid: false
            },
            exercises: {
                sectionId: 'exerciseSection',
                collectionName: 'exercises',
                title: 'Exercises for Sale',
                level1: 'Subject',
                level2: 'Topic',
                level3: 'Exercise',
                modalId: 'addExerciseModal',
                isPaid: true
            }
        };

        function getPath(type, ids = []) {
            const collection = materialsConfig[type].collectionName;
            const pathParts = [`artifacts/${appId}/public/data/${collection}`];
            if (ids[0]) pathParts.push(ids[0], materialsConfig[type].level2.toLowerCase() + 's');
            if (ids[1]) pathParts.push(ids[1], materialsConfig[type].level3.toLowerCase() + 's');
            return pathParts.join('/');
        }

        function initializeAllMaterialSections() {
            for (const type in materialsConfig) {
                setupMaterialSection(type);
            }
            // Add delegated event listener for YouTube thumbnails
            document.getElementById('tutorialSection').addEventListener('click', (e) => {
                const thumbnail = e.target.closest('.material-card-thumbnail[data-youtube-id]');
                if (thumbnail) {
                    e.preventDefault();
                    const videoId = thumbnail.dataset.youtubeId;
                    const embedContainer = document.createElement('div');
                    embedContainer.className = 'video-embed-container';
                    embedContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                    thumbnail.replaceWith(embedContainer);
                }
            });

            // Setup the Finder window's drag/resize/fullscreen
            setupFinderWindow();
        }

        function setupMaterialSection(type) {
            const config = materialsConfig[type];
            const section = document.getElementById(config.sectionId);

            let studentViewHtml = `
                <div class="filters-container">
                    <select id="level1-${type}-filter" style="width:250px;"><option>-- Select ${config.level1} --</option></select>
                    <select id="level2-${type}-filter" style="width:250px;" disabled><option>-- Select ${config.level2} --</option></select>
                </div>
                <div id="level3-${type}-grid" class="grid-container"></div>`;

            if (config.isPaid) {
                studentViewHtml = `
                    <div class="store-layout">
                        <div class="product-grid">
                            ${studentViewHtml}
                        </div>
                        <div class="shopping-cart">
                            <h3>Shopping Cart</h3>
                            <div id="cart-items"></div>
                            <div id="cart-summary">
                                <div class="summary-line">
                                    <span>Subtotal:</span>
                                    <span id="cart-subtotal-price">$0.00</span>
                                </div>
                                <div class="summary-line" id="promo-discount-line" style="display:none;">
                                    <span>Promo Discount:</span>
                                    <span id="cart-promo-discount">-$0.00</span>
                                </div>
                                <div class="summary-line">
                                    <span>Total Price:</span>
                                    <span id="cart-total-price">$0.00</span>
                                </div>
                            </div>
                            <div class="promo-code-section">
                                <label for="promoCodeInput">Promo Code:</label>
                                <div class="promo-input-group">
                                    <input type="text" id="promoCodeInput" placeholder="Enter promo code">
                                    <button id="applyPromoCodeBtn" class="btn-primary">Apply</button>
                                </div>
                                <div id="appliedPromoCodeDisplay" class="promo-display" style="display:none;">
                                    <span>Applied: <span id="appliedPromoCodeText"></span></span>
                                    <button id="removePromoCodeBtn" class="remove-promo-btn">Remove</button>
                                </div>
                                <p id="promoCodeError" class="promo-error"></p>
                            </div>
                            <div id="cart-validation-message"></div>
                            <button id="checkout-btn" class="btn-primary" disabled>Proceed to Checkout</button>
                        </div>
                    </div>`;
            }

            section.innerHTML = `
                <h2 class="section-title">${config.title}</h2>
                <div id="teacher-${type}-view" style="display:none;">
                    <div class="form-container" style="max-width: initial;">
                        <button id="add-level1-${type}-btn" class="btn-primary">Add New ${config.level1}</button>
                        <button id="toggle-view-mode-${type}" class="material-view-toggle">Switch View Mode</button>
                        <p id="view-mode-status-${type}" style="display:inline-block; margin-left:1rem; color:var(--text-secondary);"></p>
                    </div>
                    <div id="level1-${type}-container" class="folder-view"></div>
                    <div id="board-view-${type}" style="display:none; padding:1rem; border:1px dashed var(--border-color); min-height:300px; text-align:center; color:var(--text-secondary);">
                        Board View (Future Feature)
                        <p>This will be an interactive tree diagram or board where you can freely move files.</p>
                    </div>
                    ${type === 'exercises' ? `
                        <div class="form-container" style="max-width: initial; margin-top: 2rem;">
                            <h3>Promo Code Management</h3>
                            <div style="margin-bottom: 1rem;">
                                <label for="promoDiscountAmount">Discount Amount ($)</label>
                                <input type="number" id="promoDiscountAmount" placeholder="e.g., 10.00" step="0.01" min="0">
                            </div>
                            <button id="generatePromoCodeBtn" class="btn-primary">Generate New Promo Code</button>
                            <p id="promoCodeGenerationStatus" class="loading-indicator"></p>
                            <div class="promo-code-list" id="teacherPromoCodeList">
                                <p>No promo codes generated yet.</p>
                            </div>
                        </div>
                        <div class="purchase-history-section">
                            <h3>Student Purchase History</h3>
                            <div id="studentPurchaseHistoryList">
                                <p class="loading-indicator">Loading purchase history...</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
                <div id="student-${type}-view" style="display:none;">
                    ${studentViewHtml}
                </div>`;

            const isTeacher = currentUserRole === 'teacher';
            document.getElementById(`teacher-${type}-view`).style.display = isTeacher ? 'block' : 'none';
            document.getElementById(`student-${type}-view`).style.display = isTeacher ? 'none' : 'block';

            if (isTeacher) {
                renderContent(type, `level1-${type}-container`, 1);
                document.getElementById(`add-level1-${type}-btn`).onclick = () => showAddItemModal(type, 1);
                document.getElementById(`level1-${type}-container`).addEventListener('click', (e) => handleTeacherClick(e, type));
                
                // Add drag-and-drop event listeners to the main container for the teacher view
                const teacherViewContainer = document.getElementById(`teacher-${type}-view`);
                teacherViewContainer.addEventListener('dragover', (e) => handleDragOver(e, type));
                teacherViewContainer.addEventListener('drop', (e) => handleDrop(e, type));
                teacherViewContainer.addEventListener('dragleave', (e) => handleDragLeave(e, type));


                const toggleViewBtn = document.getElementById(`toggle-view-mode-${type}`);
                const folderView = document.getElementById(`level1-${type}-container`);
                const boardView = document.getElementById(`board-view-${type}`);
                const viewStatus = document.getElementById(`view-mode-status-${type}`);
                
                let currentTeacherMaterialViewMode = 'folder'; // 'folder' or 'board'

                const updateViewDisplay = () => {
                    if (currentTeacherMaterialViewMode === 'folder') {
                        folderView.style.display = 'block';
                        boardView.style.display = 'none';
                        viewStatus.textContent = '(Current: Folder View)';
                    } else {
                        folderView.style.display = 'none';
                        boardView.style.display = 'block';
                        viewStatus.textContent = '(Current: Board View)';
                    }
                };

                toggleViewBtn.onclick = () => {
                    currentTeacherMaterialViewMode = currentTeacherMaterialViewMode === 'folder' ? 'board' : 'folder';
                    updateViewDisplay();
                };
                updateViewDisplay(); // Set initial display

                if (type === 'exercises') {
                    document.getElementById('generatePromoCodeBtn').addEventListener('click', generateAndSavePromoCode);
                    // Initial load of promo codes for teacher
                    loadPromoCodesForTeacher();
                }
            } else { // Student view
                setupStudentFilters(type);
                if(config.isPaid) {
                    document.getElementById('checkout-btn').addEventListener('click', handleCheckout);
                    document.getElementById('applyPromoCodeBtn').addEventListener('click', applyPromoCode);
                    document.getElementById('removePromoCodeBtn').addEventListener('click', removeAppliedPromoCode);
                }

                // Add toggle for student view (desktop only)
                if (window.innerWidth >= 769) {
                    const studentViewContainer = document.getElementById(`student-${type}-view`);
                    const materialsSectionTitle = section.querySelector('.section-title');
                    const toggleButton = document.createElement('button');
                    toggleButton.className = 'material-view-toggle';
                    toggleButton.textContent = 'Switch to Finder View';
                    materialsSectionTitle.appendChild(toggleButton); // Append next to title

                    toggleButton.addEventListener('click', () => {
                        if (currentMaterialViewMode === 'card') {
                            currentMaterialViewMode = 'finder';
                            studentViewContainer.classList.add('hidden-on-desktop');
                            showFinderView(type);
                            toggleButton.textContent = 'Switch to Card View';
                        } else {
                            currentMaterialViewMode = 'card';
                            studentViewContainer.classList.remove('hidden-on-desktop');
                            document.getElementById('finderMaterialsSection').style.display = 'none';
                            toggleButton.textContent = 'Switch to Finder View';
                            renderStudentItems(type); // Re-render card view to ensure it's up-to-date
                        }
                    });
                }
            }
        }
        
        async function renderContent(type, containerId, level, parentIds = []) {
            const container = document.getElementById(containerId);
            const config = materialsConfig[type];
            const levelName = config[`level${level}`];
            container.innerHTML = `<p class="loading-indicator">Loading ${levelName.toLowerCase()}s...</p>`;

            const collectionRef = collection(db, getPath(type, parentIds));
            // IMPORTANT: For 'orderBy' to work on 'name' in subcollections, you need to create a Collection Group Index in Firestore.
            // Go to Firebase Console -> Firestore Database -> Indexes tab.
            // Create a new index with:
            // Collection ID: (e.g., 'tutorials', 'pastPapers', 'exercises') - you'll need one for each top-level collection name
            // Fields: name (Ascending)
            // Query Scope: Collection Group
            const q = query(collectionRef, orderBy('name', levelName === 'Year' ? 'desc' : 'asc'));
            
            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = `<p>No ${levelName.toLowerCase()}s added yet.</p>`;
                    return;
                }
                
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = doc.data();
                    item.id = doc.id; // Ensure item ID is available for preview/delete
                    const el = document.createElement('div');
                    el.className = level < 3 ? 'content-item' : 'sub-item';

                    let headerHtml;
                    if (level < 3) {
                        const nextLevel = level + 1;
                        const newParentIds = [...parentIds, doc.id];
                        // Add aria-expanded for accessibility and CSS targeting
                        headerHtml = `
                            <div class="content-header" data-level="${level}" data-id="${doc.id}" data-parent-ids='${JSON.stringify(parentIds)}' aria-expanded="false">
                                <${level === 1 ? 'h3' : 'h4'}>${item.name} <span class="collapse-arrow"></span></${level === 1 ? 'h3' : 'h4'}>
                                <div class="item-actions">
                                    <button class="add-item-btn btn-primary" data-level="${nextLevel}" data-parent-ids='${JSON.stringify(newParentIds)}'>Add ${config[`level${nextLevel}`]}</button>
                                    <button class="delete-item-btn logout-btn" data-level="${level}" data-id="${doc.id}" data-parent-ids='${JSON.stringify(parentIds)}'>Delete</button>
                                </div>
                            </div>
                            <div class="nested-container" id="container-level${nextLevel}-${type}-${doc.id}"></div>
                        `;
                    } else { // Level 3 - Final item
                        let itemName = item.name || item.title;
                        let itemPrice = config.isPaid ? ` - $${item.price.toFixed(2)}` : '';
                        headerHtml = `<span>${itemName}${itemPrice}</span>
                                     <div class="item-actions">
                                        <button class="preview-item-btn btn-primary" data-type="${type}" data-item='${JSON.stringify(item)}'>Preview</button>
                                        <button class="delete-item-btn logout-btn" data-level="${level}" data-id="${doc.id}" data-parent-ids='${JSON.stringify(parentIds)}'>Delete</button>
                                     </div>`;
                        // Add draggable attributes and event listeners for level 3 items
                        el.setAttribute('draggable', 'true');
                        el.dataset.itemId = doc.id;
                        el.dataset.itemType = type;
                        el.dataset.itemParentIds = JSON.stringify(parentIds);
                        el.addEventListener('dragstart', handleDragStart);
                    }
                    el.innerHTML = headerHtml;
                    container.appendChild(el);
                });
            } catch (error) {
                console.error(`Error rendering level ${level} for ${type}:`, error);
                container.innerHTML = `<p class="error-message">Error loading content. A database index might be required. Check console for details.</p>`;
            }
        }
        
        async function handleTeacherClick(e, type) {
            const header = e.target.closest('.content-header');
            const button = e.target.closest('button');

            if (button) {
                e.stopPropagation();
                const { level, parentIds } = button.dataset;
                const parentIdsArray = parentIds ? JSON.parse(parentIds) : [];

                if (button.matches('.add-item-btn')) {
                    const nextLevel = parseInt(level);
                    if (nextLevel < 3) {
                        showAddItemModal(type, nextLevel, parentIdsArray);
                    } else { 
                        showAddFinalItemModal(type, parentIdsArray);
                    }
                } else if (button.matches('.delete-item-btn')) {
                    const idToDelete = button.dataset.id;
                    handleDeleteItem(type, parseInt(level), idToDelete, parentIdsArray);
                } else if (button.matches('.preview-item-btn')) {
                    const itemData = JSON.parse(button.dataset.item);
                    handleTeacherPreview(type, itemData);
                }
            } else if (header) {
                const { level, id, parentIds } = header.dataset;
                const currentLevel = parseInt(level);
                if (currentLevel >= 3) return; 
                
                const nextLevel = currentLevel + 1;
                const container = document.getElementById(`container-level${nextLevel}-${type}-${id}`);
                if (!container) return;

                const isExpanded = header.getAttribute('aria-expanded') === 'true';
                header.setAttribute('aria-expanded', !isExpanded);
                container.classList.toggle('expanded', !isExpanded);

                if (!isExpanded && !container.dataset.loaded) {
                    const parentIdsArray = parentIds ? JSON.parse(parentIds) : [];
                    await renderContent(type, container.id, nextLevel, [...parentIdsArray, id]);
                    container.dataset.loaded = 'true';
                }
            }
        }

        // New function for teacher preview
        function handleTeacherPreview(type, item) {
            if (type === 'tutorials') {
                const videoPreviewModal = document.getElementById('videoPreviewModal');
                const videoPreviewTitle = document.getElementById('videoPreviewTitle');
                const videoPreviewContent = document.getElementById('videoPreviewContent');
                
                videoPreviewTitle.textContent = item.title;
                if (item.type === 'youtube') {
                    videoPreviewContent.innerHTML = `<iframe src="https://www.youtube.com/embed/${item.youtubeId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                } else if (item.type === 'embed') {
                    videoPreviewContent.innerHTML = item.embedCode;
                }
                videoPreviewModal.style.display = 'flex';
            } else if (type === 'pastPapers' || type === 'exercises') {
                if (item.link) {
                    window.open(item.link, '_blank');
                } else {
                    showModal('Preview Error', 'No link available for this item.');
                }
            }
        }


        function showAddItemModal(type, level, parentIds = []) {
            const config = materialsConfig[type];
            const levelName = config[`level${level}`];
            const prompt = levelName === 'Year' ? 'Year (e.g., 2024)' : levelName;
            
            showInputModal(`Add New ${levelName}`, `Enter ${prompt} Name:`, async (name) => {
                const collectionRef = collection(db, getPath(type, parentIds));
                try {
                    await addDoc(collectionRef, { name: name.trim() });
                    showModal('Success', `${levelName} added.`);
                    const containerId = level === 1 ? `level1-${type}-container` : `container-level${level}-${type}-${parentIds[parentIds.length - 1]}`;
                    renderContent(type, containerId, level, parentIds);
                } catch(e) {
                    console.error("Error adding item:", e);
                    showModal('Error', `Could not add ${levelName}. Error: ${e.message}`);
                }
            });
        }

        function showAddFinalItemModal(type, parentIds) {
            const config = materialsConfig[type];
            const modal = document.getElementById(config.modalId);
            modal.style.display = 'flex';
            
            const form = modal.querySelector('form');
            form.querySelector('input[type=hidden]:nth-of-type(1)').value = parentIds[0];
            form.querySelector('input[type=hidden]:nth-of-type(2)').value = parentIds[1];
            form.reset();

            // Also reset file input displays and previews
            if (type === 'pastPapers') {
                document.getElementById('pastPaperFileName').textContent = 'No file chosen';
                document.getElementById('pastPaperLink').value = '';
            }
            if (type === 'exercises') {
                document.getElementById('exerciseFileName').textContent = 'No file chosen';
                document.getElementById('exerciseLink').value = '';
            }
            if (type === 'tutorials') {
                document.getElementById('tutorialThumbnailPreview').style.display = 'none';
            }
        }

        function handleDeleteItem(type, level, id, parentIds) {
            const config = materialsConfig[type];
            const levelName = config[`level${level}`];

            showModal('Confirm Deletion', `Are you sure you want to delete this ${levelName.toLowerCase()}? This will also delete all items inside it. This action cannot be undone.`, [
                { text: 'Delete', className: 'btn-primary', onClick: async () => {
                    const docRef = doc(db, getPath(type, parentIds), id);
                    try {
                        await deleteDoc(docRef); // Note: This doesn't delete subcollections. A proper solution requires a cloud function for recursive deletes.
                        showModal('Success', `${levelName} deleted.`);
                        const containerId = level === 1 ? `level1-${type}-container` : `container-level${level}-${type}-${parentIds[parentIds.length - 1]}`;
                        renderContent(type, containerId, level, parentIds);
                    } catch(e) {
                         console.error("Error deleting item:", e);
                         showModal('Error', `Could not delete ${levelName}. Error: ${e.message}`);
                    }
                }},
                { text: 'Cancel', className: 'logout-btn' }
            ]);
        }
        
        // --- DRAG AND DROP LOGIC (TEACHER SIDE) ---
        let draggedItem = null; // Stores data about the item being dragged

        function handleDragStart(e) {
            const subItem = e.target.closest('.sub-item');
            if (!subItem) return;

            draggedItem = {
                id: subItem.dataset.itemId,
                type: subItem.dataset.itemType,
                parentIds: JSON.parse(subItem.dataset.itemParentIds)
            };
            e.dataTransfer.setData('text/plain', JSON.stringify(draggedItem));
            e.dataTransfer.effectAllowed = 'move';
            subItem.classList.add('dragging'); // Optional: Add visual feedback for the dragged item
        }

        function handleDragOver(e, type) {
            e.preventDefault(); // Crucial to allow dropping
            const targetElement = e.target.closest('.content-item'); // Target is a folder (level 1 or 2)
            if (targetElement && draggedItem && draggedItem.type === type) { // Only allow dropping items of the same type
                targetElement.classList.add('drag-over');
                e.dataTransfer.dropEffect = 'move';
            } else {
                e.dataTransfer.dropEffect = 'none';
            }
        }

        function handleDragLeave(e, type) {
            const targetElement = e.target.closest('.content-item');
            if (targetElement) {
                targetElement.classList.remove('drag-over');
            }
        }

        async function handleDrop(e, type) {
            e.preventDefault();
            const targetElement = e.target.closest('.content-item');
            if (targetElement) {
                targetElement.classList.remove('drag-over');
            }

            if (!draggedItem) return; // No item being dragged

            const droppedItemData = JSON.parse(e.dataTransfer.getData('text/plain'));
            
            // Ensure the dropped item is of the same type as the section
            if (droppedItemData.type !== type) {
                showModal('Move Error', 'Cannot move items between different material types (e.g., tutorials to past papers).');
                draggedItem = null; // Reset dragged item
                return;
            }

            const newParentLevel = parseInt(targetElement.dataset.level);
            const newParentId = targetElement.dataset.id;
            const newParentIds = JSON.parse(targetElement.dataset.parentIds);

            // Determine the new full path for the item
            let newFullParentIds = [];
            if (newParentLevel === 1) { // Dropped into a Level 1 folder (Subject)
                newFullParentIds = [newParentId];
            } else if (newParentLevel === 2) { // Dropped into a Level 2 folder (Topic/Year)
                newFullParentIds = [...newParentIds, newParentId];
            } else {
                showModal('Move Error', 'Items can only be dropped into Subject or Topic/Year folders.');
                draggedItem = null;
                return;
            }

            // Prevent dropping into the same folder or an invalid folder structure (e.g., dropping a subject into a topic)
            if (newFullParentIds.length !== 2) { // Files (level 3) always have 2 parent IDs
                 showModal('Move Error', 'Files must be moved into a Topic or Year folder (which has a Subject parent).');
                 draggedItem = null;
                 return;
            }

            const oldParentIds = draggedItem.parentIds;
            const itemId = draggedItem.id;
            const itemType = draggedItem.type;

            // Check if the item is being dropped into its current parent folder
            if (oldParentIds[0] === newFullParentIds[0] && oldParentIds[1] === newFullParentIds[1]) {
                showModal('Move Info', 'Item is already in this folder.');
                draggedItem = null;
                return;
            }

            // Get a reference to the original document
            const oldDocRef = doc(db, getPath(itemType, oldParentIds), itemId);
            const newDocRef = doc(db, getPath(itemType, newFullParentIds), itemId);

            try {
                // Fetch the item's data
                const docSnap = await getDoc(oldDocRef);
                if (!docSnap.exists()) {
                    throw new Error("Item not found for moving.");
                }
                const itemData = docSnap.data();

                // Use a batch write for atomicity: delete from old location, add to new
                const batch = writeBatch(db);
                batch.set(newDocRef, itemData); // Create a new document with the same data in the new location
                batch.delete(oldDocRef); // Delete the original document

                await batch.commit();

                showModal('Success', `Item "${itemData.name || itemData.title}" moved successfully!`);
                
                // Re-render both the old and new parent containers to reflect changes
                const oldContainerId = `container-level3-${itemType}-${oldParentIds[1]}`;
                const newContainerId = `container-level3-${itemType}-${newFullParentIds[1]}`;
                
                // Only re-render if the containers are currently expanded/loaded
                if (document.getElementById(oldContainerId)?.classList.contains('expanded')) {
                    renderContent(itemType, oldContainerId, 3, oldParentIds);
                }
                if (document.getElementById(newContainerId)?.classList.contains('expanded')) {
                     renderContent(itemType, newContainerId, 3, newFullParentIds);
                }
                // If a parent folder was not expanded, it will load correctly when expanded next time.

            } catch (error) {
                console.error("Error moving item:", error);
                showModal('Move Error', `Could not move item. Error: ${e.message}`);
            } finally {
                draggedItem = null; // Reset dragged item
                // Remove dragging class from original item if it still exists
                document.querySelectorAll('.sub-item.dragging').forEach(el => el.classList.remove('dragging'));
            }
        }


        // --- STUDENT FILTER LOGIC ---
        function setupStudentFilters(type) {
            const config = materialsConfig[type];
            const level1Filter = document.getElementById(`level1-${type}-filter`);
            const level2Filter = document.getElementById(`level2-${type}-filter`);
            const grid = document.getElementById(`level3-${type}-grid`);

            populateFilter(level1Filter, collection(db, getPath(type)), config.level1);

            level1Filter.onchange = () => {
                const level1Id = level1Filter.value;
                level2Filter.innerHTML = `<option value="">-- Select ${config.level2} --</option>`;
                level2Filter.disabled = true;
                grid.innerHTML = `<p>Please select a ${config.level2.toLowerCase()}.</p>`;
                if (level1Id) {
                    populateFilter(level2Filter, collection(db, getPath(type, [level1Id])), config.level2);
                    level2Filter.disabled = false;
                }
            };
            level2Filter.onchange = () => renderStudentItems(type);
        }

        async function renderStudentItems(type) {
             const config = materialsConfig[type];
             const grid = document.getElementById(`level3-${type}-grid`);
             const level1Id = document.getElementById(`level1-${type}-filter`).value;
             const level2Id = document.getElementById(`level2-${type}-filter`).value;

             grid.innerHTML = `<p class="loading-indicator">Loading...</p>`;
             if (!level1Id || !level2Id) {
                 grid.innerHTML = `<p>Please select a ${config.level1.toLowerCase()} and ${config.level2.toLowerCase()}.</p>`;
                 return;
             }

             const itemsRef = collection(db, getPath(type, [level1Id, level2Id]));
             const q = query(itemsRef, orderBy('name', 'asc'));
             
             let purchasedItems = {};
             if(config.isPaid) {
                 const purchaseCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/purchased_${config.collectionName}`);
                 const snapshot = await getDocs(purchaseCollectionRef);
                 snapshot.forEach(doc => purchasedItems[doc.id] = true);
             }

             try {
                const snapshot = await getDocs(q);
                grid.innerHTML = snapshot.empty ? `<p>No ${config.level3.toLowerCase()}s found.</p>` : '';
                snapshot.forEach(doc => {
                    const item = doc.data();
                    item.id = doc.id; // Add id to item object
                    const card = document.createElement('div');
                    card.className = 'material-card';
                    
                    let cardContent = '';
                    if (type === 'tutorials') {
                        if (item.type === 'youtube') {
                            cardContent = `
                                <div class="material-card-thumbnail" data-youtube-id="${item.youtubeId}">
                                    <img src="https://img.youtube.com/vi/${item.youtubeId}/mqdefault.jpg" alt="${item.title}" onerror="this.onerror=null; this.src='https://placehold.co/480x360/30363d/c9d1d9?text=No%20Thumbnail';">
                                    <div class="play-button-overlay">▶</div>
                                </div>
                                <div class="material-card-content"><h3>${item.title}</h3></div>
                            `;
                        } else if (item.type === 'embed') {
                            cardContent = `
                                <div class="video-embed-container">${item.embedCode}</div>
                                <div class="material-card-content"><h3>${item.title}</h3></div>
                            `;
                        }
                    } else if (config.isPaid) {
                        const isPurchased = purchasedItems[item.id];
                        const inCart = shoppingCart.find(cartItem => cartItem.id === item.id);
                        card.className = 'product-card';
                        cardContent = `
                            <h4>${item.name}</h4>
                            <p class="product-price">$${item.price.toFixed(2)}</p>
                            ${isPurchased 
                                ? `<a href="${item.link}" target="_blank" rel="noopener noreferrer" class="btn-primary download-btn">Download</a>`
                                : `<button class="add-to-cart-btn btn-primary" data-id="${item.id}" ${inCart ? 'disabled' : ''}>${inCart ? 'In Cart' : 'Add to Cart'}</button>`
                            }`;
                        if(!isPurchased) {
                           setTimeout(() => card.querySelector('.add-to-cart-btn')?.addEventListener('click', () => addToCart(item)), 0);
                        }
                    } else { // Free materials like past papers
                        cardContent = `<a href="${item.link}" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit; display: flex; flex-direction: column; height: 100%;"><div class="material-card-content"><h3>${item.name}</h3></div></a>`;
                    }
                    card.innerHTML = cardContent;
                    grid.appendChild(card);
                });
             } catch(e) {
                console.error("Error loading student items:", e);
                grid.innerHTML = "<p class='error-message'>Error loading items. A database index might be required. Check console for details.</p>"
             }
        }
        
        async function populateFilter(selectElement, collectionRef, levelName) {
            selectElement.innerHTML = `<option value="">-- Loading ${levelName}s --</option>`;
            try {
                const q = query(collectionRef, orderBy('name', levelName === 'Year' ? 'desc' : 'asc'));
                const snapshot = await getDocs(q);
                selectElement.innerHTML = `<option value="">-- Select a ${levelName} --</option>`;
                if(snapshot.empty) {
                    selectElement.innerHTML += `<option value="" disabled>-- No ${levelName}s Available --</option>`;
                    return;
                }
                snapshot.forEach(doc => {
                    selectElement.add(new Option(doc.data().name, doc.id));
                });
            } catch (e) {
                console.error(`Error loading ${levelName}s:`, e);
                selectElement.innerHTML = `<option value="">-- Error --</option>`;
            }
        }

        // --- E-COMMERCE LOGIC ---
        function addToCart(item) {
            shoppingCart.push(item);
            updateCartUI();
            renderStudentItems('exercises'); 
        }

        function removeFromCart(itemId) {
            shoppingCart = shoppingCart.filter(item => item.id !== itemId);
            updateCartUI();
            renderStudentItems('exercises');
        }

        function updateCartUI() {
            const cartItemsContainer = document.getElementById('cart-items');
            const subtotalPriceEl = document.getElementById('cart-subtotal-price');
            const promoDiscountLine = document.getElementById('promo-discount-line');
            const promoDiscountEl = document.getElementById('cart-promo-discount');
            const totalPriceEl = document.getElementById('cart-total-price');
            const checkoutBtn = document.getElementById('checkout-btn');
            const validationMsg = document.getElementById('cart-validation-message');
            const promoCodeInput = document.getElementById('promoCodeInput');
            const applyPromoCodeBtn = document.getElementById('applyPromoCodeBtn');
            const appliedPromoCodeDisplay = document.getElementById('appliedPromoCodeDisplay');
            const appliedPromoCodeText = document.getElementById('appliedPromoCodeText');
            const promoCodeError = document.getElementById('promoCodeError');


            cartItemsContainer.innerHTML = '';
            let subtotal = 0;

            if (shoppingCart.length === 0) {
                cartItemsContainer.innerHTML = '<p>Your cart is empty.</p>';
            }

            shoppingCart.forEach(item => {
                subtotal += item.price;
                const itemEl = document.createElement('div');
                itemEl.className = 'cart-item';
                itemEl.innerHTML = `
                    <span class="cart-item-name">${item.name}</span>
                    <span class="cart-item-price">$${item.price.toFixed(2)}</span>
                    <button class="remove-from-cart-btn" data-id="${item.id}">✖</button>
                `;
                cartItemsContainer.appendChild(itemEl);
            });
            
            document.querySelectorAll('.remove-from-cart-btn').forEach(btn => {
                btn.addEventListener('click', () => removeFromCart(btn.dataset.id));
            });

            subtotalPriceEl.textContent = `$${subtotal.toFixed(2)}`;
            let finalPrice = subtotal;

            if (appliedPromoCode) {
                finalPrice = Math.max(0, subtotal - appliedPromoCode.discountAmount); // Ensure price doesn't go negative
                promoDiscountEl.textContent = `-$${appliedPromoCode.discountAmount.toFixed(2)}`;
                promoDiscountLine.style.display = 'flex';
                appliedPromoCodeText.textContent = `${appliedPromoCode.code} (-$${appliedPromoCode.discountAmount.toFixed(2)})`;
                appliedPromoCodeDisplay.style.display = 'flex';
                promoCodeInput.disabled = true;
                applyPromoCodeBtn.disabled = true;
                promoCodeInput.value = appliedPromoCode.code; // Pre-fill with applied code
                promoCodeError.textContent = ''; // Clear any previous error
            } else {
                promoDiscountLine.style.display = 'none';
                appliedPromoCodeDisplay.style.display = 'none';
                promoCodeInput.disabled = false;
                applyPromoCodeBtn.disabled = false;
                promoCodeInput.value = ''; // Clear input if no code applied
            }

            totalPriceEl.textContent = `$${finalPrice.toFixed(2)}`;

            // Validate cart: Checkout enabled if total price is $0 or more AND cart is not empty.
            // Also, if the final price is > 0, enforce a minimum total of $100.
            const canCheckout = shoppingCart.length > 0 && (finalPrice === 0 || finalPrice >= 100);

            if (canCheckout) {
                checkoutBtn.disabled = false;
                if (finalPrice === 0) {
                    validationMsg.textContent = 'Proceed to checkout for free!';
                } else {
                    validationMsg.textContent = '';
                }
            } else {
                checkoutBtn.disabled = true;
                if (shoppingCart.length === 0) {
                    validationMsg.textContent = 'Your cart is empty. Add items to proceed.';
                } else if (finalPrice > 0 && finalPrice < 100) {
                    validationMsg.textContent = 'Minimum total of $100 required to checkout.';
                } else {
                    validationMsg.textContent = ''; // Should not happen if previous conditions are met
                }
            }
        }

        async function applyPromoCode() {
            const promoCodeInput = document.getElementById('promoCodeInput');
            const promoCodeError = document.getElementById('promoCodeError');
            const code = promoCodeInput.value.trim().toUpperCase(); // Convert to uppercase for case-insensitivity

            promoCodeError.textContent = ''; // Clear previous errors

            if (!code) {
                promoCodeError.textContent = 'Please enter a promo code.';
                return;
            }

            const promoCodeRef = doc(db, `artifacts/${appId}/public/data/promoCodes`, code);
            try {
                const docSnap = await getDoc(promoCodeRef);
                if (docSnap.exists()) {
                    const promoData = docSnap.data();
                    if (promoData.isActive) {
                        appliedPromoCode = {
                            code: code,
                            discountAmount: promoData.discountAmount
                        };
                        updateCartUI();
                        showModal('Promo Code Applied', `Successfully applied promo code "${code}" for a $${promoData.discountAmount.toFixed(2)} discount!`);
                    } else {
                        promoCodeError.textContent = 'This promo code is not active.';
                    }
                } else {
                    promoCodeError.textContent = 'Invalid promo code.';
                }
            } catch (error) {
                console.error("Error applying promo code:", error);
                promoCodeError.textContent = `Error applying code: ${e.message}`;
            }
        }

        function removeAppliedPromoCode() {
            appliedPromoCode = null;
            updateCartUI();
            document.getElementById('promoCodeInput').value = ''; // Clear input field
            document.getElementById('promoCodeError').textContent = ''; // Clear error message
            showModal('Promo Code Removed', 'The promo code has been removed from your cart.');
        }


        async function handleCheckout() {
            if (!currentUserId) {
                return showModal('Error', 'You must be logged in to check out.');
            }

            // Recalculate final price with applied discount
            let subtotal = shoppingCart.reduce((sum, item) => sum + item.price, 0);
            let finalPrice = subtotal;
            if (appliedPromoCode) {
                finalPrice = Math.max(0, subtotal - appliedPromoCode.discountAmount);
            }

            if (shoppingCart.length === 0) {
                return showModal('Checkout Error', 'Your cart is empty. Please add items before checking out.');
            }

            if (finalPrice === 0) {
                // Direct "free" checkout - bypass Stripe
                try {
                    const batch = writeBatch(db);
                    shoppingCart.forEach(item => {
                        const purchaseRef = doc(db, `artifacts/${appId}/users/${currentUserId}/purchased_exercises/${item.id}`);
                        batch.set(purchaseRef, { 
                            name: item.name, 
                            price: item.price, 
                            purchasedAt: Date.now(),
                            purchaseMethod: 'promo', // Track purchase method
                            promoCodeUsed: appliedPromoCode ? appliedPromoCode.code : 'N/A' // Track promo code used
                        });
                    });
                    await batch.commit();

                    showModal('Purchase Successful!', 'Your new exercises are now available for download. Enjoy your free items!');
                    shoppingCart = []; // Clear the local cart
                    appliedPromoCode = null; // Clear applied promo code
                    updateCartUI(); // Update UI to reflect empty cart and no promo
                    showSection('exerciseSection'); // Re-render the exercises page
                    renderStudentItems('exercises');
                    if (currentUserRole === 'teacher') loadStudentPurchasesForTeacher(); // Update teacher view

                } catch (error) {
                    console.error("Error processing free checkout:", error);
                    showModal('Checkout Error', `Could not complete free checkout. Please try again. Error: ${e.message}`);
                }

            } else if (finalPrice >= 100) {
                // Proceed with Stripe checkout for paid items
                if (STRIPE_PAYMENT_LINK.includes("...")) {
                    return showModal('Configuration Error', 'The Stripe Payment Link has not been configured by the site administrator.');
                }

                const checkoutSessionId = crypto.randomUUID();
                const checkoutSessionRef = doc(db, `artifacts/${appId}/users/${currentUserId}/checkout_sessions/${checkoutSessionId}`);

                try {
                    // Save the cart and applied promo code to Firestore
                    await setDoc(checkoutSessionRef, {
                        cart: shoppingCart,
                        appliedPromoCode: appliedPromoCode, // Save applied promo code
                        created: Date.now(),
                        totalAmount: finalPrice, // Save the final amount for record
                        purchaseMethod: 'paid' // Mark as paid purchase
                    });

                    // Redirect to Stripe
                    const stripeUrl = `${STRIPE_PAYMENT_LINK}?client_reference_id=${checkoutSessionId}&prefilled_email=${currentUserEmail}`;
                    window.location.href = stripeUrl;

                } catch (error) {
                    console.error("Error creating checkout session:", error);
                    showModal('Checkout Error', `Could not initiate checkout. Please try again. Error: ${e.message}`);
                }
            } else {
                showModal('Checkout Error', 'Minimum total of $100 required to checkout for paid items.');
            }
        }
        
        async function checkForSuccessfulPurchase() {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session_id'); // This is a placeholder, Stripe might use a different param

            // A more robust check might be needed depending on Stripe's redirect behavior
            if (params.get('payment_status') === 'success' && sessionId) {
                const checkoutSessionRef = doc(db, `artifacts/${appId}/users/${currentUserId}/checkout_sessions/${sessionId}`);
                try {
                    const sessionDoc = await getDoc(checkoutSessionRef);
                    if (sessionDoc.exists()) {
                        const sessionData = sessionDoc.data();
                        const purchasedItems = sessionData.cart;

                        // Use a batch write to add all purchased items and delete the session doc atomically
                        const batch = writeBatch(db);
                        purchasedItems.forEach(item => {
                            const purchaseRef = doc(db, `artifacts/${appId}/users/${currentUserId}/purchased_exercises/${item.id}`);
                            batch.set(purchaseRef, { 
                                name: item.name, 
                                price: item.price, 
                                purchasedAt: Date.now(),
                                purchaseMethod: sessionData.purchaseMethod || 'paid', // Default to paid if not specified
                                promoCodeUsed: sessionData.appliedPromoCode ? sessionData.appliedPromoCode.code : 'N/A'
                            });
                        });
                        batch.delete(checkoutSessionRef); // Clean up the session doc
                        await batch.commit();
                        
                        showModal('Purchase Successful!', 'Your new exercises are now available for download.');
                        shoppingCart = []; // Clear the local cart
                        appliedPromoCode = null; // Clear applied promo code
                        
                        // Clean the URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        // Re-render the exercises page
                        showSection('exerciseSection');
                        renderStudentItems('exercises');
                        if (currentUserRole === 'teacher') loadStudentPurchasesForTeacher(); // Update teacher view
                    }
                } catch (error) {
                    console.error("Error processing purchase:", error);
                    showModal('Purchase Error', 'There was an issue verifying your purchase. Please contact support.');
                }
            }
        }

        // --- PROMO CODE MANAGEMENT (TEACHER SIDE) ---
        function generateRandomCode(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        async function generateAndSavePromoCode() {
            const promoDiscountAmountInput = document.getElementById('promoDiscountAmount');
            const promoCodeGenerationStatus = document.getElementById('promoCodeGenerationStatus');
            const discountAmount = parseFloat(promoDiscountAmountInput.value);

            promoCodeGenerationStatus.textContent = ''; // Clear previous messages

            if (isNaN(discountAmount) || discountAmount <= 0) {
                promoCodeGenerationStatus.textContent = 'Please enter a valid discount amount (must be positive).';
                return;
            }

            const newCode = generateRandomCode(8);
            const promoCodeRef = doc(db, `artifacts/${appId}/public/data/promoCodes`, newCode);

            try {
                promoCodeGenerationStatus.textContent = 'Generating and saving promo code...';
                await setDoc(promoCodeRef, {
                    code: newCode,
                    discountAmount: discountAmount,
                    isActive: true, // New codes are active by default
                    createdAt: Date.now(),
                    createdBy: currentUserId
                });
                promoCodeGenerationStatus.textContent = `Promo code "${newCode}" generated with $${discountAmount.toFixed(2)} discount!`;
                promoDiscountAmountInput.value = ''; // Clear discount input
                loadPromoCodesForTeacher(); // Refresh the list
            } catch (error) {
                console.error("Error generating promo code:", error);
                promoCodeGenerationStatus.textContent = `Error: ${e.message}`;
            }
        }

        async function loadPromoCodesForTeacher() {
            const teacherPromoCodeList = document.getElementById('teacherPromoCodeList');
            teacherPromoCodeList.innerHTML = '<p class="loading-indicator">Loading promo codes...</p>';

            const promoCodesCollectionRef = collection(db, `artifacts/${appId}/public/data/promoCodes`);
            const q = query(promoCodesCollectionRef, orderBy('createdAt', 'desc'));

            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    teacherPromoCodeList.innerHTML = '<p>No promo codes generated yet.</p>';
                    return;
                }

                teacherPromoCodeList.innerHTML = '';
                snapshot.forEach(doc => {
                    const promo = doc.data();
                    const promoItem = document.createElement('div');
                    promoItem.className = 'promo-code-item';
                    promoItem.innerHTML = `
                        <span>${promo.code}</span>
                        <span>$${promo.discountAmount.toFixed(2)}</span>
                        <span>${promo.isActive ? 'Active' : 'Inactive'}</span>
                        <div class="actions">
                            <button class="btn-primary toggle-promo-status-btn" data-code="${promo.code}" data-is-active="${promo.isActive ? 'true' : 'false'}">
                                ${promo.isActive ? 'Deactivate' : 'Activate'}
                            </button>
                            <button class="logout-btn delete-promo-btn" data-code="${promo.code}">Delete</button>
                        </div>
                    `;
                    teacherPromoCodeList.appendChild(promoItem);
                });

                // Add event listeners for toggle and delete buttons
                teacherPromoCodeList.querySelectorAll('.toggle-promo-status-btn').forEach(button => {
                    button.addEventListener('click', (e) => togglePromoCodeStatus(e.target.dataset.code, e.target.dataset.isActive === 'true'));
                });
                teacherPromoCodeList.querySelectorAll('.delete-promo-btn').forEach(button => {
                    button.addEventListener('click', (e) => deletePromoCode(e.target.dataset.code));
                });

            } catch (error) {
                console.error("Error loading promo codes:", error);
                teacherPromoCodeList.innerHTML = '<p class="error-message">Error loading promo codes.</p>';
            }
        }

        async function togglePromoCodeStatus(code, currentStatus) {
            const promoCodeRef = doc(db, `artifacts/${appId}/public/data/promoCodes`, code);
            try {
                await updateDoc(promoCodeRef, { isActive: !currentStatus });
                showModal('Status Updated', `Promo code "${code}" is now ${!currentStatus ? 'Active' : 'Inactive'}.`);
                loadPromoCodesForTeacher(); // Refresh the list
            } catch (error) {
                console.error("Error toggling promo code status:", error);
                showModal('Error', `Could not update status for "${code}": ${e.message}`);
            }
        }

        async function deletePromoCode(code) {
            showModal('Confirm Deletion', `Are you sure you want to delete promo code "${code}"? This action cannot be undone.`, [
                { text: 'Delete', className: 'btn-primary', onClick: async () => {
                    const promoCodeRef = doc(db, `artifacts/${appId}/public/data/promoCodes`, code);
                    try {
                        await deleteDoc(promoCodeRef);
                        showModal('Success', `Promo code "${code}" deleted.`);
                        loadPromoCodesForTeacher(); // Refresh the list
                    } catch (error) {
                        console.error("Error deleting promo code:", error);
                        showModal('Error', `Could not delete "${code}": ${e.message}`);
                    }
                }},
                { text: 'Cancel', className: 'logout-btn' }
            ]);
        }

        // --- TEACHER: LOAD STUDENT PURCHASE HISTORY ---
        async function loadStudentPurchasesForTeacher() {
            const purchaseHistoryList = document.getElementById('studentPurchaseHistoryList');
            purchaseHistoryList.innerHTML = '<p class="loading-indicator">Loading student purchase history...</p>';

            try {
                const usersCollectionRef = collection(db, `artifacts/${appId}/users`);
                const userDocs = await getDocs(usersCollectionRef);
                
                let allPurchases = [];

                for (const userDoc of userDocs.docs) {
                    const userId = userDoc.id;
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                    const userProfileSnap = await getDoc(userProfileRef);
                    const userName = userProfileSnap.exists() ? (userProfileSnap.data().name || userProfileSnap.data().email) : `User ${userId.substring(0, 8)}...`;

                    const purchasedExercisesRef = collection(db, `artifacts/${appId}/users/${userId}/purchased_exercises`);
                    const purchasedExercisesSnap = await getDocs(purchasedExercisesRef);

                    purchasedExercisesSnap.forEach(purchaseDoc => {
                        const purchaseData = purchaseDoc.data();
                        allPurchases.push({
                            userId: userId,
                            userName: userName,
                            itemName: purchaseData.name,
                            price: purchaseData.price,
                            purchasedAt: purchaseData.purchasedAt,
                            purchaseMethod: purchaseData.purchaseMethod || 'N/A',
                            promoCodeUsed: purchaseData.promoCodeUsed || 'N/A'
                        });
                    });
                }

                if (allPurchases.length === 0) {
                    purchaseHistoryList.innerHTML = '<p>No student purchase records found yet.</p>';
                    return;
                }

                // Sort purchases by date, newest first
                allPurchases.sort((a, b) => b.purchasedAt - a.purchasedAt);

                purchaseHistoryList.innerHTML = '';
                allPurchases.forEach(purchase => {
                    const purchaseEntry = document.createElement('div');
                    purchaseEntry.className = 'student-purchase-entry';
                    purchaseEntry.innerHTML = `
                        <strong>Student: ${purchase.userName} (ID: ${purchase.userId})</strong>
                        <div class="purchased-item-detail">Item: ${purchase.itemName}</div>
                        <div class="purchased-item-detail">Price: $${purchase.price.toFixed(2)}</div>
                        <div class="purchased-item-detail">Purchased: ${new Date(purchase.purchasedAt).toLocaleString()}</div>
                        <div class="purchased-item-detail">Method: ${purchase.purchaseMethod}</div>
                        <div class="purchased-item-detail">Promo Code: ${purchase.promoCodeUsed}</div>
                    `;
                    purchaseHistoryList.appendChild(purchaseEntry);
                });

            } catch (error) {
                console.error("Error loading student purchase history:", error);
                purchaseHistoryList.innerHTML = '<p class="error-message">Error loading purchase history.</p>';
            }
        }


        // --- VIDEO PARSING ---
        function parseVideoInput(input) {
            const text = input.trim();
            // Check for YouTube URL
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const youtubeMatch = text.match(youtubeRegex);
            if (youtubeMatch && youtubeMatch[1]) {
                return { type: 'youtube', id: youtubeMatch[1] };
            }
            // Check for iframe embed code
            if (text.startsWith('<iframe') && text.endsWith('>')) {
                return { type: 'embed', code: text };
            }
            return null; // Invalid input
        }

        // --- MODAL SUBMISSION LOGIC ---
        document.getElementById('addVideoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const parentId1 = e.target.querySelector('#videoParentId1').value;
            const parentId2 = e.target.querySelector('#videoParentId2').value;
            const input = document.getElementById('tutorialLink').value;
            const title = document.getElementById('tutorialTitle').value;
            
            const videoDetails = parseVideoInput(input);

            if (!videoDetails || !title.trim()) { 
                return showModal('Input Error', 'Please provide a title and a valid YouTube link or embed code.');
            }
            
            const dataToSave = {
                title: title.trim(),
                name: title.trim(),
                timestamp: Date.now()
            };

            if (videoDetails.type === 'youtube') {
                dataToSave.type = 'youtube';
                dataToSave.youtubeId = videoDetails.id;
            } else { // 'embed'
                dataToSave.type = 'embed';
                dataToSave.embedCode = videoDetails.code;
            }

            const collectionRef = collection(db, getPath('tutorials', [parentId1, parentId2]));
            try {
                await addDoc(collectionRef, dataToSave);
                showModal('Success', 'Video added.');
                document.getElementById('addVideoModal').style.display = 'none';
                renderContent('tutorials', `container-level3-tutorials-${parentId2}`, 3, [parentId1, parentId2]);
            } catch (error) { 
                showModal('Error', `Could not add video: ${e.message}`); 
            }
        });

        document.getElementById('addPastPaperForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const parentId1 = form.querySelector('#paperParentId1').value;
            const parentId2 = form.querySelector('#paperParentId2').value;
            const name = document.getElementById('pastPaperName').value;
            const fileInput = document.getElementById('pastPaperFile');
            const file = fileInput.files[0];
            const link = document.getElementById('pastPaperLink').value.trim();

            if (!name.trim() || (!file && !link)) {
                return showModal('Input Error', 'Please provide a paper name and either upload a PDF or paste a link.');
            }

            const buttonsContainer = form.querySelector('.modal-form-buttons');
            const originalButtonsHTML = buttonsContainer.innerHTML;
            buttonsContainer.innerHTML = `<p class="loading-indicator">Processing...</p>`;
            
            let downloadURL = link; // Default to the pasted link

            try {
                // If a file is provided, it takes priority
                if (file) {
                    buttonsContainer.innerHTML = `<p class="loading-indicator">Uploading file...</p>`;
                    const storagePath = `materials/past-papers/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, storagePath);
                    const uploadResult = await uploadBytes(storageRef, file);
                    downloadURL = await getDownloadURL(uploadResult.ref);
                }

                if (!downloadURL) { // Final check in case link was empty and file failed
                    throw new Error("No valid file or link provided.");
                }

                const collectionRef = collection(db, getPath('pastPapers', [parentId1, parentId2]));
                await addDoc(collectionRef, { name: name.trim(), link: downloadURL, timestamp: Date.now() });
                
                showModal('Success', 'Past paper added.');
                document.getElementById('addPastPaperModal').style.display = 'none';
                renderContent('pastPapers', `container-level3-pastPapers-${parentId2}`, 3, [parentId1, parentId2]);
            } catch (error) { 
                console.error("Past paper upload error:", error);
                showModal('Error', `Could not add paper: ${e.message}`); 
            } finally {
                buttonsContainer.innerHTML = originalButtonsHTML;
            }
        });

        document.getElementById('addExerciseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const parentId1 = form.querySelector('#exerciseParentId1').value;
            const parentId2 = form.querySelector('#exerciseParentId2').value;
            const name = document.getElementById('exerciseName').value;
            const price = parseFloat(document.getElementById('exercisePrice').value);
            const fileInput = document.getElementById('exerciseFile');
            const file = fileInput.files[0];
            const link = document.getElementById('exerciseLink').value.trim();
            
            if (!name.trim() || (!file && !link) || isNaN(price) || price < 0) { 
                return showModal('Input Error', 'Please provide a name, price, and either upload a file or paste a link.'); 
            }

            const buttonsContainer = form.querySelector('.modal-form-buttons');
            const originalButtonsHTML = buttonsContainer.innerHTML;
            buttonsContainer.innerHTML = `<p class="loading-indicator">Processing...</p>`;
            
            let downloadURL = link;

            try {
                if (file) {
                    buttonsContainer.innerHTML = `<p class="loading-indicator">Uploading file...</p>`;
                    const storagePath = `materials/exercises/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, storagePath);
                    const uploadResult = await uploadBytes(storageRef, file);
                    downloadURL = await getDownloadURL(uploadResult.ref);
                }

                if (!downloadURL) {
                    throw new Error("No valid file or link provided.");
                }

                const collectionRef = collection(db, getPath('exercises', [parentId1, parentId2]));
                await addDoc(collectionRef, { name: name.trim(), link: downloadURL, price: price, timestamp: Date.now() });
                
                showModal('Success', 'Exercise added.');
                document.getElementById('addExerciseModal').style.display = 'none';
                renderContent('exercises', `container-level3-exercises-${parentId2}`, 3, [parentId1, parentId2]);
            } catch (error) { 
                console.error("Exercise upload error:", error);
                showModal('Error', `Could not add exercise: ${e.message}`); 
            } finally {
                buttonsContainer.innerHTML = originalButtonsHTML;
            }
        });

        document.getElementById('tutorialLink').addEventListener('input', (e) => {
            const videoDetails = parseVideoInput(e.target.value);
            const thumbnailPreview = document.getElementById('tutorialThumbnailPreview');
            if (videoDetails && videoDetails.type === 'youtube') {
                thumbnailPreview.src = `https://img.youtube.com/vi/${videoDetails.id}/mqdefault.jpg`;
                thumbnailPreview.style.display = 'block';
            } else {
                thumbnailPreview.style.display = 'none';
                thumbnailPreview.src = '';
            }
        });
        
        // --- GRADING & CHAT & OTHER ---
        function setupDropZone(dropZoneId, fileInputId, fileNameDisplayId, filePreviewId = null) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            const fileNameDisplay = document.getElementById(fileNameDisplayId);
            const filePreview = filePreviewId ? document.getElementById(filePreviewId) : null;

            if (!dropZone || !fileInput || !fileNameDisplay) return;

            dropZone.addEventListener('click', () => fileInput.click());
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => dropZone.addEventListener(eName, e => {e.preventDefault(); e.stopPropagation();}));
            ['dragenter', 'dragover'].forEach(eName => dropZone.addEventListener(eName, () => dropZone.classList.add('highlight')));
            ['dragleave', 'drop'].forEach(eName => dropZone.addEventListener(eName, () => dropZone.classList.remove('highlight')));

            dropZone.addEventListener('drop', e => {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            });

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    fileNameDisplay.textContent = file.name;
                    if (filePreview && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => { filePreview.src = e.target.result; filePreview.style.display = 'block'; };
                        reader.readAsDataURL(file);
                    } else if (filePreview && file.type === 'application/pdf') {
                        pdfjsLib.getDocument({ url: URL.createObjectURL(file) }).promise.then(pdf => pdf.getPage(1)).then(page => {
                            const viewport = page.getViewport({ scale: 1.0 });
                            const canvas = document.createElement('canvas');
                            canvas.height = viewport.height; canvas.width = viewport.width;
                            page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise.then(() => {
                                filePreview.src = canvas.toDataURL('image/png');
                                filePreview.style.display = 'block';
                                canvas.remove();
                            });
                        }).catch(err => { console.error("PDF Preview Error:", err); if(filePreview) filePreview.style.display = 'none';});
                    } else {
                        if(filePreview) filePreview.style.display = 'none';
                    }
                } else {
                    fileNameDisplay.textContent = 'No file chosen';
                    if(filePreview) {
                        filePreview.style.display = 'none';
                        filePreview.src = '';
                    }
                }
            });
        }
        // Setup all dropzones on init
        setupDropZone('studentDropZone', 'studentAnswerFile', 'studentFileName', 'studentFilePreview');
        setupDropZone('answerKeyDropZone', 'answerKeyFile', 'answerKeyFileName', 'answerKeyFilePreview');
        setupDropZone('pastPaperDropZone', 'pastPaperFile', 'pastPaperFileName');
        setupDropZone('exerciseDropZone', 'exerciseFile', 'exerciseFileName');
        
        async function loadPastSubmissions() { /* Placeholder for original function */ }
        document.getElementById('gradeButton').addEventListener('click', async () => { /* Placeholder for original function */ });
        async function handleSendMessage() { /* Placeholder for original function */ }
        function appendChatMessage(text, sender) { /* Placeholder for original function */ }
        document.getElementById('addStudentButton').addEventListener('click', async () => { /* Placeholder for original function */ });
        async function loadAuthorizedStudents() { /* Placeholder for original function */ }
        async function deleteStudent(e) { /* Placeholder for original function */ }

        function showModal(title, message, buttons = []) {
            const messageModal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = '';

            if (buttons.length === 0) {
                 const okButton = document.createElement('button');
                 okButton.textContent = 'OK';
                 okButton.className = 'btn-primary';
                 okButton.onclick = () => { messageModal.style.display = 'none'; };
                 modalButtons.appendChild(okButton);
            } else {
                 buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.textContent = btnConfig.text;
                    button.className = btnConfig.className;
                    button.onclick = () => { 
                        messageModal.style.display = 'none';
                        if (btnConfig.onClick) btnConfig.onClick();
                    };
                    modalButtons.appendChild(button);
                });
            }
            messageModal.style.display = 'flex';
        }
        
        function showInputModal(title, label, callback) {
            const messageModal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = `<label for="modalInput" style="display:block; margin-bottom:8px;">${label}</label><input type="text" id="modalInput" style="width: 100%;" required>`;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = ''; 

            const modalInput = document.getElementById('modalInput');
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.className = 'btn-primary';
            saveButton.onclick = () => {
                const value = modalInput.value.trim();
                if (value) {
                    messageModal.style.display = 'none';
                    callback(value);
                } else {
                    modalInput.style.border = '1px solid var(--accent-red)';
                    modalInput.focus();
                }
            };
            modalButtons.appendChild(saveButton);

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.className = 'logout-btn';
            cancelButton.onclick = () => { messageModal.style.display = 'none'; };
            modalButtons.appendChild(cancelButton);

            messageModal.style.display = 'flex';
            modalInput.focus();
            modalInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); saveButton.click(); } });
        }

        document.querySelectorAll('.modal .close-button').forEach(btn => btn.onclick = () => { 
            const modal = btn.closest('.modal');
            modal.style.display = 'none'; 
            // If it's the video preview modal, stop the video playback
            if (modal.id === 'videoPreviewModal') {
                const videoContent = document.getElementById('videoPreviewContent');
                videoContent.innerHTML = ''; // Clear content to stop video
            }
        });

        const themeToggleButton = document.getElementById('themeToggleButton');
        function applyTheme(theme) { document.body.classList.toggle('light-theme', theme === 'light'); }
        function loadTheme() { applyTheme(localStorage.getItem('ai-marker-theme') || 'dark'); }
        themeToggleButton.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('ai-marker-theme', newTheme);
        });

        loadTheme();

        // --- FINDER WINDOW LOGIC ---
        let finderCurrentPath = []; // Stores [type, level1Id, level2Id]
        let finderCurrentType = null; // 'tutorials', 'pastPapers', 'exercises'

        function setupFinderWindow() {
            const finderWindow = document.getElementById('finderMaterialsSection');
            const dragBar = document.getElementById('finderDragBar');
            const fullscreenToggle = document.getElementById('finderFullscreenToggle');

            let isDragging = false, offsetX = 0, offsetY = 0;
            
            // Prevent text selection during drag
            dragBar.addEventListener('selectstart', (e) => e.preventDefault());

            dragBar.addEventListener('mousedown', (e) => {
                isDragging = true;
                // Remove the transform to allow direct manipulation of left/top
                finderWindow.style.transform = 'none';
                // Calculate offset relative to the window's current position
                offsetX = e.clientX - finderWindow.getBoundingClientRect().left;
                offsetY = e.clientY - finderWindow.getBoundingClientRect().top;
                finderWindow.style.cursor = 'grabbing';
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                finderWindow.style.cursor = 'grab';
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    // Update window position based on mouse movement
                    let newLeft = e.clientX - offsetX;
                    let newTop = e.clientY - offsetY;

                    // Ensure window stays within viewport
                    const maxX = window.innerWidth - finderWindow.offsetWidth;
                    const maxY = window.innerHeight - finderWindow.offsetHeight;

                    finderWindow.style.left = Math.max(0, Math.min(newLeft, maxX)) + 'px';
                    finderWindow.style.top = Math.max(0, Math.min(newTop, maxY)) + 'px';
                }
            });

            let isFullscreen = false;
            fullscreenToggle.addEventListener('click', () => {
                if (!isFullscreen) {
                    finderWindow.classList.add('fullscreen');
                    // When going fullscreen, also remove transform and set explicit 0,0
                    finderWindow.style.transform = 'none';
                    finderWindow.style.top = '0';
                    finderWindow.style.left = '0';
                    isFullscreen = true;
                } else {
                    finderWindow.classList.remove('fullscreen');
                    // When exiting fullscreen, reset to default centered position
                    finderWindow.style.top = '50%';
                    finderWindow.style.left = '50%';
                    finderWindow.style.transform = 'translate(-50%, -50%)';
                    finderWindow.style.width = '960px'; // Restore default width
                    finderWindow.style.height = '600px'; // Restore default height
                    isFullscreen = false;
                }
            });

            // Handle close button
            finderWindow.querySelector('.finder-circle.close').addEventListener('click', () => {
                finderWindow.style.display = 'none';
                currentMaterialViewMode = 'card'; // Revert to card view
                // Re-render the currently active material section in card view
                const activeMaterialSectionId = ['tutorialSection', 'pastPapersSection', 'exerciseSection'].find(id => document.getElementById(id).style.display !== 'none');
                if (activeMaterialSectionId) {
                    document.getElementById(activeMaterialSectionId).classList.remove('hidden-on-desktop');
                    const type = Object.keys(materialsConfig).find(key => materialsConfig[key].sectionId === activeMaterialSectionId);
                    if (type) renderStudentItems(type); // Re-render the card view
                }
                // When closing, reset position to default centered state for next open
                finderWindow.style.top = '50%';
                finderWindow.style.left = '50%';
                finderWindow.style.transform = 'translate(-50%, -50%)';
                finderWindow.style.width = '960px';
                finderWindow.style.height = '600px';
                finderWindow.classList.remove('fullscreen'); // Ensure fullscreen class is removed
            });
        }

        async function showFinderView(type) {
            finderCurrentType = type;
            finderCurrentPath = []; // Reset path to top level
            const finderSection = document.getElementById('finderMaterialsSection');
            finderSection.style.display = 'flex';
            
            // Hide the current card view for the active material type
            const activeMaterialSectionId = materialsConfig[type].sectionId;
            document.getElementById(activeMaterialSectionId).classList.add('hidden-on-desktop');

            await loadFinderSidebar(type);
            document.getElementById('finderFileListContent').innerHTML = '<p style="text-align:center; padding:20px; color:#666;">Select a subject from the sidebar.</p>';
        }

        async function loadFinderSidebar(type) {
            const sidebar = document.getElementById('finderSidebar');
            sidebar.innerHTML = '<p class="loading-indicator">Loading subjects...</p>';

            const config = materialsConfig[type];
            const collectionRef = collection(db, `artifacts/${appId}/public/data/${config.collectionName}`);
            const q = query(collectionRef, orderBy('name', 'asc'));

            try {
                const snapshot = await getDocs(q);
                sidebar.innerHTML = '';
                if (snapshot.empty) {
                    sidebar.innerHTML = '<p style="padding:10px; color:#666;">No subjects found.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const item = doc.data();
                    const div = document.createElement('div');
                    div.className = 'finder-sidebar-item';
                    div.textContent = item.name;
                    div.dataset.id = doc.id;
                    div.dataset.level = 1; // Mark as level 1 item
                    div.dataset.type = type;
                    div.addEventListener('click', () => handleFinderSidebarClick(div, type, doc.id));
                    sidebar.appendChild(div);
                });
            } catch (e) {
                console.error("Error loading finder sidebar:", e);
                sidebar.innerHTML = '<p class="error-message" style="padding:10px;">Error loading subjects.</p>';
            }
        }

        async function handleFinderSidebarClick(element, type, id) {
            // Remove active class from previous sidebar item
            document.querySelectorAll('.finder-sidebar-item.active').forEach(item => item.classList.remove('active'));
            element.classList.add('active');

            finderCurrentPath = [id]; // Set current path to the selected subject
            await loadFinderFileList(type, id);
        }

        async function loadFinderFileList(type, level1Id, level2Id = null) {
            const fileListContent = document.getElementById('finderFileListContent');
            fileListContent.innerHTML = '<p class="loading-indicator">Loading items...</p>';

            const config = materialsConfig[type];
            let itemsRef;
            let currentLevelName;
            let purchasedItems = {};

            if (level2Id) { // Showing Level 3 items (files)
                itemsRef = collection(db, getPath(type, [level1Id, level2Id]));
                currentLevelName = config.level3;
                if (config.isPaid) {
                    const purchaseCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/purchased_${config.collectionName}`);
                    const snapshot = await getDocs(purchaseCollectionRef);
                    snapshot.forEach(doc => purchasedItems[doc.id] = true);
                }
            } else { // Showing Level 2 items (folders)
                itemsRef = collection(db, getPath(type, [level1Id]));
                currentLevelName = config.level2;
            }

            const q = query(itemsRef, orderBy('name', currentLevelName === 'Year' ? 'desc' : 'asc'));

            try {
                const snapshot = await getDocs(q);
                fileListContent.innerHTML = '';
                if (snapshot.empty) {
                    fileListContent.innerHTML = `<p style="text-align:center; padding:20px; color:#666;">No ${currentLevelName.toLowerCase()}s found.</p>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const item = doc.data();
                    const row = document.createElement('div');
                    row.className = 'finder-file-list row';
                    row.dataset.id = doc.id;
                    row.dataset.name = item.name || item.title;
                    row.dataset.type = type;

                    let kind = '';
                    let size = ''; // Placeholder for size, not implemented
                    let dateAdded = item.timestamp ? new Date(item.timestamp).toLocaleDateString() : 'N/A';

                    if (!level2Id) { // This is a Level 2 folder (Topic/Year)
                        row.classList.add('folder');
                        kind = config.level2;
                        row.addEventListener('click', () => {
                            finderCurrentPath = [level1Id, doc.id]; // Update path
                            loadFinderFileList(type, level1Id, doc.id);
                        });
                    } else { // This is a Level 3 item (Video/Paper/Exercise)
                        row.classList.add('file'); // Default to file
                        let isPurchased = false;
                        if (config.isPaid) {
                            isPurchased = purchasedItems[doc.id];
                            if (isPurchased) row.classList.add('purchased');
                        }

                        if (type === 'tutorials') {
                            kind = 'Video';
                            row.classList.add('video');
                            row.addEventListener('click', () => handleStudentPreview(type, item));
                        } else if (type === 'pastPapers') {
                            kind = 'PDF';
                            row.addEventListener('click', () => handleStudentPreview(type, item));
                        } else if (type === 'exercises') {
                            kind = 'Exercise';
                            row.classList.add('exercise');
                            if (isPurchased) {
                                row.addEventListener('click', () => handleStudentPreview(type, item));
                            } else {
                                row.innerHTML += `<div style="grid-column: span 4; text-align: right; font-size: 0.8em; color: var(--accent-red);">Price: $${item.price.toFixed(2)} - Not Purchased</div>`;
                                // Add to cart button directly in the row for exercises
                                const addToCartBtn = document.createElement('button');
                                addToCartBtn.textContent = shoppingCart.some(cartItem => cartItem.id === doc.id) ? 'In Cart' : 'Add to Cart';
                                addToCartBtn.className = 'btn-primary';
                                addToCartBtn.style.cssText = 'padding: 4px 8px; font-size: 0.75rem; margin-left: auto;';
                                addToCartBtn.disabled = shoppingCart.some(cartItem => cartItem.id === doc.id);
                                addToCartBtn.addEventListener('click', (e) => {
                                    e.stopPropagation(); // Prevent row click from firing
                                    addToCart(item);
                                    addToCartBtn.textContent = 'In Cart';
                                    addToCartBtn.disabled = true;
                                });
                                row.appendChild(addToCartBtn);
                            }
                        }
                    }

                    row.innerHTML = `
                        <div>${item.name || item.title}</div>
                        <div>${size}</div>
                        <div>${kind}</div>
                        <div>${dateAdded}</div>
                    ` + (level2Id && type === 'exercises' && !purchasedItems[doc.id] ? '' : ''); // Remove price if already added above
                    
                    fileListContent.appendChild(row);
                });
            } catch (e) {
                console.error("Error loading finder file list:", e);
                fileListContent.innerHTML = `<p class="error-message" style="text-align:center; padding:20px;">Error loading items. A database index might be required. Check console for details.</p>`;
            }
        }

        // Handle clicks on items within the finder file list (for navigation or preview)
        document.getElementById('finderFileListContent').addEventListener('click', (e) => {
            const row = e.target.closest('.finder-file-list .row');
            if (!row) return;

            const type = row.dataset.type;
            const id = row.dataset.id;
            const name = row.dataset.name;
            const config = materialsConfig[type];

            if (row.classList.contains('folder')) {
                // Navigate into the folder
                const level1Id = finderCurrentPath[0];
                loadFinderFileList(type, level1Id, id);
            } else {
                // It's a file, handle preview/download
                const itemData = { id: id, name: name, ...materialsConfig[type].isPaid ? { price: parseFloat(row.dataset.price) } : {} }; // Reconstruct item data
                // Need to fetch full item data to get link/youtubeId
                const itemRef = doc(db, getPath(type, finderCurrentPath), id);
                getDoc(itemRef).then(docSnap => {
                    if (docSnap.exists()) {
                        handleStudentPreview(type, docSnap.data());
                    } else {
                        showModal('Error', 'Item details not found.');
                    }
                }).catch(err => {
                    console.error("Error fetching item for preview:", err);
                    showModal('Error', 'Could not retrieve item details for preview.');
                });
            }
        });

        // Function to handle student preview for both card and finder views
        function handleStudentPreview(type, item) {
            if (type === 'tutorials') {
                const videoPreviewModal = document.getElementById('videoPreviewModal');
                const videoPreviewTitle = document.getElementById('videoPreviewTitle');
                const videoPreviewContent = document.getElementById('videoPreviewContent');
                
                videoPreviewTitle.textContent = item.title;
                if (item.type === 'youtube') {
                    videoPreviewContent.innerHTML = `<iframe src="https://www.youtube.com/embed/${item.youtubeId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                } else if (item.type === 'embed') {
                    videoPreviewContent.innerHTML = item.embedCode;
                }
                videoPreviewModal.style.display = 'flex';
            } else if (type === 'pastPapers' || type === 'exercises') {
                if (item.link) {
                    window.open(item.link, '_blank');
                } else {
                    showModal('Preview Error', 'No link available for this item.');
                }
            }
        }

        // Listen for browser back/forward to update finder path (basic)
        window.addEventListener('popstate', () => {
            // This is a simplified approach. A full routing solution would be better.
            // For now, if the user navigates back, we can try to go up one level in the finder.
            if (document.getElementById('finderMaterialsSection').style.display === 'flex' && finderCurrentPath.length > 1) {
                finderCurrentPath.pop(); // Go up one level
                const type = finderCurrentType;
                const level1Id = finderCurrentPath[0];
                const level2Id = finderCurrentPath.length === 2 ? finderCurrentPath[1] : null;
                if (level1Id) {
                    loadFinderFileList(type, level1Id, level2Id);
                } else {
                    loadFinderSidebar(type); // Back to subjects list
                }
            }
        });

        // Initial check for screen width to set default view mode
        window.addEventListener('load', () => {
            if (window.innerWidth >= 769) {
                currentMaterialViewMode = 'finder'; // Default to finder for desktop
            } else {
                currentMaterialViewMode = 'card'; // Default to card for mobile
            }
        });

        // Adjust view mode on window resize
        window.addEventListener('resize', () => {
            const isDesktop = window.innerWidth >= 769;
            const finderSection = document.getElementById('finderMaterialsSection');
            const activeMaterialSectionId = ['tutorialSection', 'pastPapersSection', 'exerciseSection'].find(id => document.getElementById(id).style.display !== 'none');
            
            if (isDesktop && currentMaterialViewMode === 'finder') {
                finderSection.style.display = 'flex';
                if (activeMaterialSectionId) document.getElementById(activeMaterialSectionId).classList.add('hidden-on-desktop');
            } else if (!isDesktop && currentMaterialViewMode === 'finder') {
                finderSection.style.display = 'none';
                if (activeMaterialSectionId) document.getElementById(activeMaterialSectionId).classList.remove('hidden-on-desktop');
            } else if (isDesktop && currentMaterialViewMode === 'card') {
                finderSection.style.display = 'none';
                if (activeMaterialSectionId) document.getElementById(activeMaterialSectionId).classList.remove('hidden-on-desktop');
            }
            // If it's mobile and in card view, no change needed.
        });


    </script>
</body>
</html>
