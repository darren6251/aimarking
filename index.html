<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Marker</title>
    <!-- PDF.js library for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- Custom styles -->
    <style>
        :root {
            --black: #0d1117;
            --dark-gray: #161b22;
            --light-gray: #c9d1d9;
            --white: #ffffff;
            --blue: #58a6ff;
            --green: #3fb950;
            --red: #f85149;
            --border-color: #30363d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", sans-serif;
            color: var(--light-gray);
            background-color: var(--black);
            overflow-x: hidden;
            scroll-behavior: smooth;
            display: flex; /* Added for overall layout of app section */
            flex-direction: column; /* Added for overall layout of app section */
            min-height: 100vh; /* Ensure body takes full height */
        }

        button,
        input,
        textarea,
        select {
            transition: all .2s ease-out;
            font-family: inherit;
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        /* Keyframe animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* LOGIN PAGE: Full screen wrapper */
        #authWrapper {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1001; /* Ensure it's on top */
        }

        .login-left-panel,
        .login-right-panel {
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .login-left-panel {
            background: var(--black);
            color: var(--white);
            flex-direction: column;
            text-align: center;
        }

        .login-left-panel h1 {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 1rem;
        }

        .login-left-panel p {
            font-size: 1.75rem;
            font-weight: 400;
            line-height: 1.3;
            margin-bottom: .5rem;
            color: var(--light-gray);
        }

        .login-right-panel {
            background: var(--dark-gray);
            flex-direction: column;
        }
        
        #authContainer {
            width: 100%;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            background-color: var(--black);
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #authContainer h2 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--white);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: .75rem;
            cursor: pointer;
            background: var(--dark-gray);
            color: var(--white);
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        .google-btn:hover { background-color: #21262d; border-color: #8b949e; }
        .google-btn img { height: 20px; }
        
        #accessCodeInput {
             background-color: var(--dark-gray);
             border: 1px solid var(--border-color);
             color: var(--white);
             padding: 12px;
             border-radius: 6px;
             width: 100%;
             margin-bottom: 1rem;
             text-align: center;
        }
        #accessCodeInput:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
        }

        .btn-primary {
             background-color: var(--green);
             color: var(--white);
             padding: .75rem 1.5rem;
             border-radius: 6px;
             border: none;
             cursor: pointer;
             font-weight: 600;
        }
        .btn-primary:hover {
             background-color: #2ea043;
             transform: translateY(-1px);
        }
        
        #appSection {
            display: none; /* Hidden by default, shown by JS */
            flex-direction: column;
            height: 100vh;
            background-color: var(--black);
            animation: fadeIn .6s ease-out both;
        }
        
        header {
            background: var(--dark-gray);
            color: var(--white);
            display: flex;
            align-items: center;
            padding: 0 24px;
            height: 64px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .logo-container { display: flex; align-items: center; gap: 1rem; }
        .logo-container h1 { font-size: 1.5rem; font-weight: 700; }
        .logo-container p { font-weight: 400; color: #bbb; }
        
        .header-actions { margin-left: auto; display: flex; align-items: center; gap: 1rem; }
        .header-actions .tab { padding: 8px 16px; border-radius: 6px; cursor: pointer; color: var(--light-gray); font-weight: 500; }
        .header-actions .tab.active { background: rgba(88, 166, 255, 0.2); color: var(--blue); }
        .header-actions .tab:hover:not(.active) { background: #21262d; }

        .user-info { display: flex; align-items: center; gap: 1rem; }
        #userDisplayName { font-weight: 500; cursor: pointer; }
        .logout-btn { background: none; border: 1px solid var(--red); color: var(--red); cursor: pointer; padding: 6px 12px; border-radius: 6px; font-weight: 600; }
        .logout-btn:hover { background: rgba(248, 81, 73, 0.1); }

        main {
            flex: 1;
            display: flex;
            overflow-y: auto; /* Enables scrolling for main content */
            padding: 24px;
            gap: 24px;
            padding-bottom: 100px; /* More padding to avoid footer overlap */
        }
        
        /* Content Sections */
        #homeSection, #gradingSection, #chatSection, #studentManagementSection, #profileSection, #tutorialSection {
            display: none; /* Controlled by JS showSection */
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            width: 100%;
        }
        #profileSection { max-width: 800px; margin: 0 auto; }

        /* Form elements */
        label { display: block; font-weight: 600; margin-bottom: 8px; }
        input[type="text"], input[type="number"], input[type="email"], select {
            width: 100%; background-color: var(--dark-gray); border: 1px solid var(--border-color); color: var(--white);
            padding: 12px; border-radius: 6px; margin-bottom: 1rem;
        }
        textarea {
            width: 100%; background-color: var(--dark-gray); border: 1px solid var(--border-color); color: var(--white);
            padding: 12px; border-radius: 6px; margin-bottom: 1rem; resize: vertical; min-height: 120px;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3); }
        
        .drop-zone { border: 2px dashed var(--border-color); border-radius: 6px; min-height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 1rem; margin-bottom: 1.5rem; cursor: pointer; word-wrap: break-word; padding: 1rem; text-align: center; }
        .drop-zone.highlight { border-color: var(--blue); background: rgba(88, 166, 255, .1); }
        
        .file-preview { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; max-height: 200px; object-fit: contain; }
        .error-message { color: var(--red); font-size: 0.875rem; margin-top: -0.5rem; margin-bottom: 1rem; }

        #gradeButton { background-color: var(--green); color: var(--white); }
        #gradeButton:hover { background-color: #2ea043; }

        #resultContainer { margin-top: 1.5rem; padding: 1rem; border-radius: 6px; background-color: var(--dark-gray); border: 1px solid var(--border-color); min-height: 100px; white-space: pre-wrap; }
        #pastSubmissions { margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .submission-card { background-color: var(--dark-gray); padding: 1rem; border-radius: 6px; border: 1px solid var(--border-color); }

        /* Chat styles */
        #chatSection, #studentManagementSection { display: none; flex-direction: column; gap: 1rem; }
        #chatDisplay { flex: 1; background: var(--black); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { max-width: 85%; padding: 10px 14px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; }
        .chat-message.user { background-color: var(--blue); color: var(--black); align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-message.gemini { background-color: #21262d; align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-input-wrapper { display: flex; gap: .5rem; flex-shrink: 0; }
        #chatInput { flex: 1; padding: .75rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--dark-gray); color: var(--white); }
        #sendChatButton { padding: .5rem 1rem; border: none; background: var(--blue); color: var(--black); border-radius: 6px; font-weight: 600; cursor: pointer; }
        #sendChatButton:hover { background-color: #4c9aff; }
        
        .loading-indicator { text-align: center; padding: 1rem; color: var(--light-gray); }

        /* Student Management, Profile, Tutorial Pages */
        #studentManagementSection h2, #profileSection h2, #tutorialSection h2 { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; }
        .form-container { max-width: 600px; margin-bottom: 2rem; background: var(--dark-gray); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color); }
        
        #authorizedStudentsList { display: flex; flex-direction: column; gap: 0.5rem; }
        .student-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--dark-gray); padding: 0.75rem 1rem; border-radius: 6px; border: 1px solid var(--border-color); }
        .delete-student-btn { background: none; border: none; color: var(--red); cursor: pointer; padding: 4px; }
        .delete-student-btn:hover { background-color: rgba(248, 81, 73, 0.1); border-radius: 50%; }

        /* Tutorial Page styles */
        .tutorial-filters { display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap; }
        .tutorial-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .tutorial-card { background-color: var(--dark-gray); border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); display: flex; flex-direction: column; position:relative; }
        .tutorial-card-thumbnail { position: relative; }
        .tutorial-card-thumbnail img { width: 100%; display: block; aspect-ratio: 16/9; object-fit: cover; }
        .tutorial-card-duration { position: absolute; bottom: 8px; right: 8px; background-color: rgba(0,0,0,0.8); color: white; padding: 2px 6px; font-size: 0.75rem; border-radius: 4px; }
        .tutorial-card-content { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; }
        .tutorial-card-content h3 { font-size: 1.1rem; margin-bottom: 0.5rem; }
        .tutorial-card-info { font-size: 0.875rem; color: var(--light-gray); display: flex; gap: 1rem; margin-bottom: 1rem; }
        
        /* Teacher Tutorial Management Styles */
        .subject-item, .topic-item { padding: 1rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 1rem; background: #1a2028; }
        .subject-header, .topic-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .subject-header h3, .topic-header h4 { margin: 0; }
        .item-actions button { margin-left: 0.5rem; padding: 4px 8px; font-size: 0.8rem; }
        .topics-container, .videos-container { padding-left: 1.5rem; margin-top: 1rem; border-left: 2px solid var(--border-color); display: none; }
        .video-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 4px; }
        .video-item:hover { background-color: #21262d; }

        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; animation: fadeIn 0.3s ease-out; }
        .modal-content { background-color: var(--dark-gray); padding: 30px; border-radius: 8px; border: 1px solid var(--border-color); max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; animation: slideInUp 0.3s ease-out; }
        #modalTitle { margin-bottom: 1rem; font-size: 1.5rem; font-weight: 600; }
        #modalMessage { line-height: 1.5; }
        .close-button { position: absolute; top: 10px; right: 15px; font-size: 28px; cursor: pointer; color: #aaa; }
        .close-button:hover { color: #fff; }
        #modalButtons { display:flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }

        /* Footer */
        footer { position: fixed; bottom: 0; right: 0; text-align: right; padding: 10px 20px; color: var(--light-gray); font-size: 0.875rem; z-index: 100; pointer-events: none; }
        footer a { color: var(--blue); text-decoration: none; pointer-events: all;}
        footer a:hover { text-decoration: underline; }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            #authWrapper { flex-direction: column; position: static; height: auto; }
            .login-left-panel, .login-right-panel { width: 100%; }
            header { flex-direction: column; height: auto; padding: 1rem; align-items: flex-start; }
            .header-actions { margin-left: 0; margin-top: 1rem; flex-wrap: wrap; }
            main { flex-direction: column; }
            /* Home page specific responsive adjustments */
            .hero { flex-direction: column-reverse; text-align: center; }
            .hero-text, .hero-image { max-width: 100%; }
            .buttons { justify-content: center; }
        }

        /* --- Styles from AI_Marker_Home_Page.html (adapted for dark theme) --- */
        /* Hero */
        .hero {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2rem 1.5rem;
            position: relative;
            overflow: hidden;
            background-color: var(--black); /* Ensure hero background matches body */
            color: var(--light-gray);
        }
        .hero-text {
            max-width: 50%;
            font-size: 2rem;
            font-weight: bold;
            opacity: 0;
            animation: slideInLeft 1s ease-out forwards;
        }
        .hero-text span {
            display: block;
            font-size: 1.5rem;
            font-weight: normal;
            margin-top: 0.5rem;
            color: var(--blue); /* Highlighted text */
        }
        .hero-image {
            max-width: 40%;
            opacity: 0;
            animation: slideInRight 1s ease-out forwards;
        }
        .hero-image img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); /* Add subtle shadow */
        }

        /* Buttons */
        .buttons {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
        }
        .buttons a {
            padding: 0.6rem 1.2rem;
            border: 2px solid var(--blue); /* Use theme blue for consistency */
            border-radius: 4px;
            font-size: 1rem;
            transition: background 0.2s, color 0.2s;
            color: var(--blue); /* Default text color for buttons */
            text-decoration: none;
        }
        .buttons a:hover {
            background: var(--blue); /* Fill with blue on hover */
            color: var(--white); /* White text on blue background */
        }

        /* Why AI */
        .why-ai {
            padding: 2rem 1.5rem;
            border-top: 1px solid var(--border-color); /* Use theme border color */
            background-color: var(--dark-gray); /* Darker background for contrast */
            margin-top: 2rem;
            border-radius: 8px;
        }
        .why-ai h2 {
            font-size: 1.75rem;
            margin-bottom: 1rem;
            color: var(--green); /* Use theme green for headings */
        }
        .why-ai p {
            color: var(--light-gray); /* Light gray for body text */
            line-height: 1.6;
        }

        /* Animations */
        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to   { transform: translateX(0);    opacity: 1; }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to   { transform: translateX(0);    opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="authWrapper" style="display: none;">
        <div class="login-left-panel">
            <h1>Let AI mark your work.</h1>
            <p>Let AI assist you, not replace you</p>
            <p>Mark with AI, learn better</p>
        </div>
        <div class="login-right-panel">
            <div id="authContainer">
                 <!-- JS will inject googleSignInTemplate or codeEntryTemplate here -->
            </div>
        </div>
    </div>

    <div id="appSection" style="display: none;">
        <header>
            <div class="logo-container">
                <h1>AI Marker</h1>
                <p>Operated by Darren Ng</p>
            </div>
            <div class="header-actions">
                <button id="toggleHomeButton" class="tab active">Home</button>
                <button id="toggleGradingButton" class="tab">Exam Grader</button>
                <button id="toggleChatButton" class="tab">Chat with Gemini</button>
                <button id="toggleTutorialButton" class="tab">Tutorial Videos</button>
                <button id="manageStudentsButton" class="tab" style="display: none;">Manage Students</button>
                <button id="toggleProfileButton" class="tab">Profile</button>
                <div class="user-info">
                     <span id="userDisplayName"></span>
                     <button id="logoutButton" class="logout-btn">Log Out</button>
                </div>
            </div>
        </header>
        
        <main>
            <!-- NEW HOME SECTION -->
            <div id="homeSection" style="display: block; opacity: 1;">
                <section class="hero">
                    <div class="hero-text">
                        AI helps you learn better
                        <span>to fight DSE</span>
                        <div class="buttons">
                            <a href="#tutorial" id="homeTutorialLink">Tutorial Video</a>
                            <a href="#grader" id="homeGraderLink">Exam Grader</a>
                            <a href="#chat" id="homeChatLink">Chat with AI</a>
                        </div>
                    </div>
                    <div class="hero-image">
                        <!-- Placeholder image. If you have hero.jpg, upload it or replace with a descriptive placeholder -->
                        <img src="https://placehold.co/600x400/161b22/c9d1d9?text=AI+Marker+Hero" alt="Darren Ng demonstrating AI Marker">
                    </div>
                </section>

                <section class="why-ai" id="why-ai">
                    <h2>Why AI</h2>
                    <p>
                        AI serves as a powerful assistant in your studies, especially when preparing for challenging exams like DSE. It can provide instant feedback on your work, identify areas where you need improvement, and offer personalized explanations. Unlike traditional methods, AI can analyze vast amounts of information and adapt to your learning style, making your study sessions more efficient and effective. It helps you grasp complex concepts, practice critical thinking, and build confidence, ultimately empowering you to perform your best.
                    </p>
                </section>
            </div>


            <div id="gradingSection">
                 <!-- Grading content remains the same -->
                <div class="mb-4">
                    <label>Upload Student's Work (Image or PDF):</label>
                    <div id="studentDropZone" class="drop-zone">
                        <span>Drag & Drop Student's Work Here or click to select</span>
                        <input type="file" id="studentAnswerFile" accept="image/*,application/pdf" hidden>
                    </div>
                     <span id="studentFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                    <img id="studentFilePreview" class="file-preview mx-auto" style="display: none;" alt="Student Work Preview">
                    <label for="studentAnswer">Or type Student's Answer:</label>
                    <textarea id="studentAnswer" placeholder="Enter student's answer here..."></textarea>
                    <p id="studentAnswerError" class="error-message"></p>
                </div>

                <div class="mb-6">
                    <label>Upload Answer Key (Image or PDF):</label>
                    <div id="answerKeyDropZone" class="drop-zone">
                        <span>Drag & Drop Answer Key Here or click to select</span>
                         <input type="file" id="answerKeyFile" accept="image/*,application/pdf" hidden>
                    </div>
                    <span id="answerKeyFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                    <img id="answerKeyFilePreview" class="file-preview mx-auto" style="display: none;" alt="Answer Key Preview">
                    <label for="answerKey">Or type Answer Key:</label>
                    <textarea id="answerKey" placeholder="Enter the correct answer key here..."></textarea>
                    <p id="answerKeyError" class="error-message"></p>
                </div>

                <button id="gradeButton" class="btn-primary">Grade Work</button>
                <p id="gradingLoadingIndicator" class="loading-indicator"></p>
                <div id="resultContainer">
                    <h2>Grading Results:</h2>
                    <p id="gradeResult">Your grading results will appear here.</p>
                </div>

                <div style="margin-top: 2rem;">
                    <h2>Past Submissions:</h2>
                    <div id="pastSubmissions">
                        <p id="noSubmissions">No past submissions found.</p>
                    </div>
                </div>
            </div>

            <div id="chatSection">
                 <!-- Chat content remains the same -->
                <div id="chatDisplay">
                    <div class="chat-message gemini">Hello! How can I help you today?</div>
                </div>
                <div class="chat-input-wrapper">
                    <input type="text" id="chatInput" placeholder="Type a message…">
                    <button id="sendChatButton">Send</button>
                </div>
                 <p id="chatLoadingIndicator" class="loading-indicator"></p>
            </div>

            <div id="studentManagementSection">
                <!-- Student management content remains the same -->
                <h2>Manage Authorized Students</h2>
                <div class="add-student-form form-container">
                    <input type="email" id="studentEmailInput" placeholder="Enter student's Gmail address">
                    <button id="addStudentButton">Add Student</button>
                </div>
                <p id="studentManagementLoading" class="loading-indicator"></p>
                <div id="authorizedStudentsList">
                    <p id="noAuthorizedStudents">No authorized students yet.</p>
                </div>
            </div>

            <div id="tutorialSection">
                 <!-- === NEW RESTRUCTURED TUTORIAL SECTION === -->
                 <h2>Tutorial Videos</h2>

                 <!-- Teacher View: For managing subjects, topics, and videos -->
                 <div id="teacherTutorialView" style="display:none;">
                     <div class="form-container" style="max-width: initial;">
                         <button id="addSubjectBtn" class="btn-primary">Add New Subject</button>
                     </div>
                     <div id="subjectsContainer">
                        <p class="loading-indicator">Loading subjects...</p>
                     </div>
                 </div>
                 
                 <!-- Student View: For filtering and watching videos -->
                 <div id="studentTutorialView" style="display:none;">
                     <div class="tutorial-filters">
                         <select id="subjectFilter" style="width:250px;">
                             <option value="">-- Select a Subject --</option>
                         </select>
                         <select id="topicFilter" style="width:250px;" disabled>
                             <option value="">-- Select a Topic --</option>
                         </select>
                     </div>
                     <div id="tutorialGrid" class="tutorial-grid">
                         <p id="noTutorials">Please select a subject and topic to see videos.</p>
                     </div>
                 </div>
            </div>

            <div id="profileSection">
                <!-- Profile content remains the same -->
                <h2>Edit Your Profile</h2>
                <form id="profileForm" class="form-container">
                    <div style="margin-bottom: 1rem;">
                        <label for="profileName">Display Name</label>
                        <input type="text" id="profileName" name="name" required>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileAge">Age</label>
                        <input type="number" id="profileAge" name="age">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileGrade">Year/Grade</label>
                        <input type="text" id="profileGrade" name="grade">
                    </div>
                     <div style="margin-bottom: 1rem;">
                        <label for="profileSchool">School</label>
                        <input type="text" id="profileSchool" name="school">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileElectives">Elective Subjects</label>
                        <textarea id="profileElectives" name="electives" placeholder="e.g., Physics, Computer Science, Art"></textarea>
                    </div>
                    <button type="submit" id="saveProfileButton" class="btn-primary">Save Profile</button>
                </form>
            </div>
        </main>
    </div>

    <footer>
        <a href="mailto:darren_0625@mc-zero.com">Contact: darren_0625@mc-zero.com</a> | Copyright © 2025 Operated by Darren Ng
    </footer>

    <!-- Universal Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle"></h3>
            <div id="modalMessage"></div>
            <div id="modalButtons"></div>
        </div>
    </div>
    
    <!-- Add Video Form Modal -->
    <div id="addVideoModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3>Add New Tutorial Video</h3>
             <form id="addVideoForm">
                <input type="hidden" id="videoSubjectId">
                <input type="hidden" id="videoTopicId">
                 <div style="margin-bottom: 1rem;">
                     <label for="tutorialLink">YouTube Video Link</label>
                     <input type="text" id="tutorialLink" required placeholder="https://www.youtube.com/watch?v=...">
                     <img id="tutorialThumbnailPreview" style="max-width:200px; margin-top:10px; border-radius:8px; display:none;" alt="Video Thumbnail Preview"/>
                 </div>
                 <div style="margin-bottom: 1rem;">
                     <label for="tutorialTitle">Video Title</label>
                     <input type="text" id="tutorialTitle" required>
                 </div>
                 <div id="modalButtons">
                    <button type="submit" class="btn-primary">Add Video</button>
                 </div>
             </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
          authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30",
          storageBucket: "ai-grading-9bb30.firebasestorage.app",
          messagingSenderId: "298162112230",
          appId: "1:298162112230:web:529d3f95536991be685d27",
          measurementId: "G-CHKLKSM17S"
        };
        
        // __app_id is a global variable provided by the Canvas environment.
        // If running outside Canvas, 'default-app-id' is used as a fallback.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const CLOUDFLARE_WORKER_URL = "https://ai-marker-gemini-proxy.darren-xie11.workers.dev/";
        const TEACHER_CODE = "TEACHER123";
        const STUDENT_CODE = "STUDENT456";

        // Set PDF.js worker source to prevent cross-origin issues
        pdfjsLib.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let app, db, auth, storage;
        let currentUserId = null, currentUserEmail = null, currentUserRole = null, currentUserName = null;
        // Initialize chat history with a system instruction and a greeting from the model
        let geminiChatHistory = [{ role: "user", parts: [{text: "You are an AI assistant."}]}, { role: "model", parts: [{text: "Hello! How can I assist you?"}]}];

        const authWrapper = document.getElementById('authWrapper');
        const appSection = document.getElementById('appSection');
        const authContainer = document.getElementById('authContainer');

        const googleSignInTemplate = `
            <h2>Sign In</h2>
            <button id="googleSignInButton" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
                <span>Sign in with Google</span>
            </button>
            <p id="authError" class="error-message"></p>
        `;

        const codeEntryTemplate = `
            <h2>Enter Access Code</h2>
            <p style="color: #888; text-align: center; margin-bottom: 1rem;">Please enter the access code provided by your administrator.</p>
            <input type="text" id="accessCodeInput" placeholder="Enter code here">
            <button id="submitCodeButton" class="btn-primary" style="width:100%">Submit Code</button>
            <p id="codeError" class="error-message"></p>
        `;

        // Initialize Firebase
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            // Display a user-friendly modal if Firebase initialization fails
            showModal('Firebase Configuration Error', `Failed to initialize Firebase. Please check your console for details. Error: ${error.message}`);
        }

        // Listen for Firebase authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                currentUserEmail = user.email;
                // Reference to the user's profile document in Firestore
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                try {
                    const userProfileDoc = await getDoc(userProfileRef);
                    // If user profile exists and has a role, set the role and show the app
                    if (userProfileDoc.exists() && userProfileDoc.data().role) {
                        const profileData = userProfileDoc.data();
                        currentUserRole = profileData.role;
                        currentUserName = profileData.name || user.displayName; // Use saved name, fallback to Google display name
                        // Update last login timestamp in the user's profile
                        await setDoc(userProfileRef, { name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                        showApp();
                    } else {
                        // If no role assigned, prompt for access code
                        currentUserName = user.displayName; // Set temporary name before profile is saved
                        currentUserRole = 'unassigned';
                        showCodeEntry();
                    }
                } catch (e) {
                     console.error("Error checking user profile:", e);
                     // If there's an error getting profile, revert to login
                     showModal('Profile Error', `Could not load user profile. Please try again. Error: ${e.message}`);
                     showLogin();
                }
            } else {
                // If no user is logged in, reset user info and show login
                currentUserId = null;
                currentUserRole = null;
                currentUserName = null;
                showLogin();
            }
        });

        // Displays the login section
        function showLogin() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authWrapper.style.opacity = '1'; // Fade in effect
            authContainer.innerHTML = googleSignInTemplate;
            document.getElementById('googleSignInButton')?.addEventListener('click', handleGoogleSignIn);
        }

        // Displays the access code entry section
        function showCodeEntry() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authWrapper.style.opacity = '1'; // Fade in effect
            authContainer.innerHTML = codeEntryTemplate;
            const submitCodeBtn = document.getElementById('submitCodeButton');
            const accessCodeInput = document.getElementById('accessCodeInput');
            submitCodeBtn?.addEventListener('click', handleSubmitCode);
            // Add 'Enter' key listener for the access code input
            accessCodeInput?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevent default form submission if any
                    handleSubmitCode();
                }
            });
            accessCodeInput?.focus(); // Focus on the input field
        }

        // Displays the main application section
        function showApp() {
            authWrapper.style.display = 'none';
            appSection.style.display = 'flex';
            // Update display name and role in the header
            document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
            // Show/hide "Manage Students" button based on user role
            document.getElementById('manageStudentsButton').style.display = currentUserRole === 'teacher' ? 'block' : 'none';
            
            // Initialize tutorial section based on current user's role
            setupTutorialSection();

            // Default to Home section on app load
            showSection('homeSection');
            loadPastSubmissions(); // Load user's past submissions
            if(currentUserRole === 'teacher') loadAuthorizedStudents(); // Load authorized students for teachers

            // Add event listeners for home page links
            document.getElementById('homeTutorialLink')?.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('tutorialSection');
            });
            document.getElementById('homeGraderLink')?.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('gradingSection');
            });
            document.getElementById('homeChatLink')?.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('chatSection');
            });
        }

        // Handles Google Sign-In using Firebase Auth
        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try { 
                await signInWithPopup(auth, provider); 
                // onAuthStateChanged listener will handle redirection after successful sign-in
            } catch (error) { 
                document.getElementById('authError').textContent = `Sign-in failed. Please try again. Error: ${error.message}`; 
                console.error("Google Sign-In Error:", error);
            }
        }

        // Handles submission of access code
        async function handleSubmitCode() {
            const code = document.getElementById('accessCodeInput').value.trim();
            const codeError = document.getElementById('codeError');
            codeError.textContent = ''; // Clear previous errors
            let roleToSet = null;

            if (code === TEACHER_CODE) roleToSet = 'teacher';
            else if (code === STUDENT_CODE) roleToSet = 'student';
            else { 
                codeError.textContent = 'Invalid access code.'; 
                return; 
            }
            
            try {
                // Save the assigned role to the user's profile in Firestore
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await setDoc(userProfileRef, { role: roleToSet, name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                currentUserRole = roleToSet; // Update current user's role
                showModal('Success!', `Your role has been set to ${roleToSet}. Please complete your profile.`);
                showApp(); // Show the main app
                showSection('profileSection'); // Navigate to profile section to encourage completion
            } catch (error) {
                codeError.textContent = `Could not set role. Please try again. Error: ${error.message}`;
                console.error("Submit Code Error:", error);
            }
        }

        // Add event listener for the logout button
        document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));

        // Function to show a specific section of the app
        function showSection(sectionIdToShow) {
            const sections = ['homeSection', 'gradingSection', 'chatSection', 'studentManagementSection', 'profileSection', 'tutorialSection'];
            const buttons = {
                toggleHomeButton: 'homeSection',
                toggleGradingButton: 'gradingSection',
                toggleChatButton: 'chatSection',
                manageStudentsButton: 'studentManagementSection',
                toggleProfileButton: 'profileSection',
                toggleTutorialButton: 'tutorialSection'
            };
            
            let targetButtonId = null;
            // Find the button corresponding to the section to show
            for(const [btnId, secId] of Object.entries(buttons)){
                 if(secId === sectionIdToShow) targetButtonId = btnId;
            }

            // Deactivate all header tabs and activate the target one
            document.querySelectorAll('.header-actions .tab').forEach(t => t.classList.remove('active'));
            if(targetButtonId) document.getElementById(targetButtonId)?.classList.add('active');

            // Hide all sections and show only the target section with a fade effect
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    const isTarget = id === sectionIdToShow;
                    // For main sections, use 'block', for others like chat, use 'flex'
                    section.style.display = isTarget ? (id === 'chatSection' || id === 'studentManagementSection' ? 'flex' : 'block') : 'none';
                    // Apply opacity change after a small delay for animation
                    setTimeout(() => section.style.opacity = isTarget ? '1' : '0', 10);
                }
            });

            // Load profile data if navigating to the profile section
            if (sectionIdToShow === 'profileSection') loadProfileData();
        }

        // Sets up event listeners for section toggle buttons in the header
        function setupSectionToggle() {
             const buttons = {
                toggleHomeButton: 'homeSection',
                toggleGradingButton: 'gradingSection',
                toggleChatButton: 'chatSection',
                manageStudentsButton: 'studentManagementSection',
                toggleProfileButton: 'profileSection',
                toggleTutorialButton: 'tutorialSection',
            };
            Object.entries(buttons).forEach(([buttonId, sectionId]) => {
                document.getElementById(buttonId)?.addEventListener('click', () => showSection(sectionId));
            });
            // Allow clicking user display name to go to profile
            document.getElementById('userDisplayName')?.addEventListener('click', () => showSection('profileSection'));
        }
        setupSectionToggle(); // Call to set up listeners on load
        
        // Profile Management: Handles saving user profile data
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default form submission
            if (!currentUserId) { showModal('Error', 'You must be logged in to save your profile.'); return; }
            
            const formData = new FormData(e.target);
            const profileData = Object.fromEntries(formData.entries()); // Convert form data to an object
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            try {
                await setDoc(userProfileRef, profileData, { merge: true }); // Merge new data with existing
                currentUserName = profileData.name; // Update displayed user name
                document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
                showModal('Success', 'Your profile has been updated!');
            } catch (error) {
                console.error("Error saving profile:", error);
                showModal('Error', `Could not save profile: ${error.message}`);
            }
        });

        // Profile Management: Loads existing user profile data into the form
        async function loadProfileData() {
            if (!currentUserId) return;
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            const docSnap = await getDoc(userProfileRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                // Populate form fields with data, fallback to empty string if undefined
                document.getElementById('profileName').value = data.name || '';
                document.getElementById('profileAge').value = data.age || '';
                document.getElementById('profileGrade').value = data.grade || '';
                document.getElementById('profileSchool').value = data.school || '';
                document.getElementById('profileElectives').value = data.electives || '';
            }
        }
        
        // --- TUTORIALS RESTRUCTURED ---
        // Reference to the 'subjects' collection in Firestore (public data)
        const subjectsRef = collection(db, `artifacts/${appId}/public/data/subjects`);

        // Sets up the tutorial section view based on the user's role
        function setupTutorialSection() {
            if (currentUserRole === 'teacher') {
                document.getElementById('teacherTutorialView').style.display = 'block';
                document.getElementById('studentTutorialView').style.display = 'none';
                setupTeacherTutorialView(); // Initialize teacher-specific tutorial view
            } else {
                document.getElementById('teacherTutorialView').style.display = 'none';
                document.getElementById('studentTutorialView').style.display = 'block';
                setupStudentTutorialView(); // Initialize student-specific tutorial view
            }
        }
        
        // --- Teacher View Logic ---
        function setupTeacherTutorialView() {
            renderTeacherSubjects(); // Render existing subjects
            document.getElementById('addSubjectBtn').onclick = handleAddSubject;
            
            // Use event delegation for dynamically added buttons within subjectsContainer
            const subjectsContainer = document.getElementById('subjectsContainer');
            subjectsContainer.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return; // Not a button click

                // Handle adding/deleting topics and videos using dataset attributes
                if (target.matches('.add-topic-btn')) {
                    handleAddTopic(target.dataset.subjectId);
                } else if (target.matches('.delete-subject-btn')) {
                    handleDelete(target.dataset.subjectId, 'subject');
                } else if (target.matches('.add-video-btn')) {
                    showAddVideoModal(target.dataset.subjectId, target.dataset.topicId);
                } else if (target.matches('.delete-topic-btn')) {
                    handleDelete(target.dataset.subjectId, 'topic', target.dataset.topicId);
                } else if (target.matches('.delete-video-btn')) {
                    handleDelete(target.dataset.subjectId, 'video', target.dataset.topicId, target.dataset.videoId);
                }
            });

            // Event delegation for expanding/collapsing subject topics and videos
            subjectsContainer.addEventListener('click', async (e) => {
                 // Check if the click was on a subject header or its children
                 if (e.target.matches('.subject-header, .subject-header *')) {
                    const header = e.target.closest('.subject-header');
                    const subjectId = header.dataset.subjectId;
                    const topicsContainer = document.getElementById(`topics-container-${subjectId}`);
                    // Toggle display of topics container
                    if(topicsContainer.style.display === 'block') {
                        topicsContainer.style.display = 'none';
                    } else {
                        topicsContainer.style.display = 'block';
                        // Load topics only if not already loaded (lazy loading)
                        if (!topicsContainer.dataset.loaded) {
                            await renderTeacherTopics(subjectId);
                            topicsContainer.dataset.loaded = true;
                        }
                    }
                } else if (e.target.matches('.topic-header, .topic-header *')) {
                    const header = e.target.closest('.topic-header');
                    const subjectId = header.dataset.subjectId; // Assuming subjectId is available via dataset from the parent subject
                    const topicId = header.dataset.topicId;
                    const videosContainer = document.getElementById(`videos-container-${topicId}`);
                     // Toggle display of videos container
                    if(videosContainer.style.display === 'block') {
                        videosContainer.style.display = 'none';
                    } else {
                        videosContainer.style.display = 'block';
                        // Load videos only if not already loaded
                        if (!videosContainer.dataset.loaded) {
                            await renderTeacherVideos(subjectId, topicId);
                            videosContainer.dataset.loaded = true;
                        }
                    }
                }
            });
        }

        // Renders the list of subjects for the teacher view
        async function renderTeacherSubjects() {
            const container = document.getElementById('subjectsContainer');
            container.innerHTML = '<p class="loading-indicator">Loading subjects...</p>'; // Show loading message
            const q = query(subjectsRef, orderBy('name')); // Order subjects alphabetically by name
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                container.innerHTML = '<p>No subjects created yet. Click "Add New Subject" to start.</p>';
                return;
            }

            container.innerHTML = ''; // Clear loading message
            querySnapshot.forEach(doc => {
                const subject = doc.data();
                const subjectEl = document.createElement('div');
                subjectEl.className = 'subject-item';
                subjectEl.innerHTML = `
                    <div class="subject-header" data-subject-id="${doc.id}">
                        <h3>${subject.name}</h3>
                        <div class="item-actions">
                            <button class="add-topic-btn btn-primary" data-subject-id="${doc.id}">Add Topic</button>
                            <button class="delete-subject-btn logout-btn" data-subject-id="${doc.id}">Delete</button>
                        </div>
                    </div>
                    <div class="topics-container" id="topics-container-${doc.id}"></div>
                `;
                container.appendChild(subjectEl);
            });
        }

        // Renders the list of topics for a given subject in the teacher view
        async function renderTeacherTopics(subjectId) {
            const topicsRef = collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics`);
            const container = document.getElementById(`topics-container-${subjectId}`);
            container.innerHTML = '<p class="loading-indicator">Loading topics...</p>';
            
            const q = query(topicsRef, orderBy('name'));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                container.innerHTML = '<p>No topics yet. Click "Add Topic" to create one.</p>';
                return;
            }
            container.innerHTML = '';
            querySnapshot.forEach(doc => {
                const topic = doc.data();
                const topicEl = document.createElement('div');
                topicEl.className = 'topic-item';
                // Add data-subject-id to topic-header for easier event delegation if needed
                topicEl.innerHTML = `
                     <div class="topic-header" data-subject-id="${subjectId}" data-topic-id="${doc.id}">
                        <h4>${topic.name}</h4>
                         <div class="item-actions">
                            <button class="add-video-btn btn-primary" data-subject-id="${subjectId}" data-topic-id="${doc.id}">Add Video</button>
                            <button class="delete-topic-btn logout-btn" data-subject-id="${subjectId}" data-topic-id="${doc.id}">Delete</button>
                        </div>
                    </div>
                     <div class="videos-container" id="videos-container-${doc.id}"></div>
                `;
                container.appendChild(topicEl);
                // Load videos for this topic immediately (can be made lazy if performance is an issue with many topics)
                renderTeacherVideos(subjectId, doc.id);
            });
        }
        
        // Renders the list of videos for a given topic in the teacher view
        async function renderTeacherVideos(subjectId, topicId) {
            const videosRef = collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics/${topicId}/videos`);
            const container = document.getElementById(`videos-container-${topicId}`);
            // Force display of videos container and remove cursor from topic header as it's not collapsible here
            container.parentElement.querySelector('.topic-header').style.cursor = 'default'; 
            container.style.display = 'block'; 
            container.innerHTML = '<p class="loading-indicator">Loading videos...</p>';

            const q = query(videosRef, orderBy('timestamp', 'desc'));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                container.innerHTML = '<p>No videos yet.</p>'; 
                return;
            }
            container.innerHTML = '';
            querySnapshot.forEach(doc => {
                const video = doc.data();
                const videoEl = document.createElement('div');
                videoEl.className = 'video-item';
                videoEl.innerHTML = `
                    <span>${video.title}</span>
                    <button class="delete-video-btn logout-btn" data-subject-id="${subjectId}" data-topic-id="${topicId}" data-video-id="${doc.id}">Delete</button>
                `;
                container.appendChild(videoEl);
            });
        }
        
        // Handles adding a new subject via a modal input
        function handleAddSubject() {
            showInputModal('Add New Subject', 'Enter Subject Name:', async (name) => {
                try {
                    await addDoc(subjectsRef, { name: name.trim() }); // Trim whitespace
                    showModal('Success', `Subject "${name}" added.`);
                    renderTeacherSubjects(); // Re-render subjects to show the new one
                } catch (e) { 
                    console.error("Error adding subject:", e);
                    showModal('Error', `Could not add subject: ${e.message}`); 
                }
            });
        }
        
        // Handles adding a new topic for a given subject via a modal input
        function handleAddTopic(subjectId) {
            showInputModal('Add New Topic', 'Enter Topic Name:', async (name) => {
                try {
                    const topicsRef = collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics`);
                    await addDoc(topicsRef, { name: name.trim() }); // Trim whitespace
                    showModal('Success', `Topic "${name}" added.`);
                    renderTeacherTopics(subjectId); // Re-render topics for the subject
                } catch (e) { 
                    console.error("Error adding topic:", e);
                    showModal('Error', `Could not add topic: ${e.message}`); 
                }
            });
        }

        const addVideoModal = document.getElementById('addVideoModal');
        const addVideoForm = document.getElementById('addVideoForm');
        
        // Shows the modal for adding a new tutorial video
        function showAddVideoModal(subjectId, topicId) {
            addVideoForm.reset(); // Clear form fields
            document.getElementById('tutorialThumbnailPreview').style.display = 'none'; // Hide thumbnail
            document.getElementById('videoSubjectId').value = subjectId; // Set hidden subject ID
            document.getElementById('videoTopicId').value = topicId;   // Set hidden topic ID
            addVideoModal.style.display = 'flex'; // Display the modal
            document.getElementById('tutorialLink').focus(); // Focus on the first input
        }

        // Event listener for submitting the Add Video form
        addVideoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const subjectId = document.getElementById('videoSubjectId').value;
            const topicId = document.getElementById('videoTopicId').value;
            const link = document.getElementById('tutorialLink').value;
            const title = document.getElementById('tutorialTitle').value;
            const youtubeId = getYouTubeId(link); // Extract YouTube video ID from the link

            if (!youtubeId || !title.trim()) { // Validate presence of YouTube ID and trimmed title
                showModal('Input Error', 'Please provide a valid YouTube video link and title.'); 
                return; 
            }
            
            try {
                // Add video document to Firestore
                const videosRef = collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics/${topicId}/videos`);
                await addDoc(videosRef, { youtubeId, title: title.trim(), timestamp: Date.now() });
                showModal('Success', 'Video added successfully!');
                addVideoModal.style.display = 'none'; // Hide the modal
                renderTeacherVideos(subjectId, topicId); // Re-render videos for the topic
            } catch (error) { 
                console.error("Error adding video:", error);
                showModal('Error', `Could not add video: ${error.message}`); 
            }
        });

        // Handles deletion of subjects, topics, or videos
        function handleDelete(subjectId, type, topicId = null, videoId = null) {
            // Show a confirmation modal before deleting
            showModal('Confirm Deletion', `Are you sure you want to delete this ${type}? This action cannot be undone.`, [
                { text: 'Delete', className: 'btn-primary', onClick: async () => {
                    let docRef;
                    // Determine the correct Firestore document reference based on the item type
                    if (type === 'subject') {
                        docRef = doc(db, `artifacts/${appId}/public/data/subjects`, subjectId);
                    } else if (type === 'topic') {
                        docRef = doc(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics`, topicId);
                    } else if (type === 'video') {
                        docRef = doc(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics/${topicId}/videos`, videoId);
                    }
                    try {
                        await deleteDoc(docRef); // Perform deletion
                        showModal('Success', `${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully.`);
                        // Re-render the appropriate list after deletion
                        if (type === 'subject') renderTeacherSubjects();
                        if (type === 'topic') renderTeacherTopics(subjectId);
                        if (type === 'video') renderTeacherVideos(subjectId, topicId);
                    } catch (e) { 
                        console.error("Error deleting item:", e);
                        showModal('Error', `Could not delete item: ${e.message}`); 
                    }
                }},
                { text: 'Cancel', className: 'logout-btn' } // Cancel button
            ]);
        }
        
        // --- Student View Logic ---
        const subjectFilter = document.getElementById('subjectFilter');
        const topicFilter = document.getElementById('topicFilter');

        // Sets up the tutorial view for students by populating subject filter
        async function setupStudentTutorialView() {
            subjectFilter.innerHTML = '<option value="">-- Loading Subjects --</option>';
            topicFilter.innerHTML = '<option value="">-- Select a Topic --</option>';
            topicFilter.disabled = true; // Disable topic filter initially
            document.getElementById('tutorialGrid').innerHTML = '<p id="noTutorials">Please select a subject and topic to see videos.</p>';

            const q = query(subjectsRef, orderBy('name'));
            const querySnapshot = await getDocs(q);

            subjectFilter.innerHTML = '<option value="">-- Select a Subject --</option>';
            if (querySnapshot.empty) {
                 subjectFilter.innerHTML = '<option value="">-- No Subjects Available --</option>';
                 return;
            }
            querySnapshot.forEach(doc => {
                const option = new Option(doc.data().name, doc.id);
                subjectFilter.add(option);
            });

            // Attach event listeners for filter changes
            subjectFilter.onchange = handleSubjectChange;
            topicFilter.onchange = handleTopicChange;
        }

        // Handles change in the subject filter for students
        async function handleSubjectChange() {
            const subjectId = subjectFilter.value;
            topicFilter.innerHTML = '<option value="">-- Loading Topics --</option>';
            topicFilter.disabled = true;
            document.getElementById('tutorialGrid').innerHTML = '<p>Please select a topic.</p>';

            if (!subjectId) {
                topicFilter.innerHTML = '<option value="">-- Select a Topic --</option>';
                return;
            }

            const topicsRef = collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics`);
            const q = query(topicsRef, orderBy('name'));
            const querySnapshot = await getDocs(q);

            topicFilter.innerHTML = '<option value="">-- Select a Topic --</option>';
            if (querySnapshot.empty) {
                topicFilter.innerHTML = '<option value="">-- No Topics Available --</option>';
                return;
            }
            querySnapshot.forEach(doc => {
                const option = new Option(doc.data().name, doc.id);
                topicFilter.add(option);
            });
            topicFilter.disabled = false; // Enable topic filter once topics are loaded
        }
        
        // Handles change in the topic filter for students, loading relevant videos
        async function handleTopicChange() {
            const subjectId = subjectFilter.value;
            const topicId = topicFilter.value;
            const grid = document.getElementById('tutorialGrid');
            grid.innerHTML = '<p class="loading-indicator">Loading videos...</p>';
            
            if (!subjectId || !topicId) {
                grid.innerHTML = '<p>Please select a subject and topic.</p>'; 
                return;
            }
            
            const videosRef = collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics/${topicId}/videos`);
            const q = query(videosRef, orderBy('timestamp', 'desc'));
            const querySnapshot = await getDocs(q);

            if(querySnapshot.empty) {
                grid.innerHTML = '<p>No videos found for this topic.</p>'; 
                return;
            }

            grid.innerHTML = '';
            querySnapshot.forEach(videoDoc => {
                const video = videoDoc.data();
                const card = document.createElement('div');
                card.className = 'tutorial-card';
                card.innerHTML = `
                    <div class="tutorial-card-thumbnail">
                        <a href="https://www.youtube.com/watch?v=${video.youtubeId}" target="_blank">
                            <img src="https://img.youtube.com/vi/${video.youtubeId}/mqdefault.jpg" alt="${video.title}" onerror="this.onerror=null; this.src='https://placehold.co/1280x720/30363d/c9d1d9?text=No%20Thumbnail';">
                        </a>
                    </div>
                    <div class="tutorial-card-content">
                        <h3>${video.title}</h3>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        // Helper function to extract YouTube video ID from a URL
        function getYouTubeId(url) {
            let ID = '';
            url = url.replace(/(>|<)/gi,'').split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/);
            if(url[2] !== undefined) {
                ID = url[2].split(/[^0-9a-z_\-]/i);
                ID = ID[0];
            } else {
                ID = url[0]; // If the format is just the ID directly
            }
            return ID;
        }

        // Event listener for the video link input to show thumbnail preview
        document.getElementById('tutorialLink').addEventListener('input', () => {
            const videoId = getYouTubeId(document.getElementById('tutorialLink').value);
            const thumbnailPreview = document.getElementById('tutorialThumbnailPreview');
            if (videoId) {
                thumbnailPreview.src = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
                thumbnailPreview.style.display = 'block';
            } else {
                thumbnailPreview.style.display = 'none';
                thumbnailPreview.src = ''; // Clear src if no valid ID
            }
        });
        
        // --- End of Tutorial Section ---

        // Utility function to upload a file to Firebase Storage
        async function uploadFileToStorage(file, path) {
            if (!file) return null;
            // Create a unique file name using timestamp
            const storageRef = ref(storage, path + '/' + file.name + '-' + Date.now());
            const snapshot = await uploadBytes(storageRef, file); // Upload the file
            return await getDownloadURL(snapshot.ref); // Get the public download URL
        }

        // Processes uploaded file (image or PDF) for Gemini API
        async function processFileForGemini(file, loadingIndicator) {
             if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                return new Promise((resolve, reject) => {
                    reader.onload = () => resolve([{ type: file.type, data: reader.result.split(',')[1] }]);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            } else if (file.type === 'application/pdf') {
                try {
                    const loadingTask = pdfjsLib.getDocument({ url: URL.createObjectURL(file) });
                    const pdf = await loadingTask.promise;
                    const images = [];
                    loadingIndicator.style.display = 'block';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        loadingIndicator.textContent = `Rendering PDF page ${i} of ${pdf.numPages}...`;
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 2 }); // Scale up for better image quality
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        images.push({ type: 'image/png', data: canvas.toDataURL('image/png').split(',')[1] });
                        canvas.remove(); // Remove canvas element after use
                    }
                    loadingIndicator.style.display = 'none';
                    return images;
                } catch (error) {
                    loadingIndicator.style.display = 'none';
                    throw new Error("Failed to render PDF: " + error.message);
                }
            } else {
                throw new Error("Unsupported file type.");
            }
        }

        // Sets up drag-and-drop functionality for file inputs
        function setupDropZone(dropZoneId, fileInputId, fileNameDisplayId, filePreviewId) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            const fileNameDisplay = document.getElementById(fileNameDisplayId);
            const filePreview = document.getElementById(filePreviewId);

            dropZone.addEventListener('click', () => fileInput.click()); // Click drop zone to open file picker
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, e => {e.preventDefault(); e.stopPropagation();}));
            // Highlight drop zone on drag enter/over
            ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.add('highlight')));
            // Remove highlight on drag leave/drop
            ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.remove('highlight')));

            // Handle file drop
            dropZone.addEventListener('drop', e => {
                fileInput.files = e.dataTransfer.files; // Assign dropped files to input
                fileInput.dispatchEvent(new Event('change')); // Trigger change event manually
            });

            // Handle file input change (file selected)
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    fileNameDisplay.textContent = file.name;
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => { filePreview.src = e.target.result; filePreview.style.display = 'block'; };
                        reader.readAsDataURL(file);
                    } else if (file.type === 'application/pdf') { // Handle PDF preview (first page)
                        const loadingTask = pdfjsLib.getDocument({ url: URL.createObjectURL(file) });
                        loadingTask.promise.then(pdf => pdf.getPage(1)).then(page => {
                            const viewport = page.getViewport({ scale: 1.0 });
                            const canvas = document.createElement('canvas');
                            canvas.height = viewport.height; canvas.width = viewport.width;
                            page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise.then(() => {
                                filePreview.src = canvas.toDataURL('image/png');
                                filePreview.style.display = 'block';
                                canvas.remove();
                            });
                        }).catch(error => {
                            console.error("Error rendering PDF preview:", error);
                            fileNameDisplay.textContent = 'Error rendering PDF preview.';
                            filePreview.style.display = 'none';
                        });
                    } else { // Unsupported file type, hide preview
                        filePreview.style.display = 'none';
                    }
                } else {
                    fileNameDisplay.textContent = 'No file chosen';
                    filePreview.style.display = 'none';
                    filePreview.src = ''; // Clear preview source
                }
            });
        }
        setupDropZone('studentDropZone', 'studentAnswerFile', 'studentFileName', 'studentFilePreview');
        setupDropZone('answerKeyDropZone', 'answerKeyFile', 'answerKeyFileName', 'answerKeyFilePreview');
        
        // Loads and displays past grading submissions for the current user
        async function loadPastSubmissions() {
            if (!currentUserId) return;
            const container = document.getElementById('pastSubmissions');
            container.innerHTML = ''; // Clear existing submissions
            const noSubmissionsMsg = document.getElementById('noSubmissions');
            try {
                // Query submissions ordered by timestamp (newest first)
                const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/submissions`), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    noSubmissionsMsg.style.display = 'block'; // Show "No submissions" message
                    return;
                }
                noSubmissionsMsg.style.display = 'none'; // Hide "No submissions" message
                querySnapshot.forEach((doc) => {
                    const submission = doc.data();
                    const card = document.createElement('div');
                    card.className = 'submission-card';
                    card.innerHTML = `<h3 class="font-semibold text-lg mb-2">Submission on ${new Date(submission.timestamp).toLocaleString()}</h3>
                                      <p><strong>Grade:</strong> ${submission.geminiGrade.substring(0, 200)}...</p>`; // Display truncated grade
                    container.appendChild(card);
                });
            } catch (error) {
                console.error("Error loading past submissions:", error);
                // Inform user about error loading submissions
                showModal('Error Loading Submissions', `Could not load past submissions: ${error.message}`);
            }
        }

        // Event listener for the "Grade Work" button
        document.getElementById('gradeButton').addEventListener('click', async () => {
            if (!currentUserId) { showModal('Authentication Required', 'Please sign in to grade work.'); return; }

            const studentAnswerText = document.getElementById('studentAnswer').value.trim();
            const answerKeyText = document.getElementById('answerKey').value.trim();
            const studentFile = document.getElementById('studentAnswerFile').files[0];
            const answerKeyFile = document.getElementById('answerKeyFile').files[0];

            // Validate that either text or a file is provided for both student work and answer key
            if ((!studentAnswerText && !studentFile) || (!answerKeyText && !answerKeyFile)) {
                showModal('Input Missing', "Please provide either text or upload a file for both the student's work and the answer key.");
                return;
            }

            const loadingIndicator = document.getElementById('gradingLoadingIndicator');
            loadingIndicator.style.display = 'block';
            loadingIndicator.textContent = 'Starting grading process...';
            document.getElementById('gradeButton').disabled = true; // Disable button during processing

            try {
                // Prepare input for Gemini: prioritize text, then process files
                let studentInputForGemini = studentAnswerText ? [{ text: studentAnswerText }] : await processFileForGemini(studentFile, loadingIndicator);
                let answerKeyInputForGemini = answerKeyText ? [{ text: answerKeyText }] : await processFileForGemini(answerKeyFile, loadingIndicator);
                
                // Upload files to Firebase Storage if they exist
                let studentFileUrl = studentFile ? await uploadFileToStorage(studentFile, `artifacts/${appId}/users/${currentUserId}/submissions_files`) : null;
                let answerKeyFileUrl = answerKeyFile ? await uploadFileToStorage(answerKeyFile, `artifacts/${appId}/users/${currentUserId}/submissions_files`) : null;
                
                loadingIndicator.textContent = 'Sending to Gemini for grading...';
                
                // Construct the prompt for Gemini
                let prompt = `You are an expert exam grader. Compare the student's work with the answer key. Provide a clear grade and constructive feedback.\n\n[STUDENT WORK]:\n`;
                studentInputForGemini.forEach(p => prompt += p.text || '[IMAGE/PDF CONTENT]'); // Indicate if content is from image/PDF
                prompt += `\n\n[ANSWER KEY]:\n`;
                answerKeyInputForGemini.forEach(p => prompt += p.text || '[IMAGE/PDF CONTENT]');

                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                // Make API call to Gemini proxy
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody}`);
                }

                const result = await response.json();
                const geminiGrade = result.candidates[0].content.parts[0].text;
                document.getElementById('gradeResult').textContent = geminiGrade; // Display grade

                // Save submission details to Firestore
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/submissions`), {
                    studentAnswerText, 
                    answerKeyText, 
                    geminiGrade, 
                    studentAnswerFileUrls: studentFileUrl ? [studentFileUrl] : [], // Store URLs as an array
                    answerKeyFileUrls: answerKeyFileUrl ? [answerKeyFileUrl] : [], 
                    timestamp: Date.now()
                });

                showModal('Grading Complete', 'The work has been graded and saved.');
                await loadPastSubmissions(); // Reload past submissions list

            } catch (error) {
                console.error("Grading Error:", error);
                showModal('Grading Error', `An error occurred during grading: ${error.message}`);
            } finally {
                loadingIndicator.style.display = 'none'; // Hide loading indicator
                document.getElementById('gradeButton').disabled = false; // Re-enable button
            }
        });

        // Chat Logic: Event listeners for sending messages
        const sendChatButton = document.getElementById('sendChatButton');
        const chatInput = document.getElementById('chatInput');
        sendChatButton.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent new line in input if it's a textarea
                handleSendMessage(); 
            } 
        });

        // Handles sending a chat message to Gemini
        async function handleSendMessage() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return; // Don't send empty messages
            appendChatMessage(userMessage, 'user'); // Append user message to chat display
            chatInput.value = ''; // Clear input field
            document.getElementById('chatLoadingIndicator').style.display = 'block'; // Show loading indicator

            try {
                geminiChatHistory.push({ role: "user", parts: [{ text: userMessage }] }); // Add user message to history
                const payload = { contents: geminiChatHistory };
                // Make API call to Gemini proxy
                const response = await fetch(CLOUDFLARE_WORKER_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody}`);
                }
                const result = await response.json();
                const geminiResponseText = result.candidates[0].content.parts[0].text;
                appendChatMessage(geminiResponseText, 'gemini'); // Append Gemini's response
                geminiChatHistory.push({ role: "model", parts: [{ text: geminiResponseText }] }); // Add Gemini's response to history
            } catch (error) {
                console.error("Chat Error:", error);
                appendChatMessage(`Error: ${error.message}`, 'gemini'); // Display error in chat
            } finally {
                document.getElementById('chatLoadingIndicator').style.display = 'none'; // Hide loading indicator
            }
        }

        // Appends a new message to the chat display
        function appendChatMessage(text, sender) {
            const display = document.getElementById('chatDisplay');
            const msgEl = document.createElement('div');
            msgEl.className = `chat-message ${sender}`;
            msgEl.textContent = text;
            display.appendChild(msgEl);
            display.scrollTop = display.scrollHeight; // Scroll to bottom of chat
        }
        
        // Student Management: Event listener for adding a student
        const addStudentButton = document.getElementById('addStudentButton');
        addStudentButton.addEventListener('click', async () => {
             if (currentUserRole !== 'teacher') { showModal('Access Denied', 'Only teachers can add students.'); return; }
             const email = document.getElementById('studentEmailInput').value.trim().toLowerCase();
             if (!email) { showModal('Input Error', 'Please enter a student email address.'); return; }

             document.getElementById('studentManagementLoading').style.display = 'block';
             try {
                // Reference to the collection storing authorized student emails
                const authorizedStudentsCollectionRef = collection(db, `artifacts/${appId}/authorized_users/auth_data/student_emails`);
                // Check if email already exists
                const q = query(authorizedStudentsCollectionRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);
                if(!querySnapshot.empty) {
                    showModal('Student Exists', `${email} is already authorized.`);
                } else {
                    // Add new authorized student email
                    await addDoc(authorizedStudentsCollectionRef, { email, addedBy: currentUserId, timestamp: Date.now() });
                    showModal('Success', `${email} has been authorized.`);
                    document.getElementById('studentEmailInput').value = ''; // Clear input
                    loadAuthorizedStudents(); // Reload list of authorized students
                }
             } catch(e) {
                console.error("Error adding student:", e);
                showModal('Error', `Could not add student: ${e.message}`);
             } finally {
                document.getElementById('studentManagementLoading').style.display = 'none';
             }
        });

        // Loads and displays authorized students for teachers
        async function loadAuthorizedStudents() {
            if(currentUserRole !== 'teacher') return;
            const list = document.getElementById('authorizedStudentsList');
            list.innerHTML = ''; // Clear existing list
            const noStudentsMsg = document.getElementById('noAuthorizedStudents');
            try {
                // Query authorized student emails ordered by timestamp
                const q = query(collection(db, `artifacts/${appId}/authorized_users/auth_data/student_emails`), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                if(querySnapshot.empty) { noStudentsMsg.style.display = 'block'; return; }
                
                noStudentsMsg.style.display = 'none';
                querySnapshot.forEach(docSnap => {
                    const student = docSnap.data();
                    const item = document.createElement('div');
                    item.className = 'student-item';
                    item.innerHTML = `<span>${student.email}</span><button class="delete-student-btn" data-id="${docSnap.id}">❌</button>`;
                    list.appendChild(item);
                });
                // Attach event listeners to delete buttons
                document.querySelectorAll('.delete-student-btn').forEach(btn => btn.addEventListener('click', deleteStudent));
            } catch(e) { 
                console.error("Error loading students:", e); 
                showModal('Error Loading Students', `Could not load authorized students: ${e.message}`);
            }
        }

        // Handles deletion of an authorized student
        async function deleteStudent(e) {
            const studentId = e.currentTarget.dataset.id;
            // Confirmation modal before deletion
            showModal('Confirm Deletion', 'Are you sure you want to remove this student from the authorized list?', [
                { text: 'Delete', className: 'btn-primary', onClick: async () => {
                    try {
                        // Delete student document from Firestore
                        await deleteDoc(doc(db, `artifacts/${appId}/authorized_users/auth_data/student_emails`, studentId));
                        showModal('Success', 'Student removed successfully.');
                        loadAuthorizedStudents(); // Reload list
                    } catch(err) {
                        console.error("Error removing student:", err);
                        showModal('Error', `Could not remove student: ${err.message}`);
                    }
                }},
                { text: 'Cancel', className: 'logout-btn' }
            ]);
        }
        
        // --- Modal Functionality ---
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalButtons = document.getElementById('modalButtons');

        // Displays a general-purpose modal with a title, message, and optional custom buttons
        function showModal(title, message, buttons = []) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // Use innerHTML to allow for custom content (e.g., error details)
            modalButtons.innerHTML = ''; // Clear previous buttons

            if (buttons.length === 0) {
                 // If no custom buttons are provided, add a default 'OK' button
                 const okButton = document.createElement('button');
                 okButton.textContent = 'OK';
                 okButton.className = 'btn-primary';
                 okButton.onclick = () => { messageModal.style.display = 'none'; }; // Close modal on OK
                 modalButtons.appendChild(okButton);
            } else {
                 buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.textContent = btnConfig.text;
                    button.className = btnConfig.className;
                    button.onclick = () => { 
                        messageModal.style.display = 'none'; // Close modal
                        if (btnConfig.onClick) btnConfig.onClick(); // Execute custom click handler if provided
                    };
                    modalButtons.appendChild(button);
                });
            }
            messageModal.style.display = 'flex'; // Display the modal
        }
        
        // Displays a modal with a single input field, label, and save/cancel buttons
        function showInputModal(title, label, callback) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = `
                <label for="modalInput" style="display:block; margin-bottom:8px;">${label}</label>
                <input type="text" id="modalInput" style="width: 100%;" required>`;
            modalButtons.innerHTML = ''; 

            const modalInput = document.getElementById('modalInput');
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.className = 'btn-primary';
            saveButton.onclick = () => {
                const value = modalInput.value.trim(); // Trim input value
                if (value) { // Ensure input is not empty after trimming
                    messageModal.style.display = 'none';
                    callback(value); // Execute callback with the input value
                } else {
                    // Optionally show a visual cue or a small error message in the modal
                    modalInput.style.border = '1px solid var(--red)'; // Highlight input in red
                    modalInput.focus(); // Keep focus on the input
                }
            };
            modalButtons.appendChild(saveButton);

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.className = 'logout-btn';
            cancelButton.onclick = () => { messageModal.style.display = 'none'; }; // Close modal on cancel
            modalButtons.appendChild(cancelButton);

            messageModal.style.display = 'flex'; // Display the modal
            modalInput.focus(); // Focus on the input field

            // Add 'Enter' key listener to trigger save
            modalInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevent default form submission if any
                    saveButton.click(); // Programmatically click the save button
                }
            });
        }

        // Add event listeners to all close buttons on modals (universal close functionality)
        document.querySelectorAll('.modal .close-button').forEach(btn => {
            btn.onclick = () => {
                btn.closest('.modal').style.display = 'none';
            };
        });
    </script>
</body>
</html>
