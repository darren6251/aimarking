<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Marker</title>
    <!-- PDF.js library for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- Custom styles -->
    <style>
        /* Base Dark Theme Variables */
        :root {
            --bg-primary: #0d1117; /* Black */
            --bg-secondary: #161b22; /* Dark Gray */
            --text-primary: #c9d1d9; /* Light Gray */
            --text-secondary: #8b949e; /* Muted gray for secondary text */
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --border-color: #30363d;
            --button-hover-darken: #21262d;
            --button-primary-lighten: #2ea043; /* Green hover */
            --button-blue-lighten: #4c9aff; /* Blue hover */
            --button-red-lighten: rgba(248, 81, 73, 0.1); /* Red hover */
            --neon-glow-color: #58a6ff; /* Neon blue for dark theme */

            /* Finder Window Specific Variables (Dark Theme) */
            --finder-bg-primary: #1e232a;
            --finder-bg-secondary: #161b22;
            --finder-text-primary: #c9d1d9;
            --finder-text-secondary: #8b949e;
            --finder-border-color: #30363d;
            --finder-titlebar-bg: #2a3038;
            --finder-hover-bg: #2c333c;
            --finder-active-bg: var(--accent-blue);
            --finder-active-text: #ffffff;
        }

        /* Light Theme Variables - Overrides for .light-theme class */
        body.light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f2f5;
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent-blue: #007bff;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --border-color: #cccccc;
            --button-hover-darken: #e2e6ea;
            --button-primary-lighten: #218838;
            --button-blue-lighten: #0069d9;
            --button-red-lighten: rgba(220, 53, 69, 0.1);
            --neon-glow-color: #007bff; /* Neon blue for light theme */

            /* Finder Window Specific Variables (Light Theme) */
            --finder-bg-primary: #ffffff;
            --finder-bg-secondary: #f7f7f7;
            --finder-text-primary: #333333;
            --finder-text-secondary: #666666;
            --finder-border-color: #cccccc;
            --finder-titlebar-bg: #e8e8e8;
            --finder-hover-bg: #e0e0e0;
            --finder-active-bg: var(--accent-blue);
            --finder-active-text: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", sans-serif;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            overflow-x: hidden;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        button,
        input,
        textarea,
        select {
            transition: all .2s ease-out;
            font-family: inherit;
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        /* Keyframe animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* LOGIN PAGE: Full screen wrapper */
        #authWrapper {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1001;
        }

        .login-left-panel,
        .login-right-panel {
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .login-left-panel {
            background: var(--bg-primary);
            color: var(--text-primary);
            flex-direction: column;
            text-align: center;
        }

        .login-left-panel h1 {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 1rem;
        }

        .login-left-panel p {
            font-size: 1.75rem;
            font-weight: 400;
            line-height: 1.3;
            margin-bottom: .5rem;
            color: var(--text-secondary);
        }

        .login-right-panel {
            background: var(--bg-secondary);
            flex-direction: column;
        }
        
        #authContainer {
            width: 100%;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            background-color: var(--bg-primary);
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #authContainer h2 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: .75rem;
            cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        .google-btn:hover { background-color: var(--button-hover-darken); border-color: var(--text-secondary); }
        .google-btn img { height: 20px; }
        
        #accessCodeInput {
             background-color: var(--bg-secondary);
             border: 1px solid var(--border-color);
             color: var(--text-primary);
             padding: 12px;
             border-radius: 6px;
             width: 100%;
             margin-bottom: 1rem;
             text-align: center;
        }
        #accessCodeInput:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
        }

        .btn-primary {
             background-color: var(--accent-green);
             color: #fff;
             padding: .75rem 1.5rem;
             border-radius: 6px;
             border: none;
             cursor: pointer;
             font-weight: 600;
        }
        .btn-primary:hover {
             background-color: var(--button-primary-lighten);
             transform: translateY(-1px);
        }
        
        #appSection {
            display: none;
            flex-direction: column;
            height: 100vh;
            background-color: var(--bg-primary);
            animation: fadeIn .6s ease-out both;
        }
        
        header {
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            padding: 0 24px;
            height: 64px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            z-index: 999;
        }
        
        .logo-container { display: flex; align-items: center; gap: 1rem; }
        .logo-container h1 { font-size: 1.5rem; font-weight: 700; }
        .logo-container p { font-weight: 400; color: var(--text-secondary); }
        
        .header-actions { margin-left: auto; display: flex; align-items: center; gap: 1rem; }

        /* --- START: NEON BUTTON STYLES --- */
        .header-actions .tab.neon-button {
            position: relative;
            display: inline-block;
            padding: 10px 18px; /* Adjusted padding */
            color: var(--neon-glow-color);
            text-decoration: none;
            overflow: hidden;
            transition: .5s;
            border: 1px solid var(--neon-glow-color);
            border-radius: 6px;
            background: transparent;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.875rem; /* Adjusted font size */
        }
        
        .header-actions .tab.neon-button:hover,
        .header-actions .tab.neon-button.active {
            background: var(--neon-glow-color);
            color: var(--bg-secondary);
            border-radius: 66px;
            box-shadow: 0 0 5px var(--neon-glow-color),
                        0 0 25px var(--neon-glow-color),
                        0 0 50px var(--neon-glow-color),
                        0 0 100px var(--neon-glow-color);
        }

        .header-actions .tab.neon-button span {
            position: absolute;
            display: block;
        }

        .header-actions .tab.neon-button span:nth-child(1) {
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--neon-glow-color));
            animation: btn-anim1 1.5s linear infinite;
        }

        @keyframes btn-anim1 {
            0% { left: -100%; }
            50%,100% { left: 100%; }
        }

        .header-actions .tab.neon-button span:nth-child(2) {
            top: -100%;
            right: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, transparent, var(--neon-glow-color));
            animation: btn-anim2 1.5s linear infinite;
            animation-delay: .375s
        }

        @keyframes btn-anim2 {
            0% { top: -100%; }
            50%,100% { top: 100%; }
        }

        .header-actions .tab.neon-button span:nth-child(3) {
            bottom: 0;
            right: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(270deg, transparent, var(--neon-glow-color));
            animation: btn-anim3 1.5s linear infinite;
            animation-delay: .75s
        }

        @keyframes btn-anim3 {
            0% { right: -100%; }
            50%,100% { right: 100%; }
        }

        .header-actions .tab.neon-button span:nth-child(4) {
            bottom: -100%;
            left: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(360deg, transparent, var(--neon-glow-color));
            animation: btn-anim4 1.5s linear infinite;
            animation-delay: 1.125s
        }

        @keyframes btn-anim4 {
            0% { bottom: -100%; }
            50%,100% { bottom: 100%; }
        }
        /* --- END: NEON BUTTON STYLES --- */


        .user-info { display: flex; align-items: center; gap: 1rem; }
        #userDisplayName { font-weight: 500; cursor: pointer; }
        .logout-btn { background: none; border: 1px solid var(--accent-red); color: var(--accent-red); cursor: pointer; padding: 6px 12px; border-radius: 6px; font-weight: 600; }
        .logout-btn:hover { background: var(--button-red-lighten); }
        /* Style for Switch Role button */
        #switchRoleButton {
            background-color: var(--accent-blue);
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        #switchRoleButton:hover {
            background-color: var(--button-blue-lighten);
        }

        /* --- START: DROPDOWN STYLES --- */
        .dropdown-menu {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-menu-content {
            display: none;
            position: absolute;
            top: calc(100% + 10px); 
            left: 0;
            background-color: var(--bg-secondary);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
            z-index: 10;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding: 4px;
        }

        .dropdown-menu-content button {
            color: var(--text-primary);
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .dropdown-menu-content button:hover {
            background-color: var(--button-hover-darken);
            color: var(--accent-blue);
        }

        .dropdown-menu:hover .dropdown-menu-content {
            display: block;
        }
        /* --- END: DROPDOWN STYLES --- */


        main {
            flex: 1;
            display: flex;
            overflow-y: auto;
            padding: 24px;
            gap: 24px;
        }
        
        /* Content Sections */
        #homeSection, #gradingSection, #chatSection, #studentManagementSection, #profileSection, #tutorialSection, #pastPapersSection, #exerciseSection {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            width: 100%;
        }
        #profileSection { max-width: 800px; margin: 0 auto; }

        /* Form elements */
        label { display: block; font-weight: 600; margin-bottom: 8px; }
        input[type="text"], input[type="number"], input[type="email"], select, input[type="url"] {
            width: 100%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 12px; border-radius: 6px; margin-bottom: 1rem;
        }
        textarea {
            width: 100%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 12px; border-radius: 6px; margin-bottom: 1rem; resize: vertical; min-height: 120px;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3); }
        
        .drop-zone { border: 2px dashed var(--border-color); border-radius: 6px; min-height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 1rem; margin-bottom: 1.5rem; cursor: pointer; word-wrap: break-word; padding: 1rem; text-align: center; }
        .drop-zone.highlight { border-color: var(--accent-blue); background: rgba(88, 166, 255, .1); }
        
        .file-preview { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; max-height: 200px; object-fit: contain; }
        .error-message { color: var(--accent-red); font-size: 0.875rem; margin-top: -0.5rem; margin-bottom: 1rem; }

        #gradeButton { background-color: var(--accent-green); color: #fff; }
        #gradeButton:hover { background-color: var(--button-primary-lighten); }

        #resultContainer { margin-top: 1.5rem; padding: 1rem; border-radius: 6px; background-color: var(--bg-secondary); border: 1px solid var(--border-color); min-height: 100px; white-space: pre-wrap; }
        #pastSubmissions { margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .submission-card { background-color: var(--bg-secondary); padding: 1rem; border-radius: 6px; border: 1px solid var(--border-color); }

        /* Chat styles */
        #chatSection, #studentManagementSection { display: none; flex-direction: column; gap: 1rem; height: calc(100vh - 64px - 48px); }
        #chatDisplay { flex: 1; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { max-width: 85%; padding: 10px 14px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; }
        .chat-message.user { background-color: var(--accent-blue); color: var(--bg-primary); align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-message.gemini { background-color: var(--button-hover-darken); align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-input-wrapper { display: flex; gap: .5rem; flex-shrink: 0; }
        #chatInput { flex: 1; padding: .75rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-secondary); color: var(--text-primary); }
        #sendChatButton { padding: .5rem 1rem; border: none; background: var(--accent-blue); color: var(--bg-primary); border-radius: 6px; font-weight: 600; cursor: pointer; }
        #sendChatButton:hover { background-color: var(--button-blue-lighten); }
        
        .loading-indicator { text-align: center; padding: 1rem; color: var(--text-secondary); }

        /* Universal Section Title */
        .section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }

        /* Form container */
        .form-container { max-width: 600px; margin-bottom: 2rem; background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color); }
        
        /* Student Management Styles */
        #authorizedStudentsList { display: flex; flex-direction: column; gap: 0.5rem; }
        .student-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-secondary); padding: 0.75rem 1rem; border-radius: 6px; border: 1px solid var(--border-color); }
        .delete-student-btn { background: none; border: none; color: var(--accent-red); cursor: pointer; padding: 4px; }
        .delete-student-btn:hover { background-color: var(--button-red-lighten); border-radius: 50%; }

        /* Universal Filter Styles */
        .filters-container { display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap; }
        
        /* Universal Grid Styles */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        
        /* Card Styles (for Tutorials, Papers, Exercises) */
        .material-card { background-color: var(--bg-secondary); border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); display: flex; flex-direction: column; position:relative; text-decoration: none; color: var(--text-primary); }
        .material-card-thumbnail { position: relative; cursor: pointer; }
        .material-card-thumbnail img { width: 100%; display: block; aspect-ratio: 16/9; object-fit: cover; }
        .material-card-content { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; }
        .material-card-content h3 { font-size: 1.1rem; margin-bottom: 0.5rem; }
        
        /* Teacher Content Management Styles (Tutorials, Papers, Exercises) */
        .content-item { 
            padding: 1rem; 
            border: 1px solid var(--border-color); 
            border-radius: 6px; 
            margin-bottom: 1rem; 
            background: var(--bg-primary); 
            transition: background-color 0.2s ease-in-out;
        }
        .content-item.drag-over {
            background-color: rgba(88, 166, 255, 0.2);
            border-color: var(--accent-blue);
        }

        .content-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            padding: 0.5rem 0;
        }
        .content-header h3, .content-header h4 { margin: 0; }
        .item-actions button { margin-left: 0.5rem; padding: 4px 8px; font-size: 0.8rem; }
        
        .nested-container { 
            padding-left: 1.5rem; 
            margin-top: 0.5rem;
            border-left: 2px solid var(--border-color); 
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 0;
        }
        .nested-container.expanded {
            max-height: 1000px;
        }

        .sub-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0.5rem; 
            border-radius: 4px; 
            cursor: grab;
        }
        .sub-item:hover { background-color: var(--button-hover-darken); }
        .sub-item a { color: var(--accent-blue); text-decoration: none; }
        .sub-item a:hover { text-decoration: underline; }

        .collapse-arrow {
            margin-left: 10px;
            transition: transform 0.3s ease-out;
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid var(--text-secondary);
        }
        .content-header[aria-expanded="true"] .collapse-arrow {
            transform: rotate(90deg);
        }
        .content-header[aria-expanded="false"] .collapse-arrow {
            transform: rotate(0deg);
        }

        /* Video Embedding Styles */
        .video-embed-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            border-radius: 8px 8px 0 0;
        }
        .video-embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .play-button-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            transition: all 0.2s ease;
        }
        .material-card-thumbnail:hover .play-button-overlay {
            color: #fff;
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* --- E-COMMERCE STYLES --- */
        .store-layout { display: flex; gap: 24px; width: 100%; }
        .product-grid { flex-grow: 1; }
        .shopping-cart { width: 320px; flex-shrink: 0; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; height: fit-content; }
        .shopping-cart h3 { font-size: 1.25rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        #cart-items { display: flex; flex-direction: column; gap: 0.75rem; max-height: 300px; overflow-y: auto; margin-bottom: 1rem; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; }
        .cart-item-name { flex-grow: 1; margin-right: 1rem; }
        .cart-item-price { font-weight: 600; color: var(--accent-green); }
        .remove-from-cart-btn { background: none; border: none; color: var(--accent-red); cursor: pointer; font-size: 1rem; margin-left: 0.5rem; }
        #cart-summary { border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem; }
        .summary-line { display: flex; justify-content: space-between; font-weight: 600; margin-bottom: 0.5rem; }
        #cart-validation-message { font-size: 0.875rem; color: var(--accent-red); text-align: center; margin-top: 1rem; min-height: 20px; }
        #checkout-btn { width: 100%; margin-top: 1rem; }
        .product-card { background-color: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color); padding: 1rem; display: flex; flex-direction: column; justify-content: space-between; }
        .product-card h4 { font-size: 1.1rem; margin-bottom: 0.5rem; }
        .product-price { font-size: 1.25rem; font-weight: 700; color: var(--accent-green); margin-bottom: 1rem; }
        .add-to-cart-btn, .download-btn { width: 100%; }
        .download-btn { background-color: var(--accent-blue); }
        .download-btn:hover { background-color: var(--button-blue-lighten); }

        /* Promo code styles */
        .promo-code-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .promo-input-group { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
        .promo-input-group input { flex-grow: 1; margin-bottom: 0; }
        .promo-input-group button { flex-shrink: 0; padding: 8px 12px; font-size: 0.875rem; }
        .promo-display { font-size: 0.875rem; color: var(--accent-green); display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
        .promo-display .remove-promo-btn { color: var(--accent-red); background: none; border: none; cursor: pointer; font-size: 0.875rem; margin-left: 0.5rem; }
        .promo-display .remove-promo-btn:hover { text-decoration: underline; }
        .promo-error { color: var(--accent-red); font-size: 0.875rem; margin-top: 0.5rem; }
        .promo-code-list { margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem; }
        .promo-code-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px dashed var(--border-color); font-size: 0.9rem; }
        .promo-code-item:last-child { border-bottom: none; }
        .promo-code-item span:first-child { font-weight: 600; }
        .promo-code-item .actions button { margin-left: 0.5rem; padding: 4px 8px; font-size: 0.75rem; }

        /* Teacher Purchase History Styles */
        .purchase-history-section { margin-top: 2rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color); }
        .purchase-history-section h3 { font-size: 1.25rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .student-purchase-entry { margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color); }
        .student-purchase-entry strong { display: block; margin-bottom: 0.5rem; color: var(--accent-blue); }
        .purchased-item-detail { font-size: 0.9rem; margin-left: 1rem; color: var(--text-secondary); }

        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; animation: fadeIn 0.3s ease-out; }
        .modal-content { background-color: var(--bg-secondary); padding: 30px; border-radius: 8px; border: 1px solid var(--border-color); max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; animation: slideInUp 0.3s ease-out; }
        #modalTitle { margin-bottom: 1rem; font-size: 1.5rem; font-weight: 600; }
        #modalMessage { line-height: 1.5; }
        .close-button { position: absolute; top: 10px; right: 15px; font-size: 28px; cursor: pointer; color: var(--text-secondary); }
        .close-button:hover { color: var(--text-primary); }
        #modalButtons { display:flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }

        /* Video Preview Modal Specific Styles */
        #videoPreviewModal .modal-content { max-width: 900px; width: 95%; padding: 15px; }
        #videoPreviewModal iframe { width: 100%; height: 500px; border-radius: 8px; }
        @media (max-width: 768px) { #videoPreviewModal iframe { height: 300px; } }

        /* Footer */
        footer { position: fixed; bottom: 0; right: 0; text-align: right; padding: 10px 20px; color: var(--text-secondary); font-size: 0.875rem; z-index: 100; pointer-events: none; }
        footer a { color: var(--accent-blue); text-decoration: none; pointer-events: all;}
        footer a:hover { text-decoration: underline; }

        /* --- START: FINDER WINDOW STYLES --- */
        #finderMaterialsSection {
            display: none; /* Hidden by default, shown via JS */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90vw;
            height: 85vh;
            max-width: 1200px;
            max-height: 800px;
            border: 1px solid var(--finder-border-color);
            border-radius: 10px;
            background: var(--finder-bg-primary);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 900;
            resize: both;
            min-width: 400px;
            min-height: 300px;
            color: var(--finder-text-primary);
        }

        #finderMaterialsSection.fullscreen {
            top: 0 !important;
            left: 0 !important;
            transform: none !important;
            width: 100vw !important;
            height: 100vh !important;
            max-width: none !important;
            max-height: none !important;
            border-radius: 0 !important;
            resize: none;
        }

        .finder-titlebar {
            background: var(--finder-titlebar-bg);
            height: 32px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            cursor: grab;
            flex-shrink: 0;
            border-bottom: 1px solid var(--finder-border-color);
            justify-content: flex-start;
        }
        .finder-titlebar:active { cursor: grabbing; }

        .finder-titlebar .buttons { display: flex; gap: 8px; }
        .finder-circle { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); cursor: pointer; }
        .finder-circle.close { background: #ff5f57; }
        .finder-circle.min { background: #ffbd2e; }
        .finder-circle.max { background: #28c840; }
        .finder-window-title { margin-left: 10px; font-weight: 500; font-size: 13px; color: var(--finder-text-secondary); }

        .finder-content { flex: 1; display: flex; overflow: hidden; }
        .finder-sidebar {
            width: 220px;
            min-width: 160px;
            border-right: 1px solid var(--finder-border-color);
            background: var(--finder-bg-secondary);
            padding: 10px 0;
            overflow-y: auto;
            flex-shrink: 0;
            resize: horizontal;
        }
        .finder-sidebar-header { padding: 0 15px 10px; font-size: 11px; font-weight: 600; color: var(--finder-text-secondary); text-transform: uppercase; }
        .finder-sidebar-item {
            padding: 8px 15px;
            font-size: 14px;
            color: var(--finder-text-primary);
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-radius: 4px;
            margin: 0 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .finder-sidebar-item:hover { background: var(--finder-hover-bg); }
        .finder-sidebar-item.active { background: var(--finder-active-bg); color: var(--finder-active-text); }
        .finder-sidebar-item::before {
            content: '📁'; /* Default icon */
        }

        .finder-main-view { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .finder-header { padding: 8px 12px; border-bottom: 1px solid var(--finder-border-color); flex-shrink: 0; }
        .finder-breadcrumbs { font-size: 14px; color: var(--finder-text-secondary); }
        .finder-breadcrumbs span { cursor: pointer; }
        .finder-breadcrumbs span:hover { color: var(--accent-blue); }
        .finder-breadcrumbs span:not(:last-child)::after { content: '›'; margin: 0 8px; }

        .finder-file-list { flex: 1; overflow-y: auto; background: var(--finder-bg-primary); }
        .finder-file-list .columns, .finder-file-list .row {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr;
            padding: 8px 15px;
            border-bottom: 1px solid var(--finder-border-color);
            align-items: center;
            font-size: 13px;
        }
        .finder-file-list .columns { 
            background: var(--finder-bg-secondary);
            color: var(--finder-text-secondary);
            font-weight: 500;
            position: sticky;
            top: 0;
        }
        .finder-file-list .row { color: var(--finder-text-primary); cursor: pointer; }
        .finder-file-list .row:hover { background: var(--finder-hover-bg); }
        .finder-file-list .row.active { background: var(--finder-active-bg); color: var(--finder-active-text); }
        .finder-file-list .row .file-name { display: flex; align-items: center; gap: 8px; }
        .finder-file-list .row.folder .file-name::before { content: '📁'; }
        .finder-file-list .row.file .file-name::before { content: '📄'; }
        .finder-file-list .row.video .file-name::before { content: '🎬'; }
        .finder-file-list .row.exercise .file-name::before { content: '📝'; }
        .finder-file-list .row.purchased { color: var(--accent-green); }

        .finder-footer {
            text-align: right;
            font-size: 11px;
            color: var(--finder-text-secondary);
            padding: 5px 10px;
            border-top: 1px solid var(--finder-border-color);
            background: var(--finder-bg-secondary);
            flex-shrink: 0;
        }
        /* --- END: FINDER WINDOW STYLES --- */

        /* --- START: MINIMIZED DOCK/BAR STYLES --- */
        #minimizedWindowsBar {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            height: 50px;
            background-color: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 1000;
            transition: all 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        body.light-theme #minimizedWindowsBar {
            background-color: rgba(240, 240, 240, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        #minimizedWindowsBar.active { opacity: 1; pointer-events: all; }

        .minimized-tab {
            background-color: var(--accent-blue);
            color: #fff;
            padding: 6px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            position: relative;
        }
        .minimized-tab:hover {
            background-color: var(--button-blue-lighten);
            transform: translateY(-4px);
        }
        .minimized-tab .close-tab-btn {
            background: rgba(0,0,0,0.2);
            border: none;
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 50%;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .minimized-tab:hover .close-tab-btn { opacity: 1; }
        .minimized-tab .close-tab-btn:hover { background: rgba(0,0,0,0.4); }
        /* --- END: MINIMIZED DOCK/BAR STYLES --- */

        /* --- START: MINIMIZE/RESTORE ANIMATIONS --- */
        @keyframes minimizeAnimation {
            from {
                transform: translate(var(--start-x), var(--start-y)) scale(1);
                opacity: 1;
            }
            to {
                transform: translate(var(--target-x), var(--target-y)) scale(0.1);
                opacity: 0;
            }
        }
        @keyframes restoreAnimation {
            from {
                transform: translate(var(--start-x), var(--start-y)) scale(0.1);
                opacity: 0;
            }
            to {
                transform: translate(var(--target-x), var(--target-y)) scale(1);
                opacity: 1;
            }
        }
        #finderMaterialsSection.minimizing {
            animation: minimizeAnimation 0.4s cubic-bezier(0.4, 0, 1, 1) forwards;
        }
        #finderMaterialsSection.restoring {
            animation: restoreAnimation 0.4s cubic-bezier(0, 0, 0.2, 1) forwards;
        }
        /* --- END: MINIMIZE/RESTORE ANIMATIONS --- */

        /* Utility classes */
        .hidden-on-desktop { display: none !important; }

        /* Mobile responsiveness */
        @media (max-width: 992px) {
            .store-layout { flex-direction: column; }
            .shopping-cart { width: 100%; position: sticky; bottom: 0; border-radius: 8px 8px 0 0; }
        }
        @media (max-width: 768px) {
            #authWrapper { flex-direction: column; position: static; height: auto; }
            .login-left-panel, .login-right-panel { width: 100%; }
            header { flex-direction: column; height: auto; padding: 1rem; align-items: flex-start; }
            .header-actions { margin-left: 0; margin-top: 1rem; flex-wrap: wrap; }
            main { flex-direction: column; }
            .hero { flex-direction: column-reverse; text-align: center; }
            .hero-text, .hero-image { max-width: 100%; }
            .buttons { justify-content: center; }

            /* Hide finder view and toggle on mobile */
            #finderMaterialsSection { display: none !important; }
            .material-view-toggle { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="authWrapper" style="display: none;">
        <div class="login-left-panel">
            <h1>Let AI mark your work.</h1>
            <p>Let AI assist you, not replace you</p>
            <p>Mark with AI, learn better</p>
        </div>
        <div class="login-right-panel">
            <div id="authContainer">
                 <!-- JS will inject googleSignInTemplate or codeEntryTemplate -->
            </div>
        </div>
    </div>

    <div id="appSection" style="display: none;">
        <header>
            <div class="logo-container">
                <h1>AI Marker</h1>
                <p>Operated by Darren Ng</p>
            </div>
            <div class="header-actions">
                <button id="toggleHomeButton" class="tab neon-button active">
                    <span></span><span></span><span></span><span></span>
                    Home
                </button>
                
                <div class="dropdown-menu">
                    <button class="tab neon-button" id="workWithAIButton">
                        <span></span><span></span><span></span><span></span>
                        Work with AI
                    </button>
                    <div class="dropdown-menu-content">
                        <button id="toggleGradingButton" class="tab">Exam Grader</button>
                        <button id="toggleChatButton" class="tab">Chat with Gemini</button>
                    </div>
                </div>

                <div class="dropdown-menu">
                    <button class="tab neon-button" id="materialsButton">
                        <span></span><span></span><span></span><span></span>
                        Materials
                    </button>
                    <div class="dropdown-menu-content">
                        <button id="toggleTutorialButton" class="tab">Tutorial Videos</button>
                        <button id="togglePastPapersButton" class="tab">Past Papers</button>
                        <button id="toggleExercisesButton" class="tab">Exercises for Sale</button>
                    </div>
                </div>

                <button id="manageStudentsButton" class="tab neon-button" style="display: none;">
                    <span></span><span></span><span></span><span></span>
                    Manage Students
                </button>
                <button id="toggleProfileButton" class="tab neon-button">
                    <span></span><span></span><span></span><span></span>
                    Profile
                </button>
                <button id="themeToggleButton" class="tab neon-button">
                    <span></span><span></span><span></span><span></span>
                    Theme
                </button>
                <div class="user-info">
                     <span id="userDisplayName"></span>
                     <button id="switchRoleButton" class="btn-primary">Switch Role</button>
                     <button id="logoutButton" class="logout-btn">Log Out</button>
                </div>
            </div>
        </header>
        
        <main>
            <!-- Home Section -->
            <div id="homeSection" style="display: block; opacity: 1;">
                <section class="hero">
                    <div class="hero-text">
                        AI helps you learn better
                        <span>to fight DSE</span>
                        <div class="buttons">
                            <a href="#tutorial" id="homeTutorialLink">Tutorial Video</a>
                            <a href="#grader" id="homeGraderLink">Exam Grader</a>
                            <a href="#chat" id="homeChatLink">Chat with AI</a>
                        </div>
                    </div>
                    <div class="hero-image">
                        <img src="https://drive.google.com/uc?export=download&id=1wdjIr6SjqlgEjulvbpuNa08HHSMX623t" alt="Darren Ng demonstrating AI Marker">
                    </div>
                </section>

                <section class="why-ai" id="why-ai">
                    <h2>Why AI</h2>
                    <p>
                        AI serves as a powerful assistant in your studies, especially when preparing for challenging exams like DSE. It can provide instant feedback on your work, identify areas where you need improvement, and offer personalized explanations. Unlike traditional methods, AI can analyze vast amounts of information and adapt to your learning style, making your study sessions more efficient and effective. It helps you grasp complex concepts, practice critical thinking, and build confidence, ultimately empowering you to perform your best.
                    </p>
                </section>
            </div>

            <!-- Grading Section -->
            <div id="gradingSection">
                <h2 class="section-title">Exam Grader</h2>
                <div class="mb-4">
                    <label>Upload Student's Work (Image or PDF):</label>
                    <div id="studentDropZone" class="drop-zone">
                        <span>Drag & Drop Student's Work Here or click to select</span>
                        <input type="file" id="studentAnswerFile" accept="image/*,application/pdf" hidden>
                    </div>
                     <span id="studentFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                    <img id="studentFilePreview" class="file-preview mx-auto" style="display: none;" alt="Student Work Preview">
                    <label for="studentAnswer">Or type Student's Answer:</label>
                    <textarea id="studentAnswer" placeholder="Enter student's answer here..."></textarea>
                    <p id="studentAnswerError" class="error-message"></p>
                </div>

                <div class="mb-6">
                    <label>Upload Answer Key (Image or PDF):</label>
                    <div id="answerKeyDropZone" class="drop-zone">
                        <span>Drag & Drop Answer Key Here or click to select</span>
                         <input type="file" id="answerKeyFile" accept="image/*,application/pdf" hidden>
                    </div>
                    <span id="answerKeyFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                    <img id="answerKeyFilePreview" class="file-preview mx-auto" style="display: none;" alt="Answer Key Preview">
                    <label for="answerKey">Or type Answer Key:</label>
                    <textarea id="answerKey" placeholder="Enter the correct answer key here..."></textarea>
                    <p id="answerKeyError" class="error-message"></p>
                </div>

                <button id="gradeButton" class="btn-primary">Grade Work</button>
                <p id="gradingLoadingIndicator" class="loading-indicator"></p>
                <div id="resultContainer">
                    <h2>Grading Results:</h2>
                    <p id="gradeResult">Your grading results will appear here.</p>
                </div>

                <div style="margin-top: 2rem;">
                    <h2>Past Submissions:</h2>
                    <div id="pastSubmissions">
                        <p id="noSubmissions">No past submissions found.</p>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="chatSection">
                <div id="chatDisplay">
                    <div class="chat-message gemini">Hello! How can I help you today?</div>
                </div>
                <div class="chat-input-wrapper">
                    <input type="text" id="chatInput" placeholder="Type a message…">
                    <button id="sendChatButton">Send</button>
                </div>
                 <p id="chatLoadingIndicator" class="loading-indicator"></p>
            </div>

            <!-- Student Management Section -->
            <div id="studentManagementSection">
                <h2 class="section-title">Manage Authorized Students</h2>
                <div class="add-student-form form-container">
                    <input type="email" id="studentEmailInput" placeholder="Enter student's Gmail address">
                    <button id="addStudentButton" class="btn-primary">Add Student</button>
                </div>
                <p id="studentManagementLoading" class="loading-indicator"></p>
                <div id="authorizedStudentsList">
                    <p id="noAuthorizedStudents">No authorized students yet.</p>
                </div>
            </div>

            <!-- Generic Material Section Template -->
            <div id="tutorialSection"></div>
            <div id="pastPapersSection"></div>
            <div id="exerciseSection"></div>
            
            <!-- Profile Section -->
            <div id="profileSection">
                <h2 class="section-title">Edit Your Profile</h2>
                <form id="profileForm" class="form-container">
                    <div style="margin-bottom: 1rem;">
                        <label for="profileName">Display Name</label>
                        <input type="text" id="profileName" name="name" required>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileAge">Age</label>
                        <input type="number" id="profileAge" name="age">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileGrade">Year/Grade</label>
                        <input type="text" id="profileGrade" name="grade">
                    </div>
                     <div style="margin-bottom: 1rem;">
                        <label for="profileSchool">School</label>
                        <input type="text" id="profileSchool" name="school">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileElectives">Elective Subjects</label>
                        <textarea id="profileElectives" name="electives" placeholder="e.g., Physics, Computer Science, Art"></textarea>
                    </div>
                    <button type="submit" id="saveProfileButton" class="btn-primary">Save Profile</button>
                </form>
            </div>
        </main>
    </div>

    <!-- Finder Style Materials Window (Universal for all material types) -->
    <div id="finderMaterialsSection">
        <div class="finder-titlebar" id="finderDragBar">
            <div class="buttons">
                <div class="finder-circle close"></div>
                <div class="finder-circle min"></div>
                <div class="finder-circle max" id="finderFullscreenToggle"></div>
            </div>
            <span id="finderWindowTitle" class="finder-window-title">Materials</span>
        </div>

        <div class="finder-content">
            <aside class="finder-sidebar" id="finderSidebar">
                <!-- Level 1 items (Subjects) will be loaded here by JS -->
            </aside>
            <div class="finder-main-view">
                <div class="finder-header">
                    <div class="finder-breadcrumbs" id="finderBreadcrumbs">
                        <!-- Breadcrumbs will be loaded here by JS -->
                    </div>
                </div>
                <section class="finder-file-list">
                    <div class="columns">
                        <div>Name</div><div>Kind</div><div>Date Added</div><div>Price/Owner</div>
                    </div>
                    <div id="finderFileListContent">
                        <!-- Level 2/3 items will be loaded here by JS -->
                        <p style="text-align:center; padding:20px; color:var(--finder-text-secondary);">Select an item from the sidebar to begin.</p>
                    </div>
                </section>
            </div>
        </div>

        <div class="finder-footer">Contact: darren_0625@mc-zero.com | © 2025 Darren Ng</div>
    </div>

    <!-- Minimized Windows Dock -->
    <div id="minimizedWindowsBar">
        <!-- Minimized tabs will be appended here by JS -->
    </div>

    <footer>
        <a href="mailto:darren_0625@mc-zero.com">Contact: darren_0625@mc-zero.com</a> | Copyright © 2025 Operated by Darren Ng
    </footer>

    <!-- Universal Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle"></h3>
            <div id="modalMessage"></div>
            <div id="modalButtons"></div>
        </div>
    </div>
    
    <!-- Modals for adding content -->
    <div id="addVideoModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3>Add New Tutorial Video</h3>
             <form id="addVideoForm">
                <input type="hidden" id="videoParentId1">
                <input type="hidden" id="videoParentId2">
                 <div style="margin-bottom: 1rem;">
                     <label for="tutorialLink">YouTube Link or Embed Code</label>
                     <textarea id="tutorialLink" required placeholder="Paste a YouTube URL or an <iframe> embed code here..."></textarea>
                     <img id="tutorialThumbnailPreview" style="max-width:200px; margin-top:10px; border-radius:8px; display:none;" alt="Video Thumbnail Preview"/>
                 </div>
                 <div style="margin-bottom: 1rem;">
                     <label for="tutorialTitle">Video Title</label>
                     <input type="text" id="tutorialTitle" required>
                 </div>
                 <div class="modal-form-buttons">
                    <button type="submit" class="btn-primary">Add Video</button>
                 </div>
             </form>
        </div>
    </div>

    <div id="addPastPaperModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3>Add New Past Paper</h3>
             <form id="addPastPaperForm">
                <input type="hidden" id="paperParentId1">
                <input type="hidden" id="paperParentId2">
                 <div style="margin-bottom: 1rem;">
                     <label for="pastPaperName">Paper Name / Title</label>
                     <input type="text" id="pastPaperName" required placeholder="e.g., Paper 1 Section A">
                 </div>
                 <div style="margin-bottom: 1rem;">
                    <label>Upload File (PDF only)</label>
                    <div id="pastPaperDropZone" class="drop-zone">
                        <span>Drag & Drop PDF Here or click to select</span>
                        <input type="file" id="pastPaperFile" accept="application/pdf" hidden>
                    </div>
                    <span id="pastPaperFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                </div>
                <p style="text-align:center; margin-bottom: 1rem; color: var(--text-secondary);">OR</p>
                <div style="margin-bottom: 1rem;">
                    <label for="pastPaperLink">Paste External Link (for large files)</label>
                    <input type="url" id="pastPaperLink" placeholder="https://example.com/document.pdf">
                </div>
                 <div class="modal-form-buttons">
                    <button type="submit" class="btn-primary">Add Paper</button>
                 </div>
             </form>
        </div>
    </div>

    <div id="addExerciseModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3>Add New Exercise</h3>
             <form id="addExerciseForm">
                <input type="hidden" id="exerciseParentId1">
                <input type="hidden" id="exerciseParentId2">
                 <div style="margin-bottom: 1rem;">
                     <label for="exerciseName">Exercise Name / Title</label>
                     <input type="text" id="exerciseName" required placeholder="e.g., Chapter 1 MCQs">
                 </div>
                 <div style="margin-bottom: 1rem;">
                     <label for="exercisePrice">Price (USD)</label>
                     <input type="number" id="exercisePrice" required placeholder="e.g., 10.00" step="0.01" min="0">
                 </div>
                 <div style="margin-bottom: 1rem;">
                    <label>Upload File (PDF only)</label>
                    <div id="exerciseDropZone" class="drop-zone">
                        <span>Drag & Drop PDF Here or click to select</span>
                        <input type="file" id="exerciseFile" accept="application/pdf" hidden>
                    </div>
                    <span id="exerciseFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                </div>
                <p style="text-align:center; margin-bottom: 1rem; color: var(--text-secondary);">OR</p>
                <div style="margin-bottom: 1rem;">
                    <label for="exerciseLink">Paste External Link (for large files)</label>
                    <input type="url" id="exerciseLink" placeholder="https://example.com/document.pdf">
                </div>
                 <div class="modal-form-buttons">
                    <button type="submit" class="btn-primary">Add Exercise</button>
                 </div>
             </form>
        </div>
    </div>

    <!-- Video Preview Modal -->
    <div id="videoPreviewModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="videoPreviewTitle"></h3>
            <div id="videoPreviewContent"></div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, where, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";

        // --- IMPORTANT CONFIGURATION ---
        const STRIPE_PAYMENT_LINK = "https://buy.stripe.com/14A28t1kAfr2gnx04L0ZW0n"; 
        const firebaseConfig = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
          authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30",
          storageBucket: "ai-grading-9bb30.appspot.com",
          messagingSenderId: "298162112230",
          appId: "1:298162112230:web:529d3f95536991be685d27",
          measurementId: "G-CHKLKSM17S"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const CLOUDFLARE_WORKER_URL = "https://ai-marker-gemini-proxy.darren-xie11.workers.dev/";
        const TEACHER_CODE = "TEACHER123";
        const STUDENT_CODE = "STUDENT456";

        pdfjsLib.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let app, db, auth, storage;
        let currentUserId = null, currentUserEmail = null, currentUserRole = null, currentUserName = null;
        let geminiChatHistory = [{ role: "user", parts: [{text: "You are an AI assistant."}]}, { role: "model", parts: [{text: "Hello! How can I assist you?"}]}];
        let shoppingCart = [];
        let appliedPromoCode = null;

        // --- AUTH & INITIALIZATION ---
        
        const authWrapper = document.getElementById('authWrapper');
        const appSection = document.getElementById('appSection');
        const authContainer = document.getElementById('authContainer');

        const googleSignInTemplate = `
            <h2>Sign In</h2>
            <button id="googleSignInButton" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
                <span>Sign in with Google</span>
            </button>
            <p id="authError" class="error-message"></p>
        `;

        const codeEntryTemplate = `
            <h2>Enter Access Code</h2>
            <p style="color: var(--text-secondary); text-align: center; margin-bottom: 1rem;">Please enter the access code provided by your administrator.</p>
            <input type="text" id="accessCodeInput" placeholder="Enter code here">
            <button id="submitCodeButton" class="btn-primary" style="width:100%">Submit Code</button>
            <p id="codeError" class="error-message"></p>
        `;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showModal('Firebase Configuration Error', `Failed to initialize Firebase. Error: ${error.message}`);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                currentUserEmail = user.email;
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                try {
                    const userProfileDoc = await getDoc(userProfileRef);
                    if (userProfileDoc.exists() && userProfileDoc.data().role) {
                        const profileData = userProfileDoc.data();
                        currentUserRole = profileData.role;
                        currentUserName = profileData.name || user.displayName;
                        await setDoc(userProfileRef, { name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                        showApp();
                    } else {
                        currentUserName = user.displayName;
                        currentUserRole = 'unassigned';
                        showCodeEntry();
                    }
                } catch (e) {
                     console.error("Error checking user profile:", e);
                     showModal('Profile Error', `Could not load user profile. Error: ${e.message}`);
                     showLogin();
                }
            } else {
                currentUserId = null;
                currentUserRole = null;
                currentUserName = null;
                showLogin();
            }
        });

        function showLogin() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authWrapper.style.opacity = '1';
            authContainer.innerHTML = googleSignInTemplate;
            document.getElementById('googleSignInButton')?.addEventListener('click', handleGoogleSignIn);
        }

        function showCodeEntry() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authWrapper.style.opacity = '1';
            authContainer.innerHTML = codeEntryTemplate;
            const submitCodeBtn = document.getElementById('submitCodeButton');
            const accessCodeInput = document.getElementById('accessCodeInput');
            submitCodeBtn?.addEventListener('click', () => handleSubmitCode());
            accessCodeInput?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSubmitCode();
                }
            });
            accessCodeInput?.focus();
        }

        async function showApp() {
            authWrapper.style.display = 'none';
            appSection.style.display = 'flex';
            document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
            document.getElementById('manageStudentsButton').style.display = currentUserRole === 'teacher' ? 'block' : 'none';
            
            initializeAllMaterialSections();
            await checkForSuccessfulPurchase();

            showSection('homeSection');
            loadPastSubmissions();
            if(currentUserRole === 'teacher') {
                loadAuthorizedStudents();
                loadStudentPurchasesForTeacher();
            }

            document.getElementById('homeTutorialLink')?.addEventListener('click', (e) => { e.preventDefault(); showSection('tutorialSection'); });
            document.getElementById('homeGraderLink')?.addEventListener('click', (e) => { e.preventDefault(); showSection('gradingSection'); });
            document.getElementById('homeChatLink')?.addEventListener('click', (e) => { e.preventDefault(); showSection('chatSection'); });
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try { 
                await signInWithPopup(auth, provider); 
            } catch (error) { 
                document.getElementById('authError').textContent = `Sign-in failed. Error: ${error.message}`; 
                console.error("Google Sign-In Error:", error);
            }
        }

        async function handleSubmitCode(codeValue) {
            const code = (codeValue || document.getElementById('accessCodeInput').value).trim();
            const codeError = document.getElementById('codeError');
            if(codeError) codeError.textContent = '';
            
            let roleToSet = null;
            if (code === TEACHER_CODE) roleToSet = 'teacher';
            else if (code === STUDENT_CODE) roleToSet = 'student';
            else { 
                if(codeError) codeError.textContent = 'Invalid access code.';
                return; 
            }
            
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await setDoc(userProfileRef, { role: roleToSet, name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                currentUserRole = roleToSet;
                showModal('Success!', `Your role has been set to ${roleToSet}.`);
                showApp();
            } catch (error) {
                if(codeError) codeError.textContent = `Could not set role. Error: ${e.message}`;
                console.error("Submit Code Error:", error);
            }
        }

        document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));

        document.getElementById('switchRoleButton').addEventListener('click', () => {
            showInputModal('Switch Role', 'Enter new access code (Teacher or Student):', async (code) => {
                await handleSubmitCode(code);
            });
        });

        // --- NAVIGATION & UI ---

        let currentMaterialViewMode = 'card'; // 'card' or 'finder'

        function showSection(sectionIdToShow) {
            const sections = ['homeSection', 'gradingSection', 'chatSection', 'studentManagementSection', 'profileSection', 'tutorialSection', 'pastPapersSection', 'exerciseSection'];
            const buttons = {
                toggleHomeButton: 'homeSection',
                workWithAIButton: ['gradingSection', 'chatSection'],
                materialsButton: ['tutorialSection', 'pastPapersSection', 'exerciseSection'],
                manageStudentsButton: 'studentManagementSection',
                toggleProfileButton: 'profileSection'
            };
            
            document.querySelectorAll('.header-actions .tab.neon-button').forEach(t => t.classList.remove('active'));

            let activeButtonId = null;
            for (const [btnId, secId] of Object.entries(buttons)) {
                if (Array.isArray(secId) && secId.includes(sectionIdToShow)) {
                    activeButtonId = btnId;
                    break;
                }
                if (secId === sectionIdToShow) {
                    activeButtonId = btnId;
                    break;
                }
            }
            if (activeButtonId) {
                document.getElementById(activeButtonId)?.classList.add('active');
            }

            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    const isTarget = id === sectionIdToShow;
                    section.style.display = isTarget ? (id === 'chatSection' || id === 'studentManagementSection' ? 'flex' : 'block') : 'none';
                    setTimeout(() => section.style.opacity = isTarget ? '1' : '0', 10);
                }
            });

            // Handle visibility of finder window based on section and screen size
            const finderSection = document.getElementById('finderMaterialsSection');
            const isMaterialSection = ['tutorialSection', 'pastPapersSection', 'exerciseSection'].includes(sectionIdToShow);
            
            if (isMaterialSection && window.innerWidth >= 769) {
                // If finder mode is active, show it. Otherwise, hide it.
                finderSection.style.display = currentMaterialViewMode === 'finder' ? 'flex' : 'none';
                // Hide the standard card/list view if finder is active
                document.getElementById(sectionIdToShow).classList.toggle('hidden-on-desktop', currentMaterialViewMode === 'finder');
            } else { // Mobile or non-material section
                finderSection.style.display = 'none';
                // Always show the standard view on mobile or for non-material sections
                document.getElementById(sectionIdToShow).classList.remove('hidden-on-desktop');
            }


            if (sectionIdToShow === 'profileSection') loadProfileData();
            if (sectionIdToShow === 'exerciseSection' && currentUserRole === 'teacher') {
                loadPromoCodesForTeacher();
                loadStudentPurchasesForTeacher();
            }
        }

        function setupSectionToggle() {
            document.getElementById('toggleHomeButton')?.addEventListener('click', () => showSection('homeSection'));
            document.getElementById('toggleGradingButton')?.addEventListener('click', () => showSection('gradingSection'));
            document.getElementById('toggleChatButton')?.addEventListener('click', () => showSection('chatSection'));
            document.getElementById('manageStudentsButton')?.addEventListener('click', () => showSection('studentManagementSection'));
            document.getElementById('toggleProfileButton')?.addEventListener('click', () => showSection('profileSection'));
            
            // Materials dropdown buttons
            document.getElementById('toggleTutorialButton')?.addEventListener('click', () => handleMaterialNavClick('tutorials'));
            document.getElementById('togglePastPapersButton')?.addEventListener('click', () => handleMaterialNavClick('pastPapers'));
            document.getElementById('toggleExercisesButton')?.addEventListener('click', () => handleMaterialNavClick('exercises'));
            
            document.getElementById('userDisplayName')?.addEventListener('click', () => showSection('profileSection'));
        }
        setupSectionToggle();
        
        function handleMaterialNavClick(type) {
            const config = materialsConfig[type];
            showSection(config.sectionId);
            
            // If finder view is the current mode on desktop, ensure it's populated for the selected type
            if (window.innerWidth >= 769 && currentMaterialViewMode === 'finder') {
                showFinderView(type);
            }
        }
        
        // --- PROFILE MANAGEMENT ---

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) { showModal('Error', 'You must be logged in to save your profile.'); return; }
            
            const formData = new FormData(e.target);
            const profileData = Object.fromEntries(formData.entries());
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            try {
                await setDoc(userProfileRef, profileData, { merge: true });
                currentUserName = profileData.name;
                document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
                showModal('Success', 'Your profile has been updated!');
            } catch (error) {
                console.error("Error saving profile:", error);
                showModal('Error', `Could not save profile: ${error.message}`);
            }
        });

        async function loadProfileData() {
            if (!currentUserId) return;
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            const docSnap = await getDoc(userProfileRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('profileName').value = data.name || '';
                document.getElementById('profileAge').value = data.age || '';
                document.getElementById('profileGrade').value = data.grade || '';
                document.getElementById('profileSchool').value = data.school || '';
                document.getElementById('profileElectives').value = data.electives || '';
            }
        }
        
        // --- REFACTORED MATERIALS MANAGEMENT ---

        const materialsConfig = {
            tutorials: {
                sectionId: 'tutorialSection',
                collectionName: 'tutorials',
                title: 'Tutorial Videos',
                level1: 'Subject',
                level2: 'Topic',
                level3: 'Video',
                modalId: 'addVideoModal',
                isPaid: false
            },
            pastPapers: {
                sectionId: 'pastPapersSection',
                collectionName: 'pastPapers',
                title: 'Past Papers',
                level1: 'Subject',
                level2: 'Year',
                level3: 'Paper',
                modalId: 'addPastPaperModal',
                isPaid: false
            },
            exercises: {
                sectionId: 'exerciseSection',
                collectionName: 'exercises',
                title: 'Exercises for Sale',
                level1: 'Subject',
                level2: 'Topic',
                level3: 'Exercise',
                modalId: 'addExerciseModal',
                isPaid: true
            }
        };

        function getPath(type, ids = []) {
            const collection = materialsConfig[type].collectionName;
            const pathParts = [`artifacts/${appId}/public/data/${collection}`];
            if (ids[0]) pathParts.push(ids[0], materialsConfig[type].level2.toLowerCase() + 's');
            if (ids[1]) pathParts.push(ids[1], materialsConfig[type].level3.toLowerCase() + 's');
            return pathParts.join('/');
        }

        function initializeAllMaterialSections() {
            for (const type in materialsConfig) {
                setupMaterialSection(type);
            }
            document.getElementById('tutorialSection').addEventListener('click', (e) => {
                const thumbnail = e.target.closest('.material-card-thumbnail[data-youtube-id]');
                if (thumbnail) {
                    e.preventDefault();
                    const videoId = thumbnail.dataset.youtubeId;
                    const embedContainer = document.createElement('div');
                    embedContainer.className = 'video-embed-container';
                    embedContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                    thumbnail.replaceWith(embedContainer);
                }
            });
            setupFinderWindow();
        }

        function setupMaterialSection(type) {
            const config = materialsConfig[type];
            const section = document.getElementById(config.sectionId);

            let studentViewHtml = `
                <div class="filters-container">
                    <select id="level1-${type}-filter" style="width:250px;"><option>-- Select ${config.level1} --</option></select>
                    <select id="level2-${type}-filter" style="width:250px;" disabled><option>-- Select ${config.level2} --</option></select>
                </div>
                <div id="level3-${type}-grid" class="grid-container"></div>`;

            if (config.isPaid) {
                studentViewHtml = `
                    <div class="store-layout">
                        <div class="product-grid">
                            ${studentViewHtml}
                        </div>
                        <div class="shopping-cart">
                            <h3>Shopping Cart</h3>
                            <div id="cart-items"></div>
                            <div id="cart-summary">
                                <div class="summary-line">
                                    <span>Subtotal:</span>
                                    <span id="cart-subtotal-price">$0.00</span>
                                </div>
                                <div class="summary-line" id="promo-discount-line" style="display:none;">
                                    <span>Promo Discount:</span>
                                    <span id="cart-promo-discount">-$0.00</span>
                                </div>
                                <div class="summary-line">
                                    <span>Total Price:</span>
                                    <span id="cart-total-price">$0.00</span>
                                </div>
                            </div>
                            <div class="promo-code-section">
                                <label for="promoCodeInput">Promo Code:</label>
                                <div class="promo-input-group">
                                    <input type="text" id="promoCodeInput" placeholder="Enter promo code">
                                    <button id="applyPromoCodeBtn" class="btn-primary">Apply</button>
                                </div>
                                <div id="appliedPromoCodeDisplay" class="promo-display" style="display:none;">
                                    <span>Applied: <span id="appliedPromoCodeText"></span></span>
                                    <button id="removePromoCodeBtn" class="remove-promo-btn">Remove</button>
                                </div>
                                <p id="promoCodeError" class="promo-error"></p>
                            </div>
                            <div id="cart-validation-message"></div>
                            <button id="checkout-btn" class="btn-primary" disabled>Proceed to Checkout</button>
                        </div>
                    </div>`;
            }

            section.innerHTML = `
                <div id="material-view-${type}" class="material-card-view">
                    <h2 class="section-title">
                        ${config.title}
                        <button class="material-view-toggle" data-type="${type}">Switch to Windows Mode</button>
                    </h2>
                    <div id="teacher-${type}-view" style="display:none;">
                        <div class="form-container" style="max-width: initial;">
                            <button id="add-level1-${type}-btn" class="btn-primary">Add New ${config.level1}</button>
                        </div>
                        <div id="level1-${type}-container"></div>
                        ${type === 'exercises' ? `
                            <div class="form-container" style="max-width: initial; margin-top: 2rem;">
                                <h3>Promo Code Management</h3>
                                <div style="margin-bottom: 1rem;">
                                    <label for="promoDiscountAmount">Discount Amount ($)</label>
                                    <input type="number" id="promoDiscountAmount" placeholder="e.g., 10.00" step="0.01" min="0">
                                </div>
                                <button id="generatePromoCodeBtn" class="btn-primary">Generate New Promo Code</button>
                                <p id="promoCodeGenerationStatus" class="loading-indicator"></p>
                                <div class="promo-code-list" id="teacherPromoCodeList"><p>No promo codes generated yet.</p></div>
                            </div>
                            <div class="purchase-history-section">
                                <h3>Student Purchase History</h3>
                                <div id="studentPurchaseHistoryList"><p class="loading-indicator">Loading purchase history...</p></div>
                            </div>
                        ` : ''}
                    </div>
                    <div id="student-${type}-view" style="display:none;">
                        ${studentViewHtml}
                    </div>
                </div>`;

            const isTeacher = currentUserRole === 'teacher';
            document.getElementById(`teacher-${type}-view`).style.display = isTeacher ? 'block' : 'none';
            document.getElementById(`student-${type}-view`).style.display = isTeacher ? 'none' : 'block';

            if (isTeacher) {
                renderContent(type, `level1-${type}-container`, 1);
                document.getElementById(`add-level1-${type}-btn`).onclick = () => showAddItemModal(type, 1);
                document.getElementById(`level1-${type}-container`).addEventListener('click', (e) => handleTeacherClick(e, type));
                
                const teacherViewContainer = document.getElementById(`teacher-${type}-view`);
                teacherViewContainer.addEventListener('dragover', (e) => handleDragOver(e, type));
                teacherViewContainer.addEventListener('drop', (e) => handleDrop(e, type));
                teacherViewContainer.addEventListener('dragleave', (e) => handleDragLeave(e, type));

                if (type === 'exercises') {
                    document.getElementById('generatePromoCodeBtn').addEventListener('click', generateAndSavePromoCode);
                    loadPromoCodesForTeacher();
                }
            } else { // Student view
                setupStudentFilters(type);
                if(config.isPaid) {
                    document.getElementById('checkout-btn').addEventListener('click', handleCheckout);
                    document.getElementById('applyPromoCodeBtn').addEventListener('click', applyPromoCode);
                    document.getElementById('removePromoCodeBtn').addEventListener('click', removeAppliedPromoCode);
                }
            }

            // Setup the view toggle button
            section.querySelector('.material-view-toggle').addEventListener('click', (e) => {
                const button = e.target;
                const type = button.dataset.type;
                const cardView = document.getElementById(`material-view-${type}`);
                
                if (currentMaterialViewMode === 'card') {
                    currentMaterialViewMode = 'finder';
                    cardView.classList.add('hidden-on-desktop');
                    showFinderView(type);
                    button.textContent = 'Switch to Folder Mode';
                } else {
                    currentMaterialViewMode = 'card';
                    cardView.classList.remove('hidden-on-desktop');
                    document.getElementById('finderMaterialsSection').style.display = 'none';
                    button.textContent = 'Switch to Windows Mode';
                }
            });
        }
        
        async function renderContent(type, containerId, level, parentIds = []) {
            const container = document.getElementById(containerId);
            const config = materialsConfig[type];
            const levelName = config[`level${level}`];
            container.innerHTML = `<p class="loading-indicator">Loading ${levelName.toLowerCase()}s...</p>`;

            const collectionRef = collection(db, getPath(type, parentIds));
            const q = query(collectionRef, orderBy('name', levelName === 'Year' ? 'desc' : 'asc'));
            
            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = `<p>No ${levelName.toLowerCase()}s added yet.</p>`;
                    return;
                }
                
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = doc.data();
                    item.id = doc.id;
                    const el = document.createElement('div');
                    el.className = level < 3 ? 'content-item' : 'sub-item';
                    el.dataset.level = level;
                    el.dataset.id = doc.id;
                    el.dataset.parentIds = JSON.stringify(parentIds);

                    let headerHtml;
                    if (level < 3) {
                        const nextLevel = level + 1;
                        const newParentIds = [...parentIds, doc.id];
                        headerHtml = `
                            <div class="content-header" aria-expanded="false">
                                <${level === 1 ? 'h3' : 'h4'}>${item.name} <span class="collapse-arrow"></span></${level === 1 ? 'h3' : 'h4'}>
                                <div class="item-actions">
                                    <button class="add-item-btn btn-primary" data-level="${nextLevel}" data-parent-ids='${JSON.stringify(newParentIds)}'>Add ${config[`level${nextLevel}`]}</button>
                                    <button class="delete-item-btn logout-btn">Delete</button>
                                </div>
                            </div>
                            <div class="nested-container" id="container-level${nextLevel}-${type}-${doc.id}"></div>
                        `;
                    } else {
                        let itemName = item.name || item.title;
                        let itemPrice = config.isPaid ? ` - $${item.price.toFixed(2)}` : '';
                        headerHtml = `<span>${itemName}${itemPrice}</span>
                                     <div class="item-actions">
                                        <button class="preview-item-btn btn-primary" data-type="${type}" data-item='${JSON.stringify(item)}'>Preview</button>
                                        <button class="delete-item-btn logout-btn">Delete</button>
                                     </div>`;
                        el.setAttribute('draggable', 'true');
                        el.dataset.itemType = type;
                        el.addEventListener('dragstart', handleDragStart);
                    }
                    el.innerHTML = headerHtml;
                    container.appendChild(el);
                });
            } catch (error) {
                console.error(`Error rendering level ${level} for ${type}:`, error);
                container.innerHTML = `<p class="error-message">Error loading content. A database index might be required. Check console for details.</p>`;
            }
        }
        
        async function handleTeacherClick(e, type) {
            const itemElement = e.target.closest('.content-item, .sub-item');
            if (!itemElement) return;

            const { level, id, parentIds: parentIdsJson } = itemElement.dataset;
            const parentIds = JSON.parse(parentIdsJson);
            const currentLevel = parseInt(level);

            const button = e.target.closest('button');
            if (button) {
                e.stopPropagation();
                if (button.matches('.add-item-btn')) {
                    const nextLevel = parseInt(button.dataset.level);
                    const newParentIds = JSON.parse(button.dataset.parentIds);
                    if (nextLevel < 3) {
                        showAddItemModal(type, nextLevel, newParentIds);
                    } else { 
                        showAddFinalItemModal(type, newParentIds);
                    }
                } else if (button.matches('.delete-item-btn')) {
                    handleDeleteItem(type, currentLevel, id, parentIds);
                } else if (button.matches('.preview-item-btn')) {
                    const itemData = JSON.parse(button.dataset.item);
                    handleTeacherPreview(type, itemData);
                }
            } else if (currentLevel < 3) {
                const header = itemElement.querySelector('.content-header');
                const container = itemElement.querySelector('.nested-container');
                if (!header || !container) return;

                const isExpanded = header.getAttribute('aria-expanded') === 'true';
                header.setAttribute('aria-expanded', !isExpanded);
                container.classList.toggle('expanded', !isExpanded);

                if (!isExpanded && !container.dataset.loaded) {
                    await renderContent(type, container.id, currentLevel + 1, [...parentIds, id]);
                    container.dataset.loaded = 'true';
                }
            }
        }

        function handleTeacherPreview(type, item) {
            if (type === 'tutorials') {
                const videoPreviewModal = document.getElementById('videoPreviewModal');
                const videoPreviewTitle = document.getElementById('videoPreviewTitle');
                const videoPreviewContent = document.getElementById('videoPreviewContent');
                
                videoPreviewTitle.textContent = item.title;
                if (item.type === 'youtube') {
                    videoPreviewContent.innerHTML = `<iframe src="https://www.youtube.com/embed/${item.youtubeId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                } else if (item.type === 'embed') {
                    videoPreviewContent.innerHTML = item.embedCode;
                }
                videoPreviewModal.style.display = 'flex';
            } else if (type === 'pastPapers' || type === 'exercises') {
                if (item.link) {
                    window.open(item.link, '_blank');
                } else {
                    showModal('Preview Error', 'No link available for this item.');
                }
            }
        }

        // --- All other functions (showAddItemModal, handleDeleteItem, drag-drop, student filters, e-commerce, modals, grading, chat, etc.) remain largely the same ---
        // ... (The large block of existing JS functions from the original file would go here)
        // For brevity, I will omit the functions that do not need significant changes and focus on the new Finder logic.
        // Assume all other functions like `showAddItemModal`, `handleDeleteItem`, `setupStudentFilters`, `addToCart`, etc. are present here.

        // --- START: NEW AND REFACTORED FINDER WINDOW LOGIC ---
        let finderCurrentType = null;
        let finderCurrentPath = []; // Array of {id, name} objects for breadcrumbs
        let minimizedWindows = {}; // Stores { type: { left, top, width, height, isFullscreen } }

        function showFinderView(type) {
            const finderWindow = document.getElementById('finderMaterialsSection');
            finderWindow.style.display = 'flex';
            finderCurrentType = type;
            document.getElementById('finderWindowTitle').textContent = materialsConfig[type].title;
            
            // Reset path and render sidebar
            finderCurrentPath = [];
            renderFinderSidebar(type);
            renderFinderFileList(); // Renders initial empty/prompt state
            updateFinderBreadcrumbs();
        }

        async function renderFinderSidebar(type) {
            const sidebar = document.getElementById('finderSidebar');
            const config = materialsConfig[type];
            sidebar.innerHTML = `<div class="finder-sidebar-header">${config.level1}s</div>`;
            const collectionRef = collection(db, getPath(type));
            const q = query(collectionRef, orderBy('name', 'asc'));

            try {
                const snapshot = await getDocs(q);
                snapshot.forEach(doc => {
                    const item = doc.data();
                    const el = document.createElement('div');
                    el.className = 'finder-sidebar-item';
                    el.textContent = item.name;
                    el.dataset.id = doc.id;
                    el.dataset.name = item.name;
                    el.onclick = () => {
                        finderCurrentPath = [{id: doc.id, name: item.name}];
                        document.querySelectorAll('.finder-sidebar-item.active').forEach(i => i.classList.remove('active'));
                        el.classList.add('active');
                        renderFinderFileList();
                        updateFinderBreadcrumbs();
                    };
                    sidebar.appendChild(el);
                });
            } catch(e) {
                sidebar.innerHTML += `<p class="error-message">Error loading.</p>`;
                console.error(e);
            }
        }

        async function renderFinderFileList() {
            const fileListContent = document.getElementById('finderFileListContent');
            const type = finderCurrentType;
            const config = materialsConfig[type];
            const pathIds = finderCurrentPath.map(p => p.id);
            const level = finderCurrentPath.length + 1;

            fileListContent.innerHTML = `<p class="loading-indicator">Loading...</p>`;

            if (level > 3) {
                fileListContent.innerHTML = `<p>End of path.</p>`;
                return;
            }
            if (level === 1) {
                 fileListContent.innerHTML = `<p style="text-align:center; padding:20px; color:var(--finder-text-secondary);">Select a ${config.level1} from the sidebar.</p>`;
                 return;
            }

            const collectionRef = collection(db, getPath(type, pathIds));
            const q = query(collectionRef, orderBy('name', config.level2 === 'Year' && level === 2 ? 'desc' : 'asc'));

            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    fileListContent.innerHTML = `<p style="text-align:center; padding:20px; color:var(--finder-text-secondary);">This folder is empty.</p>`;
                    return;
                }
                fileListContent.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = doc.data();
                    const row = document.createElement('div');
                    const isFolder = level < 3;
                    const kind = isFolder ? config[`level${level}`] : config.level3;
                    row.className = `row ${isFolder ? 'folder' : type.slice(0, -1)}`; // e.g., 'tutorial', 'pastPaper', 'exercise'
                    
                    let priceOrOwner = '-';
                    if (!isFolder && config.isPaid) {
                        priceOrOwner = `$${item.price.toFixed(2)}`;
                    }

                    row.innerHTML = `
                        <div class="file-name">${item.name}</div>
                        <div>${kind}</div>
                        <div>${new Date(item.timestamp).toLocaleDateString()}</div>
                        <div>${priceOrOwner}</div>
                    `;
                    
                    row.onclick = () => {
                        if (isFolder) {
                            finderCurrentPath.push({id: doc.id, name: item.name});
                            renderFinderFileList();
                            updateFinderBreadcrumbs();
                        } else {
                            // Handle file click (e.g., preview or download)
                            handleTeacherPreview(type, {...item, id: doc.id});
                        }
                    };
                    fileListContent.appendChild(row);
                });

            } catch(e) {
                fileListContent.innerHTML = `<p class="error-message">Error loading content.</p>`;
                console.error(e);
            }
        }

        function updateFinderBreadcrumbs() {
            const breadcrumbsContainer = document.getElementById('finderBreadcrumbs');
            const type = finderCurrentType;
            if (!type) return;

            breadcrumbsContainer.innerHTML = '';
            const rootEl = document.createElement('span');
            rootEl.textContent = materialsConfig[type].title;
            rootEl.onclick = () => {
                finderCurrentPath = [];
                document.querySelectorAll('.finder-sidebar-item.active').forEach(i => i.classList.remove('active'));
                renderFinderFileList();
                updateFinderBreadcrumbs();
            };
            breadcrumbsContainer.appendChild(rootEl);

            finderCurrentPath.forEach((segment, index) => {
                const segmentEl = document.createElement('span');
                segmentEl.textContent = segment.name;
                segmentEl.onclick = () => {
                    finderCurrentPath = finderCurrentPath.slice(0, index + 1);
                    renderFinderFileList();
                    updateFinderBreadcrumbs();
                };
                breadcrumbsContainer.appendChild(segmentEl);
            });
        }

        function setupFinderWindow() {
            const finderWindow = document.getElementById('finderMaterialsSection');
            const dragBar = document.getElementById('finderDragBar');
            const fullscreenToggle = document.getElementById('finderFullscreenToggle');
            const minimizeButton = finderWindow.querySelector('.finder-circle.min');
            const closeButton = finderWindow.querySelector('.finder-circle.close');

            let isDragging = false, startX, startY, startLeft, startTop;
            
            dragBar.addEventListener('mousedown', (e) => {
                if (e.target.closest('.buttons')) return; // Don't drag if clicking buttons
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                const rect = finderWindow.getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
                finderWindow.style.transition = 'none'; // Disable transition for smooth dragging
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    finderWindow.style.left = `${startLeft + dx}px`;
                    finderWindow.style.top = `${startTop + dy}px`;
                    finderWindow.style.transform = 'none';
                }
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    finderWindow.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                }
            });

            fullscreenToggle.addEventListener('click', () => {
                finderWindow.classList.toggle('fullscreen');
                // After toggling, reset position if not fullscreen
                if (!finderWindow.classList.contains('fullscreen')) {
                    finderWindow.style.left = '50%';
                    finderWindow.style.top = '50%';
                    finderWindow.style.transform = 'translate(-50%, -50%)';
                }
            });

            closeButton.addEventListener('click', () => {
                finderWindow.style.display = 'none';
                currentMaterialViewMode = 'card';
                const cardView = document.getElementById(`material-view-${finderCurrentType}`);
                if (cardView) {
                    cardView.classList.remove('hidden-on-desktop');
                    cardView.querySelector('.material-view-toggle').textContent = 'Switch to Windows Mode';
                }
            });

            minimizeButton.addEventListener('click', () => minimizeFinderWindow());
        }

        function minimizeFinderWindow() {
            const finderWindow = document.getElementById('finderMaterialsSection');
            const bar = document.getElementById('minimizedWindowsBar');
            const type = finderCurrentType;
            if (!type || minimizedWindows[type]) return; // Don't minimize if already minimized

            const rect = finderWindow.getBoundingClientRect();
            minimizedWindows[type] = {
                left: rect.left, top: rect.top, width: rect.width, height: rect.height,
                isFullscreen: finderWindow.classList.contains('fullscreen')
            };

            const tab = document.createElement('div');
            tab.className = 'minimized-tab';
            tab.dataset.type = type;
            tab.innerHTML = `<span>${materialsConfig[type].title}</span><button class="close-tab-btn">✖</button>`;
            bar.appendChild(tab);
            bar.classList.add('active');

            // Animate
            const tabRect = tab.getBoundingClientRect();
            finderWindow.style.setProperty('--start-x', `${rect.left}px`);
            finderWindow.style.setProperty('--start-y', `${rect.top}px`);
            finderWindow.style.setProperty('--target-x', `${tabRect.left}px`);
            finderWindow.style.setProperty('--target-y', `${tabRect.top}px`);
            finderWindow.style.transformOrigin = 'top left';
            finderWindow.classList.add('minimizing');

            finderWindow.addEventListener('animationend', function handler() {
                finderWindow.style.display = 'none';
                finderWindow.classList.remove('minimizing');
                this.removeEventListener('animationend', handler);
            }, { once: true });

            tab.querySelector('.close-tab-btn').onclick = (e) => {
                e.stopPropagation();
                delete minimizedWindows[type];
                tab.remove();
                if (Object.keys(minimizedWindows).length === 0) bar.classList.remove('active');
            };

            tab.onclick = () => restoreFinderWindow(type, tab);
        }

        function restoreFinderWindow(type, tabElement) {
            const finderWindow = document.getElementById('finderMaterialsSection');
            const bar = document.getElementById('minimizedWindowsBar');
            const state = minimizedWindows[type];
            if (!state) return;

            tabElement.remove();
            delete minimizedWindows[type];
            if (Object.keys(minimizedWindows).length === 0) bar.classList.remove('active');

            finderWindow.style.display = 'flex';
            if (state.isFullscreen) {
                finderWindow.classList.add('fullscreen');
            } else {
                finderWindow.classList.remove('fullscreen');
            }

            const tabRect = tabElement.getBoundingClientRect();
            finderWindow.style.setProperty('--start-x', `${tabRect.left}px`);
            finderWindow.style.setProperty('--start-y', `${tabRect.top}px`);
            finderWindow.style.setProperty('--target-x', `${state.left}px`);
            finderWindow.style.setProperty('--target-y', `${state.top}px`);
            finderWindow.classList.add('restoring');

            finderWindow.addEventListener('animationend', function handler() {
                finderWindow.classList.remove('restoring');
                finderWindow.style.left = `${state.left}px`;
                finderWindow.style.top = `${state.top}px`;
                finderWindow.style.transform = 'none';
                this.removeEventListener('animationend', handler);
            }, { once: true });
        }

        // --- THEME TOGGLE ---
        const themeToggleButton = document.getElementById('themeToggleButton');
        function applyTheme(theme) { document.body.classList.toggle('light-theme', theme === 'light'); }
        function loadTheme() { applyTheme(localStorage.getItem('ai-marker-theme') || 'dark'); }
        themeToggleButton.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('ai-marker-theme', newTheme);
        });
        loadTheme();

        // --- WINDOW RESIZE HANDLING ---
        window.addEventListener('resize', () => {
            const isDesktop = window.innerWidth >= 769;
            const finderSection = document.getElementById('finderMaterialsSection');
            
            // Hide finder view on mobile if it's open
            if (!isDesktop && finderSection.style.display === 'flex') {
                finderSection.style.display = 'none';
                currentMaterialViewMode = 'card';
                // Make sure the corresponding card view is visible
                if (finderCurrentType) {
                    const cardView = document.getElementById(`material-view-${finderCurrentType}`);
                    cardView.classList.remove('hidden-on-desktop');
                    cardView.querySelector('.material-view-toggle').textContent = 'Switch to Windows Mode';
                }
            }
        });

        // --- All other existing JS functions should be included here ---
        // For example:
        async function loadPastSubmissions() { /* ... */ }
        document.getElementById('gradeButton').addEventListener('click', async () => { /* ... */ });
        async function handleSendMessage() { /* ... */ }
        function appendChatMessage(text, sender) { /* ... */ }
        document.getElementById('addStudentButton').addEventListener('click', async () => { /* ... */ });
        async function loadAuthorizedStudents() { /* ... */ }
        function showModal(title, message, buttons = []) { /* ... */ }
        function showInputModal(title, label, callback) { /* ... */ }
        // etc.
        // The full script from the original file should be here, with the finder logic integrated as shown above.
        // I've omitted the unchanged functions for clarity in this response.

    </script>
</body>
</html>
