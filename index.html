<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Exam Grader</title>
    <!-- Tailwind CSS for basic styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Inter font and rounded corners */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f7f9fa; /* Very light gray, almost white, like Google's */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            padding: 40px; /* Increased padding */
            border-radius: 8px; /* Slightly less rounded, more modern card */
            /* Subtle, multi-layer shadow like Google's cards */
            box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
            max-width: 900px;
            width: 100%;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        input[type="text"],
        input[type="file"],
        textarea {
            border-color: #dadce0; /* Softer, Google-like border color */
        }
        input[type="text"]:focus,
        input[type="file"]:focus,
        textarea:focus {
            border-color: #4285F4; /* Google blue for focus */
            box-shadow: 0 0 0 1px #4285F4; /* Subtle glow on focus */
            outline: none; /* Remove default outline */
        }
        button {
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 4px; /* Slightly less rounded buttons */
        }
        button:hover {
            transform: translateY(-1px); /* Slight lift */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow on hover */
        }
        #loadingIndicator {
            display: none;
            color: #4f46e5;
            font-weight: 500;
        }
        #resultContainer {
            min-height: 100px;
            background-color: #ecf0f1;
            padding: 16px;
            border-radius: 8px;
            white-space: pre-wrap;
            border: 1px solid #dadce0; /* Add a light border to the result container */
        }
        .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .file-input-wrapper input[type="file"] {
            flex-grow: 1;
        }
        .file-preview {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }
        .close-button:hover {
            color: #555;
        }
        .google-btn {
            background-color: #4285F4; /* Google Blue */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
        }
        .google-btn:hover {
            background-color: #357ae8; /* Darker blue on hover */
        }
        .google-icon {
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
        }
        .google-icon img {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body class="antialiased">
    <div id="authSection" class="container flex flex-col gap-6" style="display: none;">
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-6">Welcome to AI Grader</h1>

        <button id="googleSignInButton" class="google-btn rounded-lg focus:outline-none focus:shadow-outline-blue transition duration-300">
            <span class="google-icon">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
            </span>
            Sign in with Google
        </button>

        <p id="authError" class="error-message text-center"></p>
    </div>

    <!-- Role Selection Modal (hidden by default) -->
    <div id="roleSelectionModal" class="modal">
        <div class="modal-content">
            <h3 id="roleModalTitle" class="text-xl font-bold mb-3 text-center">Select Your Role</h3>
            <p id="roleModalMessage" class="text-gray-700 text-center mb-6">Please tell us if you are a Student or a Teacher.</p>
            <div id="roleModalButtons" class="flex flex-col gap-4">
                <button id="selectStudentRole" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline-blue transition duration-300">
                    I am a Student
                </button>
                <button id="selectTeacherRole" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline-green transition duration-300">
                    I am a Teacher
                </button>
            </div>
        </div>
    </div>


    <div id="appSection" class="container flex flex-col gap-6" style="display: none;">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-4xl font-extrabold text-gray-800">Gemini Exam Grader</h1>
            <div class="flex items-center gap-2">
                <span id="userDisplayName" class="text-gray-600 text-sm font-medium"></span>
                <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline-red transition duration-300 text-sm">
                    Log Out
                </button>
            </div>
        </div>

        <div class="mb-4">
            <label for="studentAnswerFile" class="block text-gray-700 text-sm font-semibold mb-2">Upload Student's Work (Image):</label>
            <div class="file-input-wrapper">
                <input type="file" id="studentAnswerFile" accept="image/*" class="shadow-sm appearance-none border rounded-lg py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                <span id="studentFileName" class="text-gray-500 text-sm">No file chosen</span>
            </div>
            <img id="studentFilePreview" class="file-preview" style="display: none;" alt="Student Work Preview">
            <label for="studentAnswer" class="block text-gray-700 text-sm font-semibold mt-4 mb-2">Or type Student's Answer:</label>
            <textarea id="studentAnswer" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" placeholder="Enter student's answer here..."></textarea>
            <p id="studentAnswerError" class="error-message"></p>
        </div>

        <div class="mb-6">
            <label for="answerKeyFile" class="block text-gray-700 text-sm font-semibold mb-2">Upload Answer Key (Image):</label>
            <div class="file-input-wrapper">
                <input type="file" id="answerKeyFile" accept="image/*" class="shadow-sm appearance-none border rounded-lg py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                <span id="answerKeyFileName" class="text-gray-500 text-sm">No file chosen</span>
            </div>
            <img id="answerKeyFilePreview" class="file-preview" style="display: none;" alt="Answer Key Preview">
            <label for="answerKey" class="block text-gray-700 text-sm font-semibold mt-4 mb-2">Or type Answer Key:</label>
            <textarea id="answerKey" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" placeholder="Enter the correct answer key here..."></textarea>
            <p id="answerKeyError" class="error-message"></p>
        </div>

        <button id="gradeButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline-indigo transition duration-300">
            Grade Work
        </button>

        <p id="loadingIndicator" class="text-center mt-4">Grading in progress, please wait...</p>

        <div id="resultContainer" class="mt-6 border border-gray-300 rounded-lg p-5">
            <h2 class="text-2xl font-bold text-gray-800 mb-3">Grading Results:</h2>
            <p id="gradeResult" class="text-gray-900 leading-relaxed">Your grading results will appear here after submission.</p>
        </div>

        <div class="mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Past Submissions:</h2>
            <div id="pastSubmissions" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <p id="noSubmissions" class="text-gray-500">No past submissions found.</p>
            </div>
        </div>
    </div>

    <!-- Custom Modal for General Messages -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle" class="text-xl font-bold mb-3"></h3>
            <p id="modalMessage" class="text-gray-700"></p>
            <div id="modalButtons" class="flex justify-end gap-2 mt-4"></div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

        // --- Firebase Initialization and Global Variables ---
        // For local file execution or when hosted on your own domain,
        // you MUST replace this `FIREBASE_CONFIG_PLACEHOLDER` with your actual Firebase project config.
        // This config was copied from your Firebase Console -> Project settings -> Your apps -> Web app -> Config
        const FIREBASE_CONFIG_PLACEHOLDER = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
          authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30",
          storageBucket: "ai-grading-9bb30.firebasestorage.app",
          messagingSenderId: "298162112230",
          appId: "1:298162112230:web:529d3f95536991be685d27",
          measurementId: "G-CHKLKSM17S"
        };

        // For local file execution or when hosted on your own domain,
        // you must replace this with the specific APP_ID from your Canvas environment URL.
        // This is the 'c_...' string that appears in the URL when you view this Canvas.
        // Example: "c_0aa637cf03094e15_gemini-grader-demo-878"
        const APP_ID_FROM_CANVAS_ENVIRONMENT = "c_03094e15"; 


        // Conditional assignment for running in Canvas vs. locally or on your own host
        const appId = typeof __app_id !== 'undefined' ? __app_id : APP_ID_FROM_CANVAS_ENVIRONMENT;
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : FIREBASE_CONFIG_PLACEHOLDER;


        let app;
        let db;
        let auth;
        let currentUserId = null;
        let currentUserRole = null;
        let currentUserName = null;
        let currentAuthReady = false; // Flag to indicate Firebase auth is ready

        // Function to show custom modal for general messages
        function showModal(title, message, buttons = []) {
            const modal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = ''; // Clear previous buttons

            buttons.forEach(btnConfig => {
                const button = document.createElement('button');
                button.textContent = btnConfig.text;
                button.className = btnConfig.className || 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg';
                button.onclick = () => {
                    modal.style.display = 'none';
                    if (btnConfig.onClick) btnConfig.onClick();
                };
                modalButtons.appendChild(button);
            });

            modal.style.display = 'flex';
        }

        // Close button for general message modal
        document.querySelector('#messageModal .close-button').onclick = () => {
            document.getElementById('messageModal').style.display = 'none';
        };
        // Close modal if clicked outside
        window.onclick = (event) => {
            if (event.target === document.getElementById('messageModal')) {
                document.getElementById('messageModal').style.display = 'none';
            }
        };

        // Function to show role selection modal
        function showRoleSelectionModal() {
            const roleModal = document.getElementById('roleSelectionModal');
            roleModal.style.display = 'flex';
        }

        // Initialize Firebase
        try {
            // Check if firebaseConfig is empty (likely if placeholders were not filled for local run)
            if (!firebaseConfig || !firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                throw new Error("Firebase configuration is missing or incomplete. Please replace the placeholders in the HTML code with your actual Firebase project details.");
            }
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showModal('Firebase Error', `Failed to initialize Firebase. Please check the configuration. Details: ${error.message}`);
        }

        // --- Auth State Listener ---
        onAuthStateChanged(auth, async (user) => {
            console.log("onAuthStateChanged fired. User:", user ? user.uid : "null");
            if (user) {
                currentUserId = user.uid;
                currentUserName = user.displayName || user.email || 'Anonymous User'; // Use Google name/email
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);

                try {
                    const profileDoc = await getDoc(userProfileRef);
                    if (profileDoc.exists() && profileDoc.data().role) {
                        const profileData = profileDoc.data();
                        currentUserRole = profileData.role;
                        currentUserName = profileData.name || currentUserName; // Prefer stored name if available
                        document.getElementById('userDisplayName').textContent = `Logged in as: ${currentUserName} (${currentUserRole})`;
                        document.getElementById('authSection').style.display = 'none';
                        document.getElementById('appSection').style.display = 'flex';
                        currentAuthReady = true;
                        console.log(`User profile loaded: Name=${currentUserName}, Role=${currentUserRole}`);
                        await loadPastSubmissions();
                    } else {
                        // User exists (Google logged in), but no role assigned in Firestore profile
                        console.log("User logged in with Google, but no role found. Prompting for role selection.");
                        showRoleSelectionModal();
                        document.getElementById('authSection').style.display = 'none'; // Keep auth section hidden
                        document.getElementById('appSection').style.display = 'none'; // Keep app section hidden until role is selected
                        currentAuthReady = true; // Auth system ready, just need role
                    }
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    currentAuthReady = true;
                    showModal('Profile Error', `Failed to load user profile. Details: ${error.message}`);
                    // Fallback: If profile fetch fails, stay on auth screen or show error
                    document.getElementById('authSection').style.display = 'flex';
                    document.getElementById('appSection').style.display = 'none';
                }

            } else {
                // User is logged out
                currentUserId = null;
                currentUserRole = null;
                currentUserName = null;
                console.log("User is logged out. Displaying auth section.");
                document.getElementById('userDisplayName').textContent = `Not logged in`;
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('appSection').style.display = 'none';
                currentAuthReady = true; // Auth system is ready, no user.
                document.getElementById('roleSelectionModal').style.display = 'none'; // Hide role modal if user logs out
            }
        });

        // --- Google Sign-In Function ---
        document.getElementById('googleSignInButton').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                // Use signInWithPopup for a new window authentication
                const result = await signInWithPopup(auth, provider);
                // User is signed in. onAuthStateChanged listener will handle UI update and role check.
                console.log("Google Sign-In successful:", result.user);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                const errorCode = error.code;
                const errorMessage = error.message;
                const credential = GoogleAuthProvider.credentialFromError(error);
                document.getElementById('authError').textContent = `Sign-in failed: ${errorMessage}`;
                showModal('Sign-In Error', `Failed to sign in with Google. Details: ${errorMessage}`);
            }
        });

        // --- Role Selection Handlers ---
        document.getElementById('selectStudentRole').addEventListener('click', () => saveUserRole('student'));
        document.getElementById('selectTeacherRole').addEventListener('click', () => saveUserRole('teacher'));

        async function saveUserRole(role) {
            if (!currentUserId) {
                console.error("No current user to save role for!");
                showModal('Error', 'No active user. Please try signing in again.');
                return;
            }

            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            try {
                await setDoc(userProfileRef, {
                    role: role,
                    name: auth.currentUser.displayName || auth.currentUser.email,
                    lastLogin: Date.now()
                }, { merge: true }); // Merge to update, not overwrite

                currentUserRole = role;
                currentUserName = auth.currentUser.displayName || auth.currentUser.email;
                document.getElementById('userDisplayName').textContent = `Logged in as: ${currentUserName} (${currentUserRole})`;
                document.getElementById('roleSelectionModal').style.display = 'none'; // Hide role modal
                document.getElementById('appSection').style.display = 'flex'; // Show main app
                showModal('Role Set', `You are now logged in as a ${role}!`);
                await loadPastSubmissions();
            } catch (error) {
                console.error("Error saving user role:", error);
                showModal('Role Save Error', `Failed to save your role. Details: ${error.message}`);
            }
        }


        document.getElementById('logoutButton').addEventListener('click', async () => {
            try {
                currentUserRole = null;
                currentUserName = null;
                currentUserId = null;
                document.getElementById('userDisplayName').textContent = `Not logged in`;
                document.getElementById('appSection').style.display = 'none';
                document.getElementById('authSection').style.display = 'flex';
                pastSubmissionsContainer.innerHTML = '';
                noSubmissionsMessage.style.display = 'block';

                await signOut(auth);
                showModal('Logged Out', 'You have been logged out successfully.');
            } catch (error) {
                console.error("Logout error:", error);
                showModal('Logout Error', `Failed to log out: ${error.message}`);
            }
        });


        // --- File Handling Functions ---
        async function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        const gradeButton = document.getElementById('gradeButton');
        const studentAnswerInput = document.getElementById('studentAnswer');
        const answerKeyInput = document.getElementById('answerKey');
        const studentAnswerFile = document.getElementById('studentAnswerFile');
        const answerKeyFile = document.getElementById('answerKeyFile');
        const studentFileNameDisplay = document.getElementById('studentFileName');
        const answerKeyFileNameDisplay = document.getElementById('answerKeyFileName');
        const studentFilePreview = document.getElementById('studentFilePreview');
        const answerKeyFilePreview = document.getElementById('answerKeyFilePreview');
        const gradeResultDisplay = document.getElementById('gradeResult');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const pastSubmissionsContainer = document.getElementById('pastSubmissions');
        const noSubmissionsMessage = document.getElementById('noSubmissions');

        studentAnswerFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                studentFileNameDisplay.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    studentFilePreview.src = e.target.result;
                    studentFilePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                studentFileNameDisplay.textContent = 'No file chosen';
                studentFilePreview.style.display = 'none';
                studentFilePreview.src = '';
            }
        });

        answerKeyFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                answerKeyFileNameDisplay.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    answerKeyFilePreview.src = e.target.result;
                    answerKeyFilePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                answerKeyFileNameDisplay.textContent = 'No file chosen';
                answerKeyFilePreview.style.display = 'none';
                answerKeyFilePreview.src = '';
            }
        });


        // --- Load Past Submissions from Firestore ---
        async function loadPastSubmissions() {
            if (!currentAuthReady || !currentUserId) {
                console.log("Auth not ready or no user (currentUserId is null), skipping loading past submissions.");
                pastSubmissionsContainer.innerHTML = '';
                noSubmissionsMessage.style.display = 'block';
                return;
            }

            pastSubmissionsContainer.innerHTML = ''; // Clear previous submissions
            noSubmissionsMessage.style.display = 'block'; // Show "No submissions" initially

            try {
                console.log(`Loading past submissions for user: ${currentUserId}`);
                // IMPORTANT: Ensure the path matches your Firestore security rules for private data
                const submissionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/submissions`);
                // Using getDocs for a one-time fetch when the user logs in
                const q = query(submissionsCollectionRef, orderBy('timestamp', 'desc')); // Order by timestamp
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log("No past submissions found for this user.");
                    noSubmissionsMessage.style.display = 'block';
                    return;
                }

                noSubmissionsMessage.style.display = 'none'; // Hide "No submissions" if there are submissions
                console.log(`Found ${querySnapshot.docs.length} past submissions.`);

                querySnapshot.forEach((doc) => {
                    const submission = doc.data();
                    const submissionElement = document.createElement('div');
                    submissionElement.className = 'bg-gray-100 p-4 rounded-lg shadow-sm border border-gray-200';
                    submissionElement.innerHTML = `
                        <h3 class="font-semibold text-lg text-gray-800 mb-2">Submission on ${new Date(submission.timestamp).toLocaleString()}</h3>
                        ${submission.studentAnswerText ? `<p class="text-gray-700"><strong>Student Answer (Text):</strong> ${submission.studentAnswerText.substring(0, 100)}...</p>` : ''}
                        ${submission.studentAnswerImageBase64 ? `<p class="text-gray-700"><strong>Student Work:</strong> <img src="data:image/jpeg;base64,${submission.studentAnswerImageBase64}" class="w-full h-auto max-h-40 object-contain rounded mt-2"></p>` : ''}
                        ${submission.answerKeyText ? `<p class="text-gray-700 mt-2"><strong>Answer Key (Text):</strong> ${submission.answerKeyText.substring(0, 100)}...</p>` : ''}
                        ${submission.answerKeyImageBase64 ? `<p class="text-gray-700 mt-2"><strong>Answer Key:</strong> <img src="data:image/jpeg;base64,${submission.answerKeyImageBase64}" class="w-full h-auto max-h-40 object-contain rounded mt-2"></p>` : ''}
                        <div class="mt-4">
                            <p class="font-medium text-indigo-600"><strong>Gemini Grade:</strong></p>
                            <p class="text-gray-800 text-sm mt-1">${submission.geminiGrade || 'N/A'}</p>
                        </div>
                    `;
                    pastSubmissionsContainer.appendChild(submissionElement);
                });
            } catch (error) {
                console.error("Error loading past submissions:", error);
                showModal('Error Loading Submissions', `Could not load past submissions. Details: ${error.message}`);
            }
        }


        // --- Main Grading Logic ---
        gradeButton.addEventListener('click', async () => {
            // Ensure user is authenticated and has a role
            if (!currentUserId || !currentUserRole) {
                showModal('Authentication Required', 'Please sign in to grade work and select your role.');
                return;
            }

            const studentAnswerText = studentAnswerInput.value.trim();
            const answerKeyText = answerKeyInput.value.trim();
            const studentFile = studentAnswerFile.files[0];
            const answerKeyFileObj = answerKeyFile.files[0];

            // Clear previous error messages
            document.getElementById('studentAnswerError').textContent = '';
            document.getElementById('answerKeyError').textContent = '';
            gradeResultDisplay.style.color = "black"; // Reset color

            if ((!studentAnswerText && !studentFile) || (!answerKeyText && !answerKeyFileObj)) {
                if (!studentAnswerText && !studentFile) {
                    document.getElementById('studentAnswerError').textContent = 'Please provide student answer via text or file.';
                }
                if (!answerKeyText && !answerKeyFileObj) {
                    document.getElementById('answerKeyError').textContent = 'Please provide answer key via text or file.';
                }
                gradeResultDisplay.textContent = "Please provide both student's answer (text or image) and the answer key (text or image).";
                gradeResultDisplay.style.color = "red";
                return;
            }

            loadingIndicator.style.display = 'block'; // Show loading indicator
            gradeButton.disabled = true; // Disable button during grading

            let studentImageBase64 = null;
            let answerKeyImageBase64 = null;
            let geminiPromptParts = [];

            try {
                // Read student file if provided
                if (studentFile) {
                    studentImageBase64 = await readFileAsBase64(studentFile);
                    geminiPromptParts.push({ text: "Here is the student's work:" });
                    geminiPromptParts.push({
                        inlineData: {
                            mimeType: studentFile.type,
                            data: studentImageBase64
                        }
                    });
                } else if (studentAnswerText) {
                    geminiPromptParts.push({ text: `Student's Answer:\n"${studentAnswerText}"` });
                }

                // Read answer key file if provided
                if (answerKeyFileObj) {
                    answerKeyImageBase64 = await readFileAsBase64(answerKeyFileObj);
                    geminiPromptParts.push({ text: "Here is the answer key:" });
                    geminiPromptParts.push({
                        inlineData: {
                            mimeType: answerKeyFileObj.type,
                            data: answerKeyImageBase64
                        }
                    });
                } else if (answerKeyText) {
                    geminiPromptParts.push({ text: `Answer Key:\n"${answerKeyText}"` });
                }

                // Add grading instructions to the prompt
                geminiPromptParts.push({ text: `\nYou are an expert exam grader.
                Compare the student's work/answer with the provided answer key.
                Provide a clear grade (e.g., "Excellent", "Good", "Needs Improvement", or a numerical score like "8/10").
                Also, provide specific feedback on what was correct, what was incorrect, and suggestions for improvement.

                Grading and Feedback:` });


                let chatHistory = [];
                chatHistory.push({ role: "user", parts: geminiPromptParts });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas provides this at runtime for testing purposes
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();
                let geminiGrade = "No grade generated.";

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    geminiGrade = result.candidates[0].content.parts[0].text;
                    gradeResultDisplay.textContent = geminiGrade;
                } else {
                    gradeResultDisplay.textContent = "Could not get a valid response from the Gemini API. Please try again.";
                }

                // --- Save Submission to Firestore ---
                // Save based on the current user's actual Firebase UID, linked to their role
                const submissionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/submissions`);
                const newSubmission = {
                    submittedBy: currentUserName,
                    submittedByRole: currentUserRole,
                    studentAnswerText: studentAnswerText || null,
                    studentAnswerImageBase64: studentImageBase64,
                    studentFileName: studentFile ? studentFile.name : null,
                    answerKeyText: answerKeyText || null,
                    answerKeyImageBase64: answerKeyImageBase64,
                    answerKeyFileName: answerKeyFileObj ? answerKeyFileObj.name : null,
                    geminiGrade: geminiGrade,
                    timestamp: Date.now()
                };
                await addDoc(submissionsCollectionRef, newSubmission);
                console.log("Submission saved to Firestore!");
                await loadPastSubmissions(); // Reload submissions to show the new one

            } catch (error) {
                console.error('Error in grading process:', error);
                gradeResultDisplay.textContent = `An error occurred while grading: ${error.message}. Please check the console for more details.`;
                showModal('Grading Error', `An unexpected error occurred during grading. Details: ${error.message}`);
            } finally {
                loadingIndicator.style.display = 'none'; // Hide loading indicator
                gradeButton.disabled = false; // Re-enable button
            }
        });
    </script>
</body>
</html>
