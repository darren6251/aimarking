<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Marker</title>
    <!-- PDF.js library for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- Custom styles -->
    <style>
        /* Base Dark Theme Variables */
        :root {
            --bg-primary: #0d1117; /* Black */
            --bg-secondary: #161b22; /* Dark Gray */
            --text-primary: #c9d1d9; /* Light Gray */
            --text-secondary: #8b949e; /* Muted gray for secondary text */
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --border-color: #30363d;
            --button-hover-darken: #21262d;
            --button-primary-lighten: #2ea043; /* Green hover */
            --button-blue-lighten: #4c9aff; /* Blue hover */
            --button-red-lighten: rgba(248, 81, 73, 0.1); /* Red hover */
            --neon-glow-color: #58a6ff; /* Neon blue for dark theme */
        }

        /* Light Theme Variables - Overrides for .light-theme class */
        body.light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f2f5;
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent-blue: #007bff;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --border-color: #cccccc;
            --button-hover-darken: #e2e6ea;
            --button-primary-lighten: #218838;
            --button-blue-lighten: #0069d9;
            --button-red-lighten: rgba(220, 53, 69, 0.1);
            --neon-glow-color: #007bff; /* Neon blue for light theme */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacMacSystemFont, "Segoe UI", "Inter", sans-serif;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            overflow-x: hidden;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        button,
        input,
        textarea,
        select {
            transition: all .2s ease-out;
            font-family: inherit;
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        /* Keyframe animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* LOGIN PAGE: Full screen wrapper */
        #authWrapper {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1001;
        }

        .login-left-panel,
        .login-right-panel {
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .login-left-panel {
            background: var(--bg-primary);
            color: var(--text-primary);
            flex-direction: column;
            text-align: center;
        }

        .login-left-panel h1 {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 1rem;
        }

        .login-left-panel p {
            font-size: 1.75rem;
            font-weight: 400;
            line-height: 1.3;
            margin-bottom: .5rem;
            color: var(--text-secondary);
        }

        .login-right-panel {
            background: var(--bg-secondary);
            flex-direction: column;
        }
        
        #authContainer {
            width: 100%;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            background-color: var(--bg-primary);
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #authContainer h2 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: .75rem;
            cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        .google-btn:hover { background-color: var(--button-hover-darken); border-color: var(--text-secondary); }
        .google-btn img { height: 20px; }
        
        #accessCodeInput {
             background-color: var(--bg-secondary);
             border: 1px solid var(--border-color);
             color: var(--text-primary);
             padding: 12px;
             border-radius: 6px;
             width: 100%;
             margin-bottom: 1rem;
             text-align: center;
        }
        #accessCodeInput:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
        }

        .btn-primary {
             background-color: var(--accent-green);
             color: #fff;
             padding: .75rem 1.5rem;
             border-radius: 6px;
             border: none;
             cursor: pointer;
             font-weight: 600;
        }
        .btn-primary:hover {
             background-color: var(--button-primary-lighten);
             transform: translateY(-1px);
        }
        
        #appSection {
            display: none;
            flex-direction: column;
            height: 100vh;
            background-color: var(--bg-primary);
            animation: fadeIn .6s ease-out both;
        }
        
        header {
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            padding: 0 24px;
            height: 64px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .logo-container { display: flex; align-items: center; gap: 1rem; }
        .logo-container h1 { font-size: 1.5rem; font-weight: 700; }
        .logo-container p { font-weight: 400; color: var(--text-secondary); }
        
        .header-actions { margin-left: auto; display: flex; align-items: center; gap: 1rem; }

        /* --- START: NEON BUTTON STYLES --- */
        .header-actions .tab.neon-button {
            position: relative;
            display: inline-block;
            padding: 10px 18px; /* Adjusted padding */
            color: var(--neon-glow-color);
            text-decoration: none;
            overflow: hidden;
            transition: .5s;
            border: 1px solid var(--neon-glow-color);
            border-radius: 6px;
            background: transparent;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.875rem; /* Adjusted font size */
        }
        
        .header-actions .tab.neon-button:hover,
        .header-actions .tab.neon-button.active {
            background: var(--neon-glow-color);
            color: var(--bg-secondary);
            border-radius: 6px;
            box-shadow: 0 0 5px var(--neon-glow-color),
                        0 0 25px var(--neon-glow-color),
                        0 0 50px var(--neon-glow-color),
                        0 0 100px var(--neon-glow-color);
        }

        .header-actions .tab.neon-button span {
            position: absolute;
            display: block;
        }

        .header-actions .tab.neon-button span:nth-child(1) {
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--neon-glow-color));
            animation: btn-anim1 1.5s linear infinite;
        }

        @keyframes btn-anim1 {
            0% { left: -100%; }
            50%,100% { left: 100%; }
        }

        .header-actions .tab.neon-button span:nth-child(2) {
            top: -100%;
            right: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, transparent, var(--neon-glow-color));
            animation: btn-anim2 1.5s linear infinite;
            animation-delay: .375s
        }

        @keyframes btn-anim2 {
            0% { top: -100%; }
            50%,100% { top: 100%; }
        }

        .header-actions .tab.neon-button span:nth-child(3) {
            bottom: 0;
            right: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(270deg, transparent, var(--neon-glow-color));
            animation: btn-anim3 1.5s linear infinite;
            animation-delay: .75s
        }

        @keyframes btn-anim3 {
            0% { right: -100%; }
            50%,100% { right: 100%; }
        }

        .header-actions .tab.neon-button span:nth-child(4) {
            bottom: -100%;
            left: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(360deg, transparent, var(--neon-glow-color));
            animation: btn-anim4 1.5s linear infinite;
            animation-delay: 1.125s
        }

        @keyframes btn-anim4 {
            0% { bottom: -100%; }
            50%,100% { bottom: 100%; }
        }
        /* --- END: NEON BUTTON STYLES --- */


        .user-info { display: flex; align-items: center; gap: 1rem; }
        #userDisplayName { font-weight: 500; cursor: pointer; }
        .logout-btn { background: none; border: 1px solid var(--accent-red); color: var(--accent-red); cursor: pointer; padding: 6px 12px; border-radius: 6px; font-weight: 600; }
        .logout-btn:hover { background: var(--button-red-lighten); }
        /* Style for Switch Role button */
        #switchRoleButton {
            background-color: var(--accent-blue);
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        #switchRoleButton:hover {
            background-color: var(--button-blue-lighten);
        }

        /* --- START: DROPDOWN STYLES --- */
        .dropdown-menu {
            position: relative;
            display: inline-block;
            /* Add padding to the bottom to bridge the gap between button and menu */
            padding-bottom: 10px;
            margin-bottom: -10px; /* Counteract the padding to maintain alignment */
        }
        
        .dropdown-menu-content {
            display: none; /* Hidden by default */
            position: absolute;
            top: 100%; /* Position it right below the button container */
            left: 0;
            background-color: var(--bg-secondary); /* Dropdown background */
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
            z-index: 10; /* Ensure it appears above other content */
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding: 4px;
        }

        .dropdown-menu-content button {
            color: var(--text-primary);
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.875rem; /* Ensure consistent font size */
        }
        
        .dropdown-menu-content button:hover {
            background-color: var(--button-hover-darken);
            color: var(--accent-blue);
        }

        /* Show the dropdown menu on hover */
        .dropdown-menu:hover .dropdown-menu-content {
            display: block;
        }
        /* --- END: DROPDOWN STYLES --- */


        main {
            flex: 1;
            display: flex;
            overflow-y: auto;
            padding: 24px;
            gap: 24px;
            padding-bottom: 100px;
        }
        
        /* Content Sections */
        #homeSection, #gradingSection, #chatSection, #studentManagementSection, #profileSection, #tutorialSection, #pastPapersSection {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            width: 100%;
        }
        #profileSection { max-width: 800px; margin: 0 auto; }

        /* Form elements */
        label { display: block; font-weight: 600; margin-bottom: 8px; }
        input[type="text"], input[type="number"], input[type="email"], select, input[type="url"] {
            width: 100%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 12px; border-radius: 6px; margin-bottom: 1rem;
        }
        textarea {
            width: 100%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 12px; border-radius: 6px; margin-bottom: 1rem; resize: vertical; min-height: 120px;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3); }
        
        .drop-zone { border: 2px dashed var(--border-color); border-radius: 6px; min-height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 1rem; margin-bottom: 1.5rem; cursor: pointer; word-wrap: break-word; padding: 1rem; text-align: center; }
        .drop-zone.highlight { border-color: var(--accent-blue); background: rgba(88, 166, 255, .1); }
        
        .file-preview { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; max-height: 200px; object-fit: contain; }
        .error-message { color: var(--accent-red); font-size: 0.875rem; margin-top: -0.5rem; margin-bottom: 1rem; }

        #gradeButton { background-color: var(--accent-green); color: #fff; }
        #gradeButton:hover { background-color: var(--button-primary-lighten); }

        #resultContainer { margin-top: 1.5rem; padding: 1rem; border-radius: 6px; background-color: var(--bg-secondary); border: 1px solid var(--border-color); min-height: 100px; white-space: pre-wrap; }
        #pastSubmissions { margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .submission-card { background-color: var(--bg-secondary); padding: 1rem; border-radius: 6px; border: 1px solid var(--border-color); }

        /* Chat styles */
        #chatSection, #studentManagementSection { display: none; flex-direction: column; gap: 1rem; }
        #chatDisplay { flex: 1; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { max-width: 85%; padding: 10px 14px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; }
        .chat-message.user { background-color: var(--accent-blue); color: var(--bg-primary); align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-message.gemini { background-color: var(--button-hover-darken); align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-input-wrapper { display: flex; gap: .5rem; flex-shrink: 0; }
        #chatInput { flex: 1; padding: .75rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-secondary); color: var(--text-primary); }
        #sendChatButton { padding: .5rem 1rem; border: none; background: var(--accent-blue); color: var(--bg-primary); border-radius: 6px; font-weight: 600; cursor: pointer; }
        #sendChatButton:hover { background-color: var(--button-blue-lighten); }
        
        .loading-indicator { text-align: center; padding: 1rem; color: var(--text-secondary); }

        /* Universal Section Title */
        .section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; }

        /* Form container */
        .form-container { max-width: 600px; margin-bottom: 2rem; background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color); }
        
        /* Student Management Styles */
        #authorizedStudentsList { display: flex; flex-direction: column; gap: 0.5rem; }
        .student-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-secondary); padding: 0.75rem 1rem; border-radius: 6px; border: 1px solid var(--border-color); }
        .delete-student-btn { background: none; border: none; color: var(--accent-red); cursor: pointer; padding: 4px; }
        .delete-student-btn:hover { background-color: var(--button-red-lighten); border-radius: 50%; }

        /* Universal Filter Styles */
        .filters-container { display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; flex-wrap: wrap; }
        
        /* Universal Grid Styles */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        
        /* Tutorial Card Styles */
        .tutorial-card { background-color: var(--bg-secondary); border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); display: flex; flex-direction: column; position:relative; }
        .tutorial-card-thumbnail { position: relative; }
        .tutorial-card-thumbnail img { width: 100%; display: block; aspect-ratio: 16/9; object-fit: cover; }
        .tutorial-card-duration { position: absolute; bottom: 8px; right: 8px; background-color: rgba(0,0,0,0.8); color: white; padding: 2px 6px; font-size: 0.75rem; border-radius: 4px; }
        .tutorial-card-content { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; }
        .tutorial-card-content h3 { font-size: 1.1rem; margin-bottom: 0.5rem; }
        
        /* Teacher Content Management Styles (Tutorials & Past Papers) */
        .content-item { padding: 1rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 1rem; background: var(--bg-primary); }
        .content-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .content-header h3, .content-header h4 { margin: 0; }
        .item-actions button { margin-left: 0.5rem; padding: 4px 8px; font-size: 0.8rem; }
        .nested-container { padding-left: 1.5rem; margin-top: 1rem; border-left: 2px solid var(--border-color); display: none; }
        .sub-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 4px; }
        .sub-item:hover { background-color: var(--button-hover-darken); }

        /* Past Paper Specific Styles */
        .paper-item a { color: var(--accent-blue); text-decoration: none; }
        .paper-item a:hover { text-decoration: underline; }

        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; animation: fadeIn 0.3s ease-out; }
        .modal-content { background-color: var(--bg-secondary); padding: 30px; border-radius: 8px; border: 1px solid var(--border-color); max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; animation: slideInUp 0.3s ease-out; }
        #modalTitle { margin-bottom: 1rem; font-size: 1.5rem; font-weight: 600; }
        #modalMessage { line-height: 1.5; }
        .close-button { position: absolute; top: 10px; right: 15px; font-size: 28px; cursor: pointer; color: var(--text-secondary); }
        .close-button:hover { color: var(--text-primary); }
        #modalButtons { display:flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }

        /* Footer */
        footer { position: fixed; bottom: 0; right: 0; text-align: right; padding: 10px 20px; color: var(--text-secondary); font-size: 0.875rem; z-index: 100; pointer-events: none; }
        footer a { color: var(--accent-blue); text-decoration: none; pointer-events: all;}
        footer a:hover { text-decoration: underline; }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            #authWrapper { flex-direction: column; position: static; height: auto; }
            .login-left-panel, .login-right-panel { width: 100%; }
            header { flex-direction: column; height: auto; padding: 1rem; align-items: flex-start; }
            .header-actions { margin-left: 0; margin-top: 1rem; flex-wrap: wrap; }
            main { flex-direction: column; }
            /* Home page specific responsive adjustments */
            .hero { flex-direction: column-reverse; text-align: center; }
            .hero-text, .hero-image { max-width: 100%; }
            .buttons { justify-content: center; }
        }

        /* Hero */
        .hero {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2rem 1.5rem;
            position: relative;
            overflow: hidden;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .hero-text {
            max-width: 50%;
            font-size: 2rem;
            font-weight: bold;
            opacity: 0;
            animation: slideInLeft 1s ease-out forwards;
        }
        .hero-text span {
            display: block;
            font-size: 1.5rem;
            font-weight: normal;
            margin-top: 0.5rem;
            color: var(--accent-blue);
        }
        .hero-image {
            max-width: 40%;
            opacity: 0;
            animation: slideInRight 1s ease-out forwards;
        }
        .hero-image img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* Buttons (on Home Page Hero) */
        .buttons {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
        }
        .buttons a {
            padding: 0.6rem 1.2rem;
            border: 2px solid var(--accent-blue);
            border-radius: 4px;
            font-size: 1rem;
            transition: background 0.2s, color 0.2s;
            color: var(--accent-blue);
            text-decoration: none;
        }
        .buttons a:hover {
            background: var(--accent-blue);
            color: #fff;
        }

        /* Why AI Section */
        .why-ai {
            padding: 2rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            margin-top: 2rem;
            border-radius: 8px;
        }
        .why-ai h2 {
            font-size: 1.75rem;
            margin-bottom: 1rem;
            color: var(--accent-green);
        }
        .why-ai p {
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Animations */
        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to   { transform: translateX(0);    opacity: 1; }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to   { transform: translateX(0);    opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="authWrapper" style="display: none;">
        <div class="login-left-panel">
            <h1>Let AI mark your work.</h1>
            <p>Let AI assist you, not replace you</p>
            <p>Mark with AI, learn better</p>
        </div>
        <div class="login-right-panel">
            <div id="authContainer">
                 <!-- JS will inject googleSignInTemplate or codeEntryTemplate here -->
            </div>
        </div>
    </div>

    <div id="appSection" style="display: none;">
        <header>
            <div class="logo-container">
                <h1>AI Marker</h1>
                <p>Operated by Darren Ng</p>
            </div>
            <div class="header-actions">
                <button id="toggleHomeButton" class="tab neon-button active">
                    <span></span><span></span><span></span><span></span>
                    Home
                </button>
                
                <!-- "Work with AI" Dropdown Group -->
                <div class="dropdown-menu">
                    <button class="tab neon-button" id="workWithAIButton">
                        <span></span><span></span><span></span><span></span>
                        Work with AI
                    </button>
                    <div class="dropdown-menu-content">
                        <button id="toggleGradingButton" class="tab">Exam Grader</button>
                        <button id="toggleChatButton" class="tab">Chat with Gemini</button>
                    </div>
                </div>

                <!-- NEW "Materials" Dropdown Group -->
                <div class="dropdown-menu">
                    <button class="tab neon-button" id="materialsButton">
                        <span></span><span></span><span></span><span></span>
                        Materials
                    </button>
                    <div class="dropdown-menu-content">
                        <button id="toggleTutorialButton" class="tab">Tutorial Videos</button>
                        <button id="togglePastPapersButton" class="tab">Past Papers</button>
                    </div>
                </div>

                <button id="manageStudentsButton" class="tab neon-button" style="display: none;">
                    <span></span><span></span><span></span><span></span>
                    Manage Students
                </button>
                <button id="toggleProfileButton" class="tab neon-button">
                    <span></span><span></span><span></span><span></span>
                    Profile
                </button>
                <button id="themeToggleButton" class="tab neon-button">
                    <span></span><span></span><span></span><span></span>
                    Theme
                </button>
                <div class="user-info">
                     <span id="userDisplayName"></span>
                     <button id="switchRoleButton" class="btn-primary">Switch Role</button>
                     <button id="logoutButton" class="logout-btn">Log Out</button>
                </div>
            </div>
        </header>
        
        <main>
            <!-- Home Section -->
            <div id="homeSection" style="display: block; opacity: 1;">
                <section class="hero">
                    <div class="hero-text">
                        AI helps you learn better
                        <span>to fight DSE</span>
                        <div class="buttons">
                            <a href="#tutorial" id="homeTutorialLink">Tutorial Video</a>
                            <a href="#grader" id="homeGraderLink">Exam Grader</a>
                            <a href="#chat" id="homeChatLink">Chat with AI</a>
                        </div>
                    </div>
                    <div class="hero-image">
                        <img src="https://drive.google.com/uc?export=download&id=1wdjIr6SjqlgEjulvbpuNa08HHSMX623t" alt="Darren Ng demonstrating AI Marker">
                    </div>
                </section>

                <section class="why-ai" id="why-ai">
                    <h2>Why AI</h2>
                    <p>
                        AI serves as a powerful assistant in your studies, especially when preparing for challenging exams like DSE. It can provide instant feedback on your work, identify areas where you need improvement, and offer personalized explanations. Unlike traditional methods, AI can analyze vast amounts of information and adapt to your learning style, making your study sessions more efficient and effective. It helps you grasp complex concepts, practice critical thinking, and build confidence, ultimately empowering you to perform your best.
                    </p>
                </section>
            </div>

            <!-- Grading Section -->
            <div id="gradingSection">
                <h2 class="section-title">Exam Grader</h2>
                <div class="mb-4">
                    <label>Upload Student's Work (Image or PDF):</label>
                    <div id="studentDropZone" class="drop-zone">
                        <span>Drag & Drop Student's Work Here or click to select</span>
                        <input type="file" id="studentAnswerFile" accept="image/*,application/pdf" hidden>
                    </div>
                     <span id="studentFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                    <img id="studentFilePreview" class="file-preview mx-auto" style="display: none;" alt="Student Work Preview">
                    <label for="studentAnswer">Or type Student's Answer:</label>
                    <textarea id="studentAnswer" placeholder="Enter student's answer here..."></textarea>
                    <p id="studentAnswerError" class="error-message"></p>
                </div>

                <div class="mb-6">
                    <label>Upload Answer Key (Image or PDF):</label>
                    <div id="answerKeyDropZone" class="drop-zone">
                        <span>Drag & Drop Answer Key Here or click to select</span>
                         <input type="file" id="answerKeyFile" accept="image/*,application/pdf" hidden>
                    </div>
                    <span id="answerKeyFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                    <img id="answerKeyFilePreview" class="file-preview mx-auto" style="display: none;" alt="Answer Key Preview">
                    <label for="answerKey">Or type Answer Key:</label>
                    <textarea id="answerKey" placeholder="Enter the correct answer key here..."></textarea>
                    <p id="answerKeyError" class="error-message"></p>
                </div>

                <button id="gradeButton" class="btn-primary">Grade Work</button>
                <p id="gradingLoadingIndicator" class="loading-indicator"></p>
                <div id="resultContainer">
                    <h2>Grading Results:</h2>
                    <p id="gradeResult">Your grading results will appear here.</p>
                </div>

                <div style="margin-top: 2rem;">
                    <h2>Past Submissions:</h2>
                    <div id="pastSubmissions">
                        <p id="noSubmissions">No past submissions found.</p>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="chatSection">
                <div id="chatDisplay">
                    <div class="chat-message gemini">Hello! How can I help you today?</div>
                </div>
                <div class="chat-input-wrapper">
                    <input type="text" id="chatInput" placeholder="Type a message…">
                    <button id="sendChatButton">Send</button>
                </div>
                 <p id="chatLoadingIndicator" class="loading-indicator"></p>
            </div>

            <!-- Student Management Section -->
            <div id="studentManagementSection">
                <h2 class="section-title">Manage Authorized Students</h2>
                <div class="add-student-form form-container">
                    <input type="email" id="studentEmailInput" placeholder="Enter student's Gmail address">
                    <button id="addStudentButton" class="btn-primary">Add Student</button>
                </div>
                <p id="studentManagementLoading" class="loading-indicator"></p>
                <div id="authorizedStudentsList">
                    <p id="noAuthorizedStudents">No authorized students yet.</p>
                </div>
            </div>

            <!-- Tutorial Section -->
            <div id="tutorialSection">
                 <h2 class="section-title">Tutorial Videos</h2>

                 <!-- Teacher View -->
                 <div id="teacherTutorialView" style="display:none;">
                     <div class="form-container" style="max-width: initial;">
                         <button id="addSubjectBtn" class="btn-primary">Add New Subject</button>
                     </div>
                     <div id="subjectsContainer">
                        <p class="loading-indicator">Loading subjects...</p>
                     </div>
                 </div>
                 
                 <!-- Student View -->
                 <div id="studentTutorialView" style="display:none;">
                     <div class="filters-container">
                         <select id="subjectFilter" style="width:250px;">
                             <option value="">-- Select a Subject --</option>
                         </select>
                         <select id="topicFilter" style="width:250px;" disabled>
                             <option value="">-- Select a Topic --</option>
                         </select>
                     </div>
                     <div id="tutorialGrid" class="grid-container">
                         <p id="noTutorials">Please select a subject and topic to see videos.</p>
                     </div>
                 </div>
            </div>
            
            <!-- NEW: Past Papers Section -->
            <div id="pastPapersSection">
                <h2 class="section-title">Past Papers</h2>

                <!-- Teacher View for Past Papers -->
                <div id="teacherPastPapersView" style="display:none;">
                    <div class="form-container" style="max-width: initial;">
                        <button id="addPaperSubjectBtn" class="btn-primary">Add New Subject</button>
                    </div>
                    <div id="paperSubjectsContainer">
                        <p class="loading-indicator">Loading subjects...</p>
                    </div>
                </div>

                <!-- Student View for Past Papers -->
                <div id="studentPastPapersView" style="display:none;">
                    <div class="filters-container">
                         <select id="paperSubjectFilter" style="width:250px;">
                             <option value="">-- Select a Subject --</option>
                         </select>
                         <select id="paperYearFilter" style="width:250px;" disabled>
                             <option value="">-- Select a Year --</option>
                         </select>
                    </div>
                    <div id="papersGrid" class="grid-container">
                        <p id="noPapers">Please select a subject and year to see papers.</p>
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profileSection">
                <h2 class="section-title">Edit Your Profile</h2>
                <form id="profileForm" class="form-container">
                    <div style="margin-bottom: 1rem;">
                        <label for="profileName">Display Name</label>
                        <input type="text" id="profileName" name="name" required>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileAge">Age</label>
                        <input type="number" id="profileAge" name="age">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileGrade">Year/Grade</label>
                        <input type="text" id="profileGrade" name="grade">
                    </div>
                     <div style="margin-bottom: 1rem;">
                        <label for="profileSchool">School</label>
                        <input type="text" id="profileSchool" name="school">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileElectives">Elective Subjects</label>
                        <textarea id="profileElectives" name="electives" placeholder="e.g., Physics, Computer Science, Art"></textarea>
                    </div>
                    <button type="submit" id="saveProfileButton" class="btn-primary">Save Profile</button>
                </form>
            </div>
        </main>
    </div>

    <footer>
        <a href="mailto:darren_0625@mc-zero.com">Contact: darren_0625@mc-zero.com</a> | Copyright © 2025 Operated by Darren Ng
    </footer>

    <!-- Universal Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle"></h3>
            <div id="modalMessage"></div>
            <div id="modalButtons"></div>
        </div>
    </div>
    
    <!-- Add Video Form Modal -->
    <div id="addVideoModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3>Add New Tutorial Video</h3>
             <form id="addVideoForm">
                <input type="hidden" id="videoSubjectId">
                <input type="hidden" id="videoTopicId">
                 <div style="margin-bottom: 1rem;">
                     <label for="tutorialLink">YouTube Video Link</label>
                     <input type="text" id="tutorialLink" required placeholder="https://www.youtube.com/watch?v=...">
                     <img id="tutorialThumbnailPreview" style="max-width:200px; margin-top:10px; border-radius:8px; display:none;" alt="Video Thumbnail Preview"/>
                 </div>
                 <div style="margin-bottom: 1rem;">
                     <label for="tutorialTitle">Video Title</label>
                     <input type="text" id="tutorialTitle" required>
                 </div>
                 <div id="modalButtons">
                    <button type="submit" class="btn-primary">Add Video</button>
                 </div>
             </form>
        </div>
    </div>

    <!-- NEW: Add Past Paper Form Modal -->
    <div id="addPastPaperModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3>Add New Past Paper</h3>
             <form id="addPastPaperForm">
                <input type="hidden" id="paperSubjectId">
                <input type="hidden" id="paperYearId">
                 <div style="margin-bottom: 1rem;">
                     <label for="pastPaperName">Paper Name / Title</label>
                     <input type="text" id="pastPaperName" required placeholder="e.g., Paper 1 Section A">
                 </div>
                 <div style="margin-bottom: 1rem;">
                     <label for="pastPaperLink">Download Link</label>
                     <input type="url" id="pastPaperLink" required placeholder="https://example.com/paper.pdf">
                 </div>
                 <div id="modalButtons">
                    <button type="submit" class="btn-primary">Add Paper</button>
                 </div>
             </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
          authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30",
          storageBucket: "ai-grading-9bb30.firebasestorage.app",
          messagingSenderId: "298162112230",
          appId: "1:298162112230:web:529d3f95536991be685d27",
          measurementId: "G-CHKLKSM17S"
        };
        
        // __app_id is a global variable provided by the Canvas environment.
        // If running outside Canvas, 'default-app-id' is used as a fallback.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const CLOUDFLARE_WORKER_URL = "https://ai-marker-gemini-proxy.darren-xie11.workers.dev/";
        const TEACHER_CODE = "TEACHER123";
        const STUDENT_CODE = "STUDENT456";

        // Set PDF.js worker source to prevent cross-origin issues
        pdfjsLib.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let app, db, auth, storage;
        let currentUserId = null, currentUserEmail = null, currentUserRole = null, currentUserName = null;
        // Initialize chat history with a system instruction and a greeting from the model
        let geminiChatHistory = [{ role: "user", parts: [{text: "You are an AI assistant."}]}, { role: "model", parts: [{text: "Hello! How can I assist you?"}]}];

        const authWrapper = document.getElementById('authWrapper');
        const appSection = document.getElementById('appSection');
        const authContainer = document.getElementById('authContainer');

        const googleSignInTemplate = `
            <h2>Sign In</h2>
            <button id="googleSignInButton" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
                <span>Sign in with Google</span>
            </button>
            <p id="authError" class="error-message"></p>
        `;

        const codeEntryTemplate = `
            <h2>Enter Access Code</h2>
            <p style="color: var(--text-secondary); text-align: center; margin-bottom: 1rem;">Please enter the access code provided by your administrator.</p>
            <input type="text" id="accessCodeInput" placeholder="Enter code here">
            <button id="submitCodeButton" class="btn-primary" style="width:100%">Submit Code</button>
            <p id="codeError" class="error-message"></p>
        `;

        // Initialize Firebase
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showModal('Firebase Configuration Error', `Failed to initialize Firebase. Please check your console for details. Error: ${error.message}`);
        }

        // Listen for Firebase authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                currentUserEmail = user.email;
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                try {
                    const userProfileDoc = await getDoc(userProfileRef);
                    if (userProfileDoc.exists() && userProfileDoc.data().role) {
                        const profileData = userProfileDoc.data();
                        currentUserRole = profileData.role;
                        currentUserName = profileData.name || user.displayName;
                        await setDoc(userProfileRef, { name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                        showApp();
                    } else {
                        currentUserName = user.displayName;
                        currentUserRole = 'unassigned';
                        showCodeEntry();
                    }
                } catch (e) {
                     console.error("Error checking user profile:", e);
                     showModal('Profile Error', `Could not load user profile. Please try again. Error: ${e.message}`);
                     showLogin();
                }
            } else {
                currentUserId = null;
                currentUserRole = null;
                currentUserName = null;
                showLogin();
            }
        });

        // Displays the login section
        function showLogin() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authWrapper.style.opacity = '1';
            authContainer.innerHTML = googleSignInTemplate;
            document.getElementById('googleSignInButton')?.addEventListener('click', handleGoogleSignIn);
        }

        // Displays the access code entry section
        function showCodeEntry() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authWrapper.style.opacity = '1';
            authContainer.innerHTML = codeEntryTemplate;
            const submitCodeBtn = document.getElementById('submitCodeButton');
            const accessCodeInput = document.getElementById('accessCodeInput');
            submitCodeBtn?.addEventListener('click', () => handleSubmitCode());
            accessCodeInput?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSubmitCode();
                }
            });
            accessCodeInput?.focus();
        }

        // Displays the main application section
        function showApp() {
            authWrapper.style.display = 'none';
            appSection.style.display = 'flex';
            document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
            document.getElementById('manageStudentsButton').style.display = currentUserRole === 'teacher' ? 'block' : 'none';
            
            // Initialize content sections based on role
            setupTutorialSection();
            setupPastPapersSection();

            // Default to Home section on app load
            showSection('homeSection');
            loadPastSubmissions();
            if(currentUserRole === 'teacher') loadAuthorizedStudents();

            // Home page links
            document.getElementById('homeTutorialLink')?.addEventListener('click', (e) => { e.preventDefault(); showSection('tutorialSection'); });
            document.getElementById('homeGraderLink')?.addEventListener('click', (e) => { e.preventDefault(); showSection('gradingSection'); });
            document.getElementById('homeChatLink')?.addEventListener('click', (e) => { e.preventDefault(); showSection('chatSection'); });
        }

        // Handles Google Sign-In
        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try { 
                await signInWithPopup(auth, provider); 
            } catch (error) { 
                document.getElementById('authError').textContent = `Sign-in failed. Error: ${error.message}`; 
                console.error("Google Sign-In Error:", error);
            }
        }

        // Handles submission of access code
        async function handleSubmitCode(codeValue) {
            const code = (codeValue || document.getElementById('accessCodeInput').value).trim();
            const codeError = document.getElementById('codeError');
            if(codeError) codeError.textContent = '';
            
            let roleToSet = null;
            if (code === TEACHER_CODE) roleToSet = 'teacher';
            else if (code === STUDENT_CODE) roleToSet = 'student';
            else { 
                if(codeError) codeError.textContent = 'Invalid access code.';
                return; 
            }
            
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await setDoc(userProfileRef, { role: roleToSet, name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                currentUserRole = roleToSet;
                showModal('Success!', `Your role has been set to ${roleToSet}.`);
                showApp();
            } catch (error) {
                if(codeError) codeError.textContent = `Could not set role. Error: ${error.message}`;
                console.error("Submit Code Error:", error);
            }
        }

        // Event listener for logout
        document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));

        // Event listener for Switch Role
        document.getElementById('switchRoleButton').addEventListener('click', () => {
            showInputModal('Switch Role', 'Enter new access code (Teacher or Student):', async (code) => {
                await handleSubmitCode(code);
            });
        });

        // Function to show a specific section of the app
        function showSection(sectionIdToShow) {
            const sections = ['homeSection', 'gradingSection', 'chatSection', 'studentManagementSection', 'profileSection', 'tutorialSection', 'pastPapersSection'];
            const buttons = {
                toggleHomeButton: 'homeSection',
                workWithAIButton: ['gradingSection', 'chatSection'],
                materialsButton: ['tutorialSection', 'pastPapersSection'],
                manageStudentsButton: 'studentManagementSection',
                toggleProfileButton: 'profileSection'
            };
            
            document.querySelectorAll('.header-actions .tab.neon-button').forEach(t => t.classList.remove('active'));

            let activeButtonId = null;
            for (const [btnId, secId] of Object.entries(buttons)) {
                if (Array.isArray(secId) && secId.includes(sectionIdToShow)) {
                    activeButtonId = btnId;
                    break;
                }
                if (secId === sectionIdToShow) {
                    activeButtonId = btnId;
                    break;
                }
            }
            if (activeButtonId) {
                document.getElementById(activeButtonId)?.classList.add('active');
            }

            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    const isTarget = id === sectionIdToShow;
                    section.style.display = isTarget ? (id === 'chatSection' || id === 'studentManagementSection' ? 'flex' : 'block') : 'none';
                    setTimeout(() => section.style.opacity = isTarget ? '1' : '0', 10);
                }
            });

            if (sectionIdToShow === 'profileSection') loadProfileData();
        }

        // Sets up event listeners for section toggle buttons
        function setupSectionToggle() {
            document.getElementById('toggleHomeButton')?.addEventListener('click', () => showSection('homeSection'));
            document.getElementById('toggleGradingButton')?.addEventListener('click', () => showSection('gradingSection'));
            document.getElementById('toggleChatButton')?.addEventListener('click', () => showSection('chatSection'));
            document.getElementById('manageStudentsButton')?.addEventListener('click', () => showSection('studentManagementSection'));
            document.getElementById('toggleProfileButton')?.addEventListener('click', () => showSection('profileSection'));
            document.getElementById('toggleTutorialButton')?.addEventListener('click', () => showSection('tutorialSection'));
            document.getElementById('togglePastPapersButton')?.addEventListener('click', () => showSection('pastPapersSection')); // NEW
            document.getElementById('userDisplayName')?.addEventListener('click', () => showSection('profileSection'));
        }
        setupSectionToggle();
        
        // Profile Management
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) { showModal('Error', 'You must be logged in to save your profile.'); return; }
            
            const formData = new FormData(e.target);
            const profileData = Object.fromEntries(formData.entries());
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            try {
                await setDoc(userProfileRef, profileData, { merge: true });
                currentUserName = profileData.name;
                document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
                showModal('Success', 'Your profile has been updated!');
            } catch (error) {
                console.error("Error saving profile:", error);
                showModal('Error', `Could not save profile: ${error.message}`);
            }
        });

        async function loadProfileData() {
            if (!currentUserId) return;
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            const docSnap = await getDoc(userProfileRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('profileName').value = data.name || '';
                document.getElementById('profileAge').value = data.age || '';
                document.getElementById('profileGrade').value = data.grade || '';
                document.getElementById('profileSchool').value = data.school || '';
                document.getElementById('profileElectives').value = data.electives || '';
            }
        }
        
        // --- TUTORIALS SECTION LOGIC ---
        const subjectsRef = collection(db, `artifacts/${appId}/public/data/subjects`);

        function setupTutorialSection() {
            const isTeacher = currentUserRole === 'teacher';
            document.getElementById('teacherTutorialView').style.display = isTeacher ? 'block' : 'none';
            document.getElementById('studentTutorialView').style.display = isTeacher ? 'none' : 'block';
            if (isTeacher) {
                setupTeacherTutorialView();
            } else {
                setupStudentTutorialView();
            }
        }
        
        function setupTeacherTutorialView() {
            renderTeacherSubjects();
            document.getElementById('addSubjectBtn').onclick = () => handleAddContentItem('subject');
            const container = document.getElementById('subjectsContainer');
            container.addEventListener('click', teacherContentClickHandler);
        }

        async function renderTeacherSubjects() {
            const container = document.getElementById('subjectsContainer');
            container.innerHTML = '<p class="loading-indicator">Loading subjects...</p>';
            const q = query(subjectsRef, orderBy('name'));
            const querySnapshot = await getDocs(q);
            container.innerHTML = querySnapshot.empty ? '<p>No subjects created yet.</p>' : '';
            querySnapshot.forEach(doc => {
                const subject = doc.data();
                const el = document.createElement('div');
                el.className = 'content-item';
                el.innerHTML = `
                    <div class="content-header" data-type="subject" data-id="${doc.id}">
                        <h3>${subject.name}</h3>
                        <div class="item-actions">
                            <button class="add-topic-btn btn-primary" data-subject-id="${doc.id}">Add Topic</button>
                            <button class="delete-btn logout-btn" data-type="subject" data-id="${doc.id}">Delete</button>
                        </div>
                    </div>
                    <div class="nested-container" id="topics-container-${doc.id}"></div>
                `;
                container.appendChild(el);
            });
        }
        
        async function renderTeacherTopics(subjectId) {
            const topicsRef = collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics`);
            const container = document.getElementById(`topics-container-${subjectId}`);
            container.innerHTML = '<p class="loading-indicator">Loading topics...</p>';
            const q = query(topicsRef, orderBy('name'));
            const querySnapshot = await getDocs(q);
            container.innerHTML = querySnapshot.empty ? '<p>No topics yet.</p>' : '';
            querySnapshot.forEach(doc => {
                const topic = doc.data();
                const el = document.createElement('div');
                el.className = 'content-item';
                el.innerHTML = `
                    <div class="content-header" data-type="topic" data-subject-id="${subjectId}" data-id="${doc.id}">
                        <h4>${topic.name}</h4>
                        <div class="item-actions">
                            <button class="add-video-btn btn-primary" data-subject-id="${subjectId}" data-topic-id="${doc.id}">Add Video</button>
                            <button class="delete-btn logout-btn" data-type="topic" data-subject-id="${subjectId}" data-id="${doc.id}">Delete</button>
                        </div>
                    </div>
                    <div class="nested-container" id="videos-container-${doc.id}"></div>
                `;
                container.appendChild(el);
            });
        }

        async function renderTeacherVideos(subjectId, topicId) {
            const videosRef = collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics/${topicId}/videos`);
            const container = document.getElementById(`videos-container-${topicId}`);
            container.innerHTML = '<p class="loading-indicator">Loading videos...</p>';
            const q = query(videosRef, orderBy('timestamp', 'desc'));
            const querySnapshot = await getDocs(q);
            container.innerHTML = querySnapshot.empty ? '<p>No videos yet.</p>' : '';
            querySnapshot.forEach(doc => {
                const video = doc.data();
                const el = document.createElement('div');
                el.className = 'sub-item';
                el.innerHTML = `
                    <span>${video.title}</span>
                    <button class="delete-btn logout-btn" data-type="video" data-subject-id="${subjectId}" data-topic-id="${topicId}" data-id="${doc.id}">Delete</button>
                `;
                container.appendChild(el);
            });
        }

        // --- PAST PAPERS SECTION LOGIC ---
        const paperSubjectsRef = collection(db, `artifacts/${appId}/public/data/pastPapers`);

        function setupPastPapersSection() {
            const isTeacher = currentUserRole === 'teacher';
            document.getElementById('teacherPastPapersView').style.display = isTeacher ? 'block' : 'none';
            document.getElementById('studentPastPapersView').style.display = isTeacher ? 'none' : 'block';
            if (isTeacher) {
                setupTeacherPastPapersView();
            } else {
                setupStudentPastPapersView();
            }
        }

        function setupTeacherPastPapersView() {
            renderTeacherPaperSubjects();
            document.getElementById('addPaperSubjectBtn').onclick = () => handleAddContentItem('paperSubject');
            const container = document.getElementById('paperSubjectsContainer');
            container.addEventListener('click', teacherContentClickHandler);
        }
        
        async function renderTeacherPaperSubjects() {
            const container = document.getElementById('paperSubjectsContainer');
            container.innerHTML = '<p class="loading-indicator">Loading subjects...</p>';
            const q = query(paperSubjectsRef, orderBy('name'));
            const querySnapshot = await getDocs(q);
            container.innerHTML = querySnapshot.empty ? '<p>No subjects for past papers created yet.</p>' : '';
            querySnapshot.forEach(doc => {
                const subject = doc.data();
                const el = document.createElement('div');
                el.className = 'content-item';
                el.innerHTML = `
                    <div class="content-header" data-type="paperSubject" data-id="${doc.id}">
                        <h3>${subject.name}</h3>
                        <div class="item-actions">
                            <button class="add-year-btn btn-primary" data-subject-id="${doc.id}">Add Year</button>
                            <button class="delete-btn logout-btn" data-type="paperSubject" data-id="${doc.id}">Delete</button>
                        </div>
                    </div>
                    <div class="nested-container" id="years-container-${doc.id}"></div>
                `;
                container.appendChild(el);
            });
        }
        
        async function renderTeacherPaperYears(subjectId) {
            const yearsRef = collection(db, `artifacts/${appId}/public/data/pastPapers/${subjectId}/years`);
            const container = document.getElementById(`years-container-${subjectId}`);
            container.innerHTML = '<p class="loading-indicator">Loading years...</p>';
            const q = query(yearsRef, orderBy('name', 'desc')); // Order years descending
            const querySnapshot = await getDocs(q);
            container.innerHTML = querySnapshot.empty ? '<p>No years added yet.</p>' : '';
            querySnapshot.forEach(doc => {
                const year = doc.data();
                const el = document.createElement('div');
                el.className = 'content-item';
                el.innerHTML = `
                    <div class="content-header" data-type="paperYear" data-subject-id="${subjectId}" data-id="${doc.id}">
                        <h4>${year.name}</h4>
                        <div class="item-actions">
                            <button class="add-paper-btn btn-primary" data-subject-id="${subjectId}" data-year-id="${doc.id}">Add Paper</button>
                            <button class="delete-btn logout-btn" data-type="paperYear" data-subject-id="${subjectId}" data-id="${doc.id}">Delete</button>
                        </div>
                    </div>
                    <div class="nested-container" id="papers-container-${doc.id}"></div>
                `;
                container.appendChild(el);
            });
        }

        async function renderTeacherPapers(subjectId, yearId) {
            const papersRef = collection(db, `artifacts/${appId}/public/data/pastPapers/${subjectId}/years/${yearId}/papers`);
            const container = document.getElementById(`papers-container-${yearId}`);
            container.innerHTML = '<p class="loading-indicator">Loading papers...</p>';
            const q = query(papersRef, orderBy('timestamp', 'desc'));
            const querySnapshot = await getDocs(q);
            container.innerHTML = querySnapshot.empty ? '<p>No papers added yet.</p>' : '';
            querySnapshot.forEach(doc => {
                const paper = doc.data();
                const el = document.createElement('div');
                el.className = 'sub-item paper-item';
                el.innerHTML = `
                    <a href="${paper.link}" target="_blank" rel="noopener noreferrer">${paper.name}</a>
                    <button class="delete-btn logout-btn" data-type="pastPaper" data-subject-id="${subjectId}" data-year-id="${yearId}" data-id="${doc.id}">Delete</button>
                `;
                container.appendChild(el);
            });
        }
        
        // --- STUDENT VIEWS (Tutorials & Past Papers) ---
        async function setupStudentTutorialView() {
            populateFilter(document.getElementById('subjectFilter'), subjectsRef, 'Subjects');
            document.getElementById('subjectFilter').onchange = () => {
                const subjectId = document.getElementById('subjectFilter').value;
                const topicFilter = document.getElementById('topicFilter');
                if(subjectId) {
                    const topicsRef = collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics`);
                    populateFilter(topicFilter, topicsRef, 'Topics');
                    topicFilter.disabled = false;
                } else {
                    topicFilter.innerHTML = '<option value="">-- Select a Topic --</option>';
                    topicFilter.disabled = true;
                }
                document.getElementById('tutorialGrid').innerHTML = '<p>Please select a topic.</p>';
            };
            document.getElementById('topicFilter').onchange = renderStudentVideos;
        }

        async function renderStudentVideos() {
            const subjectId = document.getElementById('subjectFilter').value;
            const topicId = document.getElementById('topicFilter').value;
            const grid = document.getElementById('tutorialGrid');
            grid.innerHTML = '<p class="loading-indicator">Loading videos...</p>';
            if (!subjectId || !topicId) { grid.innerHTML = '<p>Please select a subject and topic.</p>'; return; }
            const videosRef = collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics/${topicId}/videos`);
            const q = query(videosRef, orderBy('timestamp', 'desc'));
            const querySnapshot = await getDocs(q);
            grid.innerHTML = querySnapshot.empty ? '<p>No videos found for this topic.</p>' : '';
            querySnapshot.forEach(doc => {
                const video = doc.data();
                const card = document.createElement('div');
                card.className = 'tutorial-card';
                card.innerHTML = `
                    <a href="https://www.youtube.com/watch?v=${video.youtubeId}" target="_blank" rel="noopener noreferrer" class="tutorial-card-thumbnail">
                        <img src="https://img.youtube.com/vi/${video.youtubeId}/mqdefault.jpg" alt="${video.title}" onerror="this.onerror=null; this.src='https://placehold.co/1280x720/30363d/c9d1d9?text=No%20Thumbnail';">
                    </a>
                    <div class="tutorial-card-content"><h3>${video.title}</h3></div>`;
                grid.appendChild(card);
            });
        }

        async function setupStudentPastPapersView() {
            populateFilter(document.getElementById('paperSubjectFilter'), paperSubjectsRef, 'Subjects');
            document.getElementById('paperSubjectFilter').onchange = () => {
                const subjectId = document.getElementById('paperSubjectFilter').value;
                const yearFilter = document.getElementById('paperYearFilter');
                if(subjectId) {
                    const yearsRef = collection(db, `artifacts/${appId}/public/data/pastPapers/${subjectId}/years`);
                    populateFilter(yearFilter, yearsRef, 'Years');
                    yearFilter.disabled = false;
                } else {
                    yearFilter.innerHTML = '<option value="">-- Select a Year --</option>';
                    yearFilter.disabled = true;
                }
                document.getElementById('papersGrid').innerHTML = '<p>Please select a year.</p>';
            };
            document.getElementById('paperYearFilter').onchange = renderStudentPapers;
        }

        async function renderStudentPapers() {
            const subjectId = document.getElementById('paperSubjectFilter').value;
            const yearId = document.getElementById('paperYearFilter').value;
            const grid = document.getElementById('papersGrid');
            grid.innerHTML = '<p class="loading-indicator">Loading papers...</p>';
            if (!subjectId || !yearId) { grid.innerHTML = '<p>Please select a subject and year.</p>'; return; }
            const papersRef = collection(db, `artifacts/${appId}/public/data/pastPapers/${subjectId}/years/${yearId}/papers`);
            const q = query(papersRef, orderBy('timestamp', 'desc'));
            const querySnapshot = await getDocs(q);
            grid.innerHTML = querySnapshot.empty ? '<p>No papers found.</p>' : '';
            querySnapshot.forEach(doc => {
                const paper = doc.data();
                const card = document.createElement('a');
                card.href = paper.link;
                card.target = '_blank';
                card.rel = 'noopener noreferrer';
                card.className = 'tutorial-card'; // Re-use card style
                card.innerHTML = `<div class="tutorial-card-content"><h3>${paper.name}</h3></div>`;
                grid.appendChild(card);
            });
        }
        
        async function populateFilter(selectElement, collectionRef, itemTypeName) {
            selectElement.innerHTML = `<option value="">-- Loading ${itemTypeName} --</option>`;
            try {
                const q = query(collectionRef, orderBy('name'));
                const snapshot = await getDocs(q);
                selectElement.innerHTML = `<option value="">-- Select a ${itemTypeName.slice(0,-1)} --</option>`;
                if(snapshot.empty) {
                    selectElement.innerHTML = `<option value="">-- No ${itemTypeName} Available --</option>`;
                    return;
                }
                snapshot.forEach(doc => {
                    selectElement.add(new Option(doc.data().name, doc.id));
                });
            } catch (e) {
                console.error(`Error loading ${itemTypeName}:`, e);
                selectElement.innerHTML = `<option value="">-- Error Loading --</option>`;
            }
        }
        
        // --- GENERIC TEACHER CONTENT MANAGEMENT ---
        async function teacherContentClickHandler(e) {
            const header = e.target.closest('.content-header');
            const button = e.target.closest('button');

            if (button) { // Button click
                e.stopPropagation();
                const { type, id, subjectId, topicId, yearId } = button.dataset;
                if(button.matches('.add-topic-btn')) handleAddContentItem('topic', subjectId);
                else if(button.matches('.add-video-btn')) showAddVideoModal(subjectId, topicId);
                else if(button.matches('.add-year-btn')) handleAddContentItem('paperYear', subjectId);
                else if(button.matches('.add-paper-btn')) showAddPastPaperModal(subjectId, yearId);
                else if(button.matches('.delete-btn')) handleDelete(button.dataset);
            } else if (header) { // Header click for toggling
                const { type, id, subjectId } = header.dataset;
                const containerId = {
                    subject: `topics-container-${id}`,
                    topic: `videos-container-${id}`,
                    paperSubject: `years-container-${id}`,
                    paperYear: `papers-container-${id}`
                }[type];

                const container = document.getElementById(containerId);
                if (!container) return;

                const isVisible = container.style.display === 'block';
                container.style.display = isVisible ? 'none' : 'block';

                if (!isVisible && !container.dataset.loaded) {
                    if(type === 'subject') await renderTeacherTopics(id);
                    else if(type === 'topic') await renderTeacherVideos(subjectId, id);
                    else if(type === 'paperSubject') await renderTeacherPaperYears(id);
                    else if(type === 'paperYear') await renderTeacherPapers(subjectId, id);
                    container.dataset.loaded = 'true';
                }
            }
        }
        
        function handleAddContentItem(type, parentId = null) {
            const itemType = { subject: 'Subject', topic: 'Topic', paperSubject: 'Subject', paperYear: 'Year (e.g., 2024)' }[type];
            showInputModal(`Add New ${itemType}`, `Enter ${itemType} Name:`, async (name) => {
                try {
                    const ref = {
                        subject: subjectsRef,
                        topic: collection(db, `artifacts/${appId}/public/data/subjects/${parentId}/topics`),
                        paperSubject: paperSubjectsRef,
                        paperYear: collection(db, `artifacts/${appId}/public/data/pastPapers/${parentId}/years`)
                    }[type];
                    await addDoc(ref, { name: name.trim() });
                    showModal('Success', `${itemType} "${name}" added.`);
                    // Refresh view
                    if(type === 'subject') renderTeacherSubjects();
                    else if(type === 'topic') renderTeacherTopics(parentId);
                    else if(type === 'paperSubject') renderTeacherPaperSubjects();
                    else if(type === 'paperYear') renderTeacherPaperYears(parentId);
                } catch (e) { 
                    console.error(`Error adding ${type}:`, e);
                    showModal('Error', `Could not add ${itemType}: ${e.message}`); 
                }
            });
        }
        
        function handleDelete(dataset) {
            const { type, id, subjectId, topicId, yearId } = dataset;
            const typeName = { subject: 'Subject', topic: 'Topic', video: 'Video', paperSubject: 'Subject', paperYear: 'Year', pastPaper: 'Past Paper'}[type];
            showModal('Confirm Deletion', `Are you sure you want to delete this ${typeName}? This action cannot be undone.`, [
                { text: 'Delete', className: 'btn-primary', onClick: async () => {
                    let docRef;
                    if (type === 'subject') docRef = doc(db, `artifacts/${appId}/public/data/subjects`, id);
                    else if (type === 'topic') docRef = doc(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics`, id);
                    else if (type === 'video') docRef = doc(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics/${topicId}/videos`, id);
                    else if (type === 'paperSubject') docRef = doc(db, `artifacts/${appId}/public/data/pastPapers`, id);
                    else if (type === 'paperYear') docRef = doc(db, `artifacts/${appId}/public/data/pastPapers/${subjectId}/years`, id);
                    else if (type === 'pastPaper') docRef = doc(db, `artifacts/${appId}/public/data/pastPapers/${subjectId}/years/${yearId}/papers`, id);

                    try {
                        await deleteDoc(docRef);
                        showModal('Success', `${typeName} deleted successfully.`);
                        if (type === 'subject') renderTeacherSubjects();
                        else if (type === 'topic') renderTeacherTopics(subjectId);
                        else if (type === 'video') renderTeacherVideos(subjectId, topicId);
                        else if (type === 'paperSubject') renderTeacherPaperSubjects();
                        else if (type === 'paperYear') renderTeacherPaperYears(subjectId);
                        else if (type === 'pastPaper') renderTeacherPapers(subjectId, yearId);
                    } catch (e) { 
                        console.error(`Error deleting ${type}:`, e);
                        showModal('Error', `Could not delete ${typeName}: ${e.message}`); 
                    }
                }},
                { text: 'Cancel', className: 'logout-btn' }
            ]);
        }

        // --- MODALS (Video & Past Paper) ---
        const addVideoModal = document.getElementById('addVideoModal');
        const addVideoForm = document.getElementById('addVideoForm');
        const addPastPaperModal = document.getElementById('addPastPaperModal');
        const addPastPaperForm = document.getElementById('addPastPaperForm');
        
        function showAddVideoModal(subjectId, topicId) {
            addVideoForm.reset();
            document.getElementById('tutorialThumbnailPreview').style.display = 'none';
            document.getElementById('videoSubjectId').value = subjectId;
            document.getElementById('videoTopicId').value = topicId;
            addVideoModal.style.display = 'flex';
            document.getElementById('tutorialLink').focus();
        }

        addVideoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const subjectId = document.getElementById('videoSubjectId').value;
            const topicId = document.getElementById('videoTopicId').value;
            const link = document.getElementById('tutorialLink').value;
            const title = document.getElementById('tutorialTitle').value;
            const youtubeId = getYouTubeId(link);

            if (!youtubeId || !title.trim()) { showModal('Input Error', 'Please provide a valid YouTube video link and title.'); return; }
            
            try {
                const videosRef = collection(db, `artifacts/${appId}/public/data/subjects/${subjectId}/topics/${topicId}/videos`);
                await addDoc(videosRef, { youtubeId, title: title.trim(), timestamp: Date.now() });
                showModal('Success', 'Video added successfully!');
                addVideoModal.style.display = 'none';
                renderTeacherVideos(subjectId, topicId);
            } catch (error) { 
                console.error("Error adding video:", error);
                showModal('Error', `Could not add video: ${error.message}`); 
            }
        });
        
        function showAddPastPaperModal(subjectId, yearId) {
            addPastPaperForm.reset();
            document.getElementById('paperSubjectId').value = subjectId;
            document.getElementById('paperYearId').value = yearId;
            addPastPaperModal.style.display = 'flex';
            document.getElementById('pastPaperName').focus();
        }

        addPastPaperForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const subjectId = document.getElementById('paperSubjectId').value;
            const yearId = document.getElementById('paperYearId').value;
            const name = document.getElementById('pastPaperName').value;
            const link = document.getElementById('pastPaperLink').value;

            if (!name.trim() || !link.trim()) { showModal('Input Error', 'Please provide a paper name and a download link.'); return; }
            
            try {
                const papersRef = collection(db, `artifacts/${appId}/public/data/pastPapers/${subjectId}/years/${yearId}/papers`);
                await addDoc(papersRef, { name: name.trim(), link: link.trim(), timestamp: Date.now() });
                showModal('Success', 'Past paper added successfully!');
                addPastPaperModal.style.display = 'none';
                renderTeacherPapers(subjectId, yearId);
            } catch (error) { 
                console.error("Error adding past paper:", error);
                showModal('Error', `Could not add paper: ${error.message}`); 
            }
        });

        function getYouTubeId(url) {
            let ID = '';
            url = url.replace(/(>|<)/gi,'').split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/);
            if(url[2] !== undefined) {
                ID = url[2].split(/[^0-9a-z_\-]/i);
                ID = ID[0];
            } else {
                ID = url[0];
            }
            return ID;
        }

        document.getElementById('tutorialLink').addEventListener('input', () => {
            const videoId = getYouTubeId(document.getElementById('tutorialLink').value);
            const thumbnailPreview = document.getElementById('tutorialThumbnailPreview');
            if (videoId) {
                thumbnailPreview.src = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
                thumbnailPreview.style.display = 'block';
            } else {
                thumbnailPreview.style.display = 'none';
                thumbnailPreview.src = '';
            }
        });
        
        // --- GRADING & CHAT LOGIC (largely unchanged) ---
        // Sets up drag-and-drop functionality for file inputs
        function setupDropZone(dropZoneId, fileInputId, fileNameDisplayId, filePreviewId) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            const fileNameDisplay = document.getElementById(fileNameDisplayId);
            const filePreview = document.getElementById(filePreviewId);

            dropZone.addEventListener('click', () => fileInput.click());
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, e => {e.preventDefault(); e.stopPropagation();}));
            ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.add('highlight')));
            ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.remove('highlight')));

            dropZone.addEventListener('drop', e => {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            });

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    fileNameDisplay.textContent = file.name;
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => { filePreview.src = e.target.result; filePreview.style.display = 'block'; };
                        reader.readAsDataURL(file);
                    } else if (file.type === 'application/pdf') {
                        const loadingTask = pdfjsLib.getDocument({ url: URL.createObjectURL(file) });
                        loadingTask.promise.then(pdf => pdf.getPage(1)).then(page => {
                            const viewport = page.getViewport({ scale: 1.0 });
                            const canvas = document.createElement('canvas');
                            canvas.height = viewport.height; canvas.width = viewport.width;
                            page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise.then(() => {
                                filePreview.src = canvas.toDataURL('image/png');
                                filePreview.style.display = 'block';
                                canvas.remove();
                            });
                        }).catch(error => {
                            console.error("Error rendering PDF preview:", error);
                            fileNameDisplay.textContent = 'Error rendering PDF preview.';
                            filePreview.style.display = 'none';
                        });
                    } else {
                        filePreview.style.display = 'none';
                    }
                } else {
                    fileNameDisplay.textContent = 'No file chosen';
                    filePreview.style.display = 'none';
                    filePreview.src = '';
                }
            });
        }
        setupDropZone('studentDropZone', 'studentAnswerFile', 'studentFileName', 'studentFilePreview');
        setupDropZone('answerKeyDropZone', 'answerKeyFile', 'answerKeyFileName', 'answerKeyFilePreview');
        
        async function loadPastSubmissions() {
            if (!currentUserId) return;
            const container = document.getElementById('pastSubmissions');
            container.innerHTML = '';
            const noSubmissionsMsg = document.getElementById('noSubmissions'); 
            
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/submissions`), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    if (noSubmissionsMsg) noSubmissionsMsg.style.display = 'block'; 
                    return;
                }
                if (noSubmissionsMsg) noSubmissionsMsg.style.display = 'none';
                querySnapshot.forEach((doc) => {
                    const submission = doc.data();
                    const card = document.createElement('div');
                    card.className = 'submission-card';
                    card.innerHTML = `<h3 class="font-semibold text-lg mb-2">Submission on ${new Date(submission.timestamp).toLocaleString()}</h3>
                                      <p><strong>Grade:</strong> ${submission.geminiGrade.substring(0, 200)}...</p>`;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error("Error loading past submissions:", error);
                showModal('Error Loading Submissions', `Could not load past submissions: ${error.message}`);
            }
        }

        document.getElementById('gradeButton').addEventListener('click', async () => {
            if (!currentUserId) { showModal('Authentication Required', 'Please sign in to grade work.'); return; }

            const studentAnswerText = document.getElementById('studentAnswer').value.trim();
            const answerKeyText = document.getElementById('answerKey').value.trim();
            const studentFile = document.getElementById('studentAnswerFile').files[0];
            const answerKeyFile = document.getElementById('answerKeyFile').files[0];

            if ((!studentAnswerText && !studentFile) || (!answerKeyText && !answerKeyFile)) {
                showModal('Input Missing', "Please provide either text or upload a file for both the student's work and the answer key.");
                return;
            }

            const loadingIndicator = document.getElementById('gradingLoadingIndicator');
            loadingIndicator.style.display = 'block';
            loadingIndicator.textContent = 'Starting grading process...';
            document.getElementById('gradeButton').disabled = true;

            try {
                let studentInputForGemini = studentAnswerText ? [{ text: studentAnswerText }] : await processFileForGemini(studentFile, loadingIndicator);
                let answerKeyInputForGemini = answerKeyText ? [{ text: answerKeyText }] : await processFileForGemini(answerKeyFile, loadingIndicator);
                
                let studentFileUrl = studentFile ? await uploadFileToStorage(studentFile, `artifacts/${appId}/users/${currentUserId}/submissions_files`) : null;
                let answerKeyFileUrl = answerKeyFile ? await uploadFileToStorage(answerKeyFile, `artifacts/${appId}/users/${currentUserId}/submissions_files`) : null;
                
                loadingIndicator.textContent = 'Sending to Gemini for grading...';
                
                let prompt = `You are an expert exam grader. Compare the student's work with the answer key. Provide a clear grade and constructive feedback.\n\n[STUDENT WORK]:\n`;
                studentInputForGemini.forEach(p => prompt += p.text || '[IMAGE/PDF CONTENT]');
                prompt += `\n\n[ANSWER KEY]:\n`;
                answerKeyInputForGemini.forEach(p => prompt += p.text || '[IMAGE/PDF CONTENT]');

                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody}`);
                }

                const result = await response.json();
                const geminiGrade = result.candidates[0].content.parts[0].text;
                document.getElementById('gradeResult').textContent = geminiGrade;

                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/submissions`), {
                    studentAnswerText, 
                    answerKeyText, 
                    geminiGrade, 
                    studentAnswerFileUrls: studentFileUrl ? [studentFileUrl] : [],
                    answerKeyFileUrls: answerKeyFileUrl ? [answerKeyFileUrl] : [], 
                    timestamp: Date.now()
                });

                showModal('Grading Complete', 'The work has been graded and saved.');
                await loadPastSubmissions();

            } catch (error) {
                console.error("Grading Error:", error);
                showModal('Grading Error', `An error occurred during grading: ${error.message}`);
            } finally {
                loadingIndicator.style.display = 'none';
                document.getElementById('gradeButton').disabled = false;
            }
        });

        const sendChatButton = document.getElementById('sendChatButton');
        const chatInput = document.getElementById('chatInput');
        sendChatButton.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSendMessage(); 
            } 
        });

        async function handleSendMessage() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;
            appendChatMessage(userMessage, 'user');
            chatInput.value = '';
            document.getElementById('chatLoadingIndicator').style.display = 'block';

            try {
                geminiChatHistory.push({ role: "user", parts: [{ text: userMessage }] });
                const payload = { contents: geminiChatHistory };
                const response = await fetch(CLOUDFLARE_WORKER_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody}`);
                }
                const result = await response.json();
                const geminiResponseText = result.candidates[0].content.parts[0].text;
                appendChatMessage(geminiResponseText, 'gemini');
                geminiChatHistory.push({ role: "model", parts: [{ text: geminiResponseText }] });
            } catch (error) {
                console.error("Chat Error:", error);
                appendChatMessage(`Error: ${error.message}`, 'gemini');
            } finally {
                document.getElementById('chatLoadingIndicator').style.display = 'none';
            }
        }

        function appendChatMessage(text, sender) {
            const display = document.getElementById('chatDisplay');
            const msgEl = document.createElement('div');
            msgEl.className = `chat-message ${sender}`;
            msgEl.textContent = text;
            display.appendChild(msgEl);
            display.scrollTop = display.scrollHeight;
        }
        
        // --- STUDENT MANAGEMENT & THEME & GENERAL MODAL ---
        document.getElementById('addStudentButton').addEventListener('click', async () => {
             if (currentUserRole !== 'teacher') { showModal('Access Denied', 'Only teachers can add students.'); return; }
             const email = document.getElementById('studentEmailInput').value.trim().toLowerCase();
             if (!email) { showModal('Input Error', 'Please enter a student email address.'); return; }

             document.getElementById('studentManagementLoading').style.display = 'block';
             try {
                const authorizedStudentsCollectionRef = collection(db, `artifacts/${appId}/authorized_users/auth_data/student_emails`);
                const q = query(authorizedStudentsCollectionRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);
                if(!querySnapshot.empty) {
                    showModal('Student Exists', `${email} is already authorized.`);
                } else {
                    await addDoc(authorizedStudentsCollectionRef, { email, addedBy: currentUserId, timestamp: Date.now() });
                    showModal('Success', `${email} has been authorized.`);
                    document.getElementById('studentEmailInput').value = '';
                    loadAuthorizedStudents();
                }
             } catch(e) {
                console.error("Error adding student:", e);
                showModal('Error', `Could not add student: ${e.message}`);
             } finally {
                document.getElementById('studentManagementLoading').style.display = 'none';
             }
        });

        async function loadAuthorizedStudents() {
            if(currentUserRole !== 'teacher') return;
            const list = document.getElementById('authorizedStudentsList');
            list.innerHTML = '';
            const noStudentsMsg = document.getElementById('noAuthorizedStudents');
            try {
                const q = query(collection(db, `artifacts/${appId}/authorized_users/auth_data/student_emails`), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                if(querySnapshot.empty) { 
                    if (noStudentsMsg) noStudentsMsg.style.display = 'block'; 
                    return; 
                }
                if (noStudentsMsg) noStudentsMsg.style.display = 'none';
                querySnapshot.forEach(docSnap => {
                    const student = docSnap.data();
                    const item = document.createElement('div');
                    item.className = 'student-item';
                    item.innerHTML = `<span>${student.email}</span><button class="delete-student-btn" data-id="${docSnap.id}">❌</button>`;
                    list.appendChild(item);
                });
                document.querySelectorAll('.delete-student-btn').forEach(btn => btn.addEventListener('click', deleteStudent));
            } catch(e) { 
                console.error("Error loading students:", e); 
                showModal('Error Loading Students', `Could not load authorized students: ${e.message}`);
            }
        }

        async function deleteStudent(e) {
            const studentId = e.currentTarget.dataset.id;
            showModal('Confirm Deletion', 'Are you sure you want to remove this student from the authorized list?', [
                { text: 'Delete', className: 'btn-primary', onClick: async () => {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/authorized_users/auth_data/student_emails`, studentId));
                        showModal('Success', 'Student removed successfully.');
                        loadAuthorizedStudents();
                    } catch(err) {
                        console.error("Error removing student:", err);
                        showModal('Error', `Could not remove student: ${err.message}`);
                    }
                }},
                { text: 'Cancel', className: 'logout-btn' }
            ]);
        }
        
        function showModal(title, message, buttons = []) {
            const messageModal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = '';

            if (buttons.length === 0) {
                 const okButton = document.createElement('button');
                 okButton.textContent = 'OK';
                 okButton.className = 'btn-primary';
                 okButton.onclick = () => { messageModal.style.display = 'none'; };
                 modalButtons.appendChild(okButton);
            } else {
                 buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.textContent = btnConfig.text;
                    button.className = btnConfig.className;
                    button.onclick = () => { 
                        messageModal.style.display = 'none';
                        if (btnConfig.onClick) btnConfig.onClick();
                    };
                    modalButtons.appendChild(button);
                });
            }
            messageModal.style.display = 'flex';
        }
        
        function showInputModal(title, label, callback) {
            const messageModal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = `
                <label for="modalInput" style="display:block; margin-bottom:8px;">${label}</label>
                <input type="text" id="modalInput" style="width: 100%;" required>`;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = ''; 

            const modalInput = document.getElementById('modalInput');
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.className = 'btn-primary';
            saveButton.onclick = () => {
                const value = modalInput.value.trim();
                if (value) {
                    messageModal.style.display = 'none';
                    callback(value);
                } else {
                    modalInput.style.border = '1px solid var(--accent-red)';
                    modalInput.focus();
                }
            };
            modalButtons.appendChild(saveButton);

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.className = 'logout-btn';
            cancelButton.onclick = () => { messageModal.style.display = 'none'; };
            modalButtons.appendChild(cancelButton);

            messageModal.style.display = 'flex';
            modalInput.focus();

            modalInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveButton.click();
                }
            });
        }

        document.querySelectorAll('.modal .close-button').forEach(btn => {
            btn.onclick = () => {
                btn.closest('.modal').style.display = 'none';
            };
        });

        const themeToggleButton = document.getElementById('themeToggleButton');
        function applyTheme(theme) {
            document.body.classList.toggle('light-theme', theme === 'light');
        }
        function loadTheme() {
            const savedTheme = localStorage.getItem('ai-marker-theme') || 'dark';
            applyTheme(savedTheme);
        }
        themeToggleButton.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('ai-marker-theme', newTheme);
        });

        // Load theme on init
        loadTheme();
    </script>
</body>
</html>
