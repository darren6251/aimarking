<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Marker</title>
    <!-- PDF.js library for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- Custom styles -->
    <style>
        /* Base Dark Theme Variables */
        :root {
            --bg-primary: #0d1117; /* Black */
            --bg-secondary: #161b22; /* Dark Gray */
            --bg-tertiary: #21262d; /* Slightly Lighter Dark Gray */
            --text-primary: #c9d1d9; /* Light Gray */
            --text-secondary: #8b949e; /* Muted gray for secondary text */
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --border-color: #30363d;
            --button-hover-darken: #21262d;
            --button-primary-lighten: #2ea043; /* Green hover */
            --button-blue-lighten: #4c9aff; /* Blue hover */
            --button-red-lighten: rgba(248, 81, 73, 0.1); /* Red hover */
            --neon-glow-color: #58a6ff; /* Neon blue for dark theme */
            --finder-item-hover: rgba(88, 166, 255, 0.1);
            --finder-item-active: rgba(88, 166, 255, 0.2);
        }

        /* Light Theme Variables - Overrides for .light-theme class */
        body.light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-tertiary: #e1e4e8;
            --text-primary: #24292e;
            --text-secondary: #586069;
            --accent-blue: #0366d6;
            --accent-green: #28a745;
            --accent-red: #d73a49;
            --border-color: #d1d5da;
            --button-hover-darken: #e2e6ea;
            --button-primary-lighten: #218838;
            --button-blue-lighten: #0069d9;
            --button-red-lighten: rgba(220, 53, 69, 0.1);
            --neon-glow-color: #007bff; /* Neon blue for light theme */
            --finder-item-hover: #f1f8ff;
            --finder-item-active: #e1f0ff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", sans-serif;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            overflow: hidden; /* Prevent body scroll */
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        button,
        input,
        textarea,
        select {
            transition: all .2s ease-out;
            font-family: inherit;
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        /* Keyframe animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* LOGIN PAGE: Full screen wrapper */
        #authWrapper {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1001;
        }

        .login-left-panel,
        .login-right-panel {
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .login-left-panel {
            background: var(--bg-primary);
            color: var(--text-primary);
            flex-direction: column;
            text-align: center;
        }

        .login-left-panel h1 {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 1rem;
        }

        .login-left-panel p {
            font-size: 1.75rem;
            font-weight: 400;
            line-height: 1.3;
            margin-bottom: .5rem;
            color: var(--text-secondary);
        }

        .login-right-panel {
            background: var(--bg-secondary);
            flex-direction: column;
        }
        
        #authContainer {
            width: 100%;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            background-color: var(--bg-primary);
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #authContainer h2 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: .75rem;
            cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        .google-btn:hover { background-color: var(--button-hover-darken); border-color: var(--text-secondary); }
        .google-btn img { height: 20px; }
        
        #accessCodeInput {
             background-color: var(--bg-secondary);
             border: 1px solid var(--border-color);
             color: var(--text-primary);
             padding: 12px;
             border-radius: 6px;
             width: 100%;
             margin-bottom: 1rem;
             text-align: center;
        }
        #accessCodeInput:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
        }

        .btn-primary {
             background-color: var(--accent-green);
             color: #fff;
             padding: .75rem 1.5rem;
             border-radius: 6px;
             border: none;
             cursor: pointer;
             font-weight: 600;
        }
        .btn-primary:hover {
             background-color: var(--button-primary-lighten);
             transform: translateY(-1px);
        }
        
        #appSection {
            display: none;
            flex-direction: column;
            height: 100vh;
            background-color: var(--bg-primary);
            animation: fadeIn .6s ease-out both;
        }
        
        header {
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            padding: 0 24px;
            height: 64px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            z-index: 100;
        }
        
        #logoLink {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .logo-container h1 { font-size: 1.5rem; font-weight: 700; }
        .logo-container p { font-weight: 400; color: var(--text-secondary); }
        
        .header-actions { margin-left: auto; display: flex; align-items: center; gap: 1rem; }

        /* --- START: NEON BUTTON STYLES --- */
        .header-actions .tab.neon-button {
            position: relative;
            display: inline-block;
            padding: 10px 18px;
            color: var(--neon-glow-color);
            text-decoration: none;
            overflow: hidden;
            transition: .5s;
            border: 1px solid var(--neon-glow-color);
            border-radius: 6px;
            background: transparent;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .header-actions .tab.neon-button:hover,
        .header-actions .tab.neon-button.active {
            background: var(--neon-glow-color);
            color: var(--bg-secondary);
            border-radius: 6px;
            box-shadow: 0 0 5px var(--neon-glow-color),
                        0 0 25px var(--neon-glow-color),
                        0 0 50px var(--neon-glow-color),
                        0 0 100px var(--neon-glow-color);
        }

        .header-actions .tab.neon-button span {
            position: absolute;
            display: block;
        }
        @keyframes btn-anim1 { 0% { left: -100%; } 50%,100% { left: 100%; } }
        @keyframes btn-anim2 { 0% { top: -100%; } 50%,100% { top: 100%; } }
        @keyframes btn-anim3 { 0% { right: -100%; } 50%,100% { right: 100%; } }
        @keyframes btn-anim4 { 0% { bottom: -100%; } 50%,100% { bottom: 100%; } }
        .header-actions .tab.neon-button span:nth-child(1) { animation: btn-anim1 1.5s linear infinite; top: 0; left: -100%; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--neon-glow-color)); }
        .header-actions .tab.neon-button span:nth-child(2) { animation: btn-anim2 1.5s linear infinite .375s; top: -100%; right: 0; width: 2px; height: 100%; background: linear-gradient(180deg, transparent, var(--neon-glow-color)); }
        .header-actions .tab.neon-button span:nth-child(3) { animation: btn-anim3 1.5s linear infinite .75s; bottom: 0; right: -100%; width: 100%; height: 2px; background: linear-gradient(270deg, transparent, var(--neon-glow-color)); }
        .header-actions .tab.neon-button span:nth-child(4) { animation: btn-anim4 1.5s linear infinite 1.125s; bottom: -100%; left: 0; width: 2px; height: 100%; background: linear-gradient(360deg, transparent, var(--neon-glow-color)); }
        /* --- END: NEON BUTTON STYLES --- */


        .user-info { display: flex; align-items: center; gap: 1rem; }
        #userDisplayName { font-weight: 500; cursor: pointer; }
        .logout-btn { background: none; border: 1px solid var(--accent-red); color: var(--accent-red); cursor: pointer; padding: 6px 12px; border-radius: 6px; font-weight: 600; }
        .logout-btn:hover { background: var(--button-red-lighten); }
        #switchRoleButton {
            background-color: var(--accent-blue);
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        #switchRoleButton:hover {
            background-color: var(--button-blue-lighten);
        }

        /* --- START: DROPDOWN STYLES --- */
        .dropdown-menu { position: relative; display: inline-block; }
        .dropdown-menu-content { display: none; position: absolute; top: 100%; left: 0; background-color: var(--bg-secondary); min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5); z-index: 10; border-radius: 6px; border: 1px solid var(--border-color); padding: 4px; }
        .dropdown-menu-content button { color: var(--text-primary); padding: 8px 12px; text-decoration: none; display: block; background: none; border: none; width: 100%; text-align: left; cursor: pointer; border-radius: 4px; font-size: 0.875rem; }
        .dropdown-menu-content button:hover { background-color: var(--button-hover-darken); color: var(--accent-blue); }
        .dropdown-menu:hover .dropdown-menu-content { display: block; }
        /* --- END: DROPDOWN STYLES --- */

        main {
            flex-grow: 1;
            display: flex;
            overflow: hidden; /* Hide overflow to contain sections */
            position: relative;
        }
        
        /* Content Sections */
        #homeSection, #gradingSection, #chatSection, #studentManagementSection, #profileSection, #tutorialSection, #pastPapersSection, #exerciseSection {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 24px;
        }
        #profileSection { max-width: 800px; margin: 0 auto; }

        /* --- START: FINDER UI STYLES --- */
        .finder-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .finder-toolbar {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .finder-content {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        .finder-column {
            min-width: 240px;
            width: 240px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            flex-shrink: 0;
        }
        .finder-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            gap: 8px;
        }
        .finder-item:last-child {
            border-bottom: none;
        }
        .finder-item:hover {
            background-color: var(--finder-item-hover);
        }
        .finder-item.active {
            background-color: var(--finder-item-active);
            font-weight: 600;
        }
        .finder-item .item-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .finder-item .item-actions {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .finder-item .item-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            font-size: 1rem;
            line-height: 1;
        }
        .finder-item .item-actions .add-btn { color: var(--accent-green); }
        .finder-item .item-actions .delete-btn { color: var(--accent-red); }
        .finder-item .arrow {
            color: var(--text-secondary);
            font-size: 1.2em;
            flex-shrink: 0;
        }
        .finder-preview-pane {
            flex-grow: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .finder-preview-placeholder {
            text-align: center;
            color: var(--text-secondary);
            margin: auto;
        }
        .preview-thumbnail {
            max-width: 100%;
            max-height: 250px;
            border-radius: 8px;
            margin-bottom: 1rem;
            object-fit: contain;
            background-color: var(--bg-secondary);
        }
        .preview-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }
        .preview-actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        /* --- END: FINDER UI STYLES --- */

        /* --- START: WINDOW VIEW STYLES --- */
        .finder-window-wrapper {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 960px;
            height: 600px;
            min-width: 400px;
            min-height: 300px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            overflow: hidden;
            display: none; /* Hidden by default */
            flex-direction: column;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
            z-index: 10;
            resize: both;
        }
        .finder-window-wrapper.fullscreen {
            top: 64px !important; /* Adjust for header */
            left: 0 !important;
            width: 100vw !important;
            height: calc(100vh - 64px) !important; 
            transform: none !important;
            border-radius: 0;
            border: none;
            resize: none;
        }

        .finder-window-titlebar {
            background: var(--bg-tertiary);
            height: 28px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            cursor: move;
            flex-shrink: 0;
        }
        .finder-window-titlebar .buttons {
            display: flex;
            gap: 6px;
        }
        .finder-window-titlebar .circle {
            width: 12px; height: 12px; border-radius: 50%;
        }
        .finder-window-titlebar .circle.close { background: #ff5f57; cursor: pointer; }
        .finder-window-titlebar .circle.min { background: #ffbd2e; }
        .finder-window-titlebar .circle.max { background: #28c840; cursor: pointer; }

        .finder-window-wrapper .finder-container {
            border: none;
            border-radius: 0;
            height: 100%;
        }
        /* --- END: WINDOW VIEW STYLES --- */


        /* Form elements */
        label { display: block; font-weight: 600; margin-bottom: 8px; }
        input[type="text"], input[type="number"], input[type="email"], select, input[type="url"] {
            width: 100%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 12px; border-radius: 6px; margin-bottom: 1rem;
        }
        textarea {
            width: 100%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 12px; border-radius: 6px; margin-bottom: 1rem; resize: vertical; min-height: 120px;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3); }
        
        .drop-zone { border: 2px dashed var(--border-color); border-radius: 6px; min-height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 1rem; margin-bottom: 1.5rem; cursor: pointer; word-wrap: break-word; padding: 1rem; text-align: center; }
        .drop-zone.highlight { border-color: var(--accent-blue); background: rgba(88, 166, 255, .1); }
        
        .file-preview { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; max-height: 200px; object-fit: contain; }
        .error-message { color: var(--accent-red); font-size: 0.875rem; margin-top: -0.5rem; margin-bottom: 1rem; }

        #gradeButton { background-color: var(--accent-green); color: #fff; }
        #gradeButton:hover { background-color: var(--button-primary-lighten); }

        #resultContainer { margin-top: 1.5rem; padding: 1rem; border-radius: 6px; background-color: var(--bg-secondary); border: 1px solid var(--border-color); min-height: 100px; white-space: pre-wrap; }

        /* Chat styles */
        #chatSection { display: none; flex-direction: column; gap: 1rem; height: 100%; padding: 24px; }
        #chatDisplay { flex: 1; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { max-width: 85%; padding: 10px 14px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; }
        .chat-message.user { background-color: var(--accent-blue); color: var(--bg-primary); align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-message.gemini { background-color: var(--button-hover-darken); align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-message.loading { align-self: flex-start; display: flex; align-items: center; gap: 8px; }
        .chat-message.loading .dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--text-secondary); animation: bounce 1.4s infinite ease-in-out both; }
        .chat-message.loading .dot:nth-child(1) { animation-delay: -0.32s; }
        .chat-message.loading .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        .chat-input-wrapper { display: flex; gap: .5rem; flex-shrink: 0; }
        #chatInput { flex: 1; padding: .75rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-secondary); color: var(--text-primary); }
        #sendChatButton { padding: .5rem 1rem; border: none; background: var(--accent-blue); color: var(--bg-primary); border-radius: 6px; font-weight: 600; cursor: pointer; }
        #sendChatButton:hover { background-color: var(--button-blue-lighten); }
        
        .loading-indicator { text-align: center; padding: 1rem; color: var(--text-secondary); }

        /* Universal Section Title */
        .section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; }

        /* Form container */
        .form-container { max-width: 600px; margin-bottom: 2rem; background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color); }
        
        /* Student Management Styles */
        #authorizedStudentsList { display: flex; flex-direction: column; gap: 0.5rem; }
        .student-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-secondary); padding: 0.75rem 1rem; border-radius: 6px; border: 1px solid var(--border-color); flex-wrap: wrap; }
        .student-info { flex-grow: 1; }
        .student-info span { display: block; }
        .student-info .student-name { font-weight: 600; }
        .student-info .student-email { font-size: 0.9em; color: var(--text-secondary); }
        .student-info .student-last-login { font-size: 0.8em; color: var(--accent-blue); margin-top: 4px; }
        .delete-student-btn { background: none; border: none; color: var(--accent-red); cursor: pointer; padding: 4px; }
        .delete-student-btn:hover { background-color: var(--button-red-lighten); border-radius: 50%; }

        /* Visibility Toggle Switch CSS */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4d555e; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--accent-green); }
        input:focus + .slider { box-shadow: 0 0 1px var(--accent-green); }
        input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 24px; }
        .slider.round:before { border-radius: 50%; }


        /* --- E-COMMERCE STYLES (used in preview pane) --- */
        .shopping-cart {
            width: 320px;
            flex-shrink: 0;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            height: fit-content;
        }
        .shopping-cart h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        #cart-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
        .cart-item-name {
            flex-grow: 1;
            margin-right: 1rem;
        }
        .cart-item-price {
            font-weight: 600;
            color: var(--accent-green);
        }
        .remove-from-cart-btn {
            background: none;
            border: none;
            color: var(--accent-red);
            cursor: pointer;
            font-size: 1rem;
            margin-left: 0.5rem;
        }
        #cart-summary {
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            margin-top: 1rem;
        }
        .summary-line {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        #cart-validation-message {
            font-size: 0.875rem;
            color: var(--accent-red);
            text-align: center;
            margin-top: 1rem;
            min-height: 20px;
        }
        #checkout-btn {
            width: 100%;
            margin-top: 1rem;
        }
        .product-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 1rem;
        }
        .add-to-cart-btn, .download-btn {
            width: 100%;
        }
        .download-btn {
            background-color: var(--accent-blue);
        }
        .download-btn:hover {
            background-color: var(--button-blue-lighten);
        }

        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; animation: fadeIn 0.3s ease-out; }
        .modal-content { background-color: var(--bg-secondary); padding: 30px; border-radius: 8px; border: 1px solid var(--border-color); max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; animation: slideInUp 0.3s ease-out; }
        #modalTitle { margin-bottom: 1rem; font-size: 1.5rem; font-weight: 600; }
        #modalMessage { line-height: 1.5; }
        .close-button { position: absolute; top: 10px; right: 15px; font-size: 28px; cursor: pointer; color: var(--text-secondary); }
        .close-button:hover { color: var(--text-primary); }
        #modalButtons, .modal-form-buttons { display:flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }

        /* Video Preview Modal Specific Styles */
        #videoPreviewModal .modal-content {
            max-width: 900px;
            width: 95%;
            padding: 15px;
            background-color: var(--bg-primary);
        }
        #videoPreviewModal iframe {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 8px;
        }
        @media (max-width: 768px) {
            #videoPreviewModal iframe { height: 300px; }
            .view-toggle-btn { display: none !important; }
        }


        /* Footer */
        footer { position: fixed; bottom: 0; right: 0; text-align: right; padding: 10px 20px; color: var(--text-secondary); font-size: 0.875rem; z-index: 100; pointer-events: none; }
        footer a { color: var(--accent-blue); text-decoration: none; pointer-events: all;}
        footer a:hover { text-decoration: underline; }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            #authWrapper { flex-direction: column; position: static; height: auto; }
            .login-left-panel, .login-right-panel { width: 100%; }
            header { flex-direction: column; height: auto; padding: 1rem; align-items: flex-start; }
            .header-actions { margin-left: 0; margin-top: 1rem; flex-wrap: wrap; }
            main { flex-direction: column; }
            .finder-content { flex-direction: column; }
            .finder-column { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); max-height: 200px; }
        }

        /* Hero */
        .hero {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2rem 1.5rem;
            position: relative;
            overflow: hidden;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .hero-text {
            max-width: 50%;
            font-size: 2rem;
            font-weight: bold;
            opacity: 0;
            animation: slideInLeft 1s ease-out forwards;
        }
        .hero-text span {
            display: block;
            font-size: 1.5rem;
            font-weight: normal;
            margin-top: 0.5rem;
            color: var(--accent-blue);
        }
        .hero-image {
            max-width: 40%;
            opacity: 0;
            animation: slideInRight 1s ease-out forwards;
        }
        .hero-image img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    </style>
</head>
<body>

    <div id="authWrapper" style="display: none;">
        <div class="login-left-panel">
            <h1>Let AI mark your work.</h1>
            <p>Let AI assist you, not replace you</p>
            <p>Mark with AI, learn better</p>
        </div>
        <div class="login-right-panel">
            <div id="authContainer">
                 <!-- JS will inject googleSignInTemplate or codeEntryTemplate -->
            </div>
        </div>
    </div>

    <div id="appSection" style="display: none;">
        <header>
             <a href="#" id="logoLink">
                <div class="logo-container">
                    <h1>AI Marker</h1>
                    <p>Operated by Darren Ng</p>
                </div>
            </a>
            <div class="header-actions">
                <button id="toggleHomeButton" class="tab neon-button active">
                    <span></span><span></span><span></span><span></span>
                    Home
                </button>
                
                <div class="dropdown-menu">
                    <button class="tab neon-button" id="workWithAIButton">
                        <span></span><span></span><span></span><span></span>
                        Work with AI
                    </button>
                    <div class="dropdown-menu-content">
                        <button id="toggleGradingButton" class="tab">Exam Grader</button>
                        <button id="toggleChatButton" class="tab">Chat with Gemini</button>
                    </div>
                </div>

                <div class="dropdown-menu">
                    <button class="tab neon-button" id="materialsButton">
                        <span></span><span></span><span></span><span></span>
                        Materials
                    </button>
                    <div class="dropdown-menu-content">
                        <button id="toggleTutorialButton" class="tab">Tutorial Videos</button>
                        <button id="togglePastPapersButton" class="tab">Past Papers</button>
                        <button id="toggleExercisesButton" class="tab">Exercises for Sale</button>
                    </div>
                </div>

                <button id="manageStudentsButton" class="tab neon-button" style="display: none;">
                    <span></span><span></span><span></span><span></span>
                    Manage Students
                </button>
                <button id="toggleProfileButton" class="tab neon-button">
                    <span></span><span></span><span></span><span></span>
                    Profile
                </button>
                <button id="themeToggleButton" class="tab neon-button">
                    <span></span><span></span><span></span><span></span>
                    Theme
                </button>
                <div class="user-info">
                     <span id="userDisplayName"></span>
                     <button id="switchRoleButton" class="btn-primary">Switch Role</button>
                     <button id="logoutButton" class="logout-btn">Log Out</button>
                </div>
            </div>
        </header>
        
        <main>
            <!-- Home Section -->
            <div id="homeSection" style="display: block; opacity: 1;">
                <section class="hero">
                    <div class="hero-text">
                        AI helps you learn better
                        <span>to fight DSE</span>
                    </div>
                    <div class="hero-image">
                        <img src="https://drive.google.com/uc?export=download&id=1wdjIr6SjqlgEjulvbpuNa08HHSMX623t" alt="Darren Ng demonstrating AI Marker">
                    </div>
                </section>
            </div>

            <!-- Grading Section -->
            <div id="gradingSection">
                <h2 class="section-title">Exam Grader</h2>
                <div class="mb-4">
                    <label>Upload Student's Work (Image or PDF):</label>
                    <div id="studentDropZone" class="drop-zone">
                        <span>Drag & Drop Student's Work Here or click to select</span>
                        <input type="file" id="studentAnswerFile" accept="image/*,application/pdf" hidden>
                    </div>
                     <span id="studentFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                    <img id="studentFilePreview" class="file-preview mx-auto" style="display: none;" alt="Student Work Preview">
                    <label for="studentAnswer">Or type Student's Answer:</label>
                    <textarea id="studentAnswer" placeholder="Enter student's answer here..."></textarea>
                    <p id="studentAnswerError" class="error-message"></p>
                </div>

                <div class="mb-6">
                    <label>Upload Answer Key (Image or PDF):</label>
                    <div id="answerKeyDropZone" class="drop-zone">
                        <span>Drag & Drop Answer Key Here or click to select</span>
                         <input type="file" id="answerKeyFile" accept="image/*,application/pdf" hidden>
                    </div>
                    <span id="answerKeyFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                    <img id="answerKeyFilePreview" class="file-preview mx-auto" style="display: none;" alt="Answer Key Preview">
                    <label for="answerKey">Or type Answer Key:</label>
                    <textarea id="answerKey" placeholder="Enter the correct answer key here..."></textarea>
                    <p id="answerKeyError" class="error-message"></p>
                </div>

                <button id="gradeButton" class="btn-primary">Grade Work</button>
                <div id="gradingLoadingIndicator" class="loading-indicator" style="display: none;"></div>
                <div id="resultContainer">
                    <h2>Grading Results:</h2>
                    <p id="gradeResult">Your grading results will appear here.</p>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="chatSection">
                <div id="chatDisplay">
                    <div class="chat-message gemini">Hello! How can I help you today?</div>
                </div>
                <div class="chat-input-wrapper">
                    <input type="text" id="chatInput" placeholder="Type a message…">
                    <button id="sendChatButton">Send</button>
                </div>
            </div>

            <!-- Student Management Section -->
            <div id="studentManagementSection">
                <h2 class="section-title">Manage Authorized Students</h2>
                <div class="add-student-form form-container">
                    <input type="email" id="studentEmailInput" placeholder="Enter student's Gmail address">
                    <button id="addStudentButton" class="btn-primary">Add Student</button>
                    <p id="addStudentStatus" class="loading-indicator" style="display: none;"></p>
                </div>
                <div id="studentManagementLoading" class="loading-indicator" style="display: none;"></div>
                <div id="authorizedStudentsList">
                    <p id="noAuthorizedStudents">No authorized students yet.</p>
                </div>
            </div>

            <!-- Material Sections (will be populated by JS) -->
            <div id="tutorialSection"></div>
            <div id="pastPapersSection"></div>
            <div id="exerciseSection"></div>
            
            <!-- Profile Section -->
            <div id="profileSection">
                <h2 class="section-title">Edit Your Profile</h2>
                <form id="profileForm" class="form-container">
                    <div style="margin-bottom: 1rem;">
                        <label for="profileName">Display Name</label>
                        <input type="text" id="profileName" name="name" required>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileAge">Age</label>
                        <input type="number" id="profileAge" name="age">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileGrade">Year/Grade</label>
                        <input type="text" id="profileGrade" name="grade">
                    </div>
                     <div style="margin-bottom: 1rem;">
                        <label for="profileSchool">School</label>
                        <input type="text" id="profileSchool" name="school">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileElectives">Elective Subjects</label>
                        <textarea id="profileElectives" name="electives" placeholder="e.g., Physics, Computer Science, Art"></textarea>
                    </div>
                    <button type="submit" id="saveProfileButton" class="btn-primary">Save Profile</button>
                </form>
            </div>
        </main>
    </div>

    <footer>
        <a href="mailto:darren_0625@mc-zero.com">Contact: darren_0625@mc-zero.com</a> | Copyright © 2025 Operated by Darren Ng
    </footer>

    <!-- Universal Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle"></h3>
            <div id="modalMessage"></div>
            <div id="modalButtons"></div>
        </div>
    </div>
    
    <!-- Modals for adding content -->
    <div id="addItemModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3 id="addItemModalTitle">Add New Item</h3>
             <form id="addItemForm">
                 <input type="hidden" id="addItemMaterialType">
                 <input type="hidden" id="addItemType">
                 <input type="hidden" id="addItemParentId">
                 <div style="margin-bottom: 1rem;">
                     <label for="addItemName">Name</label>
                     <input type="text" id="addItemName" required>
                 </div>
                 <div id="addItemFields"></div>
                 <div class="modal-form-buttons">
                    <button type="submit" class="btn-primary">Add Item</button>
                 </div>
             </form>
        </div>
    </div>

    <!-- Video Preview Modal -->
    <div id="videoPreviewModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="videoPreviewTitle" class="section-title"></h3>
            <div id="videoPreviewContent"></div>
        </div>
    </div>

    <!-- Shopping Cart Modal for Exercises -->
    <div id="shoppingCartModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close-button">&times;</span>
            <div class="shopping-cart">
                <h3>Shopping Cart</h3>
                <div id="cart-items"></div>
                <div id="cart-summary">
                    <div class="summary-line">
                        <span>Subtotal:</span>
                        <span id="cart-subtotal-price">$0.00</span>
                    </div>
                    <div class="summary-line" id="promo-discount-line" style="display:none;">
                        <span>Promo Discount:</span>
                        <span id="cart-promo-discount">-$0.00</span>
                    </div>
                    <div class="summary-line">
                        <span>Total Price:</span>
                        <span id="cart-total-price">$0.00</span>
                    </div>
                </div>
                <div id="cart-validation-message"></div>
                <button id="checkout-btn" class="btn-primary" disabled>Proceed to Checkout</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, where, writeBatch, collectionGroup } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";

        // --- IMPORTANT CONFIGURATION ---
        const STRIPE_PAYMENT_LINK = "https://buy.stripe.com/14A28t1kAfr2gnx04L0ZW0n"; 

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
          authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30",
          storageBucket: "ai-grading-9bb30.appspot.com",
          messagingSenderId: "298162112230",
          appId: "1:298162112230:web:529d3f95536991be685d27",
          measurementId: "G-CHKLKSM17S"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const CLOUDFLARE_WORKER_URL = "https://ai-marker-gemini-proxy.darren-xie11.workers.dev/";
        const TEACHER_CODE = "TEACHER123";
        const STUDENT_CODE = "STUDENT456";

        pdfjsLib.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let app, db, auth, storage;
        let currentUserId = null, currentUserEmail = null, currentUserRole = null, currentUserName = null;
        let geminiChatHistory = [];
        let shoppingCart = [];
        let appliedPromoCode = null;

        // --- AUTH & INITIALIZATION ---
        
        const authWrapper = document.getElementById('authWrapper');
        const appSection = document.getElementById('appSection');
        const authContainer = document.getElementById('authContainer');

        const googleSignInTemplate = `
            <h2>Sign In</h2>
            <button id="googleSignInButton" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
                <span>Sign in with Google</span>
            </button>
            <p id="authError" class="error-message"></p>
        `;

        const codeEntryTemplate = `
            <h2>Enter Access Code</h2>
            <p style="color: var(--text-secondary); text-align: center; margin-bottom: 1rem;">Please enter the access code provided by your administrator.</p>
            <input type="text" id="accessCodeInput" placeholder="Enter code here">
            <button id="submitCodeButton" class="btn-primary" style="width:100%">Submit Code</button>
            <p id="codeError" class="error-message"></p>
        `;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showModal('Firebase Configuration Error', `Failed to initialize Firebase. Error: ${error.message}`);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                currentUserEmail = user.email;
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                try {
                    const userProfileDoc = await getDoc(userProfileRef);
                    if (userProfileDoc.exists() && userProfileDoc.data().role) {
                        const profileData = userProfileDoc.data();
                        currentUserRole = profileData.role;
                        currentUserName = profileData.name || user.displayName;
                        await setDoc(userProfileRef, { name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                        showApp();
                    } else {
                        currentUserName = user.displayName;
                        currentUserRole = 'unassigned';
                        await setDoc(userProfileRef, { name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                        showCodeEntry();
                    }
                } catch (e) {
                     console.error("Error checking user profile:", e);
                     showModal('Profile Error', `Could not load user profile. Error: ${e.message}`);
                     showLogin();
                }
            } else {
                currentUserId = null;
                currentUserRole = null;
                currentUserName = null;
                showLogin();
            }
        });

        function showLogin() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authWrapper.style.opacity = '1';
            authContainer.innerHTML = googleSignInTemplate;
            document.getElementById('googleSignInButton')?.addEventListener('click', handleGoogleSignIn);
        }

        function showCodeEntry() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authWrapper.style.opacity = '1';
            authContainer.innerHTML = codeEntryTemplate;
            const submitCodeBtn = document.getElementById('submitCodeButton');
            const accessCodeInput = document.getElementById('accessCodeInput');
            submitCodeBtn?.addEventListener('click', () => handleSubmitCode());
            accessCodeInput?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSubmitCode();
                }
            });
            accessCodeInput?.focus();
        }

        async function showApp() {
            authWrapper.style.display = 'none';
            appSection.style.display = 'flex';
            document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
            document.getElementById('manageStudentsButton').style.display = currentUserRole === 'teacher' ? 'block' : 'none';
            
            initializeAllMaterialSections();
            await checkForSuccessfulPurchase();

            showSection('homeSection');
            if(currentUserRole === 'teacher') loadAuthorizedStudents();
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try { 
                await signInWithPopup(auth, provider); 
            } catch (error) { 
                document.getElementById('authError').textContent = `Sign-in failed. Error: ${error.message}`; 
                console.error("Google Sign-In Error:", error);
            }
        }

        async function handleSubmitCode(codeValue) {
            const code = (codeValue || document.getElementById('accessCodeInput').value).trim();
            const codeError = document.getElementById('codeError');
            if(codeError) codeError.textContent = '';
            
            let roleToSet = null;
            if (code === TEACHER_CODE) roleToSet = 'teacher';
            else if (code === STUDENT_CODE) roleToSet = 'student';
            else { 
                if(codeError) codeError.textContent = 'Invalid access code.';
                return; 
            }
            
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await setDoc(userProfileRef, { role: roleToSet, name: currentUserName, email: currentUserEmail }, { merge: true });
                currentUserRole = roleToSet;
                showModal('Success!', `Your role has been set to ${roleToSet}.`);
                showApp();
            } catch (error) {
                if(codeError) codeError.textContent = `Could not set role. Error: ${error.message}`;
                console.error("Submit Code Error:", error);
            }
        }

        document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));

        document.getElementById('switchRoleButton').addEventListener('click', () => {
            showInputModal('Switch Role', 'Enter new access code (Teacher or Student):', async (code) => {
                await handleSubmitCode(code);
            });
        });

        // --- NAVIGATION & UI ---

        function showSection(sectionIdToShow) {
            const sections = ['homeSection', 'gradingSection', 'chatSection', 'studentManagementSection', 'profileSection', 'tutorialSection', 'pastPapersSection', 'exerciseSection'];
            const buttons = {
                toggleHomeButton: 'homeSection',
                workWithAIButton: ['gradingSection', 'chatSection'],
                materialsButton: ['tutorialSection', 'pastPapersSection', 'exerciseSection'],
                manageStudentsButton: 'studentManagementSection',
                toggleProfileButton: 'profileSection'
            };
            
            document.querySelectorAll('.header-actions .tab.neon-button').forEach(t => t.classList.remove('active'));

            let activeButtonId = null;
            for (const [btnId, secId] of Object.entries(buttons)) {
                if (Array.isArray(secId) && secId.includes(sectionIdToShow)) {
                    activeButtonId = btnId;
                    break;
                }
                if (secId === sectionIdToShow) {
                    activeButtonId = btnId;
                    break;
                }
            }
            if (activeButtonId) {
                document.getElementById(activeButtonId)?.classList.add('active');
            }

            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    const isTarget = id === sectionIdToShow;
                    const displayStyle = 'flex';
                    section.style.display = isTarget ? displayStyle : 'none';
                    if (isTarget) {
                        if (['tutorialSection', 'pastPapersSection', 'exerciseSection'].includes(id)) {
                            section.style.padding = '0';
                        } else {
                            section.style.padding = '24px';
                        }
                    }
                    setTimeout(() => section.style.opacity = isTarget ? '1' : '0', 10);
                }
            });

            if (sectionIdToShow === 'profileSection') loadProfileData();
        }

        function setupSectionToggle() {
            document.getElementById('logoLink').addEventListener('click', (e) => { e.preventDefault(); showSection('homeSection'); });
            document.getElementById('toggleHomeButton')?.addEventListener('click', () => showSection('homeSection'));
            document.getElementById('toggleGradingButton')?.addEventListener('click', () => showSection('gradingSection'));
            document.getElementById('toggleChatButton')?.addEventListener('click', () => showSection('chatSection'));
            document.getElementById('manageStudentsButton')?.addEventListener('click', () => showSection('studentManagementSection'));
            document.getElementById('toggleProfileButton')?.addEventListener('click', () => showSection('profileSection'));
            document.getElementById('toggleTutorialButton')?.addEventListener('click', () => showSection('tutorialSection'));
            document.getElementById('togglePastPapersButton')?.addEventListener('click', () => showSection('pastPapersSection'));
            document.getElementById('toggleExercisesButton')?.addEventListener('click', () => showSection('exerciseSection'));
            document.getElementById('userDisplayName')?.addEventListener('click', () => showSection('profileSection'));
        }
        setupSectionToggle();
        
        // --- PROFILE MANAGEMENT ---

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) { showModal('Error', 'You must be logged in to save your profile.'); return; }
            
            const formData = new FormData(e.target);
            const profileData = Object.fromEntries(formData.entries());
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            try {
                await setDoc(userProfileRef, profileData, { merge: true });
                currentUserName = profileData.name;
                document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
                showModal('Success', 'Your profile has been updated!');
            } catch (error) {
                console.error("Error saving profile:", error);
                showModal('Error', `Could not save profile: ${error.message}`);
            }
        });

        async function loadProfileData() {
            if (!currentUserId) return;
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            const docSnap = await getDoc(userProfileRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('profileName').value = data.name || '';
                document.getElementById('profileAge').value = data.age || '';
                document.getElementById('profileGrade').value = data.grade || '';
                document.getElementById('profileSchool').value = data.school || '';
                document.getElementById('profileElectives').value = data.electives || '';
            }
        }
        
        // --- RECURSIVE FINDER-STYLE MATERIALS MANAGEMENT ---

        const materialsConfig = {
            tutorials: {
                collectionName: 'tutorial_items',
                title: 'Tutorial Videos',
                itemTypes: { folder: 'Folder', video: 'Video' }
            },
            pastPapers: {
                collectionName: 'pastpaper_items',
                title: 'Past Papers',
                itemTypes: { folder: 'Folder', paper: 'Paper' }
            },
            exercises: {
                collectionName: 'exercise_items',
                title: 'Exercises for Sale',
                itemTypes: { folder: 'Folder', exercise: 'Exercise' },
                isPaid: true
            }
        };
        
        function getItemsCollectionRef(type) {
            return collection(db, `artifacts/${appId}/public/data/${materialsConfig[type].collectionName}`);
        }

        function initializeAllMaterialSections() {
            for (const type in materialsConfig) {
                setupMaterialSection(type);
            }
        }

        function setupMaterialSection(type) {
            const config = materialsConfig[type];
            const section = document.getElementById(`${type}Section`);
            section.innerHTML = `
                <!-- Embedded View -->
                <div class="finder-container embedded-view" style="display: flex;">
                    <div class="finder-toolbar"></div>
                    <div class="finder-content"></div>
                </div>
                <!-- Windowed View -->
                <div class="finder-window-wrapper windowed-view">
                    <div class="finder-window-titlebar">
                        <div class="buttons">
                          <div class="circle close"></div>
                          <div class="circle min"></div>
                          <div class="circle max"></div>
                        </div>
                    </div>
                    <div class="finder-container">
                         <div class="finder-toolbar"></div>
                         <div class="finder-content"></div>
                    </div>
                </div>
            `;
            
            // Populate toolbars for both views
            document.querySelectorAll(`#${type}Section .finder-toolbar`).forEach(toolbar => {
                let toolbarHtml = '';
                 if (currentUserRole === 'teacher') {
                    toolbarHtml += `<button class="add-folder-btn btn-primary" style="padding: 6px 12px; font-size: 0.875rem;">New Folder</button>`;
                    const itemTypeKeys = Object.keys(config.itemTypes).filter(k => k !== 'folder');
                    if (itemTypeKeys.length > 0) {
                         toolbarHtml += `<button class="add-item-btn btn-primary" style="padding: 6px 12px; font-size: 0.875rem;">New ${config.itemTypes[itemTypeKeys[0]]}</button>`;
                    }
                }
                toolbarHtml += `<button class="view-toggle-btn" style="margin-left: auto; background: none; border: 1px solid var(--text-secondary); color: var(--text-secondary); padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">Window View</button>`;
                toolbar.innerHTML = toolbarHtml;
            });
            
            // Set up event listeners
            section.addEventListener('click', (e) => {
                const finderContainer = e.target.closest('.finder-container');
                if (!finderContainer) return;

                const currentPath = JSON.parse(finderContainer.dataset.path || '[]');
                const parentId = currentPath.length > 0 ? currentPath[currentPath.length - 1].id : 'root';

                if (e.target.matches('.add-folder-btn')) {
                    showAddItemModal(type, 'folder', parentId);
                } else if (e.target.matches('.add-item-btn')) {
                    const itemType = Object.keys(config.itemTypes).find(k => k !== 'folder');
                    showAddItemModal(type, itemType, parentId);
                } else if (e.target.closest('.finder-item')) {
                    handleFinderClick(e.target.closest('.finder-item'), type, finderContainer);
                }
            });
            
            // Window view toggle and controls
            const windowWrapper = section.querySelector('.windowed-view');
            const embeddedView = section.querySelector('.embedded-view');
            section.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.onclick = () => {
                    const isEmbedded = embeddedView.style.display === 'flex';
                    windowWrapper.style.display = isEmbedded ? 'flex' : 'none';
                    embeddedView.style.display = isEmbedded ? 'none' : 'flex';
                    btn.textContent = isEmbedded ? 'Embed View' : 'Window View';
                    const targetContainer = isEmbedded ? windowWrapper : embeddedView;
                    renderFinder(type, 'root', targetContainer.querySelector('.finder-content'));
                };
            });
            setupWindowControls(windowWrapper);

            // Initial render
            renderFinder(type, 'root', embeddedView.querySelector('.finder-content'));
        }

        async function renderFinder(type, parentId, contentContainer, activePath = []) {
            contentContainer.innerHTML = ''; // Clear previous content
            contentContainer.dataset.path = JSON.stringify(activePath);

            // Re-render columns from the active path
            let currentParentId = 'root';
            for (const pathItem of activePath) {
                const columnEl = await createColumn(type, currentParentId, contentContainer);
                // Mark the active item in the column
                const activeItemEl = Array.from(columnEl.children).find(child => child.dataset.id === pathItem.id);
                if (activeItemEl) activeItemEl.classList.add('active');
                currentParentId = pathItem.id;
            }
            
            // Render the new "current" column
            await createColumn(type, parentId, contentContainer);
        }

        async function createColumn(type, parentId, contentContainer) {
            const columnEl = document.createElement('div');
            columnEl.className = 'finder-column';
            columnEl.dataset.parentId = parentId;
            contentContainer.appendChild(columnEl);
            columnEl.innerHTML = `<p class="loading-indicator">Loading...</p>`;

            const queries = [where("parentId", "==", parentId), orderBy("name")];
            if (currentUserRole !== 'teacher') {
                queries.unshift(where('isVisibleToStudents', '==', true));
            }
            const q = query(getItemsCollectionRef(type), ...queries);
            
            try {
                const snapshot = await getDocs(q);
                columnEl.innerHTML = '';
                if (snapshot.empty) {
                    columnEl.innerHTML = `<p style="padding: 12px; color: var(--text-secondary);">Empty</p>`;
                }
                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    const itemEl = document.createElement('div');
                    itemEl.className = 'finder-item';
                    itemEl.dataset.id = item.id;
                    itemEl.dataset.itemData = JSON.stringify(item);

                    let teacherActions = '';
                    if (currentUserRole === 'teacher') {
                        teacherActions = `<div class="item-actions"><button class="delete-btn" title="Delete">✖</button></div>`;
                    }
                    
                    itemEl.innerHTML = `
                        <span>${item.itemType === 'folder' ? '📁' : '📄'}</span>
                        <span class="item-name">${item.name}</span>
                        ${teacherActions}
                        ${item.itemType === 'folder' ? '<span class="arrow">›</span>' : ''}
                    `;
                    columnEl.appendChild(itemEl);
                });
            } catch (error) {
                console.error(`Error rendering column for ${type}:`, error);
                columnEl.innerHTML = `<p class="error-message" style="padding: 12px;">Error loading items.</p>`;
            }
            return columnEl;
        }

        function handleFinderClick(itemEl, type, finderContainer) {
            const item = JSON.parse(itemEl.dataset.itemData);
            const contentContainer = finderContainer.querySelector('.finder-content');
            
            // Determine the new path
            const currentColumn = itemEl.closest('.finder-column');
            const allColumns = Array.from(contentContainer.querySelectorAll('.finder-column'));
            const columnIndex = allColumns.indexOf(currentColumn);
            const currentPath = JSON.parse(contentContainer.dataset.path || '[]');
            const newPath = currentPath.slice(0, columnIndex);
            newPath.push(item);

            // Handle delete button click
            if(event.target.matches('.delete-btn')) {
                event.stopPropagation();
                handleDeleteItem(type, item, finderContainer);
                return;
            }

            if (item.itemType === 'folder') {
                renderFinder(type, item.id, contentContainer, newPath);
            } else {
                // Remove selection from other items in the same column
                currentColumn.querySelectorAll('.finder-item').forEach(el => el.classList.remove('active'));
                itemEl.classList.add('active');
                renderPreviewPane(type, item, contentContainer);
            }
        }

        function renderPreviewPane(type, item, contentContainer) {
            // Remove existing preview pane first
            let previewPane = contentContainer.querySelector('.finder-preview-pane');
            if (previewPane) previewPane.remove();

            previewPane = document.createElement('div');
            previewPane.className = 'finder-preview-pane';
            contentContainer.appendChild(previewPane);
            
            previewPane.style.display = 'flex';
            const config = materialsConfig[type];

            let thumbnailHtml = `<img src="https://placehold.co/400x225/${getComputedStyle(document.body).getPropertyValue('--bg-tertiary').substring(1).replace('#','')}/${getComputedStyle(document.body).getPropertyValue('--text-secondary').substring(1).replace('#','')}?text=${item.itemType}" class="preview-thumbnail" alt="Placeholder">`;
            if (item.itemType === 'video' && item.youtubeId) {
                 thumbnailHtml = `<img src="https://img.youtube.com/vi/${item.youtubeId}/hqdefault.jpg" class="preview-thumbnail" alt="Video thumbnail">`;
            }

            let actionsHtml = `<button class="preview-btn btn-primary">Preview</button>`;
            if (currentUserRole === 'teacher') {
                const isVisible = item.isVisibleToStudents !== false;
                actionsHtml += `
                    <label class="switch" title="Visible to students">
                      <input type="checkbox" class="visibility-toggle" ${isVisible ? 'checked' : ''}>
                      <span class="slider round"></span>
                    </label>
                `;
            } else if (config.isPaid) {
                actionsHtml = `<button class="add-to-cart-btn btn-primary" data-price="${item.price}">Add to Cart - $${item.price.toFixed(2)}</button>`;
            }

            previewPane.innerHTML = `
                ${thumbnailHtml}
                <h3 class="preview-title">${item.name}</h3>
                <div class="preview-actions">${actionsHtml}</div>
            `;
            
            previewPane.querySelector('.preview-btn').onclick = () => handlePreview(type, item);
            if (currentUserRole === 'teacher') {
                previewPane.querySelector('.visibility-toggle').onchange = (e) => toggleMaterialVisibility(type, item.id, e.target.checked);
            }
        }
        
        async function toggleMaterialVisibility(type, itemId, isVisible) {
            const docRef = doc(getItemsCollectionRef(type), itemId);
            try {
                await updateDoc(docRef, { isVisibleToStudents: isVisible });
            } catch (error) {
                showModal('Error', `Could not update visibility: ${error.message}`);
            }
        }

        function handlePreview(type, item) {
            if (item.itemType === 'video') {
                const videoPreviewModal = document.getElementById('videoPreviewModal');
                document.getElementById('videoPreviewTitle').textContent = item.name;
                document.getElementById('videoPreviewContent').innerHTML = `<iframe src="https://www.youtube.com/embed/${item.youtubeId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                videoPreviewModal.style.display = 'flex';
            } else {
                if (item.link) window.open(item.link, '_blank');
                else showModal('Preview Error', 'No link available for this item.');
            }
        }

        function showAddItemModal(type, itemType, parentId) {
            const config = materialsConfig[type];
            const modal = document.getElementById('addItemModal');
            const form = document.getElementById('addItemForm');
            form.reset();
            
            document.getElementById('addItemModalTitle').textContent = `Add New ${config.itemTypes[itemType]}`;
            document.getElementById('addItemMaterialType').value = type;
            document.getElementById('addItemType').value = itemType;
            document.getElementById('addItemParentId').value = parentId;

            const fieldsContainer = document.getElementById('addItemFields');
            fieldsContainer.innerHTML = '';
            if (itemType === 'video') {
                fieldsContainer.innerHTML = `<label for="addItemLink">YouTube Link</label><input type="url" id="addItemLink" required placeholder="https://youtube.com/watch?v=...">`;
            } else if (itemType === 'paper' || itemType === 'exercise') {
                 fieldsContainer.innerHTML = `<label for="addItemLink">File Link</label><input type="url" id="addItemLink" required placeholder="https://example.com/file.pdf">`;
                 if (itemType === 'exercise') {
                      fieldsContainer.innerHTML += `<label for="addItemPrice">Price (USD)</label><input type="number" id="addItemPrice" required step="0.01" min="0">`;
                 }
            }
            
            modal.style.display = 'flex';
        }

        document.getElementById('addItemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const materialType = document.getElementById('addItemMaterialType').value;
            const itemType = document.getElementById('addItemType').value;
            const parentId = document.getElementById('addItemParentId').value;
            const name = document.getElementById('addItemName').value;
            
            const dataToSave = { name, parentId, itemType, isVisibleToStudents: true, timestamp: Date.now() };

            if (itemType === 'video') {
                const link = document.getElementById('addItemLink').value;
                const videoDetails = parseVideoInput(link);
                if (!videoDetails || videoDetails.type !== 'youtube') return showModal('Error', 'Please enter a valid YouTube video link.');
                dataToSave.youtubeId = videoDetails.id;
            } else if (itemType === 'paper' || itemType === 'exercise') {
                dataToSave.link = document.getElementById('addItemLink').value;
                if (itemType === 'exercise') {
                    dataToSave.price = parseFloat(document.getElementById('addItemPrice').value);
                }
            }

            try {
                await addDoc(getItemsCollectionRef(materialType), dataToSave);
                showModal('Success', 'Item added!');
                document.getElementById('addItemModal').style.display = 'none';
                
                // Refresh the view
                const section = document.getElementById(`${materialType}Section`);
                const visibleView = section.querySelector('.embedded-view, .windowed-view');
                renderFinder(materialType, parentId, visibleView.querySelector('.finder-content'), JSON.parse(visibleView.querySelector('.finder-content').dataset.path || '[]'));

            } catch (error) {
                showModal('Error', `Could not add item: ${error.message}`);
            }
        });

        function handleDeleteItem(type, item, finderContainer) {
             showModal('Confirm Deletion', `Are you sure you want to delete "${item.name}"? This action cannot be undone.`, [
                { text: 'Delete', className: 'btn-primary', onClick: async () => {
                    try {
                        // WARNING: This only deletes the item itself. A recursive delete for folders
                        // requires a Cloud Function for reliability.
                        await deleteDoc(doc(getItemsCollectionRef(type), item.id));
                        showModal('Success', `"${item.name}" deleted.`);
                        // Refresh the view
                        const contentContainer = finderContainer.querySelector('.finder-content');
                        renderFinder(type, item.parentId, contentContainer, JSON.parse(contentContainer.dataset.path || '[]').slice(0,-1));

                    } catch(e) {
                         showModal('Error', `Could not delete item: ${e.message}`);
                    }
                }},
                { text: 'Cancel', className: 'logout-btn' }
            ]);
        }

        function setupWindowControls(windowWrapper) {
            const dragBar = windowWrapper.querySelector('.finder-window-titlebar');
            const closeBtn = windowWrapper.querySelector('.circle.close');
            const maxBtn = windowWrapper.querySelector('.circle.max');
            let isDragging = false, offsetX, offsetY;

            dragBar.onmousedown = (e) => {
                if (e.target.classList.contains('circle')) return;
                isDragging = true;
                offsetX = e.clientX - windowWrapper.offsetLeft;
                offsetY = e.clientY - windowWrapper.offsetTop;
                document.onmousemove = (ev) => {
                    if (isDragging) {
                        windowWrapper.style.left = `${ev.clientX - offsetX}px`;
                        windowWrapper.style.top = `${ev.clientY - offsetY}px`;
                    }
                };
                document.onmouseup = () => {
                    isDragging = false;
                    document.onmousemove = null;
                    document.onmouseup = null;
                };
            };
            
            closeBtn.onclick = () => {
                windowWrapper.style.display = 'none';
                const embeddedView = windowWrapper.parentElement.querySelector('.embedded-view');
                embeddedView.style.display = 'flex';
                embeddedView.querySelector('.view-toggle-btn').textContent = 'Window View';
            };

            maxBtn.onclick = () => {
                windowWrapper.classList.toggle('fullscreen');
            };
        }
        
        // --- E-COMMERCE LOGIC ---
        function addToCart(item) { /* Unchanged */ }
        function removeFromCart(itemId) { /* Unchanged */ }
        function updateCartUI() { /* Unchanged */ }
        async function handleCheckout() { /* Unchanged */ }
        async function checkForSuccessfulPurchase() { /* Unchanged */ }


        // --- VIDEO PARSING ---
        function parseVideoInput(input) {
            const text = input.trim();
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const youtubeMatch = text.match(youtubeRegex);
            if (youtubeMatch && youtubeMatch[1]) {
                return { type: 'youtube', id: youtubeMatch[1] };
            }
            if (text.startsWith('<iframe') && text.endsWith('>')) {
                return { type: 'embed', code: text };
            }
            return null;
        }
        
        // --- GRADING & CHAT & OTHER ---
        function setupDropZone(dropZoneId, fileInputId, fileNameDisplayId, filePreviewId = null) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            const fileNameDisplay = document.getElementById(fileNameDisplayId);
            const filePreview = filePreviewId ? document.getElementById(filePreviewId) : null;

            if (!dropZone || !fileInput || !fileNameDisplay) return;

            dropZone.addEventListener('click', () => fileInput.click());
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => dropZone.addEventListener(eName, e => {e.preventDefault(); e.stopPropagation();}));
            ['dragenter', 'dragover'].forEach(eName => dropZone.addEventListener(eName, () => dropZone.classList.add('highlight')));
            ['dragleave', 'drop'].forEach(eName => dropZone.addEventListener(eName, () => dropZone.classList.remove('highlight')));

            dropZone.addEventListener('drop', e => {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            });

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    fileNameDisplay.textContent = file.name;
                    if (filePreview && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => { filePreview.src = e.target.result; filePreview.style.display = 'block'; };
                        reader.readAsDataURL(file);
                    } else if (filePreview && file.type === 'application/pdf') {
                        pdfjsLib.getDocument({ url: URL.createObjectURL(file) }).promise.then(pdf => pdf.getPage(1)).then(page => {
                            const viewport = page.getViewport({ scale: 1.0 });
                            const canvas = document.createElement('canvas');
                            canvas.height = viewport.height; canvas.width = viewport.width;
                            page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise.then(() => {
                                filePreview.src = canvas.toDataURL('image/png');
                                filePreview.style.display = 'block';
                                canvas.remove();
                            });
                        }).catch(err => { console.error("PDF Preview Error:", err); if(filePreview) filePreview.style.display = 'none';});
                    } else {
                        if(filePreview) filePreview.style.display = 'none';
                    }
                } else {
                    fileNameDisplay.textContent = 'No file chosen';
                    if(filePreview) {
                        filePreview.style.display = 'none';
                        filePreview.src = '';
                    }
                }
            });
        }
        setupDropZone('studentDropZone', 'studentAnswerFile', 'studentFileName', 'studentFilePreview');
        setupDropZone('answerKeyDropZone', 'answerKeyFile', 'answerKeyFileName', 'answerKeyFilePreview');
        
        // --- CHAT IMPLEMENTATION ---
        const chatInput = document.getElementById('chatInput');
        const sendChatButton = document.getElementById('sendChatButton');

        async function handleSendMessage() {
            const messageText = chatInput.value.trim();
            if (!messageText) return;

            appendChatMessage(messageText, 'user');
            chatInput.value = '';
            chatInput.disabled = true;
            sendChatButton.disabled = true;

            appendChatMessage('...', 'loading');

            geminiChatHistory.push({ role: "user", parts: [{ text: messageText }] });
            
            try {
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: geminiChatHistory })
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);

                const data = await response.json();
                const geminiResponse = data.candidates[0].content.parts[0].text;
                
                geminiChatHistory.push({ role: "model", parts: [{ text: geminiResponse }] });
                
                document.querySelector('.chat-message.loading')?.remove();
                appendChatMessage(geminiResponse, 'gemini');

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                document.querySelector('.chat-message.loading')?.remove();
                appendChatMessage(`Sorry, I encountered an error: ${error.message}`, 'gemini');
            } finally {
                chatInput.disabled = false;
                sendChatButton.disabled = false;
                chatInput.focus();
            }
        }

        function appendChatMessage(text, sender) {
            const chatDisplay = document.getElementById('chatDisplay');
            const messageDiv = document.createElement('div');
            
            if (sender === 'loading') {
                messageDiv.className = 'chat-message loading';
                messageDiv.innerHTML = `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
            } else {
                messageDiv.className = `chat-message ${sender}`;
                messageDiv.textContent = text;
            }
            
            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }

        sendChatButton.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

        // --- STUDENT MANAGEMENT IMPLEMENTATION ---
        document.getElementById('addStudentButton').addEventListener('click', async () => { /* Unchanged */ });
        async function loadAuthorizedStudents() { /* Unchanged */ }
        async function deleteStudent(e) { /* Unchanged */ }

        function showModal(title, message, buttons = []) {
            const messageModal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = '';

            if (buttons.length === 0) {
                 const okButton = document.createElement('button');
                 okButton.textContent = 'OK';
                 okButton.className = 'btn-primary';
                 okButton.onclick = () => { messageModal.style.display = 'none'; };
                 modalButtons.appendChild(okButton);
            } else {
                 buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.textContent = btnConfig.text;
                    button.className = btnConfig.className;
                    button.onclick = () => { 
                        messageModal.style.display = 'none';
                        if (btnConfig.onClick) btnConfig.onClick();
                    };
                    modalButtons.appendChild(button);
                });
            }
            messageModal.style.display = 'flex';
        }
        
        function showInputModal(title, label, callback) {
            const messageModal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = `<label for="modalInput" style="display:block; margin-bottom:8px;">${label}</label><input type="text" id="modalInput" style="width: 100%;" required>`;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = ''; 

            const modalInput = document.getElementById('modalInput');
            
            const handleSave = () => {
                const value = modalInput.value.trim();
                if (value) {
                    messageModal.style.display = 'none';
                    callback(value);
                } else {
                    modalInput.style.border = '1px solid var(--accent-red)';
                    modalInput.focus();
                }
            };

            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.className = 'btn-primary';
            saveButton.onclick = handleSave;
            modalButtons.appendChild(saveButton);

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.className = 'logout-btn';
            cancelButton.onclick = () => { messageModal.style.display = 'none'; };
            modalButtons.appendChild(cancelButton);

            messageModal.style.display = 'flex';
            modalInput.focus();
            modalInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); saveButton.click(); } });
        }

        document.querySelectorAll('.modal .close-button').forEach(btn => btn.onclick = () => { 
            const modal = btn.closest('.modal');
            modal.style.display = 'none'; 
            if (modal.id === 'videoPreviewModal') {
                document.getElementById('videoPreviewContent').innerHTML = '';
            }
        });

        const themeToggleButton = document.getElementById('themeToggleButton');
        function applyTheme(theme) { document.body.classList.toggle('light-theme', theme === 'light'); }
        function loadTheme() { applyTheme(localStorage.getItem('ai-marker-theme') || 'dark'); }
        themeToggleButton.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('ai-marker-theme', newTheme);
        });

        loadTheme();
    </script>
</body>
</html>
