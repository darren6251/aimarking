<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Marker</title>
    <!-- PDF.js library for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- Custom styles -->
    <style>
        /* Base Dark Theme Variables */
        :root {
            --bg-primary: #0d1117; /* Black */
            --bg-secondary: #161b22; /* Dark Gray */
            --text-primary: #c9d1d9; /* Light Gray */
            --text-secondary: #8b949e; /* Muted gray for secondary text */
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --border-color: #30363d;
            --button-hover-darken: #21262d;
            --button-primary-lighten: #2ea043; /* Green hover */
            --button-blue-lighten: #4c9aff; /* Blue hover */
            --button-red-lighten: rgba(248, 81, 73, 0.1); /* Red hover */
            --neon-glow-color: #58a6ff; /* Neon blue for dark theme */

            /* Finder Window Specific Variables (Dark Theme) */
            --finder-bg-primary: #161b22;
            --finder-bg-secondary: #0d1117;
            --finder-text-primary: #c9d1d9;
            --finder-text-secondary: #8b949e;
            --finder-border-color: #30363d;
            --finder-titlebar-bg: #1f252d;
            --finder-hover-bg: #21262d;
            --finder-active-bg: var(--accent-blue);
            --finder-active-text: #0d1117;
        }

        /* Light Theme Variables - Overrides for .light-theme class */
        body.light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f2f5;
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent-blue: #007bff;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --border-color: #cccccc;
            --button-hover-darken: #e2e6ea;
            --button-primary-lighten: #218838;
            --button-blue-lighten: #0069d9;
            --button-red-lighten: rgba(220, 53, 69, 0.1);
            --neon-glow-color: #007bff; /* Neon blue for light theme */

            /* Finder Window Specific Variables (Light Theme) */
            --finder-bg-primary: #f8f9fa;
            --finder-bg-secondary: #ffffff;
            --finder-text-primary: #212529;
            --finder-text-secondary: #6c757d;
            --finder-border-color: #dee2e6;
            --finder-titlebar-bg: #e9ecef;
            --finder-hover-bg: #e9ecef;
            --finder-active-bg: var(--accent-blue);
            --finder-active-text: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", sans-serif;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            overflow: hidden; /* Prevent body scroll when finder is open */
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        button,
        input,
        textarea,
        select {
            transition: all .2s ease-out;
            font-family: inherit;
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        /* Keyframe animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* LOGIN PAGE: Full screen wrapper */
        #authWrapper {
            display: none; /* Correctly hidden initially */
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1001;
        }

        .login-left-panel,
        .login-right-panel {
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .login-left-panel {
            background: var(--bg-primary);
            color: var(--text-primary);
            flex-direction: column;
            text-align: center;
        }

        .login-left-panel h1 {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 1rem;
        }

        .login-left-panel p {
            font-size: 1.75rem;
            font-weight: 400;
            line-height: 1.3;
            margin-bottom: .5rem;
            color: var(--text-secondary);
        }

        .login-right-panel {
            background: var(--bg-secondary);
            flex-direction: column;
        }
        
        #authContainer {
            width: 100%;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            background-color: var(--bg-primary);
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #authContainer h2 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: .75rem;
            cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        .google-btn:hover { background-color: var(--button-hover-darken); border-color: var(--text-secondary); }
        .google-btn img { height: 20px; }
        
        #accessCodeInput {
             background-color: var(--bg-secondary);
             border: 1px solid var(--border-color);
             color: var(--text-primary);
             padding: 12px;
             border-radius: 6px;
             width: 100%;
             margin-bottom: 1rem;
             text-align: center;
        }
        #accessCodeInput:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
        }

        .btn-primary {
             background-color: var(--accent-green);
             color: #fff;
             padding: .75rem 1.5rem;
             border-radius: 6px;
             border: none;
             cursor: pointer;
             font-weight: 600;
        }
        .btn-primary:hover {
             background-color: var(--button-primary-lighten);
             transform: translateY(-1px);
        }
        
        #appSection {
            display: none;
            flex-direction: column;
            height: 100vh;
            background-color: var(--bg-primary);
            animation: fadeIn .6s ease-out both;
        }
        
        header {
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            padding: 0 24px;
            height: 64px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            position: relative;
            z-index: 1001;
        }
        
        .logo-container { display: flex; align-items: center; gap: 1rem; }
        .logo-container h1 { font-size: 1.5rem; font-weight: 700; }
        .logo-container p { font-weight: 400; color: var(--text-secondary); }
        
        .header-actions { margin-left: auto; display: flex; align-items: center; gap: 1rem; }

        /* --- START: NEON BUTTON STYLES --- */
        .header-actions .tab.neon-button {
            position: relative;
            display: inline-block;
            padding: 10px 18px; /* Adjusted padding */
            color: var(--neon-glow-color);
            text-decoration: none;
            overflow: hidden;
            transition: .5s;
            border: 1px solid var(--neon-glow-color);
            border-radius: 6px;
            background: transparent;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.875rem; /* Adjusted font size */
        }
        
        .header-actions .tab.neon-button:hover,
        .header-actions .tab.neon-button.active {
            background: var(--neon-glow-color);
            color: var(--bg-secondary);
            border-radius: 66px;
            box-shadow: 0 0 5px var(--neon-glow-color),
                        0 0 25px var(--neon-glow-color),
                        0 0 50px var(--neon-glow-color),
                        0 0 100px var(--neon-glow-color);
        }

        .header-actions .tab.neon-button span {
            position: absolute;
            display: block;
        }

        .header-actions .tab.neon-button span:nth-child(1) {
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--neon-glow-color));
            animation: btn-anim1 1.5s linear infinite;
        }

        @keyframes btn-anim1 {
            0% { left: -100%; }
            50%,100% { left: 100%; }
        }

        .header-actions .tab.neon-button span:nth-child(2) {
            top: -100%;
            right: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, transparent, var(--neon-glow-color));
            animation: btn-anim2 1.5s linear infinite;
            animation-delay: .375s
        }

        @keyframes btn-anim2 {
            0% { top: -100%; }
            50%,100% { top: 100%; }
        }

        .header-actions .tab.neon-button span:nth-child(3) {
            bottom: 0;
            right: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(270deg, transparent, var(--neon-glow-color));
            animation: btn-anim3 1.5s linear infinite;
            animation-delay: .75s
        }

        @keyframes btn-anim3 {
            0% { right: -100%; }
            50%,100% { right: 100%; }
        }

        .header-actions .tab.neon-button span:nth-child(4) {
            bottom: -100%;
            left: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(360deg, transparent, var(--neon-glow-color));
            animation: btn-anim4 1.5s linear infinite;
            animation-delay: 1.125s
        }

        @keyframes btn-anim4 {
            0% { bottom: -100%; }
            50%,100% { bottom: 100%; }
        }
        /* --- END: NEON BUTTON STYLES --- */


        .user-info { display: flex; align-items: center; gap: 1rem; }
        #userDisplayName { font-weight: 500; cursor: pointer; }
        .logout-btn { background: none; border: 1px solid var(--accent-red); color: var(--accent-red); cursor: pointer; padding: 6px 12px; border-radius: 6px; font-weight: 600; }
        .logout-btn:hover { background: var(--button-red-lighten); }
        /* Style for Switch Role button */
        #switchRoleButton {
            background-color: var(--accent-blue);
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        #switchRoleButton:hover {
            background-color: var(--button-blue-lighten);
        }

        /* --- START: DROPDOWN STYLES --- */
        .dropdown-menu {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-menu-content {
            display: none;
            position: absolute;
            top: 100%; 
            left: 0;
            background-color: var(--bg-secondary);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
            z-index: 10;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding: 4px;
            margin-top: 8px;
        }

        .dropdown-menu-content button {
            color: var(--text-primary);
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .dropdown-menu-content button:hover {
            background-color: var(--button-hover-darken);
            color: var(--accent-blue);
        }

        .dropdown-menu:hover .dropdown-menu-content {
            display: block;
        }
        /* --- END: DROPDOWN STYLES --- */

        /* --- START: TAB BAR STYLES --- */
        #minimizedTabsBar {
            background: var(--bg-primary);
            height: 40px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 8px;
            flex-shrink: 0;
            position: relative;
            z-index: 1000;
        }
        .minimized-tab {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .minimized-tab:hover {
            background: var(--button-hover-darken);
            color: var(--text-primary);
        }
        .minimized-tab.active {
            background: var(--accent-blue);
            color: #fff;
            border-color: var(--accent-blue);
        }
        /* --- END: TAB BAR STYLES --- */


        main {
            flex: 1;
            display: flex;
            overflow-y: auto;
            padding: 24px;
            gap: 24px;
            position: relative;
        }
        
        /* Content Sections */
        #homeSection, #gradingSection, #chatSection, #studentManagementSection, #profileSection, #tutorialSection, #pastPapersSection, #exerciseSection {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            width: 100%;
        }
        #profileSection { max-width: 800px; margin: 0 auto; }

        /* Form elements */
        label { display: block; font-weight: 600; margin-bottom: 8px; }
        input[type="text"], input[type="number"], input[type="email"], select, input[type="url"] {
            width: 100%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 12px; border-radius: 6px; margin-bottom: 1rem;
        }
        textarea {
            width: 100%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 12px; border-radius: 6px; margin-bottom: 1rem; resize: vertical; min-height: 120px;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3); }
        
        .drop-zone { border: 2px dashed var(--border-color); border-radius: 6px; min-height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 1rem; margin-bottom: 1.5rem; cursor: pointer; word-wrap: break-word; padding: 1rem; text-align: center; }
        .drop-zone.highlight { border-color: var(--accent-blue); background: rgba(88, 166, 255, .1); }
        
        .file-preview { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; max-height: 200px; object-fit: contain; }
        .error-message { color: var(--accent-red); font-size: 0.875rem; margin-top: -0.5rem; margin-bottom: 1rem; }

        #gradeButton { background-color: var(--accent-green); color: #fff; }
        #gradeButton:hover { background-color: var(--button-primary-lighten); }

        #resultContainer { margin-top: 1.5rem; padding: 1rem; border-radius: 6px; background-color: var(--bg-secondary); border: 1px solid var(--border-color); min-height: 100px; white-space: pre-wrap; }
        
        /* Chat styles */
        #chatSection, #studentManagementSection { display: none; flex-direction: column; gap: 1rem; }
        #chatDisplay { flex: 1; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { max-width: 85%; padding: 10px 14px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; }
        .chat-message.user { background-color: var(--accent-blue); color: var(--bg-primary); align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-message.gemini { background-color: var(--button-hover-darken); align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-input-wrapper { display: flex; gap: .5rem; flex-shrink: 0; }
        #chatInput { flex: 1; padding: .75rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-secondary); color: var(--text-primary); }
        #sendChatButton { padding: .5rem 1rem; border: none; background: var(--accent-blue); color: var(--bg-primary); border-radius: 6px; font-weight: 600; cursor: pointer; }
        #sendChatButton:hover { background-color: var(--button-blue-lighten); }
        
        .loading-indicator { text-align: center; padding: 1rem; color: var(--text-secondary); }

        /* Universal Section Title */
        .section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; }

        /* Form container */
        .form-container { max-width: 600px; margin-bottom: 2rem; background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color); }
        
        /* --- E-COMMERCE STYLES --- */
        .store-layout { display: flex; gap: 24px; width: 100%; }
        .product-grid { flex-grow: 1; }
        .shopping-cart { width: 320px; flex-shrink: 0; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; height: fit-content; }
        .shopping-cart h3 { font-size: 1.25rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        #cart-items { display: flex; flex-direction: column; gap: 0.75rem; max-height: 300px; overflow-y: auto; margin-bottom: 1rem; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; }
        .cart-item-name { flex-grow: 1; margin-right: 1rem; }
        .cart-item-price { font-weight: 600; color: var(--accent-green); }
        .remove-from-cart-btn { background: none; border: none; color: var(--accent-red); cursor: pointer; font-size: 1rem; margin-left: 0.5rem; }
        #cart-summary { border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem; }
        .summary-line { display: flex; justify-content: space-between; font-weight: 600; margin-bottom: 0.5rem; }
        #checkout-btn { width: 100%; margin-top: 1rem; }
        .product-card { background-color: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color); padding: 1rem; display: flex; flex-direction: column; justify-content: space-between; }
        .product-card h4 { font-size: 1.1rem; margin-bottom: 0.5rem; }
        .product-price { font-size: 1.25rem; font-weight: 700; color: var(--accent-green); margin-bottom: 1rem; }
        .add-to-cart-btn, .download-btn { width: 100%; }
        .download-btn { background-color: var(--accent-blue); }
        .download-btn:hover { background-color: var(--button-blue-lighten); }

        /* Teacher Purchase History Styles */
        .purchase-history-section { margin-top: 2rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color); }
        .purchase-history-section h3 { font-size: 1.25rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; color: var(--accent-blue); }
        .student-purchase-entry { margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color); }
        .student-purchase-entry strong { display: block; margin-bottom: 0.5rem; color: var(--accent-green); }
        .purchased-item-detail { font-size: 0.9rem; margin-left: 1rem; color: var(--text-secondary); }


        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1002; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; animation: fadeIn 0.3s ease-out; }
        .modal-content { background-color: var(--bg-secondary); padding: 30px; border-radius: 8px; border: 1px solid var(--border-color); max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; animation: slideInUp 0.3s ease-out; }
        #modalTitle { margin-bottom: 1rem; font-size: 1.5rem; font-weight: 600; }
        #modalMessage { line-height: 1.5; }
        .close-button { position: absolute; top: 10px; right: 15px; font-size: 28px; cursor: pointer; color: var(--text-secondary); }
        .close-button:hover { color: var(--text-primary); }
        #modalButtons { display:flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }

        /* --- START: Finder Window Styles --- */
        .finder-window-wrapper {
            position: fixed;
            top: calc(64px + 40px + 24px); /* Header + Tab Bar + Margin */
            left: 50%;
            transform: translateX(-50%);
            width: 90vw;
            height: calc(100vh - 64px - 40px - 48px); /* Full height minus headers and margins */
            max-width: 1600px;
            border: 1px solid var(--finder-border-color);
            border-radius: 8px;
            background: var(--finder-bg-primary);
            overflow: hidden;
            display: none; /* Initially hidden */
            flex-direction: column;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 999;
            resize: both;
            min-width: 500px;
            min-height: 400px;
            color: var(--finder-text-primary);
            transition: opacity 0.3s, transform 0.3s;
        }

        .finder-window-wrapper.fullscreen {
            top: 0 !important;
            left: 0 !important;
            transform: none !important;
            width: 100vw !important;
            height: 100vh !important;
            border-radius: 0 !important;
            max-width: 100vw;
            max-height: 100vh;
            z-index: 1002;
        }

        .finder-titlebar {
            background: var(--finder-titlebar-bg);
            height: 38px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            cursor: grab;
            user-select: none;
            flex-shrink: 0;
            border-bottom: 1px solid var(--finder-border-color);
        }
        .finder-titlebar:active { cursor: grabbing; }

        .finder-titlebar .buttons { display: flex; gap: 8px; margin-right: 12px; }
        .finder-circle { width: 13px; height: 13px; border-radius: 50%; cursor: pointer; }
        .finder-circle.close { background: #ff5f57; }
        .finder-circle.min { background: #ffbd2e; }
        .finder-circle.max { background: #28c840; }
        .finder-title { font-weight: 600; font-size: 1rem; color: var(--finder-text-primary); }

        .finder-content {
            flex: 1;
            display: flex;
            min-height: 0;
            overflow-x: auto;
        }

        .finder-column {
            min-width: 220px;
            width: 25%;
            height: 100%;
            border-right: 1px solid var(--finder-border-color);
            overflow-y: auto;
            flex-shrink: 0;
            padding: 5px;
        }
        .finder-column:last-child { border-right: none; }

        .finder-item {
            padding: 8px 10px;
            font-size: 0.9rem;
            border-radius: 5px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .finder-item:hover { background-color: var(--finder-hover-bg); }
        .finder-item.active { background-color: var(--finder-active-bg); color: var(--finder-active-text); }
        .finder-item .item-name { display: flex; align-items: center; gap: 8px; }
        .finder-item .chevron { font-size: 0.7rem; color: var(--text-secondary); }
        .finder-item.active .chevron { color: var(--finder-active-text); }
        
        .finder-preview-pane {
            flex-grow: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .finder-preview-pane h3 { font-size: 1.5rem; margin-bottom: 1rem; }
        .finder-preview-pane p { color: var(--text-secondary); margin-bottom: 0.5rem; }
        .finder-preview-pane .price { font-size: 1.2rem; font-weight: bold; color: var(--accent-green); margin: 1rem 0;}
        .finder-preview-pane .purchased-tag { background-color: var(--accent-green); color: #fff; padding: 4px 10px; border-radius: 6px; font-weight: 600; display: inline-block; margin: 1rem 0;}
        .finder-preview-pane .item-actions button { margin: 0.5rem; }
        .finder-preview-pane .file-icon-large { font-size: 5rem; color: var(--text-secondary); margin-bottom: 1rem; }

        .finder-footer {
            text-align: right;
            font-size: 0.8rem;
            color: var(--finder-text-secondary);
            padding: 8px 12px;
            border-top: 1px solid var(--finder-border-color);
            background: var(--finder-bg-secondary);
            flex-shrink: 0;
        }

        /* --- END: Finder Window Styles --- */

        /* --- START: Minimize/Restore Animations --- */
        @keyframes minimize-window {
            from {
                transform: translate(var(--start-left), var(--start-top)) scale(1);
                opacity: 1;
            }
            to {
                transform: translate(var(--end-left), var(--end-top)) scale(0.1);
                opacity: 0;
            }
        }
        .finder-window-wrapper.minimizing {
            transform-origin: top left;
            animation: minimize-window 0.4s ease-in-out forwards;
        }
        /* --- END: Animations --- */


        /* Mobile responsiveness */
        @media (max-width: 768px) {
            #authWrapper { flex-direction: column; position: static; height: auto; }
            .login-left-panel, .login-right-panel { width: 100%; }
            header { flex-direction: column; height: auto; padding: 1rem; align-items: flex-start; }
            .header-actions { margin-left: 0; margin-top: 1rem; flex-wrap: wrap; }
            main { flex-direction: column; padding: 12px; }
            #minimizedTabsBar { display: none; } /* Hide tab bar on mobile */
            .finder-window-wrapper { display: none !important; } /* Always hide finder on mobile */
        }
    </style>
</head>
<body>

    <div id="authWrapper">
        <div class="login-left-panel">
            <h1>Let AI mark your work.</h1>
            <p>Let AI assist you, not replace you</p>
            <p>Mark with AI, learn better</p>
        </div>
        <div class="login-right-panel">
            <div id="authContainer">
                 <!-- JS will inject googleSignInTemplate or codeEntryTemplate -->
            </div>
        </div>
    </div>

    <div id="appSection">
        <header>
            <div class="logo-container">
                <h1>AI Marker</h1>
                <p>Operated by Darren Ng</p>
            </div>
            <div class="header-actions">
                <button id="toggleHomeButton" class="tab neon-button active">
                    <span></span><span></span><span></span><span></span>
                    Home
                </button>
                
                <div class="dropdown-menu">
                    <button class="tab neon-button" id="workWithAIButton">
                        <span></span><span></span><span></span><span></span>
                        Work with AI
                    </button>
                    <div class="dropdown-menu-content">
                        <button id="toggleGradingButton" class="tab">Exam Grader</button>
                        <button id="toggleChatButton" class="tab">Chat with Gemini</button>
                    </div>
                </div>

                <div class="dropdown-menu">
                    <button class="tab neon-button" id="materialsButton">
                        <span></span><span></span><span></span><span></span>
                        Materials
                    </button>
                    <div class="dropdown-menu-content">
                        <button id="toggleTutorialButton" class="tab">Tutorials</button>
                        <button id="togglePastPapersButton" class="tab">Past Papers</button>
                        <button id="toggleExercisesButton" class="tab">Exercises</button>
                    </div>
                </div>

                <button id="manageStudentsButton" class="tab neon-button" style="display: none;">
                    <span></span><span></span><span></span><span></span>
                    Manage Students
                </button>
                <button id="toggleProfileButton" class="tab neon-button">
                    <span></span><span></span><span></span><span></span>
                    Profile
                </button>
                <button id="themeToggleButton" class="tab neon-button">
                    <span></span><span></span><span></span><span></span>
                    Theme
                </button>
                <div class="user-info">
                     <span id="userDisplayName"></span>
                     <button id="switchRoleButton" class="btn-primary">Switch Role</button>
                     <button id="logoutButton" class="logout-btn">Log Out</button>
                </div>
            </div>
        </header>

        <div id="minimizedTabsBar">
            <!-- Minimized window tabs will be appended here -->
        </div>
        
        <main>
            <!-- Home Section -->
            <div id="homeSection" style="display: block; opacity: 1;">
                 <!-- Home content will be added here -->
            </div>

            <!-- Other sections (Grading, Chat, etc.) -->
            <div id="gradingSection"></div>
            <div id="chatSection"></div>
            <div id="studentManagementSection"></div>
            <div id="profileSection"></div>

            <!-- Material Sections (now just placeholders, content is in the finder) -->
            <div id="tutorialSection">
                 <div class="form-container" style="max-width: initial; text-align: center;">
                    <h2 class="section-title">Tutorials Manager</h2>
                    <p style="margin-bottom: 1.5rem;">All tutorial materials are now managed in the unified Finder window.</p>
                    <button class="btn-primary" onclick="showFinderView('tutorials')">Open Tutorials Finder</button>
                 </div>
                 <div class="purchase-history-section" style="display:none;" id="tutorials-teacher-extras"></div>
            </div>
            <div id="pastPapersSection">
                <div class="form-container" style="max-width: initial; text-align: center;">
                    <h2 class="section-title">Past Papers Manager</h2>
                    <p style="margin-bottom: 1.5rem;">All past paper materials are now managed in the unified Finder window.</p>
                    <button class="btn-primary" onclick="showFinderView('pastPapers')">Open Past Papers Finder</button>
                 </div>
                 <div class="purchase-history-section" style="display:none;" id="pastPapers-teacher-extras"></div>
            </div>
            <div id="exerciseSection">
                <div class="form-container" style="max-width: initial; text-align: center;">
                    <h2 class="section-title">Exercises Manager</h2>
                    <p style="margin-bottom: 1.5rem;">All exercise materials are now managed in the unified Finder window.</p>
                    <button class="btn-primary" onclick="showFinderView('exercises')">Open Exercises Finder</button>
                 </div>
                 <div id="exercises-teacher-extras">
                    <!-- Promo code and purchase history will be injected here for teachers -->
                 </div>
            </div>
            
        </main>
    </div>

    <!-- Modals remain the same -->
    <div id="messageModal" class="modal"></div>
    <div id="addVideoModal" class="modal"></div>
    <div id="addPastPaperModal" class="modal"></div>
    <div id="addExerciseModal" class="modal"></div>
    <div id="videoPreviewModal" class="modal"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, where, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";

        // --- CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
          authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30",
          storageBucket: "ai-grading-9bb30.appspot.com",
          messagingSenderId: "298162112230",
          appId: "1:298162112230:web:529d3f95536991be685d27",
          measurementId: "G-CHKLKSM17S"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const TEACHER_CODE = "TEACHER123";
        const STUDENT_CODE = "STUDENT456";

        // --- GLOBAL STATE ---
        let app, db, auth, storage;
        let currentUserId = null, currentUserEmail = null, currentUserRole = null, currentUserName = null;
        let openFinderWindows = {}; // Tracks state of open/minimized finder windows, e.g., { tutorials: { minimized: false, zIndex: 1 } }

        // --- MATERIALS CONFIG ---
        const materialsConfig = {
            tutorials: { title: 'Tutorials', collectionName: 'tutorials', level1: 'Subject', level2: 'Topic', level3: 'Video', isPaid: false },
            pastPapers: { title: 'Past Papers', collectionName: 'pastPapers', level1: 'Subject', level2: 'Year', level3: 'Paper', isPaid: false },
            exercises: { title: 'Exercises', collectionName: 'exercises', level1: 'Subject', level2: 'Topic', level3: 'Exercise', isPaid: true }
        };
        
        const authWrapper = document.getElementById('authWrapper');
        const appSection = document.getElementById('appSection');
        const authContainer = document.getElementById('authContainer');

        const googleSignInTemplate = `
            <h2>Sign In</h2>
            <button id="googleSignInButton" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
                <span>Sign in with Google</span>
            </button>
            <p id="authError" class="error-message"></p>
        `;

        const codeEntryTemplate = `
            <h2>Enter Access Code</h2>
            <p style="color: var(--text-secondary); text-align: center; margin-bottom: 1rem;">Please enter the access code provided.</p>
            <input type="text" id="accessCodeInput" placeholder="Enter code here">
            <button id="submitCodeButton" class="btn-primary" style="width:100%">Submit Code</button>
            <p id="codeError" class="error-message"></p>
        `;

        // --- INITIALIZATION ---
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
            console.log("Firebase initialized.");
            setupAuthListener();
            setupStaticEventListeners();
        } catch (error) {
            console.error("Firebase Init Error:", error);
            document.body.innerHTML = 'Error initializing application. Please contact support.';
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    currentUserEmail = user.email;
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                    const userProfileDoc = await getDoc(userProfileRef);

                    if (userProfileDoc.exists() && userProfileDoc.data().role) {
                        const profileData = userProfileDoc.data();
                        currentUserRole = profileData.role;
                        currentUserName = profileData.name || user.displayName;
                        await setDoc(userProfileRef, { name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                        showApp();
                    } else {
                        currentUserName = user.displayName;
                        currentUserRole = 'unassigned';
                        showCodeEntry();
                    }
                } else {
                    currentUserId = null; currentUserRole = null; currentUserName = null;
                    showLogin();
                }
            });
        }

        // --- UI ROUTING & DISPLAY ---

        function showLogin() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authContainer.innerHTML = googleSignInTemplate;
            document.getElementById('googleSignInButton')?.addEventListener('click', handleGoogleSignIn);
            setTimeout(() => authWrapper.style.opacity = '1', 10);
        }

        function showCodeEntry() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authContainer.innerHTML = codeEntryTemplate;
            document.getElementById('submitCodeButton')?.addEventListener('click', () => handleSubmitCode());
            document.getElementById('accessCodeInput')?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleSubmitCode();
            });
            setTimeout(() => authWrapper.style.opacity = '1', 10);
        }

        async function showApp() {
            authWrapper.style.display = 'none';
            authWrapper.style.opacity = '0';
            appSection.style.display = 'flex';
            document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
            document.getElementById('manageStudentsButton').style.display = currentUserRole === 'teacher' ? 'block' : 'none';
            
            if (currentUserRole === 'teacher') {
                setupTeacherExtras();
            }
            
            showSection('homeSection');
        }
        
        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try { 
                await signInWithPopup(auth, provider); 
            } catch (error) { 
                document.getElementById('authError').textContent = `Sign-in failed. Error: ${error.message}`; 
            }
        }

        async function handleSubmitCode() {
            const code = document.getElementById('accessCodeInput').value.trim();
            const codeError = document.getElementById('codeError');
            if(codeError) codeError.textContent = '';
            
            let roleToSet = null;
            if (code === TEACHER_CODE) roleToSet = 'teacher';
            else if (code === STUDENT_CODE) roleToSet = 'student';
            else { 
                if(codeError) codeError.textContent = 'Invalid access code.';
                return; 
            }
            
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await setDoc(userProfileRef, { role: roleToSet, name: currentUserName, email: currentUserEmail }, { merge: true });
                currentUserRole = roleToSet;
                showApp();
            } catch (error) {
                if(codeError) codeError.textContent = `Could not set role. Error: ${error.message}`;
            }
        }


        function showSection(sectionId) {
            document.querySelectorAll('main > div').forEach(el => {
                if (!el.classList.contains('finder-window-wrapper')) {
                    el.style.display = 'none';
                }
            });
            const section = document.getElementById(sectionId);
            if(section) {
                section.style.display = 'block';
                section.style.opacity = '1';
            }
            
            document.querySelectorAll('.header-actions .tab.neon-button').forEach(t => t.classList.remove('active'));
            let activeBtn;
            if (['tutorialSection', 'pastPapersSection', 'exerciseSection'].includes(sectionId)) {
                activeBtn = document.getElementById('materialsButton');
            } else {
                activeBtn = Array.from(document.querySelectorAll('.header-actions .tab.neon-button')).find(btn => btn.id.toLowerCase().includes(sectionId.replace('Section', '').toLowerCase()));
            }
            if(activeBtn) activeBtn.classList.add('active');
        }
        
        function setupTeacherExtras() {
            const exercisesExtras = document.getElementById('exercises-teacher-extras');
            exercisesExtras.style.display = 'block';
            exercisesExtras.innerHTML = `
                <div class="form-container" style="max-width: initial; margin-top: 2rem;">
                    <h3>Promo Code Management</h3>
                    <input type="number" id="promoDiscountAmount" placeholder="Discount Amount ($)" step="0.01" min="0">
                    <button id="generatePromoCodeBtn" class="btn-primary">Generate Promo Code</button>
                    <div id="teacherPromoCodeList" style="margin-top: 1rem;"></div>
                </div>
                <div class="purchase-history-section">
                    <h3>Student Purchase History</h3>
                    <div id="studentPurchaseHistoryList"></div>
                </div>`;
            // Add event listeners for new elements
            // loadPromoCodesForTeacher();
            // loadStudentPurchasesForTeacher();
        }

        // --- FINDER WINDOW MANAGEMENT ---

        window.showFinderView = function(type) {
            if (!openFinderWindows[type]) {
                createFinderWindow(type);
            }
            
            const finderState = openFinderWindows[type];
            const finderWindow = document.getElementById(`finder-window-${type}`);
            
            if (finderState.minimized) {
                restoreFinderWindow(type);
            } else {
                finderWindow.style.display = 'flex';
                focusFinderWindow(type);
            }
        }

        function createFinderWindow(type) {
            const config = materialsConfig[type];

            const finderWrapper = document.createElement('div');
            finderWrapper.id = `finder-window-${type}`;
            finderWrapper.className = 'finder-window-wrapper';
            finderWrapper.dataset.type = type;

            finderWrapper.innerHTML = `
                <div class="finder-titlebar">
                    <div class="buttons">
                        <div class="finder-circle close"></div>
                        <div class="finder-circle min"></div>
                        <div class="finder-circle max"></div>
                    </div>
                    <span class="finder-title">${config.title}</span>
                </div>
                <div class="finder-content">
                    <!-- Columns will be generated here -->
                </div>
                <div class="finder-footer">
                    ${currentUserRole === 'teacher' ? `<button class="btn-primary add-level1-btn" style="font-size: 0.8rem; padding: 4px 8px;">Add New ${config.level1}</button>` : `<span>Select an item to see details.</span>`}
                </div>
            `;
            
            document.querySelector('main').appendChild(finderWrapper);
            
            openFinderWindows[type] = {
                minimized: false,
                zIndex: Object.keys(openFinderWindows).length + 1000,
                path: [], // Array of selected IDs
            };
            
            finderWrapper.style.zIndex = openFinderWindows[type].zIndex;
            setupFinderEventListeners(finderWrapper, type);
            renderFinderColumns(type);
            finderWrapper.style.display = 'flex';
            focusFinderWindow(type);
        }

        function setupFinderEventListeners(finderWindow, type) {
            const titlebar = finderWindow.querySelector('.finder-titlebar');
            
            // Dragging
            let isDragging = false, offsetX, offsetY;
            titlebar.addEventListener('mousedown', e => {
                if (e.target.closest('.buttons')) return;
                isDragging = true;
                focusFinderWindow(type);
                offsetX = e.clientX - finderWindow.offsetLeft;
                offsetY = e.clientY - finderWindow.offsetTop;
                titlebar.style.cursor = 'grabbing';
            });
            document.addEventListener('mousemove', e => {
                if(isDragging) {
                    finderWindow.style.left = `${e.clientX - offsetX}px`;
                    finderWindow.style.top = `${e.clientY - offsetY}px`;
                }
            });
            document.addEventListener('mouseup', () => {
                isDragging = false;
                titlebar.style.cursor = 'grab';
            });

            // Buttons
            finderWindow.querySelector('.close').addEventListener('click', () => closeFinderWindow(type));
            finderWindow.querySelector('.min').addEventListener('click', () => minimizeFinderWindow(type));
            finderWindow.querySelector('.max').addEventListener('click', () => finderWindow.classList.toggle('fullscreen'));
            
            // Add Level 1 button for teacher
            if (currentUserRole === 'teacher') {
                finderWindow.querySelector('.add-level1-btn').addEventListener('click', () => {
                    // TODO: Implement add level 1 item logic
                });
            }
        }

        function focusFinderWindow(type) {
            let maxZ = 999;
            Object.values(openFinderWindows).forEach(w => { if (w.zIndex > maxZ) maxZ = w.zIndex; });
            
            openFinderWindows[type].zIndex = maxZ + 1;
            document.getElementById(`finder-window-${type}`).style.zIndex = openFinderWindows[type].zIndex;

            // Update active tab in tab bar
            document.querySelectorAll('.minimized-tab').forEach(t => t.classList.remove('active'));
            const tab = document.getElementById(`minimized-tab-${type}`);
            if (tab) tab.classList.add('active');
        }

        function closeFinderWindow(type) {
            document.getElementById(`finder-window-${type}`).remove();
            document.getElementById(`minimized-tab-${type}`)?.remove();
            delete openFinderWindows[type];
        }

        function minimizeFinderWindow(type) {
            const finderWindow = document.getElementById(`finder-window-${type}`);
            const tab = document.getElementById(`minimized-tab-${type}`) || createMinimizedTab(type);
            const tabRect = tab.getBoundingClientRect();
            
            // Set CSS variables for animation
            finderWindow.style.setProperty('--start-left', `${finderWindow.offsetLeft}px`);
            finderWindow.style.setProperty('--start-top', `${finderWindow.offsetTop}px`);
            finderWindow.style.setProperty('--end-left', `${tabRect.left}px`);
            finderWindow.style.setProperty('--end-top', `${tabRect.top}px`);
            
            finderWindow.classList.add('minimizing');
            
            finderWindow.addEventListener('animationend', () => {
                finderWindow.style.display = 'none';
                finderWindow.classList.remove('minimizing');
                openFinderWindows[type].minimized = true;
                tab.classList.remove('active');
            }, { once: true });
        }
        
        function restoreFinderWindow(type) {
            const finderWindow = document.getElementById(`finder-window-${type}`);
            const tab = document.getElementById(`minimized-tab-${type}`);
            const tabRect = tab.getBoundingClientRect();

            finderWindow.style.display = 'flex';
            
            // This is a simplified restore without animation for now.
            // A proper restore animation would be the reverse of minimizing.
            finderWindow.style.opacity = '1';
            
            openFinderWindows[type].minimized = false;
            focusFinderWindow(type);
        }

        function createMinimizedTab(type) {
            const config = materialsConfig[type];
            const tabBar = document.getElementById('minimizedTabsBar');
            const tab = document.createElement('div');
            tab.id = `minimized-tab-${type}`;
            tab.className = 'minimized-tab';
            tab.textContent = config.title;
            tab.onclick = () => {
                const finderState = openFinderWindows[type];
                if (finderState.minimized) {
                    restoreFinderWindow(type);
                } else {
                    focusFinderWindow(type);
                }
            };
            tabBar.appendChild(tab);
            return tab;
        }

        async function renderFinderColumns(type) {
            const finderState = openFinderWindows[type];
            const contentDiv = document.getElementById(`finder-window-${type}`).querySelector('.finder-content');
            contentDiv.innerHTML = ''; // Clear existing columns

            // Render columns for the current path
            for (let i = 0; i <= finderState.path.length; i++) {
                const parentIds = finderState.path.slice(0, i);
                if (i < 3) { // Only render columns for levels 1, 2, and 3
                    await createFinderColumn(type, parentIds, contentDiv);
                }
            }
            
            // If the path is for a file (length 3), show a preview pane
            if (finderState.path.length === 3) {
                // TODO: Implement preview pane rendering
            }
        }

        async function createFinderColumn(type, parentIds, container) {
            const columnDiv = document.createElement('div');
            columnDiv.className = 'finder-column';
            container.appendChild(columnDiv);
            
            const level = parentIds.length + 1;
            const collectionPath = getPath(type, parentIds);
            const q = query(collection(db, collectionPath), orderBy("name"));
            
            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    columnDiv.innerHTML = `<p style="padding:10px; color: var(--text-secondary);">No items.</p>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'finder-item';
                    itemDiv.dataset.id = item.id;
                    itemDiv.innerHTML = `
                        <span class="item-name">
                           <span>${level < 3 ? '' : ''}</span>
                           ${item.name}
                        </span>
                        ${level < 3 ? '<span class="chevron">></span>' : ''}
                    `;
                    
                    if (openFinderWindows[type]?.path[level - 1] === item.id) {
                        itemDiv.classList.add('active');
                    }
                    
                    itemDiv.onclick = () => handleFinderItemClick(type, level, item.id);
                    columnDiv.appendChild(itemDiv);
                });
            } catch (e) {
                console.error("Error fetching column data:", e);
                columnDiv.innerHTML = `<p class="error-message">Error loading.</p>`;
            }
        }
        
        function handleFinderItemClick(type, level, selectedId) {
            const finderState = openFinderWindows[type];
            
            // If clicking the same item in the last column, do nothing.
            if (finderState.path[level - 1] === selectedId && level === finderState.path.length) {
                return;
            }

            finderState.path = finderState.path.slice(0, level - 1);
            finderState.path.push(selectedId);
            
            renderFinderColumns(type);
        }


        // --- STATIC EVENT LISTENERS & HELPERS ---
        function setupStaticEventListeners() {
            // Navigation
            document.getElementById('toggleHomeButton').addEventListener('click', () => showSection('homeSection'));
            document.getElementById('toggleGradingButton').addEventListener('click', () => showSection('gradingSection'));
            document.getElementById('toggleChatButton').addEventListener('click', () => showSection('chatSection'));
            document.getElementById('toggleTutorialButton').addEventListener('click', () => showSection('tutorialSection'));
            document.getElementById('togglePastPapersButton').addEventListener('click', () => showSection('pastPapersSection'));
            document.getElementById('toggleExercisesButton').addEventListener('click', () => showSection('exerciseSection'));
            document.getElementById('manageStudentsButton').addEventListener('click', () => showSection('studentManagementSection'));
            document.getElementById('toggleProfileButton').addEventListener('click', () => showSection('profileSection'));
            
            // Theme toggle
            document.getElementById('themeToggleButton').addEventListener('click', () => {
                const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';
                document.body.classList.toggle('light-theme', newTheme === 'light');
                localStorage.setItem('ai-marker-theme', newTheme);
            });
            
            // Load theme on start
            const savedTheme = localStorage.getItem('ai-marker-theme') || 'dark';
            document.body.classList.toggle('light-theme', savedTheme === 'light');
        }

        function getPath(type, ids = []) {
            const config = materialsConfig[type];
            let path = `artifacts/${appId}/public/data/${config.collectionName}`;
            if (ids[0]) path += `/${ids[0]}/${config.level2.toLowerCase()}s`;
            if (ids[1]) path += `/${ids[1]}/${config.level3.toLowerCase()}s`;
            return path;
        }

    </script>
</body>
</html>
