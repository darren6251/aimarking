<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Marker</title>
    <!-- Tailwind CSS for basic styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js CDN for PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        /* Base styles */
        body {
            font-family: "Inter", sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column; /* Allows content and footer to stack conceptually */
            position: relative; /* For footer positioning */
            overflow: hidden; /* Prevent scrollbars from initial layout */
            background-color: #f7f9fa; /* Default light background, visible if authWrapper is hidden */
        }

        /* Full-screen wrapper for login/auth sections */
        .auth-wrapper {
            display: flex; /* Flex container for the left and right panels */
            width: 100vw; /* Take full viewport width */
            height: 100vh; /* Take full viewport height */
            position: fixed; /* Fix to viewport so it covers the whole screen */
            top: 0;
            left: 0;
            z-index: 10; /* Ensure it's above body background and below footer/modals */
            opacity: 0; /* Initial state for fade-in */
            transition: opacity 0.5s ease-in-out; /* Smooth transition */
            /* Add overflow hidden to prevent internal content from causing scrollbars at this level */
            overflow: hidden;
        }

        /* Left side of the login page (70% - Black Background) */
        .login-left-panel {
            width: 70%; /* 70% of the screen width */
            background-color: #000000; /* Black background */
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center content vertically */
            align-items: center; /* Center content horizontally */
            text-align: center;
            padding: 30px;
            box-sizing: border-box; /* Include padding in width calculation */
        }
        .login-left-panel h1 {
            font-size: 3rem; /* Larger font for main title */
            font-weight: 800; /* Extra bold */
            margin-bottom: 20px;
            line-height: 1.2; /* Tighter line height for large text */
        }
        .login-left-panel p {
            font-size: 2rem; /* Consistent size for all lines */
            margin-bottom: 15px; /* Spacing between lines */
            font-weight: 500;
            line-height: 1.2;
        }
        .login-left-panel p:last-child {
            margin-bottom: 0; /* No margin after the last paragraph */
        }

        /* Right side of the login page (30% - White Panel with form) */
        .login-right-panel {
            width: 30%; /* 30% of the screen width */
            background-color: #ffffff; /* White background */
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center content vertically */
            align-items: center; /* Center content horizontally */
            padding: 30px;
            box-sizing: border-box;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
            border-radius: 8px; /* Rounded corners for the right panel */
            margin: 0 20px; /* Horizontal margin to create space from the edges */
            align-self: center; /* Vertically center the panel within its 30% parent */
            max-height: 500px; /* Prevent it from getting too tall */
            min-height: 300px; /* Minimum height for better appearance */
            overflow-y: auto; /* Allow scrolling within this panel if content is too tall */
        }

        /* Specific styling for elements within the right panel to ensure they fit */
        .login-right-panel .google-btn,
        .login-right-panel #accessCodeInput,
        .login-right-panel #submitCodeButton {
            width: 100%; /* Take full width of its panel's padding */
            max-width: 280px; /* Maximum width for these elements for better aesthetics */
        }
        .login-right-panel #googleSignInButton {
            margin-bottom: 20px;
        }

        /* Main application container (after login) */
        #appSection {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
            max-width: 900px;
            width: 100%;
            margin: 20px auto; /* Center the app section and provide vertical spacing */
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            /* New: Make appSection scrollable if content overflows */
            max-height: calc(100vh - 40px); /* Adjust based on body padding and footer height if fixed */
            overflow-y: auto; /* Enable vertical scrolling for the main app section */
            padding-bottom: 20px; /* Ensure space at the bottom when scrolling */
        }

        /* When appSection is shown, body doesn't need fixed 100vh to avoid double scrollbars */
        body:not(.login-active) {
            min-height: 100vh; /* Ensure body stretches for footer at bottom */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to top */
            align-items: center; /* Center appSection horizontally */
            overflow-y: auto; /* Allow body to scroll if content plus appSection overflows */
            padding-top: 20px; /* Add padding to the top of the body for main app section */
        }


        /* Common styles for buttons, inputs, etc. */
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        input[type="text"],
        input[type="email"],
        input[type="file"],
        textarea {
            border-color: #dadce0;
            border-width: 1px;
            padding: 12px 16px;
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="file"]:focus,
        textarea:focus {
            border-color: #4285F4;
            box-shadow: 0 0 0 1px #4285F4;
            outline: none;
        }
        button {
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 4px;
            padding: 12px 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .loading-indicator {
            display: none;
            color: #4f46e5;
            font-weight: 500;
            text-align: center;
            margin-top: 1rem;
        }
        #resultContainer {
            min-height: 100px;
            background-color: #ecf0f1;
            padding: 16px;
            border-radius: 8px;
            white-space: pre-wrap;
            border: 1px solid #dadce0;
        }
        .drop-zone {
            border: 2px dashed #a0aec0;
            background-color: #f7fafc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            margin-bottom: 1rem;
            word-wrap: break-word; /* Ensure text wraps within drop zone */
        }
        .drop-zone.highlight {
            background-color: #ebf8ff;
            border-color: #4299e1;
        }
        .drop-zone-text {
            color: #4a5568;
            font-weight: 500;
            white-space: normal; /* Ensure text can wrap */
        }
        .drop-zone-subtext {
            color: #718096;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            white-space: normal; /* Ensure text can wrap */
        }

        .file-preview {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: 200px;
            object-fit: contain;
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            white-space: normal; /* Ensure error messages wrap */
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            animation: slideIn 0.3s ease-out;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #aaa;
        }
        .close-button:hover {
            color: #555;
        }
        /* Google Sign-In Button style */
        .google-btn {
            background-color: #4285F4;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
        }
        .google-btn:hover {
            background-color: #357ae8;
        }
        .google-icon {
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
        }
        .google-icon img {
            width: 20px;
            height: 20px;
        }
        /* CSS Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .btn-primary {
            background-image: linear-gradient(to right, #6366f1, #4f46e5);
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-image: linear-gradient(to right, #4f46e5, #4338ca);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-grade {
            background-image: linear-gradient(to right, #22c55e, #10b981);
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-grade:hover {
            background-image: linear-gradient(to right, #10b981, #059669);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-logout {
            background-color: #ef4444;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-logout:hover {
            background-color: #dc2626;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }
        .btn-secondary {
            background-color: #cbd5e1;
            color: #334155;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 8px 16px;
            font-size: 0.875rem;
        }
        .btn-secondary:hover {
            background-color: #94a3b8;
            color: #1e293b;
        }


        /* Chat specific styles */
        #chatDisplay {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 16px;
            background-color: #fcfcfc;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .chat-message.user {
            background-color: #e0f2f7;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-message.gemini {
            background-color: #f0f4f8;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        #chatInput {
            border-radius: 20px;
            padding-right: 50px;
        }
        #sendChatButton {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background-color: transparent;
            color: #4285F4;
            border: none;
            padding: 0;
            cursor: pointer;
            font-size: 24px;
        }
        #sendChatButton:hover {
            color: #357ae8;
        }
        .chat-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        /* Specific styles for animated sections (grading, chat, student management) */
        #gradingSection, #chatSection, #studentManagementSection {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            height: auto;
            width: 100%;
        }

        /* Header content within the main application container (appSection) */
        .app-header-content-in-container {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        @media (min-width: 768px) {
            .app-header-content-in-container {
                flex-direction: row;
            }
        }
        .app-header-logo-text-in-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .app-header-buttons-in-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        @media (min-width: 768px) {
            .app-header-logo-text-in-container {
                margin-bottom: 0;
            }
            .app-header-buttons-in-container {
                justify-content: flex-end;
            }
        }


        /* Footer styles */
        footer {
            position: fixed; /* Fixed to viewport */
            bottom: 20px;
            right: 20px;
            text-align: right;
            color: #71717a;
            font-size: 0.875rem;
            padding: 10px;
            z-index: 100; /* Ensure it's above other content */
        }
        footer p {
            margin-bottom: 5px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .auth-wrapper {
                flex-direction: column; /* Stack panels vertically */
                height: auto; /* Allow height to adjust to content */
                position: static; /* Allow normal flow on small screens */
                width: 100%;
            }
            .login-left-panel, .login-right-panel {
                width: 100%; /* Full width on mobile */
                padding: 20px;
                box-shadow: none; /* Remove shadow on mobile for cleaner look */
                border-radius: 0; /* No rounded corners on mobile panels */
                margin: 0; /* No margins on stacked panels */
                min-height: auto; /* Allow height to shrink */
                max-height: none;
            }
            .login-left-panel {
                padding-bottom: 10px; /* Reduce space between stacked panels */
            }
            .login-left-panel h1 {
                font-size: 2rem;
            }
            .login-left-panel p {
                font-size: 1.25rem;
            }
            .login-right-panel {
                padding-top: 10px; /* Reduce space between stacked panels */
            }

            #appSection {
                padding: 20px;
                margin-top: 10px;
                margin-bottom: 10px;
                max-height: calc(100vh - 20px); /* Adjust max-height for mobile if needed */
                overflow-y: auto; /* Ensure scrolling */
            }
            body:not(.login-active) {
                padding-top: 10px; /* Adjust body padding for main app on mobile */
            }
            footer {
                position: static; /* Allow footer to flow with content */
                text-align: center;
                margin-top: 20px;
                width: 100%;
                padding: 10px;
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Auth Wrapper (Login and Code Entry) -->
    <!-- This wrapper will manage the 70/30 split directly -->
    <div id="authWrapper" class="auth-wrapper" style="display: none;">
        <!-- Left Panel (70% - Black Background) -->
        <div class="login-left-panel">
            <h1>Let AI mark your work.</h1>
            <p>Let AI assist you, not replace you</p>
            <p>Mark with AI, learn better</p>
        </div>

        <!-- Right Panel (30% - White Background with form) -->
        <div id="authRightPanel" class="login-right-panel">
            <!-- Content for Google Sign-In -->
            <div id="authContent" class="flex flex-col items-center w-full">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-16 h-16 mb-6">
                <button id="googleSignInButton" class="google-btn focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300">
                    Sign in with Google
                </button>
                <p id="authError" class="error-message text-center mt-4"></p>
                <p id="unauthorizedMessage" class="error-message text-center mt-4" style="display: none;">
                    Your account is not authorized to use this application. Please contact the administrator.
                </p>
            </div>

            <!-- Content for Access Code Entry (initially hidden) -->
            <div id="codeEntryContent" class="flex flex-col items-center w-full" style="display: none;">
                <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">Enter Access Code</h2>
                <p class="text-gray-600 text-md mb-6 text-center">
                    Please enter the access code.
                </p>
                <input type="text" id="accessCodeInput" placeholder="Enter code here"
                       class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 mb-4 text-center">
                <p id="codeError" class="error-message text-center"></p>
                <button id="submitCodeButton" class="btn-primary py-3 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-300">
                    Submit Code
                </button>
                <p id="codeLoadingIndicator" class="loading-indicator"></p>
            </div>
        </div>
    </div>


    <!-- Main Application Section (uses the app-container for the white card look) -->
    <div id="appSection" class="app-container" style="display: none;">
        <div class="app-header-content-in-container">
            <!-- Left-aligned Logo and Operated By -->
            <div class="app-header-logo-text-in-container">
                <div class="flex items-center gap-2 mb-2">
                    <img src="https://placehold.co/40x40/FFFFFF/000000?text=AI" alt="AI Marker Logo" class="w-auto h-10 border rounded-full border-gray-300">
                    <h1 class="text-xl font-extrabold text-gray-800">AI Marker</h1>
                </div>
                <p class="text-gray-600 text-sm">Operated by Darren Ng</p>
            </div>

            <!-- Right-aligned user info and buttons -->
            <div class="flex items-center gap-4 app-header-buttons-in-container">
                <span id="userDisplayName" class="text-gray-600 text-base font-medium"></span>
                <!-- Toggle Buttons for Grading vs Chat -->
                <button id="toggleGradingButton" class="btn-primary text-sm py-2 px-4">
                    Exam Grader
                </button>
                <button id="toggleChatButton" class="btn-primary text-sm py-2 px-4">
                    Chat with Gemini
                </button>
                <button id="manageStudentsButton" class="btn-primary text-sm py-2 px-4" style="display: none;">
                    Manage Students
                </button>
                <button id="logoutButton" class="btn-logout text-sm py-2 px-4">
                    Log Out
                </button>
            </div>
        </div>

        <!-- Grading Section -->
        <div id="gradingSection" class="w-full" style="display: block; opacity: 0;">
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-semibold mb-2">Upload Student's Work (Image or PDF):</label>
                <!-- Drag and Drop Zone for Student Answer -->
                <div id="studentDropZone" class="drop-zone">
                    <p class="drop-zone-text">Drag & Drop Student's Work Here</p>
                    <p class="drop-zone-subtext">(or click to select file)</p>
                    <input type="file" id="studentAnswerFile" accept="image/*,application/pdf" class="hidden">
                </div>
                <span id="studentFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                <img id="studentFilePreview" class="file-preview mx-auto" style="display: none;" alt="Student Work Preview">
                <label for="studentAnswer" class="block text-gray-700 text-sm font-semibold mt-4 mb-2">Or type Student's Answer:</label>
                <textarea id="studentAnswer" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" placeholder="Enter student's answer here..."></textarea>
                <p id="studentAnswerError" class="error-message"></p>
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-semibold mb-2">Upload Answer Key (Image or PDF):</label>
                <!-- Drag and Drop Zone for Answer Key -->
                <div id="answerKeyDropZone" class="drop-zone">
                    <p class="drop-zone-text">Drag & Drop Answer Key Here</p>
                    <p class="drop-zone-subtext">(or click to select file)</p>
                    <input type="file" id="answerKeyFile" accept="image/*,application/pdf" class="hidden">
                </div>
                <span id="answerKeyFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                <img id="answerKeyFilePreview" class="file-preview mx-auto" style="display: none;" alt="Answer Key Preview">
                <label for="answerKey" class="block text-gray-700 text-sm font-semibold mt-4 mb-2">Or type Answer Key:</label>
                <textarea id="answerKey" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" placeholder="Enter the correct answer key here..."></textarea>
                <p id="answerKeyError" class="error-message"></p>
            </div>

            <button id="gradeButton" class="btn-primary btn-grade py-3 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle-2"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
                Grade Work
            </button>

            <p id="gradingLoadingIndicator" class="loading-indicator"></p>

            <div id="resultContainer" class="mt-6 border border-gray-300 rounded-lg p-5">
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Grading Results:</h2>
                <p id="gradeResult" class="text-gray-900 leading-relaxed">Your grading results will appear here after submission.</p>
            </div>

            <div class="mt-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Past Submissions:</h2>
                <div id="pastSubmissions" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <p id="noSubmissions" class="text-gray-500">No past submissions found.</p>
                </div>
            </div>
        </div>

        <!-- Chat Section -->
        <div id="chatSection" class="w-full flex flex-col gap-4" style="display: none; opacity: 0;">
            <div id="chatDisplay" class="flex-grow">
                <!-- Chat messages will be appended here -->
                <div class="chat-message gemini">Hello! I'm AI Marker, operated by Darren Ng, assisted with Google Gemini, How can I help you today?</div>
            </div>
            <div class="chat-input-wrapper flex items-center gap-2">
                <input type="text" id="chatInput" class="w-full py-3 px-4 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" placeholder="Type your message...">
                <button id="sendChatButton" class="px-3 py-2 rounded-full text-blue-600 hover:bg-blue-100 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4 20-7Z"/><path d="M15 9l-6 6"/></svg>
                </button>
            </div>
            <p id="chatLoadingIndicator" class="loading-indicator"></p>
        </div>

        <!-- Student Management Section (Teacher Only) -->
        <div id="studentManagementSection" class="w-full flex flex-col gap-4" style="display: none; opacity: 0;">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Authorized Students</h2>
            <div class="flex flex-col md:flex-row gap-2 mb-4">
                <input type="email" id="studentEmailInput" class="shadow-sm appearance-none border rounded-lg py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 flex-grow" placeholder="Enter student's Gmail address">
                <button id="addStudentButton" class="btn-primary py-3 px-6 rounded-lg">
                    Add Student
                </button>
            </div>
            <p id="studentManagementLoading" class="loading-indicator"></p>
            <div id="authorizedStudentsList" class="border border-gray-300 rounded-lg p-4 bg-gray-50 max-h-80 overflow-y-auto">
                <p id="noAuthorizedStudents" class="text-gray-500 text-center">No authorized students yet.</p>
                <!-- Students will be listed here -->
            </div>
        </div>

    </div>

    <!-- Custom Modal for General Messages -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle" class="text-xl font-bold mb-3"></h3>
            <p id="modalMessage" class="text-gray-700"></p>
            <div id="modalButtons" class="flex justify-end gap-2 mt-4"></div>
        </div>
    </div>

    <!-- Global Footer -->
    <footer>
        <p>Contact: <a href="mailto:darren_0625@mc-zero.com" class="text-blue-600 hover:underline">darren_0625@mc-zero.com</a></p>
        <p>Copyright Â© 2025 Operated by Darren Ng</p>
    </footer>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";


        // IMPORTANT: Replace these with your actual Firebase project config.
        // Get this from your Firebase Console -> Project settings -> Your apps -> Web app -> Config
        const FIREBASE_CONFIG_PLACEHOLDER = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI", // Your API Key (Updated from previous step)
          authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30",
          storageBucket: "ai-grading-9bb30.firebasestorage.app",
          messagingSenderId: "298162112230",
          appId: "1:298162112230:web:529d3f95536991be685d27",
          measurementId: "G-CHKLKSM17S"
        };

        // This is the Canvas app ID (from the URL of THIS chat).
        // It's used for the Firestore data structure related to this specific artifact.
        const APP_ID_FROM_CANVAS_ENVIRONMENT = "c_03094e15";


        // Conditional assignment for running in Canvas vs. locally or on your own host
        const appId = typeof __app_id !== 'undefined' ? __app_id : APP_ID_FROM_CANVAS_ENVIRONMENT;
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : FIREBASE_CONFIG_PLACEHOLDER;

        // Configure pdf.js worker source
        pdfjsLib.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';


        let app;
        let db;
        let auth;
        let storage; // Declare storage variable
        let currentUserId = null;
        let currentUserEmail = null; // Store user email for potential use
        let currentUserRole = null; // Will be 'teacher', 'student', or 'unassigned'
        let currentUserName = null;
        let currentAuthReady = false; // Flag to indicate Firebase auth is ready

        // Gemini API Key for direct calls (not provided by Canvas environment)
        // Define your Cloudflare Worker URL for proxying Gemini API calls
        const CLOUDFLARE_WORKER_URL = "https://ai-marker-gemini-proxy.darren-xie11.workers.dev/"; // <<< PASTE YOUR WORKER URL HERE!

        // Define your secret codes here
        const TEACHER_CODE = "TEACHER123";
        const STUDENT_CODE = "STUDENT456";

        // Function to show custom modal for general messages
        function showModal(title, message, buttons = []) {
            const modal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = ''; // Clear previous buttons

            buttons.forEach(btnConfig => {
                const button = document.createElement('button');
                button.textContent = btnConfig.text;
                button.className = btnConfig.className || 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg';
                button.onclick = () => {
                    modal.style.display = 'none';
                    if (btnConfig.onClick) btnConfig.onClick();
                };
                modalButtons.appendChild(button);
            });

            modal.style.display = 'flex';
        }

        // Close button for general message modal
        document.querySelector('#messageModal .close-button').onclick = () => {
            document.getElementById('messageModal').style.display = 'none';
        };
        // Close modal if clicked outside
        window.onclick = (event) => {
            if (event.target === document.getElementById('messageModal')) {
                document.getElementById('messageModal').style.display = 'none';
            }
        };


        // Initialize Firebase
        try {
            if (!firebaseConfig || !firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                throw new Error("Firebase configuration is missing or incomplete. Please replace the placeholders in the HTML code with your actual Firebase project details.");
            }
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app); // Initialize Firebase Storage
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showModal('Firebase Error', `Failed to initialize Firebase. Please check the configuration. Details: ${error.message}`);
        }

        // --- Auth State Listener ---
        onAuthStateChanged(auth, async (user) => {
            console.log("onAuthStateChanged fired. User:", user ? user.uid : "null");
            const authWrapper = document.getElementById('authWrapper');
            const appSection = document.getElementById('appSection');
            const authContent = document.getElementById('authContent');
            const codeEntryContent = document.getElementById('codeEntryContent');
            const unauthorizedMessageElement = document.getElementById('unauthorizedMessage');

            if (user) {
                currentUserId = user.uid;
                currentUserEmail = user.email; // Store email
                currentUserName = user.displayName || user.email || 'Google User'; // Use Google name/email
                
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                unauthorizedMessageElement.style.display = 'none'; // Hide by default

                try {
                    const userProfileDoc = await getDoc(userProfileRef);
                    if (userProfileDoc.exists() && userProfileDoc.data().role) {
                        currentUserRole = userProfileDoc.data().role;
                        console.log(`User profile loaded. Role: ${currentUserRole}`);
                    } else {
                        // New user or role not set, prompt for code
                        currentUserRole = 'unassigned'; // Temporarily set as unassigned
                        console.log("User role not found or unassigned. Prompting for access code.");
                    }

                    // Always save/update basic profile info (email, name, lastLogin)
                    await setDoc(userProfileRef, {
                        name: currentUserName,
                        email: currentUserEmail,
                        lastLogin: Date.now(),
                        // Only set role if it's not 'unassigned' yet to avoid overwriting later
                        role: currentUserRole === 'unassigned' ? null : currentUserRole 
                    }, { merge: true });

                    // Update UI based on role
                    if (currentUserRole === 'teacher' || currentUserRole === 'student') {
                        document.getElementById('userDisplayName').textContent = `Logged in as: ${currentUserName} (${currentUserRole})`;
                        authWrapper.style.display = 'none'; // Hide auth wrapper
                        appSection.style.display = 'flex'; // Show main app
                        setTimeout(() => { appSection.style.opacity = '1'; }, 50); // Fade in app section
                        document.body.classList.remove('login-active'); // Remove login active class
                        
                        // Show/hide teacher-specific buttons
                        const manageStudentsButton = document.getElementById('manageStudentsButton');
                        if (currentUserRole === 'teacher') {
                            manageStudentsButton.style.display = 'flex'; // Use flex to maintain button styling
                        } else {
                            manageStudentsButton.style.display = 'none'; // Ensure students don't see this
                        }

                        // Initially show grading section with fade-in (within appSection)
                        const gradingSection = document.getElementById('gradingSection');
                        gradingSection.style.display = 'block';
                        gradingSection.style.opacity = '0'; // Start at 0 for fade-in
                        setTimeout(() => { gradingSection.style.opacity = '1'; }, 50); // Small delay to trigger transition

                        document.getElementById('chatSection').style.display = 'none';
                        document.getElementById('studentManagementSection').style.display = 'none'; // Ensure this is hidden

                        await loadPastSubmissions();
                        if (currentUserRole === 'teacher') {
                            await loadAuthorizedStudents(); // Load students if teacher
                        }

                    } else if (currentUserRole === 'unassigned') {
                        // User logged in, but needs to enter a code
                        document.getElementById('userDisplayName').textContent = `Logged in as: ${currentUserName}`; // Show they are logged in
                        authWrapper.style.display = 'flex'; // Show the auth wrapper
                        authContent.style.display = 'none'; // Hide Google sign-in
                        codeEntryContent.style.display = 'flex'; // Show code entry
                        appSection.style.display = 'none'; // Hide main app
                        setTimeout(() => { authWrapper.style.opacity = '1'; }, 50); // Fade in auth wrapper
                        document.body.classList.add('login-active'); // Add login active class
                        currentAuthReady = true;
                    } else { // Should not happen with 'unassigned' fallback, but for safety
                        document.getElementById('userDisplayName').textContent = `Not logged in`;
                        authWrapper.style.display = 'flex'; // Show login
                        authContent.style.display = 'flex'; // Show Google sign-in
                        codeEntryContent.style.display = 'none'; // Hide code entry
                        appSection.style.display = 'none';
                        unauthorizedMessageElement.style.display = 'block'; // Show unauthorized message
                        setTimeout(() => { authWrapper.style.opacity = '1'; }, 50); // Fade in auth wrapper
                        document.body.classList.add('login-active'); // Add login active class
                        currentAuthReady = true; 
                    }

                } catch (error) {
                    console.error("Error fetching or setting user profile:", error);
                    currentAuthReady = true;
                    showModal('Profile Error', `Failed to load or assign user role. Details: ${error.message}. Please check console for details.`);
                    authWrapper.style.display = 'flex'; // Default to showing auth
                    authContent.style.display = 'flex';
                    codeEntryContent.style.display = 'none';
                    appSection.style.display = 'none';
                    document.body.classList.add('login-active'); // Add login active class
                }

            } else {
                // User is logged out
                currentUserId = null;
                currentUserEmail = null;
                currentUserRole = null;
                currentUserName = null;
                console.log("User is logged out. Displaying auth section.");
                document.getElementById('userDisplayName').textContent = `Not logged in`;
                appSection.style.display = 'none';
                authWrapper.style.display = 'flex'; // Show login wrapper
                authContent.style.display = 'flex'; // Show Google Sign-In content
                codeEntryContent.style.display = 'none'; // Hide code entry
                setTimeout(() => { authWrapper.style.opacity = '1'; }, 50); // Fade in auth wrapper
                document.body.classList.add('login-active'); // Add login active class

                document.getElementById('pastSubmissions').innerHTML = ''; // Clear past submissions
                document.getElementById('noSubmissions').style.display = 'block'; // Show no submissions message
                document.getElementById('authorizedStudentsList').innerHTML = ''; // Clear student list
                document.getElementById('noAuthorizedStudents').style.display = 'block'; // Show no students message
                document.getElementById('unauthorizedMessage').style.display = 'none'; // Ensure unauthorized message is hidden on logout
                
                currentAuthReady = true; // Auth system is ready, no user.
            }
        });

        // --- Google Sign-In Function ---
        document.getElementById('googleSignInButton').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                console.log("Google Sign-In successful:", result.user);
                // onAuthStateChanged listener will handle UI update and role check.
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                const errorMessage = error.message;
                document.getElementById('authError').textContent = `Sign-in failed: ${errorMessage}`;
                showModal('Sign-In Error', `Failed to sign in with Google. Details: ${errorMessage}`);
            }
        });

        document.getElementById('logoutButton').addEventListener('click', async () => {
            try {
                currentUserRole = null;
                currentUserName = null;
                currentUserId = null;
                currentUserEmail = null;
                document.getElementById('userDisplayName').textContent = `Not logged in`;
                document.getElementById('appSection').style.display = 'none';
                document.getElementById('authWrapper').style.display = 'flex'; // Show login wrapper
                document.getElementById('authContent').style.display = 'flex'; // Show Google Sign-In
                document.getElementById('codeEntryContent').style.display = 'none'; // Hide code entry
                document.body.classList.add('login-active'); // Add login active class

                document.getElementById('pastSubmissions').innerHTML = ''; // Clear past submissions
                document.getElementById('noSubmissions').style.display = 'block'; // Show no submissions message
                document.getElementById('authorizedStudentsList').innerHTML = ''; // Clear student list
                document.getElementById('noAuthorizedStudents').style.display = 'block'; // Show no students message
                document.getElementById('unauthorizedMessage').style.display = 'none'; // Ensure unauthorized message is hidden on logout


                await signOut(auth);
                showModal('Logged Out', 'You have been logged out successfully.');
            } catch (error) {
                console.error("Logout error:", error);
                showModal('Logout Error', `Failed to log out: ${error.message}`);
            }
        });

        // --- UI Section Toggle Functions (with transitions) ---
        function showSection(sectionIdToShow) {
            const sections = ['gradingSection', 'chatSection', 'studentManagementSection'];
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (id === sectionIdToShow) {
                    section.style.opacity = '0'; // Start hidden for transition
                    // Ensure display flex for chat/management sections to maintain column layout
                    section.style.display = (id === 'chatSection' || id === 'studentManagementSection') ? 'flex' : 'block';
                    setTimeout(() => { section.style.opacity = '1'; }, 50); // Small delay to trigger transition
                } else {
                    section.style.opacity = '0'; // Fade out
                    setTimeout(() => { section.style.display = 'none'; }, 400); // Match CSS transition duration
                }
            });
        }

        document.getElementById('toggleGradingButton').addEventListener('click', () => showSection('gradingSection'));
        document.getElementById('toggleChatButton').addEventListener('click', () => showSection('chatSection'));
        document.getElementById('manageStudentsButton').addEventListener('click', () => {
            if (currentUserRole === 'teacher') {
                showSection('studentManagementSection');
                loadAuthorizedStudents(); // Reload list when showing
            } else {
                showModal('Access Denied', 'Only teachers can manage students.');
            }
        });


        // --- File Handling Functions ---
        // New function to upload file to Firebase Storage and return URL
        async function uploadFileToStorage(file, path) {
            if (!file) return null;
            const storageRef = ref(storage, path + '/' + file.name + '-' + Date.now()); // Unique filename
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            return downloadURL;
        }

        // Modified readFileAsBase64 to only handle PDF to image conversion
        // Direct image files will now be uploaded to Storage
        async function processFileForGemini(file) {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                return new Promise((resolve, reject) => {
                    reader.onload = () => resolve([{ type: file.type, data: reader.result.split(',')[1] }]);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            } else if (file.type === 'application/pdf') {
                try {
                    const loadingTask = pdfjsLib.getDocument({ url: URL.createObjectURL(file) });
                    const pdf = await loadingTask.promise;
                    const numPages = pdf.numPages;
                    const images = [];

                    // Show processing message for PDF
                    const originalLoadingText = gradingLoadingIndicator.textContent; // Use grading-specific indicator
                    gradingLoadingIndicator.style.display = 'block';
                    gradingLoadingIndicator.textContent = `Rendering PDF pages for AI: Page 1 of ${numPages}`;

                    for (let i = 1; i <= numPages; i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 2 }); // Scale for better resolution
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        images.push({ type: 'image/png', data: canvas.toDataURL('image/png').split(',')[1] });
                        canvas.remove(); // Clean up canvas element
                        if (i < numPages) { // Only update if more pages are coming
                            gradingLoadingIndicator.textContent = `Rendering PDF pages for AI: Page ${i + 1} of ${numPages}`;
                        }
                    }
                    gradingLoadingIndicator.style.display = 'none'; // Hide after processing
                    gradingLoadingIndicator.textContent = originalLoadingText; // Restore original text
                    return images; // Return array of image data
                } catch (error) {
                    gradingLoadingIndicator.style.display = 'none'; // Hide on error
                    throw new Error("Failed to render PDF: " + error.message);
                }
            } else {
                throw new Error("Unsupported file type. Please upload an image or PDF.");
            }
        }

        // --- Drag and Drop File Handlers ---
        function setupDropZone(dropZoneId, fileInputId, fileNameDisplayId, filePreviewId) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            const fileNameDisplay = document.getElementById(fileNameDisplayId);
            const filePreview = document.getElementById(filePreviewId);

            // Trigger file input click when drop zone is clicked
            dropZone.addEventListener('click', () => fileInput.click());

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false); // Global prevent
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Highlight drop zone when dragging over
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('highlight'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('highlight'), false);
            });

            // Handle dropped files
            dropZone.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    fileInput.files = files; // Assign files to the hidden input
                    // Manually trigger change event since it's not a user-initiated click
                    const changeEvent = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(changeEvent);
                }
            }

            // Update file name and preview when file input changes (for both click and drop)
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    fileNameDisplay.textContent = file.name;
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            filePreview.src = e.target.result;
                            filePreview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else if (file.type === 'application/pdf') {
                        const loadingTask = pdfjsLib.getDocument({ url: URL.createObjectURL(file) });
                        loadingTask.promise.then(pdf => {
                            pdf.getPage(1).then(page => {
                                const viewport = page.getViewport({ scale: 1.0 });
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                page.render({ canvasContext: context, viewport: viewport }).promise.then(() => {
                                    filePreview.src = canvas.toDataURL('image/png');
                                    filePreview.style.display = 'block';
                                    canvas.remove();
                                });
                            });
                        }).catch(error => {
                            console.error("Error rendering PDF preview:", error);
                            filePreview.src = "https://placehold.co/150x200/cccccc/000000?text=PDF+Error";
                            filePreview.style.display = 'block';
                        });
                    }
                } else {
                    fileNameDisplay.textContent = 'No file chosen';
                    filePreview.style.display = 'none';
                    filePreview.src = '';
                }
            });
        }

        // Setup the drop zones for student and answer key files
        setupDropZone('studentDropZone', 'studentAnswerFile', 'studentFileName', 'studentFilePreview');
        setupDropZone('answerKeyDropZone', 'answerKeyFile', 'answerKeyFileName', 'answerKeyFilePreview');


        const gradeButton = document.getElementById('gradeButton');
        const studentAnswerInput = document.getElementById('studentAnswer');
        const answerKeyInput = document.getElementById('answerKey');
        const studentAnswerFile = document.getElementById('studentAnswerFile'); // Keep for direct file access
        const answerKeyFile = document.getElementById('answerKeyFile'); // Keep for direct file access
        const gradeResultDisplay = document.getElementById('gradeResult');
        const gradingLoadingIndicator = document.getElementById('gradingLoadingIndicator'); // Specific for grading
        const pastSubmissionsContainer = document.getElementById('pastSubmissions');
        const noSubmissionsMessage = document.getElementById('noSubmissions');

        // --- Load Past Submissions from Firestore ---
        async function loadPastSubmissions() {
            if (!currentAuthReady || !currentUserId || currentUserRole === 'unassigned') {
                console.log("Auth not ready, no user, or user unassigned. Skipping loading past submissions.");
                pastSubmissionsContainer.innerHTML = '';
                noSubmissionsMessage.style.display = 'block';
                return;
            }
            // No need to check for 'unauthorized' role anymore, as that implies code not entered

            pastSubmissionsContainer.innerHTML = ''; // Clear previous submissions
            noSubmissionsMessage.style.display = 'block'; // Show "No submissions" initially

            try {
                console.log(`Loading past submissions for user: ${currentUserId}`);
                // IMPORTANT: Ensure the path matches your Firestore security rules for private data
                const submissionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/submissions`);
                const q = query(submissionsCollectionRef, orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log("No past submissions found for this user.");
                    noSubmissionsMessage.style.display = 'block';
                    return;
                }

                noSubmissionsMessage.style.display = 'none'; // Hide "No submissions" if there are submissions
                console.log(`Found ${querySnapshot.docs.length} past submissions.`);

                querySnapshot.forEach((doc) => {
                    const submission = doc.data();
                    const submissionElement = document.createElement('div');
                    submissionElement.className = 'bg-gray-100 p-4 rounded-lg shadow-sm border border-gray-200';
                    let studentWorkHtml = '';
                    if (submission.studentAnswerText) {
                        studentWorkHtml += `<p class="text-gray-700"><strong>Student Answer (Text):</strong> ${submission.studentAnswerText.substring(0, 150)}${submission.studentAnswerText.length > 150 ? '...' : ''}</p>`;
                    }
                    // Display images from URLs stored in Firebase Storage
                    if (submission.studentAnswerFileUrls && submission.studentAnswerFileUrls.length > 0) {
                        studentWorkHtml += `<p class="text-gray-700 mt-2"><strong>Student Work (Files):</strong></p>`;
                        submission.studentAnswerFileUrls.forEach(url => {
                            // Check if it's an image for direct display, otherwise a link
                            if (url.match(/\.(jpeg|jpg|gif|png|webp)$/i)) { // Simple check for image extensions
                                studentWorkHtml += `<img src="${url}" class="w-full h-auto max-h-40 object-contain rounded mt-2">`;
                            } else { // Assume PDF or other
                                studentWorkHtml += `<a href="${url}" target="_blank" class="text-blue-600 hover:underline mt-2 block">${url.substring(url.lastIndexOf('/') + 1).split('?')[0]} (View PDF/File)</a>`;
                            }
                        });
                    }

                    let answerKeyHtml = '';
                    if (submission.answerKeyText) {
                        answerKeyHtml += `<p class="text-gray-700"><strong>Answer Key (Text):</strong> ${submission.answerKeyText.substring(0, 150)}${submission.answerKeyText.length > 150 ? '...' : ''}</p>`;
                    }
                    if (submission.answerKeyFileUrls && submission.answerKeyFileUrls.length > 0) {
                        answerKeyHtml += `<p class="text-gray-700 mt-2"><strong>Answer Key (Files):</strong></p>`;
                        submission.answerKeyFileUrls.forEach(url => {
                            if (url.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
                                answerKeyHtml += `<img src="${url}" class="w-full h-auto max-h-40 object-contain rounded mt-2">`;
                            } else {
                                answerKeyHtml += `<a href="${url}" target="_blank" class="text-blue-600 hover:underline mt-2 block">${url.substring(url.lastIndexOf('/') + 1).split('?')[0]} (View PDF/File)</a>`;
                            }
                        });
                    }


                    submissionElement.innerHTML = `
                        <h3 class="font-semibold text-lg text-gray-800 mb-2">Submission on ${new Date(submission.timestamp).toLocaleString()}</h3>
                        ${studentWorkHtml}
                        ${answerKeyHtml}
                        <div class="mt-4">
                            <p class="font-medium text-indigo-600"><strong>Gemini Grade:</strong></p>
                            <p class="text-gray-800 text-sm mt-1">${submission.geminiGrade || 'N/A'}</p>
                        </div>
                    `;
                    pastSubmissionsContainer.appendChild(submissionElement);
                });
            } catch (error) {
                console.error("Error loading past submissions:", error);
                showModal('Error Loading Submissions', `Could not load past submissions. Details: ${error.message}`);
            }
        }


        // --- Main Grading Logic ---
        gradeButton.addEventListener('click', async () => {
            // Ensure user is authenticated and has a valid role (not 'unassigned')
            if (!currentUserId || !currentUserRole || currentUserRole === 'unassigned') {
                showModal('Authentication Required', 'Please sign in and enter a valid access code to grade work.');
                return;
            }

            const studentAnswerText = studentAnswerInput.value.trim();
            const answerKeyText = answerKeyInput.value.trim();
            const studentFile = document.getElementById('studentAnswerFile').files[0]; // Get file from hidden input
            const answerKeyFileObj = document.getElementById('answerKeyFile').files[0]; // Get file from hidden input

            // Clear previous error messages
            document.getElementById('studentAnswerError').textContent = '';
            document.getElementById('answerKeyError').textContent = '';
            gradeResultDisplay.style.color = "black"; // Reset color

            if ((!studentAnswerText && !studentFile) || (!answerKeyText && !answerKeyFileObj)) {
                if (!studentAnswerText && !studentFile) {
                    document.getElementById('studentAnswerError').textContent = 'Please provide student answer via text or file.';
                }
                if (!answerKeyText && !answerKeyFileObj) {
                    document.getElementById('answerKeyError').textContent = 'Please provide answer key via text or file.';
                }
                gradeResultDisplay.textContent = "Please provide both student's answer (text, image, or PDF) and the answer key (text, image, or PDF).";
                gradeResultDisplay.style.color = "red";
                return;
            }

            gradingLoadingIndicator.style.display = 'block'; // Show loading indicator
            gradeButton.disabled = true; // Disable button during grading

            let studentInputForGemini = []; // Base64 images for Gemini
            let answerKeyInputForGemini = []; // Base64 images for Gemini
            let studentFileDownloadURLs = []; // URLs to store in Firestore
            let answerKeyFileDownloadURLs = []; // URLs to store in Firestore

            try {
                // Process and upload student file (if any)
                if (studentFile) {
                    gradingLoadingIndicator.textContent = `Uploading student file: ${studentFile.name}...`;
                    const fileExtension = studentFile.name.split('.').pop();
                    const fileNameForStorage = `student-work-${currentUserId}-${Date.now()}.${fileExtension}`;
                    const storagePath = `artifacts/${appId}/users/${currentUserId}/submissions_files/${fileNameForStorage}`;
                    const downloadURL = await uploadFileToStorage(studentFile, storagePath);
                    if (downloadURL) {
                        studentFileDownloadURLs.push(downloadURL);
                    }

                    // For Gemini, convert to Base64 images if it's an image or PDF
                    gradingLoadingIndicator.textContent = `Preparing student file for AI analysis...`;
                    studentInputForGemini = await processFileForGemini(studentFile);
                } else if (studentAnswerText) {
                    studentInputForGemini = [{ text: studentAnswerText }];
                }

                // Process and upload answer key file (if any)
                if (answerKeyFileObj) {
                    gradingLoadingIndicator.textContent = `Uploading answer key file: ${answerKeyFileObj.name}...`;
                    const fileExtension = answerKeyFileObj.name.split('.').pop();
                    const fileNameForStorage = `answer-key-${currentUserId}-${Date.now()}.${fileExtension}`;
                    const storagePath = `artifacts/${appId}/users/${currentUserId}/submissions_files/${fileNameForStorage}`;
                    const downloadURL = await uploadFileToStorage(answerKeyFileObj, storagePath);
                    if (downloadURL) {
                        answerKeyFileDownloadURLs.push(downloadURL);
                    }

                    // For Gemini, convert to Base64 images if it's an image or PDF
                    gradingLoadingIndicator.textContent = `Preparing answer key file for AI analysis...`;
                    answerKeyInputForGemini = await processFileForGemini(answerKeyFileObj);
                } else if (answerKeyText) {
                    answerKeyInputForGemini = [{ text: answerKeyText }];
                }


                gradingLoadingIndicator.textContent = 'Sending to Gemini for grading...';
                let geminiPromptParts = [];

                // Add student content to prompt (from processed files or text)
                if (studentInputForGemini.length > 0) {
                    geminiPromptParts.push({ text: "Here is the student's work:" });
                    studentInputForGemini.forEach(part => {
                        if (part.text) {
                            geminiPromptParts.push({ text: `"${part.text}"` });
                        } else if (part.data) {
                            geminiPromptParts.push({
                                inlineData: { mimeType: part.type, data: part.data }
                            });
                        }
                    });
                }


                // Add answer key content to prompt (from processed files or text)
                if (answerKeyInputForGemini.length > 0) {
                    geminiPromptParts.push({ text: "Here is the Answer Key:" }); // Separator for clarity
                    answerKeyInputForGemini.forEach(part => {
                        if (part.text) {
                            geminiPromptParts.push({ text: `"${part.text}"` });
                        } else if (part.data) {
                            geminiPromptParts.push({
                                inlineData: { mimeType: part.type, data: part.data }
                            });
                        }
                    });
                }


                // Add grading instructions to the prompt
                geminiPromptParts.push({ text: `\nYou are an expert exam grader.
                Compare the student's work/answer with the provided answer key.
                Provide a clear grade (e.g., "Excellent", "Good", "Needs Improvement", or a numerical score like "8/10").
                Also, provide specific feedback on what was correct, what was incorrect, and suggestions for improvement.
                Focus on providing detailed, constructive feedback.` });


                let chatHistory = [];
                chatHistory.push({ role: "user", parts: geminiPromptParts });
                const payload = { contents: chatHistory };
                // Your Gemini API Key
                // Make the fetch request to your Cloudflare Worker URL instead of direct Gemini API
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload) // Send the full payload to the Worker
                });
                

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();
                let geminiGrade = "No grade generated.";

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    geminiGrade = result.candidates[0].content.parts[0].text;
                } else {
                    gradeResultDisplay.textContent = "Could not get a valid response from the Gemini API. Please try again.";
                }

                // --- Save Submission to Firestore ---
                const submissionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/submissions`);
                const newSubmission = {
                    submittedBy: currentUserName,
                    submittedByRole: currentUserRole,
                    studentAnswerText: studentAnswerText || null,
                    studentAnswerFileUrls: studentFileDownloadURLs, // Store URLs here
                    studentFileName: studentFile ? studentFile.name : null,
                    answerKeyText: answerKeyText || null,
                    answerKeyFileUrls: answerKeyFileDownloadURLs, // Store URLs here
                    answerKeyFileName: answerKeyFileObj ? answerKeyFileObj.name : null,
                    geminiGrade: geminiGrade,
                    timestamp: Date.now()
                };
                await addDoc(submissionsCollectionRef, newSubmission);
                console.log("Submission saved to Firestore!");
                await loadPastSubmissions(); // Reload submissions to show the new one

            } catch (error) {
                console.error('Error in grading process:', error);
                gradeResultDisplay.textContent = `An error occurred while grading: ${error.message}. Please check the console for more details.`;
                showModal('Grading Error', `An unexpected error occurred during grading. Details: ${error.message}`);
            } finally {
                gradingLoadingIndicator.style.display = 'none'; // Hide loading indicator
                gradeButton.disabled = false; // Re-enable button
            }
        });

        // --- Gemini Chat Logic ---
        const chatDisplay = document.getElementById('chatDisplay');
        const chatInput = document.getElementById('chatInput');
        const sendChatButton = document.getElementById('sendChatButton');
        const chatLoadingIndicator = document.getElementById('chatLoadingIndicator');

        // Initial chat history with a greeting
        let geminiChatHistory = [{
            role: "model",
            parts: [{ text: "Hello! I'm Gemini. How can I help you today?" }]
        }];

        async function sendChatMessage() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            if (!currentUserId || currentUserRole === 'unassigned') { // Check for valid user and assigned role
                showModal('Authentication Required', 'Please sign in and enter a valid access code to chat with Gemini.');
                return;
            }

            // Display user message
            appendMessage(userMessage, 'user');
            chatInput.value = ''; // Clear input

            // Add user message to history
            geminiChatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            chatLoadingIndicator.style.display = 'block'; // Show typing indicator
            sendChatButton.disabled = true;

            try {
                const payload = { contents: geminiChatHistory };
                // Make the fetch request to your Cloudflare Worker URL instead of direct Gemini API
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload) // Send the full payload to the Worker
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();
                let geminiResponseText = "Sorry, I couldn't get a response. Please try again.";

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    geminiResponseText = result.candidates[0].content.parts[0].text;
                }

                // Add Gemini's response to history and display
                geminiChatHistory.push({ role: "model", parts: [{ text: geminiResponseText }] });
                appendMessage(geminiResponseText, 'gemini');

            } catch (error) {
                console.error('Error in Gemini chat:', error);
                const errorMessage = `An error occurred with the chat: ${error.message}. Please check the console.`;
                appendMessage(errorMessage, 'gemini'); // Display error in chat
                showModal('Chat Error', errorMessage);
            } finally {
                    chatLoadingIndicator.style.display = 'none'; // Hide typing indicator
                sendChatButton.disabled = false;
                chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom
            }
        }

        function appendMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${sender}`;
            messageElement.textContent = text;
            chatDisplay.appendChild(messageElement);
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Auto-scroll to latest message
        }

        sendChatButton.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) { // Send on Enter, allow Shift+Enter for new line
                event.preventDefault();
                sendChatMessage();
            }
        });

        // --- Teacher: Student Management Logic ---
        const studentEmailInput = document.getElementById('studentEmailInput');
        const addStudentButton = document.getElementById('addStudentButton');
        const authorizedStudentsList = document.getElementById('authorizedStudentsList');
        const noAuthorizedStudentsMessage = document.getElementById('noAuthorizedStudents'); 
        const studentManagementLoading = document.getElementById('studentManagementLoading');


        // Live listener for authorized students (teacher view)
        let unsubscribeStudents = null; // To store the unsubscribe function

        async function loadAuthorizedStudents() {
            if (!currentAuthReady || currentUserRole !== 'teacher') {
                console.log("Not a teacher or auth not ready, skipping loading authorized students.");
                authorizedStudentsList.innerHTML = '';
                noAuthorizedStudentsMessage.style.display = 'block';
                return;
            }

            if (unsubscribeStudents) {
                unsubscribeStudents(); // Unsubscribe from previous listener if it exists
            }

            studentManagementLoading.style.display = 'block';
            studentManagementLoading.textContent = 'Loading authorized students...';
            authorizedStudentsList.innerHTML = ''; // Clear existing list
            noAuthorizedStudentsMessage.style.display = 'block'; // Show 'No students' by default

            try {
                // This path is now CORRECT for fetching authorized students emails
                const authorizedStudentsCollectionRef = collection(db, `artifacts/${appId}/authorized_users/auth_data/student_emails`);
                const q = query(authorizedStudentsCollectionRef, orderBy('email')); // Order for consistent display

                // Use onSnapshot for real-time updates
                unsubscribeStudents = onSnapshot(q, (snapshot) => {
                    authorizedStudentsList.innerHTML = ''; // Clear list on every update
                    if (snapshot.empty) {
                        noAuthorizedStudentsMessage.style.display = 'block';
                        console.log("No authorized students found.");
                        return;
                    }

                    noAuthorizedStudentsMessage.style.display = 'none';
                    snapshot.forEach((doc) => {
                        const studentData = doc.data();
                        const studentDocId = doc.id;
                        const studentEmail = studentData.email;

                        const studentEntry = document.createElement('div');
                        studentEntry.className = 'flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100 mb-2';
                        studentEntry.innerHTML = `
                            <span class="text-gray-800 font-medium">${studentEmail}</span>
                            <button class="remove-student-btn btn-secondary" data-doc-id="${studentDocId}">Remove</button>
                        `;
                        authorizedStudentsList.appendChild(studentEntry);
                    });
                    studentManagementLoading.style.display = 'none';
                }, (error) => {
                    console.error("Error listening to authorized students:", error);
                    studentManagementLoading.textContent = `Error: ${error.message}`;
                    showModal('Error', `Failed to load student list: ${error.message}`);
                });

            } catch (error) {
                console.error("Error setting up student listener:", error);
                studentManagementLoading.textContent = `Error: ${error.message}`;
                showModal('Error', `Failed to load student list: ${error.message}`);
            } finally {
                // Initial hide will be done by onSnapshot callback
            }
        }


        addStudentButton.addEventListener('click', async () => {
            const email = studentEmailInput.value.trim();
            if (!email) {
                showModal('Input Required', 'Please enter a student email address.');
                return;
            }
            if (!/\S+@\S+\.\S+/.test(email)) { // Simple email validation
                showModal('Invalid Email', 'Please enter a valid email address.');
                return;
            }
            if (currentUserRole !== 'teacher') {
                showModal('Access Denied', 'Only teachers can add students.');
                return;
            }

            studentManagementLoading.style.display = 'block';
            studentManagementLoading.textContent = 'Adding student...';

            try {
                // This path is now CORRECT for adding authorized student emails
                const authorizedStudentsCollectionRef = collection(db, `artifacts/${appId}/authorized_users/auth_data/student_emails`);
                // Check if email already exists
                const q = query(authorizedStudentsCollectionRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    showModal('Student Exists', `Student with email ${email} is already authorized.`);
                    studentManagementLoading.style.display = 'none';
                    return;
                }

                // Add new student email. Firestore will auto-generate doc ID.
                await addDoc(authorizedStudentsCollectionRef, {
                    email: email,
                    addedBy: currentUserId,
                    timestamp: Date.now()
                });
                showModal('Success', `Student ${email} added successfully.`);
                studentEmailInput.value = ''; // Clear input
            } catch (error) {
                console.error("Error adding student:", error);
                showModal('Error', `Failed to add student: ${error.message}`);
            } finally {
                studentManagementLoading.style.display = 'none';
            }
        });

        // Event delegation for remove buttons (since they are added dynamically)
        authorizedStudentsList.addEventListener('click', async (event) => {
            if (event.target.classList.contains('remove-student-btn')) {
                const docId = event.target.dataset.docId;
                if (!docId) return;

                if (currentUserRole !== 'teacher') {
                    showModal('Access Denied', 'Only teachers can remove students.');
                    return;
                }

                showModal('Confirm Removal', `Are you sure you want to remove this student?`, [
                    { text: 'Yes, Remove', className: 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg', onClick: async () => {
                        studentManagementLoading.style.display = 'block';
                        studentManagementLoading.textContent = 'Removing student...';
                        try {
                            // This path is now CORRECT for removing student emails
                            const studentDocRef = doc(db, `artifacts/${appId}/authorized_users/auth_data/student_emails`, docId);
                            await deleteDoc(studentDocRef);
                            showModal('Success', 'Student removed successfully.');
                        } catch (error) {
                            console.error("Error removing student:", error);
                            showModal('Error', `Failed to remove student: ${error.message}`);
                        } finally {
                            studentManagementLoading.style.display = 'none';
                        }
                    }},
                    { text: 'Cancel', className: 'bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg' }
                ]);
            }
        });

        // --- Code Entry Logic ---
        const accessCodeInput = document.getElementById('accessCodeInput');
        const submitCodeButton = document.getElementById('submitCodeButton');
        const codeError = document.getElementById('codeError');
        const codeLoadingIndicator = document.getElementById('codeLoadingIndicator');

        submitCodeButton.addEventListener('click', async () => {
            const code = accessCodeInput.value.trim();
            codeError.textContent = ''; // Clear previous errors
            codeLoadingIndicator.style.display = 'block';
            codeLoadingIndicator.textContent = 'Verifying code...';
            submitCodeButton.disabled = true;

            if (!code) {
                codeError.textContent = 'Please enter an access code.';
                codeLoadingIndicator.style.display = 'none';
                submitCodeButton.disabled = false;
                return;
            }

            let newRole = null;
            let isAuthorized = false;

            // Check if the user's email is in the authorized students list if the code is a student code
            if (code === STUDENT_CODE) {
                if (!currentUserEmail) {
                    codeError.textContent = 'Could not verify student. Please re-login.';
                    codeLoadingIndicator.style.display = 'none';
                    submitCodeButton.disabled = false;
                    return;
                }
                const authorizedStudentsCollectionRef = collection(db, `artifacts/${appId}/authorized_users/auth_data/student_emails`);
                const q = query(authorizedStudentsCollectionRef, where("email", "==", currentUserEmail));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    codeError.textContent = 'Your email is not authorized for student access. Please contact your teacher.';
                    codeLoadingIndicator.style.display = 'none';
                    submitCodeButton.disabled = false;
                    return;
                }
                isAuthorized = true;
                newRole = 'student';
            } else if (code === TEACHER_CODE) {
                isAuthorized = true; // Teacher code is direct authorization
                newRole = 'teacher';
            } else {
                codeError.textContent = 'Invalid code. Please try again.';
                codeLoadingIndicator.style.display = 'none';
                submitCodeButton.disabled = false;
                return;
            }

            if (!isAuthorized) {
                 codeError.textContent = 'Access Denied. Invalid code or unauthorized email.';
                 codeLoadingIndicator.style.display = 'none';
                 submitCodeButton.disabled = false;
                 return;
            }

            try {
                // Save the assigned role to the user's profile
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await setDoc(userProfileRef, {
                    role: newRole,
                    email: currentUserEmail, // Ensure email is saved with the role
                    lastLogin: Date.now()
                }, { merge: true });

                currentUserRole = newRole; // Update local role
                accessCodeInput.value = ''; // Clear code input
                showModal('Success', `Welcome! You are now logged in as a ${newRole}.`);
                
                // Re-evaluate auth state to update UI (this will call onAuthStateChanged again)
                // This ensures all UI elements are updated correctly based on the new role.
                const user = auth.currentUser;
                if (user) {
                    onAuthStateChanged(auth, (re_user) => {
                        console.log("Re-triggering onAuthStateChanged after code submission.");
                    });
                }
                
            } catch (error) {
                console.error("Error saving user role after code entry:", error);
                codeError.textContent = `Error: ${error.message}. Could not save your role.`;
                showModal('Role Assignment Error', `Failed to assign your role: ${error.message}`);
            } finally {
                codeLoadingIndicator.style.display = 'none';
                submitCodeButton.disabled = false;
            }
        });
    </script>
</body>
</html>
