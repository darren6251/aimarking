<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Marker</title>
    <!-- PDF.js library for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- Custom styles -->
    <style>
        /* --- MODERN BLACK & WHITE THEME --- */
        :root {
            --bg-primary: #0a0a0a; /* Near black for main background */
            --bg-secondary: #1a1a1a; /* Dark gray for secondary elements */
            --bg-tertiary: #2a2a2a; /* Lighter gray for hovers */
            --text-primary: #f5f5f5; /* Off-white for primary text */
            --text-secondary: #a3a3a3; /* Muted gray for secondary text */
            --accent-primary: #ffffff; /* White for key actions and highlights */
            --accent-red: #ef4444; /* A modern, sharp red for destructive actions */
            --border-color: #333333; /* Subtle border color */
            --focus-ring-color: rgba(245, 245, 245, 0.5); /* Semi-transparent white for focus rings */

            /* Finder Window Specific Variables */
            --finder-bg-primary: #1c1c1c;
            --finder-bg-secondary: #0a0a0a;
            --finder-text-primary: #f5f5f5;
            --finder-text-secondary: #a3a3a3;
            --finder-border-color: #333333;
            --finder-titlebar-bg: #2a2a2a;
            --finder-hover-bg: #333333;
            --finder-active-bg: var(--accent-primary);
            --finder-active-text: #0a0a0a;
        }
        
        /* --- LIGHT THEME OVERRIDES --- */
        body.light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e5e5e5;
            --text-primary: #0a0a0a;
            --text-secondary: #737373;
            --accent-primary: #0a0a0a;
            --border-color: #d4d4d4;
            --focus-ring-color: rgba(10, 10, 10, 0.5);

            /* Finder Window Light Theme */
            --finder-bg-primary: #ffffff;
            --finder-bg-secondary: #f5f5f5;
            --finder-text-primary: #0a0a0a;
            --finder-text-secondary: #737373;
            --finder-border-color: #d4d4d4;
            --finder-titlebar-bg: #e5e5e5;
            --finder-hover-bg: #e5e5e5;
            --finder-active-bg: var(--accent-primary);
            --finder-active-text: #ffffff;
        }


        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            overflow-x: hidden;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        button,
        input,
        textarea,
        select {
            transition: all .2s ease-in-out;
            font-family: inherit;
        }

        button:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        /* Keyframe animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* --- LOGIN PAGE --- */
        #authWrapper {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1001;
        }

        .login-left-panel,
        .login-right-panel {
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .login-left-panel {
            background: var(--bg-primary);
            color: var(--text-primary);
            flex-direction: column;
            text-align: center;
        }

        .login-left-panel h1 {
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 1rem;
        }

        .login-left-panel p {
            font-size: 1.25rem;
            font-weight: 400;
            line-height: 1.5;
            margin-bottom: .5rem;
            color: var(--text-secondary);
        }

        .login-right-panel {
            background: var(--bg-secondary);
            flex-direction: column;
        }
        
        #authContainer {
            width: 100%;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            background-color: var(--bg-primary);
            padding: 2.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        #authContainer h2 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2rem;
            text-align: center;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: .75rem;
            cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        .google-btn:hover { background-color: var(--bg-tertiary); border-color: var(--text-secondary); }
        .google-btn img { height: 20px; }
        
        #accessCodeInput {
             background-color: var(--bg-secondary);
             border: 1px solid var(--border-color);
             color: var(--text-primary);
             padding: 12px;
             border-radius: 8px;
             width: 100%;
             margin-bottom: 1rem;
             text-align: center;
             font-size: 1rem;
        }
        #accessCodeInput:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--focus-ring-color);
        }

        .btn-primary {
             background-color: var(--accent-primary);
             color: var(--bg-primary);
             padding: .75rem 1.5rem;
             border-radius: 8px;
             border: none;
             cursor: pointer;
             font-weight: 600;
             font-size: 1rem;
        }
        
        body.light-theme .btn-primary {
            color: var(--bg-primary);
        }

        .btn-primary:hover {
             opacity: 0.85;
             transform: translateY(-1px);
        }
        
        #appSection {
            display: none;
            flex-direction: column;
            height: 100vh;
            background-color: var(--bg-primary);
            animation: fadeIn .6s ease-out both;
        }
        
        /* --- HEADER --- */
        header {
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            padding: 0 24px;
            height: 64px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .logo-container { display: flex; align-items: center; gap: 1rem; }
        .logo-container h1 { font-size: 1.5rem; font-weight: 700; }
        .logo-container p { font-weight: 400; color: var(--text-secondary); }
        
        .header-actions { margin-left: auto; display: flex; align-items: center; gap: 0.5rem; }

        /* Modernized Header Buttons */
        .header-actions .tab {
            padding: 8px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: .2s;
            border: none;
            border-radius: 8px;
            background: transparent;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .header-actions .tab:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .header-actions .tab.active {
            background: var(--bg-secondary);
            color: var(--accent-primary);
            font-weight: 600;
        }

        .user-info { display: flex; align-items: center; gap: 1rem; margin-left: 1rem; }
        #userDisplayName { font-weight: 500; cursor: pointer; }
        .logout-btn { background: none; border: 1px solid var(--border-color); color: var(--text-secondary); cursor: pointer; padding: 6px 12px; border-radius: 8px; font-weight: 600; }
        .logout-btn:hover { background: var(--accent-red); border-color: var(--accent-red); color: var(--accent-primary); }
        
        #switchRoleButton {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-weight: 600;
        }
        #switchRoleButton:hover {
            background-color: var(--bg-tertiary);
            border-color: var(--text-secondary);
        }

        /* --- DROPDOWN MENU --- */
        .dropdown-menu {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-menu-content {
            display: none;
            position: absolute;
            top: 110%; /* Adjusted to be clearly below the button */
            left: 0;
            background-color: var(--bg-secondary);
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
            z-index: 10;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 4px;
            animation: fadeIn 0.2s ease-out;
        }

        .dropdown-menu-content button {
            color: var(--text-secondary);
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .dropdown-menu-content button:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .dropdown-menu:hover .dropdown-menu-content {
            display: block;
        }

        /* --- MAIN CONTENT --- */
        main {
            flex: 1;
            display: flex;
            overflow-y: auto;
            padding: 32px;
            gap: 32px;
            justify-content: center; /* Center content horizontally */
        }
        
        #homeSection, #gradingSection, #chatSection, #studentManagementSection, #profileSection, #tutorialSection, #pastPapersSection, #exerciseSection, #submissionSection {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            width: 100%; /* Take full width of main */
            max-width: 900px; /* Max width for content readability */
            margin: 0 auto; /* Center content within main */
        }
        
        #gradingSection, #chatSection, #studentManagementSection, #submissionSection {
            max-width: 900px; /* Consistent max-width for these sections */
            margin: 0 auto;
        }

        /* --- FORMS --- */
        label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); }
        input[type="text"], input[type="number"], input[type="email"], select, input[type="url"], textarea, input[type="date"] {
            width: 100%; 
            background-color: var(--bg-secondary); 
            border: 1px solid var(--border-color); 
            color: var(--text-primary);
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }
        textarea { resize: vertical; min-height: 120px; }
        input:focus, textarea:focus, select:focus { 
            outline: none; 
            border-color: var(--accent-primary); 
            box-shadow: 0 0 0 3px var(--focus-ring-color); 
        }
        
        .drop-zone { 
            border: 2px dashed var(--border-color); 
            border-radius: 8px; 
            min-height: 140px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: var(--text-secondary); 
            font-size: 1rem; 
            margin-bottom: 1.5rem; 
            cursor: pointer; 
            word-wrap: break-word; 
            padding: 1rem; 
            text-align: center; 
        }
        .drop-zone.highlight { 
            border-color: var(--accent-primary); 
            background: rgba(245, 245, 245, .05); 
        }
        
        body.light-theme .drop-zone.highlight {
            background: rgba(10, 10, 10, .05);
        }

        .file-preview { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; max-height: 200px; object-fit: contain; }
        .error-message { color: var(--accent-red); font-size: 0.875rem; margin-top: -1rem; margin-bottom: 1rem; }

        #resultContainer { margin-top: 1.5rem; padding: 1.5rem; border-radius: 8px; background-color: var(--bg-secondary); border: 1px solid var(--border-color); min-height: 100px; white-space: pre-wrap; }
        #pastSubmissions { margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .submission-card { background-color: var(--bg-secondary); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); }

        /* --- CHAT --- */
        #chatSection { display: flex; flex-direction: column; gap: 1rem; }
        #chatDisplay { flex: 1; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { max-width: 80%; padding: 12px 18px; border-radius: 20px; line-height: 1.5; word-wrap: break-word; }
        .chat-message.user { background-color: var(--accent-primary); color: var(--bg-primary); align-self: flex-end; border-bottom-right-radius: 6px; }
        body.light-theme .chat-message.user { color: var(--bg-primary); }
        .chat-message.gemini { background-color: var(--bg-secondary); align-self: flex-start; border-bottom-left-radius: 6px; }
        .chat-input-wrapper { display: flex; gap: .5rem; flex-shrink: 0; }
        #chatInput { flex: 1; }
        #sendChatButton { background: var(--accent-primary); color: var(--bg-primary); }
        body.light-theme #sendChatButton { color: var(--bg-primary); }
        #sendChatButton:hover { opacity: 0.85; }
        
        .loading-indicator { text-align: center; padding: 1rem; color: var(--text-secondary); }

        /* --- UNIVERSAL STYLES --- */
        .section-title { font-size: 2rem; font-weight: 700; margin-bottom: 2rem; letter-spacing: -0.5px; }
        .form-container { max-width: 100%; margin-bottom: 2rem; background: var(--bg-secondary); padding: 2rem; border-radius: 12px; border: 1px solid var(--border-color); }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }

        /* --- STUDENT MANAGEMENT --- */
        #studentManagementSection { display: flex; flex-direction: column; gap: 1.5rem; }
        .student-card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; position: relative;}
        .student-card h3 { font-size: 1.25rem; margin-bottom: 1rem; }
        .student-info p { margin-bottom: 0.5rem; color: var(--text-secondary); }
        .student-info p strong { color: var(--text-primary); }
        .purchase-history { margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem; }
        .purchase-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); }
        .purchase-item:last-child { border-bottom: none; }
        .delete-student-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--accent-red);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            border-radius: 50%;
        }
        .delete-student-btn:hover {
            background-color: rgba(239, 68, 68, 0.1); /* Light red hover */
        }


        /* --- MATERIAL CARDS (Tutorials, Papers, Exercises) --- */
        .material-card { background-color: var(--bg-secondary); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); display: flex; flex-direction: column; position:relative; text-decoration: none; color: var(--text-primary); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .material-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .material-card-thumbnail { position: relative; cursor: pointer; }
        .material-card-thumbnail img { width: 100%; display: block; aspect-ratio: 16/9; object-fit: cover; }
        .material-card-content { padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column; }
        .material-card-content h3 { font-size: 1.25rem; margin-bottom: 0.5rem; }
        
        /* --- TEACHER CONTENT MANAGEMENT --- */
        .content-item { 
            padding: 1rem; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            margin-bottom: 1rem; 
            background: var(--bg-primary); 
            transition: background-color 0.2s ease-in-out;
        }
        .content-item.drag-over {
            background-color: rgba(245, 245, 245, 0.1);
            border-color: var(--accent-primary);
        }
        body.light-theme .content-item.drag-over {
            background-color: rgba(10, 10, 10, 0.1);
        }

        .content-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 0.5rem; }
        .content-header h3, .content-header h4 { margin: 0; }
        .item-actions button { margin-left: 0.5rem; padding: 6px 10px; font-size: 0.8rem; }
        
        .nested-container { 
            padding-left: 1.5rem; 
            margin-top: 0.5rem;
            border-left: 2px solid var(--border-color); 
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 0;
        }
        .nested-container.expanded { max-height: 1000px; } /* Sufficiently large to show content */

        .sub-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 6px; cursor: grab; }
        .sub-item:hover { background-color: var(--bg-tertiary); }
        .sub-item a { color: var(--text-primary); text-decoration: none; }
        .sub-item a:hover { text-decoration: underline; }

        .collapse-arrow {
            margin-left: 10px; transition: transform 0.3s ease-out; display: inline-block; width: 0; height: 0;
            border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid var(--text-secondary);
        }
        .content-header[aria-expanded="true"] .collapse-arrow { transform: rotate(90deg); }
        .content-header[aria-expanded="false"] .collapse-arrow { transform: rotate(0deg); }

        /* --- VIDEO & HERO --- */
        .video-embed-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; border-radius: 8px 8px 0 0; }
        .video-embed-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .play-button-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; color: rgba(255, 255, 255, 0.8); text-shadow: 0 0 15px rgba(0, 0, 0, 0.5); pointer-events: none; transition: all 0.2s ease; }
        .material-card-thumbnail:hover .play-button-overlay { color: #fff; transform: translate(-50%, -50%) scale(1.1); }

        .hero { display: flex; align-items: center; justify-content: space-between; padding: 2rem 1.5rem; }
        .hero-text { max-width: 50%; opacity: 0; animation: slideInUp 1s ease-out forwards; }
        .hero-text h2 { font-size: 3rem; font-weight: 700; letter-spacing: -1px; }
        .hero-text span { display: block; font-size: 1.5rem; font-weight: normal; margin-top: 0.5rem; color: var(--text-secondary); }
        .hero-image { max-width: 40%; opacity: 0; animation: slideInUp 1s 0.2s ease-out forwards; }
        .hero-image img { width: 100%; height: auto; display: block; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }

        .buttons { margin-top: 1.5rem; display: flex; gap: 1rem; }
        .buttons a { padding: 0.75rem 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: background 0.2s, color 0.2s; color: var(--text-primary); text-decoration: none; }
        .buttons a:hover { background: var(--accent-primary); color: var(--bg-primary); border-color: var(--accent-primary); }
        body.light-theme .buttons a:hover { color: var(--bg-primary); }

        /* --- E-COMMERCE --- */
        .store-layout { display: flex; gap: 24px; width: 100%; }
        .product-grid { flex-grow: 1; }
        .shopping-cart { width: 320px; flex-shrink: 0; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; height: fit-content; }
        .shopping-cart h3 { font-size: 1.25rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        #cart-items { display: flex; flex-direction: column; gap: 0.75rem; max-height: 300px; overflow-y: auto; margin-bottom: 1rem; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; }
        .remove-from-cart-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1rem; margin-left: 0.5rem; }
        .remove-from-cart-btn:hover { color: var(--accent-red); }
        #cart-summary { border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem; }
        #checkout-btn { width: 100%; margin-top: 1rem; }
        .product-card { background-color: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); padding: 1.5rem; display: flex; flex-direction: column; justify-content: space-between; }
        .product-card h4 { font-size: 1.1rem; margin-bottom: 0.5rem; }
        .product-price { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem; }
        .add-to-cart-btn, .download-btn { width: 100%; }
        .download-btn { background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); }
        .download-btn:hover { background-color: var(--bg-tertiary); }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; animation: fadeIn 0.3s ease-out; }
        .modal-content { background-color: var(--bg-secondary); padding: 30px; border-radius: 12px; border: 1px solid var(--border-color); max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; animation: slideInUp 0.3s ease-out; }
        #modalTitle { margin-bottom: 1rem; font-size: 1.5rem; font-weight: 600; }
        .close-button { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: var(--text-secondary); }
        .close-button:hover { color: var(--text-primary); }
        #modalButtons { display:flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }

        #pdfPreviewModal .modal-content { max-width: 90vw; max-height: 90vh; width: auto; height: auto; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        #pdfCanvasContainer { width: 100%; flex-grow: 1; display: flex; justify-content: center; align-items: center; overflow: auto; margin-bottom: 10px; }
        #pdfCanvas { border: 1px solid var(--border-color); display: block; max-width: 100%; height: auto; }
        #pdfControls button { background-color: var(--bg-tertiary); color: var(--text-primary); }
        #pdfControls button:hover:not(:disabled) { background-color: #444; }

        /* --- FOOTER --- */
        footer { position: fixed; bottom: 0; right: 0; text-align: right; padding: 10px 20px; color: var(--text-secondary); font-size: 0.875rem; z-index: 100; pointer-events: none; }
        footer a { color: var(--text-secondary); text-decoration: none; pointer-events: all;}
        footer a:hover { text-decoration: underline; color: var(--text-primary); }

        /* --- FINDER WINDOW --- */
        .finder-window-wrapper { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90vw; height: 90vh; max-width: 1200px; max-height: 800px; border: 1px solid var(--finder-border-color); border-radius: 12px; background: var(--finder-bg-primary); overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.4); transition: all 0.3s ease; z-index: 100; resize: both; min-width: 300px; min-height: 200px; color: var(--finder-text-primary); }
        .finder-window-wrapper.fullscreen { top: 0 !important; left: 0 !important; transform: none !important; width: 100vw !important; height: 100vh !important; border-radius: 0 !important; }
        .finder-titlebar { background: var(--finder-titlebar-bg); height: 32px; display: flex; align-items: center; padding: 0 10px; cursor: grab; flex-shrink: 0; border-bottom: 1px solid var(--finder-border-color); justify-content: flex-start; }
        .finder-titlebar .buttons { display: flex; gap: 8px; }
        .finder-circle { width: 12px; height: 12px; border-radius: 50%; }
        .finder-circle.close { background: #ff5f57; }
        .finder-circle.min { background: #ffbd2e; }
        .finder-circle.max { background: #28c840; cursor: pointer; }
        .finder-content { flex: 1; display: flex; overflow: hidden; }
        .finder-sidebar { width: 220px; min-width: 150px; border-right: 1px solid var(--finder-border-color); background: var(--finder-bg-secondary); padding: 10px 0; overflow-y: auto; flex-shrink: 0; }
        .finder-sidebar-item { padding: 8px 20px; font-size: 14px; color: var(--finder-text-primary); cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .finder-sidebar-item:hover { background: var(--finder-hover-bg); }
        .finder-sidebar-item.active { background: var(--finder-active-bg); color: var(--finder-active-text); font-weight: 600; }
        .finder-file-list { flex: 1; display: flex; flex-direction: column; overflow-y: auto; background: var(--finder-bg-primary); }
        .finder-file-list .columns, .finder-file-list .row { display: grid; grid-template-columns: 3fr 1fr 1fr 1fr; padding: 10px 15px; border-bottom: 1px solid var(--finder-border-color); align-items: center; }
        .finder-file-list .columns { background: var(--finder-bg-secondary); font-size: 12px; color: var(--finder-text-secondary); font-weight: 600; text-transform: uppercase; }
        .finder-file-list .row { font-size: 14px; color: var(--finder-text-primary); cursor: pointer; }
        .finder-file-list .row:hover { background: var(--finder-hover-bg); }
        .finder-file-list .row.folder { font-weight: bold; color: var(--text-primary); }

        /* --- RESPONSIVENESS --- */
        @media (max-width: 992px) {
            .store-layout { flex-direction: column; }
            .shopping-cart { width: 100%; position: sticky; bottom: 0; border-radius: 8px 8px 0 0; }
        }
        @media (max-width: 768px) {
            #authWrapper { flex-direction: column; position: static; height: auto; }
            .login-left-panel, .login-right-panel { width: 100%; }
            header { flex-direction: column; height: auto; padding: 1rem; align-items: flex-start; }
            .header-actions { margin-left: 0; margin-top: 1rem; flex-wrap: wrap; }
            main { flex-direction: column; padding: 16px; }
            .hero { flex-direction: column-reverse; text-align: center; }
            .hero-text, .hero-image { max-width: 100%; }
            .buttons { justify-content: center; }
            .finder-window-wrapper { display: none !important; }
        }

        /* Homework Submission Specific Styles */
        .assignment-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
        }
        .assignment-card h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        .assignment-card p {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        .assignment-card .assignment-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        .assignment-submission-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .assignment-submission-item:last-child {
            border-bottom: none;
        }
        .submission-detail {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .submission-actions button {
            margin-left: 0.5rem;
            padding: 6px 10px;
            font-size: 0.8rem;
        }
        #submissionsListContainer {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .student-submission-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .student-submission-card h4 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

    </style>
</head>
<body>

    <div id="authWrapper" style="display: none;">
        <div class="login-left-panel">
            <h1>AI Marker</h1>
            <p>Mark with AI, learn better.</p>
        </div>
        <div class="login-right-panel">
            <div id="authContainer">
                 <!-- JS will inject googleSignInTemplate or codeEntryTemplate -->
            </div>
        </div>
    </div>

    <div id="appSection" style="display: none;">
        <header>
            <div class="logo-container">
                <h1>AI Marker</h1>
                <p>Operated by Darren Ng</p>
            </div>
            <div class="header-actions">
                <button id="toggleHomeButton" class="tab active">Home</button>
                
                <div class="dropdown-menu">
                    <button class="tab" id="workWithAIButton">Work with AI</button>
                    <div class="dropdown-menu-content">
                        <button id="toggleGradingButton" class="tab">Exam Grader</button>
                        <button id="toggleChatButton" class="tab">Chat with Gemini</button>
                    </div>
                </div>

                <div class="dropdown-menu">
                    <button class="tab" id="materialsButton">Materials</button>
                    <div class="dropdown-menu-content">
                        <button id="toggleTutorialButton" class="tab">Tutorial Videos</button>
                        <button id="togglePastPapersButton" class="tab">Past Papers</button>
                        <button id="toggleExercisesButton" class="tab">Exercises for Sale</button>
                    </div>
                </div>

                <button id="toggleSubmissionsButton" class="tab" style="display: none;">Submissions</button>
                <button id="manageStudentsButton" class="tab" style="display: none;">Manage Students</button>
                <button id="toggleProfileButton" class="tab">Profile</button>
                <button id="themeToggleButton" class="tab">Theme</button>
                <div class="user-info">
                     <span id="userDisplayName"></span>
                     <button id="switchRoleButton">Switch Role</button>
                     <button id="logoutButton" class="logout-btn">Log Out</button>
                </div>
            </div>
        </header>
        
        <main>
            <!-- Home Section -->
            <div id="homeSection" style="display: block; opacity: 1;">
                <section class="hero">
                    <div class="hero-text">
                        <h2>AI helps you learn better</h2>
                        <span>to fight DSE</span>
                        <div class="buttons">
                            <a href="#tutorial" id="homeTutorialLink">Tutorial Video</a>
                            <a href="#grader" id="homeGraderLink">Exam Grader</a>
                            <a href="#chat" id="homeChatLink">Chat with AI</a>
                        </div>
                    </div>
                    <div class="hero-image">
                        <img src="https://raw.githubusercontent.com/darren6251/aimarking/refs/heads/main/hero.png" alt="Darren Ng demonstrating AI Marker">
                    </div>
                </section>
            </div>

            <!-- Grading Section -->
            <div id="gradingSection">
                <h2 class="section-title">Exam Grader</h2>
                <div class="mb-4">
                    <label>Upload Student's Work (Image or PDF):</label>
                    <div id="studentDropZone" class="drop-zone">
                        <span>Drag & Drop Student's Work Here or click to select</span>
                        <input type="file" id="studentAnswerFile" accept="image/*,application/pdf" hidden>
                    </div>
                     <span id="studentFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                    <img id="studentFilePreview" class="file-preview mx-auto" style="display: none;" alt="Student Work Preview">
                    <label for="studentAnswer">Or type Student's Answer:</label>
                    <textarea id="studentAnswer" placeholder="Enter student's answer here..."></textarea>
                    <p id="studentAnswerError" class="error-message"></p>
                </div>

                <div class="mb-6">
                    <label>Upload Answer Key (Image or PDF):</label>
                    <div id="answerKeyDropZone" class="drop-zone">
                        <span>Drag & Drop Answer Key Here or click to select</span>
                         <input type="file" id="answerKeyFile" accept="image/*,application/pdf" hidden>
                    </div>
                    <span id="answerKeyFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                    <img id="answerKeyFilePreview" class="file-preview mx-auto" style="display: none;" alt="Answer Key Preview">
                    <label for="answerKey">Or type Answer Key:</label>
                    <textarea id="answerKey" placeholder="Enter the correct answer key here..."></textarea>
                    <p id="answerKeyError" class="error-message"></p>
                </div>

                <button id="gradeButton" class="btn-primary">Grade Work</button>
                <p id="gradingLoadingIndicator" class="loading-indicator"></p>
                <div id="resultContainer">
                    <h2>Grading Results:</h2>
                    <p id="gradeResult">Your grading results will appear here.</p>
                </div>

                <div style="margin-top: 2rem;">
                    <h2>Past Submissions:</h2>
                    <div id="pastSubmissions">
                        <p id="noSubmissions">No past submissions found.</p>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="chatSection">
                <h2 class="section-title">Chat with AI</h2>
                <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <label>AI Source:</label>
                    <input type="radio" id="aiSourceGemini" name="aiSource" value="gemini-api" checked>
                    <label for="aiSourceGemini">Gemini API (Cloud)</label>
                    <input type="radio" id="aiSourceDeepSeek" name="aiSource" value="deepseek-api">
                    <label for="aiSourceDeepSeek">DeepSeek API (Cloud)</label>
                    <input type="radio" id="aiSourceLocal" name="aiSource" value="local-ai">
                    <label for="aiSourceLocal">Local AI (Experimental)</label>
                    <button id="clearChatMemoryButton" class="logout-btn" style="margin-left: auto;">Clear Chat Memory</button>
                </div>
                <div id="chatDisplay">
                    <!-- Chat messages will be appended here -->
                </div>
                <div class="chat-input-wrapper">
                    <input type="text" id="chatInput" placeholder="Type a message…">
                    <button id="sendChatButton" class="btn-primary">Send</button>
                </div>
                 <p id="chatLoadingIndicator" class="loading-indicator"></p>
            </div>

            <!-- Submission Section (New) -->
            <div id="submissionSection">
                <h2 class="section-title">Homework Submissions</h2>
                <!-- Content will be rendered based on user role -->
            </div>


            <!-- Student Management Section -->
            <div id="studentManagementSection">
                <h2 class="section-title">Student Dashboard</h2>
                <p id="studentManagementLoading" class="loading-indicator"></p>
                <div id="authorizedStudentsList">
                    <!-- Student cards will be injected here by JS -->
                </div>
            </div>

            <!-- Generic Material Section Template -->
            <div id="tutorialSection"></div>
            <div id="pastPapersSection"></div>
            <div id="exerciseSection"></div>
            
            <!-- Profile Section -->
            <div id="profileSection">
                <h2 class="section-title">Edit Your Profile</h2>
                <form id="profileForm" class="form-container">
                    <div style="margin-bottom: 1rem;">
                        <label for="profileName">Display Name</label>
                        <input type="text" id="profileName" name="name" required>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileAge">Age</label>
                        <input type="number" id="profileAge" name="age">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileGrade">Year/Grade</label>
                        <input type="text" id="profileGrade" name="grade">
                    </div>
                     <div style="margin-bottom: 1rem;">
                        <label for="profileSchool">School</label>
                        <input type="text" id="profileSchool" name="school">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="profileElectives">Elective Subjects</label>
                        <textarea id="profileElectives" name="electives" placeholder="e.g., Physics, Computer Science, Art"></textarea>
                    </div>
                    <button type="submit" id="saveProfileButton" class="btn-primary">Save Profile</button>
                </form>
            </div>

            <!-- Finder Style Materials Section (Desktop Only) -->
            <div id="finderMaterialsSection" class="finder-window-wrapper">
                <div class="finder-titlebar" id="finderDragBar">
                    <div class="buttons">
                        <div class="finder-circle close"></div>
                        <div class="finder-circle min"></div>
                        <div class="finder-circle max" id="finderFullscreenToggle"></div>
                    </div>
                    <span style="margin-left: 10px; font-weight: bold;">Materials</span>
                </div>

                <div class="finder-content">
                    <aside class="finder-sidebar" id="finderSidebar">
                        <!-- Level 1 items (Subjects) will be loaded here -->
                    </aside>
                    <section class="finder-file-list">
                        <div class="columns">
                            <div>Name</div><div>Size</div><div>Kind</div><div>Date Added</div>
                        </div>
                        <div id="finderFileListContent">
                            <p style="text-align:center; padding:20px; color:var(--finder-text-secondary);">Select a subject from the sidebar.</p>
                        </div>
                    </section>
                </div>

                <div class="finder-footer">Contact: darren_0625@mc-zero.com | © 2025 Darren Ng</div>
            </div>

        </main>
    </div>

    <!-- Minimized Windows Bar -->
    <div id="minimizedWindowsBar">
        <!-- Minimized tabs will be appended here -->
    </div>

    <footer>
        <a href="mailto:darren_0625@mc-zero.com">Contact: darren_0625@mc-zero.com</a> | Copyright © 2025 Operated by Darren Ng
    </footer>

    <!-- Universal Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle"></h3>
            <div id="modalMessage"></div>
            <div id="modalButtons"></div>
        </div>
    </div>
    
    <!-- Modals for adding content -->
    <div id="addVideoModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3>Add New Tutorial Video</h3>
             <form id="addVideoForm">
                <input type="hidden" id="videoParentId1">
                <input type="hidden" id="videoParentId2">
                 <div style="margin-bottom: 1rem;">
                     <label for="tutorialLink">YouTube Link or Embed Code</label>
                     <textarea id="tutorialLink" required placeholder="Paste a YouTube URL or an <iframe> embed code here..."></textarea>
                     <img id="tutorialThumbnailPreview" style="max-width:200px; margin-top:10px; border-radius:8px; display:none;" alt="Video Thumbnail Preview"/>
                 </div>
                 <div style="margin-bottom: 1rem;">
                     <label for="tutorialTitle">Video Title</label>
                     <input type="text" id="tutorialTitle" required>
                 </div>
                 <div class="modal-form-buttons">
                    <button type="submit" class="btn-primary">Add Video</button>
                 </div>
             </form>
        </div>
    </div>

    <div id="addPastPaperModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3>Add New Past Paper</h3>
             <form id="addPastPaperForm">
                <input type="hidden" id="paperParentId1">
                <input type="hidden" id="paperParentId2">
                 <div style="margin-bottom: 1rem;">
                     <label for="pastPaperName">Paper Name / Title</label>
                     <input type="text" id="pastPaperName" required placeholder="e.g., Paper 1 Section A">
                 </div>
                 <div style="margin-bottom: 1rem;">
                    <label>Upload File (PDF only)</label>
                    <div id="pastPaperDropZone" class="drop-zone">
                        <span>Drag & Drop PDF Here or click to select</span>
                        <input type="file" id="pastPaperFile" accept="application/pdf" hidden>
                    </div>
                    <span id="pastPaperFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                </div>
                <p style="text-align:center; margin-bottom: 1rem; color: var(--text-secondary);">OR</p>
                <div style="margin-bottom: 1rem;">
                    <label for="pastPaperLink">Paste External Link (for large files)</label>
                    <input type="url" id="pastPaperLink" placeholder="https://example.com/document.pdf">
                </div>
                 <div class="modal-form-buttons">
                    <button type="submit" class="btn-primary">Add Paper</button>
                 </div>
             </form>
        </div>
    </div>

    <!-- New Modal for Editing Past Papers -->
    <div id="editPastPaperModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Edit Past Paper</h3>
            <form id="editPastPaperForm">
                <input type="hidden" id="editPaperId">
                <input type="hidden" id="editPaperParentId1">
                <input type="hidden" id="editPaperParentId2">
                <div style="margin-bottom: 1rem;">
                    <label for="editPastPaperName">Paper Name / Title</label>
                    <input type="text" id="editPastPaperName" required>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="editPastPaperLink">Download Link</label>
                    <input type="url" id="editPastPaperLink" required>
                </div>
                <div class="modal-form-buttons">
                    <button type="submit" class="btn-primary">Save Changes</button>
                    <button type="button" class="logout-btn" onclick="document.getElementById('editPastPaperModal').style.display = 'none';">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addExerciseModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3>Add New Exercise</h3>
             <form id="addExerciseForm">
                <input type="hidden" id="exerciseParentId1">
                <input type="hidden" id="exerciseParentId2">
                 <div style="margin-bottom: 1rem;">
                     <label for="exerciseName">Exercise Name / Title</label>
                     <input type="text" id="exerciseName" required placeholder="e.g., Chapter 1 MCQs">
                 </div>
                 <div style="margin-bottom: 1rem;">
                     <label for="exercisePrice">Price (USD)</label>
                     <input type="number" id="exercisePrice" required placeholder="e.g., 10.00" step="0.01" min="0">
                 </div>
                 <div style="margin-bottom: 1rem;">
                    <label>Upload File (PDF only)</label>
                    <div id="exerciseDropZone" class="drop-zone">
                        <span>Drag & Drop PDF Here or click to select</span>
                        <input type="file" id="exerciseFile" accept="application/pdf" hidden>
                    </div>
                    <span id="exerciseFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                </div>
                <p style="text-align:center; margin-bottom: 1rem; color: var(--text-secondary);">OR</p>
                <div style="margin-bottom: 1rem;">
                    <label for="exerciseLink">Paste External Link (for large files)</label>
                    <input type="url" id="exerciseLink" placeholder="https://example.com/document.pdf">
                </div>
                 <div class="modal-form-buttons">
                    <button type="submit" class="btn-primary">Add Exercise</button>
                 </div>
             </form>
        </div>
    </div>

    <!-- Video Preview Modal -->
    <div id="videoPreviewModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="videoPreviewTitle"></h3>
            <div id="videoPreviewContent"></div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="pdfPreviewTitle"></h3>
            <div id="pdfCanvasContainer">
                <canvas id="pdfCanvas"></canvas>
            </div>
            <div id="pdfControls">
                <button id="prevPdfPage">Previous</button>
                <span id="pdfPageNum"></span> / <span id="pdfTotalPages"></span>
                <button id="nextPdfPage">Next</button>
            </div>
        </div>
    </div>

    <!-- New Assignment Modal -->
    <div id="addAssignmentModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Create New Assignment</h3>
            <form id="addAssignmentForm">
                <div style="margin-bottom: 1rem;">
                    <label for="assignmentSubject">Subject</label>
                    <input type="text" id="assignmentSubject" required placeholder="e.g., Mathematics, English">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="assignmentTitle">Assignment Title</label>
                    <input type="text" id="assignmentTitle" required placeholder="e.g., Chapter 3 Homework, Essay Outline">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="assignmentDescription">Description (Optional)</label>
                    <textarea id="assignmentDescription" placeholder="Provide instructions or details for the assignment..."></textarea>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="assignmentDueDate">Due Date (Optional)</label>
                    <input type="date" id="assignmentDueDate">
                </div>
                <div class="modal-form-buttons">
                    <button type="submit" class="btn-primary">Create Assignment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Submission Modal -->
    <div id="viewSubmissionModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="viewSubmissionTitle">Submission Details</h3>
            <div id="submissionDetailsContent">
                <!-- Submission file/text preview will be loaded here -->
            </div>
             <div id="submissionDownloadLink" style="margin-top: 1rem; text-align: center; display: none;">
                <a id="submissionFileDownloadBtn" class="btn-primary" download target="_blank">Download File</a>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, where, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";

        // --- IMPORTANT CONFIGURATION ---
        // TODO: PASTE YOUR STRIPE PAYMENT LINK HERE
        // Create a product in Stripe with a price, then create a payment link for it.
        const STRIPE_PAYMENT_LINK = "https://buy.stripe.com/14A28t1kAfr2gnx04L0ZW0n"; 

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
          authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30",
          storageBucket: "ai-grading-9bb30.appspot.com", // Corrected storage bucket URL
          messagingSenderId: "298162112230",
          appId: "1:298162112230:web:529d3f95536991be685d27",
          measurementId: "G-CHKLKSM17S"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const CLOUDFLARE_WORKER_URL = "https://ai-marker-gemini-proxy.darren-xie11.workers.dev/";
        // Placeholder for DeepSeek API Cloudflare Worker URL
        // IMPORTANT: Replace this with your actual Cloudflare Worker URL that proxies to DeepSeek API
        const DEEPSEEK_WORKER_URL = "https://your-deepseek-proxy-worker.yourdomain.workers.dev/"; 
        const TEACHER_CODE = "Derren0625";
        const STUDENT_CODE = "STUDENT456";

        pdfjsLib.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let app, db, auth, storage;
        let currentUserId = null, currentUserEmail = null, currentUserRole = null, currentUserName = null;
        // Initialize chat history for Gemini API - will be loaded from Firestore
        let geminiChatHistory = []; 
        let shoppingCart = [];
        let appliedPromoCode = null; // New variable to store applied promo code details
        let currentAiSource = 'gemini-api'; // Default AI source for chat

        // --- AUTH & INITIALIZATION ---
        
        const authWrapper = document.getElementById('authWrapper');
        const appSection = document.getElementById('appSection');
        const authContainer = document.getElementById('authContainer');

        const googleSignInTemplate = `
            <h2>Sign In</h2>
            <button id="googleSignInButton" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
                <span>Sign in with Google</span>
            </button>
            <p id="authError" class="error-message"></p>
        `;

        const codeEntryTemplate = `
            <h2>Enter Access Code</h2>
            <p style="color: var(--text-secondary); text-align: center; margin-bottom: 1rem;">Please enter the access code provided by your administrator.</p>
            <input type="text" id="accessCodeInput" placeholder="Enter code here">
            <button id="submitCodeButton" class="btn-primary" style="width:100%">Submit Code</button>
            <p id="codeError" class="error-message"></p>
        `;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showModal('Firebase Configuration Error', `Failed to initialize Firebase. Error: ${error.message}`);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                currentUserEmail = user.email;
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                try {
                    const userProfileDoc = await getDoc(userProfileRef);
                    if (userProfileDoc.exists() && userProfileDoc.data().role) {
                        const profileData = userProfileDoc.data();
                        currentUserRole = profileData.role;
                        currentUserName = profileData.name || user.displayName;
                        await setDoc(userProfileRef, { name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                        showApp();
                    } else {
                        currentUserName = user.displayName;
                        currentUserRole = 'unassigned';
                        showCodeEntry();
                    }
                } catch (e) {
                     console.error("Error checking user profile:", e);
                     showModal('Profile Error', `Could not load user profile. Error: ${e.message}`);
                     showLogin();
                }
            } else {
                currentUserId = null;
                currentUserRole = null;
                currentUserName = null;
                showLogin();
            }
        });

        function showLogin() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authWrapper.style.opacity = '1';
            authContainer.innerHTML = googleSignInTemplate;
            document.getElementById('googleSignInButton')?.addEventListener('click', handleGoogleSignIn);
        }

        function showCodeEntry() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            authWrapper.style.opacity = '1';
            authContainer.innerHTML = codeEntryTemplate;
            const submitCodeBtn = document.getElementById('submitCodeButton');
            const accessCodeInput = document.getElementById('accessCodeInput');
            submitCodeBtn?.addEventListener('click', () => handleSubmitCode());
            accessCodeInput?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSubmitCode();
                }
            });
            accessCodeInput?.focus();
        }

        async function showApp() {
            authWrapper.style.display = 'none';
            appSection.style.display = 'flex';
            document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
            document.getElementById('manageStudentsButton').style.display = currentUserRole === 'teacher' ? 'block' : 'none';
            document.getElementById('toggleSubmissionsButton').style.display = 'block'; // Always show submissions button

            initializeAllMaterialSections();
            await checkForSuccessfulPurchase();

            showSection('homeSection');
            loadPastSubmissions();
            if(currentUserRole === 'teacher') {
                loadAuthorizedStudents();
            }

            document.getElementById('homeTutorialLink')?.addEventListener('click', (e) => { e.preventDefault(); showSection('tutorialSection'); });
            document.getElementById('homeGraderLink')?.addEventListener('click', (e) => { e.preventDefault(); showSection('gradingSection'); });
            document.getElementById('homeChatLink')?.addEventListener('click', (e) => { e.preventDefault(); showSection('chatSection'); });
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try { 
                await signInWithPopup(auth, provider); 
            } catch (error) { 
                document.getElementById('authError').textContent = `Sign-in failed. Error: ${error.message}`; 
                console.error("Google Sign-In Error:", error);
            }
        }

        async function handleSubmitCode(codeValue) {
            const code = (codeValue || document.getElementById('accessCodeInput').value).trim();
            const codeError = document.getElementById('codeError');
            if(codeError) codeError.textContent = '';
            
            let roleToSet = null;
            if (code === TEACHER_CODE) roleToSet = 'teacher';
            else if (code === STUDENT_CODE) roleToSet = 'student';
            else { 
                if(codeError) codeError.textContent = 'Invalid access code.';
                return; 
            }
            
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                await setDoc(userProfileRef, { role: roleToSet, name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                currentUserRole = roleToSet;
                showModal('Success!', `Your role has been set to ${roleToSet}.`);
                showApp();
            } catch (error) {
                if(codeError) codeError.textContent = `Could not set role. Error: ${e.message}`;
                console.error("Submit Code Error:", error);
            }
        }

        document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));

        document.getElementById('switchRoleButton').addEventListener('click', () => {
            showInputModal('Switch Role', 'Enter new access code (Teacher or Student):', async (code) => {
                await handleSubmitCode(code);
            });
        });

        // --- NAVIGATION & UI ---

        let currentMaterialViewMode = 'card'; // 'card' or 'finder'

        function showSection(sectionIdToShow) {
            const sections = ['homeSection', 'gradingSection', 'chatSection', 'studentManagementSection', 'profileSection', 'tutorialSection', 'pastPapersSection', 'exerciseSection', 'submissionSection'];
            const buttons = {
                toggleHomeButton: 'homeSection',
                workWithAIButton: ['gradingSection', 'chatSection'],
                materialsButton: ['tutorialSection', 'pastPapersSection', 'exerciseSection'],
                toggleSubmissionsButton: 'submissionSection', // New submission button
                manageStudentsButton: 'studentManagementSection',
                toggleProfileButton: 'profileSection'
            };
            
            document.querySelectorAll('.header-actions .tab').forEach(t => t.classList.remove('active'));

            let activeButtonId = null;
            for (const [btnId, secId] of Object.entries(buttons)) {
                if (Array.isArray(secId) && secId.includes(sectionIdToShow)) {
                    activeButtonId = btnId;
                    break;
                }
                if (secId === sectionIdToShow) {
                    activeButtonId = btnId;
                    break;
                }
            }
            if (activeButtonId) {
                document.getElementById(activeButtonId)?.classList.add('active');
            }

            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    const isTarget = id === sectionIdToShow;
                    // Adjusted display type for various sections
                    section.style.display = isTarget ? (['chatSection', 'studentManagementSection', 'submissionSection'].includes(id) ? 'flex' : 'block') : 'none';
                    setTimeout(() => section.style.opacity = isTarget ? '1' : '0', 10);
                }
            });

            // Handle visibility of finder window based on section and screen size
            const finderSection = document.getElementById('finderMaterialsSection');
            const isMaterialSection = ['tutorialSection', 'pastPapersSection', 'exerciseSection'].includes(sectionIdToShow);
            
            if (isMaterialSection && window.innerWidth >= 769) { // Desktop
                finderSection.style.display = currentMaterialViewMode === 'finder' ? 'flex' : 'none';
                // Hide card view if finder is active
                document.getElementById(sectionIdToShow).classList.toggle('hidden-on-desktop', currentMaterialViewMode === 'finder');
            } else { // Mobile or non-material section
                finderSection.style.display = 'none';
                document.getElementById(sectionIdToShow).classList.remove('hidden-on-desktop');
            }


            if (sectionIdToShow === 'profileSection') loadProfileData();
            if (sectionIdToShow === 'exerciseSection' && currentUserRole === 'teacher') {
                loadPromoCodesForTeacher();
            }
            if (sectionIdToShow === 'chatSection') {
                loadChatHistory(); // Load chat history when chat section is shown
            }
            if (sectionIdToShow === 'studentManagementSection' && currentUserRole === 'teacher') {
                loadAuthorizedStudents();
            }
            if (sectionIdToShow === 'submissionSection') { // New: Handle submissions section
                renderSubmissionSection();
            }
        }

        function setupSectionToggle() {
            document.getElementById('toggleHomeButton')?.addEventListener('click', () => showSection('homeSection'));
            document.getElementById('toggleGradingButton')?.addEventListener('click', () => showSection('gradingSection'));
            document.getElementById('toggleChatButton')?.addEventListener('click', () => showSection('chatSection'));
            document.getElementById('manageStudentsButton')?.addEventListener('click', () => showSection('studentManagementSection'));
            document.getElementById('toggleProfileButton')?.addEventListener('click', () => showSection('profileSection'));
            document.getElementById('toggleSubmissionsButton')?.addEventListener('click', () => showSection('submissionSection')); // New event listener
            
            // Materials dropdown buttons
            document.getElementById('toggleTutorialButton')?.addEventListener('click', () => {
                showSection('tutorialSection');
                if (window.innerWidth >= 769) { // On desktop, default to finder view if it's active
                    if (currentMaterialViewMode === 'finder') showFinderView('tutorials');
                    else renderStudentItems('tutorials'); // Re-render card view if that's active
                } else {
                    renderStudentItems('tutorials'); // Always card view on mobile
                }
            });
            document.getElementById('togglePastPapersButton')?.addEventListener('click', () => {
                showSection('pastPapersSection');
                if (window.innerWidth >= 769) {
                    if (currentMaterialViewMode === 'finder') showFinderView('pastPapers');
                    else renderStudentItems('pastPapers');
                } else {
                    renderStudentItems('pastPapers');
                }
            });
            document.getElementById('toggleExercisesButton')?.addEventListener('click', () => {
                showSection('exerciseSection');
                if (window.innerWidth >= 769) {
                    if (currentMaterialViewMode === 'finder') showFinderView('exercises');
                    else renderStudentItems('exercises');
                } else {
                    renderStudentItems('exercises');
                }
            });
            
            document.getElementById('userDisplayName')?.addEventListener('click', () => showSection('profileSection'));
        }
        setupSectionToggle();
        
        // --- PROFILE MANAGEMENT ---

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) { showModal('Error', 'You must be logged in to save your profile.'); return; }
            
            const formData = new FormData(e.target);
            const profileData = Object.fromEntries(formData.entries());
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            try {
                await setDoc(userProfileRef, profileData, { merge: true });
                currentUserName = profileData.name;
                document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
                showModal('Success', 'Your profile has been updated!');
            } catch (error) {
                console.error("Error saving profile:", error);
                showModal('Error', `Could not save profile: ${error.message}`);
            }
        });

        async function loadProfileData() {
            if (!currentUserId) return;
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            const docSnap = await getDoc(userProfileRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('profileName').value = data.name || '';
                document.getElementById('profileAge').value = data.age || '';
                document.getElementById('profileGrade').value = data.grade || '';
                document.getElementById('profileSchool').value = data.school || '';
                document.getElementById('profileElectives').value = data.electives || '';
            }
        }
        
        // --- REFACTORED MATERIALS MANAGEMENT ---

        const materialsConfig = {
            tutorials: {
                sectionId: 'tutorialSection',
                collectionName: 'tutorials',
                title: 'Tutorial Videos',
                level1: 'Subject',
                level2: 'Topic',
                level3: 'Video',
                modalId: 'addVideoModal',
                isPaid: false
            },
            pastPapers: {
                sectionId: 'pastPapersSection',
                collectionName: 'pastPapers',
                title: 'Past Papers',
                level1: 'Subject',
                level2: 'Year',
                level3: 'Paper',
                modalId: 'addPastPaperModal',
                editModalId: 'editPastPaperModal', // New: Add edit modal ID
                isPaid: false
            },
            exercises: {
                sectionId: 'exerciseSection',
                collectionName: 'exercises',
                title: 'Exercises for Sale',
                level1: 'Subject',
                level2: 'Topic',
                level3: 'Exercise',
                modalId: 'addExerciseModal',
                isPaid: true
            },
            assignments: { // New materials config for assignments
                collectionName: 'assignments',
                title: 'Homework Assignments',
                level1: 'Subject',
                level2: 'Assignment',
                modalId: 'addAssignmentModal',
                isPaid: false // Assignments are not for sale
            }
        };

        function getPath(type, ids = []) {
            const config = materialsConfig[type];
            const collection = config.collectionName;
            let pathParts = [];

            if (type === 'assignments') {
                // Assignments are structured as: artifacts/{appId}/public/data/assignments/{subjectId}/assignments/{assignmentId}
                pathParts = [`artifacts/${appId}/public/data/assignments`];
                if (ids[0]) pathParts.push(ids[0], 'assignments'); // Subject ID
                if (ids[1]) pathParts.push(ids[1]); // Assignment ID
            } else {
                // Existing structure for tutorials, pastPapers, exercises
                pathParts = [`artifacts/${appId}/public/data/${collection}`];
                if (ids[0]) pathParts.push(ids[0], config.level2.toLowerCase() + 's');
                if (ids[1]) pathParts.push(ids[1], config.level3.toLowerCase() + 's');
            }
            return pathParts.join('/');
        }

        function initializeAllMaterialSections() {
            for (const type in materialsConfig) {
                // Skip 'assignments' as it's handled by renderSubmissionSection()
                if (type === 'assignments') continue; 
                setupMaterialSection(type);
            }
            // Add delegated event listener for YouTube thumbnails
            document.getElementById('tutorialSection').addEventListener('click', (e) => {
                const thumbnail = e.target.closest('.material-card-thumbnail[data-youtube-id]');
                if (thumbnail) {
                    e.preventDefault();
                    const videoId = thumbnail.dataset.youtubeId;
                    const embedContainer = document.createElement('div');
                    embedContainer.className = 'video-embed-container';
                    embedContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-in-picture" allowfullscreen></iframe>`;
                    thumbnail.replaceWith(embedContainer);
                }
            });

            // Setup the Finder window's drag/resize/fullscreen
            setupFinderWindow();

            // Setup Google Drive link conversion for relevant inputs
            setupGoogleDriveLinkConversion();
        }

        function setupMaterialSection(type) {
            const config = materialsConfig[type];
            const section = document.getElementById(config.sectionId);

            let studentViewHtml = `
                <div class="filters-container">
                    <select id="level1-${type}-filter" style="width:250px;"><option value="">-- Select ${config.level1} --</option></select>
                    <select id="level2-${type}-filter" style="width:250px;" disabled><option value="">-- Select ${config.level2} --</option></select>
                </div>
                <div id="level3-${type}-grid" class="grid-container"></div>`;

            if (config.isPaid) {
                studentViewHtml = `
                    <div class="store-layout">
                        <div class="product-grid">
                            ${studentViewHtml}
                        </div>
                        <div class="shopping-cart">
                            <h3>Shopping Cart</h3>
                            <div id="cart-items"></div>
                            <div id="cart-summary">
                                <div class="summary-line">
                                    <span>Subtotal:</span>
                                    <span id="cart-subtotal-price">$0.00</span>
                                </div>
                                <div class="summary-line" id="promo-discount-line" style="display:none;">
                                    <span>Promo Discount:</span>
                                    <span id="cart-promo-discount">-$0.00</span>
                                </div>
                                <div class="summary-line">
                                    <span>Total Price:</span>
                                    <span id="cart-total-price">$0.00</span>
                                </div>
                            </div>
                            <div class="promo-code-section">
                                <label for="promoCodeInput">Promo Code:</label>
                                <div class="promo-input-group">
                                    <input type="text" id="promoCodeInput" placeholder="Enter promo code">
                                    <button id="applyPromoCodeBtn" class="btn-primary">Apply</button>
                                </div>
                                <div id="appliedPromoCodeDisplay" class="promo-display" style="display:none;">
                                    <span>Applied: <span id="appliedPromoCodeText"></span></span>
                                    <button id="removePromoCodeBtn" class="remove-promo-btn">Remove</button>
                                </div>
                                <p id="promoCodeError" class="promo-error"></p>
                            </div>
                            <div id="cart-validation-message"></div>
                            <button id="checkout-btn" class="btn-primary" disabled>Proceed to Checkout</button>
                        </div>
                    </div>`;
            }

            section.innerHTML = `
                <h2 class="section-title">${config.title}</h2>
                <div id="teacher-${type}-view" style="display:none;">
                    <div class="form-container" style="max-width: initial;">
                        <button id="add-level1-${type}-btn" class="btn-primary">Add New ${config.level1}</button>
                        <button id="toggle-view-mode-${type}" class="material-view-toggle">Switch View Mode</button>
                        <p id="view-mode-status-${type}" style="display:inline-block; margin-left:1rem; color:var(--text-secondary);"></p>
                    </div>
                    <div id="level1-${type}-container" class="folder-view"></div>
                    <div id="board-view-${type}" style="display:none; padding:1rem; border:1px dashed var(--border-color); min-height:300px; text-align:center; color:var(--text-secondary);">
                        Board View (Future Feature)
                        <p>This will be an interactive tree diagram or board where you can freely move files.</p>
                    </div>
                    ${type === 'exercises' ? `
                        <div class="form-container" style="max-width: initial; margin-top: 2rem;">
                            <h3>Promo Code Management</h3>
                            <div style="margin-bottom: 1rem;">
                                <label for="promoDiscountAmount">Discount Amount ($)</label>
                                <input type="number" id="promoDiscountAmount" placeholder="e.g., 10.00" step="0.01" min="0">
                            </div>
                            <button id="generatePromoCodeBtn" class="btn-primary">Generate New Promo Code</button>
                            <p id="promoCodeGenerationStatus" class="loading-indicator"></p>
                            <div class="promo-code-list" id="teacherPromoCodeList">
                                <p>No promo codes generated yet.</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
                <div id="student-${type}-view" style="display:none;">
                    ${studentViewHtml}
                </div>`;

            const isTeacher = currentUserRole === 'teacher';
            document.getElementById(`teacher-${type}-view`).style.display = isTeacher ? 'block' : 'none';
            document.getElementById(`student-${type}-view`).style.display = isTeacher ? 'none' : 'block';

            if (isTeacher) {
                renderContent(type, `level1-${type}-container`, 1);
                document.getElementById(`add-level1-${type}-btn`).onclick = () => showAddItemModal(type, 1);
                document.getElementById(`level1-${type}-container`).addEventListener('click', (e) => handleTeacherClick(e, type));
                
                // Add drag-and-drop event listeners to the main container for the teacher view
                const teacherViewContainer = document.getElementById(`teacher-${type}-view`);
                teacherViewContainer.addEventListener('dragover', (e) => handleDragOver(e, type));
                teacherViewContainer.addEventListener('drop', (e) => handleDrop(e, type));
                teacherViewContainer.addEventListener('dragleave', (e) => handleDragLeave(e, type));


                const toggleViewBtn = document.getElementById(`toggle-view-mode-${type}`);
                const folderView = document.getElementById(`level1-${type}-container`);
                const boardView = document.getElementById(`board-view-${type}`);
                const viewStatus = document.getElementById(`view-mode-status-${type}`);
                
                let currentTeacherMaterialViewMode = 'folder'; // 'folder' or 'board'

                const updateViewDisplay = () => {
                    if (currentTeacherMaterialViewMode === 'folder') {
                        folderView.style.display = 'block';
                        boardView.style.display = 'none';
                        viewStatus.textContent = '(Current: Folder View)';
                    } else {
                        folderView.style.display = 'none';
                        boardView.style.display = 'block';
                        viewStatus.textContent = '(Current: Board View)';
                    }
                };

                toggleViewBtn.onclick = () => {
                    currentTeacherMaterialViewMode = currentTeacherMaterialViewMode === 'folder' ? 'board' : 'folder';
                    updateViewDisplay();
                };
                updateViewDisplay(); // Set initial display

                if (type === 'exercises') {
                    document.getElementById('generatePromoCodeBtn').addEventListener('click', generateAndSavePromoCode);
                    // Initial load of promo codes for teacher
                    loadPromoCodesForTeacher();
                }
            } else { // Student view
                setupStudentFilters(type);
                if(config.isPaid) {
                    document.getElementById('checkout-btn').addEventListener('click', handleCheckout);
                    document.getElementById('applyPromoCodeBtn').addEventListener('click', applyPromoCode);
                    document.getElementById('removePromoCodeBtn').addEventListener('click', removeAppliedPromoCode);
                }

                // Add toggle for student view (desktop only)
                if (window.innerWidth >= 769) {
                    const studentViewContainer = document.getElementById(`student-${type}-view`);
                    const materialsSectionTitle = section.querySelector('.section-title');
                    const toggleButton = document.createElement('button');
                    toggleButton.className = 'material-view-toggle btn-primary'; /* Added btn-primary for consistent styling */
                    toggleButton.textContent = 'Switch to Finder View';
                    materialsSectionTitle.after(toggleButton); // Append next to title

                    toggleButton.addEventListener('click', () => {
                        if (currentMaterialViewMode === 'card') {
                            currentMaterialViewMode = 'finder';
                            studentViewContainer.classList.add('hidden-on-desktop');
                            showFinderView(type);
                            toggleButton.textContent = 'Switch to Card View';
                        } else {
                            currentMaterialViewMode = 'card';
                            studentViewContainer.classList.remove('hidden-on-desktop');
                            document.getElementById('finderMaterialsSection').style.display = 'none';
                            toggleButton.textContent = 'Switch to Finder View';
                            renderStudentItems(type); // Re-render the card view to ensure it's up-to-date
                        }
                    });
                }
            }
        }
        
        async function renderContent(type, containerId, level, parentIds = []) {
            const container = document.getElementById(containerId);
            const config = materialsConfig[type];
            const levelName = config[`level${level}`];
            container.innerHTML = `<p class="loading-indicator">Loading ${levelName.toLowerCase()}s...</p>`;

            const collectionRef = collection(db, getPath(type, parentIds));
            // IMPORTANT: For 'orderBy' to work on 'name' in subcollections, you need to create a Collection Group Index in Firestore.
            // Go to Firebase Console -> Firestore Database -> Indexes tab.
            // Create a new index with:
            // Collection ID: (e.g., 'tutorials', 'pastPapers', 'exercises') - you'll need one for each top-level collection name
            // Fields: name (Ascending)
            // Query Scope: Collection Group
            const q = query(collectionRef, orderBy('name', levelName === 'Year' ? 'desc' : 'asc'));
            
            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = `<p>No ${levelName.toLowerCase()}s added yet.</p>`;
                    return;
                }
                
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = doc.data();
                    item.id = doc.id; // Ensure item ID is available for preview/delete
                    const el = document.createElement('div');
                    el.className = level < 3 ? 'content-item' : 'sub-item';

                    let headerHtml;
                    if (level < 3) {
                        const nextLevel = level + 1;
                        const newParentIds = [...parentIds, doc.id];
                        // Add aria-expanded for accessibility and CSS targeting
                        headerHtml = `
                            <div class="content-header" data-level="${level}" data-id="${doc.id}" data-parent-ids='${JSON.stringify(parentIds)}' aria-expanded="false">
                                <${level === 1 ? 'h3' : 'h4'}>${item.name} <span class="collapse-arrow"></span></${level === 1 ? 'h3' : 'h4'}>
                                <div class="item-actions">
                                    <button class="add-item-btn btn-primary" data-level="${nextLevel}" data-parent-ids='${JSON.stringify(newParentIds)}'>Add ${config[`level${nextLevel}`]}</button>
                                    <button class="delete-item-btn logout-btn" data-level="${level}" data-id="${doc.id}" data-parent-ids='${JSON.stringify(parentIds)}'>Delete</button>
                                </div>
                            </div>
                            <div class="nested-container" id="container-level${nextLevel}-${type}-${doc.id}"></div>
                        `;
                    } else { // Level 3 - Final item
                        let itemName = item.name || item.title;
                        let itemPrice = config.isPaid ? ` - $${item.price.toFixed(2)}` : '';
                        headerHtml = `<span>${itemName}${itemPrice}</span>
                                     <div class="item-actions">
                                        ${type === 'pastPapers' ? `<button class="edit-item-btn btn-primary" data-type="${type}" data-item='${JSON.stringify(item)}' data-parent-ids='${JSON.stringify(parentIds)}'>Edit</button>` : ''}
                                        <button class="preview-item-btn btn-primary" data-type="${type}" data-item='${JSON.stringify(item)}'>Preview</button>
                                        <a href="${item.link}" download="${itemName}.pdf" class="download-item-btn btn-primary" style="margin-left: 0.5rem;">Download</a>
                                        <button class="delete-item-btn logout-btn" data-level="${level}" data-id="${doc.id}" data-parent-ids='${JSON.stringify(parentIds)}'>Delete</button>
                                     </div>`;
                        // Add draggable attributes and event listeners for level 3 items
                        el.setAttribute('draggable', 'true');
                        el.dataset.itemId = doc.id;
                        el.dataset.itemType = type;
                        el.dataset.itemParentIds = JSON.stringify(parentIds);
                        el.addEventListener('dragstart', handleDragStart);
                    }
                    el.innerHTML = headerHtml;
                    container.appendChild(el);
                });
            } catch (error) {
                console.error(`Error rendering level ${level} for ${type}:`, error);
                container.innerHTML = `<p class="error-message">Error loading content. A database index might be required. Check console for details.</p>`;
            }
        }
        
        async function handleTeacherClick(e, type) {
            const header = e.target.closest('.content-header');
            const button = e.target.closest('button');

            if (button) {
                e.stopPropagation();
                const { level, parentIds } = button.dataset;
                const parentIdsArray = parentIds ? JSON.parse(parentIds) : [];

                if (button.matches('.add-item-btn')) {
                    const nextLevel = parseInt(level);
                    if (nextLevel < 3) {
                        showAddItemModal(type, nextLevel, parentIdsArray);
                    } else { 
                        showAddFinalItemModal(type, parentIdsArray);
                    }
                } else if (button.matches('.delete-item-btn')) {
                    const idToDelete = button.dataset.id;
                    handleDeleteItem(type, parseInt(level), idToDelete, parentIdsArray);
                } else if (button.matches('.preview-item-btn')) {
                    const itemData = JSON.parse(button.dataset.item);
                    handlePreview(type, itemData); // Use the unified preview function
                } else if (button.matches('.edit-item-btn')) { // New: Handle edit button click
                    const itemData = JSON.parse(button.dataset.item);
                    const itemParentIds = JSON.parse(button.dataset.parentIds);
                    showEditPastPaperModal(itemData, itemParentIds);
                }
            } else if (header) {
                const { level, id, parentIds } = header.dataset;
                const currentLevel = parseInt(level);
                if (currentLevel >= 3) return; 
                
                const nextLevel = currentLevel + 1;
                const container = document.getElementById(`container-level${nextLevel}-${type}-${id}`);
                if (!container) return;

                const isExpanded = header.getAttribute('aria-expanded') === 'true';
                header.setAttribute('aria-expanded', !isExpanded);
                container.classList.toggle('expanded', !isExpanded);

                if (!isExpanded && !container.dataset.loaded) {
                    const parentIdsArray = parentIds ? JSON.parse(parentIds) : [];
                    await renderContent(type, container.id, nextLevel, [...parentIdsArray, id]);
                    container.dataset.loaded = 'true';
                }
            }
        }

        // Unified preview function for both teacher and student
        function handlePreview(type, item) {
            if (type === 'tutorials') {
                const videoPreviewModal = document.getElementById('videoPreviewModal');
                const videoPreviewTitle = document.getElementById('videoPreviewTitle');
                const videoPreviewContent = document.getElementById('videoPreviewContent');
                
                videoPreviewTitle.textContent = item.title;
                if (item.type === 'youtube') {
                    videoPreviewContent.innerHTML = `<iframe src="https://www.youtube.com/embed/${item.youtubeId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-in-picture" allowfullscreen></iframe>`;
                } else if (item.type === 'embed') {
                    videoPreviewContent.innerHTML = item.embedCode;
                }
                videoPreviewModal.style.display = 'flex';
            } else if (type === 'pastPapers' || type === 'exercises' || type === 'submissionFile') {
                if (item.link) {
                    // Check if the link is a PDF
                    if (item.link.toLowerCase().endsWith('.pdf') || item.link.includes('drive.google.com/uc?export=download')) {
                        showPdfPreviewModal(item.name, item.link);
                    } else if (item.link.startsWith('data:image')) {
                         // Directly display base64 image if it's a submission file preview
                        showModal(item.name, `<img src="${item.link}" class="file-preview mx-auto" alt="Submission Preview">`);
                    } else if (item.link.match(/\.(jpeg|jpg|gif|png|webp)$/i)) { // Check for common image extensions
                        showModal(item.name, `<img src="${item.link}" class="file-preview mx-auto" alt="Submission Preview">`);
                    } else {
                        // For other links, open in a new tab
                        window.open(item.link, '_blank');
                    }
                } else {
                    showModal('Preview Error', 'No link available for this item.');
                }
            } else if (type === 'submissionText') {
                showModal(item.name, `<div style="white-space: pre-wrap; max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px;">${item.text}</div>`);
            }
        }


        function showAddItemModal(type, level, parentIds = []) {
            const config = materialsConfig[type];
            const levelName = config[`level${level}`];
            const prompt = levelName === 'Year' ? 'Year (e.g., 2024)' : levelName;
            
            showInputModal(`Add New ${levelName}`, `Enter ${prompt} Name:`, async (name) => {
                const collectionRef = collection(db, getPath(type, parentIds));
                try {
                    await addDoc(collectionRef, { name: name.trim() });
                    showModal('Success', `${levelName} added.`);
                    const containerId = level === 1 ? `level1-${type}-container` : `container-level${level}-${type}-${parentIds[parentIds.length - 1]}`;
                    renderContent(type, containerId, level, parentIds);
                } catch(e) {
                    console.error("Error adding item:", e);
                    showModal('Error', `Could not add ${levelName}. Error: ${e.message}`);
                }
            });
        }

        function showAddFinalItemModal(type, parentIds) {
            const config = materialsConfig[type];
            const modal = document.getElementById(config.modalId);
            modal.style.display = 'flex';
            
            const form = modal.querySelector('form');
            form.querySelector('input[type=hidden]:nth-of-type(1)').value = parentIds[0];
            form.querySelector('input[type=hidden]:nth-of-type(2)').value = parentIds[1];
            form.reset();

            // Also reset file input displays and previews
            if (type === 'pastPapers') {
                document.getElementById('pastPaperFileName').textContent = 'No file chosen';
                document.getElementById('pastPaperLink').value = '';
            }
            if (type === 'exercises') {
                document.getElementById('exerciseFileName').textContent = 'No file chosen';
                document.getElementById('exerciseLink').value = '';
            }
            if (type === 'tutorials') {
                document.getElementById('tutorialThumbnailPreview').style.display = 'none';
            }
        }

        async function handleDeleteItem(type, level, id, parentIds) {
            const config = materialsConfig[type];
            const levelName = config[`level${level}`];

            showModal('Confirm Deletion', `Are you sure you want to delete this ${levelName.toLowerCase()}? This will also delete all items inside it. This action cannot be undone.`, [
                { text: 'Delete', className: 'btn-primary', onClick: async () => {
                    const docRef = doc(db, getPath(type, parentIds), id);
                    try {
                        // For Level 3 items, check if a file needs to be deleted from storage
                        if (level === 3 && (type === 'pastPapers' || type === 'exercises')) {
                            const itemSnap = await getDoc(docRef);
                            const itemData = itemSnap.data();
                            if (itemData && itemData.link && !itemData.link.startsWith('https://drive.google.com')) {
                                // Assume it's a Firebase Storage URL if not Google Drive
                                const storagePath = ref(storage, itemData.link).fullPath;
                                const fileRef = ref(storage, storagePath);
                                try {
                                    await deleteObject(fileRef);
                                    console.log('File deleted from storage:', storagePath);
                                } catch (storageError) {
                                    console.warn('Could not delete file from storage (may not exist or external link):', storageError);
                                }
                            }
                        }

                        await deleteDoc(docRef); // Note: This doesn't delete subcollections. A proper solution requires a cloud function for recursive deletes.
                        showModal('Success', `${levelName} deleted.`);
                        const containerId = level === 1 ? `level1-${type}-container` : `container-level${level}-${type}-${parentIds[parentIds.length - 1]}`;
                        renderContent(type, containerId, level, parentIds);
                    } catch(e) {
                         console.error("Error deleting item:", e);
                         showModal('Error', `Could not delete ${levelName}. Error: ${e.message}`);
                    }
                }},
                { text: 'Cancel', className: 'logout-btn' }
            ]);
        }
        
        // --- DRAG AND DROP LOGIC (TEACHER SIDE) ---
        let draggedItem = null; // Stores data about the item being dragged

        function handleDragStart(e) {
            const subItem = e.target.closest('.sub-item');
            if (!subItem) return;

            draggedItem = {
                id: subItem.dataset.itemId,
                type: subItem.dataset.itemType,
                parentIds: JSON.parse(subItem.dataset.itemParentIds)
            };
            e.dataTransfer.setData('text/plain', JSON.stringify(draggedItem));
            e.dataTransfer.effectAllowed = 'move';
            subItem.classList.add('dragging'); // Optional: Add visual feedback for the dragged item
        }

        function handleDragOver(e, type) {
            e.preventDefault(); // Crucial to allow dropping
            const targetElement = e.target.closest('.content-item'); // Target is a folder (level 1 or 2)
            if (targetElement && draggedItem && draggedItem.type === type) { // Only allow dropping items of the same type
                targetElement.classList.add('drag-over');
                e.dataTransfer.dropEffect = 'move';
            } else {
                e.dataTransfer.dropEffect = 'none';
            }
        }

        function handleDragLeave(e, type) {
            const targetElement = e.target.closest('.content-item');
            if (targetElement) {
                targetElement.classList.remove('drag-over');
            }
        }

        async function handleDrop(e, type) {
            e.preventDefault();
            const targetElement = e.target.closest('.content-item');
            if (targetElement) {
                targetElement.classList.remove('drag-over');
            }

            if (!draggedItem) return; // No item being dragged

            const droppedItemData = JSON.parse(e.dataTransfer.getData('text/plain'));
            
            // Ensure the dropped item is of the same type as the section
            if (droppedItemData.type !== type) {
                showModal('Move Error', 'Cannot move items between different material types (e.g., tutorials to past papers).');
                draggedItem = null; // Reset dragged item
                return;
            }

            const newParentLevel = parseInt(targetElement.dataset.level);
            const newParentId = targetElement.dataset.id;
            const newParentIds = JSON.parse(targetElement.dataset.parentIds);

            // Determine the new full path for the item
            let newFullParentIds = [];
            if (newParentLevel === 1) { // Dropped into a Level 1 folder (Subject)
                newFullParentIds = [newParentId];
            } else if (newParentLevel === 2) { // Dropped into a Level 2 folder (Topic/Year)
                newFullParentIds = [...newParentIds, newParentId];
            } else {
                showModal('Move Error', 'Items can only be dropped into Subject or Topic/Year folders.');
                draggedItem = null;
                return;
            }

            // Prevent dropping into the same folder or an invalid folder structure (e.g., dropping a subject into a topic)
            if (newFullParentIds.length !== 2) { // Files (level 3) always have 2 parent IDs
                 showModal('Move Error', 'Files must be moved into a Topic or Year folder (which has a Subject parent).');
                 draggedItem = null;
                 return;
            }

            const oldParentIds = draggedItem.parentIds;
            const itemId = draggedItem.id;
            const itemType = draggedItem.type;

            // Check if the item is being dropped into its current parent folder
            if (oldParentIds[0] === newFullParentIds[0] && oldParentIds[1] === newFullParentIds[1]) {
                showModal('Move Info', 'Item is already in this folder.');
                draggedItem = null;
                return;
            }

            // Get a reference to the original document
            const oldDocRef = doc(db, getPath(itemType, oldParentIds), itemId);
            const newDocRef = doc(db, getPath(itemType, newFullParentIds), itemId);

            try {
                // Fetch the item's data
                const docSnap = await getDoc(oldDocRef);
                if (!docSnap.exists()) {
                    throw new Error("Item not found for moving.");
                }
                const itemData = docSnap.data();

                // Use a batch write for atomicity: delete from old location, add to new
                const batch = writeBatch(db);
                batch.set(newDocRef, itemData); // Create a new document with the same data in the new location
                batch.delete(oldDocRef); // Delete the original document

                await batch.commit();

                showModal('Success', `Item "${itemData.name || itemData.title}" moved successfully!`);
                
                // Re-render both the old and new parent containers to reflect changes
                const oldContainerId = `container-level3-${itemType}-${oldParentIds[1]}`;
                const newContainerId = `container-level3-${itemType}-${newFullParentIds[1]}`;
                
                // Only re-render if the containers are currently expanded/loaded
                if (document.getElementById(oldContainerId)?.classList.contains('expanded')) {
                    renderContent(itemType, oldContainerId, 3, oldParentIds);
                }
                if (document.getElementById(newContainerId)?.classList.contains('expanded')) {
                     renderContent(itemType, newContainerId, 3, newFullParentIds);
                }
                // If a parent folder was not expanded, it will load correctly when expanded next time.

            } catch (error) {
                console.error("Error moving item:", error);
                showModal('Move Error', `Could not move item. Error: ${e.message}`);
            } finally {
                draggedItem = null; // Reset dragged item
                // Remove dragging class from original item if it still exists
                document.querySelectorAll('.sub-item.dragging').forEach(el => el.classList.remove('dragging'));
            }
        }


        // --- STUDENT FILTER LOGIC ---
        function setupStudentFilters(type) {
            const config = materialsConfig[type];
            const level1Filter = document.getElementById(`level1-${type}-filter`);
            const level2Filter = document.getElementById(`level2-${type}-filter`);
            const grid = document.getElementById(`level3-${type}-grid`);

            populateFilter(level1Filter, collection(db, getPath(type)), config.level1);

            level1Filter.onchange = () => {
                const level1Id = level1Filter.value;
                level2Filter.innerHTML = `<option value="">-- Select ${config.level2} --</option>`;
                level2Filter.disabled = true;
                grid.innerHTML = `<p>Please select a ${config.level2.toLowerCase()}.</p>`;
                if (level1Id) {
                    populateFilter(level2Filter, collection(db, getPath(type, [level1Id])), config.level2);
                    level2Filter.disabled = false;
                }
            };
            level2Filter.onchange = () => renderStudentItems(type);
        }

        async function renderStudentItems(type) {
             const config = materialsConfig[type];
             const grid = document.getElementById(`level3-${type}-grid`);
             const level1Id = document.getElementById(`level1-${type}-filter`).value;
             const level2Id = document.getElementById(`level2-${type}-filter`).value;

             grid.innerHTML = `<p class="loading-indicator">Loading...</p>`;
             if (!level1Id || !level2Id) {
                 grid.innerHTML = `<p>Please select a ${config.level1.toLowerCase()} and ${config.level2.toLowerCase()}.</p>`;
                 return;
             }

             const itemsRef = collection(db, getPath(type, [level1Id, level2Id]));
             const q = query(itemsRef, orderBy('name', 'asc'));
             
             let purchasedItems = {};
             if(config.isPaid) {
                 const purchaseCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/purchased_${config.collectionName}`);
                 const snapshot = await getDocs(purchaseCollectionRef);
                 snapshot.forEach(doc => purchasedItems[doc.id] = true);
             }

             try {
                const snapshot = await getDocs(q);
                grid.innerHTML = snapshot.empty ? `<p>No ${config.level3.toLowerCase()}s found.</p>` : '';
                snapshot.forEach(doc => {
                    const item = doc.data();
                    item.id = doc.id; // Add id to item object
                    const card = document.createElement('div');
                    card.className = 'material-card';
                    
                    let cardContent = '';
                    if (type === 'tutorials') {
                        if (item.type === 'youtube') {
                            cardContent = `
                                <div class="material-card-thumbnail" data-youtube-id="${item.youtubeId}">
                                    <img src="https://img.youtube.com/vi/${item.youtubeId}/mqdefault.jpg" alt="${item.title}" onerror="this.onerror=null; this.src='https://placehold.co/480x360/30363d/c9d1d9?text=No%20Thumbnail';">
                                    <div class="play-button-overlay">▶</div>
                                </div>
                                <div class="material-card-content"><h3>${item.title}</h3></div>
                            `;
                        } else if (item.type === 'embed') {
                            cardContent = `
                                <div class="video-embed-container">${item.embedCode}</div>
                                <div class="material-card-content"><h3>${item.title}</h3></div>
                            `;
                        }
                    } else if (config.isPaid) {
                        const isPurchased = purchasedItems[item.id];
                        const inCart = shoppingCart.find(cartItem => cartItem.id === item.id);
                        card.className = 'product-card';
                        cardContent = `
                            <h4>${item.name}</h4>
                            <p class="product-price">$${item.price.toFixed(2)}</p>
                            ${isPurchased 
                                ? `<button class="btn-primary download-btn" data-type="${type}" data-item='${JSON.stringify(item)}'>Preview/Download</button>`
                                : `<button class="add-to-cart-btn btn-primary" data-id="${item.id}" ${inCart ? 'disabled' : ''}>${inCart ? 'In Cart' : 'Add to Cart'}</button>`
                            }`;
                        if(!isPurchased) {
                           setTimeout(() => card.querySelector('.add-to-cart-btn')?.addEventListener('click', () => addToCart(item)), 0);
                        } else {
                            // Ensure the download-btn has the correct data-item for preview
                            setTimeout(() => card.querySelector('.download-btn')?.addEventListener('click', (e) => {
                                const itemData = JSON.parse(e.target.dataset.item);
                                handlePreview(type, itemData); // Use the unified preview function
                            }), 0);
                        }
                    } else { // Free materials like past papers
                        // Changed to a button for consistent styling and click handling
                        cardContent = `
                            <div class="material-card-content">
                                <h3>${item.name}</h3>
                            </div>
                            <button class="btn-primary download-btn" data-type="${type}" data-item='${JSON.stringify(item)}'>Preview/Download</button>
                        `;
                        // Attach event listener directly after creating the card
                        setTimeout(() => card.querySelector('.download-btn')?.addEventListener('click', (e) => {
                            const itemData = JSON.parse(e.target.dataset.item);
                            handlePreview(type, itemData); // Use the unified preview function
                        }), 0);
                    }
                    card.innerHTML = cardContent;
                    grid.appendChild(card);
                });
             } catch(e) {
                console.error("Error loading student items:", e);
                grid.innerHTML = "<p class='error-message'>Error loading items. A database index might be required. Check console for details.</p>"
             }
        }
        
        async function populateFilter(selectElement, collectionRef, levelName) {
            selectElement.innerHTML = `<option value="">-- Loading ${levelName}s --</option>`;
            try {
                const q = query(collectionRef, orderBy('name', levelName === 'Year' ? 'desc' : 'asc'));
                const snapshot = await getDocs(q);
                selectElement.innerHTML = `<option value="">-- Select a ${levelName} --</option>`;
                if(snapshot.empty) {
                    selectElement.innerHTML += `<option value="" disabled>-- No ${levelName}s Available --</option>`;
                    return;
                }
                snapshot.forEach(doc => {
                    selectElement.add(new Option(doc.data().name, doc.id));
                });
            }
            catch (e) {
                console.error(`Error loading ${levelName}s:`, e);
                selectElement.innerHTML = `<option value="">-- Error --</option>`;
            }
        }

        // --- E-COMMERCE LOGIC ---
        function addToCart(item) {
            shoppingCart.push(item);
            updateCartUI();
            renderStudentItems('exercises'); 
        }

        function removeFromCart(itemId) {
            shoppingCart = shoppingCart.filter(item => item.id !== itemId);
            updateCartUI();
            renderStudentItems('exercises');
        }

        function updateCartUI() {
            const cartItemsContainer = document.getElementById('cart-items');
            const subtotalPriceEl = document.getElementById('cart-subtotal-price');
            const promoDiscountLine = document.getElementById('promo-discount-line');
            const promoDiscountEl = document.getElementById('cart-promo-discount');
            const totalPriceEl = document.getElementById('cart-total-price');
            const checkoutBtn = document.getElementById('checkout-btn');
            const validationMsg = document.getElementById('cart-validation-message');
            const promoCodeInput = document.getElementById('promoCodeInput');
            const applyPromoCodeBtn = document.getElementById('applyPromoCodeBtn');
            const appliedPromoCodeDisplay = document.getElementById('appliedPromoCodeDisplay');
            const appliedPromoCodeText = document.getElementById('appliedPromoCodeText');
            const promoCodeError = document.getElementById('promoCodeError');


            cartItemsContainer.innerHTML = '';
            let subtotal = 0;

            if (shoppingCart.length === 0) {
                cartItemsContainer.innerHTML = '<p>Your cart is empty.</p>';
            }

            shoppingCart.forEach(item => {
                subtotal += item.price;
                const itemEl = document.createElement('div');
                itemEl.className = 'cart-item';
                itemEl.innerHTML = `
                    <span class="cart-item-name">${item.name}</span>
                    <span class="cart-item-price">$${item.price.toFixed(2)}</span>
                    <button class="remove-from-cart-btn" data-id="${item.id}">✖</button>
                `;
                cartItemsContainer.appendChild(itemEl);
            });
            
            document.querySelectorAll('.remove-from-cart-btn').forEach(btn => {
                btn.addEventListener('click', () => removeFromCart(btn.dataset.id));
            });

            subtotalPriceEl.textContent = `$${subtotal.toFixed(2)}`;
            let finalPrice = subtotal;

            if (appliedPromoCode) {
                finalPrice = Math.max(0, subtotal - appliedPromoCode.discountAmount); // Ensure price doesn't go negative
                promoDiscountEl.textContent = `-$${appliedPromoCode.discountAmount.toFixed(2)}`;
                promoDiscountLine.style.display = 'flex';
                appliedPromoCodeText.textContent = `${appliedPromoCode.code} (-$${appliedPromoCode.discountAmount.toFixed(2)})`;
                appliedPromoCodeDisplay.style.display = 'flex';
                promoCodeInput.disabled = true;
                applyPromoCodeBtn.disabled = true;
                promoCodeInput.value = appliedPromoCode.code; // Pre-fill with applied code
                promoCodeError.textContent = ''; // Clear any previous error
            } else {
                promoDiscountLine.style.display = 'none';
                appliedPromoCodeDisplay.style.display = 'none';
                promoCodeInput.disabled = false;
                applyPromoCodeBtn.disabled = false;
                promoCodeInput.value = ''; // Clear input if no code applied
            }

            totalPriceEl.textContent = `$${finalPrice.toFixed(2)}`;

            // Validate cart: Checkout enabled if total price is $0 or more AND cart is not empty.
            // Also, if the final price is > 0, enforce a minimum total of $100.
            const canCheckout = shoppingCart.length > 0 && (finalPrice === 0 || finalPrice >= 100);

            if (canCheckout) {
                checkoutBtn.disabled = false;
                if (finalPrice === 0) {
                    validationMsg.textContent = 'Proceed to checkout for free!';
                } else {
                    validationMsg.textContent = '';
                }
            } else {
                checkoutBtn.disabled = true;
                if (shoppingCart.length === 0) {
                    validationMsg.textContent = 'Your cart is empty. Add items to proceed.';
                } else if (finalPrice > 0 && finalPrice < 100) {
                    validationMsg.textContent = 'Minimum total of $100 required to checkout.';
                } else {
                    validationMsg.textContent = ''; // Should not happen if previous conditions are met
                }
            }
        }

        async function applyPromoCode() {
            const promoCodeInput = document.getElementById('promoCodeInput');
            const promoCodeError = document.getElementById('promoCodeError');
            const code = promoCodeInput.value.trim().toUpperCase(); // Convert to uppercase for case-insensitivity

            promoCodeError.textContent = ''; // Clear previous errors

            if (!code) {
                promoCodeError.textContent = 'Please enter a promo code.';
                return;
            }

            const promoCodeRef = doc(db, `artifacts/${appId}/public/data/promoCodes`, code);
            try {
                const docSnap = await getDoc(promoCodeRef);
                if (docSnap.exists()) {
                    const promoData = docSnap.data();
                    if (promoData.isActive) {
                        appliedPromoCode = {
                            code: code,
                            discountAmount: promoData.discountAmount
                        };
                        updateCartUI();
                        showModal('Promo Code Applied', `Successfully applied promo code "${code}" for a $${promoData.discountAmount.toFixed(2)} discount!`);
                    } else {
                        promoCodeError.textContent = 'This promo code is not active.';
                    }
                } else {
                    promoCodeError.textContent = 'Invalid promo code.';
                }
            } catch (error) {
                console.error("Error applying promo code:", error);
                promoCodeError.textContent = `Error applying code: ${error.message}`;
            }
        }

        function removeAppliedPromoCode() {
            appliedPromoCode = null;
            updateCartUI();
            document.getElementById('promoCodeInput').value = ''; // Clear input field
            document.getElementById('promoCodeError').textContent = ''; // Clear error message
            showModal('Promo Code Removed', 'The promo code has been removed from your cart.');
        }


        async function handleCheckout() {
            if (!currentUserId) {
                return showModal('Error', 'You must be logged in to check out.');
            }

            // Recalculate final price with applied discount
            let subtotal = shoppingCart.reduce((sum, item) => sum + item.price, 0);
            let finalPrice = subtotal;
            if (appliedPromoCode) {
                finalPrice = Math.max(0, subtotal - appliedPromoCode.discountAmount);
            }

            if (shoppingCart.length === 0) {
                return showModal('Checkout Error', 'Your cart is empty. Please add items before checking out.');
            }

            if (finalPrice === 0) {
                // Direct "free" checkout - bypass Stripe
                try {
                    const batch = writeBatch(db);
                    shoppingCart.forEach(item => {
                        const purchaseRef = doc(db, `artifacts/${appId}/users/${currentUserId}/purchased_exercises/${item.id}`);
                        batch.set(purchaseRef, { 
                            name: item.name, 
                            price: item.price, 
                            purchasedAt: Date.now(),
                            purchaseMethod: 'promo', // Track purchase method
                            promoCodeUsed: appliedPromoCode ? appliedPromoCode.code : 'N/A' // Track promo code used
                        });
                    });
                    await batch.commit();

                    showModal('Purchase Successful!', 'Your new exercises are now available for download. Enjoy your free items!');
                    shoppingCart = []; // Clear the local cart
                    appliedPromoCode = null; // Clear applied promo code
                    updateCartUI(); // Update UI to reflect empty cart and no promo
                    showSection('exerciseSection'); // Re-render the exercises page
                    renderStudentItems('exercises');

                } catch (error) {
                    console.error("Error processing free checkout:", error);
                    showModal('Checkout Error', `Could not complete free checkout. Please try again. Error: ${error.message}`);
                }

            } else if (finalPrice >= 100) {
                // Proceed with Stripe checkout for paid items
                if (STRIPE_PAYMENT_LINK.includes("...")) {
                    return showModal('Configuration Error', 'The Stripe Payment Link has not been configured by the site administrator.');
                }

                const checkoutSessionId = crypto.randomUUID();
                const checkoutSessionRef = doc(db, `artifacts/${appId}/users/${currentUserId}/checkout_sessions/${checkoutSessionId}`);

                try {
                    // Save the cart and applied promo code to Firestore
                    await setDoc(checkoutSessionRef, {
                        cart: shoppingCart,
                        appliedPromoCode: appliedPromoCode, // Save applied promo code
                        created: Date.now(),
                        totalAmount: finalPrice, // Save the final amount for record
                        purchaseMethod: 'paid' // Mark as paid purchase
                    });

                    // Redirect to Stripe
                    const stripeUrl = `${STRIPE_PAYAPE_LINK}?client_reference_id=${checkoutSessionId}&prefilled_email=${currentUserEmail}`;
                    window.location.href = stripeUrl;

                } catch (error) {
                    console.error("Error creating checkout session:", error);
                    showModal('Checkout Error', `Could not initiate checkout. Please try again. Error: ${error.message}`);
                }
            } else {
                showModal('Checkout Error', 'Minimum total of $100 required to checkout for paid items.');
            }
        }
        
        async function checkForSuccessfulPurchase() {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session_id'); // This is a placeholder, Stripe might use a different param

            // A more robust check might be needed depending on Stripe's redirect behavior
            if (params.get('payment_status') === 'success' && sessionId) {
                const checkoutSessionRef = doc(db, `artifacts/${appId}/users/${currentUserId}/checkout_sessions/${sessionId}`);
                try {
                    const sessionDoc = await getDoc(checkoutSessionRef);
                    if (sessionDoc.exists()) {
                        const sessionData = sessionDoc.data();
                        const purchasedItems = sessionData.cart;

                        // Use a batch write to add all purchased items and delete the session doc atomically
                        const batch = writeBatch(db);
                        purchasedItems.forEach(item => {
                            const purchaseRef = doc(db, `artifacts/${appId}/users/${currentUserId}/purchased_exercises/${item.id}`);
                            batch.set(purchaseRef, { 
                                name: item.name, 
                                price: item.price, 
                                purchasedAt: Date.now(),
                                purchaseMethod: sessionData.purchaseMethod || 'paid', // Default to paid if not specified
                                promoCodeUsed: sessionData.appliedPromoCode ? sessionData.appliedPromoCode.code : 'N/A'
                            });
                        });
                        batch.delete(checkoutSessionRef); // Clean up the session doc
                        await batch.commit();
                        
                        showModal('Purchase Successful!', 'Your new exercises are now available for download.');
                        shoppingCart = []; // Clear the local cart
                        appliedPromoCode = null; // Clear applied promo code
                        
                        // Clean the URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        // Re-render the exercises page
                        showSection('exerciseSection');
                        renderStudentItems('exercises');
                    }
                } catch (error) {
                    console.error("Error processing purchase:", error);
                    showModal('Purchase Error', 'There was an issue verifying your purchase. Please contact support.');
                }
            }
        }

        // --- PROMO CODE MANAGEMENT (TEACHER SIDE) ---
        function generateRandomCode(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        async function generateAndSavePromoCode() {
            const promoDiscountAmountInput = document.getElementById('promoDiscountAmount');
            const promoCodeGenerationStatus = document.getElementById('promoCodeGenerationStatus');
            const discountAmount = parseFloat(promoDiscountAmountInput.value);

            promoCodeGenerationStatus.textContent = ''; // Clear previous messages

            if (isNaN(discountAmount) || discountAmount <= 0) {
                promoCodeGenerationStatus.textContent = 'Please enter a valid discount amount (must be positive).';
                return;
            }

            const newCode = generateRandomCode(8);
            const promoCodeRef = doc(db, `artifacts/${appId}/public/data/promoCodes`, newCode);

            try {
                promoCodeGenerationStatus.textContent = 'Generating and saving promo code...';
                await setDoc(promoCodeRef, {
                    code: newCode,
                    discountAmount: discountAmount,
                    isActive: true, // New codes are active by default
                    createdAt: Date.now(),
                    createdBy: currentUserId
                });
                promoCodeGenerationStatus.textContent = `Promo code "${newCode}" generated with $${discountAmount.toFixed(2)} discount!`;
                promoDiscountAmountInput.value = ''; // Clear discount input
                loadPromoCodesForTeacher(); // Refresh the list
            } catch (error) {
                console.error("Error generating promo code:", error);
                promoCodeGenerationStatus.textContent = `Error: ${error.message}`;
            }
        }

        async function loadPromoCodesForTeacher() {
            const teacherPromoCodeList = document.getElementById('teacherPromoCodeList');
            teacherPromoCodeList.innerHTML = '<p class="loading-indicator">Loading promo codes...</p>';

            const promoCodesCollectionRef = collection(db, `artifacts/${appId}/public/data/promoCodes`);
            const q = query(promoCodesCollectionRef, orderBy('createdAt', 'desc'));

            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    teacherPromoCodeList.innerHTML = '<p>No promo codes generated yet.</p>';
                    return;
                }

                teacherPromoCodeList.innerHTML = '';
                snapshot.forEach(doc => {
                    const promo = doc.data();
                    const promoItem = document.createElement('div');
                    promoItem.className = 'promo-code-item';
                    promoItem.innerHTML = `
                        <span>${promo.code}</span>
                        <span>$${promo.discountAmount.toFixed(2)}</span>
                        <span>${promo.isActive ? 'Active' : 'Inactive'}</span>
                        <div class="actions">
                            <button class="btn-primary toggle-promo-status-btn" data-code="${promo.code}" data-is-active="${promo.isActive ? 'true' : 'false'}">
                                ${promo.isActive ? 'Deactivate' : 'Activate'}
                            </button>
                            <button class="logout-btn delete-promo-btn" data-code="${promo.code}">Delete</button>
                        </div>
                    `;
                    teacherPromoCodeList.appendChild(promoItem);
                });

                // Add event listeners for toggle and delete buttons
                teacherPromoCodeList.querySelectorAll('.toggle-promo-status-btn').forEach(button => {
                    button.addEventListener('click', (e) => togglePromoCodeStatus(e.target.dataset.code, e.target.dataset.isActive === 'true'));
                });
                teacherPromoCodeList.querySelectorAll('.delete-promo-btn').forEach(button => {
                    button.addEventListener('click', (e) => deletePromoCode(e.target.dataset.code));
                });

            } catch (error) {
                console.error("Error loading promo codes:", error);
                teacherPromoCodeList.innerHTML = '<p class="error-message">Error loading promo codes.</p>';
            }
        }

        async function togglePromoCodeStatus(code, currentStatus) {
            const promoCodeRef = doc(db, `artifacts/${appId}/public/data/promoCodes`, code);
            try {
                await updateDoc(promoCodeRef, { isActive: !currentStatus });
                showModal('Status Updated', `Promo code "${code}" is now ${!currentStatus ? 'Active' : 'Inactive'}.`);
                loadPromoCodesForTeacher(); // Refresh the list
            } catch (error) {
                console.error("Error toggling promo code status:", error);
                showModal('Error', `Could not update status for "${code}": ${error.message}`);
            }
        }

        async function deletePromoCode(code) {
            showModal('Confirm Deletion', `Are you sure you want to delete promo code "${code}"? This action cannot be undone.`, [
                { text: 'Delete', className: 'btn-primary', onClick: async () => {
                    const promoCodeRef = doc(db, `artifacts/${appId}/public/data/promoCodes`, code);
                    try {
                        await deleteDoc(promoCodeRef);
                        showModal('Success', `Promo code "${code}" deleted.`);
                        loadPromoCodesForTeacher(); // Refresh the list
                    } catch (error) {
                        console.error("Error deleting promo code:", error);
                        showModal('Error', `Could not delete "${code}": ${error.message}`);
                    }
                }},
                { text: 'Cancel', className: 'logout-btn' }
            ]);
        }

        // --- VIDEO PARSING ---
        function parseVideoInput(input) {
            const text = input.trim();
            // Check for YouTube URL
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const youtubeMatch = text.match(youtubeRegex);
            if (youtubeMatch && youtubeMatch[1]) {
                return { type: 'youtube', id: youtubeMatch[1] };
            }
            // Check for iframe embed code
            if (text.startsWith('<iframe') && text.endsWith('>')) {
                return { type: 'embed', code: text };
            }
            return null; // Invalid input
        }

        // --- GOOGLE DRIVE LINK CONVERSION ---
        function convertGoogleDriveLink(url) {
            const driveViewRegex = /https:\/\/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\/view(?:\?usp=drive_link)?/;
            const match = url.match(driveViewRegex);
            if (match && match[1]) {
                return `https://drive.google.com/uc?export=download&id=${match[1]}`;
            }
            return url; // Return original URL if no match
        }

        function setupGoogleDriveLinkConversion() {
            const linkInputs = [
                document.getElementById('pastPaperLink'),
                document.getElementById('exerciseLink'),
                document.getElementById('editPastPaperLink')
            ];

            linkInputs.forEach(input => {
                if (input) {
                    input.addEventListener('input', (e) => {
                        e.target.value = convertGoogleDriveLink(e.target.value);
                    });
                }
            });
        }

        // --- MODAL SUBMISSION LOGIC ---
        document.getElementById('addVideoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const parentId1 = e.target.querySelector('#videoParentId1').value;
            const parentId2 = e.target.querySelector('#videoParentId2').value;
            const input = document.getElementById('tutorialLink').value;
            const title = document.getElementById('tutorialTitle').value;
            
            const videoDetails = parseVideoInput(input);

            if (!videoDetails || !title.trim()) { 
                return showModal('Input Error', 'Please provide a title and a valid YouTube link or embed code.');
            }
            
            const dataToSave = {
                title: title.trim(),
                name: title.trim(),
                timestamp: Date.now()
            };

            if (videoDetails.type === 'youtube') {
                dataToSave.type = 'youtube';
                dataToSave.youtubeId = videoDetails.id;
            } else { // 'embed'
                dataToSave.type = 'embed';
                dataToSave.embedCode = videoDetails.code;
            }

            const collectionRef = collection(db, getPath('tutorials', [parentId1, parentId2]));
            try {
                await addDoc(collectionRef, dataToSave);
                showModal('Success', 'Video added.');
                document.getElementById('addVideoModal').style.display = 'none';
                renderContent('tutorials', `container-level3-tutorials-${parentId2}`, 3, [parentId1, parentId2]);
            } catch (error) { 
                showModal('Error', `Could not add video: ${error.message}`); 
            }
        });

        document.getElementById('addPastPaperForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const parentId1 = form.querySelector('#paperParentId1').value;
            const parentId2 = form.querySelector('#paperParentId2').value;
            const name = document.getElementById('pastPaperName').value;
            const fileInput = document.getElementById('pastPaperFile');
            const file = fileInput.files[0];
            const link = document.getElementById('pastPaperLink').value.trim();

            if (!name.trim() || (!file && !link)) {
                return showModal('Input Error', 'Please provide a paper name and either upload a PDF or paste a link.');
            }

            const buttonsContainer = form.querySelector('.modal-form-buttons');
            const originalButtonsHTML = buttonsContainer.innerHTML;
            buttonsContainer.innerHTML = `<p class="loading-indicator">Processing...</p>`;
            
            let downloadURL = link; // Default to the pasted link
            let filePath = ''; // Store the path if file is uploaded

            try {
                // If a file is provided, it takes priority
                if (file) {
                    buttonsContainer.innerHTML = `<p class="loading-indicator">Uploading file...</p>`;
                    filePath = `materials/past-papers/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, filePath);
                    const uploadResult = await uploadBytes(storageRef, file);
                    downloadURL = await getDownloadURL(uploadResult.ref);
                }

                if (!downloadURL) { // Final check in case link was empty and file failed
                    throw new Error("No valid file or link provided.");
                }

                const collectionRef = collection(db, getPath('pastPapers', [parentId1, parentId2]));
                await addDoc(collectionRef, { name: name.trim(), link: downloadURL, timestamp: Date.now(), filePath: filePath }); // Save filePath
                
                showModal('Success', 'Past paper added.');
                document.getElementById('addPastPaperModal').style.display = 'none';
                renderContent('pastPapers', `container-level3-pastPapers-${parentId2}`, 3, [parentId1, parentId2]);
            } catch (error) { 
                console.error("Past paper upload error:", error);
                showModal('Error', `Could not add paper: ${error.message}`); 
            } finally {
                buttonsContainer.innerHTML = originalButtonsHTML;
            }
        });

        // New: Edit Past Paper Modal Submission
        document.getElementById('editPastPaperForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const itemId = form.querySelector('#editPaperId').value;
            const parentId1 = form.querySelector('#editPaperParentId1').value;
            const parentId2 = form.querySelector('#editPaperParentId2').value;
            const name = document.getElementById('editPastPaperName').value.trim();
            const link = document.getElementById('editPastPaperLink').value.trim();

            if (!name || !link) {
                return showModal('Input Error', 'Please provide a paper name and a download link.');
            }

            const docRef = doc(db, getPath('pastPapers', [parentId1, parentId2]), itemId);
            try {
                await updateDoc(docRef, { name: name, link: link });
                showModal('Success', 'Past paper updated successfully!');
                document.getElementById('editPastPaperModal').style.display = 'none';
                // Re-render the relevant section to show updated data
                renderContent('pastPapers', `container-level3-pastPapers-${parentId2}`, 3, [parentId1, parentId2]);
            } catch (error) {
                console.error("Error updating past paper:", error);
                showModal('Error', `Could not update past paper: ${error.message}`);
            }
        });

        // New: Function to show Edit Past Paper Modal
        function showEditPastPaperModal(itemData, parentIds) {
            const modal = document.getElementById('editPastPaperModal');
            document.getElementById('editPaperId').value = itemData.id;
            document.getElementById('editPaperParentId1').value = parentIds[0];
            document.getElementById('editPaperParentId2').value = parentIds[1];
            document.getElementById('editPastPaperName').value = itemData.name;
            document.getElementById('editPastPaperLink').value = itemData.link;
            modal.style.display = 'flex';
        }


        document.getElementById('addExerciseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const parentId1 = form.querySelector('#exerciseParentId1').value;
            const parentId2 = form.querySelector('#exerciseParentId2').value;
            const name = document.getElementById('exerciseName').value;
            const price = parseFloat(document.getElementById('exercisePrice').value);
            const fileInput = document.getElementById('exerciseFile');
            const file = fileInput.files[0];
            const link = document.getElementById('exerciseLink').value.trim();
            
            if (!name.trim() || (!file && !link) || isNaN(price) || price < 0) { 
                return showModal('Input Error', 'Please provide a name, price, and either upload a file or paste a link.'); 
            }

            const buttonsContainer = form.querySelector('.modal-form-buttons');
            const originalButtonsHTML = buttonsContainer.innerHTML;
            buttonsContainer.innerHTML = `<p class="loading-indicator">Processing...</p>`;
            
            let downloadURL = link;
            let filePath = ''; // Store the path if file is uploaded

            try {
                if (file) {
                    buttonsContainer.innerHTML = `<p class="loading-indicator">Uploading file...`;
                    filePath = `materials/exercises/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, filePath);
                    const uploadResult = await uploadBytes(storageRef, file);
                    downloadURL = await getDownloadURL(uploadResult.ref);
                }

                if (!downloadURL) {
                    throw new Error("No valid file or link provided.");
                }

                const collectionRef = collection(db, getPath('exercises', [parentId1, parentId2]));
                await addDoc(collectionRef, { name: name.trim(), link: downloadURL, price: price, timestamp: Date.now(), filePath: filePath }); // Save filePath
                
                showModal('Success', 'Exercise added.');
                document.getElementById('addExerciseModal').style.display = 'none';
                renderContent('exercises', `container-level3-exercises-${parentId2}`, 3, [parentId1, parentId2]);
            } catch (error) { 
                console.error("Exercise upload error:", error);
                showModal('Error', `Could not add exercise: ${error.message}`); 
            } finally {
                buttonsContainer.innerHTML = originalButtonsHTML;
            }
        });

        document.getElementById('tutorialLink').addEventListener('input', (e) => {
            const videoDetails = parseVideoInput(e.target.value);
            const thumbnailPreview = document.getElementById('tutorialThumbnailPreview');
            if (videoDetails && videoDetails.type === 'youtube') {
                thumbnailPreview.src = `https://img.youtube.com/vi/${videoDetails.id}/mqdefault.jpg`;
                thumbnailPreview.style.display = 'block';
            } else {
                thumbnailPreview.style.display = 'none';
                thumbnailPreview.src = '';
            }
        });
        
        // --- GRADING & CHAT & OTHER ---
        function setupDropZone(dropZoneId, fileInputId, fileNameDisplayId, filePreviewId = null) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            const fileNameDisplay = document.getElementById(fileNameDisplayId);
            const filePreview = filePreviewId ? document.getElementById(filePreviewId) : null;

            if (!dropZone || !fileInput || !fileNameDisplay) return;

            dropZone.addEventListener('click', () => fileInput.click());
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => dropZone.addEventListener(eName, e => {e.preventDefault(); e.stopPropagation();}));
            ['dragenter', 'dragover'].forEach(eName => dropZone.addEventListener(eName, () => dropZone.classList.add('highlight')));
            ['dragleave', 'drop'].forEach(eName => dropZone.addEventListener(eName, () => dropZone.classList.remove('highlight')));

            dropZone.addEventListener('drop', e => {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            });

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    fileNameDisplay.textContent = file.name;
                    if (filePreview && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => { filePreview.src = e.target.result; filePreview.style.display = 'block'; };
                        reader.readAsDataURL(file);
                    } else if (filePreview && file.type === 'application/pdf') {
                        pdfjsLib.getDocument({ url: URL.createObjectURL(file) }).promise.then(pdf => pdf.getPage(1)).then(page => {
                            const viewport = page.getViewport({ scale: 1.0 });
                            const canvas = document.createElement('canvas');
                            canvas.height = viewport.height; canvas.width = viewport.width;
                            page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise.then(() => {
                                filePreview.src = canvas.toDataURL('image/png');
                                filePreview.style.display = 'block';
                                canvas.remove();
                            });
                        }).catch(err => { console.error("PDF Preview Error:", err); if(filePreview) filePreview.style.display = 'none';});
                    } else {
                        if(filePreview) filePreview.style.display = 'none';
                    }
                } else {
                    fileNameDisplay.textContent = 'No file chosen';
                    if(filePreview) {
                        filePreview.style.display = 'none';
                        filePreview.src = '';
                    }
                }
            });
        }
        // Setup all dropzones on init
        setupDropZone('studentDropZone', 'studentAnswerFile', 'studentFileName', 'studentFilePreview');
        setupDropZone('answerKeyDropZone', 'answerKeyFile', 'answerKeyFileName', 'answerKeyFilePreview');
        setupDropZone('pastPaperDropZone', 'pastPaperFile', 'pastPaperFileName');
        setupDropZone('exerciseDropZone', 'exerciseFile', 'exerciseFileName');
        // New: Homework submission dropzone
        setupDropZone('homeworkDropZone', 'homeworkFile', 'homeworkFileName', 'homeworkFilePreview');
        
        async function loadPastSubmissions() { /* Placeholder for original function */ }
        document.getElementById('gradeButton').addEventListener('click', async () => { /* Placeholder for original function */ });
        
        // --- CHAT FUNCTIONALITY ---
        const chatInput = document.getElementById('chatInput');
        const sendChatButton = document.getElementById('sendChatButton');
        const chatDisplay = document.getElementById('chatDisplay');
        const chatLoadingIndicator = document.getElementById('chatLoadingIndicator');
        const clearChatMemoryButton = document.getElementById('clearChatMemoryButton');

        // Event listeners for AI source selection
        document.getElementById('aiSourceGemini').addEventListener('change', (e) => {
            if (e.target.checked) currentAiSource = 'gemini-api';
        });
        document.getElementById('aiSourceDeepSeek').addEventListener('change', (e) => {
            if (e.target.checked) currentAiSource = 'deepseek-api';
        });
        document.getElementById('aiSourceLocal').addEventListener('change', (e) => {
            if (e.target.checked) currentAiSource = 'local-ai';
        });


        async function handleSendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            appendChatMessage(message, 'user');
            chatInput.value = ''; // Clear input immediately
            chatLoadingIndicator.textContent = 'AI is typing...';

            if (currentAiSource === 'gemini-api') {
                geminiChatHistory.push({ role: "user", parts: [{ text: message }] });

                const payload = { contents: geminiChatHistory };
                const apiKey = ""; // Canvas will provide this at runtime

                try {
                    const apiUrl = `${CLOUDFLARE_WORKER_URL}v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Gemini API error:", errorData);
                        throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const aiResponse = result.candidates[0].content.parts[0].text;
                        appendChatMessage(aiResponse, 'gemini');
                        geminiChatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                        await saveChatHistory(); // Save updated history to Firestore
                    } else {
                        appendChatMessage("Sorry, I couldn't get a response from the AI.", 'gemini');
                        console.warn("Unexpected Gemini API response structure:", result);
                    }
                } catch (error) {
                    console.error("Error sending message to Gemini:", error);
                    appendChatMessage(`Error: ${error.message}`, 'gemini');
                } finally {
                    chatLoadingIndicator.textContent = ''; // Hide loading indicator
                    chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom
                }
            } else if (currentAiSource === 'deepseek-api') {
                // For DeepSeek, you would typically use a Cloudflare Worker or similar proxy
                // to handle the API key securely and bypass CORS issues.
                // This is a placeholder for demonstration.
                const deepseekPayload = {
                    messages: [{ role: "user", content: message }],
                    model: "deepseek-chat", // Or other DeepSeek model
                    stream: false
                };
                const deepseekApiKey = ""; // If you have a DeepSeek API key for a proxy

                try {
                    // This fetch call will now go to your actual DeepSeek Cloudflare Worker
                    const response = await fetch(DEEPSEEK_WORKER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(deepseekPayload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("DeepSeek API error:", errorData);
                        throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                    }

                    const result = await response.json();

                    if (result.choices && result.choices.length > 0 &&
                        result.choices[0].message && result.choices[0].message.content) {
                        const aiResponse = result.choices[0].message.content;
                        appendChatMessage(aiResponse, 'gemini'); // Using 'gemini' class for styling consistency
                    } else {
                        appendChatMessage("Sorry, I couldn't get a response from DeepSeek AI.", 'gemini');
                        console.warn("Unexpected DeepSeek API response structure:", result);
                    }
                } catch (error) {
                    console.error("Error sending message to DeepSeek:", error);
                    appendChatMessage(`Error with DeepSeek AI: ${error.message}`, 'gemini');
                } finally {
                    chatLoadingIndicator.textContent = '';
                    chatDisplay.scrollTop = chatDisplay.scrollHeight;
                }

            } else if (currentAiSource === 'local-ai') {
                let localAiResponse = "";
                // Simple arithmetic check for "1+1" and other basic operations
                const arithmeticMatch = message.match(/^(\d+)\s*([\+\-\*\/])\s*(\d+)$/);
                if (arithmeticMatch) {
                    const num1 = parseFloat(arithmeticMatch[1]);
                    const operator = arithmeticMatch[2];
                    const num2 = parseFloat(arithmeticMatch[3]);
                    let result;
                    try {
                        switch (operator) {
                            case '+': result = num1 + num2; break;
                            case '-': result = num1 - num2; break;
                            case '*': result = num1 * num2; break;
                            case '/': 
                                if (num2 === 0) throw new Error("Division by zero");
                                result = num1 / num2; 
                                break;
                            default: throw new Error("Invalid operator");
                        }
                        localAiResponse = `${message} equals ${result}. While I can handle very simple arithmetic, I'm the experimental local AI and cannot solve complex academic problems like advanced math questions or provide detailed explanations. Please switch to 'Gemini API (Cloud)' or 'DeepSeek API (Cloud)' for more powerful assistance!`;
                    } catch (e) {
                        localAiResponse = `I can't perform that calculation (${e.message}). I'm the experimental local AI and primarily for very basic tasks. For complex math, please use a cloud AI option.`;
                    }
                } else if (message.toLowerCase().includes("hello") || message.toLowerCase().includes("hi")) {
                    localAiResponse = "Hello there! I'm the local AI. I can only provide very basic responses and cannot solve complex academic problems. Please switch to a cloud AI option for advanced help.";
                } else if (message.toLowerCase().includes("math") || message.toLowerCase().includes("equation")) {
                    localAiResponse = "As a local AI, I don't have the advanced processing power for complex math problems or detailed academic explanations. Please use the 'Gemini API (Cloud)' or 'DeepSeek API (Cloud)' option for that!";
                } else if (message.toLowerCase().includes("thank you") || message.toLowerCase().includes("thanks")) {
                    localAiResponse = "You're welcome! Happy to assist in simple ways.";
                } else {
                    localAiResponse = "I'm the experimental local AI. Currently, I can only provide very basic responses and cannot solve complex academic problems. Please switch to 'Gemini API (Cloud)' or 'DeepSeek API (Cloud)' for more powerful assistance!";
                }

                setTimeout(() => { // Simulate a short processing time
                    appendChatMessage(localAiResponse, 'gemini'); // Using 'gemini' class for styling consistency
                    chatLoadingIndicator.textContent = '';
                    chatDisplay.scrollTop = chatDisplay.scrollHeight;
                }, 1000);
            }
        }

        function appendChatMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${sender}`;
            messageElement.textContent = text;
            chatDisplay.appendChild(messageElement);
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Auto-scroll to latest message
        }

        sendChatButton.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent new line in textarea
                handleSendMessage();
            }
        });

        // --- PERSISTENT CHAT HISTORY (FIRESTORE) ---
        const CHAT_HISTORY_DOC_PATH = (userId) => `artifacts/${appId}/users/${userId}/chatHistory/data`;

        async function loadChatHistory() {
            if (!currentUserId) {
                console.warn("No current user ID, cannot load chat history.");
                initializeDefaultChatHistory();
                return;
            }

            chatDisplay.innerHTML = ''; // Clear current display
            chatLoadingIndicator.textContent = 'Loading chat history...';

            try {
                const chatDocRef = doc(db, CHAT_HISTORY_DOC_PATH(currentUserId));
                const docSnap = await getDoc(chatDocRef);

                if (docSnap.exists() && docSnap.data().history) {
                    // Firestore stores arrays as native arrays, no need for JSON.parse
                    geminiChatHistory = docSnap.data().history;
                    geminiChatHistory.forEach(msg => {
                        if (msg.role === "user" || msg.role === "model") {
                            appendChatMessage(msg.parts[0].text, msg.role === "user" ? "user" : "gemini");
                        }
                    });
                } else {
                    console.log("No existing chat history found for user. Initializing default.");
                    initializeDefaultChatHistory();
                }
            } catch (error) {
                console.error("Error loading chat history:", error);
                showModal('Chat History Error', `Could not load chat history: ${error.message}`);
                initializeDefaultChatHistory(); // Fallback to default if load fails
            } finally {
                chatLoadingIndicator.textContent = '';
                chatDisplay.scrollTop = chatDisplay.scrollHeight;
            }
        }

        async function saveChatHistory() {
            if (!currentUserId) {
                console.warn("No current user ID, cannot save chat history.");
                return;
            }

            try {
                const chatDocRef = doc(db, CHAT_HISTORY_DOC_PATH(currentUserId));
                // Firestore can directly store arrays of objects, no need for JSON.stringify
                await setDoc(chatDocRef, { history: geminiChatHistory }, { merge: true });
                console.log("Chat history saved to Firestore.");
            } catch (error) {
                console.error("Error saving chat history:", error);
                showModal('Chat Save Error', `Could not save chat history: ${error.message}`);
            }
        }

        function initializeDefaultChatHistory() {
            geminiChatHistory = [
                { role: "user", parts: [{text: "You are an AI assistant."}]}, 
                { role: "model", parts: [{text: "Hello! How can I assist you?"}]}
            ];
            chatDisplay.innerHTML = ''; // Clear display
            appendChatMessage("Hello! How can I help you today?", 'gemini');
        }

        async function clearChatHistory() {
            showModal('Confirm Clear History', 'Are you sure you want to clear your chat history? This action cannot be undone.', [
                { text: 'Clear', className: 'btn-primary', onClick: async () => {
                    if (!currentUserId) {
                        showModal('Error', 'Not logged in. Cannot clear history.');
                        return;
                    }
                    try {
                        const chatDocRef = doc(db, CHAT_HISTORY_DOC_PATH(currentUserId));
                        await deleteDoc(chatDocRef);
                        initializeDefaultChatHistory(); // Reset local history and UI
                        showModal('Success', 'Chat history cleared.');
                    } catch (error) {
                        console.error("Error clearing chat history:", error);
                        showModal('Error', `Could not clear chat history: ${error.message}`);
                    }
                }},
                { text: 'Cancel', className: 'logout-btn' }
            ]);
        }

        clearChatMemoryButton.addEventListener('click', clearChatHistory);


        // --- STUDENT MANAGEMENT (TEACHER VIEW) ---
        async function loadAuthorizedStudents() {
            const container = document.getElementById('authorizedStudentsList');
            const loadingIndicator = document.getElementById('studentManagementLoading');
            loadingIndicator.textContent = 'Loading student data...';
            container.innerHTML = '';

            try {
                const usersRef = collection(db, `artifacts/${appId}/users`);
                const usersSnapshot = await getDocs(usersRef);
                
                let studentPromises = [];

                for (const userDoc of usersSnapshot.docs) {
                    const userId = userDoc.id;
                    const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                    
                    studentPromises.push((async () => {
                        try {
                            const profileSnap = await getDoc(profileRef);
                            if (profileSnap.exists() && profileSnap.data().role === 'student') {
                                const profileData = profileSnap.data();
                                
                                const purchasedExercisesRef = collection(db, `artifacts/${appId}/users/${userId}/purchased_exercises`);
                                const purchasedExercisesSnap = await getDocs(purchasedExercisesRef);
                                
                                let purchases = [];
                                purchasedExercisesSnap.forEach(purchaseDoc => {
                                    purchases.push(purchaseDoc.data());
                                });

                                return { id: userId, profile: profileData, purchases: purchases };
                            }
                        } catch (e) {
                            // Catch specific permission errors and log them clearly
                            if (e.code === 'permission-denied') {
                                console.warn(`Permission denied for user ${userId}. Ensure security rules allow teachers to read student data.`);
                            } else {
                                console.warn(`Could not load profile or purchases for user ${userId}: ${e.message}`);
                            }
                        }
                        return null;
                    })());
                }

                const students = (await Promise.all(studentPromises)).filter(Boolean); // Filter out nulls

                if (students.length === 0) {
                    container.innerHTML = '<p>No students have logged in yet or you do not have permission to view their data.</p>';
                } else {
                    students.forEach(student => {
                        const studentCard = document.createElement('div');
                        studentCard.className = 'student-card';

                        let purchasesHtml = '<h4>Purchase History</h4>';
                        if (student.purchases.length > 0) {
                            student.purchases.forEach(item => {
                                purchasesHtml += `
                                    <div class="purchase-item">
                                        <span>${item.name}</span>
                                        <span>$${item.price.toFixed(2)}</span>
                                    </div>
                                `;
                            });
                        } else {
                            purchasesHtml += '<p>No purchases made.</p>';
                        }

                        studentCard.innerHTML = `
                            <h3>${student.profile.name || 'Unnamed Student'}</h3>
                            <div class="student-info">
                                <p><strong>Email:</strong> ${student.profile.email || 'N/A'}</p>
                                <p><strong>Electives:</strong> ${student.profile.electives || 'N/A'}</p>
                                <p><strong>Last Login:</strong> ${new Date(student.profile.lastLogin).toLocaleString()}</p>
                            </div>
                            <div class="purchase-history">
                                ${purchasesHtml}
                            </div>
                            <button class="delete-student-btn" data-student-id="${student.id}">✖</button>
                        `;
                        container.appendChild(studentCard);
                    });
                     // Add event listeners for delete buttons
                    container.querySelectorAll('.delete-student-btn').forEach(btn => {
                        btn.addEventListener('click', () => deleteStudent(btn.dataset.studentId));
                    });
                }

            } catch (error) {
                console.error("Error loading student data:", error);
                container.innerHTML = `<p class="error-message">Failed to load student data: ${error.message}. Please check Firebase security rules.</p>`;
            } finally {
                loadingIndicator.textContent = '';
            }
        }

        async function deleteStudent(studentId) {
            showModal('Confirm Deletion', `Are you sure you want to delete this student's account and all their data (profile, purchases, chat history, submissions)? This action cannot be undone.`, [
                { text: 'Delete', className: 'btn-primary', onClick: async () => {
                    try {
                        const batch = writeBatch(db);

                        // Delete profile document
                        const profileDocRef = doc(db, `artifacts/${appId}/users/${studentId}/profile/data`);
                        batch.delete(profileDocRef);

                        // Delete purchased items (get all and delete)
                        const purchasedExercisesRef = collection(db, `artifacts/${appId}/users/${studentId}/purchased_exercises`);
                        const purchasedSnapshot = await getDocs(purchasedExercisesRef); /* Corrected from purchasesRef */
                        purchasedSnapshot.forEach(doc => batch.delete(doc.ref));

                        // Delete chat history
                        const chatHistoryDocRef = doc(db, CHAT_HISTORY_DOC_PATH(studentId));
                        batch.delete(chatHistoryDocRef);
                        
                        // Delete submissions for the student
                        const submissionsRef = collection(db, `artifacts/${appId}/users/${studentId}/submissions`);
                        const submissionsSnapshot = await getDocs(submissionsRef);
                        for (const submissionDoc of submissionsSnapshot.docs) {
                            const submissionData = submissionDoc.data();
                            if (submissionData.filePath) { // Delete file from storage if it exists
                                try {
                                    const fileRef = ref(storage, submissionData.filePath);
                                    await deleteObject(fileRef);
                                    console.log('Submission file deleted from storage:', submissionData.filePath);
                                } catch (storageError) {
                                    console.warn('Could not delete submission file from storage (may not exist):', storageError);
                                }
                            }
                            batch.delete(submissionDoc.ref);
                        }

                        await batch.commit();

                        showModal('Success', 'Student account and associated data deleted.');
                        loadAuthorizedStudents(); // Refresh the list
                    } catch (error) {
                        console.error("Error deleting student:", error);
                        showModal('Error', `Could not delete student: ${error.message}`);
                    }
                }},
                { text: 'Cancel', className: 'logout-btn' }
            ]);
        }

        // --- HOMEWORK SUBMISSION LOGIC (NEW) ---
        async function renderSubmissionSection() {
            const submissionSection = document.getElementById('submissionSection');
            submissionSection.innerHTML = ''; // Clear previous content

            if (currentUserRole === 'teacher') {
                renderTeacherSubmissionView(submissionSection);
            } else if (currentUserRole === 'student') {
                renderStudentSubmissionView(submissionSection);
            } else {
                submissionSection.innerHTML = `<p class="error-message">You do not have permission to view this section.</p>`;
            }
        }

        async function renderTeacherSubmissionView(container) {
            container.innerHTML = `
                <div class="form-container">
                    <h3>Create New Assignment</h3>
                    <form id="createAssignmentForm">
                        <div style="margin-bottom: 1rem;">
                            <label for="newAssignmentSubject">Subject</label>
                            <select id="newAssignmentSubject" required><option value="">-- Select Subject --</option></select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label for="newAssignmentTitle">Assignment Title</label>
                            <input type="text" id="newAssignmentTitle" required placeholder="e.g., Chapter 3 Homework, Essay Outline">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label for="newAssignmentDescription">Description (Optional)</label>
                            <textarea id="newAssignmentDescription" placeholder="Provide instructions or details for the assignment..."></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label for="newAssignmentDueDate">Due Date (Optional)</label>
                            <input type="date" id="newAssignmentDueDate">
                        </div>
                        <button type="submit" class="btn-primary">Create Assignment</button>
                    </form>
                </div>

                <div class="assignment-list-container">
                    <h3>Active Assignments</h3>
                    <p id="assignmentsLoading" class="loading-indicator">Loading assignments...</p>
                    <div id="teacherAssignmentsList">
                        <!-- Assignments will be loaded here -->
                        <p>No assignments created yet.</p>
                    </div>
                </div>
            `;

            await populateSubjectDropdowns(); // Populate subject dropdown for teacher
            document.getElementById('createAssignmentForm').addEventListener('submit', createAssignment);
            loadTeacherAssignments();
        }

        async function createAssignment(e) {
            e.preventDefault();
            const form = e.target;
            const subject = document.getElementById('newAssignmentSubject').value.trim();
            const title = document.getElementById('newAssignmentTitle').value.trim();
            const description = document.getElementById('newAssignmentDescription').value.trim();
            const dueDate = document.getElementById('newAssignmentDueDate').value;

            if (!subject || !title) {
                return showModal('Input Error', 'Please provide both a subject and an assignment title.');
            }

            const assignmentsRef = collection(db, getPath('assignments', [subject]));
            try {
                await addDoc(assignmentsRef, {
                    subjectName: subject,
                    title: title,
                    description: description,
                    dueDate: dueDate ? new Date(dueDate).getTime() : null,
                    createdAt: Date.now(),
                    createdBy: currentUserId
                });
                showModal('Success', 'Assignment created successfully!');
                form.reset();
                await populateSubjectDropdowns(); // Re-populate to update subject list if new one was added
                loadTeacherAssignments(); // Refresh the list
            } catch (error) {
                console.error("Error creating assignment:", error);
                showModal('Error', `Could not create assignment: ${error.message}`);
            }
        }
        
        // Helper function to get unique subjects from existing assignments
        async function getUniqueAssignmentSubjects() {
            const subjectsRef = collection(db, `artifacts/${appId}/public/data/assignments`);
            const subjectsSnapshot = await getDocs(subjectsRef);
            const subjects = [];
            subjectsSnapshot.forEach(doc => subjects.push(doc.id));
            return subjects;
        }

        // Populates subject dropdowns for both teacher's create assignment and student's submission
        async function populateSubjectDropdowns() {
            const teacherSubjectDropdown = document.getElementById('newAssignmentSubject');
            const studentSubjectDropdown = document.getElementById('studentSubmissionSubjectFilter');

            const subjects = await getUniqueAssignmentSubjects();

            // Populate teacher's dropdown
            if (teacherSubjectDropdown) {
                teacherSubjectDropdown.innerHTML = '<option value="">-- Select Subject --</option>';
                subjects.forEach(subject => {
                    teacherSubjectDropdown.add(new Option(subject, subject));
                });
            }

            // Populate student's dropdown
            if (studentSubjectDropdown) {
                studentSubjectDropdown.innerHTML = '<option value="">-- Select Subject --</option>';
                subjects.forEach(subject => {
                    studentSubjectDropdown.add(new Option(subject, subject));
                });
            }
        }


        async function loadTeacherAssignments() {
            const listContainer = document.getElementById('teacherAssignmentsList');
            const loadingIndicator = document.getElementById('assignmentsLoading');
            loadingIndicator.style.display = 'block';
            listContainer.innerHTML = '';

            try {
                // Get all subjects that have assignments
                const subjectsRef = collection(db, `artifacts/${appId}/public/data/assignments`);
                const subjectsSnapshot = await getDocs(subjectsRef);

                if (subjectsSnapshot.empty) {
                    listContainer.innerHTML = '<p>No assignments created yet.</p>';
                    loadingIndicator.style.display = 'none';
                    return;
                }

                let allAssignments = [];
                for (const subjectDoc of subjectsSnapshot.docs) {
                    const subjectId = subjectDoc.id;
                    const assignmentsRef = collection(db, getPath('assignments', [subjectId]));
                    const q = query(assignmentsRef, orderBy('createdAt', 'desc'));
                    const assignmentsSnapshot = await getDocs(q);

                    assignmentsSnapshot.forEach(assignmentDoc => {
                        allAssignments.push({ id: assignmentDoc.id, subjectId: subjectId, ...assignmentDoc.data() });
                    });
                }
                
                if (allAssignments.length === 0) {
                    listContainer.innerHTML = '<p>No assignments created yet.</p>';
                    loadingIndicator.style.display = 'none';
                    return;
                }

                allAssignments.sort((a, b) => b.createdAt - a.createdAt); // Newest first

                allAssignments.forEach(assignment => {
                    const assignmentCard = document.createElement('div');
                    assignmentCard.className = 'assignment-card';
                    const dueDateText = assignment.dueDate ? `Due: ${new Date(assignment.dueDate).toLocaleDateString()}` : 'No due date';

                    assignmentCard.innerHTML = `
                        <h3>${assignment.subjectName}: ${assignment.title}</h3>
                        <p>${assignment.description || 'No description provided.'}</p>
                        <p>${dueDateText}</p>
                        <div class="assignment-actions">
                            <button class="btn-primary view-submissions-btn" 
                                data-assignment-id="${assignment.id}" 
                                data-subject-id="${assignment.subjectId}"
                                data-assignment-title="${assignment.title}"
                                >View Submissions</button>
                            <button class="logout-btn delete-assignment-btn" 
                                data-assignment-id="${assignment.id}" 
                                data-subject-id="${assignment.subjectId}"
                                >Delete Assignment</button>
                        </div>
                        <div id="submissionsListContainer-${assignment.id}" style="display:none; margin-top:1.5rem;">
                            <h4>Student Submissions:</h4>
                            <p class="loading-indicator">Loading submissions...</p>
                            <div id="submissionsForAssignment-${assignment.id}"></div>
                        </div>
                    `;
                    listContainer.appendChild(assignmentCard);
                });

                listContainer.querySelectorAll('.view-submissions-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const assignmentId = e.target.dataset.assignmentId;
                        const subjectId = e.target.dataset.subjectId;
                        const assignmentTitle = e.target.dataset.assignmentTitle;
                        toggleSubmissionList(assignmentId, subjectId, assignmentTitle);
                    });
                });

                listContainer.querySelectorAll('.delete-assignment-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const assignmentId = e.target.dataset.assignmentId;
                        const subjectId = e.target.dataset.subjectId;
                        deleteAssignment(assignmentId, subjectId);
                    });
                });

            } catch (error) {
                console.error("Error loading teacher assignments:", error);
                listContainer.innerHTML = `<p class="error-message">Failed to load assignments: ${error.message}</p>`;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        async function toggleSubmissionList(assignmentId, subjectId, assignmentTitle) {
            const container = document.getElementById(`submissionsListContainer-${assignmentId}`);
            const submissionsDiv = document.getElementById(`submissionsForAssignment-${assignmentId}`);
            const loadingIndicator = container.querySelector('.loading-indicator');

            const isVisible = container.style.display === 'block';
            if (isVisible) {
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
                loadingIndicator.style.display = 'block';
                submissionsDiv.innerHTML = ''; // Clear previous
                await loadStudentSubmissionsForTeacher(assignmentId, subjectId, submissionsDiv);
                loadingIndicator.style.display = 'none';
            }
        }

        async function loadStudentSubmissionsForTeacher(assignmentId, subjectId, submissionsDiv) {
            submissionsDiv.innerHTML = '';
            try {
                const usersRef = collection(db, `artifacts/${appId}/users`);
                const usersSnapshot = await getDocs(usersRef);

                let allSubmissions = [];

                for (const userDoc of usersSnapshot.docs) {
                    const studentId = userDoc.id;
                    const studentProfileRef = doc(db, `artifacts/${appId}/users/${studentId}/profile/data`);
                    const studentProfileSnap = await getDoc(studentProfileRef);
                    const studentName = studentProfileSnap.exists() ? (studentProfileSnap.data().name || studentProfileSnap.data().email) : `Student ${studentId.substring(0, 8)}...`;

                    const submissionsRef = collection(db, `artifacts/${appId}/users/${studentId}/submissions`);
                    const q = query(submissionsRef, where('assignmentId', '==', assignmentId), orderBy('submittedAt', 'desc'));
                    const submissionsSnapshot = await getDocs(q);

                    submissionsSnapshot.forEach(submissionDoc => {
                        allSubmissions.push({ 
                            id: submissionDoc.id, 
                            studentId: studentId,
                            studentName: studentName,
                            ...submissionDoc.data() 
                        });
                    });
                }

                if (allSubmissions.length === 0) {
                    submissionsDiv.innerHTML = '<p>No submissions yet for this assignment.</p>';
                    return;
                }

                allSubmissions.forEach(submission => {
                    const submissionItem = document.createElement('div');
                    submissionItem.className = 'assignment-submission-item';
                    const submittedAt = new Date(submission.submittedAt).toLocaleString();

                    let previewContent;
                    if (submission.fileLink) {
                        previewContent = `<button class="btn-primary preview-submission-file-btn" data-file-link="${submission.fileLink}" data-file-name="${submission.fileName || 'Submission'}">Preview/Download File</button>`;
                    } else if (submission.textAnswer) {
                        previewContent = `<button class="btn-primary preview-submission-text-btn" data-text-answer="${submission.textAnswer}" data-assignment-title="${submission.assignmentTitle}">View Text</button>`;
                    } else {
                        previewContent = 'No content provided.';
                    }

                    submissionItem.innerHTML = `
                        <div>
                            <strong>${submission.studentName}</strong> <span class="submission-detail">(${submittedAt})</span>
                            <p class="submission-detail">${submission.fileName ? `File: ${submission.fileName}` : 'Text Submission'}</p>
                        </div>
                        <div class="submission-actions">
                            ${previewContent}
                            <button class="logout-btn delete-submission-btn" 
                                data-student-id="${submission.studentId}" 
                                data-submission-id="${submission.id}"
                                data-file-path="${submission.filePath || ''}"
                                >Delete</button>
                        </div>
                    `;
                    submissionsDiv.appendChild(submissionItem);
                });

                submissionsDiv.querySelectorAll('.preview-submission-file-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const fileLink = e.target.dataset.fileLink;
                        const fileName = e.target.dataset.fileName;
                        handlePreview('submissionFile', { name: fileName, link: fileLink });
                    });
                });
                submissionsDiv.querySelectorAll('.preview-submission-text-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const textAnswer = e.target.dataset.textAnswer;
                        const assignmentTitle = e.target.dataset.assignmentTitle;
                        handlePreview('submissionText', { name: assignmentTitle, text: textAnswer });
                    });
                });
                 submissionsDiv.querySelectorAll('.delete-submission-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const studentId = e.target.dataset.studentId;
                        const submissionId = e.target.dataset.submissionId;
                        const filePath = e.target.dataset.filePath;
                        deleteSubmission(studentId, submissionId, assignmentId, subjectId, filePath);
                    });
                });

            } catch (error) {
                console.error("Error loading student submissions for teacher:", error);
                submissionsDiv.innerHTML = `<p class="error-message">Failed to load student submissions: ${error.message}</p>`;
            }
        }

        async function deleteAssignment(assignmentId, subjectId) {
            showModal('Confirm Deletion', `Are you sure you want to delete this assignment? This will also delete all student submissions for it. This action cannot be undone.`, [
                { text: 'Delete', className: 'btn-primary', onClick: async () => {
                    try {
                        const batch = writeBatch(db);
                        const assignmentDocRef = doc(db, getPath('assignments', [subjectId]), assignmentId);
                        batch.delete(assignmentDocRef);

                        // Delete all associated student submissions
                        const usersRef = collection(db, `artifacts/${appId}/users`);
                        const usersSnapshot = await getDocs(usersRef);
                        for (const userDoc of usersSnapshot.docs) {
                            const studentId = userDoc.id;
                            const submissionsRef = collection(db, `artifacts/${appId}/users/${studentId}/submissions`);
                            const q = query(submissionsRef, where('assignmentId', '==', assignmentId));
                            const submissionsSnapshot = await getDocs(q);
                            for (const submissionDoc of submissionsSnapshot.docs) {
                                const submissionData = submissionDoc.data();
                                if (submissionData.filePath) { // Delete file from storage if it exists
                                    try {
                                        const fileRef = ref(storage, submissionData.filePath);
                                        await deleteObject(fileRef);
                                        console.log('Submission file deleted from storage:', submissionData.filePath);
                                    } catch (storageError) {
                                        console.warn('Could not delete submission file from storage (may not exist):', storageError);
                                    }
                                }
                                batch.delete(submissionDoc.ref);
                            }
                        }

                        await batch.commit();
                        showModal('Success', 'Assignment and all submissions deleted.');
                        await populateSubjectDropdowns(); // Re-populate subject dropdowns after deleting an assignment
                        loadTeacherAssignments(); // Refresh list
                    } catch (error) {
                        console.error("Error deleting assignment:", error);
                        showModal('Error', `Could not delete assignment: ${error.message}`);
                    }
                }},
                { text: 'Cancel', className: 'logout-btn' }
            ]);
        }

        async function deleteSubmission(studentId, submissionId, assignmentId, subjectId, filePath) {
            showModal('Confirm Deletion', `Are you sure you want to delete this student's submission? This action cannot be undone.`, [
                { text: 'Delete', className: 'btn-primary', onClick: async () => {
                    try {
                        const submissionDocRef = doc(db, `artifacts/${appId}/users/${studentId}/submissions`, submissionId);
                        
                        // Delete file from storage if it exists
                        if (filePath) {
                            try {
                                const fileRef = ref(storage, filePath);
                                await deleteObject(fileRef);
                                console.log('Submission file deleted from storage:', filePath);
                            } catch (storageError) {
                                console.warn('Could not delete submission file from storage (may not exist):', storageError);
                            }
                        }
                        
                        await deleteDoc(submissionDocRef);
                        showModal('Success', 'Submission deleted.');
                        // Re-load submissions for this assignment to update the view
                        const submissionsDiv = document.getElementById(`submissionsForAssignment-${assignmentId}`);
                        if (submissionsDiv) {
                            await loadStudentSubmissionsForTeacher(assignmentId, subjectId, submissionsDiv);
                        }
                    } catch (error) {
                        console.error("Error deleting submission:", error);
                        showModal('Error', `Could not delete submission: ${error.message}`);
                    }
                }},
                { text: 'Cancel', className: 'logout-btn' }
            ]);
        }

        async function renderStudentSubmissionView(container) {
            container.innerHTML = `
                <div class="form-container">
                    <h3>Submit Your Homework</h3>
                    <form id="submitHomeworkForm">
                        <div style="margin-bottom: 1rem;">
                            <label for="studentSubmissionSubjectFilter">Choose Subject</label>
                            <select id="studentSubmissionSubjectFilter" required><option value="">-- Select Subject --</option></select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label for="studentSubmissionAssignmentFilter">Choose Assignment</label>
                            <select id="studentSubmissionAssignmentFilter" required disabled><option value="">-- Select Assignment --</option></select>
                        </div>
                        <div id="assignmentDetails" style="margin-bottom: 1rem; padding: 1rem; border: 1px dashed var(--border-color); border-radius: 8px; display: none;">
                            <p><strong>Description:</strong> <span id="assignmentDescriptionText"></span></p>
                            <p><strong>Due Date:</strong> <span id="assignmentDueDateText"></span></p>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label>Upload Homework File (PDF, Image)</label>
                            <div id="homeworkDropZone" class="drop-zone">
                                <span>Drag & Drop File Here or click to select</span>
                                <input type="file" id="homeworkFile" accept="image/*,application/pdf" hidden>
                            </div>
                            <span id="homeworkFileName" class="text-gray-500 text-sm block text-center mt-2">No file chosen</span>
                            <img id="homeworkFilePreview" class="file-preview mx-auto" style="display: none;" alt="Homework Preview">
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label for="homeworkTextAnswer">Or Type Your Answer:</label>
                            <textarea id="homeworkTextAnswer" placeholder="Type your homework answer here..."></textarea>
                        </div>
                        <p id="homeworkSubmissionError" class="error-message"></p>
                        <button type="submit" class="btn-primary">Submit Homework</button>
                    </form>
                </div>

                <div class="my-submissions-container">
                    <h3>My Past Submissions</h3>
                    <p id="mySubmissionsLoading" class="loading-indicator">Loading your submissions...</p>
                    <div id="mySubmissionsList">
                        <!-- Student's past submissions will be loaded here -->
                        <p>No submissions yet.</p>
                    </div>
                </div>
            `;

            const subjectFilter = document.getElementById('studentSubmissionSubjectFilter');
            const assignmentFilter = document.getElementById('studentSubmissionAssignmentFilter');
            const submitForm = document.getElementById('submitHomeworkForm');

            await populateSubjectDropdowns(); // Populate subject dropdown for student
            
            subjectFilter.addEventListener('change', () => {
                const selectedSubject = subjectFilter.value;
                assignmentFilter.innerHTML = `<option value="">-- Select Assignment --</option>`;
                assignmentFilter.disabled = true;
                document.getElementById('assignmentDetails').style.display = 'none';

                if (selectedSubject) {
                    populateStudentAssignmentDropdown(assignmentFilter, selectedSubject);
                    assignmentFilter.disabled = false;
                }
            });

            assignmentFilter.addEventListener('change', async () => {
                const selectedAssignmentId = assignmentFilter.value;
                const assignmentDetailsDiv = document.getElementById('assignmentDetails');
                if (selectedAssignmentId) {
                    const subjectId = subjectFilter.value;
                    const assignmentDocRef = doc(db, getPath('assignments', [subjectId]), selectedAssignmentId);
                    const docSnap = await getDoc(assignmentDocRef);
                    if (docSnap.exists()) {
                        const assignmentData = docSnap.data();
                        document.getElementById('assignmentDescriptionText').textContent = assignmentData.description || 'No description provided.';
                        document.getElementById('assignmentDueDateText').textContent = assignmentData.dueDate ? new Date(assignmentData.dueDate).toLocaleDateString() : 'No due date.';
                        assignmentDetailsDiv.style.display = 'block';
                    }
                } else {
                    assignmentDetailsDiv.style.display = 'none';
                }
            });

            submitForm.addEventListener('submit', submitHomework);
            loadMySubmissions();
        }

        async function populateStudentAssignmentDropdown(assignmentSelect, selectedSubjectId) {
            assignmentSelect.innerHTML = `<option value="">-- Loading Assignments --</option>`;
            try {
                const assignmentsRef = collection(db, getPath('assignments', [selectedSubjectId]));
                const q = query(assignmentsRef, orderBy('createdAt', 'desc'));
                const assignmentsSnapshot = await getDocs(q);
                
                assignmentSelect.innerHTML = `<option value="">-- Select Assignment --</option>`;
                if (assignmentsSnapshot.empty) {
                    assignmentSelect.innerHTML += `<option value="" disabled>-- No Assignments for this Subject --</option>`;
                } else {
                    assignmentsSnapshot.forEach(doc => {
                        assignmentSelect.add(new Option(doc.data().title, doc.id));
                    });
                }
            } catch (error) {
                console.error("Error populating student assignment dropdown:", error);
                assignmentSelect.innerHTML = `<option value="">-- Error loading assignments --</option>`;
            }
        }


        async function submitHomework(e) {
            e.preventDefault();
            const form = e.target;
            const subjectId = document.getElementById('studentSubmissionSubjectFilter').value;
            const assignmentId = document.getElementById('studentSubmissionAssignmentFilter').value;
            const homeworkFile = document.getElementById('homeworkFile').files[0];
            const homeworkTextAnswer = document.getElementById('homeworkTextAnswer').value.trim();
            const submissionError = document.getElementById('homeworkSubmissionError');

            submissionError.textContent = ''; // Clear previous errors

            if (!subjectId || !assignmentId) {
                submissionError.textContent = 'Please select a subject and an assignment.';
                return;
            }
            if (!homeworkFile && !homeworkTextAnswer) {
                submissionError.textContent = 'Please either upload a file or type your answer.';
                return;
            }

            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';

            let fileLink = '';
            let filePath = '';
            let assignmentTitle = '';

            try {
                const assignmentDocRef = doc(db, getPath('assignments', [subjectId]), assignmentId);
                const assignmentSnap = await getDoc(assignmentDocRef);
                if (assignmentSnap.exists()) {
                    assignmentTitle = assignmentSnap.data().title;
                } else {
                    throw new Error('Selected assignment not found.');
                }

                if (homeworkFile) {
                    filePath = `submissions/${currentUserId}/${subjectId}/${assignmentId}/${Date.now()}_${homeworkFile.name}`;
                    const storageRef = ref(storage, filePath);
                    const uploadResult = await uploadBytes(storageRef, homeworkFile);
                    fileLink = await getDownloadURL(uploadResult.ref);
                }

                const submissionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/submissions`);
                await addDoc(submissionsCollectionRef, {
                    assignmentId: assignmentId,
                    subjectId: subjectId,
                    assignmentTitle: assignmentTitle,
                    fileLink: fileLink,
                    fileName: homeworkFile ? homeworkFile.name : null,
                    filePath: filePath, // Store for easy deletion
                    textAnswer: homeworkTextAnswer,
                    submittedAt: Date.now(),
                    submittedBy: currentUserId
                });

                showModal('Success', 'Your homework has been submitted successfully!');
                form.reset();
                document.getElementById('homeworkFileName').textContent = 'No file chosen';
                document.getElementById('homeworkFilePreview').style.display = 'none';
                document.getElementById('homeworkFilePreview').src = '';
                loadMySubmissions(); // Refresh student's submissions list
            } catch (error) {
                console.error("Error submitting homework:", error);
                submissionError.textContent = `Submission failed: ${error.message}`;
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        }

        async function loadMySubmissions() {
            const mySubmissionsList = document.getElementById('mySubmissionsList');
            const loadingIndicator = document.getElementById('mySubmissionsLoading');
            loadingIndicator.style.display = 'block';
            mySubmissionsList.innerHTML = '';

            try {
                const submissionsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/submissions`);
                const q = query(submissionsRef, orderBy('submittedAt', 'desc'));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    mySubmissionsList.innerHTML = '<p>You have not submitted any homework yet.</p>';
                    loadingIndicator.style.display = 'none';
                    return;
                }

                snapshot.forEach(doc => {
                    const submission = doc.data();
                    const submissionCard = document.createElement('div');
                    submissionCard.className = 'student-submission-card';
                    const submittedAt = new Date(submission.submittedAt).toLocaleString();

                    let contentPreview = '';
                    let previewButton = '';

                    if (submission.fileLink) {
                        contentPreview = `<p>File: ${submission.fileName || 'Uploaded File'}</p>`;
                        previewButton = `<button class="btn-primary preview-my-submission-file-btn" data-file-link="${submission.fileLink}" data-file-name="${submission.fileName || 'Submission'}">Preview/Download</button>`;
                    } else if (submission.textAnswer) {
                        contentPreview = `<p>Text: ${submission.textAnswer.substring(0, 100)}${submission.textAnswer.length > 100 ? '...' : ''}</p>`;
                        previewButton = `<button class="btn-primary preview-my-submission-text-btn" data-text-answer="${submission.textAnswer}" data-assignment-title="${submission.assignmentTitle}">View Text</button>`;
                    }

                    submissionCard.innerHTML = `
                        <h4>${submission.assignmentTitle}</h4>
                        <p>Subject: ${submission.subjectId}</p>
                        <p>Submitted On: ${submittedAt}</p>
                        ${contentPreview}
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            ${previewButton}
                            <button class="logout-btn delete-my-submission-btn" data-submission-id="${doc.id}" data-file-path="${submission.filePath || ''}">Delete</button>
                        </div>
                    `;
                    mySubmissionsList.appendChild(submissionCard);
                });

                mySubmissionsList.querySelectorAll('.preview-my-submission-file-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const fileLink = e.target.dataset.fileLink;
                        const fileName = e.target.dataset.fileName;
                        handlePreview('submissionFile', { name: fileName, link: fileLink });
                    });
                });
                mySubmissionsList.querySelectorAll('.preview-my-submission-text-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const textAnswer = e.target.dataset.textAnswer;
                        const assignmentTitle = e.target.dataset.assignmentTitle;
                        handlePreview('submissionText', { name: assignmentTitle, text: textAnswer });
                    });
                });
                mySubmissionsList.querySelectorAll('.delete-my-submission-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const submissionId = e.target.dataset.submissionId;
                        const filePath = e.target.dataset.filePath;
                        deleteMySubmission(submissionId, filePath);
                    });
                });

            } catch (error) {
                console.error("Error loading my submissions:", error);
                mySubmissionsList.innerHTML = `<p class="error-message">Failed to load your submissions: ${error.message}</p>`;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        async function deleteMySubmission(submissionId, filePath) {
            showModal('Confirm Deletion', `Are you sure you want to delete this submission? This action cannot be undone.`, [
                { text: 'Delete', className: 'btn-primary', onClick: async () => {
                    try {
                        const submissionDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/submissions`, submissionId);
                        
                        // Delete file from storage if it exists
                        if (filePath) {
                            try {
                                const fileRef = ref(storage, filePath);
                                await deleteObject(fileRef);
                                console.log('Submission file deleted from storage:', filePath);
                            } catch (storageError) {
                                console.warn('Could not delete submission file from storage (may not exist):', storageError);
                            }
                        }
                        
                        await deleteDoc(submissionDocRef);
                        showModal('Success', 'Submission deleted.');
                        loadMySubmissions(); // Refresh student's submissions list
                    } catch (error) {
                        console.error("Error deleting my submission:", error);
                        showModal('Error', `Could not delete submission: ${error.message}`);
                    }
                }},
                { text: 'Cancel', className: 'logout-btn' }
            ]);
        }

        function showModal(title, message, buttons = []) {
            const messageModal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = '';

            if (buttons.length === 0) {
                 const okButton = document.createElement('button');
                 okButton.textContent = 'OK';
                 okButton.className = 'btn-primary';
                 okButton.onclick = () => { messageModal.style.display = 'none'; };
                 modalButtons.appendChild(okButton);
            } else {
                 buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.textContent = btnConfig.text;
                    button.className = btnConfig.className;
                    button.onclick = () => { 
                        messageModal.style.display = 'none';
                        if (btnConfig.onClick) btnConfig.onClick();
                    };
                    modalButtons.appendChild(button);
                });
            }
            messageModal.style.display = 'flex';
        }
        
        function showInputModal(title, label, callback) {
            const messageModal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = `<label for="modalInput" style="display:block; margin-bottom:8px;">${label}</label><input type="text" id="modalInput" style="width: 100%;" required>`;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = ''; 

            const modalInput = document.getElementById('modalInput');
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.className = 'btn-primary';
            saveButton.onclick = () => {
                const value = modalInput.value.trim();
                if (value) {
                    messageModal.style.display = 'none';
                    callback(value);
                } else {
                    modalInput.style.border = '1px solid var(--accent-red)';
                    modalInput.focus();
                }
            };
            modalButtons.appendChild(saveButton);

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.className = 'logout-btn';
            cancelButton.onclick = () => { messageModal.style.display = 'none'; };
            modalButtons.appendChild(cancelButton);

            messageModal.style.display = 'flex';
            modalInput.focus();
            modalInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); saveButton.click(); } });
        }

        document.querySelectorAll('.modal .close-button').forEach(btn => btn.onclick = () => { 
            const modal = btn.closest('.modal');
            modal.style.display = 'none'; 
            // If it's the video preview modal, stop the video playback
            if (modal.id === 'videoPreviewModal') {
                const videoContent = document.getElementById('videoPreviewContent');
                videoContent.innerHTML = ''; // Clear content to stop video
            }
            // If it's the PDF preview modal, stop PDF rendering
            if (modal.id === 'pdfPreviewModal') {
                pdfDoc = null; // Clear PDF document reference
                document.getElementById('pdfCanvas').getContext('2d').clearRect(0, 0, document.getElementById('pdfCanvas').width, document.getElementById('pdfCanvas').height);
                document.getElementById('pdfPageNum').textContent = '';
                document.getElementById('pdfTotalPages').textContent = '';
            }
        });

        const themeToggleButton = document.getElementById('themeToggleButton');
        function applyTheme(theme) { 
            document.body.classList.toggle('light-theme', theme === 'light'); 
        }
        function loadTheme() { 
            const savedTheme = localStorage.getItem('ai-marker-theme') || 'dark';
            applyTheme(savedTheme); 
        }
        themeToggleButton.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('ai-marker-theme', newTheme);
        });

        loadTheme();

        // --- FINDER WINDOW LOGIC ---
        let finderCurrentPath = []; // Stores [type, level1Id, level2Id]
        let finderCurrentType = null; // 'tutorials', 'pastPapers', 'exercises'
        let minimizedWindows = {}; // Stores minimized window states: {type: {left, top, width, height}}

        function showFinderView(type) {
            const finderWindow = document.getElementById('finderMaterialsSection');
            const finderSidebar = document.getElementById('finderSidebar');
            const finderFileListContent = document.getElementById('finderFileListContent');
            
            finderCurrentType = type; // Set the current type for the finder window
            finderCurrentPath = [type]; // Initialize path with type when opening new type

            // Update title bar
            finderWindow.querySelector('.finder-titlebar span').textContent = materialsConfig[type].title;

            // Show finder window
            finderWindow.style.display = 'flex';
            finderWindow.classList.remove('fullscreen'); // Ensure it's not fullscreen by default
            finderWindow.style.top = '50%'; // Reset position
            finderWindow.style.left = '50%';
            finderWindow.style.transform = 'translate(-50%, -50%)';
            finderWindow.style.width = '90vw'; // Reset size
            finderWindow.style.height = '90vh';
            finderWindow.style.maxWidth = '1200px';
            finderWindow.style.maxHeight = '800px';

            // Load Level 1 items into sidebar
            loadFinderSidebar(type);
            finderFileListContent.innerHTML = `<p style="text-align:center; padding:20px; color:var(--finder-text-secondary);">Select a ${materialsConfig[type].level1.toLowerCase()} from the sidebar.</p>`;
        }

        async function loadFinderSidebar(type) {
            const finderSidebar = document.getElementById('finderSidebar');
            finderSidebar.innerHTML = `<p class="loading-indicator">Loading subjects...</p>`;
            const config = materialsConfig[type];
            const collectionRef = collection(db, getPath(type));
            const q = query(collectionRef, orderBy('name', 'asc'));

            try {
                const snapshot = await getDocs(q);
                finderSidebar.innerHTML = '';
                if (snapshot.empty) {
                    finderSidebar.innerHTML = `<p style="padding:10px;">No ${config.level1.toLowerCase()}s found.</p>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const item = doc.data();
                    const el = document.createElement('div');
                    el.className = 'finder-sidebar-item';
                    el.textContent = item.name;
                    el.dataset.id = doc.id;
                    el.dataset.level = 1;
                    el.dataset.type = type;
                    el.addEventListener('click', handleFinderSidebarClick);
                    finderSidebar.appendChild(el);
                });
            } catch (error) {
                console.error("Error loading finder sidebar:", error);
                finderSidebar.innerHTML = `<p class="error-message" style="padding:10px;">Error loading subjects.</p>`;
            }
        }

        async function handleFinderSidebarClick(e) {
            const item = e.target;
            const type = item.dataset.type;
            const level1Id = item.dataset.id;
            finderCurrentPath = [type, level1Id];
            
            // Highlight active sidebar item
            document.querySelectorAll('.finder-sidebar-item').forEach(el => el.classList.remove('active'));
            item.classList.add('active');

            // Load Level 2 items into file list
            await loadFinderFileList(type, [level1Id], 2);
        }

        async function loadFinderFileList(type, parentIds, level) {
            const finderFileListContent = document.getElementById('finderFileListContent');
            finderFileListContent.innerHTML = `<p class="loading-indicator">Loading items...</p>`;
            const config = materialsConfig[type];
            // Adjust path for assignments
            const collectionPath = type === 'assignments' 
                                 ? `artifacts/${appId}/public/data/assignments/${parentIds[0]}/assignments`
                                 : getPath(type, parentIds);
            const collectionRef = collection(db, collectionPath);

            const q = query(collectionRef, orderBy('name', level === 2 ? 'desc' : 'asc')); // Order years descending

            try {
                const snapshot = await getDocs(q);
                finderFileListContent.innerHTML = '';
                if (snapshot.empty) {
                    finderFileListContent.innerHTML = `<p style="text-align:center; padding:20px; color:var(--finder-text-secondary);">No items found here.</p>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const item = doc.data();
                    item.id = doc.id; // Ensure ID is part of the item data
                    const el = document.createElement('div');
                    el.className = 'row';
                    el.dataset.id = doc.id;
                    el.dataset.level = level;
                    el.dataset.type = type;
                    el.dataset.parentIds = JSON.stringify(parentIds); // Store parent IDs for drill-down

                    let icon = '';
                    let size = ''; // Placeholder for file size
                    let kind = ''; // Placeholder for file type
                    let dateAdded = item.timestamp ? new Date(item.timestamp).toLocaleDateString() : 'N/A';
                    if (type === 'assignments' && item.createdAt) {
                        dateAdded = new Date(item.createdAt).toLocaleDateString();
                    }

                    if (level === 2) { // Folder for Level 2 (Topic/Year or Assignment for assignments)
                        el.classList.add('folder');
                        icon = '📁 ';
                        kind = config.level2;
                        el.addEventListener('click', async () => {
                            finderCurrentPath = [...parentIds, doc.id];
                            await loadFinderFileList(type, finderCurrentPath, 3);
                        });
                    } else if (level === 3) { // Actual file (Video, Paper, Exercise, or Assignment itself for assignments)
                        el.classList.add('file');
                        icon = (type === 'tutorials' ? '🎬 ' : (type === 'exercises' ? '📝 ' : '📄 '));
                        kind = config.level3;
                        // For files, add a click listener to preview/download
                        el.addEventListener('click', () => {
                            // If it's an assignment, the item.name is the title, so pass item itself to handlePreview
                            handlePreview(type, item);
                        });
                    }

                    el.innerHTML = `
                        <div>${icon}${item.name || item.title}</div>
                        <div>${size}</div>
                        <div>${kind}</div>
                        <div>${dateAdded}</div>
                    `;
                    finderFileListContent.appendChild(el);
                });
            } catch (error) {
                console.error("Error loading finder file list:", error);
                finderFileListContent.innerHTML = `<p class="error-message" style="text-align:center; padding:20px;">Error loading items.</p>`;
            }
        }


        function setupFinderWindow() {
            const finderWindow = document.getElementById('finderMaterialsSection');
            const dragBar = document.getElementById('finderDragBar');
            const fullscreenToggle = document.getElementById('finderFullscreenToggle');
            const minimizeButton = finderWindow.querySelector('.finder-circle.min'); // Get the minimize button

            let isDragging = false, offsetX = 0, offsetY = 0;
            
            // Prevent text selection during drag
            dragBar.addEventListener('selectstart', (e) => e.preventDefault());

            dragBar.addEventListener('mousedown', (e) => {
                isDragging = true;
                // Remove the transform to allow direct manipulation of left/top
                finderWindow.style.transform = 'none';
                // Calculate offset relative to the window's current position
                offsetX = e.clientX - finderWindow.getBoundingClientRect().left;
                offsetY = e.clientY - finderWindow.getBoundingClientRect().top;
                finderWindow.style.cursor = 'grabbing';
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                finderWindow.style.cursor = 'grab';
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    // Update window position based on mouse movement
                    let newLeft = e.clientX - offsetX;
                    let newTop = e.clientY - offsetY;

                    // Ensure window stays within viewport
                    const maxX = window.innerWidth - finderWindow.offsetWidth;
                    const maxY = window.innerHeight - finderWindow.offsetHeight;

                    finderWindow.style.left = Math.max(0, Math.min(newLeft, maxX)) + 'px';
                    finderWindow.style.top = Math.max(0, Math.min(newTop, maxY)) + 'px';
                }
            });

            let isFullscreen = false;
            fullscreenToggle.addEventListener('click', () => {
                if (!isFullscreen) {
                    finderWindow.classList.add('fullscreen');
                    // When going fullscreen, also remove transform and set explicit 0,0
                    finderWindow.style.transform = 'none';
                    finderWindow.style.top = '0';
                    finderWindow.style.left = '0';
                    isFullscreen = true;
                } else {
                    finderWindow.classList.remove('fullscreen');
                    // When exiting fullscreen, reset to default centered position
                    finderWindow.style.top = '50%';
                    finderWindow.style.left = '50%';
                    finderWindow.style.transform = 'translate(-50%, -50%)';
                    finderWindow.style.width = '90vw'; // Restore default width
                    finderWindow.style.height = '90vh'; // Restore default height
                    finderWindow.style.maxWidth = '1200px'; // Restore max width
                    finderWindow.style.maxHeight = '800px'; // Restore max height
                    isFullscreen = false;
                }
            });

            // Handle close button
            finderWindow.querySelector('.finder-circle.close').addEventListener('click', () => {
                finderWindow.style.display = 'none';
                currentMaterialViewMode = 'card'; // Revert to card view
                // Re-render the currently active material section in card view
                const activeMaterialSectionId = ['tutorialSection', 'pastPapersSection', 'exerciseSection'].find(id => document.getElementById(id).style.display !== 'none');
                if (activeMaterialSectionId) {
                    document.getElementById(activeMaterialSectionId).classList.remove('hidden-on-desktop');
                    const type = Object.keys(materialsConfig).find(key => materialsConfig[key].sectionId === activeMaterialSectionId);
                    if (type) renderStudentItems(type); // Re-render the card view
                }
                // When closing, reset position to default centered state for next open
                finderWindow.style.top = '50%';
                finderWindow.style.left = '50%';
                finderWindow.style.transform = 'translate(-50%, -50%)';
                finderWindow.style.width = '90vw';
                finderWindow.style.height = '90vh';
                finderWindow.style.maxWidth = '1200px';
                finderWindow.style.maxHeight = '800px';
                finderWindow.classList.remove('fullscreen'); // Ensure fullscreen class is removed
            });

            // Handle minimize button
            minimizeButton.addEventListener('click', () => {
                minimizeFinderWindow();
            });
        }

        function minimizeFinderWindow() {
            const finderWindow = document.getElementById('finderMaterialsSection');
            const minimizedWindowsBar = document.getElementById('minimizedWindowsBar');
            const type = finderCurrentType; // Get the current type of material being viewed

            if (!type) return; // Should not happen if a material section is open

            // Store current position and size for restoration
            const rect = finderWindow.getBoundingClientRect();
            minimizedWindows[type] = {
                left: rect.left,
                top: rect.top,
                width: rect.width,
                height: rect.height,
                isFullscreen: finderWindow.classList.contains('fullscreen')
            };

            // Create a new tab for the minimized window
            const tab = document.createElement('div');
            tab.className = 'minimized-tab';
            tab.dataset.type = type;
            tab.innerHTML = `
                <span>${materialsConfig[type].title}</span>
                <button class="close-tab-btn">✖</button>
            `;
            minimizedWindowsBar.appendChild(tab);

            // Calculate target position for animation (center of the new tab)
            // This requires the tab to be rendered first to get its position
            const tabRect = tab.getBoundingClientRect();
            const targetX = tabRect.left + tabRect.width / 2;
            const targetY = tabRect.top + tabRect.height / 2;

            // Set CSS variables for animation
            finderWindow.style.setProperty('--target-x', `${targetX - window.innerWidth / 2}px`); // Relative to center
            finderWindow.style.setProperty('--target-y', `${targetY - window.innerHeight / 2}px`); // Relative to center

            // Apply minimize animation
            finderWindow.classList.add('minimizing');
            finderWindow.classList.remove('restoring'); // Ensure no conflicting animation

            finderWindow.addEventListener('animationend', function handler() {
                finderWindow.style.display = 'none';
                finderWindow.classList.remove('minimizing');
                minimizedWindowsBar.classList.add('active'); // Show the bar
                this.removeEventListener('animationend', handler);
            });

            // Handle click on the minimized tab to restore
            tab.addEventListener('click', (e) => {
                if (e.target.classList.contains('close-tab-btn')) {
                    // If close button on tab is clicked, remove the tab and clear state
                    e.stopPropagation(); // Prevent tab click from restoring
                    delete minimizedWindows[type];
                    tab.remove();
                    if (Object.keys(minimizedWindows).length === 0) {
                        minimizedWindowsBar.classList.remove('active');
                    }
                } else {
                    restoreFinderWindow(type, tab);
                }
            });
        }

        function restoreFinderWindow(type, tabElement) {
            const finderWindow = document.getElementById('finderMaterialsSection');
            const minimizedWindowsBar = document.getElementById('minimizedWindowsBar');
            const storedState = minimizedWindows[type];

            if (!storedState) return; // No stored state for this window

            // Remove the tab from the bar
            tabElement.remove();
            delete minimizedWindows[type];
            if (Object.keys(minimizedWindows).length === 0) {
                minimizedWindowsBar.classList.remove('active');
            }

            // Calculate start position for animation (center of the tab)
            const tabRect = tabElement.getBoundingClientRect();
            const startX = tabRect.left + tabRect.width / 2;
            const startY = tabRect.top + tabRect.height / 2;

            // Set CSS variables for animation
            finderWindow.style.setProperty('--start-x', `${startX - window.innerWidth / 2}px`); // Relative to center
            finderWindow.style.setProperty('--start-y', `${startY - window.innerHeight / 2}px`); // Relative to center

            // Reset position and size before animation starts
            finderWindow.style.display = 'flex';
            finderWindow.style.left = `${storedState.left}px`;
            finderWindow.style.top = `${storedState.top}px`;
            finderWindow.style.width = `${storedState.width}px`;
            finderWindow.style.height = `${storedState.height}px`;
            finderWindow.style.transform = 'none'; // Ensure transform is not interfering initially

            // Apply restore animation
            finderWindow.classList.add('restoring');
            finderWindow.classList.remove('minimizing'); // Ensure no conflicting animation

            if (storedState.isFullscreen) {
                finderWindow.classList.add('fullscreen');
            }

            finderWindow.addEventListener('animationend', function handler() {
                finderWindow.classList.remove('restoring');
                // Re-apply original transform for centering if not fullscreen
                if (!storedState.isFullscreen) {
                    finderWindow.style.transform = 'translate(-50%, -50%)';
                }
                this.removeEventListener('animationend', handler);
            });
        }

        // Adjust view mode on window resize - ensure finder window state is handled
        window.addEventListener('resize', () => {
            const isDesktop = window.innerWidth >= 769;
            const finderSection = document.getElementById('finderMaterialsSection');
            const activeMaterialSectionId = ['tutorialSection', 'pastPapersSection', 'exerciseSection'].find(id => document.getElementById(id).style.display !== 'none');
            
            if (isDesktop && currentMaterialViewMode === 'finder') {
                finderSection.style.display = 'flex';
                if (activeMaterialSectionId) document.getElementById(activeMaterialSectionId).classList.add('hidden-on-desktop');
            } else if (!isDesktop && currentMaterialViewMode === 'finder') {
                finderSection.style.display = 'none';
                if (activeMaterialSectionId) document.getElementById(activeMaterialSectionId).classList.remove('hidden-on-desktop');
            } else if (isDesktop && currentMaterialViewMode === 'card') {
                finderSection.style.display = 'none';
                if (activeMaterialSectionId) document.getElementById(activeMaterialSectionId).classList.remove('hidden-on-desktop');
            }
            // If it's mobile and in card view, no change needed.

            // Re-center finder window on resize if not fullscreen and not minimized
            if (finderSection.style.display === 'flex' && !finderSection.classList.contains('fullscreen')) {
                finderSection.style.left = '50%';
                finderSection.style.top = '50%';
                finderWindow.style.transform = 'translate(-50%, -50%)';
            }
        });

        // --- PDF PREVIEW LOGIC ---
        let pdfDoc = null; // Stores PDF document
        let pageNum = 1; // Current page number

        const pdfPreviewModal = document.getElementById('pdfPreviewModal');
        const pdfCanvas = document.getElementById('pdfCanvas');
        const pdfContext = pdfCanvas.getContext('2d');
        const pdfPageNumSpan = document.getElementById('pdfPageNum');
        const pdfTotalPagesSpan = document.getElementById('pdfTotalPages');
        const prevPdfPageBtn = document.getElementById('prevPdfPage');
        const nextPdfPageBtn = document.getElementById('nextPdfPage');

        prevPdfPageBtn.addEventListener('click', () => {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        });

        nextPdfPageBtn.addEventListener('click', () => {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        });

        function showPdfPreviewModal(title, pdfUrl) {
            document.getElementById('pdfPreviewTitle').textContent = title;
            pdfPreviewModal.style.display = 'flex';
            loadPdf(pdfUrl);
        }

        async function loadPdf(pdfUrl) {
            pdfDoc = null;
            pageNum = 1;
            pdfPageNumSpan.textContent = '';
            pdfTotalPagesSpan.textContent = '';
            pdfContext.clearRect(0, 0, pdfCanvas.width, pdfCanvas.height); // Clear canvas

            try {
                const loadingTask = pdfjsLib.getDocument(pdfUrl);
                pdfDoc = await loadingTask.promise;
                pdfTotalPagesSpan.textContent = pdfDoc.numPages;
                queueRenderPage(pageNum);
            } catch (error) {
                console.error('Error loading PDF:', error);
                showModal('PDF Load Error', `Failed to load PDF: ${error.message}`);
                pdfPreviewModal.style.display = 'none'; // Close modal on error
            }
        }

        let pageRendering = false;
        let pageNumPending = null;

        function renderPage(num) {
            pageRendering = true;
            pdfPageNumSpan.textContent = num;

            // Fetch the page
            pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({ scale: 1.5 }); // Adjust scale as needed for better resolution
                
                // Set canvas dimensions to match viewport
                pdfCanvas.height = viewport.height;
                pdfCanvas.width = viewport.width;

                // Render PDF page into canvas context
                const renderContext = {
                    canvasContext: pdfContext,
                    viewport: viewport
                };
                const renderTask = page.render(renderContext);

                // Wait for rendering to finish
                renderTask.promise.then(function() {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        // New page rendering is pending
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                    updatePdfNavButtons();
                });
            }).catch(error => {
                console.error('Error rendering PDF page:', error);
                showModal('PDF Render Error', `Failed to render page ${num}: ${error.message}`);
                pageRendering = false;
                pageNumPending = null;
                updatePdfNavButtons();
            });
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function updatePdfNavButtons() {
            prevPdfPageBtn.disabled = pageNum <= 1;
            nextPdfPageBtn.disabled = pageNum >= pdfDoc.numPages;
        }

    </script>
</body>
</html>
