<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Exam Grader</title>
    <!-- Tailwind CSS for basic styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js CDN for PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        /* Custom styles for the Inter font and rounded corners, inspired by Google Material Design */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f7f9fa; /* Very light gray, almost white, like Google's background */
            display: flex;
            flex-direction: column; /* Allow content and footer to stack */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
        .container {
            background-color: #ffffff;
            padding: 40px; /* Increased padding for more breathing room */
            border-radius: 8px; /* Slightly less rounded, more modern card look */
            /* Subtle, multi-layer shadow like Google's cards */
            box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
            max-width: 900px;
            width: 100%;
            flex-shrink: 0; /* Prevent container from shrinking due to footer */
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        input[type="text"],
        input[type="email"], /* Added email type for consistency */
        input[type="file"],
        textarea {
            border-color: #dadce0; /* Softer, Google-like border color */
            border-width: 1px;
            padding: 12px 16px; /* Increased padding for inputs */
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="file"]:focus,
        textarea:focus {
            border-color: #4285F4; /* Google blue for focus */
            box-shadow: 0 0 0 1px #4285F4; /* Subtle glow on focus */
            outline: none; /* Remove default outline */
        }
        button {
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 4px; /* Slightly less rounded buttons */
            padding: 12px 24px; /* Consistent button padding */
            font-weight: 600; /* Slightly bolder text */
            display: flex; /* For icon alignment */
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space between text and icon */
        }
        button:hover {
            transform: translateY(-1px); /* Slight lift on hover */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow on hover */
        }
        .loading-indicator { /* Common class for all loading indicators */
            display: none;
            color: #4f46e5;
            font-weight: 500;
            text-align: center;
            margin-top: 1rem;
        }
        #resultContainer {
            min-height: 100px;
            background-color: #ecf0f1;
            padding: 16px;
            border-radius: 8px;
            white-space: pre-wrap;
            border: 1px solid #dadce0; /* Add a light border to the result container */
        }
        .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #dadce0; /* Border for the file input wrapper */
            border-radius: 8px; /* Rounded corners for wrapper */
            padding: 8px; /* Padding inside wrapper */
            background-color: #fcfcfc; /* Slightly off-white background */
        }
        .file-input-wrapper input[type="file"] {
            flex-grow: 1;
            border: none; /* Remove individual border for actual input */
            padding: 0; /* Remove individual padding */
        }
        .file-input-wrapper input[type="file"]::before {
            content: 'Choose File'; /* Custom button text */
            display: inline-block;
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 8px 12px;
            outline: none;
            white-space: nowrap;
            -webkit-user-select: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 10pt;
        }
        .file-input-wrapper input[type="file"]:hover::before {
            border-color: black;
        }
        .file-input-wrapper input[type="file"]:active::before {
            background: -webkit-linear-gradient(top, #e3e3e3, #f0f0f0);
        }

        .file-preview {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: 200px; /* Limit preview height */
            object-fit: contain; /* Ensure image fits without cropping */
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out; /* Fade-in animation */
        }
        .modal-content {
            background-color: #fff;
            padding: 30px; /* Increased modal padding */
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            animation: slideIn 0.3s ease-out; /* Slide-in animation */
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px; /* Larger close button */
            cursor: pointer;
            color: #aaa;
        }
        .close-button:hover {
            color: #555;
        }
        /* Google Sign-In Button style */
        .google-btn {
            background-color: #4285F4; /* Google Blue */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
        }
        .google-btn:hover {
            background-color: #357ae8; /* Darker blue on hover */
        }
        .google-icon {
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
        }
        .google-icon img {
            width: 20px;
            height: 20px;
        }
        /* CSS Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .btn-primary {
            background-image: linear-gradient(to right, #6366f1, #4f46e5); /* Indigo gradient */
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-image: linear-gradient(to right, #4f46e5, #4338ca); /* Darker gradient on hover */
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-grade {
            background-image: linear-gradient(to right, #22c55e, #10b981); /* Green gradient */
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-grade:hover {
            background-image: linear-gradient(to right, #10b981, #059669); /* Darker green gradient on hover */
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-logout {
            background-color: #ef4444; /* Red */
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-logout:hover {
            background-color: #dc2626; /* Darker red */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }
        .btn-secondary { /* For remove student button */
            background-color: #cbd5e1; /* Gray-300 */
            color: #334155; /* Slate-700 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 8px 16px;
            font-size: 0.875rem;
        }
        .btn-secondary:hover {
            background-color: #94a3b8; /* Gray-400 */
            color: #1e293b; /* Slate-900 */
        }


        /* Chat specific styles */
        #chatDisplay {
            height: 400px; /* Fixed height for chat history */
            overflow-y: auto; /* Scrollable */
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 16px;
            background-color: #fcfcfc;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .chat-message.user {
            background-color: #e0f2f7; /* Light blue for user */
            align-self: flex-end; /* Align right */
            border-bottom-right-radius: 4px;
        }
        .chat-message.gemini {
            background-color: #f0f4f8; /* Light gray for Gemini */
            align-self: flex-start; /* Align left */
            border-bottom-left-radius: 4px;
        }
        #chatInput {
            border-radius: 20px; /* More rounded chat input */
            padding-right: 50px; /* Space for send button */
        }
        #sendChatButton {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background-color: transparent;
            color: #4285F4; /* Google blue */
            border: none;
            padding: 0;
            cursor: pointer;
            font-size: 24px; /* Larger icon */
        }
        #sendChatButton:hover {
            color: #357ae8;
        }
        .chat-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        /* Specific styles for animated sections */
        #gradingSection, #chatSection, #studentManagementSection {
            opacity: 0; /* Start hidden for transition */
            transition: opacity 0.5s ease-in-out; /* Apply transition effect */
            height: auto; /* Allow height to adjust */
        }

        /* Footer styles */
        footer {
            margin-top: auto; /* Pushes footer to the bottom */
            text-align: center;
            color: #71717a; /* Gray-600 */
            font-size: 0.875rem; /* text-sm */
            padding: 20px;
            width: 100%;
            max-width: 900px; /* Match container width */
            margin-left: auto;
            margin-right: auto;
        }
        footer p {
            margin-bottom: 5px; /* Small space between lines */
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .app-header-content {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            .app-header-logo-text {
                text-align: center;
                margin-bottom: 10px;
            }
            .app-header-buttons {
                flex-direction: column;
                width: 100%;
            }
            .app-header-buttons button {
                width: 100%;
            }
            #gradingSection, #chatSection, #studentManagementSection {
                min-height: 500px; /* Ensure sections have some minimum height on small screens */
            }
        }
    </style>
</head>
<body class="antialiased">
    <div id="authSection" class="container flex flex-col gap-8 items-center" style="display: none;">
        <!-- Custom Logo (Ensure media.jpg is in the same directory as index.html on your server/GitHub) -->
        <img src="media.jpg" alt="3-SHOT Logo" class="w-auto h-24 mb-4">
        <h1 class="text-3xl font-semibold text-center text-gray-800">Gemini Grader</h1>
        <p class="text-gray-600 text-lg mb-6">Operated by Darren Ng</p>

        <button id="googleSignInButton" class="google-btn rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 w-full max-w-xs">
            <span class="google-icon">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
            </span>
            Sign in with Google
        </button>

        <p id="authError" class="error-message text-center"></p>
        <p id="unauthorizedMessage" class="error-message text-center mt-4" style="display: none;">
            Your account is not authorized to use this application. Please contact the administrator.
        </p>
    </div>

    <div id="appSection" class="container flex flex-col gap-6" style="display: none;">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4 app-header-content">
            <!-- Left-aligned Logo and Operated By -->
            <div class="flex items-center gap-2 app-header-logo-text">
                <img src="media.jpg" alt="3-SHOT Logo" class="w-auto h-10">
                <div class="flex flex-col items-start">
                    <h1 class="text-xl font-extrabold text-gray-800">Gemini Grader</h1>
                    <p class="text-gray-600 text-sm">Operated by Darren Ng</p>
                </div>
            </div>

            <!-- Right-aligned user info and buttons -->
            <div class="flex items-center gap-4 app-header-buttons">
                <span id="userDisplayName" class="text-gray-600 text-base font-medium"></span>
                <!-- Toggle Buttons for Grading vs Chat -->
                <button id="toggleGradingButton" class="btn-primary text-sm py-2 px-4">
                    Exam Grader
                </button>
                <button id="toggleChatButton" class="btn-primary text-sm py-2 px-4">
                    Chat with Gemini
                </button>
                <button id="manageStudentsButton" class="btn-primary text-sm py-2 px-4" style="display: none;">
                    Manage Students
                </button>
                <button id="logoutButton" class="btn-logout text-sm py-2 px-4">
                    Log Out
                </button>
            </div>
        </div>

        <!-- Grading Section -->
        <div id="gradingSection" class="w-full" style="display: block; opacity: 0;">
            <div class="mb-4">
                <label for="studentAnswerFile" class="block text-gray-700 text-sm font-semibold mb-2">Upload Student's Work (Image or PDF):</label>
                <div class="file-input-wrapper">
                    <input type="file" id="studentAnswerFile" accept="image/*,application/pdf" class="shadow-sm appearance-none rounded-lg py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                    <span id="studentFileName" class="text-gray-500 text-sm">No file chosen</span>
                </div>
                <img id="studentFilePreview" class="file-preview mx-auto" style="display: none;" alt="Student Work Preview">
                <label for="studentAnswer" class="block text-gray-700 text-sm font-semibold mt-4 mb-2">Or type Student's Answer:</label>
                <textarea id="studentAnswer" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" placeholder="Enter student's answer here..."></textarea>
                <p id="studentAnswerError" class="error-message"></p>
            </div>

            <div class="mb-6">
                <label for="answerKeyFile" class="block text-gray-700 text-sm font-semibold mb-2">Upload Answer Key (Image or PDF):</label>
                <div class="file-input-wrapper">
                    <input type="file" id="answerKeyFile" accept="image/*,application/pdf" class="shadow-sm appearance-none rounded-lg py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                    <span id="answerKeyFileName" class="text-gray-500 text-sm">No file chosen</span>
                </div>
                <img id="answerKeyFilePreview" class="file-preview mx-auto" style="display: none;" alt="Answer Key Preview">
                <label for="answerKey" class="block text-gray-700 text-sm font-semibold mt-4 mb-2">Or type Answer Key:</label>
                <textarea id="answerKey" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" placeholder="Enter the correct answer key here..."></textarea>
                <p id="answerKeyError" class="error-message"></p>
            </div>

            <button id="gradeButton" class="btn-primary btn-grade py-3 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle-2"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
                Grade Work
            </button>

            <p id="gradingLoadingIndicator" class="loading-indicator"></p>

            <div id="resultContainer" class="mt-6 border border-gray-300 rounded-lg p-5">
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Grading Results:</h2>
                <p id="gradeResult" class="text-gray-900 leading-relaxed">Your grading results will appear here after submission.</p>
            </div>

            <div class="mt-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Past Submissions:</h2>
                <div id="pastSubmissions" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <p id="noSubmissions" class="text-gray-500">No past submissions found.</p>
                </div>
            </div>
        </div>

        <!-- Chat Section -->
        <div id="chatSection" class="w-full flex flex-col gap-4" style="display: none; opacity: 0;">
            <div id="chatDisplay" class="flex-grow">
                <!-- Chat messages will be appended here -->
                <div class="chat-message gemini">Hello! I'm Gemini. How can I help you today?</div>
            </div>
            <div class="chat-input-wrapper flex items-center gap-2">
                <input type="text" id="chatInput" class="w-full py-3 px-4 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" placeholder="Type your message...">
                <button id="sendChatButton" class="px-3 py-2 rounded-full text-blue-600 hover:bg-blue-100 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4 20-7Z"/><path d="M15 9l-6 6"/></svg>
                </button>
            </div>
            <p id="chatLoadingIndicator" class="loading-indicator"></p>
        </div>

        <!-- Student Management Section (Teacher Only) -->
        <div id="studentManagementSection" class="w-full flex flex-col gap-4" style="display: none; opacity: 0;">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Authorized Students</h2>
            <div class="flex flex-col md:flex-row gap-2 mb-4">
                <input type="email" id="studentEmailInput" class="shadow-sm appearance-none border rounded-lg py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 flex-grow" placeholder="Enter student's Gmail address">
                <button id="addStudentButton" class="btn-primary py-3 px-6 rounded-lg">
                    Add Student
                </button>
            </div>
            <p id="studentManagementLoading" class="loading-indicator"></p>
            <div id="authorizedStudentsList" class="border border-gray-300 rounded-lg p-4 bg-gray-50 max-h-80 overflow-y-auto">
                <p id="noAuthorizedStudents" class="text-gray-500 text-center">No authorized students yet.</p>
                <!-- Students will be listed here -->
            </div>
        </div>

    </div>

    <!-- Custom Modal for General Messages -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle" class="text-xl font-bold mb-3"></h3>
            <p id="modalMessage" class="text-gray-700"></p>
            <div id="modalButtons" class="flex justify-end gap-2 mt-4"></div>
        </div>
    </div>

    <!-- Global Footer -->
    <footer>
        <p>Contact: <a href="mailto:darren_0625@mc-zero.com" class="text-blue-600 hover:underline">darren_0625@mc-zero.com</a></p>
        <p>Copyright Â© 2025 Operated by Darren Ng</p>
    </footer>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";


        // IMPORTANT: Replace these with your actual Firebase project config.
        // Get this from your Firebase Console -> Project settings -> Your apps -> Web app -> Config
        const FIREBASE_CONFIG_PLACEHOLDER = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI", // Your API Key
          authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30",
          storageBucket: "ai-grading-9bb30.firebasestorage.app",
          messagingSenderId: "298162112230",
          appId: "1:298162112230:web:529d3f95536991be685d27",
          measurementId: "G-CHKLKSM17S"
        };

        // This is the Canvas app ID (from the URL of THIS chat).
        // It's used for the Firestore data structure related to this specific artifact.
        const APP_ID_FROM_CANVAS_ENVIRONMENT = "c_03094e15";


        // Conditional assignment for running in Canvas vs. locally or on your own host
        const appId = typeof __app_id !== 'undefined' ? __app_id : APP_ID_FROM_CANVAS_ENVIRONMENT;
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : FIREBASE_CONFIG_PLACEHOLDER;

        // Configure pdf.js worker source
        pdfjsLib.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';


        let app;
        let db;
        let auth;
        let storage; // Declare storage variable
        let currentUserId = null;
        let currentUserRole = null;
        let currentUserName = null;
        let currentAuthReady = false; // Flag to indicate Firebase auth is ready

        // Gemini API Key for direct calls (not provided by Canvas environment)
        const GEMINI_API_KEY = "AIzaSyDdSvz-60i1YNk7jSGNvW1dUMKseRFMueQ"; // Your Gemini API Key here

        // Function to show custom modal for general messages
        function showModal(title, message, buttons = []) {
            const modal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = ''; // Clear previous buttons

            buttons.forEach(btnConfig => {
                const button = document.createElement('button');
                button.textContent = btnConfig.text;
                button.className = btnConfig.className || 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg';
                button.onclick = () => {
                    modal.style.display = 'none';
                    if (btnConfig.onClick) btnConfig.onClick();
                };
                modalButtons.appendChild(button);
            });

            modal.style.display = 'flex';
        }

        // Close button for general message modal
        document.querySelector('#messageModal .close-button').onclick = () => {
            document.getElementById('messageModal').style.display = 'none';
        };
        // Close modal if clicked outside
        window.onclick = (event) => {
            if (event.target === document.getElementById('messageModal')) {
                document.getElementById('messageModal').style.display = 'none';
            }
        };


        // Initialize Firebase
        try {
            if (!firebaseConfig || !firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                throw new Error("Firebase configuration is missing or incomplete. Please replace the placeholders in the HTML code with your actual Firebase project details.");
            }
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app); // Initialize Firebase Storage
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showModal('Firebase Error', `Failed to initialize Firebase. Please check the configuration. Details: ${error.message}`);
        }

        // --- Auth State Listener ---
        onAuthStateChanged(auth, async (user) => {
            console.log("onAuthStateChanged fired. User:", user ? user.uid : "null");
            if (user) {
                currentUserId = user.uid;
                currentUserName = user.displayName || user.email || 'Google User'; // Use Google name/email
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                const unauthorizedMessageElement = document.getElementById('unauthorizedMessage');
                unauthorizedMessageElement.style.display = 'none'; // Hide by default

                try {
                    // 1. Check if user is a teacher
                    const authorizedTeacherRef = doc(db, `artifacts/${appId}/authorized_users/teachers/${currentUserId}`);
                    const teacherAuthDoc = await getDoc(authorizedTeacherRef);

                    if (teacherAuthDoc.exists()) {
                        currentUserRole = 'teacher';
                        console.log("User is an authorized teacher.");
                    } else {
                        // 2. If not a teacher, check if user is an authorized student by email
                        const studentEmailsRef = collection(db, `artifacts/${appId}/authorized_users/student_emails`);
                        const q = query(studentEmailsRef, where("email", "==", user.email));
                        const studentAuthSnapshot = await getDocs(q);

                        if (!studentAuthSnapshot.empty) {
                            currentUserRole = 'student';
                            console.log("User is an authorized student.");
                        } else {
                            currentUserRole = 'unauthorized';
                            console.log("User is unauthorized.");
                        }
                    }

                    // Save or update user profile in their private collection
                    await setDoc(userProfileRef, {
                        role: currentUserRole,
                        name: currentUserName,
                        email: user.email, // Store email for future checks
                        lastLogin: Date.now()
                    }, { merge: true });

                    // Update UI based on role
                    if (currentUserRole === 'teacher' || currentUserRole === 'student') {
                        document.getElementById('userDisplayName').textContent = `Logged in as: ${currentUserName} (${currentUserRole})`;
                        document.getElementById('authSection').style.display = 'none';
                        document.getElementById('appSection').style.display = 'flex';
                        currentAuthReady = true;

                        // Show/hide teacher-specific buttons
                        const manageStudentsButton = document.getElementById('manageStudentsButton');
                        if (currentUserRole === 'teacher') {
                            manageStudentsButton.style.display = 'flex'; // Use flex to maintain button styling
                        } else {
                            manageStudentsButton.style.display = 'none'; // Ensure students don't see this
                        }

                        // Initially show grading section with fade-in
                        const gradingSection = document.getElementById('gradingSection');
                        gradingSection.style.display = 'block';
                        gradingSection.style.opacity = '0'; // Start at 0 for fade-in
                        setTimeout(() => { gradingSection.style.opacity = '1'; }, 50); // Small delay to trigger transition

                        document.getElementById('chatSection').style.display = 'none';
                        document.getElementById('studentManagementSection').style.display = 'none'; // Ensure this is hidden

                        await loadPastSubmissions();
                        if (currentUserRole === 'teacher') {
                            await loadAuthorizedStudents(); // Load students if teacher
                        }

                    } else { // Unauthorized user
                        document.getElementById('userDisplayName').textContent = `Not logged in`;
                        document.getElementById('authSection').style.display = 'flex';
                        document.getElementById('appSection').style.display = 'none';
                        unauthorizedMessageElement.style.display = 'block'; // Show unauthorized message
                        currentAuthReady = true; // Auth system is ready, user just not authorized
                    }

                } catch (error) {
                    console.error("Error fetching or setting user profile/role:", error);
                    currentAuthReady = true;
                    showModal('Profile Error', `Failed to load or assign user role. Details: ${error.message}`);
                    document.getElementById('authSection').style.display = 'flex';
                    document.getElementById('appSection').style.display = 'none';
                }

            } else {
                // User is logged out
                currentUserId = null;
                currentUserRole = null;
                currentUserName = null;
                console.log("User is logged out. Displaying auth section.");
                document.getElementById('userDisplayName').textContent = `Not logged in`;
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('appSection').style.display = 'none';
                unauthorizedMessageElement.style.display = 'none'; // Hide unauthorized message
                currentAuthReady = true; // Auth system is ready, no user.
            }
        });

        // --- Google Sign-In Function ---
        document.getElementById('googleSignInButton').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                console.log("Google Sign-In successful:", result.user);
                // onAuthStateChanged listener will handle UI update and role check.
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                const errorMessage = error.message;
                document.getElementById('authError').textContent = `Sign-in failed: ${errorMessage}`;
                showModal('Sign-In Error', `Failed to sign in with Google. Details: ${errorMessage}`);
            }
        });

        document.getElementById('logoutButton').addEventListener('click', async () => {
            try {
                currentUserRole = null;
                currentUserName = null;
                currentUserId = null;
                document.getElementById('userDisplayName').textContent = `Not logged in`;
                document.getElementById('appSection').style.display = 'none';
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('pastSubmissions').innerHTML = ''; // Clear past submissions
                document.getElementById('noSubmissions').style.display = 'block'; // Show no submissions message
                document.getElementById('authorizedStudentsList').innerHTML = ''; // Clear student list
                document.getElementById('noAuthorizedStudents').style.display = 'block'; // Show no students message
                document.getElementById('unauthorizedMessage').style.display = 'none'; // Ensure unauthorized message is hidden on logout


                await signOut(auth);
                showModal('Logged Out', 'You have been logged out successfully.');
            } catch (error) {
                console.error("Logout error:", error);
                showModal('Logout Error', `Failed to log out: ${error.message}`);
            }
        });

        // --- UI Section Toggle Functions (with transitions) ---
        function showSection(sectionIdToShow) {
            const sections = ['gradingSection', 'chatSection', 'studentManagementSection'];
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (id === sectionIdToShow) {
                    section.style.opacity = '0'; // Start hidden for transition
                    section.style.display = (id === 'chatSection' || id === 'studentManagementSection') ? 'flex' : 'block'; // Adjust display type
                    setTimeout(() => { section.style.opacity = '1'; }, 50); // Fade in
                } else {
                    section.style.opacity = '0'; // Fade out
                    setTimeout(() => { section.style.display = 'none'; }, 400); // Match CSS transition duration
                }
            });
        }

        document.getElementById('toggleGradingButton').addEventListener('click', () => showSection('gradingSection'));
        document.getElementById('toggleChatButton').addEventListener('click', () => showSection('chatSection'));
        document.getElementById('manageStudentsButton').addEventListener('click', () => {
            if (currentUserRole === 'teacher') {
                showSection('studentManagementSection');
                loadAuthorizedStudents(); // Reload list when showing
            } else {
                showModal('Access Denied', 'Only teachers can manage students.');
            }
        });


        // --- File Handling Functions ---
        // New function to upload file to Firebase Storage and return URL
        async function uploadFileToStorage(file, path) {
            if (!file) return null;
            const storageRef = ref(storage, path + '/' + file.name + '-' + Date.now()); // Unique filename
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            return downloadURL;
        }

        // Modified readFileAsBase64 to only handle PDF to image conversion
        // Direct image files will now be uploaded to Storage
        async function processFileForGemini(file) {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                return new Promise((resolve, reject) => {
                    reader.onload = () => resolve([{ type: file.type, data: reader.result.split(',')[1] }]);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            } else if (file.type === 'application/pdf') {
                try {
                    const loadingTask = pdfjsLib.getDocument({ url: URL.createObjectURL(file) });
                    const pdf = await loadingTask.promise;
                    const numPages = pdf.numPages;
                    const images = [];

                    // Show processing message for PDF
                    const originalLoadingText = gradingLoadingIndicator.textContent; // Use grading-specific indicator
                    gradingLoadingIndicator.style.display = 'block';
                    gradingLoadingIndicator.textContent = `Rendering PDF pages for AI: Page 1 of ${numPages}`;

                    for (let i = 1; i <= numPages; i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 2 }); // Scale for better resolution
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        images.push({ type: 'image/png', data: canvas.toDataURL('image/png').split(',')[1] });
                        canvas.remove(); // Clean up canvas element
                        if (i < numPages) { // Only update if more pages are coming
                            gradingLoadingIndicator.textContent = `Rendering PDF pages for AI: Page ${i + 1} of ${numPages}`;
                        }
                    }
                    gradingLoadingIndicator.style.display = 'none'; // Hide after processing
                    gradingLoadingIndicator.textContent = originalLoadingText; // Restore original text
                    return images; // Return array of image data
                } catch (error) {
                    gradingLoadingIndicator.style.display = 'none'; // Hide on error
                    throw new Error("Failed to render PDF: " + error.message);
                }
            } else {
                throw new Error("Unsupported file type. Please upload an image or PDF.");
            }
        }


        const gradeButton = document.getElementById('gradeButton');
        const studentAnswerInput = document.getElementById('studentAnswer');
        const answerKeyInput = document.getElementById('answerKey');
        const studentAnswerFile = document.getElementById('studentAnswerFile');
        const answerKeyFile = document.getElementById('answerKeyFile');
        const studentFileNameDisplay = document.getElementById('studentFileName');
        const answerKeyFileNameDisplay = document.getElementById('answerKeyFileName');
        const studentFilePreview = document.getElementById('studentFilePreview');
        const answerKeyFilePreview = document.getElementById('answerKeyFilePreview');
        const gradeResultDisplay = document.getElementById('gradeResult');
        const gradingLoadingIndicator = document.getElementById('gradingLoadingIndicator'); // Specific for grading
        const pastSubmissionsContainer = document.getElementById('pastSubmissions');
        const noSubmissionsMessage = document.getElementById('noSubmissions');

        studentAnswerFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                studentFileNameDisplay.textContent = file.name;
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        studentFilePreview.src = e.target.result;
                        studentFilePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else if (file.type === 'application/pdf') {
                    // For PDF preview, render the first page
                    const loadingTask = pdfjsLib.getDocument({ url: URL.createObjectURL(file) });
                    loadingTask.promise.then(pdf => {
                        pdf.getPage(1).then(page => {
                            const viewport = page.getViewport({ scale: 1.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            page.render({ canvasContext: context, viewport: viewport }).promise.then(() => {
                                studentFilePreview.src = canvas.toDataURL('image/png');
                                studentFilePreview.style.display = 'block';
                                canvas.remove();
                            });
                        });
                    }).catch(error => {
                        console.error("Error rendering PDF preview:", error);
                        studentFilePreview.src = "https://placehold.co/150x200/cccccc/000000?text=PDF+Error";
                        studentFilePreview.style.display = 'block';
                    });
                }
            } else {
                studentFileNameDisplay.textContent = 'No file chosen';
                studentFilePreview.style.display = 'none';
                studentFilePreview.src = '';
            }
        });

        answerKeyFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                answerKeyFileNameDisplay.textContent = file.name;
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        answerKeyFilePreview.src = e.target.result;
                        answerKeyFilePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else if (file.type === 'application/pdf') {
                    const loadingTask = pdfjsLib.getDocument({ url: URL.createObjectURL(file) });
                    loadingTask.promise.then(pdf => {
                        pdf.getPage(1).then(page => {
                            const viewport = page.getViewport({ scale: 1.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            page.render({ canvasContext: context, viewport: viewport }).promise.then(() => {
                                answerKeyFilePreview.src = canvas.toDataURL('image/png');
                                answerKeyFilePreview.style.display = 'block';
                                canvas.remove();
                            });
                        });
                    }).catch(error => {
                        console.error("Error rendering PDF preview:", error);
                        answerKeyFilePreview.src = "https://placehold.co/150x200/cccccc/000000?text=PDF+Error";
                        answerKeyFilePreview.style.display = 'block';
                    });
                }
            } else {
                answerKeyFileNameDisplay.textContent = 'No file chosen';
                answerKeyFilePreview.style.display = 'none';
                answerKeyFilePreview.src = '';
            }
        });


        // --- Load Past Submissions from Firestore ---
        async function loadPastSubmissions() {
            if (!currentAuthReady || !currentUserId) {
                console.log("Auth not ready or no user (currentUserId is null), skipping loading past submissions.");
                pastSubmissionsContainer.innerHTML = '';
                noSubmissionsMessage.style.display = 'block';
                return;
            }
            if (currentUserRole === 'unauthorized') { // Added check for unauthorized users
                pastSubmissionsContainer.innerHTML = '';
                noSubmissionsMessage.style.display = 'block';
                return;
            }

            pastSubmissionsContainer.innerHTML = ''; // Clear previous submissions
            noSubmissionsMessage.style.display = 'block'; // Show "No submissions" initially

            try {
                console.log(`Loading past submissions for user: ${currentUserId}`);
                // IMPORTANT: Ensure the path matches your Firestore security rules for private data
                const submissionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/submissions`);
                const q = query(submissionsCollectionRef, orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log("No past submissions found for this user.");
                    noSubmissionsMessage.style.display = 'block';
                    return;
                }

                noSubmissionsMessage.style.display = 'none'; // Hide "No submissions" if there are submissions
                console.log(`Found ${querySnapshot.docs.length} past submissions.`);

                querySnapshot.forEach((doc) => {
                    const submission = doc.data();
                    const submissionElement = document.createElement('div');
                    submissionElement.className = 'bg-gray-100 p-4 rounded-lg shadow-sm border border-gray-200';
                    let studentWorkHtml = '';
                    if (submission.studentAnswerText) {
                        studentWorkHtml += `<p class="text-gray-700"><strong>Student Answer (Text):</strong> ${submission.studentAnswerText.substring(0, 150)}${submission.studentAnswerText.length > 150 ? '...' : ''}</p>`;
                    }
                    // Display images from URLs stored in Firebase Storage
                    if (submission.studentAnswerFileUrls && submission.studentAnswerFileUrls.length > 0) {
                        studentWorkHtml += `<p class="text-gray-700 mt-2"><strong>Student Work (Files):</strong></p>`;
                        submission.studentAnswerFileUrls.forEach(url => {
                            // Check if it's an image for direct display, otherwise a link
                            if (url.match(/\.(jpeg|jpg|gif|png|webp)$/i)) { // Simple check for image extensions
                                studentWorkHtml += `<img src="${url}" class="w-full h-auto max-h-40 object-contain rounded mt-2">`;
                            } else { // Assume PDF or other
                                studentWorkHtml += `<a href="${url}" target="_blank" class="text-blue-600 hover:underline mt-2 block">${url.substring(url.lastIndexOf('/') + 1).split('?')[0]} (View PDF/File)</a>`;
                            }
                        });
                    }

                    let answerKeyHtml = '';
                    if (submission.answerKeyText) {
                        answerKeyHtml += `<p class="text-gray-700"><strong>Answer Key (Text):</strong> ${submission.answerKeyText.substring(0, 150)}${submission.answerKeyText.length > 150 ? '...' : ''}</p>`;
                    }
                    if (submission.answerKeyFileUrls && submission.answerKeyFileUrls.length > 0) {
                        answerKeyHtml += `<p class="text-gray-700 mt-2"><strong>Answer Key (Files):</strong></p>`;
                        submission.answerKeyFileUrls.forEach(url => {
                            if (url.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
                                answerKeyHtml += `<img src="${url}" class="w-full h-auto max-h-40 object-contain rounded mt-2">`;
                            } else {
                                answerKeyHtml += `<a href="${url}" target="_blank" class="text-blue-600 hover:underline mt-2 block">${url.substring(url.lastIndexOf('/') + 1).split('?')[0]} (View PDF/File)</a>`;
                            }
                        });
                    }


                    submissionElement.innerHTML = `
                        <h3 class="font-semibold text-lg text-gray-800 mb-2">Submission on ${new Date(submission.timestamp).toLocaleString()}</h3>
                        ${studentWorkHtml}
                        ${answerKeyHtml}
                        <div class="mt-4">
                            <p class="font-medium text-indigo-600"><strong>Gemini Grade:</strong></p>
                            <p class="text-gray-800 text-sm mt-1">${submission.geminiGrade || 'N/A'}</p>
                        </div>
                    `;
                    pastSubmissionsContainer.appendChild(submissionElement);
                });
            } catch (error) {
                console.error("Error loading past submissions:", error);
                showModal('Error Loading Submissions', `Could not load past submissions. Details: ${error.message}`);
            }
        }


        // --- Main Grading Logic ---
        gradeButton.addEventListener('click', async () => {
            // Ensure user is authenticated and has a role
            if (!currentUserId || !currentUserRole || currentUserRole === 'unauthorized') {
                showModal('Authentication Required', 'Please sign in with an authorized account to grade work.');
                return;
            }

            const studentAnswerText = studentAnswerInput.value.trim();
            const answerKeyText = answerKeyInput.value.trim();
            const studentFile = studentAnswerFile.files[0];
            const answerKeyFileObj = answerKeyFile.files[0];

            // Clear previous error messages
            document.getElementById('studentAnswerError').textContent = '';
            document.getElementById('answerKeyError').textContent = '';
            gradeResultDisplay.style.color = "black"; // Reset color

            if ((!studentAnswerText && !studentFile) || (!answerKeyText && !answerKeyFileObj)) {
                if (!studentAnswerText && !studentFile) {
                    document.getElementById('studentAnswerError').textContent = 'Please provide student answer via text or file.';
                }
                if (!answerKeyText && !answerKeyFileObj) {
                    document.getElementById('answerKeyError').textContent = 'Please provide answer key via text or file.';
                }
                gradeResultDisplay.textContent = "Please provide both student's answer (text, image, or PDF) and the answer key (text, image, or PDF).";
                gradeResultDisplay.style.color = "red";
                return;
            }

            gradingLoadingIndicator.style.display = 'block'; // Show loading indicator
            gradeButton.disabled = true; // Disable button during grading

            let studentInputForGemini = []; // Base64 images for Gemini
            let answerKeyInputForGemini = []; // Base64 images for Gemini
            let studentFileDownloadURLs = []; // URLs to store in Firestore
            let answerKeyFileDownloadURLs = []; // URLs to store in Firestore

            try {
                // Process and upload student file (if any)
                if (studentFile) {
                    gradingLoadingIndicator.textContent = `Uploading student file: ${studentFile.name}...`;
                    const fileExtension = studentFile.name.split('.').pop();
                    const fileNameForStorage = `student-work-${currentUserId}-${Date.now()}.${fileExtension}`;
                    const storagePath = `artifacts/${appId}/users/${currentUserId}/submissions_files/${fileNameForStorage}`;
                    const downloadURL = await uploadFileToStorage(studentFile, storagePath);
                    if (downloadURL) {
                        studentFileDownloadURLs.push(downloadURL);
                    }

                    // For Gemini, convert to Base64 images if it's an image or PDF
                    gradingLoadingIndicator.textContent = `Preparing student file for AI analysis...`;
                    studentInputForGemini = await processFileForGemini(studentFile);
                } else if (studentAnswerText) {
                    studentInputForGemini = [{ text: studentAnswerText }];
                }

                // Process and upload answer key file (if any)
                if (answerKeyFileObj) {
                    gradingLoadingIndicator.textContent = `Uploading answer key file: ${answerKeyFileObj.name}...`;
                    const fileExtension = answerKeyFileObj.name.split('.').pop();
                    const fileNameForStorage = `answer-key-${currentUserId}-${Date.now()}.${fileExtension}`;
                    const storagePath = `artifacts/${appId}/users/${currentUserId}/submissions_files/${fileNameForStorage}`;
                    const downloadURL = await uploadFileToStorage(answerKeyFileObj, storagePath);
                    if (downloadURL) {
                        answerKeyFileDownloadURLs.push(downloadURL);
                    }

                    // For Gemini, convert to Base64 images if it's an image or PDF
                    gradingLoadingIndicator.textContent = `Preparing answer key file for AI analysis...`;
                    answerKeyInputForGemini = await processFileForGemini(answerKeyFileObj);
                } else if (answerKeyText) {
                    answerKeyInputForGemini = [{ text: answerKeyText }];
                }


                gradingLoadingIndicator.textContent = 'Sending to Gemini for grading...';
                let geminiPromptParts = [];

                // Add student content to prompt (from processed files or text)
                if (studentInputForGemini.length > 0) {
                    geminiPromptParts.push({ text: "Here is the student's work:" });
                    studentInputForGemini.forEach(part => {
                        if (part.text) {
                            geminiPromptParts.push({ text: `"${part.text}"` });
                        } else if (part.data) {
                            geminiPromptParts.push({
                                inlineData: { mimeType: part.type, data: part.data }
                            });
                        }
                    });
                }


                // Add answer key content to prompt (from processed files or text)
                if (answerKeyInputForGemini.length > 0) {
                    geminiPromptParts.push({ text: "Here is the Answer Key:" }); // Separator for clarity
                    answerKeyInputForGemini.forEach(part => {
                        if (part.text) {
                            geminiPromptParts.push({ text: `"${part.text}"` });
                        } else if (part.data) {
                            geminiPromptParts.push({
                                inlineData: { mimeType: part.type, data: part.data }
                            });
                        }
                    });
                }


                // Add grading instructions to the prompt
                geminiPromptParts.push({ text: `\nYou are an expert exam grader.
                Compare the student's work/answer with the provided answer key.
                Provide a clear grade (e.g., "Excellent", "Good", "Needs Improvement", or a numerical score like "8/10").
                Also, provide specific feedback on what was correct, what was incorrect, and suggestions for improvement.
                Focus on providing detailed, constructive feedback.` });


                let chatHistory = [];
                chatHistory.push({ role: "user", parts: geminiPromptParts });
                const payload = { contents: chatHistory };
                // Your Gemini API Key
                const apiKey = GEMINI_API_KEY; // Use the globally defined API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();
                let geminiGrade = "No grade generated.";

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    geminiGrade = result.candidates[0].content.parts[0].text;
                } else {
                    gradeResultDisplay.textContent = "Could not get a valid response from the Gemini API. Please try again.";
                }

                // --- Save Submission to Firestore ---
                const submissionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/submissions`);
                const newSubmission = {
                    submittedBy: currentUserName,
                    submittedByRole: currentUserRole,
                    studentAnswerText: studentAnswerText || null,
                    studentAnswerFileUrls: studentFileDownloadURLs, // Store URLs here
                    studentFileName: studentFile ? studentFile.name : null,
                    answerKeyText: answerKeyText || null,
                    answerKeyFileUrls: answerKeyFileDownloadURLs, // Store URLs here
                    answerKeyFileName: answerKeyFileObj ? answerKeyFileObj.name : null,
                    geminiGrade: geminiGrade,
                    timestamp: Date.now()
                };
                await addDoc(submissionsCollectionRef, newSubmission);
                console.log("Submission saved to Firestore!");
                await loadPastSubmissions(); // Reload submissions to show the new one

            } catch (error) {
                console.error('Error in grading process:', error);
                gradeResultDisplay.textContent = `An error occurred while grading: ${error.message}. Please check the console for more details.`;
                showModal('Grading Error', `An unexpected error occurred during grading. Details: ${error.message}`);
            } finally {
                gradingLoadingIndicator.style.display = 'none'; // Hide loading indicator
                gradeButton.disabled = false; // Re-enable button
            }
        });

        // --- Gemini Chat Logic ---
        const chatDisplay = document.getElementById('chatDisplay');
        const chatInput = document.getElementById('chatInput');
        const sendChatButton = document.getElementById('sendChatButton');
        const chatLoadingIndicator = document.getElementById('chatLoadingIndicator');

        // Initial chat history with a greeting
        let geminiChatHistory = [{
            role: "model",
            parts: [{ text: "Hello! I'm Gemini. How can I help you today?" }]
        }];

        async function sendChatMessage() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            if (!currentUserId || !currentUserRole || currentUserRole === 'unauthorized') {
                showModal('Authentication Required', 'Please sign in with an authorized account to chat with Gemini.');
                return;
            }

            // Display user message
            appendMessage(userMessage, 'user');
            chatInput.value = ''; // Clear input

            // Add user message to history
            geminiChatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            chatLoadingIndicator.style.display = 'block'; // Show typing indicator
            sendChatButton.disabled = true;

            try {
                const payload = { contents: geminiChatHistory };
                const apiKey = GEMINI_API_KEY; // Use the globally defined API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();
                let geminiResponseText = "Sorry, I couldn't get a response. Please try again.";

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    geminiResponseText = result.candidates[0].content.parts[0].text;
                }

                // Add Gemini's response to history and display
                geminiChatHistory.push({ role: "model", parts: [{ text: geminiResponseText }] });
                appendMessage(geminiResponseText, 'gemini');

            } catch (error) {
                console.error('Error in Gemini chat:', error);
                const errorMessage = `An error occurred with the chat: ${error.message}. Please check the console.`;
                appendMessage(errorMessage, 'gemini'); // Display error in chat
                showModal('Chat Error', errorMessage);
            } finally {
                chatLoadingIndicator.style.display = 'none'; // Hide typing indicator
                sendChatButton.disabled = false;
                chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom
            }
        }

        function appendMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${sender}`;
            messageElement.textContent = text;
            chatDisplay.appendChild(messageElement);
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Auto-scroll to latest message
        }

        sendChatButton.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) { // Send on Enter, allow Shift+Enter for new line
                event.preventDefault();
                sendChatMessage();
            }
        });

        // --- Teacher: Student Management Logic ---
        const studentEmailInput = document.getElementById('studentEmailInput');
        const addStudentButton = document.getElementById('addStudentButton');
        const authorizedStudentsList = document.getElementById('authorizedStudentsList');
        const noAuthorizedStudentsMessage = document.getElementById('noAuthorizedStudents');
        const studentManagementLoading = document.getElementById('studentManagementLoading');


        // Live listener for authorized students (teacher view)
        let unsubscribeStudents = null; // To store the unsubscribe function

        async function loadAuthorizedStudents() {
            if (!currentAuthReady || currentUserRole !== 'teacher') {
                console.log("Not a teacher or auth not ready, skipping loading authorized students.");
                authorizedStudentsList.innerHTML = '';
                noAuthorizedStudentsMessage.style.display = 'block';
                return;
            }

            if (unsubscribeStudents) {
                unsubscribeStudents(); // Unsubscribe from previous listener if it exists
            }

            studentManagementLoading.style.display = 'block';
            studentManagementLoading.textContent = 'Loading authorized students...';
            authorizedStudentsList.innerHTML = ''; // Clear existing list
            noAuthorizedStudentsMessage.style.display = 'block'; // Show 'No students' by default

            try {
                const authorizedStudentsCollectionRef = collection(db, `artifacts/${appId}/authorized_users/student_emails`);
                const q = query(authorizedStudentsCollectionRef, orderBy('email')); // Order for consistent display

                // Use onSnapshot for real-time updates
                unsubscribeStudents = onSnapshot(q, (snapshot) => {
                    authorizedStudentsList.innerHTML = ''; // Clear list on every update
                    if (snapshot.empty) {
                        noAuthorizedStudentsMessage.style.display = 'block';
                        console.log("No authorized students found.");
                        return;
                    }

                    noAuthorizedStudentsMessage.style.display = 'none';
                    snapshot.forEach((doc) => {
                        const studentData = doc.data();
                        const studentDocId = doc.id;
                        const studentEmail = studentData.email;

                        const studentEntry = document.createElement('div');
                        studentEntry.className = 'flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100 mb-2';
                        studentEntry.innerHTML = `
                            <span class="text-gray-800 font-medium">${studentEmail}</span>
                            <button class="remove-student-btn btn-secondary" data-doc-id="${studentDocId}">Remove</button>
                        `;
                        authorizedStudentsList.appendChild(studentEntry);
                    });
                    studentManagementLoading.style.display = 'none';
                }, (error) => {
                    console.error("Error listening to authorized students:", error);
                    studentManagementLoading.textContent = `Error: ${error.message}`;
                    showModal('Error', `Failed to load student list: ${error.message}`);
                });

            } catch (error) {
                console.error("Error setting up student listener:", error);
                studentManagementLoading.textContent = `Error: ${error.message}`;
                showModal('Error', `Failed to load student list: ${error.message}`);
            } finally {
                // Initial hide will be done by onSnapshot callback
            }
        }


        addStudentButton.addEventListener('click', async () => {
            const email = studentEmailInput.value.trim();
            if (!email) {
                showModal('Input Required', 'Please enter a student email address.');
                return;
            }
            if (!/\S+@\S+\.\S+/.test(email)) { // Simple email validation
                showModal('Invalid Email', 'Please enter a valid email address.');
                return;
            }
            if (currentUserRole !== 'teacher') {
                showModal('Access Denied', 'Only teachers can add students.');
                return;
            }

            studentManagementLoading.style.display = 'block';
            studentManagementLoading.textContent = 'Adding student...';

            try {
                const authorizedStudentsCollectionRef = collection(db, `artifacts/${appId}/authorized_users/student_emails`);
                // Check if email already exists
                const q = query(authorizedStudentsCollectionRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    showModal('Student Exists', `Student with email ${email} is already authorized.`);
                    studentManagementLoading.style.display = 'none';
                    return;
                }

                // Add new student email. Firestore will auto-generate doc ID.
                await addDoc(authorizedStudentsCollectionRef, {
                    email: email,
                    addedBy: currentUserId,
                    timestamp: Date.now()
                });
                showModal('Success', `Student ${email} added successfully.`);
                studentEmailInput.value = ''; // Clear input
            } catch (error) {
                console.error("Error adding student:", error);
                showModal('Error', `Failed to add student: ${error.message}`);
            } finally {
                studentManagementLoading.style.display = 'none';
            }
        });

        // Event delegation for remove buttons (since they are added dynamically)
        authorizedStudentsList.addEventListener('click', async (event) => {
            if (event.target.classList.contains('remove-student-btn')) {
                const docId = event.target.dataset.docId;
                if (!docId) return;

                if (currentUserRole !== 'teacher') {
                    showModal('Access Denied', 'Only teachers can remove students.');
                    return;
                }

                showModal('Confirm Removal', `Are you sure you want to remove this student?`, [
                    { text: 'Yes, Remove', className: 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg', onClick: async () => {
                        studentManagementLoading.style.display = 'block';
                        studentManagementLoading.textContent = 'Removing student...';
                        try {
                            const studentDocRef = doc(db, `artifacts/${appId}/authorized_users/student_emails`, docId);
                            await deleteDoc(studentDocRef);
                            showModal('Success', 'Student removed successfully.');
                        } catch (error) {
                            console.error("Error removing student:", error);
                            showModal('Error', `Failed to remove student: ${error.message}`);
                        } finally {
                            studentManagementLoading.style.display = 'none';
                        }
                    }},
                    { text: 'Cancel', className: 'bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg' }
                ]);
            }
        });

    </script>
    <!-- TEMPORARY SCRIPT FOR TEACHER AUTHORIZATION SETUP - REMOVE AFTER USE! -->
    <script type="module">
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";

        // IMPORTANT: Use your actual Firebase config and app ID
        const FIREBASE_CONFIG_FOR_SETUP = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI", // Your API Key
          authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30",
          storageBucket: "ai-grading-9bb30.firebasestorage.app",
          messagingSenderId: "298162112230",
          appId: "1:298162112230:web:529d3f95536991be685d27",
          measurementId: "G-CHKLKSM17S"
        };
        const APP_ID_FOR_SETUP = "c_03094e15";

        const setupApp = initializeApp(FIREBASE_CONFIG_FOR_SETUP, "setupApp"); // Use a distinct app instance name
        const setupDb = getFirestore(setupApp);
        const setupAuth = getAuth(setupApp);

        // *** YOUR TEACHER UID HAS BEEN ADDED HERE ***
        const TEACHER_UID_TO_AUTHORIZE = "EkrZ6R2LRrdgnvp38YnAWMN7btz2"; // <--- THIS IS YOUR UID

        onAuthStateChanged(setupAuth, async (user) => {
            if (user && user.uid === TEACHER_UID_TO_AUTHORIZE) {
                const teacherDocRef = doc(setupDb, `artifacts/${APP_ID_FOR_SETUP}/authorized_users/teachers/${TEACHER_UID_TO_AUTHORIZE}`);
                try {
                    await setDoc(teacherDocRef, { isTeacher: true }, { merge: true });
                    console.log("Teacher authorization document successfully created/updated in Firestore!");
                    // You might want to remove this log or disable this script after it runs once successfully
                } catch (error) {
                    console.error("Error creating teacher authorization document:", error);
                }
            } else if (user) {
                console.log("Logged in user is not the designated teacher for setup. UID:", user.uid);
            } else {
                console.log("No user logged in for setup script. Please log in with the teacher account.");
            }
        });
        // END TEMPORARY SCRIPT
    </script>
</body>
</html>
