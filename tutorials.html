<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>AI Marker - Tutorial Videos</title>
<link rel="stylesheet" href="css/tutorials.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>function onYouTubeIframeAPIReady(){window.isYouTubeApiReady=true;}</script>
<script src="https://www.youtube.com/iframe_api"></script><script src="https://player.vimeo.com/api/player.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"></head>
<body>
<div id="authWrapper" style="display:none;"><div class="login-left-panel"><h1>AI Marker</h1><p>Your Materials Hub</p><p>Rome wasn't built in a day</p></div><div class="login-right-panel"><div id="authContainer"></div></div></div>
<div id="appSection" style="display:none;"><header><div class="logo-container"><h1>AI Marker</h1><p>Operated by Darren Ng</p></div><div class="header-actions"><a href="home.html" class="tab">Home</a><button id="themeToggleButton" class="tab" style="padding:0 10px;">Theme</button><div class="dropdown-menu"><button class="tab active" id="materialsButton">Materials</button><div class="dropdown-menu-content"><a href="tutorials.html" class="tab active">Tutorial Videos</a><a href="pastpaper.html" class="tab">Past Papers</a><a href="exercises.html" class="tab">Exercises for Sale</a><a href="lessonhistory.html" class="tab">Lesson History</a></div></div><div class="user-info"><span id="userDisplayName"></span><button id="switchRoleButton">Switch Role</button><button id="logoutButton" class="logout-btn">Log Out</button></div></div></header><main><div id="tutorialSection"></div><div id="videoPlayerSection"><div class="video-main-content"><div class="video-player-header"><button class="back-button btn-primary" id="backToTutorialsBtn">← Back to Tutorials</button></div><div id="videoPlayerContainer"></div></div><div class="video-sidebar"><h2 id="videoInfoTitle"></h2><p id="videoInfoDescription"></p><div id="materialsLinkContainer" style="display:none;"><a id="materialsLink" href="#" target="_blank" rel="noopener noreferrer" class="btn-primary">Download Materials</a></div><div class="completion-control"><button id="completionToggleButton"></button></div><div id="topicPlaylist" class="topic-playlist"></div></div></div><div id="finderMaterialsSection" class="finder-window-wrapper"></div></main><footer><a href="mailto:darren_0625@mc-zero.com">Contact: darren_0625@mc-zero.com</a> | Copyright © 2025 Operated by Darren Ng</footer></div>
<div id="messageModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3 id="modalTitle"></h3><div id="modalMessage"></div><div id="modalButtons"></div></div></div>
<div id="addVideoModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3>Add New Tutorial Video</h3><form id="addVideoForm"><input type="hidden" id="videoParentId1"><input type="hidden" id="videoParentId2"><div style="margin-bottom:1rem;"><label for="tutorialLink">YouTube Link or Embed Code</label><textarea id="tutorialLink" required placeholder="Paste URL/Embed..."></textarea><img id="tutorialThumbnailPreview" style="max-width:200px;margin-top:10px;border-radius:8px;display:none;"/></div><div style="margin-bottom:1rem;"><label for="tutorialTitle">Video Title</label><input type="text" id="tutorialTitle" required></div><div style="margin-bottom:1rem;"><label for="tutorialNotes">Notes (Optional)</label><textarea id="tutorialNotes" placeholder="Add notes..."></textarea></div><div style="margin-bottom:1rem;"><label for="tutorialMaterialsLink">Materials Link (Optional)</label><input type="url" id="tutorialMaterialsLink" placeholder="e.g., https://drive.google.com/..."></div><div style="margin-bottom:1.5rem;"><label for="tutorialDifficulty">Difficulty Level</label><select id="tutorialDifficulty"><option value="U">Unspecified</option><option value="1/5">1/5</option><option value="2/5">2/5</option><option value="3/5">3/5</option><option value="4/5">4/5</option><option value="5/5">5/5</option><option value="5/5*">5/5*</option><option value="5/5**">5/5**</option></select></div><div class="modal-form-buttons"><button type="submit" class="btn-primary">Add Video</button></div></form></div></div>
<div id="editVideoModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3>Edit Tutorial Video</h3><form id="editVideoForm"><input type="hidden" id="editVideoParentId1"><input type="hidden" id="editVideoParentId2"><input type="hidden" id="editVideoId"><div style="margin-bottom:1rem;"><label for="editTutorialLink">YouTube Link or Embed Code</label><textarea id="editTutorialLink" required placeholder="Paste URL/Embed..."></textarea><img id="editTutorialThumbnailPreview" style="max-width:200px;margin-top:10px;border-radius:8px;display:none;"/></div><div style="margin-bottom:1rem;"><label for="editTutorialTitle">Video Title</label><input type="text" id="editTutorialTitle" required></div><div style="margin-bottom:1rem;"><label for="editTutorialNotes">Notes (Optional)</label><textarea id="editTutorialNotes" placeholder="Add notes..."></textarea></div><div style="margin-bottom:1rem;"><label for="editTutorialMaterialsLink">Materials Link (Optional)</label><input type="url" id="editTutorialMaterialsLink" placeholder="e.g., https://drive.google.com/..."></div><div style="margin-bottom:1.5rem;"><label for="editTutorialDifficulty">Difficulty Level</label><select id="editTutorialDifficulty"><option value="U">Unspecified</option><option value="1/5">1/5</option><option value="2/5">2/5</option><option value="3/5">3/5</option><option value="4/5">4/5</option><option value="5/5">5/5</option><option value="5/5*">5/5*</option><option value="5/5**">5/5**</option></select></div><div class="modal-form-buttons"><button type="submit" class="btn-primary">Save Changes</button></div></form></div></div>
<script type="module">
import {initializeApp}from"https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";import {getAuth,signInWithPopup,GoogleAuthProvider,signOut,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";import {getFirestore,doc,getDoc,addDoc,setDoc,updateDoc,collection,query,orderBy,getDocs,deleteDoc,where,onSnapshot,writeBatch}from"https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";import {getStorage,ref,uploadBytes,getDownloadURL,deleteObject}from"https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";
const firebaseConfig={apiKey:"AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",authDomain:"ai-grading-9bb30.firebaseapp.com",projectId:"ai-grading-9bb30",storageBucket:"ai-grading-9bb30.appspot.com",messagingSenderId:"298162112230",appId:"1:298162112230:web:529d3f95536991be685d27",measurementId:"G-CHKLKSM17S"};
const appId=typeof __app_id!=='undefined'?__app_id:'default-app-id';const TEACHER_CODE="Derren0625";const STUDENT_CODE="STUDENT456";
let app,db,auth,storage,currentUserId=null,currentUserEmail=null,currentUserRole=null,currentUserName=null,currentUserProfile=null,ytPlayer=null,vimeoPlayer=null,directPlayer=null,hls=null,currentVideoItem=null,saveTimeInterval=null,saveTimeTimeout=null;const SAVE_TIME_DEBOUNCE=5000;
const materialsConfig={tutorials:{sectionId:'tutorialSection',collectionName:'tutorials',title:'Tutorial Videos',level1:'Subject',level2:'Topic',level3:'Video',modalId:'addVideoModal'}};
const authWrapper=document.getElementById('authWrapper'),appSection=document.getElementById('appSection'),authContainer=document.getElementById('authContainer');
const googleSignInTemplate=`<h2>Sign In</h2><button id="googleSignInButton" class="google-btn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon"><span>Sign in with Google</span></button><p id="authError" class="error-message"></p>`;
const codeEntryTemplate=`<h2>Enter Access Code</h2><p style="color:var(--text-secondary);text-align:center;margin-bottom:1rem;">Please enter the access code provided by your administrator.</p><input type="text" id="accessCodeInput" placeholder="Enter code here"><button id="submitCodeButton" class="btn-primary" style="width:100%">Submit Code</button><p id="codeError" class="error-message"></p>`;
try{app=initializeApp(firebaseConfig);db=getFirestore(app);auth=getAuth(app);storage=getStorage(app);}catch(e){console.error(e);showModal('Config Error',e.message);}
async function checkDeepLink(){
    const p=new URLSearchParams(window.location.search),s=p.get('s'),t=p.get('t'),v=p.get('v');
    if(s&&t&&v&&currentUserId){try{const d=await getDoc(doc(db,`artifacts/${appId}/public/data/tutorials/${s}/topics/${t}/videos`,v));if(d.exists()){const i=d.data();i.id=d.id;i.level1Id=s;i.level2Id=t;showVideoPlayer(i);return true;}}catch(e){console.error(e);}}return false;
}
onAuthStateChanged(auth,async(u)=>{if(u){currentUserId=u.uid;currentUserEmail=u.email;try{const r=doc(db,`artifacts/${appId}/users/${currentUserId}/profile/data`),d=await getDoc(r);if(d.exists()&&d.data().role){const p=d.data();currentUserProfile=p;currentUserRole=p.role;currentUserName=p.name||u.displayName;await setDoc(r,{name:currentUserName,email:currentUserEmail,lastLogin:Date.now()},{merge:true});showApp();}else{currentUserName=u.displayName;currentUserRole='unassigned';currentUserProfile={};showCodeEntry();}}catch(e){showModal('Error',e.message);showLogin();}}else{currentUserId=null;currentUserRole=null;currentUserName=null;currentUserProfile=null;showLogin();}});
function showLogin(){appSection.style.display='none';authWrapper.style.display='flex';authWrapper.style.opacity='1';authContainer.innerHTML=googleSignInTemplate;document.getElementById('googleSignInButton')?.addEventListener('click',handleGoogleSignIn);}
function showCodeEntry(){appSection.style.display='none';authWrapper.style.display='flex';authWrapper.style.opacity='1';authContainer.innerHTML=codeEntryTemplate;document.getElementById('submitCodeButton')?.addEventListener('click',()=>handleSubmitCode());document.getElementById('accessCodeInput')?.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();handleSubmitCode();}});document.getElementById('accessCodeInput')?.focus();}
async function showApp(){authWrapper.style.display='none';appSection.style.display='flex';document.getElementById('userDisplayName').textContent=`${currentUserName} (${currentUserRole})`;initializeAllMaterialSections();if(!(await checkDeepLink()))showSection('tutorialSection');}
async function handleGoogleSignIn(){try{await signInWithPopup(auth,new GoogleAuthProvider());}catch(e){const el=document.getElementById('authError');if(el)el.textContent=e.message;}}
async function handleSubmitCode(val){
    const c=(val||document.getElementById('accessCodeInput').value).trim(),err=document.getElementById('codeError');if(err)err.textContent='';
    let r=null;if(c===TEACHER_CODE)r='teacher';else if(c===STUDENT_CODE)r='student';else{if(err)err.textContent='Invalid code.';return;}
    try{const p={role:r,name:currentUserName,email:currentUserEmail,lastLogin:Date.now()};if(r==='student')p.unlockedTeachers=[];await setDoc(doc(db,`artifacts/${appId}/users/${currentUserId}/profile/data`),p,{merge:true});currentUserRole=r;currentUserProfile=p;showModal('Success!',`Role set to ${r}.`);showApp();}catch(e){if(err)err.textContent=e.message;}
}
document.getElementById('logoutButton').addEventListener('click',()=>signOut(auth));
document.getElementById('switchRoleButton').addEventListener('click',()=>showInputModal('Switch Role','Enter new code:',c=>handleSubmitCode(c)));
function getPath(t,i=[]){const c=materialsConfig[t],p=[`artifacts/${appId}/public/data/${c.collectionName}`];if(i[0])p.push(i[0],c.level2.toLowerCase()+'s');if(i[1])p.push(i[1],c.level3.toLowerCase()+'s');return p.join('/');}
function initializeAllMaterialSections(){setupMaterialSection('tutorials');}
function showSection(id){document.querySelectorAll('main > div').forEach(d=>{if(d.id!=='finderMaterialsSection')d.style.display='none';});const t=document.getElementById(id);if(t){t.style.display=(id==='videoPlayerSection')?'flex':'block';setTimeout(()=>t.style.opacity=1,50);}}
function setupMaterialSection(type){
    const c=materialsConfig[type],s=document.getElementById(c.sectionId);if(!s)return;
    s.innerHTML=`<h2 class="section-title">${c.title}</h2><div id="teacher-tabs-${type}" class="tab-btn-container" style="display:none;"><button class="tab-btn active" data-tab="viewer">View Materials</button><button class="tab-btn" data-tab="manager">Manage Content</button></div><div id="viewer-${type}-view" style="display:none;"><div class="viewer-filters-container"><div class="filter-step" style="flex-direction:row;align-items:center;gap:1rem;"><div style="flex-grow:1;"><label for="teacher-${type}-filter">1. Select Teacher</label><select id="teacher-${type}-filter"><option value="">-- Unlock a Teacher --</option></select></div><button id="unlock-teacher-btn-${type}" class="btn-primary" style="padding:12px 18px;margin-top:1.5rem;">Unlock</button></div><div class="filter-step" id="filter-step-1-${type}" style="opacity:0.5;pointer-events:none;"><label for="level1-${type}-filter">2. Select ${c.level1}</label><select id="level1-${type}-filter" disabled><option value="">-- Select ${c.level1} --</option></select></div><div class="filter-step" id="filter-step-2-${type}" style="opacity:0.5;pointer-events:none;"><label for="level2-${type}-filter">3. Select ${c.level2}</label><select id="level2-${type}-filter" disabled><option value="">-- Select ${c.level2} --</option></select></div><div class="filter-step" id="filter-step-3-${type}" style="opacity:0.5;pointer-events:none;"><label for="sort-${type}-filter">4. Sort By</label><select id="sort-${type}-filter" disabled><option value="name-asc">Sort by Name (A-Z)</option><option value="name-desc">Sort by Name (Z-A)</option><option value="diff-asc">Difficulty (Low to High)</option><option value="diff-desc">Difficulty (High to Low)</option></select></div></div><div id="level3-${type}-grid" class="grid-container" style="display:none;opacity:0;"></div></div><div id="manager-${type}-view" style="display:none;"><div class="form-container" id="teacher-code-manager"><h3 class="teacher-group-heading">My Teacher Access Code</h3><p style="color:var(--text-secondary);margin-bottom:1rem;">Students use this code to unlock your content.</p><div style="display:flex;gap:1rem;align-items:center;"><input type="text" id="teacherAccessCodeInput" placeholder="Enter code..." style="margin-bottom:0;"><button id="saveTeacherAccessCodeBtn" class="btn-primary">Save Code</button></div><p id="teacherAccessCodeStatus" style="margin-top:1rem;"></p></div><div class="form-container" style="max-width:initial;"><h3 id="my-subjects-heading-${type}" class="teacher-group-heading">My Subjects</h3><div id="level1-${type}-container-mine"></div><button id="add-level1-${type}-btn" class="btn-primary" style="margin-top:1rem;">Add New ${c.level1}</button><button id="migrate-data-btn" class="btn-primary" style="margin-top:1rem;margin-left:1rem;background-color:var(--accent-red);border-color:var(--accent-red);display:none;">Fix My Old Subjects</button></div></div>`;
    const isT=currentUserRole==='teacher',vS=document.getElementById(`viewer-${type}-view`),mS=document.getElementById(`manager-${type}-view`),tabs=document.getElementById(`teacher-tabs-${type}`),cm=document.getElementById(`teacher-code-manager`);
    if(isT){tabs.style.display='flex';vS.style.display='block';mS.style.display='none';cm.style.display='block';
        tabs.addEventListener('click',e=>{if(e.target.matches('.tab-btn')){tabs.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));e.target.classList.add('active');if(e.target.dataset.tab==='viewer'){vS.style.display='block';mS.style.display='none';}else{vS.style.display='none';mS.style.display='block';}}});
        renderTeacherManagerView(type);document.getElementById(`add-level1-${type}-btn`).onclick=()=>showAddItemModal(type,1);mS.addEventListener('click',e=>handleTeacherClick(e,type));mS.addEventListener('change',e=>handleTeacherSort(e,type));
        document.getElementById(`migrate-data-btn`).onclick=()=>runMigration(type);document.getElementById('saveTeacherAccessCodeBtn').onclick=()=>saveTeacherAccessCode();if(currentUserProfile?.contentAccessCode)document.getElementById('teacherAccessCodeInput').value=currentUserProfile.contentAccessCode;
    }else{tabs.style.display='none';vS.style.display='block';mS.style.display='none';cm.style.display='none';}
    vS.addEventListener('click',e=>{if(e.target.id===`unlock-teacher-btn-${type}`){showInputModal('Unlock Teacher','Enter code:',async(c)=>{if(!c)return;try{const q=query(collection(db,`artifacts/${appId}/public/data/teacherAccessCodes`),where("code","==",c.trim())),s=await getDocs(q);if(s.empty){showModal('Invalid','Code not found.');return;}const t=s.docs[0],tid=t.id,tn=t.data().teacherName,ref=doc(db,`artifacts/${appId}/users/${currentUserId}/profile/data`);let u=(currentUserProfile?.unlockedTeachers)?[...currentUserProfile.unlockedTeachers]:[];if(u.includes(tid)){showModal('Unlocked',`Already unlocked ${tn}.`);return;}u.push(tid);await updateDoc(ref,{unlockedTeachers:u});currentUserProfile.unlockedTeachers=u;showModal('Success!',`Unlocked ${tn}.`);setupViewerFilters(type);}catch(err){showModal('Error',err.message);}});}});
    const ub=document.getElementById(`unlock-teacher-btn-${type}`);if(ub)ub.style.display='inline-block';setupViewerFilters(type);
}
async function renderTeacherManagerView(type){
    const c=materialsConfig[type],mc=document.getElementById(`level1-${type}-container-mine`);if(!mc)return;
    mc.innerHTML=`<p class="loading-indicator">Loading...</p>`;document.getElementById(`my-subjects-heading-${type}`).textContent=`My Subjects (${currentUserName})`;
    try{const r=collection(db,getPath(type)),mq=query(r,where('teacherId','==',currentUserId),orderBy('name','asc')),oq=query(r,where('teacherId','==',null));const [ms,os]=await Promise.all([getDocs(mq),getDocs(oq)]);
        if(ms.empty)mc.innerHTML=`<p>No ${c.level1.toLowerCase()}s created yet.</p>`;else{let h='';ms.forEach(d=>{const i=d.data();i.id=d.id;const p=[i.id],n=2,sh=`<div class="teacher-sort-container"><select id="sort-teacher-${type}-${i.id}" class="teacher-sort-filter" data-type="${type}" data-level="3" data-parent-ids='${JSON.stringify(p)}'><option value="name-asc">Sort by Name (A-Z)</option><option value="name-desc">Sort by Name (Z-A)</option><option value="diff-asc">Difficulty (Low to High)</option><option value="diff-desc">Difficulty (High to Low)</option></select></div>`;h+=`<div class="content-item"><div class="content-header" data-level="1" data-id="${i.id}" data-parent-ids='[]' aria-expanded="false"><h3>${i.name} <span class="collapse-arrow"></span></h3><div class="item-actions"><button class="add-item-btn btn-primary" data-level="${n}" data-parent-ids='${JSON.stringify(p)}'>Add ${c[`level${n}`]}</button><button class="delete-item-btn logout-btn" data-level="1" data-id="${i.id}" data-parent-ids='[]'>Delete</button></div></div>${sh}<div class="nested-container" id="container-level${n}-${type}-${d.id}"></div></div>`;});mc.innerHTML=h;}
        const mb=document.getElementById('migrate-data-btn');if(!os.empty){mb.style.display='inline-block';showModal('Action Required','Found old subjects. Click "Fix My Old Subjects".');}else mb.style.display='none';
    }catch(e){console.error(e);mc.innerHTML=`<p class="error-message">Error loading content.</p>`;}
}
async function renderContent(type,cid,lvl,pids=[],sby='name-asc'){
    const cnt=document.getElementById(cid);if(!cnt)return;const c=materialsConfig[type],ln=c[`level${lvl}`];
    if(cnt.innerHTML.includes('loading')||cnt.innerHTML==='')cnt.innerHTML=`<p class="loading-indicator">Loading ${ln.toLowerCase()}s...</p>`;else if(lvl===3)cnt.innerHTML=`<p class="loading-indicator">Sorting...</p>`;
    const ref=collection(db,getPath(type,pids));
    if(lvl===3){try{const q=query(ref),s=await getDocs(q);if(s.empty){cnt.innerHTML=`<p>No ${ln.toLowerCase()}s added.</p>`;return;}let items=[];s.forEach(d=>{const i=d.data();i.id=d.id;i.level1Id=pids[0];i.level2Id=pids[1];items.push(i);});const dO={'U':0,'1/5':1,'2/5':2,'3/5':3,'4/5':4,'5/5':5,'5/5*':6,'5/5**':7};items.sort((a,b)=>{const dA=dO[a.difficulty]??0,dB=dO[b.difficulty]??0,tA=a.title||a.name||'',tB=b.title||b.name||'';return sby==='name-desc'?tB.localeCompare(tA):sby==='diff-asc'?dA-dB:sby==='diff-desc'?dB-dA:tA.localeCompare(tB);});cnt.innerHTML='';items.forEach(i=>{const el=document.createElement('div');el.className='sub-item';el.innerHTML=`<span>${i.name||i.title} <span class="difficulty-badge-teacher">(${i.difficulty||'U'})</span></span><div class="item-actions"><button class="edit-item-btn btn-primary" data-id="${i.id}" data-parent-ids='${JSON.stringify(pids)}' data-item='${JSON.stringify(i)}'>Edit</button><button class="preview-item-btn btn-primary" data-item='${JSON.stringify(i)}'>Preview</button><button class="delete-item-btn logout-btn" data-level="${lvl}" data-id="${i.id}" data-parent-ids='${JSON.stringify(pids)}'>Delete</button></div>`;cnt.appendChild(el);});}catch(e){cnt.innerHTML=`<p class="error-message">Error.</p>`;}}
    else{const q=query(ref,orderBy('name','asc'));try{const s=await getDocs(q);if(s.empty){cnt.innerHTML=`<p>No ${ln.toLowerCase()}s added.</p>`;return;}cnt.innerHTML='';s.forEach(d=>{const i=d.data();i.id=d.id;const el=document.createElement('div');el.className='content-item';const n=lvl+1,np=[...pids,d.id];let sh='';if(n===3)sh=`<div class="teacher-sort-container"><select id="sort-teacher-${type}-${d.id}" class="teacher-sort-filter" data-type="${type}" data-level="3" data-parent-ids='${JSON.stringify(np)}'><option value="name-asc">Sort by Name (A-Z)</option><option value="name-desc">Sort by Name (Z-A)</option><option value="diff-asc">Difficulty (Low to High)</option><option value="diff-desc">Difficulty (High to Low)</option></select></div>`;el.innerHTML=`<div class="content-header" data-level="${lvl}" data-id="${d.id}" data-parent-ids='${JSON.stringify(pids)}' aria-expanded="false"><h3>${i.name} <span class="collapse-arrow"></span></h3><div class="item-actions"><button class="add-item-btn btn-primary" data-level="${n}" data-parent-ids='${JSON.stringify(np)}'>Add ${c[`level${n}`]}</button><button class="delete-item-btn logout-btn" data-level="${lvl}" data-id="${d.id}" data-parent-ids='${JSON.stringify(pids)}'>Delete</button></div></div>${sh}<div class="nested-container" id="container-level${n}-${type}-${d.id}"></div>`;cnt.appendChild(el);});}catch(e){cnt.innerHTML=`<p class="error-message">Error.</p>`;}}
}
function handleTeacherClick(e,type){const h=e.target.closest('.content-header'),b=e.target.closest('button');if(b){e.stopPropagation();const {level,parentIds}=b.dataset,p=JSON.parse(parentIds||'[]');if(b.matches('.add-item-btn')){const n=parseInt(level);if(n<3)showAddItemModal(type,n,p);else showAddFinalItemModal(type,p);}else if(b.matches('.edit-item-btn')){const {id,parentIds,item}=b.dataset;showEditFinalItemModal(type,JSON.parse(parentIds),id,JSON.parse(item));}else if(b.matches('.delete-item-btn'))handleDeleteItem(type,parseInt(level),b.dataset.id,p);else if(b.matches('.preview-item-btn'))handlePreview(type,JSON.parse(b.dataset.item));}else if(h){const {level,id,parentIds}=h.dataset,c=document.getElementById(`container-level${parseInt(level)+1}-${type}-${id}`);if(!c)return;const sc=h.parentElement.querySelector('.teacher-sort-container'),exp=h.getAttribute('aria-expanded')==='true';h.setAttribute('aria-expanded',!exp);c.classList.toggle('expanded',!exp);if(sc)sc.style.display=!exp?'block':'none';if(!exp&&!c.dataset.loaded){const sb=sc?sc.querySelector('select').value:'name-asc';renderContent(type,c.id,parseInt(level)+1,[...JSON.parse(parentIds),id],sb);c.dataset.loaded='true';}}}
async function runMigration(type){if(!currentUserId||!currentUserName)return;showModal('Migrating...','Wait...');try{const r=collection(db,getPath(type)),s=await getDocs(query(r)),b=writeBatch(db);let c=0;if(s.empty){showModal('Complete','None found.');return;}s.forEach(d=>{const i=d.data();if(!i.teacherId||!i.teacherName){b.update(d.ref,{teacherId:currentUserId,teacherName:currentUserName});c++;}});if(c>0){await b.commit();showModal('Success!',`Updated ${c}.`);}else showModal('All Set!','No migration needed.');renderTeacherManagerView(type);setupViewerFilters(type);}catch(e){showModal('Error',e.message);}}
function handleTeacherSort(e,type){const s=e.target.closest('select.teacher-sort-filter');if(s){e.stopPropagation();const {level,parentIds}=s.dataset,p=JSON.parse(parentIds||'[]');renderContent(type,`container-level${level}-${type}-${p[p.length-1]}`,parseInt(level),p,s.value);}}
function handlePreview(type,item){if(type==='tutorials')showVideoPlayer(item);}
async function setupViewerFilters(type){
    const c=materialsConfig[type],tf=document.getElementById(`teacher-${type}-filter`),lf1=document.getElementById(`level1-${type}-filter`),lf2=document.getElementById(`level2-${type}-filter`),sf=document.getElementById(`sort-${type}-filter`),gr=document.getElementById(`level3-${type}-grid`);
    const s1=document.getElementById(`filter-step-1-${type}`),s2=document.getElementById(`filter-step-2-${type}`),s3=document.getElementById(`filter-step-3-${type}`);
    let ut=(currentUserProfile?.unlockedTeachers)?[...currentUserProfile.unlockedTeachers]:[];if(currentUserRole==='teacher'&&!ut.includes(currentUserId))ut.push(currentUserId);
    let as=[],tm=new Map();tf.innerHTML=`<option value="">-- Loading... --</option>`;
    try{const s=await getDocs(query(collection(db,getPath(type)),orderBy('name','asc')));s.forEach(d=>{const i=d.data();i.id=d.id;as.push(i);if(i.teacherId&&i.teacherName)tm.set(i.teacherId,i.teacherName);});}catch(e){console.error(e);tf.innerHTML=`<option value="">-- Error --</option>`;return;}
    tf.innerHTML=`<option value="">-- Select a Teacher --</option>`;if(ut.length===0)tf.innerHTML+=currentUserRole==='teacher'?`<option value="" disabled>-- No subjects --</option>`:`<option value="" disabled>-- Unlock a teacher --</option>`;else{[...new Set(ut.map(id=>tm.get(id)).filter(n=>n))].sort().forEach(n=>tf.add(new Option(n,n)));}
    tf.onchange=async()=>{const t=tf.value;lf1.innerHTML=`<option value="">-- Select ${c.level1} --</option>`;lf1.disabled=true;lf2.innerHTML=`<option value="">-- Select ${c.level2} --</option>`;lf2.disabled=true;sf.disabled=true;gr.style.display='none';gr.style.opacity=0;s1.style.opacity='0.5';s1.style.pointerEvents='none';s2.style.opacity='0.5';s2.style.pointerEvents='none';s3.style.opacity='0.5';s3.style.pointerEvents='none';if(t){lf1.innerHTML=`<option value="">-- Select a ${c.level1} --</option>`;const f=as.filter(s=>s.teacherName===t);if(f.length===0)lf1.innerHTML+=`<option value="" disabled>-- None --</option>`;else f.forEach(s=>lf1.add(new Option(s.name,s.id)));lf1.disabled=false;s1.style.opacity='1';s1.style.pointerEvents='auto';}};
    lf1.onchange=()=>{const v=lf1.value;lf2.innerHTML=`<option value="">-- Select ${c.level2} --</option>`;lf2.disabled=true;sf.disabled=true;gr.style.display='none';gr.style.opacity=0;s2.style.opacity='0.5';s2.style.pointerEvents='none';s3.style.opacity='0.5';s3.style.pointerEvents='none';if(v){populateFilter(lf2,collection(db,getPath(type,[v])),c.level2);lf2.disabled=false;s2.style.opacity='1';s2.style.pointerEvents='auto';}};
    lf2.onchange=()=>{if(lf2.value){sf.disabled=false;s3.style.opacity='1';s3.style.pointerEvents='auto';renderViewerItems(type);}else{sf.disabled=true;s3.style.opacity='0.5';s3.style.pointerEvents='none';gr.style.display='none';gr.style.opacity=0;}};sf.onchange=()=>renderViewerItems(type);
}
async function renderViewerItems(type){
    const c=materialsConfig[type],g=document.getElementById(`level3-${type}-grid`),l1=document.getElementById(`level1-${type}-filter`).value,l2=document.getElementById(`level2-${type}-filter`).value,sv=document.getElementById(`sort-${type}-filter`).value;
    g.innerHTML=`<p class="loading-indicator">Loading...</p>`;g.style.display='grid';g.style.opacity=1;if(!l1||!l2){g.style.display='none';return;}
    const ref=collection(db,getPath(type,[l1,l2])),q=query(ref);let vs={};if(type==='tutorials'&&currentUserId){const snap=await getDocs(collection(db,`artifacts/${appId}/users/${currentUserId}/videoStatus`));snap.forEach(d=>vs[d.id]=d.data().completed);}
    try{const s=await getDocs(q);if(s.empty){g.innerHTML=`<p>No ${c.level3.toLowerCase()}s found.</p>`;return;}let items=[];s.forEach(d=>{const i=d.data();i.id=d.id;i.level1Id=l1;i.level2Id=l2;items.push(i);});const dO={'U':0,'1/5':1,'2/5':2,'3/5':3,'4/5':4,'5/5':5,'5/5*':6,'5/5**':7};items.sort((a,b)=>{const dA=dO[a.difficulty]??0,dB=dO[b.difficulty]??0,tA=a.title||a.name||'',tB=b.title||b.name||'';return sv==='name-desc'?tB.localeCompare(tA):sv==='diff-asc'?dA-dB:sv==='diff-desc'?dB-dA:tA.localeCompare(tB);});g.innerHTML='';items.forEach(i=>{const card=document.createElement('div');card.className='material-card';card.style.animation='slideInUp 0.5s ease-out both';card.addEventListener('click',()=>showVideoPlayer(i));const done=vs[i.id],vid=i.videoId||i.youtubeId;let t;if(i.videoType==='vimeo')t=`https://placehold.co/480x360/0a0a0a/888888?text=Vimeo+Video`;else if(i.videoType==='direct')t=`https://placehold.co/480x360/0a0a0a/888888?text=Direct+Video`;else if(i.videoType==='html')t=`https://placehold.co/480x360/0a0a0a/888888?text=HTML+Content`;else t=`https://img.youtube.com/vi/${vid}/mqdefault.jpg`;card.innerHTML=`<div class="material-card-thumbnail" data-video-id="${vid}"><img src="${t}" alt="${i.title}" onerror="this.onerror=null; this.src='https://placehold.co/480x360/30363d/c9d1d9?text=No%20Thumbnail';">${done?'<div class="completion-status">✓</div>':''}</div><div class="material-card-content"><h3>${i.title||'Untitled'}</h3><span class="difficulty-badge">${i.difficulty||'U'}</span></div>`;g.appendChild(card);});}catch(e){g.innerHTML="<p class='error-message'>Error loading.</p>"}
}
async function populateFilter(sel,qRef,ln){sel.innerHTML=`<option value="">-- Loading... --</option>`;try{const q=(qRef.type==='collection')?query(qRef,orderBy('name','asc')):qRef,s=await getDocs(q);sel.innerHTML=`<option value="">-- Select ${ln} --</option>`;if(s.empty){sel.innerHTML+=`<option value="" disabled>-- No ${ln}s --</option>`;return;}s.forEach(d=>sel.add(new Option(d.data().name,d.id)));}catch(e){console.error(e);sel.innerHTML=`<option value="">-- Error --</option>`;}}
function savePlaybackTime(vid,ct){if(!currentUserId||!vid||ct<1)return;if(saveTimeTimeout)clearTimeout(saveTimeTimeout);saveTimeTimeout=setTimeout(async()=>{try{await setDoc(doc(db,`artifacts/${appId}/users/${currentUserId}/videoPlaybackStatus`,vid),{lastPlayedTime:ct,timestamp:Date.now()},{merge:true});}catch(e){console.error(e);}saveTimeTimeout=null;},SAVE_TIME_DEBOUNCE);}
async function getPlaybackTime(vid){if(!currentUserId||!vid)return Promise.resolve(0);try{const d=await getDoc(doc(db,`artifacts/${appId}/users/${currentUserId}/videoPlaybackStatus`,vid));return(d.exists()&&d.data().lastPlayedTime)?d.data().lastPlayedTime:0;}catch(e){return 0;}}
window.onYouTubeIframeAPIReady=function(){window.isYouTubeApiReady=true;};
function cleanupPlayers(){if(ytPlayer){ytPlayer.destroy();ytPlayer=null;}if(vimeoPlayer){vimeoPlayer.destroy().catch(e=>console.warn(e));vimeoPlayer=null;}if(directPlayer){if(hls){hls.destroy();hls=null;}directPlayer.pause();directPlayer.src='';directPlayer=null;}if(saveTimeInterval){clearInterval(saveTimeInterval);saveTimeInterval=null;}if(saveTimeTimeout){clearTimeout(saveTimeTimeout);saveTimeTimeout=null;}document.getElementById('videoPlayerContainer').innerHTML='';}
async function showVideoPlayer(item){
    currentVideoItem=item;showSection('videoPlayerSection');
    if(item.level1Id&&item.level2Id&&item.id){const u=`${window.location.pathname}?s=${item.level1Id}&t=${item.level2Id}&v=${item.id}`;if(window.location.search!==`?s=${item.level1Id}&t=${item.level2Id}&v=${item.id}`)history.pushState({path:u},'',u);}
    document.getElementById('videoInfoTitle').textContent=item.title;document.getElementById('videoInfoDescription').textContent=item.notes||'No notes.';const mc=document.getElementById('materialsLinkContainer');if(item.materialsLink){document.getElementById('materialsLink').href=item.materialsLink;mc.style.display='block';}else mc.style.display='none';
    const pc=document.getElementById('videoPlayerContainer');cleanupPlayers();const st=await getPlaybackTime(item.id),vid=item.videoId||item.youtubeId;
    if(item.videoType==='vimeo'){pc.innerHTML=`<iframe src="https://player.vimeo.com/video/${vid}${vid.includes('?')?'&':'?'}muted=1" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;vimeoPlayer=new Vimeo.Player(pc.querySelector('iframe'));vimeoPlayer.on('ready',()=>{if(st>0.5)vimeoPlayer.setCurrentTime(st).catch(console.warn);vimeoPlayer.play().catch(console.warn);vimeoPlayer.setVolume(1);});vimeoPlayer.on('timeupdate',d=>savePlaybackTime(item.id,d.seconds));}
    else if(item.videoType==='direct'){pc.innerHTML=`<video id="directVideoPlayer" controls autoplay muted style="background-color:#000;"></video>`;directPlayer=document.getElementById('directVideoPlayer');directPlayer.addEventListener('timeupdate',()=>{if(directPlayer)savePlaybackTime(item.id,directPlayer.currentTime);});directPlayer.addEventListener('loadedmetadata',()=>{if(st>0&&directPlayer)directPlayer.currentTime=st;if(directPlayer){directPlayer.play().catch(console.warn);directPlayer.muted=false;}});if(item.videoId.includes('.m3u8')&&Hls.isSupported()){hls=new Hls();hls.loadSource(item.videoId);hls.attachMedia(directPlayer);}else{directPlayer.src=item.videoId;}}
    else if(item.videoType==='html'){pc.innerHTML=`<iframe src="${item.videoId}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;}
    else{pc.innerHTML=`<div id="youtube-player-div" style="width:100%;height:100%;"></div>`;const cp=()=>{if(!document.getElementById('youtube-player-div'))return;ytPlayer=new YT.Player('youtube-player-div',{height:'100%',width:'100%',videoId:vid,playerVars:{'autoplay':1,'playsinline':1,'start':Math.floor(st)},events:{'onReady':e=>e.target.playVideo(),'onStateChange':e=>{if(e.data==YT.PlayerState.PLAYING){if(saveTimeInterval)clearInterval(saveTimeInterval);saveTimeInterval=setInterval(()=>{if(ytPlayer?.getCurrentTime)savePlaybackTime(item.id,ytPlayer.getCurrentTime());},SAVE_TIME_DEBOUNCE);}else{if(saveTimeInterval){clearInterval(saveTimeInterval);saveTimeInterval=null;if(ytPlayer?.getCurrentTime)savePlaybackTime(item.id,ytPlayer.getCurrentTime());}}}}});};if(window.isYouTubeApiReady)cp();else{const i=setInterval(()=>{if(window.isYouTubeApiReady){clearInterval(i);cp();}},100);}}
    await updateCompletionButtonUI(item.id);if(item.level1Id&&item.level2Id)await loadTopicPlaylist(item.level1Id,item.level2Id,item.id);
}
document.getElementById('backToTutorialsBtn').addEventListener('click',()=>{history.pushState({},'',window.location.pathname);showSection('tutorialSection');cleanupPlayers();currentVideoItem=null;renderViewerItems('tutorials');});
async function loadTopicPlaylist(l1,l2,cvid){const c=document.getElementById('topicPlaylist');if(!c)return;c.innerHTML=`<h3>In this Topic</h3><p class="loading-indicator" style="padding:0;">Loading...</p>`;try{const s=await getDocs(query(collection(db,getPath('tutorials',[l1,l2])),orderBy('name','asc')));if(s.empty){c.innerHTML='<h3>In this Topic</h3><p>None found.</p>';return;}c.innerHTML='<h3>In this Topic</h3>';s.forEach(d=>{const v=d.data();v.id=d.id;v.level1Id=l1;v.level2Id=l2;const el=document.createElement('a');el.className='playlist-item';if(v.id===cvid)el.classList.add('active');el.textContent=v.title||'Untitled';el.onclick=e=>{e.preventDefault();showVideoPlayer(v);};c.appendChild(el);});}catch(e){c.innerHTML='<h3>In this Topic</h3><p class="error-message">Error.</p>';}}
document.getElementById('completionToggleButton').addEventListener('click',async()=>{if(!currentVideoItem||!currentUserId)return;const vid=currentVideoItem.id,r=doc(db,`artifacts/${appId}/users/${currentUserId}/videoStatus`,vid);try{const d=await getDoc(r),c=d.exists()&&d.data().completed;if(c)await setDoc(r,{completed:false},{merge:true});else await setDoc(r,{completed:true,timestamp:Date.now(),videoTitle:currentVideoItem.title,videoId:currentVideoItem.id},{merge:true});await updateCompletionButtonUI(vid);}catch(e){showModal("Error","Update failed.");}});
async function updateCompletionButtonUI(vid){if(!currentUserId)return;const b=document.getElementById('completionToggleButton'),r=doc(db,`artifacts/${appId}/users/${currentUserId}/videoStatus`,vid);try{const d=await getDoc(r);if(d.exists()&&d.data().completed){b.textContent="✓ Completed";b.className='mark-incomplete';}else{b.textContent="Mark as Complete";b.className='mark-complete';}}catch(e){b.textContent="Status Error";b.disabled=true;}}
document.getElementById('themeToggleButton').addEventListener('click',()=>showModal("Theme","Dark theme only."));document.body.classList.remove('light-theme');
async function saveTeacherAccessCode(){const i=document.getElementById('teacherAccessCodeInput'),s=document.getElementById('teacherAccessCodeStatus'),c=i.value.trim();if(!c){s.textContent="Enter code.";s.style.color="var(--accent-red)";return;}s.textContent="Checking...";s.style.color="var(--text-secondary)";try{const q=query(collection(db,`artifacts/${appId}/public/data/teacherAccessCodes`),where("code","==",c)),sn=await getDocs(q);let t=false;sn.forEach(d=>{if(d.id!==currentUserId)t=true;});if(t){s.textContent="Taken.";s.style.color="var(--accent-red)";return;}const b=writeBatch(db);b.update(doc(db,`artifacts/${appId}/users/${currentUserId}/profile/data`),{contentAccessCode:c});b.set(doc(db,`artifacts/${appId}/public/data/teacherAccessCodes`,currentUserId),{code:c,teacherName:currentUserName});await b.commit();currentUserProfile.contentAccessCode=c;s.textContent="Saved!";s.style.color="var(--accent-green)";}catch(e){s.textContent=`Error:${e.message}`;s.style.color="var(--accent-red)";}}
function showModal(t,m,btns=[]){const md=document.getElementById('messageModal');if(!md)return;document.getElementById('modalTitle').textContent=t;document.getElementById('modalMessage').innerHTML=m;const mb=document.getElementById('modalButtons');mb.innerHTML='';if(btns.length===0){const b=document.createElement('button');b.textContent='OK';b.className='btn-primary';b.onclick=()=>closeModal(md.id);mb.appendChild(b);}else{btns.forEach(bc=>{const b=document.createElement('button');b.textContent=bc.text;b.className=bc.class||'btn-primary';b.onclick=()=>{if(bc.callback)bc.callback();closeModal(md.id);};mb.appendChild(b);});}md.style.display='flex';}
async function showAddItemModal(t,l,pid=[]){const c=materialsConfig[t],ln=c[`level${l}`];showInputModal(`Add New ${ln}`,`${ln} Name:`,async(n)=>{if(!n)return;const i={name:n,createdAt:Date.now()};if(l===1){i.teacherId=currentUserId;i.teacherName=currentUserName;}try{await addDoc(collection(db,getPath(t,pid)),i);showModal('Success',`${ln} added.`);if(l===1)renderTeacherManagerView(t);else{const cid=`container-level${l}-${t}-${pid[pid.length-1]}`,s=document.getElementById(`sort-teacher-${t}-${pid[pid.length-1]}`);renderContent(t,cid,l,pid,s?s.value:'name-asc');}}catch(e){showModal('Error',e.message);}});}
function showAddFinalItemModal(t,p=[]){const c=materialsConfig[t],m=document.getElementById(c.modalId);if(!m)return;const f=m.querySelector('form');if(f)f.reset();document.getElementById('tutorialDifficulty').value='U';document.getElementById('tutorialThumbnailPreview').style.display='none';document.getElementById('videoParentId1').value=p[0]||'';document.getElementById('videoParentId2').value=p[1]||'';m.style.display='flex';if(!f.dataset.l){f.addEventListener('submit',async(e)=>{e.preventDefault();const p1=document.getElementById('videoParentId1').value,p2=document.getElementById('videoParentId2').value,l=document.getElementById('tutorialLink').value,vi=parseVideoLink(l);if(!vi){showModal("Invalid","Bad Link.");return;}const i={title:document.getElementById('tutorialTitle').value,name:document.getElementById('tutorialTitle').value,videoType:vi.type,videoId:vi.id,link:l,difficulty:document.getElementById('tutorialDifficulty').value,notes:document.getElementById('tutorialNotes').value||'',materialsLink:document.getElementById('tutorialMaterialsLink').value||'',createdAt:Date.now()};try{await addDoc(collection(db,getPath(t,[p1,p2])),i);const cid=`container-level3-${t}-${p2}`,s=document.getElementById(`sort-teacher-${t}-${p2}`);renderContent(t,cid,3,[p1,p2],s?s.value:'name-asc');closeModal(m.id);showModal('Success','Added.');}catch(err){showModal('Error',err.message);}});f.dataset.l='true';}}
const tli=document.getElementById('tutorialLink');if(tli){tli.addEventListener('input',()=>{const v=parseVideoLink(tli.value),p=document.getElementById('tutorialThumbnailPreview');if(v&&v.type==='youtube'){p.src=`https://img.youtube.com/vi/${v.id}/mqdefault.jpg`;p.style.display='block';}else p.style.display='none';});}
function parseVideoLink(u){if(!u)return null;try{if(u.includes('<iframe')){let m=u.match(/src="https:\/\/www\.youtube\.com\/embed\/([^"?]+)/);if(m&&m[1])return{type:'youtube',id:m[1]};m=u.match(/src="https:\/\/player\.vimeo\.com\/video\/([^"]+)"/);if(m&&m[1])return{type:'vimeo',id:m[1]};}let r=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/,m=u.match(r);if(m&&m[2].length===11)return{type:'youtube',id:m[2]};r=/https:\/\/player\.vimeo\.com\/video\/([^#\&\?\/]+(?:[?][^ ]*)?)/;m=u.match(r);if(m&&m[1])return{type:'vimeo',id:m[1].trim()};r=/^.*(vimeo\.com\/)([^#\&\?\/]+).*/;m=u.match(r);if(m&&m[2])return{type:'vimeo',id:m[2]};if(u.startsWith('http')&&(u.includes('.m3u8')||u.includes('.mp4')||u.includes('.webm')||u.includes('.ogv')))return{type:'direct',id:u};if(u.startsWith('http')&&(u.endsWith('.html')||u.endsWith('.htm')))return{type:'html',id:u};}catch(e){return null;}return null;}
function showInputModal(t,l,cb){const iid='dynamicInput';showModal(t,`<label for="${iid}" style="display:block;margin-bottom:8px;">${l}</label><input type="text" id="${iid}" class="modal-input-style" style="width:100%;">`,[{text:'Cancel',class:'logout-btn'},{text:'Submit',class:'btn-primary',callback:()=>cb(document.getElementById(iid).value)}]);setTimeout(()=>{const i=document.getElementById(iid);if(i){i.style.cssText="background-color:transparent;border:2px solid var(--border-color);color:var(--text-primary);padding:12px 18px;border-radius:30px;font-size:1rem;";i.focus();}},50);}
function showEditFinalItemModal(t,p,id,item){const c=materialsConfig[t],m=document.getElementById('editVideoModal');if(!m)return;document.getElementById('editVideoParentId1').value=p[0]||'';document.getElementById('editVideoParentId2').value=p[1]||'';document.getElementById('editVideoId').value=id||'';document.getElementById('editTutorialLink').value=item.link||'';document.getElementById('editTutorialTitle').value=item.title||'';document.getElementById('editTutorialNotes').value=item.notes||'';document.getElementById('editTutorialMaterialsLink').value=item.materialsLink||'';document.getElementById('editTutorialDifficulty').value=item.difficulty||'U';m.style.display='flex';const f=m.querySelector('form');if(!f.dataset.l){f.addEventListener('submit',async(e)=>{e.preventDefault();const p1=document.getElementById('editVideoParentId1').value,p2=document.getElementById('editVideoParentId2').value,vid=document.getElementById('editVideoId').value,l=document.getElementById('editTutorialLink').value,vi=parseVideoLink(l);if(!vi){showModal("Invalid","Bad Link.");return;}const u={title:document.getElementById('editTutorialTitle').value,name:document.getElementById('editTutorialTitle').value,videoType:vi.type,videoId:vi.id,link:l,difficulty:document.getElementById('editTutorialDifficulty').value,notes:document.getElementById('editTutorialNotes').value||'',materialsLink:document.getElementById('editTutorialMaterialsLink').value||''};try{await updateDoc(doc(db,getPath(t,[p1,p2]),vid),u);const cid=`container-level3-${t}-${p2}`,s=document.getElementById(`sort-teacher-${t}-${p2}`);renderContent(t,cid,3,[p1,p2],s?s.value:'name-asc');closeModal(m.id);showModal('Success','Updated.');}catch(e){showModal('Error',e.message);}});f.dataset.l='true';}}
function closeModal(id){const m=document.getElementById(id);if(m)m.style.display='none';}document.querySelectorAll('.modal .close-button').forEach(b=>b.onclick=()=>closeModal(b.closest('.modal').id));
async function handleDeleteItem(t,l,id,p=[]){const c=materialsConfig[t],ln=c[`level${l}`];showModal('Confirm',`Delete ${ln}?`,[{text:'Cancel',class:'logout-btn'},{text:'Delete',class:'logout-btn',callback:async()=>{try{await deleteDoc(doc(db,getPath(t,p),id));if(l===1)renderTeacherManagerView(t);else{const cid=`container-level${l}-${t}-${p[p.length-1]}`,s=document.getElementById(`sort-teacher-${t}-${p[p.length-1]}`);renderContent(t,cid,l,p,s?s.value:'name-asc');}showModal('Success','Deleted.');}catch(e){showModal('Error',e.message);}}}]);setTimeout(()=>{const b=document.getElementById('modalButtons').querySelector('.logout-btn:not(:first-child)');if(b){b.style.borderColor='var(--accent-red)';b.style.color='var(--accent-red)';}},0);}
</script></body></html>
