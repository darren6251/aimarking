<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>darStudy - Tutorial Videos</title>
    <!-- PDF.js library for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- HLS.js for .m3u8 video streaming -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- Define the YouTube API callback *before* loading the API -->
    <script>
        function onYouTubeIframeAPIReady() {
            window.isYouTubeApiReady = true;
        }
    </script>
    <!-- YouTube Iframe API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <!-- Vimeo Player API -->
    <script src="https://player.vimeo.com/api/player.js"></script>
    <!-- Google Font: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- MODERN BLACK & WHITE THEME --- */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #080808;     /* Darker, flatter black */
            --bg-tertiary: #141414;      /* Subtle separation */
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --accent-primary: #ffffff;   /* Pure White for accent (High Contrast) */
            --accent-green: #28c840;     /* Keep for status/success */
            --accent-red: #ef4444;       /* Keep for errors/delete */
            --border-color: #333333;     /* Crisp dark gray borders */
        }

        /* RESET & BASE - Removed global transition to fix typing lag */
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: "Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            overflow-x: hidden;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        button, input, textarea, select { font-family: inherit; }
        button:disabled, select:disabled { opacity: .5; cursor: not-allowed; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- UI COMPONENTS --- */

        /* Auth Styles */
        #authWrapper {
            display: flex; width: 100vw; height: 100vh; position: fixed; top: 0; left: 0;
            opacity: 0; transition: opacity 0.5s ease-in-out; z-index: 1001;
        }
        .login-left-panel, .login-right-panel { width: 50%; display: flex; justify-content: center; align-items: center; padding: 2rem; }
        .login-left-panel { background: var(--bg-primary); color: var(--text-primary); flex-direction: column; text-align: center; }
        .login-left-panel h1 { font-size: 3.5rem; font-weight: 700; letter-spacing: -1px; margin-bottom: 1rem; }
        .login-left-panel p { font-size: 1.25rem; font-weight: 400; line-height: 1.5; margin-bottom: .5rem; color: var(--text-secondary); }
        .login-right-panel { background: var(--bg-secondary); flex-direction: column; border-left: 1px solid var(--border-color); }
        
        #authContainer {
            width: 100%; max-width: 380px; display: flex; flex-direction: column; align-items: stretch;
            background-color: var(--bg-primary); padding: 2.5rem; border-radius: 16px; border: 1px solid var(--border-color);
        }
        #authContainer h2 { font-size: 2rem; font-weight: 600; color: var(--text-primary); margin-bottom: 2rem; text-align: center; letter-spacing: -0.5px; }

        /* Buttons */
        .google-btn {
            display: flex; align-items: center; justify-content: center; gap: 12px; border: 1px solid var(--border-color);
            border-radius: 8px; padding: .75rem; cursor: pointer; background: var(--bg-secondary); color: var(--text-primary);
            font-size: 1rem; font-weight: 500; margin-bottom: 1rem; transition: background 0.2s;
        }
        .google-btn:hover { background-color: var(--bg-tertiary); border-color: var(--text-primary); }
        .google-btn img { height: 20px; }

        .btn-primary, .logout-btn {
            background: transparent; color: var(--text-primary); 
            border: 1px solid var(--border-color);
            border-radius: 30px; padding: 10px 24px; cursor: pointer; font-weight: 600; 
            text-decoration: none; display: inline-block; text-align: center;
            transition: all 0.2s ease;
        }
        .btn-primary:hover, .logout-btn:hover { 
            background: var(--accent-primary); color: var(--bg-primary); 
            border-color: var(--accent-primary); transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
        }
        .logout-btn { border-color: var(--border-color); color: var(--text-secondary); }
        .logout-btn:hover { background: var(--accent-red); border-color: var(--accent-red); color: #fff; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }

        #accessCodeInput {
             background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);
             padding: 12px 18px; border-radius: 8px; width: 100%; margin-bottom: 1rem; text-align: center; font-size: 1rem;
        }
        #accessCodeInput:focus { outline: none; border-color: var(--accent-primary); }

        #appSection { display: none; flex-direction: column; height: 100vh; background-color: var(--bg-primary); animation: fadeIn .6s ease-out both; }

        /* Header */
        header {
            background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(12px); color: var(--text-primary); display: flex;
            align-items: center; padding: 16px 28px; height: auto; border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; position: sticky; top: 0; z-index: 100;
        }
        .logo-container h1 { font-size: 1.8rem; font-weight: 700; letter-spacing: -0.5px; margin-right: 2rem; }
        
        .header-actions { margin-left: auto; display: flex; align-items: center; gap: 0.5rem; }
        .header-actions .tab, .header-actions .dropdown-menu-content a {
            padding: 8px 16px; color: var(--text-secondary); text-decoration: none; border: none; border-radius: 6px;
            background: transparent; font-weight: 500; cursor: pointer; font-size: 0.9rem; display: block;
            width: 100%; text-align: left; transition: color 0.2s, background 0.2s;
        }
        .header-actions .tab:hover, .header-actions .dropdown-menu-content a:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .header-actions .tab.active, .header-actions .dropdown-menu-content a.active { color: var(--bg-primary); background: var(--accent-primary); font-weight: 600; }
        .header-actions .tab::after { display: none; } 

        .user-info { display: flex; align-items: center; gap: 1rem; margin-left: 1.5rem; border-left: 1px solid var(--border-color); padding-left: 1.5rem; }
        #userDisplayName { font-weight: 500; font-size: 0.9rem; color: var(--text-primary); }
        #switchRoleButton {
            background: none; color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 20px;
            padding: 4px 12px; cursor: pointer; font-weight: 500; font-size: 0.8rem; transition: all 0.2s;
        }
        #switchRoleButton:hover { border-color: var(--text-primary); color: var(--text-primary); }

        .dropdown-menu { position: relative; display: inline-block; }
        .dropdown-menu-content {
            display: none; position: absolute; top: calc(100% + 10px); right: 0; background-color: var(--bg-secondary);
            min-width: 200px; box-shadow: 0px 10px 30px rgba(0,0,0,0.5); z-index: 10; border-radius: 12px;
            border: 1px solid var(--border-color); padding: 6px; animation: fadeIn 0.2s ease-out;
        }
        .dropdown-menu:hover .dropdown-menu-content { display: block; }
        
        /* Main Layout */
        main { flex: 1; display: flex; overflow-y: auto; padding: 32px; gap: 32px; justify-content: center; }
        #tutorialSection, #videoPlayerSection { width: 100%; }
        #tutorialSection { display: none; max-width: 1200px; margin: 0 auto; opacity: 0; transition: opacity 0.4s; }
        #videoPlayerSection { display: none; opacity: 0; transition: opacity 0.4s; margin: -32px; padding: 0; flex-direction: row; height: calc(100vh - 64px); }

        /* Forms */
        label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; }
        input, select, textarea {
            width: 100%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 12px 16px; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.95rem; transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-primary); }
        
        .section-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 2rem; letter-spacing: -1px; }
        .form-container { max-width: 100%; margin-bottom: 2rem; background: var(--bg-secondary); padding: 2rem; border-radius: 16px; border: 1px solid var(--border-color); }
        
        /* Cards */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .material-card { 
            background: var(--bg-secondary); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); 
            display: flex; flex-direction: column; text-decoration: none; color: var(--text-primary); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        .material-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); border-color: var(--text-secondary); }
        .material-card-thumbnail { position: relative; background: #000; }
        .material-card-thumbnail img { width: 100%; display: block; aspect-ratio: 16/9; object-fit: cover; opacity: 0.9; }
        .material-card-content { padding: 1.25rem; flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        .material-card-content h3 { font-size: 1.1rem; margin: 0; padding-right: 40px; font-weight: 600; line-height: 1.4; }
        .completion-status { position: absolute; top: 10px; right: 10px; background-color: var(--accent-green); color: #000; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; }
        .difficulty-badge { position: absolute; bottom: 1.25rem; right: 1.25rem; background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 4px; padding: 2px 8px; font-size: 0.7rem; font-weight: 600; }

        /* Filters */
        .viewer-filters-container { display: flex; flex-wrap: wrap; gap: 1.5rem; padding: 1.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 2rem; }
        .filter-step { flex: 1; min-width: 200px; display: flex; flex-direction: column; }
        .filter-step label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .viewer-filters-container select { background-color: var(--bg-primary); }

        /* Teacher Manager */
        .content-item { padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.5rem; background: var(--bg-secondary); }
        .content-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .item-actions button { margin-left: 0.5rem; padding: 4px 12px; font-size: 0.8rem; border-radius: 20px; border-width: 1px; }
        .nested-container { padding-left: 1.5rem; margin-top: 0.5rem; border-left: 1px solid var(--border-color); overflow: hidden; max-height: 0; transition: max-height 0.4s ease; }
        .nested-container.expanded { max-height: 2000px; padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .sub-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 6px; }
        .sub-item:hover { background-color: var(--bg-tertiary); }
        .collapse-arrow { display: inline-block; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid var(--text-secondary); margin-left: 8px; transition: transform 0.3s; }
        .content-header[aria-expanded="true"] .collapse-arrow { transform: rotate(90deg); border-top-color: var(--text-primary); }

        /* Video Player & Sidebar */
        .video-main-content { flex-grow: 1; display: flex; flex-direction: column; background-color: #000; }
        #videoPlayerContainer { flex-grow: 1; position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #videoPlayerContainer iframe, #videoPlayerContainer video { width: 100%; height: 100%; border: none; }
        .video-player-header { padding: 1rem; background: var(--bg-primary); border-bottom: 1px solid var(--border-color); }
        
        .video-sidebar { width: 400px; flex-shrink: 0; background-color: var(--bg-secondary); border-left: 1px solid var(--border-color); padding: 2rem; display: flex; flex-direction: column; gap: 1.5rem; overflow-y: auto; }
        #videoInfoTitle { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem; }
        #videoInfoDescription { color: var(--text-secondary); line-height: 1.6; font-size: 0.95rem; white-space: pre-wrap; }
        
        .completion-control button { width: 100%; padding: 12px; font-weight: 600; border-radius: 8px; cursor: pointer; border: 1px solid var(--border-color); background: transparent; color: var(--text-secondary); transition: all 0.2s; }
        .completion-control button:hover { border-color: var(--text-primary); color: var(--text-primary); background: var(--bg-tertiary); }
        .completion-control button.mark-incomplete { background: var(--bg-tertiary); color: var(--accent-green); border-color: var(--accent-green); }
        
        .topic-playlist { border-top: 1px solid var(--border-color); padding-top: 1.5rem; }
        .topic-playlist h3 { font-size: 0.8rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem; }
        .playlist-item { display: block; padding: 10px; border-radius: 6px; color: var(--text-secondary); text-decoration: none; cursor: pointer; margin-bottom: 4px; transition: all 0.2s; font-size: 0.9rem; }
        .playlist-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .playlist-item.active { background: var(--bg-primary); color: var(--text-primary); font-weight: 600; border: 1px solid var(--border-color); }

        /* --- CHAT WIDGET STYLES (UPDATED) --- */
        .chat-widget { 
            margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 1.5rem; 
            display: flex; flex-direction: column; height: 500px; transition: all 0.2s ease;
        }
        /* Style when dragging file over */
        .chat-widget.drag-active {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
            position: relative;
        }
        .chat-widget.drag-active::after {
            content: "Drop Image Here";
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: bold; color: var(--accent-primary); pointer-events: none;
        }

        .chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .chat-messages {
            flex-grow: 1; overflow-y: auto; background: var(--bg-primary); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 12px; margin-bottom: 12px; font-size: 0.9rem; display: flex; flex-direction: column; gap: 12px;
        }
        .message { padding: 10px 14px; border-radius: 12px; max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background: var(--bg-tertiary); color: var(--text-primary); align-self: flex-end; border-bottom-right-radius: 2px; border: 1px solid var(--border-color); }
        .ai-message { background: var(--bg-secondary); color: var(--text-secondary); align-self: flex-start; border: 1px solid var(--border-color); border-bottom-left-radius: 2px; }
        
        .chat-input-area { display: flex; flex-direction: column; gap: 8px; }
        .chat-input-row { display: flex; gap: 8px; align-items: center; }
        
        #chatInput { margin: 0; border-radius: 24px; padding: 10px 16px; flex-grow: 1; background: var(--bg-primary); border: 1px solid var(--border-color); }
        #chatInput:focus { border-color: var(--accent-primary); }
        
        .chat-btn-icon {
            background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary);
            width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; font-size: 1.2rem;
        }
        .chat-btn-icon:hover { color: var(--text-primary); border-color: var(--text-primary); background: var(--bg-tertiary); }
        #chatSendBtn { background: var(--text-primary); color: var(--bg-primary); border-color: var(--text-primary); }
        #chatSendBtn:hover { opacity: 0.9; transform: scale(1.05); }
        
        .image-preview-container {
            display: none; align-items: center; justify-content: space-between;
            padding: 8px 12px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);
        }
        .image-preview-content { display: flex; align-items: center; gap: 10px; font-size: 0.85rem; color: var(--text-primary); }
        .image-preview-thumb { height: 32px; width: 32px; object-fit: cover; border-radius: 4px; border: 1px solid var(--border-color); }
        .remove-img-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; padding: 0 4px; }
        .remove-img-btn:hover { color: var(--accent-red); }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; animation: fadeIn 0.2s; }
        .modal-content { background-color: var(--bg-secondary); padding: 30px; border-radius: 16px; border: 1px solid var(--border-color); max-width: 500px; width: 90%; position: relative; animation: slideInUp 0.3s; }
        .close-button { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: var(--text-secondary); }
        
        footer { padding: 30px; border-top: 1px solid var(--border-color); text-align: center; color: var(--text-secondary); font-size: 0.8rem; background: var(--bg-secondary); }
        footer a { color: var(--text-secondary); text-decoration: none; border-bottom: 1px dotted var(--text-secondary); }
        
        @media (max-width: 992px) { #videoPlayerSection { flex-direction: column; } .video-sidebar { width: 100%; border-left: none; border-top: 1px solid var(--border-color); } }
        @media (max-width: 768px) { header { flex-direction: column; align-items: flex-start; } .header-actions { margin-top: 1rem; flex-wrap: wrap; width: 100%; } main { padding: 16px; } }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authWrapper" style="display: none;">
        <div class="login-left-panel">
            <h1>darStudy</h1>
            <p>Your Materials Hub</p>
            <p>Rome wasn't built in a day</p>
        </div>
        <div class="login-right-panel"><div id="authContainer"></div></div>
    </div>

    <!-- App Screen -->
    <div id="appSection" style="display: none;">
        <header>
            <div class="logo-container"><h1>darStudy</h1></div>
            <div class="header-actions">
                <a href="home.html" class="tab">Home</a>
                <button id="themeToggleButton" class="tab">Theme</button>
                <div class="dropdown-menu">
                    <button class="tab active" id="materialsButton">Materials</button>
                    <div class="dropdown-menu-content">
                        <a href="tutorials.html" class="tab active">Tutorial Videos</a>
                        <a href="pastpaper.html" class="tab">Past Papers</a>
                        <a href="exercises.html" class="tab">Exercises for Sale</a>
                        <a href="lessonhistory.html" class="tab">Lesson History</a>
                    </div>
                </div>
                <div class="user-info">
                     <span id="userDisplayName"></span>
                     <button id="switchRoleButton">Switch Role</button>
                     <button id="logoutButton" class="logout-btn">Log Out</button>
                </div>
            </div>
        </header>

        <main>
            <!-- Tutorials List -->
            <div id="tutorialSection"></div>

            <!-- Video Player -->
            <div id="videoPlayerSection">
                <div class="video-main-content">
                    <div class="video-player-header">
                        <button class="back-button btn-primary" id="backToTutorialsBtn">‚Üê Back to Tutorials</button>
                    </div>
                    <div id="videoPlayerContainer"></div>
                </div>
                <div class="video-sidebar">
                    <h2 id="videoInfoTitle"></h2>
                    <p id="videoInfoDescription"></p>
                    <div id="materialsLinkContainer" style="display: none;">
                        <a id="materialsLink" href="#" target="_blank" rel="noopener noreferrer" class="btn-primary">Download Materials</a>
                    </div>
                    <div class="completion-control"><button id="completionToggleButton"></button></div>
                    <div id="topicPlaylist" class="topic-playlist"></div>
                    
                    <!-- NEW: AI Chat Widget -->
                    <div id="aiChatWidget" class="chat-widget">
                        <div class="chat-header">
                            <h3 style="margin:0; font-size: 0.85rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">AI Tutor</h3>
                            <button id="clearChatBtn" style="font-size: 0.7rem; padding: 4px 8px; background: transparent; border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-secondary); cursor: pointer;">Clear</button>
                        </div>
                        
                        <div id="chatMessages" class="chat-messages">
                            <div class="message ai-message">Hello! I'm your AI Tutor. Ask me anything about this video!</div>
                        </div>
                        
                        <div class="chat-input-area">
                            <!-- Image Preview Area -->
                            <div id="imagePreviewContainer" class="image-preview-container">
                                <div class="image-preview-content">
                                    <img id="chatImagePreview" class="image-preview-thumb">
                                    <span>Image attached</span>
                                </div>
                                <button id="removeImageBtn" type="button" class="remove-img-btn">√ó</button>
                            </div>
                            
                            <!-- Input Row -->
                            <div class="chat-input-row">
                                <input type="file" id="chatFileInput" accept="image/*" style="display: none;">
                                <button id="attachBtn" class="chat-btn-icon" title="Attach Image">üìé</button>
                                <input type="text" id="chatInput" placeholder="Type a message..." autocomplete="off">
                                <button id="chatSendBtn" class="chat-btn-icon">‚û§</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            
            <div id="finderMaterialsSection" class="finder-window-wrapper"></div>
        </main>

        <footer>
            <a href="mailto:darren_0625@mc-zero.com">Contact: darren_0625@mc-zero.com</a> | Copyright ¬© 2025 darStudy
        </footer>
    </div>

    <!-- Modals -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span><h3 id="modalTitle"></h3><div id="modalMessage"></div><div id="modalButtons"></div>
        </div>
    </div>

    <div id="addVideoModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span><h3>Add New Tutorial Video</h3>
             <form id="addVideoForm">
                <input type="hidden" id="videoParentId1"><input type="hidden" id="videoParentId2">
                 <div style="margin-bottom: 1rem;">
                     <label for="tutorialLink">YouTube Link or Embed Code</label>
                     <textarea id="tutorialLink" required placeholder="Paste URL here..."></textarea>
                     <img id="tutorialThumbnailPreview" style="max-width:200px; margin-top:10px; border-radius:8px; display:none;">
                 </div>
                 <div style="margin-bottom: 1rem;"><label>Video Title</label><input type="text" id="tutorialTitle" required></div>
                 <div style="margin-bottom: 1rem;"><label>Notes (Optional)</label><textarea id="tutorialNotes"></textarea></div>
                 <div style="margin-bottom: 1rem;"><label>Materials Link (Optional)</label><input type="url" id="tutorialMaterialsLink"></div>
                 <div style="margin-bottom: 1.5rem;">
                     <label>Difficulty</label>
                     <select id="tutorialDifficulty">
                         <option value="U">Unspecified</option><option value="1/5">1/5</option><option value="2/5">2/5</option><option value="3/5">3/5</option>
                         <option value="4/5">4/5</option><option value="5/5">5/5</option><option value="5/5*">5/5*</option><option value="5/5**">5/5**</option>
                     </select>
                 </div>
                 <div class="modal-form-buttons"><button type="submit" class="btn-primary">Add Video</button></div>
             </form>
        </div>
    </div>

    <!-- Edit Video Modal -->
    <div id="editVideoModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span><h3>Edit Tutorial Video</h3>
             <form id="editVideoForm">
                <input type="hidden" id="editVideoParentId1"><input type="hidden" id="editVideoParentId2"><input type="hidden" id="editVideoId">
                 <div style="margin-bottom: 1rem;">
                     <label>YouTube Link or Embed Code</label>
                     <textarea id="editTutorialLink" required></textarea>
                     <img id="editTutorialThumbnailPreview" style="max-width:200px; margin-top:10px; border-radius:8px; display:none;">
                 </div>
                 <div style="margin-bottom: 1rem;"><label>Video Title</label><input type="text" id="editTutorialTitle" required></div>
                 <div style="margin-bottom: 1rem;"><label>Notes</label><textarea id="editTutorialNotes"></textarea></div>
                 <div style="margin-bottom: 1rem;"><label>Materials Link</label><input type="url" id="editTutorialMaterialsLink"></div>
                 <div style="margin-bottom: 1.5rem;">
                     <label>Difficulty</label>
                     <select id="editTutorialDifficulty">
                         <option value="U">Unspecified</option><option value="1/5">1/5</option><option value="2/5">2/5</option><option value="3/5">3/5</option>
                         <option value="4/5">4/5</option><option value="5/5">5/5</option><option value="5/5*">5/5*</option><option value="5/5**">5/5**</option>
                     </select>
                 </div>
                 <div class="modal-form-buttons"><button type="submit" class="btn-primary">Save Changes</button></div>
             </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI", authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30", storageBucket: "ai-grading-9bb30.appspot.com",
          messagingSenderId: "298162112230", appId: "1:298162112230:web:529d3f95536991be685d27", measurementId: "G-CHKLKSM17S"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const TEACHER_CODE = "Derren0625"; const STUDENT_CODE = "STUDENT456";

        let app, db, auth;
        let currentUserId = null, currentUserEmail = null, currentUserRole = null, currentUserName = null, currentUserProfile = null;
        let ytPlayer = null, vimeoPlayer = null, directPlayer = null, hls = null, currentVideoItem = null, saveTimeInterval = null, saveTimeTimeout = null;
        const SAVE_TIME_DEBOUNCE = 5000;

        try {
            app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
            console.log("Firebase initialized.");
        } catch (error) { console.error("Firebase Init Error:", error); }

        // --- AUTH & INIT ---
        const authWrapper = document.getElementById('authWrapper');
        const appSection = document.getElementById('appSection');
        const authContainer = document.getElementById('authContainer');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid; currentUserEmail = user.email;
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                try {
                    const userProfileDoc = await getDoc(userProfileRef);
                    if (userProfileDoc.exists() && userProfileDoc.data().role) {
                        const p = userProfileDoc.data(); currentUserProfile = p; currentUserRole = p.role; currentUserName = p.name || user.displayName;
                        await setDoc(userProfileRef, { name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                        showApp();
                    } else {
                        currentUserName = user.displayName; currentUserRole = 'unassigned'; currentUserProfile = {}; showCodeEntry();
                    }
                } catch (e) { showLogin(); }
            } else { currentUserId = null; showLogin(); }
        });

        function showLogin() {
            appSection.style.display = 'none'; authWrapper.style.display = 'flex'; authWrapper.style.opacity = '1';
            authContainer.innerHTML = `<h2>Sign In</h2><button id="googleSignInButton" class="google-btn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"><span>Sign in with Google</span></button><p id="authError" class="error-message"></p>`;
            document.getElementById('googleSignInButton')?.addEventListener('click', async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(e) { document.getElementById('authError').textContent = e.message; } });
        }

        function showCodeEntry() {
            appSection.style.display = 'none'; authWrapper.style.display = 'flex'; authWrapper.style.opacity = '1';
            authContainer.innerHTML = `<h2>Access Code</h2><p style="color:var(--text-secondary);text-align:center;margin-bottom:1rem;">Enter code provided by administrator.</p><input type="text" id="accessCodeInput" placeholder="Enter code"><button id="submitCodeButton" class="btn-primary" style="width:100%">Submit</button><p id="codeError" class="error-message"></p>`;
            document.getElementById('submitCodeButton')?.addEventListener('click', handleSubmitCode);
        }

        async function handleSubmitCode() {
            const code = document.getElementById('accessCodeInput').value.trim();
            let role = null;
            if (code === TEACHER_CODE) role = 'teacher'; else if (code === STUDENT_CODE) role = 'student';
            else { document.getElementById('codeError').textContent = 'Invalid code.'; return; }
            await setDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`), { role: role, name: currentUserName, email: currentUserEmail, lastLogin: Date.now(), unlockedTeachers: role === 'student' ? [] : undefined }, { merge: true });
            currentUserRole = role; showApp();
        }

        async function showApp() {
            authWrapper.style.display = 'none'; appSection.style.display = 'flex';
            document.getElementById('userDisplayName').textContent = `${currentUserName}`;
            setupMaterialSection('tutorials');
            checkDeepLink();
            if (document.getElementById('videoPlayerSection').style.display !== 'flex') showSection('tutorialSection');
        }

        document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));
        
        // --- CHAT WIDGET LOGIC ---
        let currentImageBase64 = null;
        const chatWidget = document.getElementById('aiChatWidget');

        // Drag & Drop Handling
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            chatWidget.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            chatWidget.addEventListener(eventName, () => chatWidget.classList.add('drag-active'), false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            chatWidget.addEventListener(eventName, () => chatWidget.classList.remove('drag-active'), false);
        });

        chatWidget.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if(files.length > 0) handleFiles(files);
        }

        function handleFiles(files) {
            const file = files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onloadend = function() {
                    currentImageBase64 = reader.result;
                    document.getElementById('chatImagePreview').src = currentImageBase64;
                    document.getElementById('imagePreviewContainer').style.display = 'flex';
                }
            }
        }

        // Trigger file input when paperclip is clicked
        document.getElementById('attachBtn').addEventListener('click', () => document.getElementById('chatFileInput').click());

        // Handle File Selection (Traditional)
        document.getElementById('chatFileInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) handleFiles(e.target.files);
        });

        // Remove Image
        document.getElementById('removeImageBtn').addEventListener('click', function() {
            currentImageBase64 = null;
            document.getElementById('chatFileInput').value = '';
            document.getElementById('imagePreviewContainer').style.display = 'none';
        });

        // Send Logic
        document.getElementById('chatInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') handleChatSend(); });
        document.getElementById('chatSendBtn').addEventListener('click', handleChatSend);
        document.getElementById('clearChatBtn').addEventListener('click', () => {
             document.getElementById('chatMessages').innerHTML = '<div class="message ai-message">Hello! I\'m your AI Tutor. Ask me anything about this video!</div>';
        });

        async function handleChatSend() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message && !currentImageBase64) return;
            
            const btn = document.getElementById('chatSendBtn');
            btn.disabled = true; btn.textContent = '...';

            appendMessage(message, 'user', currentImageBase64);
            input.value = '';
            
            // Build Context
            let context = `You are a helpful AI Tutor named darStudy AI. `;
            if(currentVideoItem) context += `The student is watching a video titled "${currentVideoItem.title}". Notes: "${currentVideoItem.notes || 'None'}". `;
            
            const finalPrompt = `${context}\n\nUser Question: ${message}`;
            
            // Call Proxy
            const response = await callProxyAPI(finalPrompt, currentImageBase64);
            
            // Reset
            currentImageBase64 = null;
            document.getElementById('chatFileInput').value = '';
            document.getElementById('imagePreviewContainer').style.display = 'none';

            appendMessage(response, 'ai');
            btn.disabled = false; btn.textContent = '‚û§';
        }

        function appendMessage(text, sender, imageSrc) {
            const container = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${sender}-message`;
            if (imageSrc) msgDiv.innerHTML += `<img src="${imageSrc}" style="max-width:100%; border-radius:8px; margin-bottom:5px;">`;
            if (text) msgDiv.innerHTML += `<span>${text.replace(/\n/g, '<br>')}</span>`;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        async function callProxyAPI(prompt, imageBase64) {
            // Using the user-provided proxy URL
            const url = "https://gemini-proxy-513372702506.us-central1.run.app/proxy";
            
            const parts = [{ text: prompt }];
            if (imageBase64) {
                const base64Data = imageBase64.split(',')[1];
                parts.push({ inlineData: { mimeType: "image/png", data: base64Data } });
            }

            const payload = { contents: [{ role: "user", parts: parts }] };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error(`Server Error: ${response.status}`);
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "I didn't quite get that. Try again?";
            } catch (e) {
                console.error("AI Error:", e);
                return "Error connecting to AI Tutor. Please check your connection or the proxy URL.";
            }
        }

        // --- CORE APP LOGIC ---
        const materialsConfig = { tutorials: { sectionId: 'tutorialSection', collectionName: 'tutorials', title: 'Tutorial Videos', level1: 'Subject', level2: 'Topic', level3: 'Video', modalId: 'addVideoModal' } };
        
        function getPath(type, ids = []) {
            const c = materialsConfig[type].collectionName;
            let p = [`artifacts/${appId}/public/data/${c}`];
            if (ids[0]) p.push(ids[0], materialsConfig[type].level2.toLowerCase() + 's');
            if (ids[1]) p.push(ids[1], materialsConfig[type].level3.toLowerCase() + 's');
            return p.join('/');
        }

        function showSection(id) {
            document.querySelectorAll('main > div').forEach(d => { if(d.id !== 'finderMaterialsSection') d.style.display = 'none'; });
            const t = document.getElementById(id); if(t) { t.style.display = (id === 'videoPlayerSection' ? 'flex' : 'block'); setTimeout(() => t.style.opacity = 1, 50); }
        }

        function setupMaterialSection(type) {
            const config = materialsConfig[type];
            document.getElementById(config.sectionId).innerHTML = `
                <h2 class="section-title">${config.title}</h2>
                <div id="teacher-tabs-${type}" class="tab-btn-container" style="display:none;"><button class="tab-btn active" data-tab="viewer">View Materials</button><button class="tab-btn" data-tab="manager">Manage Content</button></div>
                
                <div id="viewer-${type}-view">
                    <div class="viewer-filters-container">
                        <div class="filter-step"><label>1. Select Teacher</label><select id="teacher-${type}-filter"><option value="">-- Unlock a Teacher --</option></select></div>
                        <div class="filter-step"><label>2. Select ${config.level1}</label><select id="level1-${type}-filter" disabled></select></div>
                        <div class="filter-step"><label>3. Select ${config.level2}</label><select id="level2-${type}-filter" disabled></select></div>
                        <div class="filter-step"><label>4. Sort By</label><select id="sort-${type}-filter" disabled><option value="name-asc">Name (A-Z)</option><option value="diff-asc">Difficulty (Low-High)</option></select></div>
                    </div>
                    <div id="level3-${type}-grid" class="grid-container"></div>
                </div>

                <div id="manager-${type}-view" style="display:none;">
                    <div class="form-container"><h3 class="teacher-group-heading">My Access Code</h3><p style="color:var(--text-secondary);margin-bottom:1rem;font-size:0.9rem;">Share this code with students.</p><div style="display:flex;gap:1rem;align-items:center;"><input type="text" id="teacherAccessCodeInput" placeholder="Code" style="margin:0;"><button id="saveTeacherAccessCodeBtn" class="btn-primary">Save</button></div></div>
                    <div class="form-container"><h3 class="teacher-group-heading">My Subjects</h3><div id="level1-${type}-container-mine"></div><button id="add-level1-${type}-btn" class="btn-primary" style="margin-top:1rem;">Add ${config.level1}</button></div>
                </div>
            `;
            // Add Unlock Button logic via JS for cleaner HTML
            const filterContainer = document.querySelector(`#viewer-${type}-view .filter-step`);
            const unlockBtn = document.createElement('button');
            unlockBtn.className = 'btn-primary'; unlockBtn.style.marginTop = '0.5rem'; unlockBtn.textContent = 'Unlock New Teacher';
            unlockBtn.onclick = () => showInputModal('Unlock Teacher', 'Enter Access Code:', async (code) => {
                const q = query(collection(db, `artifacts/${appId}/public/data/teacherAccessCodes`), where("code", "==", code));
                const snap = await getDocs(q);
                if (snap.empty) { showModal('Error', 'Invalid Code'); return; }
                const tId = snap.docs[0].id;
                let unlocked = currentUserProfile.unlockedTeachers || [];
                if (!unlocked.includes(tId)) { 
                    unlocked.push(tId); await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`), { unlockedTeachers: unlocked });
                    currentUserProfile.unlockedTeachers = unlocked; showModal('Success', 'Teacher Unlocked'); setupViewerFilters(type);
                }
            });
            filterContainer.appendChild(unlockBtn);

            const isTeacher = currentUserRole === 'teacher';
            if(isTeacher) {
                const tabs = document.getElementById(`teacher-tabs-${type}`); tabs.style.display = 'flex';
                tabs.onclick = (e) => { if(e.target.matches('.tab-btn')) { 
                    tabs.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active');
                    document.getElementById(`viewer-${type}-view`).style.display = e.target.dataset.tab === 'viewer' ? 'block' : 'none';
                    document.getElementById(`manager-${type}-view`).style.display = e.target.dataset.tab === 'manager' ? 'block' : 'none';
                }};
                renderTeacherManagerView(type);
                document.getElementById(`add-level1-${type}-btn`).onclick = () => showAddItemModal(type, 1);
                document.getElementById(`manager-${type}-view`).addEventListener('click', (e) => handleTeacherClick(e, type));
                document.getElementById('saveTeacherAccessCodeBtn').onclick = saveTeacherAccessCode;
                if(currentUserProfile.contentAccessCode) document.getElementById('teacherAccessCodeInput').value = currentUserProfile.contentAccessCode;
            } else { document.getElementById(`manager-${type}-view`).remove(); }

            setupViewerFilters(type);
        }

        async function setupViewerFilters(type) {
            const tFilter = document.getElementById(`teacher-${type}-filter`);
            const l1Filter = document.getElementById(`level1-${type}-filter`);
            const l2Filter = document.getElementById(`level2-${type}-filter`);
            
            // Load Teachers
            let subjects = []; let tMap = new Map();
            const snap = await getDocs(query(collection(db, getPath(type)), orderBy('name')));
            snap.forEach(d => { const s = d.data(); s.id = d.id; subjects.push(s); if(s.teacherId) tMap.set(s.teacherId, s.teacherName); });
            
            let unlocked = currentUserProfile?.unlockedTeachers || [];
            if(currentUserRole === 'teacher' && !unlocked.includes(currentUserId)) unlocked.push(currentUserId);
            
            tFilter.innerHTML = '<option value="">-- Select --</option>';
            [...new Set(unlocked.map(id => tMap.get(id)))].filter(Boolean).sort().forEach(n => tFilter.add(new Option(n, n)));

            tFilter.onchange = () => {
                l1Filter.innerHTML = '<option value="">-- Select --</option>'; l1Filter.disabled = false;
                l2Filter.innerHTML = ''; l2Filter.disabled = true;
                const teacherName = tFilter.value;
                subjects.filter(s => s.teacherName === teacherName).forEach(s => l1Filter.add(new Option(s.name, s.id)));
            };

            l1Filter.onchange = async () => {
                l2Filter.innerHTML = '<option value="">-- Select --</option>'; l2Filter.disabled = false;
                const snap = await getDocs(query(collection(db, getPath(type, [l1Filter.value])), orderBy('name')));
                snap.forEach(d => l2Filter.add(new Option(d.data().name, d.id)));
            };

            l2Filter.onchange = () => {
                 document.getElementById(`sort-${type}-filter`).disabled = false;
                 renderViewerItems(type);
            };
            document.getElementById(`sort-${type}-filter`).onchange = () => renderViewerItems(type);
        }

        async function renderViewerItems(type) {
            const l1 = document.getElementById(`level1-${type}-filter`).value;
            const l2 = document.getElementById(`level2-${type}-filter`).value;
            const grid = document.getElementById(`level3-${type}-grid`);
            if(!l1 || !l2) return;
            
            grid.innerHTML = '<p class="loading-indicator">Loading...</p>';
            const snap = await getDocs(query(collection(db, getPath(type, [l1, l2]))));
            
            // Get completion status
            let completedMap = {};
            if(currentUserId) {
                const sSnap = await getDocs(collection(db, `artifacts/${appId}/users/${currentUserId}/videoStatus`));
                sSnap.forEach(d => completedMap[d.id] = d.data().completed);
            }

            grid.innerHTML = '';
            snap.forEach(doc => {
                const item = doc.data(); item.id = doc.id; item.level1Id = l1; item.level2Id = l2;
                const card = document.createElement('div'); card.className = 'material-card'; card.style.animation = 'slideInUp 0.3s ease-out';
                
                const vidId = item.videoId || item.youtubeId;
                let thumb = `https://img.youtube.com/vi/${vidId}/mqdefault.jpg`;
                if(item.videoType === 'vimeo' || item.videoType === 'direct') thumb = 'https://placehold.co/480x360/111/888?text=Video';
                
                card.innerHTML = `
                    <div class="material-card-thumbnail">
                        <img src="${thumb}" onerror="this.src='https://placehold.co/480x360/111/333?text=No+Thumb'">
                        ${completedMap[item.id] ? '<div class="completion-status">‚úì</div>' : ''}
                    </div>
                    <div class="material-card-content">
                        <h3>${item.title}</h3>
                        <span class="difficulty-badge">${item.difficulty || 'U'}</span>
                    </div>`;
                card.onclick = () => showVideoPlayer(item);
                grid.appendChild(card);
            });
        }

        // --- TEACHER MANAGER FUNCTIONS ---
        async function renderTeacherManagerView(type) {
            const container = document.getElementById(`level1-${type}-container-mine`);
            container.innerHTML = 'Loading...';
            const snap = await getDocs(query(collection(db, getPath(type)), where('teacherId', '==', currentUserId), orderBy('name')));
            container.innerHTML = '';
            snap.forEach(doc => {
                const item = doc.data(); item.id = doc.id;
                const el = document.createElement('div'); el.className = 'content-item';
                el.innerHTML = `
                    <div class="content-header" data-level="1" data-id="${item.id}" aria-expanded="false">
                        <h3>${item.name}<span class="collapse-arrow"></span></h3>
                        <div class="item-actions">
                            <button class="add-item-btn btn-primary" data-level="2" data-parent-ids='["${item.id}"]'>Add Topic</button>
                            <button class="delete-item-btn logout-btn" data-level="1" data-id="${item.id}">Delete</button>
                        </div>
                    </div>
                    <div class="nested-container" id="cont-1-${item.id}"></div>`;
                container.appendChild(el);
            });
        }

        function handleTeacherClick(e, type) {
            const header = e.target.closest('.content-header');
            const btn = e.target.closest('button');
            
            if (btn) {
                e.stopPropagation();
                const { level, parentIds, id } = btn.dataset;
                const pIds = parentIds ? JSON.parse(parentIds) : [];
                if (btn.classList.contains('add-item-btn')) {
                    if (level == 2) showAddItemModal(type, 2, pIds);
                    else showAddFinalItemModal(type, pIds);
                } else if (btn.classList.contains('delete-item-btn')) {
                    handleDeleteItem(type, level, id, pIds);
                } else if (btn.classList.contains('edit-item-btn')) {
                    showEditFinalItemModal(type, pIds, id, JSON.parse(btn.dataset.item));
                }
            } else if (header) {
                const level = header.dataset.level; const id = header.dataset.id;
                const isExp = header.getAttribute('aria-expanded') === 'true';
                header.setAttribute('aria-expanded', !isExp);
                const cont = header.nextElementSibling || header.parentElement.querySelector('.nested-container');
                cont.classList.toggle('expanded', !isExp);
                
                if (!isExp && !cont.dataset.loaded) {
                    loadNestedContent(type, parseInt(level) + 1, id, cont);
                    cont.dataset.loaded = 'true';
                }
            }
        }

        async function loadNestedContent(type, level, parentId, container) {
            // Reconstruct parentIds logic roughly or store it better.
            // Simplified: we know level 2 parents is [parentId], level 3 parents is [grandparentId, parentId]
            // For now, let's assume strict structure Subject -> Topic -> Video
            let pIds = [];
            if (level === 2) pIds = [parentId];
            else { 
                // Find grandparent id from DOM
                const gpId = container.closest('.nested-container').id.split('-').pop();
                pIds = [gpId, parentId];
            }
            
            const snap = await getDocs(query(collection(db, getPath(type, pIds)), orderBy(level === 3 ? 'title' : 'name'))); // simplified sort
            
            container.innerHTML = '';
            snap.forEach(doc => {
                const item = doc.data(); item.id = doc.id;
                const el = document.createElement('div');
                if (level === 2) {
                    el.className = 'content-item';
                    el.innerHTML = `
                        <div class="content-header" data-level="2" data-id="${item.id}" aria-expanded="false">
                            <h4>${item.name}<span class="collapse-arrow"></span></h4>
                            <div class="item-actions">
                                <button class="add-item-btn btn-primary" data-level="3" data-parent-ids='${JSON.stringify([...pIds, item.id])}'>Add Video</button>
                                <button class="delete-item-btn logout-btn" data-level="2" data-id="${item.id}">Delete</button>
                            </div>
                        </div>
                        <div class="nested-container" id="cont-2-${item.id}"></div>`;
                } else {
                    el.className = 'sub-item';
                    el.innerHTML = `<span>${item.title}</span>
                    <div class="item-actions">
                        <button class="edit-item-btn btn-primary" data-item='${JSON.stringify(item)}' data-id="${item.id}" data-parent-ids='${JSON.stringify(pIds)}'>Edit</button>
                        <button class="delete-item-btn logout-btn" data-level="3" data-id="${item.id}">Delete</button>
                    </div>`;
                }
                container.appendChild(el);
            });
        }

        // --- VIDEO PLAYER ---
        async function showVideoPlayer(item) {
            currentVideoItem = item;
            showSection('videoPlayerSection');
            document.getElementById('videoInfoTitle').textContent = item.title;
            document.getElementById('videoInfoDescription').textContent = item.notes || '';
            
            // Clear Chat
            document.getElementById('chatMessages').innerHTML = '<div class="message ai-message">Hello! I\'m your AI Tutor. Ask me anything about this video!</div>';
            
            // Update URL
            const url = `?s=${item.level1Id}&t=${item.level2Id}&v=${item.id}`;
            window.history.pushState({}, '', url);

            // Player Logic
            const container = document.getElementById('videoPlayerContainer');
            container.innerHTML = '';
            if (ytPlayer) { ytPlayer.destroy(); ytPlayer = null; }

            const vId = item.videoId || item.youtubeId;
            if (item.videoType === 'youtube' || !item.videoType) {
                container.innerHTML = '<div id="yt-player"></div>';
                setTimeout(() => {
                    ytPlayer = new YT.Player('yt-player', {
                        height: '100%', width: '100%', videoId: vId,
                        playerVars: { autoplay: 1, playsinline: 1 }
                    });
                }, 500);
            } else if (item.videoType === 'vimeo') {
                container.innerHTML = `<iframe src="https://player.vimeo.com/video/${vId}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
            } else {
                container.innerHTML = `<iframe src="${item.link}" allowfullscreen></iframe>`;
            }

            // Playlist
            const plCont = document.getElementById('topicPlaylist');
            plCont.innerHTML = 'Loading...';
            const snap = await getDocs(query(collection(db, getPath('tutorials', [item.level1Id, item.level2Id]))));
            plCont.innerHTML = '<h3>In This Topic</h3>';
            snap.forEach(d => {
                const v = d.data(); v.id = d.id; v.level1Id = item.level1Id; v.level2Id = item.level2Id;
                const el = document.createElement('a'); el.className = `playlist-item ${v.id === item.id ? 'active' : ''}`;
                el.textContent = v.title;
                el.onclick = () => showVideoPlayer(v);
                plCont.appendChild(el);
            });
        }

        // URL Routing
        async function checkDeepLink() {
            const p = new URLSearchParams(window.location.search);
            const s = p.get('s'), t = p.get('t'), v = p.get('v');
            if (s && t && v) {
                const docSnap = await getDoc(doc(db, getPath('tutorials', [s, t]), v));
                if (docSnap.exists()) {
                    const item = docSnap.data(); item.id = docSnap.id; item.level1Id = s; item.level2Id = t;
                    showVideoPlayer(item);
                }
            }
        }

        // --- MODAL HELPERS ---
        function showModal(title, msg) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = msg;
            document.getElementById('messageModal').style.display = 'flex';
        }
        function showInputModal(title, label, cb) {
            showModal(title, '');
            const c = document.getElementById('modalMessage');
            c.innerHTML = `<label>${label}</label><input id="dynIn">`;
            const b = document.createElement('button'); b.className='btn-primary'; b.textContent='Submit'; b.onclick=()=>cb(document.getElementById('dynIn').value);
            c.appendChild(b);
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        document.querySelectorAll('.close-button').forEach(b => b.onclick = () => closeModal(b.closest('.modal').id));
        document.getElementById('backToTutorialsBtn').onclick = () => { showSection('tutorialSection'); window.history.pushState({},'', window.location.pathname); };
        
        async function saveTeacherAccessCode() {
            const c = document.getElementById('teacherAccessCodeInput').value;
            if(!c) return;
            await setDoc(doc(db, `artifacts/${appId}/public/data/teacherAccessCodes`, currentUserId), { code: c, teacherName: currentUserName });
            await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`), { contentAccessCode: c });
            currentUserProfile.contentAccessCode = c; showModal('Saved', 'Code updated.');
        }

        async function showAddItemModal(type, level, pIds) {
            showInputModal(`Add ${level===1?'Subject':'Topic'}`, 'Name:', async (val) => {
                if(!val) return;
                const data = { name: val, createdAt: Date.now() };
                if(level===1) { data.teacherId = currentUserId; data.teacherName = currentUserName; }
                await addDoc(collection(db, getPath(type, pIds)), data);
                if(level===1) renderTeacherManagerView(type); else closeModal('messageModal'); // crude refresh
                showModal('Success', 'Added');
            });
        }
        
        // Helper to handle delete
        async function handleDeleteItem(type, level, id, pIds) {
             if(confirm('Delete this item?')) {
                 await deleteDoc(doc(db, getPath(type, pIds), id));
                 if(level===1) renderTeacherManagerView(type);
             }
        }

        // Add Video Modal Logic
        function showAddFinalItemModal(type, pIds) {
             const m = document.getElementById('addVideoModal');
             m.style.display = 'flex';
             m.querySelector('form').onsubmit = async (e) => {
                 e.preventDefault();
                 const link = document.getElementById('tutorialLink').value;
                 let type = 'youtube', id = '';
                 if(link.includes('vimeo')) { type='vimeo'; id=link.split('/').pop(); }
                 else if(link.includes('youtu')) { type='youtube'; id=link.match(/v=([^&]+)/)?.[1]||link.split('/').pop(); }
                 else type='direct'; // simplified parser
                 
                 await addDoc(collection(db, getPath('tutorials', pIds)), {
                     title: document.getElementById('tutorialTitle').value,
                     link, videoType: type, videoId: id,
                     notes: document.getElementById('tutorialNotes').value,
                     difficulty: document.getElementById('tutorialDifficulty').value
                 });
                 m.style.display = 'none';
             };
        }
    </script>
</body>
