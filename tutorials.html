<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>darStudy - Tutorial Videos</title>
    <!-- PDF.js library for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- HLS.js for .m3u8 video streaming -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- Define the YouTube API callback *before* loading the API -->
    <script>
        function onYouTubeIframeAPIReady() {
            window.isYouTubeApiReady = true;
        }
    </script>
    <!-- YouTube Iframe API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <!-- Vimeo Player API -->
    <script src="https://player.vimeo.com/api/player.js"></script>
    <!-- Google Font: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- MODERN BLACK & WHITE THEME --- */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #080808;     /* Darker, flatter black */
            --bg-tertiary: #111111;      /* Subtle separation */
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --accent-primary: #ffffff;   /* Pure White for accent (High Contrast) */
            --accent-green: #28c840;     /* Keep for status/success */
            --accent-red: #ef4444;       /* Keep for errors/delete */
            --border-color: #333333;     /* Crisp dark gray borders */
            --focus-ring-color: rgba(255, 255, 255, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; transition: all 0.3s ease; }

        body {
            font-family: "Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            overflow-x: hidden;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        button, input, textarea, select { font-family: inherit; }
        button:disabled, select:disabled { opacity: .5; cursor: not-allowed; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Auth Styles */
        #authWrapper {
            display: flex; width: 100vw; height: 100vh; position: fixed; top: 0; left: 0;
            opacity: 0; transition: opacity 0.5s ease-in-out; z-index: 1001;
        }
        .login-left-panel, .login-right-panel { width: 50%; display: flex; justify-content: center; align-items: center; padding: 2rem; }
        .login-left-panel { background: var(--bg-primary); color: var(--text-primary); flex-direction: column; text-align: center; }
        .login-left-panel h1 { font-size: 3.5rem; font-weight: 700; letter-spacing: -1px; margin-bottom: 1rem; }
        .login-left-panel p { font-size: 1.25rem; font-weight: 400; line-height: 1.5; margin-bottom: .5rem; color: var(--text-secondary); }
        .login-right-panel { background: var(--bg-secondary); flex-direction: column; border-left: 1px solid var(--border-color); }
        
        #authContainer {
            width: 100%; max-width: 380px; display: flex; flex-direction: column; align-items: stretch;
            background-color: var(--bg-primary); padding: 2.5rem; border-radius: 16px; border: 1px solid var(--border-color);
        }
        #authContainer h2 { font-size: 2rem; font-weight: 600; color: var(--text-primary); margin-bottom: 2rem; text-align: center; letter-spacing: -0.5px; }

        .google-btn {
            display: flex; align-items: center; justify-content: center; gap: 12px; border: 1px solid var(--border-color);
            border-radius: 8px; padding: .75rem; cursor: pointer; background: var(--bg-secondary); color: var(--text-primary);
            font-size: 1rem; font-weight: 500; margin-bottom: 1rem;
        }
        .google-btn:hover { background-color: var(--bg-tertiary); border-color: var(--text-primary); }
        .google-btn img { height: 20px; }

        #accessCodeInput {
             background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);
             padding: 12px 18px; border-radius: 8px; width: 100%; margin-bottom: 1rem; text-align: center; font-size: 1rem;
        }
        #accessCodeInput:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 2px var(--focus-ring-color); }

        /* Modern Button Styles */
        .btn-primary, .logout-btn {
            background: transparent; color: var(--text-primary); 
            border: 1px solid var(--border-color); /* Thinner border for modern look */
            border-radius: 30px; /* Pill shape */
            padding: 10px 24px; cursor: pointer; font-weight: 600; 
            text-decoration: none; display: inline-block; text-align: center;
            transition: all 0.2s ease;
        }
        
        /* White hover effect */
        .btn-primary:hover, .logout-btn:hover { 
            background: var(--accent-primary); 
            color: var(--bg-primary); /* Invert text to black */
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.15); 
            transform: translateY(-1px);
        }

        .logout-btn { border-color: var(--border-color); color: var(--text-secondary); }
        .logout-btn:hover { 
            background: var(--accent-red); 
            border-color: var(--accent-red); 
            color: #fff; 
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }

        #appSection { display: none; flex-direction: column; height: 100vh; background-color: var(--bg-primary); animation: fadeIn .6s ease-out both; }

        /* Header */
        header {
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(12px); color: var(--text-primary); display: flex;
            align-items: center; padding: 16px 28px; height: auto; border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; position: sticky; top: 0; z-index: 100;
        }
        .logo-container { display: flex; align-items: center; gap: 1rem; }
        .logo-container h1 { font-size: 1.8rem; font-weight: 700; letter-spacing: -0.5px; }
        /* Removed tagline p style */

        .header-actions { margin-left: auto; display: flex; align-items: center; gap: 0.5rem; }
        .header-actions .tab, .header-actions .dropdown-menu-content a {
            padding: 8px 16px; color: var(--text-secondary); text-decoration: none; border: none; border-radius: 4px;
            background: transparent; font-weight: 500; cursor: pointer; font-size: 0.95rem; display: block;
            width: 100%; text-align: left; transition: color 0.2s;
        }
        
        .header-actions .tab:hover, .header-actions .dropdown-menu-content a:hover { color: var(--text-primary); background: transparent; }
        .header-actions .tab.active, .header-actions .dropdown-menu-content a.active { color: var(--accent-primary); font-weight: 600; }
        
        /* Replaced underline with simpler active state */
        .header-actions .tab::after { display: none; } 

        .user-info { display: flex; align-items: center; gap: 1rem; margin-left: 1.5rem; border-left: 1px solid var(--border-color); padding-left: 1.5rem; }
        #userDisplayName { font-weight: 500; font-size: 0.9rem; cursor: pointer; color: var(--text-primary); }
        
        #switchRoleButton {
            background: none; color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 20px;
            padding: 6px 12px; cursor: pointer; font-weight: 500; font-size: 0.8rem;
        }
        #switchRoleButton:hover { border-color: var(--text-primary); color: var(--text-primary); }

        .dropdown-menu { position: relative; display: inline-block; }
        .dropdown-menu-content {
            display: none; position: absolute; top: calc(100% + 10px); right: 0; background-color: var(--bg-secondary);
            min-width: 200px; box-shadow: 0px 10px 30px rgba(0,0,0,0.5); z-index: 10; border-radius: 12px;
            border: 1px solid var(--border-color); padding: 8px; animation: fadeIn 0.2s ease-out;
        }
        .dropdown-menu:hover .dropdown-menu-content { display: block; }
        
        /* Main Content */
        main { flex: 1; display: flex; overflow-y: auto; padding: 32px; gap: 32px; justify-content: center; }
        #tutorialSection { display: none; opacity: 0; transition: opacity 0.4s ease-in-out; width: 100%; max-width: 1200px; margin: 0 auto; }
        #videoPlayerSection { display: none; opacity: 0; transition: opacity 0.4s ease-in-out; width: 100%; max-width: none; padding: 0; margin: -32px; }

        label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; }
        input[type="text"], input[type="number"], input[type="email"], select, input[type="url"], textarea, input[type="date"], input[type="datetime-local"] {
            width: 100%; background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 12px 16px; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.95rem;
        }
        textarea { resize: vertical; min-height: 120px; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-primary); }

        .drop-zone { 
            border: 1px dashed var(--border-color); border-radius: 12px; min-height: 140px; display: flex; 
            flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); 
            font-size: 1rem; margin-bottom: 1.5rem; cursor: pointer; padding: 1rem; text-align: center; 
        }
        .drop-zone.highlight { border-color: var(--accent-primary); background: var(--bg-tertiary); }
        
        .error-message { color: var(--accent-red); font-size: 0.875rem; margin-top: -1rem; margin-bottom: 1rem; }
        .loading-indicator { text-align: center; padding: 1rem; color: var(--text-secondary); }
        .section-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 2rem; letter-spacing: -1px; }
        
        .form-container { 
            max-width: 100%; margin-bottom: 2rem; background: var(--bg-secondary); padding: 2rem; 
            border-radius: 16px; border: 1px solid var(--border-color); 
        }
        .grid-container { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; transition: opacity 0.5s ease-out;
        }

        .material-card { 
            background: var(--bg-secondary); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); 
            display: flex; flex-direction: column; position:relative; text-decoration: none; color: var(--text-primary); cursor: pointer; 
        }
        .material-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); border-color: var(--text-secondary); }
        
        .material-card-thumbnail { position: relative; }
        .material-card-thumbnail img { width: 100%; display: block; aspect-ratio: 16/9; object-fit: cover; opacity: 0.8; transition: opacity 0.3s; }
        .material-card:hover .material-card-thumbnail img { opacity: 1; }
        
        .material-card-content { padding: 1.25rem; flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        .material-card-content h3 { font-size: 1.1rem; margin: 0; padding: 0; padding-right: 40px; font-weight: 600; line-height: 1.4; }
        
        .completion-status { 
            position: absolute; top: 10px; right: 10px; background-color: var(--accent-green); 
            color: #000; border-radius: 50%; width: 24px; height: 24px; 
            display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold;
        }
        
        .difficulty-badge {
            position: absolute; bottom: 1.25rem; right: 1.25rem; background-color: var(--bg-tertiary); 
            color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 4px; 
            padding: 2px 8px; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.5px;
        }
        .difficulty-badge-teacher { color: var(--text-secondary); font-weight: 400; font-size: 0.9rem; margin-left: 8px; }
        
        .tab-btn-container { display: flex; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .tab-btn {
            background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-secondary);
            padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; margin-bottom: -1px;
        }
        .tab-btn:hover { color: var(--text-primary); }
        .tab-btn.active { color: var(--text-primary); border-bottom-color: var(--text-primary); font-weight: 600; }

        .viewer-filters-container {
            display: flex; flex-wrap: wrap; gap: 1.5rem; padding: 1.5rem; background: var(--bg-secondary);
            border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 2rem; animation: slideInUp 0.5s ease-out;
        }
        .filter-step { flex: 1; min-width: 200px; display: flex; flex-direction: column; transition: opacity 0.5s ease; }
        .filter-step label { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 0.5rem; padding-left: 0.5rem; }
        
        .viewer-filters-container select {
            width: 100%; background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 12px 16px; border-radius: 8px; font-size: 0.95rem; transition: all 0.2s ease;
        }
        .viewer-filters-container select:focus { outline: none; border-color: var(--accent-primary); }
        .viewer-filters-container select:disabled { background: var(--bg-secondary); color: var(--border-color); opacity: 0.5; }

        .teacher-sort-container { padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; display: none; }
        .teacher-sort-filter {
            background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 6px 12px; border-radius: 6px; font-size: 0.85rem;
        }
        .teacher-sort-filter:focus { outline: none; border-color: var(--accent-primary); }
        
        .teacher-group-heading {
            font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-top: 2rem; margin-bottom: 1rem;
            padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);
        }
        .form-container .teacher-group-heading { margin-top: 0; }

        .content-item { 
            padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.5rem; 
            background: var(--bg-secondary); transition: all 0.2s ease; 
        }
        .content-item:hover { border-color: var(--text-secondary); }
        
        .content-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 0.5rem; }
        .content-header h3, .content-header h4 { margin: 0; font-weight: 500; }
        
        .item-actions button { margin-left: 0.5rem; padding: 4px 12px; font-size: 0.8rem; border-radius: 20px; border-width: 1px; }
        
        .nested-container { 
            padding-left: 1.5rem; margin-top: 0.5rem; border-left: 1px solid var(--border-color); overflow: hidden;
            transition: max-height 0.4s ease-out, padding-top 0.4s ease-out, padding-bottom 0.4s ease-out;
            max-height: 0; padding-top: 0; padding-bottom: 0;
        }
        .nested-container.expanded { max-height: 1500px; padding-top: 0.5rem; padding-bottom: 0.5rem; }
        
        .sub-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 6px; border: 1px solid transparent; }
        .sub-item:hover { background-color: var(--bg-tertiary); border-color: var(--border-color); }
        .sub-item span { color: var(--text-secondary); font-size: 0.95rem; }
        .sub-item:hover span { color: var(--text-primary); }

        .collapse-arrow {
            margin-left: 10px; transition: transform 0.3s ease-out; display: inline-block; width: 0; height: 0;
            border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 4px solid var(--text-secondary);
        }
        .content-header[aria-expanded="true"] .collapse-arrow { transform: rotate(90deg); border-top-color: var(--text-primary); }
        .content-header[aria-expanded="false"] .collapse-arrow { transform: rotate(0deg); }

        /* Video Player */
        #videoPlayerSection { display: none; flex-direction: row; height: calc(100vh - 64px); }
        .video-main-content { flex-grow: 1; display: flex; flex-direction: column; background-color: #000; }
        #videoPlayerContainer { 
            flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;
        }
        #videoPlayerContainer > iframe, #videoPlayerContainer > video, #videoPlayerContainer > #youtube-player-div {
            width: 100%; height: auto; max-width: 1280px; max-height: 80vh; aspect-ratio: 16/9; border: none;
            border-radius: 0; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-height: 100%;
        }
        #videoPlayerContainer > #youtube-player-div > iframe { width: 100%; height: 100%; position: static; transform: none; aspect-ratio: auto; }
        #videoPlayerContainer > video { height: 100%; width: 100%; object-fit: contain; }
        
        .video-player-header { padding: 1rem; background: var(--bg-primary); border-bottom: 1px solid var(--border-color); }
        .video-sidebar { 
            width: 380px; flex-shrink: 0; background-color: var(--bg-secondary); border-left: 1px solid var(--border-color); 
            padding: 2rem; display: flex; flex-direction: column; gap: 1.5rem; overflow-y: auto; 
        }
        
        #videoInfoTitle { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem; letter-spacing: -0.5px; }
        #videoInfoDescription { color: var(--text-secondary); line-height: 1.6; white-space: pre-wrap; font-size: 0.95rem; }
        
        #materialsLinkContainer a { width: 100%; box-sizing: border-box; padding: 12px; font-size: 0.95rem; }
        
        .completion-control button { width: 100%; padding: 12px; font-size: 0.95rem; font-weight: 600; border-radius: 8px; cursor: pointer; border: 1px solid; }
        .completion-control button.mark-complete { background-color: transparent; color: var(--text-secondary); border-color: var(--border-color); }
        .completion-control button.mark-complete:hover { border-color: var(--text-primary); color: var(--text-primary); background: var(--bg-tertiary); }
        .completion-control button.mark-incomplete { background-color: var(--bg-tertiary); color: var(--accent-green); border-color: var(--accent-green); }
        .completion-control button.mark-incomplete:hover { background-color: var(--bg-secondary); }

        .topic-playlist { border-top: 1px solid var(--border-color); padding-top: 1.5rem; }
        .topic-playlist h3 { font-size: 0.85rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 1px; }
        .topic-playlist .playlist-item {
            display: block; padding: 10px 12px; border-radius: 6px; color: var(--text-secondary); text-decoration: none;
            cursor: pointer; margin-bottom: 0.25rem; transition: all 0.2s ease; font-size: 0.95rem;
        }
        .topic-playlist .playlist-item:hover { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .topic-playlist .playlist-item.active { background-color: var(--bg-primary); color: var(--text-primary); font-weight: 600; border: 1px solid var(--border-color); }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; animation: fadeIn 0.3s ease-out; }
        .modal-content { 
            background-color: var(--bg-secondary); padding: 30px; border-radius: 16px; border: 1px solid var(--border-color); 
            max-width: 500px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; animation: slideInUp 0.3s ease-out; 
        }
        #modalTitle { margin-bottom: 1rem; font-size: 1.5rem; font-weight: 600; }
        .close-button { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: var(--text-secondary); transition: color 0.2s; }
        .close-button:hover { color: var(--text-primary); }
        #modalButtons { display:flex; justify-content: flex-end; gap: 0.75rem; margin-top: 2rem; }
        
        /* PDF Preview */
        #pdfPreviewModal .modal-content { max-width: 90vw; max-height: 90vh; width: auto; height: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        #pdfCanvasContainer { width: 100%; flex-grow: 1; display: flex; justify-content: center; align-items: center; overflow: auto; margin-bottom: 15px; }
        #pdfCanvas { border: 1px solid var(--border-color); display: block; max-width: 100%; height: auto; }
        #pdfControls button { background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        #pdfControls button:hover:not(:disabled) { background-color: var(--border-color); }

        footer { text-align: center; padding: 30px; border-top: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.8rem; z-index: 100; position: static; background: var(--bg-secondary); }
        footer a { color: var(--text-secondary); text-decoration: none; border-bottom: 1px dotted var(--text-secondary); }
        footer a:hover { color: var(--text-primary); border-bottom-color: var(--text-primary); }
        
        .finder-window-wrapper { display: none !important; }
        
        @media (max-width: 992px) {
            #videoPlayerSection { flex-direction: column; }
            .video-sidebar { width: 100%; height: auto; min-height: 250px; border-left: none; border-top: 1px solid var(--border-color);}
        }
        @media (max-width: 768px) {
            #authWrapper { flex-direction: column; position: static; height: auto; }
            .login-left-panel, .login-right-panel { width: 100%; border-left: none; border-top: 1px solid var(--border-color); }
            header { flex-direction: column; height: auto; padding: 1.5rem; align-items: flex-start; }
            .header-actions { margin-left: 0; margin-top: 1.5rem; flex-wrap: wrap; width: 100%; }
            main { flex-direction: column; padding: 20px; }
            .viewer-filters-container { flex-direction: column; gap: 1rem; }
            .filter-step { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div id="authWrapper" style="display: none;">
        <div class="login-left-panel">
            <h1>darStudy</h1><p>Your Materials Hub</p><p>Rome wasn't built in a day</p>
        </div>
        <div class="login-right-panel"><div id="authContainer"></div></div>
    </div>
    <div id="appSection" style="display: none;">
        <header>
            <div class="logo-container"><h1>darStudy</h1></div>
            <div class="header-actions">
                <a href="home.html" class="tab">Home</a>
                <button id="themeToggleButton" class="tab" style="padding-left: 10px; padding-right: 10px;">Theme</button>
                <div class="dropdown-menu">
                    <button class="tab active" id="materialsButton">Materials</button>
                    <div class="dropdown-menu-content">
                        <a href="tutorials.html" class="tab active">Tutorial Videos</a>
                        <a href="pastpaper.html" class="tab">Past Papers</a>
                        <a href="exercises.html" class="tab">Exercises for Sale</a>
                        <a href="lessonhistory.html" class="tab">Lesson History</a>
                    </div>
                </div>
                <div class="user-info">
                     <span id="userDisplayName"></span>
                     <button id="switchRoleButton">Switch Role</button>
                     <button id="logoutButton" class="logout-btn">Log Out</button>
                </div>
            </div>
        </header>
        <main>
            <div id="tutorialSection"></div>
            <div id="videoPlayerSection">
                <div class="video-main-content">
                    <div class="video-player-header"><button class="back-button btn-primary" id="backToTutorialsBtn">← Back to Tutorials</button></div>
                    <div id="videoPlayerContainer"></div>
                </div>
                <div class="video-sidebar">
                    <h2 id="videoInfoTitle"></h2>
                    <p id="videoInfoDescription"></p>
                    <div id="materialsLinkContainer" style="display: none;">
                        <a id="materialsLink" href="#" target="_blank" rel="noopener noreferrer" class="btn-primary">Download Materials</a>
                    </div>
                    <div class="completion-control"><button id="completionToggleButton"></button></div>
                    <div id="topicPlaylist" class="topic-playlist"></div>
                    
                    <!-- NEW: AI Chat Widget -->
                    <div id="aiChatWidget" style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
                        <h3 style="font-size: 0.85rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 1px;">AI Tutor</h3>
                        <div style="width: 100%; height: 400px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background: var(--bg-primary);">
                             <!-- Use iframe for the provided proxy URL -->
                             <iframe src="https://gemini-proxy-513372702506.us-central1.run.app/proxy" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    </div>

                </div>
            </div>
            <div id="finderMaterialsSection" class="finder-window-wrapper"></div>
        </main>
        <footer><a href="mailto:darren_0625@mc-zero.com">Contact: darren_0625@mc-zero.com</a> | Copyright © 2025 darStudy</footer>
    </div>
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span><h3 id="modalTitle"></h3><div id="modalMessage"></div><div id="modalButtons"></div>
        </div>
    </div>
    <div id="addVideoModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span><h3>Add New Tutorial Video</h3>
             <form id="addVideoForm">
                <input type="hidden" id="videoParentId1"><input type="hidden" id="videoParentId2">
                 <div style="margin-bottom: 1rem;">
                     <label for="tutorialLink">YouTube Link or Embed Code</label>
                     <textarea id="tutorialLink" required placeholder="Paste a YouTube URL or an <iframe> embed code here..."></textarea>
                     <img id="tutorialThumbnailPreview" style="max-width:200px; margin-top:10px; border-radius:8px; display:none;" alt="Video Thumbnail Preview"/>
                 </div>
                 <div style="margin-bottom: 1rem;"><label for="tutorialTitle">Video Title</label><input type="text" id="tutorialTitle" required></div>
                 <div style="margin-bottom: 1rem;"><label for="tutorialNotes">Notes (Optional)</label><textarea id="tutorialNotes" placeholder="Add any notes for this video..."></textarea></div>
                 <div style="margin-bottom: 1rem;"><label for="tutorialMaterialsLink">Materials Link (Optional)</label><input type="url" id="tutorialMaterialsLink" placeholder="e.g., https://drive.google.com/..."></div>
                 <div style="margin-bottom: 1.5rem;">
                     <label for="tutorialDifficulty">Difficulty Level</label>
                     <select id="tutorialDifficulty">
                         <option value="U">Unspecified</option><option value="1/5">1/5</option><option value="2/5">2/5</option><option value="3/5">3/5</option>
                         <option value="4/5">4/5</option><option value="5/5">5/5</option><option value="5/5*">5/5*</option><option value="5/5**">5/5**</option>
                     </select>
                 </div>
                 <div class="modal-form-buttons"><button type="submit" class="btn-primary">Add Video</button></div>
             </form>
        </div>
    </div>
    <div id="editVideoModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span><h3>Edit Tutorial Video</h3>
             <form id="editVideoForm">
                <input type="hidden" id="editVideoParentId1"><input type="hidden" id="editVideoParentId2"><input type="hidden" id="editVideoId">
                 <div style="margin-bottom: 1rem;">
                     <label for="editTutorialLink">YouTube Link or Embed Code</label>
                     <textarea id="editTutorialLink" required placeholder="Paste a YouTube URL or an <iframe> embed code here..."></textarea>
                     <img id="editTutorialThumbnailPreview" style="max-width:200px; margin-top:10px; border-radius:8px; display:none;" alt="Video Thumbnail Preview"/>
                 </div>
                 <div style="margin-bottom: 1rem;"><label for="editTutorialTitle">Video Title</label><input type="text" id="editTutorialTitle" required></div>
                 <div style="margin-bottom: 1rem;"><label for="editTutorialNotes">Notes (Optional)</label><textarea id="editTutorialNotes" placeholder="Add any notes for this video..."></textarea></div>
                 <div style="margin-bottom: 1rem;"><label for="editTutorialMaterialsLink">Materials Link (Optional)</label><input type="url" id="editTutorialMaterialsLink" placeholder="e.g., https://drive.google.com/..."></div>
                 <div style="margin-bottom: 1.5rem;">
                     <label for="editTutorialDifficulty">Difficulty Level</label>
                     <select id="editTutorialDifficulty">
                         <option value="U">Unspecified</option><option value="1/5">1/5</option><option value="2/5">2/5</option><option value="3/5">3/5</option>
                         <option value="4/5">4/5</option><option value="5/5">5/5</option><option value="5/5*">5/5*</option><option value="5/5**">5/5**</option>
                     </select>
                 </div>
                 <div class="modal-form-buttons"><button type="submit" class="btn-primary">Save Changes</button></div>
             </form>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, orderBy, getDocs, deleteDoc, where, onSnapshot, writeBatch, collectionGroup } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI", authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30", storageBucket: "ai-grading-9bb30.appspot.com",
          messagingSenderId: "298162112230", appId: "1:298162112230:web:529d3f95536991be685d27", measurementId: "G-CHKLKSM17S"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const TEACHER_CODE = "Derren0625"; const STUDENT_CODE = "STUDENT456";

        let app, db, auth, storage;
        let currentUserId = null, currentUserEmail = null, currentUserRole = null, currentUserName = null, currentUserProfile = null;
        let ytPlayer = null, vimeoPlayer = null, directPlayer = null, hls = null, currentVideoItem = null, saveTimeInterval = null, saveTimeTimeout = null;
        const SAVE_TIME_DEBOUNCE = 5000;
        const authWrapper = document.getElementById('authWrapper');
        const appSection = document.getElementById('appSection');
        const authContainer = document.getElementById('authContainer');

        const googleSignInTemplate = `
            <h2>Sign In</h2><button id="googleSignInButton" class="google-btn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon"><span>Sign in with Google</span></button><p id="authError" class="error-message"></p>`;
        const codeEntryTemplate = `
            <h2>Enter Access Code</h2><p style="color: var(--text-secondary); text-align: center; margin-bottom: 1rem;">Please enter the access code provided by your administrator.</p>
            <input type="text" id="accessCodeInput" placeholder="Enter code here"><button id="submitCodeButton" class="btn-primary" style="width:100%">Submit Code</button><p id="codeError" class="error-message"></p>`;

        try {
            app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); storage = getStorage(app);
            console.log("Firebase initialized successfully.");
        } catch (error) { console.error("Error initializing Firebase:", error); showModal('Firebase Configuration Error', `Failed to initialize Firebase. Error: ${error.message}`); }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid; currentUserEmail = user.email;
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                try {
                    const userProfileDoc = await getDoc(userProfileRef);
                    if (userProfileDoc.exists() && userProfileDoc.data().role) {
                        const profileData = userProfileDoc.data();
                        currentUserProfile = profileData; currentUserRole = profileData.role; currentUserName = profileData.name || user.displayName;
                        await setDoc(userProfileRef, { name: currentUserName, email: currentUserEmail, lastLogin: Date.now() }, { merge: true });
                        showApp();
                    } else {
                        currentUserName = user.displayName; currentUserRole = 'unassigned'; currentUserProfile = {};
                        showCodeEntry();
                    }
                } catch (e) { console.error("Error checking user profile:", e); showModal('Profile Error', `Could not load user profile. Error: ${e.message}`); showLogin(); }
            } else {
                currentUserId = null; currentUserRole = null; currentUserName = null; currentUserProfile = null; showLogin();
            }
        });

        function showLogin() {
            appSection.style.display = 'none'; authWrapper.style.display = 'flex'; authWrapper.style.opacity = '1';
            authContainer.innerHTML = googleSignInTemplate; document.getElementById('googleSignInButton')?.addEventListener('click', handleGoogleSignIn);
        }
        function showCodeEntry() {
            appSection.style.display = 'none'; authWrapper.style.display = 'flex'; authWrapper.style.opacity = '1';
            authContainer.innerHTML = codeEntryTemplate;
            document.getElementById('submitCodeButton')?.addEventListener('click', () => handleSubmitCode());
            document.getElementById('accessCodeInput')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleSubmitCode(); } });
            document.getElementById('accessCodeInput')?.focus();
        }
        async function showApp() {
            authWrapper.style.display = 'none'; appSection.style.display = 'flex';
            document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
            initializeAllMaterialSections();
            
            // Check for deep link params (URL Routing)
            await checkDeepLink();
            
            // If no deep link loaded the video player, show the tutorial section
            if (document.getElementById('videoPlayerSection').style.display !== 'flex') {
                showSection('tutorialSection');
            }
        }

        // --- NEW: URL Routing Logic ---
        async function checkDeepLink() {
            const params = new URLSearchParams(window.location.search);
            const vId = params.get('v'); // Video ID
            const sId = params.get('s'); // Subject ID (Level 1)
            const tId = params.get('t'); // Topic ID (Level 2)

            if (vId && tId && sId) {
                try {
                    // Fetch the specific video doc
                    const videoRef = doc(db, `artifacts/${appId}/public/data/tutorials/${sId}/topics/${tId}/videos/${vId}`);
                    const videoSnap = await getDoc(videoRef);
                    
                    if (videoSnap.exists()) {
                        const item = videoSnap.data();
                        item.id = videoSnap.id;
                        item.level1Id = sId; // Inject parent IDs for playlist
                        item.level2Id = tId;
                        
                        console.log("Deep link found, loading video:", item.title);
                        showVideoPlayer(item);
                    } else {
                        console.log("Deep link video not found, clearing params");
                        // Clear invalid params
                        window.history.replaceState({}, '', window.location.pathname);
                    }
                } catch (e) {
                    console.error("Error loading deep link:", e);
                }
            }
        }

        // Handle browser Back/Forward buttons
        window.addEventListener('popstate', async (event) => {
            const params = new URLSearchParams(window.location.search);
            const vId = params.get('v');
            
            if (vId) {
                // If popping state puts us back to a video URL, load it
                await checkDeepLink();
            } else {
                // Otherwise go back to the list view
                showSection('tutorialSection');
                cleanupPlayers();
            }
        });

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (error) { 
                const authError = document.getElementById('authError'); if (authError) authError.textContent = `Sign-in failed. Error: ${error.message}`; 
            }
        }
        async function handleSubmitCode(codeValue) {
            const code = (codeValue || document.getElementById('accessCodeInput').value).trim();
            const codeError = document.getElementById('codeError'); if(codeError) codeError.textContent = '';
            let roleToSet = null;
            if (code === TEACHER_CODE) roleToSet = 'teacher'; else if (code === STUDENT_CODE) roleToSet = 'student';
            else { if(codeError) codeError.textContent = 'Invalid access code.'; return; }
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                const profileData = { role: roleToSet, name: currentUserName, email: currentUserEmail, lastLogin: Date.now() };
                if (roleToSet === 'student') profileData.unlockedTeachers = [];
                await setDoc(userProfileRef, profileData, { merge: true });
                currentUserRole = roleToSet; currentUserProfile = profileData; showModal('Success!', `Your role has been set to ${roleToSet}.`); showApp();
            } catch (error) { if(codeError) codeError.textContent = `Could not set role. Error: ${error.message}`; }
        }

        document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));
        document.getElementById('switchRoleButton').addEventListener('click', () => { showInputModal('Switch Role', 'Enter new access code:', async (code) => { await handleSubmitCode(code); }); });

        const materialsConfig = { tutorials: { sectionId: 'tutorialSection', collectionName: 'tutorials', title: 'Tutorial Videos', level1: 'Subject', level2: 'Topic', level3: 'Video', modalId: 'addVideoModal' } };
        function getPath(type, ids = []) {
            const config = materialsConfig[type]; const collection = config.collectionName;
            let pathParts = [`artifacts/${appId}/public/data/${collection}`];
            if (ids[0]) pathParts.push(ids[0], config.level2.toLowerCase() + 's');
            if (ids[1]) pathParts.push(ids[1], config.level3.toLowerCase() + 's');
            return pathParts.join('/');
        }
        function initializeAllMaterialSections() { setupMaterialSection('tutorials'); }
        function showSection(sectionId) {
             document.querySelectorAll('main > div').forEach(div => { if (div.id !== 'finderMaterialsSection') { div.style.display = 'none'; } });
             const target = document.getElementById(sectionId);
             if(target) { target.style.display = (sectionId === 'videoPlayerSection') ? 'flex' : 'block'; setTimeout(() => target.style.opacity = 1, 50); }
        }
        function setupMaterialSection(type) {
            const config = materialsConfig[type]; const section = document.getElementById(config.sectionId); if (!section) return;
            section.innerHTML = `
                <h2 class="section-title">${config.title}</h2>
                <div id="teacher-tabs-${type}" class="tab-btn-container" style="display:none;"><button class="tab-btn active" data-tab="viewer">View Materials</button><button class="tab-btn" data-tab="manager">Manage Content</button></div>
                <div id="viewer-${type}-view" style="display:none;">
                    <div class="viewer-filters-container">
                        <div class="filter-step" style="flex-direction: row; align-items: center; gap: 1rem;"><div style="flex-grow: 1;"><label for="teacher-${type}-filter">1. Select Teacher</label><select id="teacher-${type}-filter"><option value="">-- Unlock a Teacher --</option></select></div><button id="unlock-teacher-btn-${type}" class="btn-primary" style="padding: 12px 18px; margin-top: 1.5rem;">Unlock</button></div>
                        <div class="filter-step" id="filter-step-1-${type}" style="opacity: 0.5; pointer-events: none;"><label for="level1-${type}-filter">2. Select ${config.level1}</label><select id="level1-${type}-filter" disabled><option value="">-- Select ${config.level1} --</option></select></div>
                        <div class="filter-step" id="filter-step-2-${type}" style="opacity: 0.5; pointer-events: none;"><label for="level2-${type}-filter">3. Select ${config.level2}</label><select id="level2-${type}-filter" disabled><option value="">-- Select ${config.level2} --</option></select></div>
                        <div class="filter-step" id="filter-step-3-${type}" style="opacity: 0.5; pointer-events: none;"><label for="sort-${type}-filter">4. Sort By</label><select id="sort-${type}-filter" disabled><option value="name-asc">Sort by Name (A-Z)</option><option value="name-desc">Sort by Name (Z-A)</option><option value="diff-asc">Difficulty (Low to High)</option><option value="diff-desc">Difficulty (High to Low)</option></select></div>
                    </div>
                    <div id="level3-${type}-grid" class="grid-container" style="display: none; opacity: 0;"></div>
                </div>
                <div id="manager-${type}-view" style="display:none;">
                     <div class="form-container" id="teacher-code-manager"><h3 class="teacher-group-heading">My Teacher Access Code</h3><p style="color: var(--text-secondary); margin-bottom: 1rem;">Students will use this code to unlock your content. (e.g., ${currentUserName ? currentUserName.split(' ')[0] : 'User'}123)</p><div style="display: flex; gap: 1rem; align-items: center;"><input type="text" id="teacherAccessCodeInput" placeholder="Enter your code..." style="margin-bottom: 0;"><button id="saveTeacherAccessCodeBtn" class="btn-primary">Save Code</button></div><p id="teacherAccessCodeStatus" style="margin-top: 1rem;"></p></div>
                     <div class="form-container" style="max-width: initial;"><h3 id="my-subjects-heading-${type}" class="teacher-group-heading">My Subjects</h3><div id="level1-${type}-container-mine"></div><button id="add-level1-${type}-btn" class="btn-primary" style="margin-top: 1rem;">Add New ${config.level1}</button><button id="migrate-data-btn" class="btn-primary" style="margin-top: 1rem; margin-left: 1rem; background-color: var(--accent-red); border-color: var(--accent-red); display: none;">Fix My Old Subjects</button></div>
                </div>`;
            const isTeacher = currentUserRole === 'teacher'; const viewerSection = document.getElementById(`viewer-${type}-view`);
            const managerSection = document.getElementById(`manager-${type}-view`); const teacherTabs = document.getElementById(`teacher-tabs-${type}`);
            const teacherCodeManager = document.getElementById(`teacher-code-manager`);
            if (isTeacher) {
                teacherTabs.style.display = 'flex'; viewerSection.style.display = 'block'; managerSection.style.display = 'none'; teacherCodeManager.style.display = 'block';
                teacherTabs.addEventListener('click', (e) => {
                    if (e.target.matches('.tab-btn')) {
                        teacherTabs.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active');
                        if (e.target.dataset.tab === 'viewer') { viewerSection.style.display = 'block'; managerSection.style.display = 'none'; } else { viewerSection.style.display = 'none'; managerSection.style.display = 'block'; }
                    }
                });
                renderTeacherManagerView(type); document.getElementById(`add-level1-${type}-btn`).onclick = () => showAddItemModal(type, 1);
                managerSection.addEventListener('click', (e) => handleTeacherClick(e, type)); managerSection.addEventListener('change', (e) => handleTeacherSort(e, type));
                document.getElementById(`migrate-data-btn`).onclick = () => runMigration(type);
                document.getElementById('saveTeacherAccessCodeBtn').onclick = () => saveTeacherAccessCode();
                if (currentUserProfile && currentUserProfile.contentAccessCode) document.getElementById('teacherAccessCodeInput').value = currentUserProfile.contentAccessCode;
            } else { teacherTabs.style.display = 'none'; viewerSection.style.display = 'block'; managerSection.style.display = 'none'; teacherCodeManager.style.display = 'none'; }
            
            viewerSection.addEventListener('click', (e) => {
                if (e.target.id === `unlock-teacher-btn-${type}`) {
                    showInputModal('Unlock Teacher Content', 'Enter the teacher\'s access code:', async (code) => {
                        if (!code) return;
                        try {
                            const publicCodesRef = collection(db, `artifacts/${appId}/public/data/teacherAccessCodes`);
                            const q = query(publicCodesRef, where("code", "==", code.trim()));
                            const snapshot = await getDocs(q);
                            if (snapshot.empty) { showModal('Invalid Code', 'That access code was not found. Please check the code and try again.'); return; }
                            const teacherDoc = snapshot.docs[0]; const teacherId = teacherDoc.id; const teacherName = teacherDoc.data().teacherName;
                            const studentProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                            let unlocked = (currentUserProfile && currentUserProfile.unlockedTeachers) ? [...currentUserProfile.unlockedTeachers] : [];
                            if (unlocked.includes(teacherId)) { showModal('Already Unlocked', `You have already unlocked content from ${teacherName}.`); return; }
                            unlocked.push(teacherId); await updateDoc(studentProfileRef, { unlockedTeachers: unlocked });
                            currentUserProfile.unlockedTeachers = unlocked; showModal('Success!', `You have unlocked content from ${teacherName}. Their subjects will now appear.`);
                            setupViewerFilters(type);
                        } catch (error) { console.error("Error unlocking teacher:", error); showModal('Error', `An error occurred: ${error.message}.`); }
                    });
                }
            });
            const unlockBtn = document.getElementById(`unlock-teacher-btn-${type}`); if (unlockBtn) unlockBtn.style.display = 'inline-block';
            setupViewerFilters(type);
        }

        async function renderTeacherManagerView(type) {
            const config = materialsConfig[type]; const myContainer = document.getElementById(`level1-${type}-container-mine`); if (!myContainer) return;
            myContainer.innerHTML = `<p class="loading-indicator">Loading...</p>`; document.getElementById(`my-subjects-heading-${type}`).textContent = `My Subjects (${currentUserName})`;
            try {
                const subjectsRef = collection(db, getPath(type));
                const mySubjectsQuery = query(subjectsRef, where('teacherId', '==', currentUserId), orderBy('name', 'asc'));
                const orphanSubjectsQuery = query(subjectsRef, where('teacherId', '==', null));
                const [mySubjectsSnapshot, orphanSubjectsSnapshot] = await Promise.all([ getDocs(mySubjectsQuery), getDocs(orphanSubjectsQuery) ]);
                if (mySubjectsSnapshot.empty) { myContainer.innerHTML = `<p>No ${config.level1.toLowerCase()}s created yet.</p>`; } else {
                    let myHtml = '';
                    mySubjectsSnapshot.forEach(doc => {
                        const item = doc.data(); item.id = doc.id; const newParentIds = [item.id]; const nextLevel = 2;
                        let sortDropdownHtml = `<div class="teacher-sort-container"><select id="sort-teacher-${type}-${item.id}" class="teacher-sort-filter" data-type="${type}" data-level="3" data-parent-ids='${JSON.stringify(newParentIds)}'><option value="name-asc">Sort by Name (A-Z)</option><option value="name-desc">Sort by Name (Z-A)</option><option value="diff-asc">Difficulty (Low to High)</option><option value="diff-desc">Difficulty (High to Low)</option></select></div>`;
                        myHtml += `<div class="content-item"><div class="content-header" data-level="1" data-id="${item.id}" data-parent-ids='[]' aria-expanded="false"><h3>${item.name} <span class="collapse-arrow"></span></h3><div class="item-actions"><button class="add-item-btn btn-primary" data-level="${nextLevel}" data-parent-ids='${JSON.stringify(newParentIds)}'>Add ${config[`level${nextLevel}`]}</button><button class="delete-item-btn logout-btn" data-level="1" data-id="${item.id}" data-parent-ids='[]'>Delete</button></div></div>${sortDropdownHtml}<div class="nested-container" id="container-level${nextLevel}-${type}-${doc.id}"></div></div>`;
                    });
                    myContainer.innerHTML = myHtml;
                }
                const migrateBtn = document.getElementById('migrate-data-btn');
                if (!orphanSubjectsSnapshot.empty) { migrateBtn.style.display = 'inline-block'; showModal('Action Required', 'We found some subjects that were created before the new Teacher update. Please click the red "Fix My Old Subjects" button to assign them to your account.'); } else { migrateBtn.style.display = 'none'; }
            } catch (error) { console.error(`Error rendering teacher manager view for ${type}:`, error); myContainer.innerHTML = `<p class="error-message">Error loading content.</p>`; }
        }

        async function renderContent(type, containerId, level, parentIds = [], sortBy = 'name-asc') {
            const container = document.getElementById(containerId); if (!container) return;
            const config = materialsConfig[type]; const levelName = config[`level${level}`];
            if (container.innerHTML.includes('loading') || container.innerHTML === '') container.innerHTML = `<p class="loading-indicator">Loading ${levelName.toLowerCase()}s...</p>`;
            const collectionRef = collection(db, getPath(type, parentIds));
            if (level === 3) {
                 try {
                    const q = query(collectionRef); const snapshot = await getDocs(q);
                    if (snapshot.empty) { container.innerHTML = `<p>No ${levelName.toLowerCase()}s added yet.</p>`; return; }
                    let items = [];
                    snapshot.forEach(doc => { const item = doc.data(); item.id = doc.id; item.level1Id = parentIds[0]; item.level2Id = parentIds[1]; items.push(item); });
                    const difficultySortOrder = { 'U': 0, '1/5': 1, '2/5': 2, '3/5': 3, '4/5': 4, '5/5': 5, '5/5*': 6, '5/5**': 7 };
                    items.sort((a, b) => {
                        const diffA = difficultySortOrder[a.difficulty] ?? 0; const diffB = difficultySortOrder[b.difficulty] ?? 0;
                        const titleA = a.title || a.name || ''; const titleB = b.title || b.name || '';
                        switch (sortBy) { case 'name-desc': return titleB.localeCompare(titleA); case 'diff-asc': return diffA - diffB; case 'diff-desc': return diffB - diffA; case 'name-asc': default: return titleA.localeCompare(titleB); }
                    });
                    container.innerHTML = '';
                    items.forEach(item => {
                        const el = document.createElement('div'); el.className = 'sub-item';
                        el.innerHTML = `<span>${item.name || item.title} <span class="difficulty-badge-teacher">(${item.difficulty || 'U'})</span></span><div class="item-actions"><button class="edit-item-btn btn-primary" data-id="${item.id}" data-parent-ids='${JSON.stringify(parentIds)}' data-item='${JSON.stringify(item)}'>Edit</button><button class="preview-item-btn btn-primary" data-item='${JSON.stringify(item)}'>Preview</button><button class="delete-item-btn logout-btn" data-level="${level}" data-id="${item.id}" data-parent-ids='${JSON.stringify(parentIds)}'>Delete</button></div>`;
                        container.appendChild(el);
                    });
                 } catch (error) { console.error(`Error rendering level ${level} for ${type}:`, error); container.innerHTML = `<p class="error-message">Error loading content.</p>`; }
            } else {
                const q = query(collectionRef, orderBy('name', 'asc'));
                try {
                    const snapshot = await getDocs(q); if (snapshot.empty) { container.innerHTML = `<p>No ${levelName.toLowerCase()}s added yet.</p>`; return; }
                    container.innerHTML = '';
                    snapshot.forEach(doc => {
                        const item = doc.data(); item.id = doc.id; const el = document.createElement('div'); el.className = 'content-item';
                        const nextLevel = level + 1; const newParentIds = [...parentIds, doc.id];
                        let sortDropdownHtml = '';
                        if (nextLevel === 3) { sortDropdownHtml = `<div class="teacher-sort-container"><select id="sort-teacher-${type}-${doc.id}" class="teacher-sort-filter" data-type="${type}" data-level="3" data-parent-ids='${JSON.stringify(newParentIds)}'><option value="name-asc">Sort by Name (A-Z)</option><option value="name-desc">Sort by Name (Z-A)</option><option value="diff-asc">Difficulty (Low to High)</option><option value="diff-desc">Difficulty (High to Low)</option></select></div>`; }
                        el.innerHTML = `<div class="content-header" data-level="${level}" data-id="${doc.id}" data-parent-ids='${JSON.stringify(parentIds)}' aria-expanded="false"><h3>${item.name} <span class="collapse-arrow"></span></h3><div class="item-actions"><button class="add-item-btn btn-primary" data-level="${nextLevel}" data-parent-ids='${JSON.stringify(newParentIds)}'>Add ${config[`level${nextLevel}`]}</button><button class="delete-item-btn logout-btn" data-level="${level}" data-id="${doc.id}" data-parent-ids='${JSON.stringify(parentIds)}'>Delete</button></div></div>${sortDropdownHtml}<div class="nested-container" id="container-level${nextLevel}-${type}-${doc.id}"></div>`;
                        container.appendChild(el);
                    });
                } catch (error) { console.error(`Error rendering level ${level} for ${type}:`, error); container.innerHTML = `<p class="error-message">Error loading content.</p>`; }
            }
        }
        function handleTeacherClick(e, type) {
            const header = e.target.closest('.content-header'); const button = e.target.closest('button');
            if(button) {
                e.stopPropagation(); const { level, parentIds } = button.dataset; const parentIdsArray = JSON.parse(parentIds || '[]');
                if(button.matches('.add-item-btn')) { const nextLevel = parseInt(level); if (nextLevel < 3) showAddItemModal(type, nextLevel, parentIdsArray); else showAddFinalItemModal(type, parentIdsArray); } 
                else if (button.matches('.edit-item-btn')) { const { id, parentIds, item } = button.dataset; showEditFinalItemModal(type, JSON.parse(parentIds), id, JSON.parse(item)); } 
                else if (button.matches('.delete-item-btn')) { handleDeleteItem(type, parseInt(level), button.dataset.id, parentIdsArray); } 
                else if(button.matches('.preview-item-btn')) { handlePreview(type, JSON.parse(button.dataset.item)); }
            } else if (header) {
                const { level, id, parentIds } = header.dataset; const container = document.getElementById(`container-level${parseInt(level) + 1}-${type}-${id}`);
                if (!container) return;
                const sortContainer = header.parentElement.querySelector('.teacher-sort-container'); const isExpanded = header.getAttribute('aria-expanded') === 'true';
                header.setAttribute('aria-expanded', !isExpanded); container.classList.toggle('expanded', !isExpanded);
                if (sortContainer) sortContainer.style.display = !isExpanded ? 'block' : 'none';
                if (!isExpanded && !container.dataset.loaded) { const sortBy = sortContainer ? sortContainer.querySelector('select').value : 'name-asc'; renderContent(type, container.id, parseInt(level) + 1, [...JSON.parse(parentIds), id], sortBy); container.dataset.loaded = 'true'; }
            }
        }
        async function runMigration(type) {
            if (!currentUserId) return; showModal('Migrating...', 'Please wait, updating your existing subjects...');
            try {
                const collectionRef = collection(db, getPath(type)); const q = query(collectionRef); const snapshot = await getDocs(q);
                if (snapshot.empty) return; const batch = writeBatch(db); let count = 0;
                snapshot.forEach(doc => { const item = doc.data(); if (!item.teacherId) { batch.update(doc.ref, { teacherId: currentUserId, teacherName: currentUserName }); count++; } });
                if (count > 0) { await batch.commit(); showModal('Success!', `Updated ${count} subjects.`); } else { showModal('All Set!', 'No migration needed.'); }
                renderTeacherManagerView(type); setupViewerFilters(type);
            } catch (error) { console.error(error); showModal('Migration Error', error.message); }
        }
        function handleTeacherSort(e, type) {
            const select = e.target.closest('select.teacher-sort-filter');
            if (select) { e.stopPropagation(); const { level, parentIds } = select.dataset; const parentIdsArray = JSON.parse(parentIds || '[]'); const containerId = `container-level${level}-${type}-${parentIdsArray[parentIdsArray.length - 1]}`; renderContent(type, containerId, parseInt(level), parentIdsArray, select.value); }
        }
        function handlePreview(type, item) { if (type === 'tutorials') showVideoPlayer(item); }

        async function setupViewerFilters(type) {
            const config = materialsConfig[type]; const teacherFilter = document.getElementById(`teacher-${type}-filter`);
            const level1Filter = document.getElementById(`level1-${type}-filter`); const level2Filter = document.getElementById(`level2-${type}-filter`);
            const sortFilter = document.getElementById(`sort-${type}-filter`); const grid = document.getElementById(`level3-${type}-grid`);
            const step1 = document.getElementById(`filter-step-1-${type}`); const step2 = document.getElementById(`filter-step-2-${type}`); const step3 = document.getElementById(`filter-step-3-${type}`);
            let allSubjects = []; let teacherIdToNameMap = new Map(); teacherFilter.innerHTML = `<option value="">-- Loading... --</option>`;
            try {
                const subjectsQuery = query(collection(db, getPath(type)), orderBy('name', 'asc')); const snapshot = await getDocs(subjectsQuery);
                snapshot.forEach(doc => { const subject = doc.data(); subject.id = doc.id; allSubjects.push(subject); if (subject.teacherId) teacherIdToNameMap.set(subject.teacherId, subject.teacherName); });
            } catch (e) { console.error(e); }
            let unlockedTeacherIds = (currentUserProfile && currentUserProfile.unlockedTeachers) ? [...currentUserProfile.unlockedTeachers] : [];
            if (currentUserRole === 'teacher' && !unlockedTeacherIds.includes(currentUserId)) unlockedTeacherIds.push(currentUserId);
            teacherFilter.innerHTML = `<option value="">-- Select a Teacher --</option>`;
            if (unlockedTeacherIds.length === 0) { teacherFilter.innerHTML += (currentUserRole === 'teacher') ? `<option value="" disabled>-- No subjects exist yet --</option>` : `<option value="" disabled>-- Use 'Unlock' to add a teacher --</option>`; }
            else { [...new Set(unlockedTeacherIds.map(id => teacherIdToNameMap.get(id)))].filter(Boolean).sort().forEach(name => teacherFilter.add(new Option(name, name))); }
            teacherFilter.onchange = async () => {
                const selectedTeacher = teacherFilter.value;
                level1Filter.innerHTML = `<option value="">-- Select ${config.level1} --</option>`; level1Filter.disabled = true;
                level2Filter.innerHTML = `<option value="">-- Select ${config.level2} --</option>`; level2Filter.disabled = true;
                sortFilter.disabled = true; grid.style.display = 'none'; grid.style.opacity = 0; grid.innerHTML = '';
                step1.style.opacity = '0.5'; step1.style.pointerEvents = 'none'; step2.style.opacity = '0.5'; step2.style.pointerEvents = 'none'; step3.style.opacity = '0.5'; step3.style.pointerEvents = 'none';
                if (selectedTeacher) {
                    level1Filter.innerHTML = `<option value="">-- Select a ${config.level1} --</option>`;
                    const filteredSubjects = allSubjects.filter(s => s.teacherName === selectedTeacher);
                    if (filteredSubjects.length === 0) level1Filter.innerHTML += `<option value="" disabled>-- No ${config.level1}s Found --</option>`;
                    else filteredSubjects.forEach(subject => level1Filter.add(new Option(subject.name, subject.id)));
                    level1Filter.disabled = false; step1.style.opacity = '1'; step1.style.pointerEvents = 'auto';
                }
            };
            level1Filter.onchange = () => {
                const level1Id = level1Filter.value; level2Filter.innerHTML = `<option value="">-- Select ${config.level2} --</option>`;
                level2Filter.disabled = true; sortFilter.disabled = true; grid.style.display = 'none';
                step2.style.opacity = '0.5'; step3.style.opacity = '0.5';
                if (level1Id) { populateFilter(level2Filter, collection(db, getPath(type, [level1Id])), config.level2); level2Filter.disabled = false; step2.style.opacity = '1'; step2.style.pointerEvents = 'auto'; }
            };
            level2Filter.onchange = () => { if(level2Filter.value) { sortFilter.disabled = false; step3.style.opacity = '1'; step3.style.pointerEvents = 'auto'; renderViewerItems(type); } else { sortFilter.disabled = true; step3.style.opacity = '0.5'; } };
            sortFilter.onchange = () => renderViewerItems(type);
        }

        async function renderViewerItems(type) {
             const config = materialsConfig[type]; const grid = document.getElementById(`level3-${type}-grid`);
             const level1Id = document.getElementById(`level1-${type}-filter`).value; const level2Id = document.getElementById(`level2-${type}-filter`).value; const sortValue = document.getElementById(`sort-${type}-filter`).value;
             grid.innerHTML = `<p class="loading-indicator">Loading...</p>`; grid.style.display = 'grid'; grid.style.opacity = 1;
             if (!level1Id || !level2Id) { grid.style.display = 'none'; return; }
             const itemsRef = collection(db, getPath(type, [level1Id, level2Id])); const q = query(itemsRef);
             let videoStatuses = {}; if(type === 'tutorials' && currentUserId) { const sSnap = await getDocs(collection(db, `artifacts/${appId}/users/${currentUserId}/videoStatus`)); sSnap.forEach(d => videoStatuses[d.id] = d.data().completed); }
             try {
                const snapshot = await getDocs(q); if (snapshot.empty) { grid.innerHTML = `<p>No ${config.level3.toLowerCase()}s found.</p>`; return; }
                let items = []; snapshot.forEach(doc => { const item = doc.data(); item.id = doc.id; item.level1Id = level1Id; item.level2Id = level2Id; items.push(item); });
                const difficultySortOrder = { 'U': 0, '1/5': 1, '2/5': 2, '3/5': 3, '4/5': 4, '5/5': 5, '5/5*': 6, '5/5**': 7 };
                items.sort((a, b) => {
                    const diffA = difficultySortOrder[a.difficulty] ?? 0; const diffB = difficultySortOrder[b.difficulty] ?? 0;
                    const titleA = a.title || a.name || ''; const titleB = b.title || b.name || '';
                    switch (sortValue) { case 'name-desc': return titleB.localeCompare(titleA); case 'diff-asc': return diffA - diffB; case 'diff-desc': return diffB - diffA; case 'name-asc': default: return titleA.localeCompare(titleB); }
                });
                grid.innerHTML = '';
                items.forEach(item => {
                    const card = document.createElement('div'); card.className = 'material-card'; card.style.animation = 'slideInUp 0.5s ease-out both'; card.addEventListener('click', () => handlePreview(type, item));
                    const isCompleted = videoStatuses[item.id];
                    let thumbnailUrl; const videoId = item.videoId || item.youtubeId;
                    if (item.videoType === 'vimeo') thumbnailUrl = `https://placehold.co/480x360/0a0a0a/888888?text=Vimeo+Video`;
                    else if (item.videoType === 'direct') thumbnailUrl = `https://placehold.co/480x360/0a0a0a/888888?text=Direct+Video`;
                    else if (item.videoType === 'html') thumbnailUrl = `https://placehold.co/480x360/0a0a0a/888888?text=HTML+Content`;
                    else thumbnailUrl = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
                    card.innerHTML = `<div class="material-card-thumbnail" data-video-id="${videoId}"><img src="${thumbnailUrl}" alt="${item.title}" onerror="this.onerror=null; this.src='https://placehold.co/480x360/30363d/c9d1d9?text=No%20Thumbnail';">${isCompleted ? '<div class="completion-status">✓</div>' : ''}</div><div class="material-card-content"><h3>${item.title || 'Untitled Video'}</h3><span class="difficulty-badge">${item.difficulty || 'U'}</span></div>`;
                    grid.appendChild(card);
                });
             } catch(e) { console.error("Error loading student items:", e); grid.innerHTML = "<p class='error-message'>Error loading items.</p>" }
        }
        async function populateFilter(selectElement, queryOrRef, levelName) {
            selectElement.innerHTML = `<option value="">-- Loading ${levelName}s --</option>`;
            try {
                let q = (queryOrRef.type === 'collection') ? query(queryOrRef, orderBy('name', 'asc')) : queryOrRef;
                const snapshot = await getDocs(q); selectElement.innerHTML = `<option value="">-- Select a ${levelName} --</option>`;
                if(snapshot.empty) { selectElement.innerHTML += `<option value="" disabled>-- No ${levelName}s Available --</option>`; return; }
                snapshot.forEach(doc => selectElement.add(new Option(doc.data().name, doc.id)));
            } catch (e) { console.error(e); selectElement.innerHTML = `<option value="">-- Error --</option>`; }
        }

        function savePlaybackTime(videoId, currentTime) {
            if (!currentUserId || !videoId || currentTime < 1) return;
            if (saveTimeTimeout) clearTimeout(saveTimeTimeout);
            saveTimeTimeout = setTimeout(async () => {
                try { await setDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/videoPlaybackStatus`, videoId), { lastPlayedTime: currentTime, timestamp: Date.now() }, { merge: true }); } 
                catch (error) { console.error("Error saving playback time:", error); } saveTimeTimeout = null;
            }, SAVE_TIME_DEBOUNCE);
        }
        async function getPlaybackTime(videoId) {
            if (!currentUserId || !videoId) return 0;
            try { const docSnap = await getDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/videoPlaybackStatus`, videoId)); return (docSnap.exists() && docSnap.data().lastPlayedTime) ? docSnap.data().lastPlayedTime : 0; } catch (error) { return 0; }
        }
        function cleanupPlayers() {
            if (ytPlayer) { ytPlayer.destroy(); ytPlayer = null; }
            if (vimeoPlayer) { vimeoPlayer.destroy().catch(e=>console.warn(e)); vimeoPlayer = null; }
            if (directPlayer) { if (hls) { hls.destroy(); hls = null; } directPlayer.pause(); directPlayer.src = ''; directPlayer = null; }
            if (saveTimeInterval) { clearInterval(saveTimeInterval); saveTimeInterval = null; }
            if (saveTimeTimeout) { clearTimeout(saveTimeTimeout); saveTimeTimeout = null; }
            document.getElementById('videoPlayerContainer').innerHTML = '';
        }

        async function showVideoPlayer(item) {
            currentVideoItem = item;
            showSection('videoPlayerSection');
            document.getElementById('videoInfoTitle').textContent = item.title;
            document.getElementById('videoInfoDescription').textContent = item.notes || 'No notes for this video.';
            const materialsLinkEl = document.getElementById('materialsLink');
            if (item.materialsLink) { materialsLinkEl.href = item.materialsLink; document.getElementById('materialsLinkContainer').style.display = 'block'; } else document.getElementById('materialsLinkContainer').style.display = 'none';

            // --- NEW: Update URL to include video params ---
            if (item.level1Id && item.level2Id) {
                const newUrl = `${window.location.pathname}?s=${item.level1Id}&t=${item.level2Id}&v=${item.id}`;
                window.history.pushState({ path: newUrl }, '', newUrl);
            }

            cleanupPlayers();
            const savedTime = await getPlaybackTime(item.id); const playerContainer = document.getElementById('videoPlayerContainer');
            const videoId = item.videoId || item.youtubeId;
            if (item.videoType === 'vimeo') {
                playerContainer.innerHTML = `<iframe src="https://player.vimeo.com/video/${videoId}?muted=1" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;
                vimeoPlayer = new Vimeo.Player(playerContainer.querySelector('iframe'));
                vimeoPlayer.on('ready', () => { if (savedTime > 0.5) vimeoPlayer.setCurrentTime(savedTime).catch(e=>console.warn(e)); vimeoPlayer.play().catch(e=>console.warn(e)); vimeoPlayer.setVolume(1); });
                vimeoPlayer.on('timeupdate', (data) => savePlaybackTime(item.id, data.seconds));
            } else if (item.videoType === 'direct') {
                playerContainer.innerHTML = `<video id="directVideoPlayer" controls autoplay muted style="background-color: #000;"></video>`;
                directPlayer = document.getElementById('directVideoPlayer');
                directPlayer.addEventListener('timeupdate', () => { if(directPlayer) savePlaybackTime(item.id, directPlayer.currentTime); });
                directPlayer.addEventListener('loadedmetadata', () => { if (savedTime > 0 && directPlayer) directPlayer.currentTime = savedTime; if(directPlayer) { directPlayer.play().catch(e=>console.warn(e)); directPlayer.muted = false; } });
                if (item.videoId.includes('.m3u8') && Hls.isSupported()) { hls = new Hls(); hls.loadSource(item.videoId); hls.attachMedia(directPlayer); } else { directPlayer.src = item.videoId; }
            } else if (item.videoType === 'html') {
                playerContainer.innerHTML = `<iframe src="${item.videoId}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;
            } else {
                playerContainer.innerHTML = `<div id="youtube-player-div" style="width: 100%; height: 100%;"></div>`;
                const createPlayer = () => {
                    ytPlayer = new YT.Player('youtube-player-div', { height: '100%', width: '100%', videoId: videoId, playerVars: { 'autoplay': 1, 'playsinline': 1, 'start': Math.floor(savedTime) }, events: {
                        'onReady': (event) => event.target.playVideo(),
                        'onStateChange': (event) => { if (event.data == YT.PlayerState.PLAYING) { if (saveTimeInterval) clearInterval(saveTimeInterval); saveTimeInterval = setInterval(() => { if (ytPlayer?.getCurrentTime) savePlaybackTime(item.id, ytPlayer.getCurrentTime()); }, SAVE_TIME_DEBOUNCE); } else { if (saveTimeInterval) clearInterval(saveTimeInterval); if (ytPlayer?.getCurrentTime) savePlaybackTime(item.id, ytPlayer.getCurrentTime()); } }
                    }});
                };
                if (window.isYouTubeApiReady) createPlayer(); else { const i = setInterval(() => { if (window.isYouTubeApiReady) { clearInterval(i); createPlayer(); } }, 100); }
            }
            await updateCompletionButtonUI(item.id); if (item.level1Id && item.level2Id) await loadTopicPlaylist(item.level1Id, item.level2Id, item.id);
        }

        document.getElementById('backToTutorialsBtn').addEventListener('click', () => {
            showSection('tutorialSection'); cleanupPlayers(); currentVideoItem = null;
            // --- NEW: Clear URL params ---
            window.history.pushState({}, '', window.location.pathname);
            renderViewerItems('tutorials');
        });

        async function loadTopicPlaylist(level1Id, level2Id, currentVideoId) {
            const container = document.getElementById('topicPlaylist'); if (!container) return;
            container.innerHTML = `<h3>In this Topic</h3><p class="loading-indicator" style="padding: 0;">Loading...</p>`;
            try {
                const q = query(collection(db, getPath('tutorials', [level1Id, level2Id])), orderBy('name', 'asc'));
                const snapshot = await getDocs(q); if (snapshot.empty) { container.innerHTML = '<h3>In this Topic</h3><p>No other videos found.</p>'; return; }
                container.innerHTML = '<h3>In this Topic</h3>';
                snapshot.forEach(doc => {
                    const videoData = doc.data(); videoData.id = doc.id; videoData.level1Id = level1Id; videoData.level2Id = level2Id;
                    const itemEl = document.createElement('a'); itemEl.className = 'playlist-item'; if (videoData.id === currentVideoId) itemEl.classList.add('active');
                    itemEl.textContent = videoData.title || 'Untitled Video'; itemEl.onclick = (e) => { e.preventDefault(); showVideoPlayer(videoData); };
                    container.appendChild(itemEl);
                });
            } catch (error) { console.error(error); container.innerHTML = '<h3>In this Topic</h3><p class="error-message">Could not load playlist.</p>'; }
        }

        document.getElementById('completionToggleButton').addEventListener('click', async () => {
            if (!currentVideoItem || !currentUserId) return;
            const statusRef = doc(db, `artifacts/${appId}/users/${currentUserId}/videoStatus`, currentVideoItem.id);
            try {
                const docSnap = await getDoc(statusRef);
                await setDoc(statusRef, { completed: !(docSnap.exists() && docSnap.data().completed), timestamp: Date.now(), videoTitle: currentVideoItem.title, videoId: currentVideoItem.id }, { merge: true });
                await updateCompletionButtonUI(currentVideoItem.id);
            } catch (error) { console.error(error); showModal("Error", "Could not update completion status."); }
        });
        async function updateCompletionButtonUI(videoId) {
            if (!currentUserId) return; const button = document.getElementById('completionToggleButton');
            try { const docSnap = await getDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/videoStatus`, videoId));
                if (docSnap.exists() && docSnap.data().completed) { button.textContent = "✓ Completed"; button.className = 'mark-incomplete'; } else { button.textContent = "Mark as Complete"; button.className = 'mark-complete'; }
            } catch (error) { button.textContent = "Status Error"; button.disabled = true; }
        }
        document.getElementById('themeToggleButton').addEventListener('click', () => showModal("Theme", "This application currently supports dark theme only."));
        document.body.classList.remove('light-theme');

        // --- Helper Functions ---
        async function saveTeacherAccessCode() {
            const input = document.getElementById('teacherAccessCodeInput'); const status = document.getElementById('teacherAccessCodeStatus'); const newCode = input.value.trim();
            if (!newCode) { status.textContent = "Please enter a code."; status.style.color = "var(--accent-red)"; return; }
            status.textContent = "Checking code..."; status.style.color = "var(--text-secondary)";
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/teacherAccessCodes`), where("code", "==", newCode)); const snapshot = await getDocs(q);
                let codeTaken = false; snapshot.forEach(doc => { if (doc.id !== currentUserId) codeTaken = true; });
                if (codeTaken) { status.textContent = "Code already taken."; status.style.color = "var(--accent-red)"; return; }
                const batch = writeBatch(db); batch.update(doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`), { contentAccessCode: newCode });
                batch.set(doc(db, `artifacts/${appId}/public/data/teacherAccessCodes`, currentUserId), { code: newCode, teacherName: currentUserName });
                await batch.commit(); currentUserProfile.contentAccessCode = newCode; status.textContent = "Saved!"; status.style.color = "var(--accent-green)";
            } catch (error) { status.textContent = `Error: ${error.message}`; status.style.color = "var(--accent-red)"; }
        }

        function showModal(title, message, buttons = []) {
            const modal = document.getElementById('messageModal'); if (!modal) return;
            document.getElementById('modalTitle').textContent = title; document.getElementById('modalMessage').innerHTML = message;
            const modalButtons = document.getElementById('modalButtons'); modalButtons.innerHTML = '';
            const createBtn = (text, cls, cb) => { const b = document.createElement('button'); b.textContent = text; b.className = cls; b.onclick = () => { if (cb) cb(); closeModal(modal.id); }; modalButtons.appendChild(b); };
            if (buttons.length === 0) createBtn('OK', 'btn-primary'); else buttons.forEach(b => createBtn(b.text, b.class || 'btn-primary', b.callback));
            modal.querySelector('.close-button').onclick = () => closeModal(modal.id); modal.style.display = 'flex';
        }

        async function showAddItemModal(type, level, parentIds = []) {
            const levelName = materialsConfig[type][`level${level}`];
            showInputModal(`Add New ${levelName}`, `${levelName} Name:`, async (name) => {
                if (!name) return; const newItem = { name: name, createdAt: Date.now() };
                if (level === 1) { newItem.teacherId = currentUserId; newItem.teacherName = currentUserName; }
                try { await addDoc(collection(db, getPath(type, parentIds)), newItem); showModal('Success', `${levelName} added.`); if (level === 1) renderTeacherManagerView(type); else { const sortBy = document.getElementById(`sort-teacher-${type}-${parentIds[parentIds.length-1]}`)?.value || 'name-asc'; renderContent(type, `container-level${level}-${type}-${parentIds[parentIds.length-1]}`, level, parentIds, sortBy); } } catch (error) { showModal('Error', error.message); }
            });
        }

        function showAddFinalItemModal(type, parentIds = []) {
            const modal = document.getElementById('addVideoModal'); if (!modal) return;
            const form = modal.querySelector('form'); if (form) form.reset();
            document.getElementById('tutorialDifficulty').value = 'U'; document.getElementById('tutorialThumbnailPreview').style.display = 'none';
            document.getElementById('videoParentId1').value = parentIds[0] || ''; document.getElementById('videoParentId2').value = parentIds[1] || '';
            modal.style.display = 'flex'; modal.querySelector('.close-button').onclick = () => closeModal(modal.id);
            if (!form.dataset.listenerAttached) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const link = document.getElementById('tutorialLink').value; const videoInfo = parseVideoLink(link);
                    if (!videoInfo) { showModal("Invalid Link", "Use valid YouTube, Vimeo, HTML, or direct video link."); return; }
                    const newItem = { title: document.getElementById('tutorialTitle').value, name: document.getElementById('tutorialTitle').value, videoType: videoInfo.type, videoId: videoInfo.id, link: link, difficulty: document.getElementById('tutorialDifficulty').value, notes: document.getElementById('tutorialNotes').value || '', materialsLink: document.getElementById('tutorialMaterialsLink').value || '', createdAt: Date.now() };
                    try { await addDoc(collection(db, getPath(type, parentIds)), newItem); const sortBy = document.getElementById(`sort-teacher-${type}-${parentIds[1]}`)?.value || 'name-asc'; renderContent(type, `container-level3-${type}-${parentIds[1]}`, 3, parentIds, sortBy); closeModal(modal.id); showModal('Success', 'Video added.'); } catch (error) { showModal('Error', error.message); }
                }); form.dataset.listenerAttached = 'true';
            }
        }
        function parseVideoLink(url) {
            if (!url) return null;
            try {
                if (url.includes('<iframe')) {
                    let m = url.match(/src="https:\/\/www\.youtube\.com\/embed\/([^"?]+)/); if (m && m[1]) return { type: 'youtube', id: m[1] };
                    m = url.match(/src="https:\/\/player\.vimeo\.com\/video\/([^"]+)"/); if (m && m[1]) return { type: 'vimeo', id: m[1] };
                }
                let m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/); if (m && m[2].length === 11) return { type: 'youtube', id: m[2] };
                m = url.match(/https:\/\/player\.vimeo\.com\/video\/([^#\&\?\/]+(?:[?][^ ]*)?)/); if (m && m[1]) return { type: 'vimeo', id: m[1].trim() };
                m = url.match(/^.*(vimeo\.com\/)([^#\&\?\/]+).*/); if (m && m[2]) return { type: 'vimeo', id: m[2] };
                if (url.startsWith('http') && (url.includes('.m3u8') || url.includes('.mp4') || url.includes('.webm') || url.includes('.ogv'))) return { type: 'direct', id: url };
                if (url.startsWith('http') && (url.endsWith('.html') || url.endsWith('.htm'))) return { type: 'html', id: url };
            } catch (e) { return null; } return null;
        }

        const tutorialLinkInput = document.getElementById('tutorialLink');
        if (tutorialLinkInput) { tutorialLinkInput.addEventListener('input', () => { const info = parseVideoLink(tutorialLinkInput.value); const img = document.getElementById('tutorialThumbnailPreview'); if (info && info.type === 'youtube') { img.src = `https://img.youtube.com/vi/${info.id}/mqdefault.jpg`; img.style.display = 'block'; } else img.style.display = 'none'; }); }

        function showInputModal(title, label, callback) {
            const inputId = 'dynamicInput';
            showModal(title, `<label for="${inputId}" style="display:block; margin-bottom: 8px;">${label}</label><input type="text" id="${inputId}" class="modal-input-style" style="width:100%;">`, 
            [{ text: 'Cancel', class: 'logout-btn' }, { text: 'Submit', class: 'btn-primary', callback: () => callback(document.getElementById(inputId).value) }]);
            setTimeout(() => { const i = document.getElementById(inputId); if(i) { i.style.background='transparent'; i.style.border='2px solid var(--border-color)'; i.style.color='var(--text-primary)'; i.style.padding='12px 18px'; i.style.borderRadius='30px'; i.focus(); i.onfocus=()=>i.style.borderColor='var(--accent-primary)'; i.onblur=()=>i.style.borderColor='var(--border-color)'; } }, 50);
        }

        function showEditFinalItemModal(type, parentIds, id, item) {
            const modal = document.getElementById('editVideoModal'); if (!modal) return;
            document.getElementById('editVideoParentId1').value = parentIds[0] || ''; document.getElementById('editVideoParentId2').value = parentIds[1] || ''; document.getElementById('editVideoId').value = id || '';
            document.getElementById('editTutorialLink').value = item.link || ''; document.getElementById('editTutorialTitle').value = item.title || ''; document.getElementById('editTutorialNotes').value = item.notes || ''; document.getElementById('editTutorialMaterialsLink').value = item.materialsLink || ''; document.getElementById('editTutorialDifficulty').value = item.difficulty || 'U';
            const vInfo = parseVideoLink(item.link || ''); const img = document.getElementById('editTutorialThumbnailPreview');
            if (vInfo && vInfo.type === 'youtube') { img.src = `https://img.youtube.com/vi/${vInfo.id}/mqdefault.jpg`; img.style.display = 'block'; } else img.style.display = 'none';
            modal.style.display = 'flex'; modal.querySelector('.close-button').onclick = () => closeModal(modal.id);
            const form = modal.querySelector('form');
            if (!form.dataset.listenerAttached) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const link = document.getElementById('editTutorialLink').value; const vInfo = parseVideoLink(link); if (!vInfo) { showModal("Invalid Link", "Use valid video link."); return; }
                    const updatedItem = { title: document.getElementById('editTutorialTitle').value, name: document.getElementById('editTutorialTitle').value, videoType: vInfo.type, videoId: vInfo.id, link: link, difficulty: document.getElementById('editTutorialDifficulty').value, notes: document.getElementById('editTutorialNotes').value || '', materialsLink: document.getElementById('editTutorialMaterialsLink').value || '' };
                    try { await updateDoc(doc(db, getPath(type, parentIds), document.getElementById('editVideoId').value), updatedItem); const sortBy = document.getElementById(`sort-teacher-${type}-${parentIds[1]}`)?.value || 'name-asc'; renderContent(type, `container-level3-${type}-${parentIds[1]}`, 3, parentIds, sortBy); closeModal(modal.id); showModal('Success', 'Video updated.'); } catch (error) { showModal('Error', error.message); }
                }); form.dataset.listenerAttached = 'true';
            }
        }
        function closeModal(modalId) { const modal = document.getElementById(modalId); if (modal) modal.style.display = 'none'; }
        document.querySelectorAll('.modal .close-button').forEach(btn => btn.onclick = () => closeModal(btn.closest('.modal').id));
        async function handleDeleteItem(type, level, id, parentIds = []) {
            const levelName = materialsConfig[type][`level${level}`];
            showModal('Confirm Deletion', `Delete this ${levelName.toLowerCase()}? Cannot be undone.`, 
            [{ text: 'Cancel', class: 'logout-btn' }, { text: 'Delete', class: 'logout-btn', callback: async () => { try { await deleteDoc(doc(db, getPath(type, parentIds), id)); if (level === 1) renderTeacherManagerView(type); else { const sortBy = document.getElementById(`sort-teacher-${type}-${parentIds[parentIds.length-1]}`)?.value || 'name-asc'; renderContent(type, `container-level${level}-${type}-${parentIds[parentIds.length-1]}`, level, parentIds, sortBy); } showModal('Success', 'Deleted.'); } catch (error) { showModal('Error', error.message); } } }]);
            setTimeout(() => { const btn = document.querySelector('#modalButtons .logout-btn:not(:first-child)'); if(btn) { btn.style.borderColor = 'var(--accent-red)'; btn.style.color = 'var(--accent-red)'; } }, 0);
        }
    </script>
</body>
