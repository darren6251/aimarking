<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>darStudy | The Noir Archive</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://player.vimeo.com/api/player.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #000000;
            --surface: #0a0a0a;
            --surface-hover: #141414;
            --border: #222222;
            --text: #ffffff;
            --text-muted: #888888;
            --accent: #ffffff;
            --danger: #ff4444;
            --success: #00ff88;
            --font-main: 'Inter', sans-serif;
            --font-heading: 'Space+Grotesk', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* Typography */
        h1, h2, h3 { font-family: var(--font-heading); font-weight: 700; letter-spacing: -0.03em; }

        /* Layout */
        #appSection { display: flex; flex-direction: column; min-height: 100vh; }
        
        header {
            padding: 1.5rem 3rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo h1 { font-size: 1.5rem; text-transform: lowercase; }
        .logo span { color: var(--text-muted); }

        .nav-actions { display: flex; gap: 1rem; align-items: center; }

        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            font-size: 0.85rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover { background: var(--text); color: var(--bg); border-color: var(--text); }
        .btn-primary { background: var(--text); color: var(--bg); border-color: var(--text); }
        .btn-primary:hover { background: transparent; color: var(--text); }
        .btn-danger:hover { background: var(--danger); color: white; border-color: var(--danger); }

        /* Main View */
        main { flex: 1; padding: 3rem; max-width: 1400px; margin: 0 auto; width: 100%; }

        .section-header { margin-bottom: 3rem; }
        .section-header h2 { font-size: 3rem; margin-bottom: 0.5rem; }
        .section-header p { color: var(--text-muted); font-size: 1.1rem; }

        /* Filter System */
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 3rem;
        }

        .filter-group label {
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        select, input, textarea {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.8rem;
            border-radius: 4px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        select:focus, input:focus, textarea:focus { outline: none; border-color: var(--text); }

        /* Video Grid */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2rem;
        }

        .video-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
            transition: transform 0.3s, border-color 0.3s;
            cursor: pointer;
            position: relative;
        }

        .video-card:hover { transform: translateY(-5px); border-color: var(--text); }

        .thumbnail { width: 100%; aspect-ratio: 16/9; background: #111; position: relative; }
        .thumbnail img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(0.5); transition: 0.3s; }
        .video-card:hover .thumbnail img { filter: grayscale(0); }

        .card-body { padding: 1.5rem; }
        .card-body h3 { font-size: 1.1rem; margin-bottom: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .badge { font-size: 0.7rem; color: var(--text-muted); border: 1px solid var(--border); padding: 2px 6px; border-radius: 2px; }

        /* Teacher Manager View */
        .manager-container { display: flex; flex-direction: column; gap: 2rem; }
        .manager-card { background: var(--surface); border: 1px solid var(--border); padding: 2rem; border-radius: 8px; }
        
        .item-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 1rem; border-bottom: 1px solid var(--border);
        }
        .item-row:last-child { border-bottom: none; }

        /* Video Player Page */
        #videoPlayerSection { 
            display: none; height: calc(100vh - 80px); 
            grid-template-columns: 1fr 400px;
        }

        .player-main { background: #000; display: flex; flex-direction: column; position: relative; }
        .player-header { padding: 1rem 2rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; background: var(--bg); }
        .iframe-container { flex: 1; display: flex; align-items: center; justify-content: center; background: #000; }
        .iframe-container iframe { width: 100%; height: 100%; border: none; }

        .sidebar { 
            background: var(--surface); border-left: 1px solid var(--border); padding: 2rem; 
            overflow-y: auto; display: flex; flex-direction: column; gap: 1.5rem;
        }

        /* Chat Widget */
        .chat-widget {
            margin-top: auto;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 450px;
        }
        .chat-messages {
            flex: 1; overflow-y: auto; background: var(--bg); border: 1px solid var(--border);
            border-radius: 4px; padding: 1rem; display: flex; flex-direction: column; gap: 1rem;
            font-size: 0.85rem; margin-bottom: 1rem;
        }
        .msg { padding: 0.8rem; border-radius: 4px; max-width: 90%; }
        .msg-ai { background: var(--surface); border: 1px solid var(--border); align-self: flex-start; }
        .msg-user { background: var(--text); color: var(--bg); align-self: flex-end; }

        /* Modal */
        .modal { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); 
            z-index: 1000; align-items: center; justify-content: center; padding: 2rem;
        }
        .modal-content { 
            background: var(--surface); border: 1px solid var(--border); width: 100%; max-width: 600px; 
            border-radius: 8px; padding: 2.5rem; position: relative; 
        }
        .close-modal { position: absolute; top: 1.5rem; right: 1.5rem; cursor: pointer; font-size: 1.5rem; }

        /* Auth */
        #authWrapper { 
            position: fixed; inset: 0; background: #000; display: flex; 
            align-items: center; justify-content: center; z-index: 2000; 
        }
        .auth-card { 
            text-align: center; border: 1px solid var(--border); padding: 4rem; border-radius: 12px; 
            background: var(--surface); max-width: 450px; width: 90%;
        }

        /* Tab buttons */
        .tab-nav { display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border); }
        .tab-nav button { 
            background: none; border: none; color: var(--text-muted); padding: 1rem; 
            cursor: pointer; font-weight: 600; border-bottom: 2px solid transparent;
        }
        .tab-nav button.active { color: var(--text); border-color: var(--text); }

        @media (max-width: 1000px) {
            #videoPlayerSection { grid-template-columns: 1fr; }
            .sidebar { border-left: none; border-top: 1px solid var(--border); height: auto; }
        }
    </style>
</head>
<body>

    <div id="authWrapper">
        <div class="auth-card">
            <h1 style="font-size: 3rem; margin-bottom: 1rem;">darStudy</h1>
            <p style="color: var(--text-muted); margin-bottom: 2rem;">Digital Education. Refined.</p>
            <div id="authContainer">
                <button id="googleSignInBtn" class="btn btn-primary" style="width:100%; justify-content: center;">Sign In with Google</button>
            </div>
        </div>
    </div>

    <div id="appSection" style="display: none;">
        <header>
            <div class="logo"><h1>darStudy<span>.hub</span></h1></div>
            <div class="nav-actions">
                <button class="btn" onclick="location.reload()">Refresh</button>
                <div id="userInfo" style="display: flex; align-items: center; gap: 1rem; margin-left: 1rem; border-left: 1px solid var(--border); padding-left: 1rem;">
                    <span id="userNameDisplay" style="font-size: 0.8rem; font-weight: 600;"></span>
                    <button id="logoutBtn" class="btn btn-danger">Exit</button>
                </div>
            </div>
        </header>

        <main>
            <div id="tutorialSection">
                <div class="section-header">
                    <h2>Tutorials</h2>
                    <p>Select your path and master the material.</p>
                </div>

                <div class="tab-nav" id="roleTabs" style="display: none;">
                    <button class="active" data-tab="viewer">Viewer</button>
                    <button data-tab="manager">Manager</button>
                </div>

                <!-- Viewer -->
                <div id="viewerView">
                    <div class="filters">
                        <div class="filter-group">
                            <label>01. Teacher</label>
                            <select id="teacherFilter"><option value="">Select Teacher</option></select>
                            <button id="unlockTeacherBtn" class="btn" style="margin-top: 0.5rem; width: 100%; font-size: 0.7rem;">Unlock New</button>
                        </div>
                        <div class="filter-group">
                            <label>02. Subject</label>
                            <select id="l1Filter" disabled><option value="">--</option></select>
                        </div>
                        <div class="filter-group">
                            <label>03. Topic</label>
                            <select id="l2Filter" disabled><option value="">--</option></select>
                        </div>
                    </div>
                    <div class="video-grid" id="mainVideoGrid"></div>
                </div>

                <!-- Manager -->
                <div id="managerView" style="display: none;">
                    <div class="manager-container">
                        <div class="manager-card">
                            <h3 style="margin-bottom: 1rem;">Access Control</h3>
                            <div style="display: flex; gap: 1rem;">
                                <input type="text" id="teacherCodeInput" placeholder="Set Access Code">
                                <button id="saveCodeBtn" class="btn btn-primary">Save Code</button>
                            </div>
                        </div>
                        <div class="manager-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                                <h3>Content Hierarchy</h3>
                                <button id="addSubjectBtn" class="btn btn-primary">+ Add Subject</button>
                            </div>
                            <div id="managerList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Video Player -->
            <div id="videoPlayerSection">
                <div class="player-main">
                    <div class="player-header">
                        <button class="btn" id="closePlayerBtn">‚Üê Back to Gallery</button>
                        <h3 id="playerTitle" style="margin-left: 2rem;">Video Title</h3>
                    </div>
                    <div class="iframe-container" id="playerTarget"></div>
                </div>
                <div class="sidebar">
                    <div class="info-block">
                        <label style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Description</label>
                        <p id="playerDesc" style="margin-top: 0.5rem; font-size: 0.9rem;"></p>
                    </div>
                    <div class="chat-widget">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted);">AI Assistant</h4>
                            <button class="btn" style="font-size: 0.6rem; padding: 2px 6px;" onclick="clearChat()">Clear</button>
                        </div>
                        <div class="chat-messages" id="chatList">
                            <div class="msg msg-ai">I'm your noir tutor. Ask me about the video.</div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="chatInput" placeholder="Ask anything...">
                            <button id="chatSendBtn" class="btn btn-primary">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal" id="genericModal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 id="modalTitle" style="margin-bottom: 1.5rem;">Title</h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <div class="modal" id="videoEntryModal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 id="veTitle">Add Video</h2>
            <form id="veForm">
                <input type="hidden" id="veId">
                <div class="filter-group" style="margin-bottom: 1rem;">
                    <label>URL / Link</label>
                    <input type="text" id="veLink" required placeholder="YouTube or Vimeo URL">
                </div>
                <div class="filter-group" style="margin-bottom: 1rem;">
                    <label>Display Title</label>
                    <input type="text" id="veLabel" required>
                </div>
                <div class="filter-group" style="margin-bottom: 1rem;">
                    <label>Notes</label>
                    <textarea id="veNotes" rows="3"></textarea>
                </div>
                <div class="filter-group" style="margin-bottom: 1.5rem;">
                    <label>Difficulty</label>
                    <select id="veDiff">
                        <option value="U">Unspecified</option>
                        <option value="1/5">1/5 - Easy</option>
                        <option value="3/5">3/5 - Intermediate</option>
                        <option value="5/5">5/5 - Expert</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Archive</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, addDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI", authDomain: "ai-grading-9bb30.firebaseapp.com",
            projectId: "ai-grading-9bb30", storageBucket: "ai-grading-9bb30.appspot.com",
            messagingSenderId: "298162112230", appId: "1:298162112230:web:529d3f95536991be685d27"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userProfile = null;
        let currentRole = 'student';

        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                currentUser = u;
                const profRef = doc(db, `artifacts/${appId}/users/${u.uid}/profile/data`);
                const snap = await getDoc(profRef);
                
                if (snap.exists()) {
                    userProfile = snap.data();
                    currentRole = userProfile.role || 'student';
                    initApp();
                } else {
                    promptForCode();
                }
            } else {
                document.getElementById('authWrapper').style.display = 'flex';
                document.getElementById('appSection').style.display = 'none';
            }
        });

        document.getElementById('googleSignInBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        document.getElementById('logoutBtn').onclick = () => signOut(auth);

        async function promptForCode() {
            const code = prompt("Enter Access Code (TEACHER: Derren0625 | STUDENT: STUDENT456):");
            let role = 'student';
            if (code === "Derren0625") role = 'teacher';
            else if (code !== "STUDENT456") { alert("Access Denied"); signOut(auth); return; }

            const profile = { 
                uid: currentUser.uid, 
                name: currentUser.displayName, 
                email: currentUser.email, 
                role, 
                unlockedTeachers: role === 'teacher' ? [currentUser.uid] : [] 
            };
            await setDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/profile/data`), profile);
            userProfile = profile;
            currentRole = role;
            initApp();
        }

        // --- CORE APP ---
        function initApp() {
            document.getElementById('authWrapper').style.display = 'none';
            document.getElementById('appSection').style.display = 'flex';
            document.getElementById('userNameDisplay').textContent = userProfile.name;
            
            if (currentRole === 'teacher') {
                document.getElementById('roleTabs').style.display = 'flex';
                setupManager();
            }
            setupViewer();
        }

        // TABS
        document.querySelectorAll('#roleTabs button').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('#roleTabs button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const isManager = btn.dataset.tab === 'manager';
                document.getElementById('viewerView').style.display = isManager ? 'none' : 'block';
                document.getElementById('managerView').style.display = isManager ? 'block' : 'none';
            };
        });

        // --- VIEWER LOGIC ---
        async function setupViewer() {
            const tFilter = document.getElementById('teacherFilter');
            const l1Filter = document.getElementById('l1Filter');
            const l2Filter = document.getElementById('l2Filter');

            // Load teachers from global index
            const tSnap = await getDocs(collection(db, `artifacts/${appId}/public/data/teacherAccessCodes`));
            const unlocked = userProfile.unlockedTeachers || [];
            
            tFilter.innerHTML = '<option value="">Select Teacher</option>';
            tSnap.forEach(d => {
                if (unlocked.includes(d.id) || currentRole === 'teacher') {
                    const opt = new Option(d.data().teacherName, d.id);
                    tFilter.add(opt);
                }
            });

            tFilter.onchange = async () => {
                if (!tFilter.value) return;
                l1Filter.disabled = false;
                l1Filter.innerHTML = '<option value="">Loading...</option>';
                const subSnap = await getDocs(query(collection(db, `artifacts/${appId}/public/data/tutorials`), where('teacherId', '==', tFilter.value)));
                l1Filter.innerHTML = '<option value="">Select Subject</option>';
                subSnap.forEach(d => l1Filter.add(new Option(d.data().name, d.id)));
            };

            l1Filter.onchange = async () => {
                l2Filter.disabled = false;
                l2Filter.innerHTML = '<option value="">Loading...</option>';
                const path = `artifacts/${appId}/public/data/tutorials/${l1Filter.value}/topics`;
                const topSnap = await getDocs(collection(db, path));
                l2Filter.innerHTML = '<option value="">Select Topic</option>';
                topSnap.forEach(d => l2Filter.add(new Option(d.data().name, d.id)));
            };

            l2Filter.onchange = renderGrid;
            
            document.getElementById('unlockTeacherBtn').onclick = () => {
                const code = prompt("Enter Teacher Access Code:");
                if (!code) return;
                unlockTeacher(code);
            };
        }

        async function unlockTeacher(code) {
            const q = query(collection(db, `artifacts/${appId}/public/data/teacherAccessCodes`), where("code", "==", code));
            const snap = await getDocs(q);
            if (snap.empty) { alert("Invalid Code"); return; }
            const tId = snap.docs[0].id;
            let list = userProfile.unlockedTeachers || [];
            if (!list.includes(tId)) {
                list.push(tId);
                await updateDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/profile/data`), { unlockedTeachers: list });
                userProfile.unlockedTeachers = list;
                setupViewer();
                alert("Teacher Unlocked!");
            }
        }

        async function renderGrid() {
            const l1 = document.getElementById('l1Filter').value;
            const l2 = document.getElementById('l2Filter').value;
            const grid = document.getElementById('mainVideoGrid');
            grid.innerHTML = '<p>Searching the archives...</p>';

            const path = `artifacts/${appId}/public/data/tutorials/${l1}/topics/${l2}/videos`;
            const snap = await getDocs(collection(db, path));
            grid.innerHTML = '';

            if (snap.empty) grid.innerHTML = '<p style="color:var(--text-muted)">No recordings found for this topic.</p>';

            snap.forEach(d => {
                const item = d.data();
                const card = document.createElement('div');
                card.className = 'video-card';
                const vId = parseVideoId(item.link);
                const thumb = item.link.includes('vimeo') ? 'https://placehold.co/600x400/111/fff?text=Vimeo' : `https://img.youtube.com/vi/${vId}/mqdefault.jpg`;

                card.innerHTML = `
                    <div class="thumbnail"><img src="${thumb}"></div>
                    <div class="card-body">
                        <h3>${item.title}</h3>
                        <span class="badge">Difficulty: ${item.difficulty || 'U'}</span>
                    </div>
                `;
                card.onclick = () => openPlayer(item);
                grid.appendChild(card);
            });
        }

        // --- PLAYER LOGIC ---
        function openPlayer(item) {
            document.getElementById('tutorialSection').style.display = 'none';
            document.getElementById('videoPlayerSection').style.display = 'grid';
            document.getElementById('playerTitle').textContent = item.title;
            document.getElementById('playerDesc').textContent = item.notes || 'No description provided.';
            
            const target = document.getElementById('playerTarget');
            const vId = parseVideoId(item.link);
            if (item.link.includes('vimeo')) {
                target.innerHTML = `<iframe src="https://player.vimeo.com/video/${vId}?autoplay=1" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
            } else {
                target.innerHTML = `<iframe src="https://www.youtube.com/embed/${vId}?autoplay=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            }
        }

        document.getElementById('closePlayerBtn').onclick = () => {
            document.getElementById('videoPlayerSection').style.display = 'none';
            document.getElementById('tutorialSection').style.display = 'block';
            document.getElementById('playerTarget').innerHTML = '';
        };

        // --- MANAGER LOGIC (TEACHER ONLY) ---
        async function setupManager() {
            if (userProfile.contentAccessCode) document.getElementById('teacherCodeInput').value = userProfile.contentAccessCode;
            
            document.getElementById('saveCodeBtn').onclick = async () => {
                const code = document.getElementById('teacherCodeInput').value;
                await setDoc(doc(db, `artifacts/${appId}/public/data/teacherAccessCodes`, currentUser.uid), { code, teacherName: userProfile.name });
                await updateDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/profile/data`), { contentAccessCode: code });
                alert("Access code updated.");
            };

            document.getElementById('addSubjectBtn').onclick = async () => {
                const name = prompt("Enter Subject Name:");
                if (!name) return;
                await addDoc(collection(db, `artifacts/${appId}/public/data/tutorials`), { name, teacherId: currentUser.uid, createdAt: Date.now() });
                refreshManager();
            };

            refreshManager();
        }

        async function refreshManager() {
            const list = document.getElementById('managerList');
            list.innerHTML = 'Indexing...';
            const snap = await getDocs(query(collection(db, `artifacts/${appId}/public/data/tutorials`), where('teacherId', '==', currentUser.uid)));
            list.innerHTML = '';

            snap.forEach(d => {
                const subj = d.data();
                const row = document.createElement('div');
                row.className = 'manager-card';
                row.style.marginBottom = '1rem';
                row.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4 style="font-size: 1.2rem;">${subj.name}</h4>
                        <div style="display:flex; gap:0.5rem;">
                            <button class="btn" onclick="addTopic('${d.id}')">+ Topic</button>
                            <button class="btn btn-danger" onclick="deleteItem('tutorials', '${d.id}')">Delete</button>
                        </div>
                    </div>
                    <div id="topics-${d.id}" style="margin-top:1.5rem; padding-left:2rem; border-left:1px solid var(--border);"></div>
                `;
                list.appendChild(row);
                loadTopics(d.id);
            });
        }

        window.addTopic = async (sId) => {
            const name = prompt("Enter Topic Name:");
            if (!name) return;
            await addDoc(collection(db, `artifacts/${appId}/public/data/tutorials/${sId}/topics`), { name, createdAt: Date.now() });
            loadTopics(sId);
        };

        async function loadTopics(sId) {
            const cont = document.getElementById(`topics-${sId}`);
            const snap = await getDocs(collection(db, `artifacts/${appId}/public/data/tutorials/${sId}/topics`));
            cont.innerHTML = '';
            snap.forEach(d => {
                const topic = d.data();
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <span>${topic.name}</span>
                    <div style="display:flex; gap:0.5rem;">
                        <button class="btn" onclick="openVideoModal('${sId}', '${d.id}')">+ Video</button>
                        <button class="btn btn-danger" onclick="deleteItem('topics', '${d.id}', '${sId}')">Delete</button>
                    </div>
                `;
                const vList = document.createElement('div');
                vList.id = `videos-${d.id}`;
                vList.style.paddingLeft = "2rem";
                cont.appendChild(div);
                cont.appendChild(vList);
                loadVideos(sId, d.id);
            });
        }

        async function loadVideos(sId, tId) {
            const cont = document.getElementById(`videos-${tId}`);
            const snap = await getDocs(collection(db, `artifacts/${appId}/public/data/tutorials/${sId}/topics/${tId}/videos`));
            cont.innerHTML = '';
            snap.forEach(d => {
                const v = d.data();
                const div = document.createElement('div');
                div.className = 'item-row';
                div.style.borderBottomStyle = 'dotted';
                div.innerHTML = `
                    <span style="font-size:0.8rem; color:var(--text-muted)">üéûÔ∏è ${v.title}</span>
                    <div style="display:flex; gap:0.5rem;">
                        <button class="btn" onclick="openVideoModal('${sId}', '${tId}', '${d.id}', ${JSON.stringify(v).replace(/"/g, '&quot;')})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteItem('videos', '${d.id}', '${sId}', '${tId}')">Del</button>
                    </div>
                `;
                cont.appendChild(div);
            });
        }

        window.deleteItem = async (type, id, p1, p2) => {
            if (!confirm("Permanently delete this entry?")) return;
            let path = `artifacts/${appId}/public/data/tutorials`;
            if (type === 'topics') path += `/${p1}/topics`;
            if (type === 'videos') path += `/${p1}/topics/${p2}/videos`;
            
            await deleteDoc(doc(db, path, id));
            if (type === 'tutorials') refreshManager();
            else if (type === 'topics') loadTopics(p1);
            else loadVideos(p1, p2);
        };

        // --- VIDEO MODAL LOGIC ---
        window.openVideoModal = (sId, tId, vId = null, existing = null) => {
            const modal = document.getElementById('videoEntryModal');
            const form = document.getElementById('veForm');
            document.getElementById('veTitle').textContent = vId ? "Edit Archive" : "New Archive";
            
            // Reset/Fill Form
            form.reset();
            document.getElementById('veId').value = vId || '';
            if (existing) {
                document.getElementById('veLink').value = existing.link || '';
                document.getElementById('veLabel').value = existing.title || '';
                document.getElementById('veNotes').value = existing.notes || '';
                document.getElementById('veDiff').value = existing.difficulty || 'U';
            }

            modal.style.display = 'flex';

            form.onsubmit = async (e) => {
                e.preventDefault();
                const data = {
                    title: document.getElementById('veLabel').value,
                    link: document.getElementById('veLink').value,
                    notes: document.getElementById('veNotes').value,
                    difficulty: document.getElementById('veDiff').value,
                    updatedAt: Date.now()
                };

                const path = `artifacts/${appId}/public/data/tutorials/${sId}/topics/${tId}/videos`;
                if (vId) {
                    await updateDoc(doc(db, path, vId), data);
                } else {
                    await addDoc(collection(db, path), data);
                }
                
                modal.style.display = 'none';
                loadVideos(sId, tId);
            };
        };

        // HELPERS
        function parseVideoId(url) {
            if (!url) return '';
            if (url.includes('vimeo.com')) return url.split('/').pop();
            const regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : url;
        }

        document.querySelectorAll('.close-modal').forEach(b => b.onclick = () => b.closest('.modal').style.display = 'none');

        // --- CHAT SYSTEM ---
        window.clearChat = () => document.getElementById('chatList').innerHTML = '<div class="msg msg-ai">Archives cleared. Ready for inquiry.</div>';
        
        document.getElementById('chatSendBtn').onclick = async () => {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            
            appendMsg(text, 'user');
            input.value = '';
            
            const prompt = `You are a helpful teaching assistant for a video tutorial site. The user is asking about the following topic. Respond in a concise, helpful tone using Markdown formatting. User Query: ${text}`;
            const response = await fetch("https://gemini-proxy-513372702506.us-central1.run.app/proxy", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Communication failure.";
            appendMsg(aiText, 'ai');
        };

        function appendMsg(text, sender) {
            const list = document.getElementById('chatList');
            const div = document.createElement('div');
            div.className = `msg msg-${sender}`;
            div.innerHTML = sender === 'ai' ? marked.parse(text) : text;
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        }

    </script>
</body>
</html>
