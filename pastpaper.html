<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Google Drive Browser</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lottie -->
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

  <style>
    :root{
      --glass-bg: rgba(255,255,255,0.06);
      --accent: #7dd3fc;
    }
    html,body{height:100%;}
    body{
      background: radial-gradient(1200px 600px at 10% 10%, rgba(125,211,252,0.05), transparent),
                  radial-gradient(1000px 500px at 90% 90%, rgba(255,255,255,0.03), transparent),
                  #0b0b0b;
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display: flex; /* Make body a flex container */
      flex-direction: column; /* Stack children vertically */
    }
    .particle{position:absolute;border-radius:999px;opacity:0.08;filter:blur(6px);}
    .glow-btn{transition: transform .18s cubic-bezier(.2,.9,.3,1), box-shadow .18s;}
    .glow-btn:hover{transform: translateY(-5px) scale(1.02); box-shadow:0 10px 30px rgba(125,211,252,0.10),0 2px 6px rgba(0,0,0,0.6);}
    .glass{background:var(--glass-bg);backdrop-filter: blur(8px);-webkit-backdrop-filter: blur(8px)}
    .focus-ring:focus{outline:none;box-shadow:0 0 0 3px rgba(125,211,252,0.18)}

    /* Auth overlay */
    #authWrapper{
        position:fixed;
        inset:0;
        display:flex; /* Start with flex */
        z-index:1000;
        background:rgba(0,0,0,0.6);
        align-items: center;
        justify-content: center;
    }
    #authCard{max-width:420px;width:92%;}

    /* Cards & inputs */
    .input{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.14);color:#e6eef8;padding:10px;border-radius:10px;width:100%}
    .input::placeholder{color:#94a3b8}
    .btn{border-radius:10px;padding:10px 14px}
    .btn-primary{background:#7dd3fc;color:#111827;font-weight:600}
    .btn-ghost{background:rgba(255,255,255,0.08);color:#e6eef8;border:1px solid rgba(255,255,255,0.14)}
    .error{color:#ef4444;font-size:.9rem; min-height: 1.25rem;} /* Added min-height */
    .label{font-size:.85rem;color:#cbd5e1}
    .pill{border-radius:9999px;background:rgba(255,255,255,0.08);padding:6px 10px;font-size:.8rem}
  </style>
</head>
<body>

  <!-- Floating particles -->
  <div aria-hidden="true">
    <div class="particle" style="width:360px;height:360px;left:-80px;top:-40px;background:linear-gradient(45deg,#0ea5e9,#8b5cf6);filter:blur(80px);opacity:0.06"></div>
    <div class="particle" style="width:220px;height:220px;right:-30px;bottom:60px;background:linear-gradient(45deg,#f97316,#f43f5e);filter:blur(60px);opacity:0.04"></div>
  </div>

  <!-- Auth gate (Exactly as before) -->
  <div id="authWrapper">
    <div class="w-full h-full flex items-center justify-center px-4">
      <div id="authCard" class="glass p-6 rounded-2xl">
        <div class="flex items-center gap-3 mb-4">
          <lottie-player src="https://assets10.lottiefiles.com/packages/lf20_ysas1x0v.json" background="transparent" speed="1" style="width:48px;height:48px" loop autoplay></lottie-player>
          <div>
            <div class="text-xl font-semibold">File Browser</div>
            <div class="text-xs text-white/70 -mt-0.5">Secure • Fast • Easy</div>
          </div>
        </div>

        <!-- Auth States -->
        <div id="authLoading">
          <div class="flex flex-col items-center justify-center py-8">
            <lottie-player src="https://assets8.lottiefiles.com/packages/lf20_usmfx6bp.json" background="transparent" speed="1" style="width:120px;height:120px" loop autoplay></lottie-player>
            <div class="text-sm text-white/70 mt-2">Initializing...</div>
          </div>
        </div>

        <div id="authLogin" style="display: none;">
          <div>
            <h3 class="text-lg font-semibold mb-2">Sign in with Google</h3>
            <p class="text-sm text-white/70 mb-4">Please sign in to access the file browser.</p>
            <button id="googleSignInButton" class="btn btn-primary w-full glow-btn">Continue with Google</button>
          </div>
        </div>

        <div id="authCode" style="display: none;">
          <div class="mt-4">
            <h3 class="text-lg font-semibold mb-2">Enter access code</h3>
            <p class="text-sm text-white/70 mb-3">An access code is required to continue.</p>
            <input type="text" id="accessCodeInput" class="input" placeholder="Enter code"/>
            <button id="submitCodeButton" class="btn btn-primary w-full mt-3 glow-btn">Submit</button>
          </div>
        </div>

        <div id="authError" class="error mt-3"></div>
      </div>
    </div>
  </div>

  <!-- Main Application Content (hidden by default) -->
  <div id="mainContent" style="display: none;" class="flex-1 flex flex-col">
    <!-- NAVBAR (Simplified) -->
    <header class="sticky top-0 z-50 glass border-b border-white/10 backdrop-blur-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Logo -->
          <div class="flex items-center gap-3">
            <button aria-label="logo" class="flex items-center gap-2 focus-ring">
              <lottie-player src="https://assets10.lottiefiles.com/packages/lf20_ysas1x0v.json" background="transparent" speed="1" style="width:44px;height:44px" loop autoplay></lottie-player>
              <div>
                <div class="text-lg font-semibold tracking-wide">File Browser</div>
                <div class="text-xs text-white/60 -mt-0.5">Secure • Fast • Easy</div>
              </div>
            </button>
          </div>

          <!-- User Info & Logout -->
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 px-3 py-1 rounded-full glass">
              <span id="displayName" class="text-xs text-white/70">User</span>
              <span id="userRole" class="pill">Role</span>
              <button id="logoutButton" class="btn btn-ghost">Log out</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- BODY (Replaced with Google Drive Embed) -->
    <main class="flex-1 flex flex-col max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="flex-1 glass rounded-xl overflow-hidden p-4 flex flex-col">
        <h2 class="text-2xl font-bold mb-4">Google Drive Folder</h2>
        <p class="text-sm text-white/70 mb-4">
          This is an embedded Google Drive folder. Make sure the folder is shared appropriately ("Anyone with the link can view").
          To change this, edit the <code class="bg-white/10 px-1 py-0.5 rounded">src</code> attribute of the <code class="bg-white/10 px-1 py-0.5 rounded">&lt;iframe&gt;</code> tag in this HTML file.
        </p>
        
        <!-- 
          *** IMPORTANT ***
          Replace the 'src' URL below with your own Google Drive folder embed link.
          1. Go to your Google Drive folder.
          2. Share it ("Anyone with the link").
          3. Copy the link (e.g., https://drive.google.com/drive/folders/YOUR_FOLDER_ID?usp=sharing)
          4. Change '/folders/' to '/embed?id=' and remove '?usp=sharing'.
          5. Your final URL should look like: https://drive.google.com/embed?id=YOUR_FOLDER_ID
        -->
        <iframe 
          src="https://drive.google.com/drive/folders/1GTacSV8XirEWFnTk-Oz380AiWwXgIWNz" 
          class="flex-1 w-full h-full rounded-md border border-white/10" 
          allow="autoplay">
        </iframe>
        
      </div>
    </main>

    <!-- Footer -->
    <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-white/70">
      <div class="text-sm text-center">© <span id="footerYear">2024</span> File Browser</div>
    </footer>
  </div> <!-- End #mainContent -->


  <!-- Firebase + App (Authentication logic is preserved, features are removed) -->
  <script type="module">
    // --- Firebase Imports (Keeping only what's needed for auth) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

    // --- Firebase Config (Same as original) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
      authDomain: "ai-grading-9bb30.firebaseapp.com",
      projectId: "ai-grading-9bb30",
      storageBucket: "ai-grading-9bb30.appspot.com",
      messagingSenderId: "298162112230",
      appId: "1:298162112230:web:529d3f95536991be685d27",
      measurementId: "G-CHKLKSM17S"
    };

    // --- App Config (Same as original) ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    
    // Use __app_id if available (for canvas environment), otherwise default
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // --- Access Codes (Same as original) ---
    const TEACHER_CODE = "Derren0625";
    const STUDENT_CODE = "STUDENT456";

    // --- DOM References (Simplified) ---
    const dom = {};

    // --- Auth UI Functions (Exactly as before) ---
    function showLoadingState() {
        dom.authWrapper.style.display = 'flex';
        dom.mainContent.style.display = 'none';
        dom.authLoading.style.display = 'block';
        dom.authLogin.style.display = 'none';
        dom.authCode.style.display = 'none';
        dom.authError.textContent = '';
    }

    function showLoginState() {
        dom.authWrapper.style.display = 'flex';
        dom.mainContent.style.display = 'none';
        dom.authLoading.style.display = 'none';
        dom.authLogin.style.display = 'block';
        dom.authCode.style.display = 'none';
        dom.authError.textContent = '';
        dom.googleSignInButton.onclick = googleSignIn;
    }

    function showCodeInputState(user) {
        dom.authWrapper.style.display = 'flex';
        dom.mainContent.style.display = 'none';
        dom.authLoading.style.display = 'none';
        dom.authLogin.style.display = 'none';
        dom.authCode.style.display = 'block';
        dom.authError.textContent = '';
        dom.submitCodeButton.onclick = () => submitCode(user);
    }

    // --- Simplified Main App Function ---
    function showMainApp(user, role) {
        dom.authWrapper.style.display = 'none';
        dom.mainContent.style.display = 'flex'; // Use flex for layout
        dom.displayName.textContent = user.displayName || 'User';
        dom.userRole.textContent = role;
        
        // Simplified UI setup
        dom.logoutButton.onclick = logout;
        document.getElementById('footerYear').textContent = new Date().getFullYear();
    }

    // --- Auth Action Functions (Exactly as before) ---
    async function googleSignIn() {
        dom.authError.textContent = '';
        try {
            await signInWithPopup(auth, provider);
        } catch (e) {
            console.error("Sign-in failed: ", e);
            dom.authError.textContent = 'Sign-in failed. Please try again.';
        }
    }

    async function submitCode(user) {
        dom.authError.textContent = '';
        const code = dom.accessCodeInput.value.trim();
        let roleToSet = (code === TEACHER_CODE) ? 'teacher' : (code === STUDENT_CODE) ? 'student' : null;
        if (!roleToSet) {
            dom.authError.textContent = 'Invalid access code.';
            return;
        }
        try {
            // This Firestore path is crucial for the auth flow
            const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
            await setDoc(userProfileRef, { role: roleToSet, name: user.displayName }, { merge: true });
            showMainApp(user, roleToSet);
        } catch (e) {
            console.error("Failed to set role: ", e);
            dom.authError.textContent = 'Failed to save role. Please try again.';
        }
    }

    async function logout() {
        await signOut(auth);
        // This will trigger the onAuthStateChanged listener and show the login state
    }

    // --- App Entry Point ---
    document.addEventListener("DOMContentLoaded", () => {
        // --- Populate DOM object (Simplified) ---
        dom.authWrapper = document.getElementById('authWrapper');
        dom.authLoading = document.getElementById('authLoading');
        dom.authLogin = document.getElementById('authLogin');
        dom.authCode = document.getElementById('authCode');
        dom.authError = document.getElementById('authError');
        dom.googleSignInButton = document.getElementById('googleSignInButton');
        dom.accessCodeInput = document.getElementById('accessCodeInput');
        dom.submitCodeButton = document.getElementById('submitCodeButton');
        dom.mainContent = document.getElementById('mainContent');
        dom.displayName = document.getElementById('displayName');
        dom.userRole = document.getElementById('userRole');
        dom.logoutButton = document.getElementById('logoutButton');

        // Start the auth flow
        showLoadingState();

        // --- Auth State Change Listener (Exactly as before) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // This Firestore check is the core of the auth requirement
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                    const snap = await getDoc(userProfileRef);
                    if (snap.exists() && snap.data().role) {
                        // User is signed in AND has a role
                        showMainApp(user, snap.data().role);
                    } else {
                        // User is signed in but has NO role, needs code
                        showCodeInputState(user);
                    }
                } catch (e) {
                    console.error("Error fetching user profile: ", e);
                    dom.authError.textContent = "Error loading your profile.";
                    showLoginState(); // Fallback to login
                }
            } else {
                // User is not signed in
                showLoginState();
            }
        });
    });
  </script>

</body>
</html>

