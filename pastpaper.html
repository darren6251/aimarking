<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Marker - Past Papers</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js library for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <style>
        /* --- Inter Font (Default) --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- Custom Theme Configuration & Transitions --- */
        :root {
            --color-primary: #0a0a0a;
            --color-secondary: #1f2937; /* Tailwind gray-800 */
            --color-accent: #3b82f6;   /* Tailwind blue-500 */
            --color-text-primary: #f3f4f6;
            --color-text-secondary: #9ca3af;
            --color-card-bg: #111827; /* Tailwind gray-900 */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-primary);
            color: var(--color-text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Light Theme Overrides (For the theme toggle functionality) */
        .light-theme {
            --color-primary: #ffffff;
            --color-secondary: #f3f4f6;
            --color-accent: #1d4ed8;
            --color-text-primary: #1f2937;
            --color-text-secondary: #6b7280;
            --color-card-bg: #ffffff;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        
        .fade-in { animation: fadeIn 0.5s ease-out both; }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) both; }
        
        /* Specific Styles for PDF Viewer Modal */
        #pdfPreviewModal .modal-content {
            max-width: 95vw;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
        }
        #pdfCanvasContainer {
            overflow: auto;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background-color: #f3f4f6; /* Light background for the actual document area */
        }
        #pdfCanvas {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin: 10px;
        }
        
        /* Custom styles for Collapsible Teacher View */
        .nested-container {
            max-height: 0;
            transition: max-height 0.4s cubic-bezier(0, 1, 0, 1);
            overflow: hidden;
        }
        .nested-container.expanded {
            max-height: 10000px;
            transition: max-height 1s ease-in-out;
        }
        .collapse-arrow {
            transition: transform 0.3s ease;
        }
        .content-header[aria-expanded="true"] .collapse-arrow {
            transform: rotate(180deg);
        }

    </style>
</head>
<body class="dark-theme min-h-screen flex flex-col">

    <!-- Auth Wrapper - Fully Redesigned -->
    <div id="authWrapper" class="fixed inset-0 flex items-center justify-center bg-gray-900/90 backdrop-blur-sm z-[1001] transition-opacity duration-500" style="display: none; opacity: 0;">
        <div class="max-w-4xl w-full mx-4 flex bg-white/5 border border-gray-700 rounded-xl shadow-2xl overflow-hidden fade-in">
            <!-- Left Promo Panel -->
            <div class="hidden md:flex w-1/2 p-10 items-center justify-center bg-gray-800 text-center">
                <div>
                    <h1 class="text-5xl font-extrabold text-white mb-4">AI Marker</h1>
                    <p class="text-xl text-blue-300 font-light">Your pathway to educational excellence.</p>
                </div>
            </div>
            <!-- Right Login Panel -->
            <div class="w-full md:w-1/2 p-8 sm:p-12 flex flex-col justify-center bg-gray-900">
                <div id="authContainer" class="w-full">
                    <!-- Auth content injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Section -->
    <div id="appSection" class="flex flex-col min-h-screen" style="display: none;">
        
        <!-- Header -->
        <header class="sticky top-0 z-50 bg-gray-900/90 backdrop-blur-sm shadow-lg border-b border-gray-700 p-4 flex justify-between items-center transition duration-300">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold text-white">AI Marker</h1>
                <span class="text-sm text-gray-400 hidden sm:inline">Past Papers Hub</span>
            </div>
            
            <div class="flex items-center space-x-3">
                <a href="home.html" class="px-3 py-2 text-sm font-medium text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg transition duration-200">Home</a>
                
                <div class="relative group">
                    <button class="px-3 py-2 text-sm font-bold text-blue-400 bg-gray-800 rounded-lg transition duration-200 shadow-md ring-2 ring-blue-500/50">Materials</button>
                    <div class="absolute right-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-xl py-1 hidden group-hover:block transition duration-300 z-10">
                        <a href="tutorials.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Tutorial Videos</a>
                        <a href="pastpaper.html" class="block px-4 py-2 text-sm text-blue-400 font-semibold bg-gray-700/50 rounded-lg mx-1 my-1">Past Papers</a>
                        <a href="exercises.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Exercises for Sale</a>
                        <a href="lessonhistory.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Lesson History</a>
                    </div>
                </div>

                <button id="themeToggleButton" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full transition duration-200" title="Toggle Theme">
                    <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.75l-1.554 1.554M17.25 12h-2.25m4.364 6.364l-1.554-1.554M12 17.25v2.25m-6.364-.75l1.554-1.554M4.5 12h2.25m-4.364-6.364l1.554 1.554" /></svg>
                </button>

                <div class="flex items-center space-x-2 text-sm">
                     <span id="userDisplayName" class="font-medium text-gray-300"></span>
                     <button id="switchRoleButton" class="text-blue-400 hover:text-blue-300 transition duration-200 hover:scale-105" title="Switch Role">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>
                     </button>
                     <button id="logoutButton" class="p-1.5 text-red-400 hover:bg-red-500/20 rounded-full transition duration-200 hover:scale-105" title="Log Out">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3.75h-8.25A2.25 2.25 0 003 6v12c0 1.242.94 2.25 2.188 2.25h8.25A2.25 2.25 0 0013.5 18.75V15m1.5-3l-3-3m0 0l-3 3m3-3v12" /></svg>
                     </button>
                </div>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <main class="flex-1 p-6 md:p-10">
            <div id="pastPapersSection" class="w-full max-w-7xl mx-auto">
                <!-- Content will be rendered here based on role and selection -->
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="text-right p-3 text-xs text-gray-500 border-t border-gray-800">
            <span class="mr-4">Copyright © 2025 Operated by Darren Ng</span>
            <a href="mailto:darren_0625@mc-zero.com" class="hover:text-gray-300 transition duration-200">Contact: darren_0625@mc-zero.com</a>
        </footer>
    </div>

    <!-- Modals (Simple, accessible, styled with Tailwind) -->
    
    <!-- Generic Message/Input Modal -->
    <div id="messageModal" class="modal fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[2000] hidden items-center justify-center fade-in">
        <div class="modal-content bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700 w-full max-w-md pop-in">
            <h3 id="modalTitle" class="text-xl font-bold mb-4 text-white"></h3>
            <div id="modalMessage" class="text-gray-300"></div>
            <div id="modalButtons" class="flex justify-end space-x-3 mt-6"></div>
            <button class="close-button absolute top-3 right-3 text-gray-500 hover:text-white transition duration-200">&times;</button>
        </div>
    </div>
    
    <!-- PDF Preview Modal (Enhanced for better viewing) -->
    <div id="pdfPreviewModal" class="modal fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[2000] hidden items-center justify-center fade-in">
        <div class="modal-content bg-gray-800 rounded-xl shadow-2xl border border-gray-700 w-full h-full p-4 md:p-6 transition-all duration-300">
            <button class="close-button absolute top-4 right-4 z-50 p-2 bg-gray-700 hover:bg-gray-600 rounded-full text-white transition duration-200" title="Close">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h3 id="pdfPreviewTitle" class="text-lg font-semibold text-white text-center mb-3 flex-shrink-0"></h3>
            
            <div id="pdfCanvasContainer" class="rounded-lg mb-3">
                <div id="pdfLoader" class="text-gray-400 p-8 text-center text-lg hidden">Loading PDF...</div>
                <canvas id="pdfCanvas" class="shadow-xl"></canvas>
            </div>
            
            <div id="pdfControls" class="flex justify-center items-center space-x-4 flex-shrink-0">
                <button id="prevPdfPage" class="action-btn text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>
                </button>
                <div class="text-sm font-mono text-gray-300"><span id="pdfPageNum">1</span> / <span id="pdfTotalPages">1</span></div>
                <button id="nextPdfPage" class="action-btn text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" /></svg>
                </button>
                <a id="pdfDownloadLink" href="#" target="_blank" download class="action-btn flex items-center bg-green-600 hover:bg-green-700 text-sm font-semibold transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    Download
                </a>
            </div>
        </div>
    </div>
    
    <!-- Add Past Paper Modal (Teacher) -->
    <div id="addPastPaperModal" class="modal fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[2000] hidden items-center justify-center fade-in">
        <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-gray-700 w-full max-w-lg pop-in">
             <h3 class="text-2xl font-bold mb-6 text-white">Add New Past Paper</h3>
             <form id="addPastPaperForm">
                <input type="hidden" id="paperParentId1">
                <input type="hidden" id="paperParentId2">
                 
                 <div class="mb-4">
                     <label for="pastPaperName" class="block text-sm font-medium text-gray-400 mb-2">Paper Name / Title</label>
                     <input type="text" id="pastPaperName" required placeholder="e.g., Paper 1 Section A" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                 </div>
                 
                 <p class="text-sm font-medium text-gray-400 mb-2">Upload or Link PDF File</p>
                 <div class="mb-4 border border-dashed border-gray-600 p-4 rounded-lg bg-gray-700/50">
                    <div id="pastPaperDropZone" class="cursor-pointer text-center text-gray-400 hover:text-white transition duration-200 p-2">
                        <span>Drag & Drop PDF Here or click to select</span>
                        <input type="file" id="pastPaperFile" accept="application/pdf" hidden>
                    </div>
                    <p id="pastPaperFileName" class="text-xs text-gray-500 text-center mt-1">No file chosen</p>
                    
                    <div class="flex items-center my-3"><div class="flex-grow border-t border-gray-700"></div><span class="mx-2 text-xs text-gray-500">OR</span><div class="flex-grow border-t border-gray-700"></div></div>

                    <div>
                        <input type="url" id="pastPaperLink" placeholder="Paste External Download Link (for large files)" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                    </div>
                </div>

                 <div class="mt-6 text-right">
                    <button type="button" class="action-btn bg-gray-600 hover:bg-gray-700 mr-3" onclick="document.getElementById('addPastPaperModal').style.display = 'none'">Cancel</button>
                    <button type="submit" class="action-btn bg-blue-600 hover:bg-blue-700">Add Paper</button>
                 </div>
             </form>
             <button class="close-button absolute top-3 right-3 text-gray-500 hover:text-white transition duration-200">&times;</button>
        </div>
    </div>
    
    <!-- Edit Past Paper Modal (Teacher) -->
    <div id="editPastPaperModal" class="modal fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[2000] hidden items-center justify-center fade-in">
        <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-gray-700 w-full max-w-lg pop-in">
            <h3 class="text-2xl font-bold mb-6 text-white">Edit Past Paper</h3>
            <form id="editPastPaperForm">
                <input type="hidden" id="editPaperId">
                <input type="hidden" id="editPaperParentId1">
                <input type="hidden" id="editPaperParentId2">
                <div class="mb-4">
                    <label for="editPastPaperName" class="block text-sm font-medium text-gray-400 mb-2">Paper Name / Title</label>
                    <input type="text" id="editPastPaperName" required class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                </div>
                <div class="mb-6">
                    <label for="editPastPaperLink" class="block text-sm font-medium text-gray-400 mb-2">Download Link</label>
                    <input type="url" id="editPastPaperLink" required class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                </div>
                <div class="mt-6 text-right">
                    <button type="button" class="action-btn bg-gray-600 hover:bg-gray-700 mr-3" onclick="document.getElementById('editPastPaperModal').style.display = 'none'">Cancel</button>
                    <button type="submit" class="action-btn bg-blue-600 hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
            <button class="close-button absolute top-3 right-3 text-gray-500 hover:text-white transition duration-200">&times;</button>
        </div>
    </div>


    <script type="module">
        // Import Firebase modules - paths retained from original file
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, collection, query, where, orderBy, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";

        // Global Firebase Configuration (Retained from original file)
        const firebaseConfig = {
          apiKey: "AIzaSyBsJCaGD3ElBb_xQXd7pQgLBAgEwa2poKI",
          authDomain: "ai-grading-9bb30.firebaseapp.com",
          projectId: "ai-grading-9bb30",
          storageBucket: "ai-grading-9bb30.appspot.com",
          messagingSenderId: "298162112230",
          appId: "1:298162112230:web:529d3f95536991be685d27",
          measurementId: "G-CHKLKSM17S"
        };
        
        // PDF.js worker setup
        pdfjsLib.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // Global Variables (Retained from original file)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const TEACHER_CODE = "Derren0625";
        const STUDENT_CODE = "STUDENT456";

        let app, db, auth, storage;
        let currentUserId = null, currentUserRole = null, currentUserName = null;

        // UI Elements
        const authWrapper = document.getElementById('authWrapper');
        const appSection = document.getElementById('appSection');
        const authContainer = document.getElementById('authContainer');
        const pastPapersSection = document.getElementById('pastPapersSection');

        // State for Student View Navigation
        let selectedSubject = null;
        let selectedYear = null;

        // --- AUTH TEMPLATES (Styled with Tailwind) ---
        const googleSignInTemplate = `
            <h2 class="text-3xl font-extrabold text-white mb-6 text-center">Welcome Back</h2>
            <p id="authError" class="text-red-400 text-sm mb-4 text-center"></p>
            <button id="googleSignInButton" class="w-full flex items-center justify-center gap-3 p-3 bg-white text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-100 transition duration-200 transform hover:scale-[1.01] active:scale-95">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-5 h-5">
                <span>Sign in with Google</span>
            </button>
        `;
        const codeEntryTemplate = `
            <h2 class="text-3xl font-extrabold text-white mb-6 text-center">Enter Access Code</h2>
            <p class="text-gray-400 text-center mb-4">Please enter the security code to continue.</p>
            <input type="text" id="accessCodeInput" placeholder="Enter code" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg text-center mb-4 focus:ring-blue-500 focus:border-blue-500">
            <button id="submitCodeButton" class="w-full p-3 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition duration-200 transform hover:scale-[1.01] active:scale-95">Submit</button>
            <p id="codeError" class="text-red-400 text-sm mt-4 text-center"></p>
        `;

        // --- FIREBASE INITIALIZATION & AUTH ---
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
                const userProfileDoc = await getDoc(userProfileRef);
                if (userProfileDoc.exists() && userProfileDoc.data().role) {
                    const profileData = userProfileDoc.data();
                    currentUserRole = profileData.role;
                    currentUserName = profileData.name || user.displayName;
                    showApp();
                } else {
                    currentUserName = user.displayName;
                    currentUserRole = 'unassigned';
                    showCodeEntry();
                }
            } else {
                currentUserId = null;
                currentUserRole = null;
                currentUserName = null;
                showLogin();
            }
        });

        function showLogin() {
            appSection.style.display = 'none';
            authWrapper.style.display = 'flex';
            setTimeout(() => authWrapper.style.opacity = '1', 10);
            authContainer.innerHTML = googleSignInTemplate;
            document.getElementById('googleSignInButton')?.addEventListener('click', handleGoogleSignIn);
        }

        function showCodeEntry() {
            authContainer.innerHTML = codeEntryTemplate;
            document.getElementById('submitCodeButton')?.addEventListener('click', handleSubmitCode);
            document.getElementById('accessCodeInput')?.focus();
        }

        async function showApp() {
            authWrapper.style.display = 'none';
            appSection.style.display = 'flex';
            document.getElementById('userDisplayName').textContent = `${currentUserName} (${currentUserRole})`;
            setupPastPapersSection();
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (error) { console.error("Google Sign-In Error:", error); }
        }

        async function handleSubmitCode() {
            const code = document.getElementById('accessCodeInput').value.trim();
            const codeError = document.getElementById('codeError');
            let roleToSet = (code === TEACHER_CODE) ? 'teacher' : (code === STUDENT_CODE) ? 'student' : null;
            
            if (!roleToSet) {
                codeError.textContent = 'Invalid access code.';
                return;
            }
            
            const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/data`);
            await setDoc(userProfileRef, { role: roleToSet, name: currentUserName }, { merge: true });
            currentUserRole = roleToSet;
            showApp();
        }

        document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));
        document.getElementById('switchRoleButton').addEventListener('click', () => showCodeEntry());
        
        // --- MATERIAL CONFIGURATION (Retained from original file) ---
        const materialsConfig = {
            pastPapers: {
                collectionName: 'pastPapers',
                title: 'Past Papers',
                level1: 'Subject',
                level2: 'Year',
                level3: 'Paper',
                modalId: 'addPastPaperModal',
                editModalId: 'editPastPaperModal',
            }
        };

        // --- FIREBASE PATH HELPER (Retained from original file) ---
        function getPath(type, ids = []) {
            const config = materialsConfig[type];
            let pathParts = [`artifacts/${appId}/public/data/${config.collectionName}`];
            if (ids[0]) pathParts.push(ids[0], config.level2.toLowerCase() + 's');
            if (ids[1]) pathParts.push(ids[1], config.level3.toLowerCase() + 's');
            return pathParts.join('/');
        }
        
        // --- MAIN SECTION SETUP ---
        function setupPastPapersSection() {
            const isTeacher = currentUserRole === 'teacher';
            const type = 'pastPapers';
            
            pastPapersSection.innerHTML = `
                <h2 class="text-4xl font-extrabold mb-8 text-center text-white">${materialsConfig[type].title}</h2>
                <div id="teacher-view" class="${isTeacher ? 'block' : 'hidden'}">
                    <div class="bg-gray-800 p-5 rounded-xl mb-8 flex flex-wrap gap-4 items-center justify-between shadow-xl">
                        <h3 class="text-xl font-semibold text-gray-300">Content Management Panel</h3>
                        <button id="add-level1-btn" class="action-btn bg-blue-600 hover:bg-blue-700">Add New Subject</button>
                    </div>
                    <div id="level1-container" class="space-y-4"></div>
                </div>
                
                <div id="student-view" class="${!isTeacher ? 'block' : 'hidden'}">
                    <div id="student-breadcrumb" class="mb-6 flex items-center space-x-2 text-sm text-gray-400">
                        <button onclick="resetStudentView()" class="hover:text-white transition duration-200">Subjects</button>
                        <span id="breadcrumb-separator1" class="${selectedSubject ? 'inline' : 'hidden'}">/</span>
                        <button id="breadcrumb-subject" class="${selectedSubject ? 'text-white font-semibold' : 'hidden'}" onclick="backToSubjects()"></button>
                        <span id="breadcrumb-separator2" class="${selectedYear ? 'inline' : 'hidden'}">/</span>
                        <span id="breadcrumb-year" class="${selectedYear ? 'text-blue-400 font-semibold' : 'hidden'}"></span>
                    </div>
                    <div id="student-content-container" class="min-h-[500px]">
                        <div id="subject-cards" class="${selectedSubject ? 'hidden' : 'block'} grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 fade-in"></div>
                        <div id="year-tiles" class="${(selectedSubject && !selectedYear) ? 'block' : 'hidden'} fade-in"></div>
                        <div id="paper-grid" class="${selectedYear ? 'block' : 'hidden'} grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 fade-in"></div>
                    </div>
                </div>
            `;
            
            if (isTeacher) {
                renderTeacherContent(type, 'level1-container', 1);
                document.getElementById('add-level1-btn').onclick = () => showAddItemModal(type, 1);
                document.getElementById('level1-container').addEventListener('click', (e) => handleTeacherClick(e, type));
            } else {
                renderStudentView(type);
            }
        }
        
        // --- STUDENT VIEW NAVIGATION & RENDERING (Animated & Interactive) ---
        function updateBreadcrumb() {
            const breadcrumbSubject = document.getElementById('breadcrumb-subject');
            const breadcrumbYear = document.getElementById('breadcrumb-year');
            const separator1 = document.getElementById('breadcrumb-separator1');
            const separator2 = document.getElementById('breadcrumb-separator2');

            breadcrumbSubject.textContent = selectedSubject ? selectedSubject.name : '';
            breadcrumbYear.textContent = selectedYear ? selectedYear.name : '';
            
            breadcrumbSubject.className = selectedSubject ? 'text-white font-semibold hover:text-blue-400 transition duration-200' : 'hidden';
            breadcrumbYear.className = selectedYear ? 'text-blue-400 font-semibold' : 'hidden';
            separator1.className = selectedSubject ? 'inline' : 'hidden';
            separator2.className = selectedYear ? 'inline' : 'hidden';
        }

        function backToSubjects() {
            selectedSubject = null;
            selectedYear = null;
            renderStudentView('pastPapers');
        }

        function renderStudentView(type) {
            updateBreadcrumb();
            const subjectCards = document.getElementById('subject-cards');
            const yearTiles = document.getElementById('year-tiles');
            const paperGrid = document.getElementById('paper-grid');
            
            subjectCards.classList.toggle('hidden', selectedSubject !== null);
            yearTiles.classList.toggle('hidden', selectedSubject === null || selectedYear !== null);
            paperGrid.classList.toggle('hidden', selectedYear === null);

            if (!selectedSubject) {
                renderSubjectCards(type);
            } else if (selectedSubject && !selectedYear) {
                renderYearTiles(type, selectedSubject.id);
            } else if (selectedYear) {
                renderPaperGrid(type, selectedSubject.id, selectedYear.id);
            }
        }

        async function renderSubjectCards(type) {
            const container = document.getElementById('subject-cards');
            container.innerHTML = `<p class="col-span-4 text-center text-gray-400 p-8">Loading Subjects...</p>`;
            
            const collectionRef = collection(db, getPath(type));
            const q = query(collectionRef, orderBy('name', 'asc'));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) { container.innerHTML = `<p class="col-span-4 text-center text-gray-400 p-8">No subjects available.</p>`; return; }
            
            container.innerHTML = '';
            snapshot.forEach(doc => {
                const item = { id: doc.id, ...doc.data() };
                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 cursor-pointer hover:bg-gray-700 transition duration-300 transform hover:scale-[1.03] pop-in';
                card.style.animationDelay = `${Math.random() * 0.15}s`;
                card.innerHTML = `<h3 class="text-xl font-bold text-white">${item.name}</h3><p class="text-gray-400 mt-2">Explore papers by year.</p>`;
                card.onclick = () => {
                    selectedSubject = item;
                    selectedYear = null;
                    renderStudentView(type);
                };
                container.appendChild(card);
            });
        }

        async function renderYearTiles(type, subjectId) {
            const container = document.getElementById('year-tiles');
            container.innerHTML = `<h3 class="text-2xl font-bold mb-6 text-white">${selectedSubject.name} - Select Year</h3><p class="text-gray-400 mb-6">Click a year to view available papers.</p><div id="year-tile-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>`;
            const tileGrid = document.getElementById('year-tile-grid');
            
            const collectionRef = collection(db, getPath(type, [subjectId]));
            const q = query(collectionRef, orderBy('name', 'desc')); // Years typically ordered descending
            const snapshot = await getDocs(q);

            if (snapshot.empty) { tileGrid.innerHTML = `<p class="col-span-6 text-center text-gray-400 p-8">No years available for this subject.</p>`; return; }
            
            snapshot.forEach(doc => {
                const item = { id: doc.id, ...doc.data() };
                const tile = document.createElement('button');
                tile.className = 'bg-gray-700 text-white p-4 rounded-lg font-bold text-xl hover:bg-blue-600 transition duration-300 transform hover:scale-[1.05] pop-in';
                tile.style.animationDelay = `${Math.random() * 0.1}s`;
                tile.textContent = item.name;
                tile.onclick = () => {
                    selectedYear = item;
                    renderStudentView(type);
                };
                tileGrid.appendChild(tile);
            });
        }
        
        async function renderPaperGrid(type, subjectId, yearId) {
            const container = document.getElementById('paper-grid');
            container.innerHTML = `<p class="col-span-4 text-center text-gray-400 p-8">Loading Papers...</p>`;

            const itemsRef = collection(db, getPath(type, [subjectId, yearId]));
            const q = query(itemsRef, orderBy('name', 'asc'));
            
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) { container.innerHTML = `<p class="col-span-4 text-center text-gray-400 p-8">No papers found for ${selectedYear.name}.</p>`; return; }
            
            container.innerHTML = '';
            snapshot.forEach(doc => {
                const item = { id: doc.id, ...doc.data() };
                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-5 rounded-xl shadow-md border border-gray-700 flex flex-col justify-between cursor-pointer hover:shadow-lg hover:border-blue-500 transition duration-300 transform hover:scale-[1.02] pop-in';
                card.style.animationDelay = `${Math.random() * 0.15}s`;
                card.onclick = () => handlePreview(type, item);
                card.innerHTML = `
                    <h3 class="text-lg font-semibold text-white mb-1">${item.name}</h3>
                    <p class="text-xs text-gray-500">Click to preview PDF</p>
                `;
                container.appendChild(card);
            });
        }
        
        // --- TEACHER VIEW RENDERING & LOGIC (Cleaned up) ---
        async function renderTeacherContent(type, containerId, level, parentIds = []) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const config = materialsConfig[type];
            const levelName = config[`level${level}`];
            container.innerHTML = `<p class="text-center text-gray-400 p-4">Loading ${levelName}s...</p>`;

            const collectionRef = collection(db, getPath(type, parentIds));
            // Ensure proper ordering for Years (desc) vs Subjects (asc)
            const q = query(collectionRef, orderBy('name', levelName === 'Year' ? 'desc' : 'asc')); 
            
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                container.innerHTML = `<p class="text-center text-gray-400 p-4">No ${levelName.toLowerCase()}s added yet.</p>`;
                return;
            }
            
            container.innerHTML = '';
            snapshot.forEach(doc => {
                const item = { id: doc.id, ...doc.data() };
                const el = document.createElement('div');
                el.className = level < 3 ? 'bg-gray-800 rounded-xl shadow-md border border-gray-700 overflow-hidden' : 'flex justify-between items-center p-3 hover:bg-gray-700/50 rounded-lg transition duration-200';

                let html;
                if (level < 3) {
                    const nextLevel = level + 1;
                    const newParentIds = [...parentIds, doc.id];
                    html = `
                        <div class="content-header flex justify-between items-center p-4 cursor-pointer hover:bg-gray-700 transition duration-200" data-level="${level}" data-id="${doc.id}" data-parent-ids='${JSON.stringify(parentIds)}' aria-expanded="false">
                            <h3 class="text-lg font-semibold text-white">${item.name} <span class="text-gray-400 transition duration-300 ml-2 collapse-arrow">▼</span></h3>
                            <div class="item-actions flex space-x-2 flex-shrink-0">
                                <button class="add-item-btn action-btn bg-blue-600 hover:bg-blue-700 text-xs py-1 px-3" data-level="${nextLevel}" data-parent-ids='${JSON.stringify(newParentIds)}'>Add ${config[`level${nextLevel}`]}</button>
                                <button class="delete-item-btn action-btn bg-red-600 hover:bg-red-700 text-xs py-1 px-3" data-level="${level}" data-id="${doc.id}" data-parent-ids='${JSON.stringify(parentIds)}'>Delete</button>
                            </div>
                        </div>
                        <div class="nested-container p-2 space-y-2" id="container-level${nextLevel}-${type}-${doc.id}"></div>
                    `;
                } else {
                    html = `
                        <span class="text-base text-gray-300">${item.name}</span>
                        <div class="item-actions flex space-x-2">
                            <button class="edit-item-btn action-btn bg-gray-600 hover:bg-gray-700 text-xs py-1 px-3" data-item='${JSON.stringify(item)}' data-parent-ids='${JSON.stringify(parentIds)}'>Edit</button>
                            <button class="preview-item-btn action-btn bg-green-600 hover:bg-green-700 text-xs py-1 px-3" data-item='${JSON.stringify(item)}'>Preview</button>
                            <button class="delete-item-btn action-btn bg-red-600 hover:bg-red-700 text-xs py-1 px-3" data-level="${level}" data-id="${doc.id}" data-parent-ids='${JSON.stringify(parentIds)}'>Delete</button>
                        </div>
                    `;
                }
                el.innerHTML = html;
                container.appendChild(el);
            });
        }
        
        function handleTeacherClick(e, type) {
            const header = e.target.closest('.content-header');
            const button = e.target.closest('button');

            if (button) {
                e.stopPropagation();
                const parentIds = JSON.parse(button.dataset.parentIds || '[]');
                if (button.matches('.add-item-btn')) {
                    const nextLevel = parseInt(button.dataset.level);
                    if (nextLevel < 3) showAddItemModal(type, nextLevel, parentIds);
                    else showAddFinalItemModal(type, parentIds);
                } else if (button.matches('.delete-item-btn')) {
                    handleDeleteItem(type, parseInt(button.dataset.level), button.dataset.id, parentIds);
                } else if (button.matches('.preview-item-btn')) {
                    handlePreview(type, JSON.parse(button.dataset.item));
                } else if (button.matches('.edit-item-btn')) {
                    showEditPastPaperModal(JSON.parse(button.dataset.item), parentIds);
                }
            } else if (header) {
                const { level, id, parentIds } = header.dataset;
                const container = document.getElementById(`container-level${parseInt(level) + 1}-${type}-${id}`);
                const isExpanded = header.getAttribute('aria-expanded') === 'true';
                header.setAttribute('aria-expanded', !isExpanded);
                container.classList.toggle('expanded', !isExpanded);
                
                if (!isExpanded && !container.dataset.loaded) {
                    renderTeacherContent(type, container.id, parseInt(level) + 1, [...JSON.parse(parentIds), id]);
                    container.dataset.loaded = 'true';
                }
            }
        }
        
        // --- MODAL & FORM LOGIC (Styled with Tailwind) ---
        function showInputModal(title, label, callback) {
            showModal(title, `<label class="block text-sm font-medium text-gray-400 mb-2">${label}</label><input type="text" id="modalInput" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">`, [
                { text: 'Cancel', className: 'action-btn bg-gray-600 hover:bg-gray-700' },
                { text: 'Save', className: 'action-btn bg-blue-600 hover:bg-blue-700', onClick: () => callback(document.getElementById('modalInput').value) }
            ]);
            setTimeout(() => document.getElementById('modalInput').focus(), 100);
        }

        function showAddItemModal(type, level, parentIds = []) {
            const config = materialsConfig[type];
            const levelName = config[`level${level}`];
            showInputModal(`Add New ${levelName}`, `Enter ${levelName} Name:`, async (name) => {
                if (!name || name.trim() === '') return;
                const collectionRef = collection(db, getPath(type, parentIds));
                await addDoc(collectionRef, { name: name.trim() });
                const containerId = level === 1 ? `level1-container` : `container-level${level}-${type}-${parentIds[parentIds.length - 1]}`;
                renderTeacherContent(type, containerId, level, parentIds);
            });
        }

        function showAddFinalItemModal(type, parentIds) {
            const config = materialsConfig[type];
            const modal = document.getElementById(config.modalId);
            modal.style.display = 'flex';
            const form = modal.querySelector('form');
            form.querySelector('#paperParentId1').value = parentIds[0];
            form.querySelector('#paperParentId2').value = parentIds[1];
            form.reset();
            document.getElementById('pastPaperFileName').textContent = 'No file chosen';
        }

        document.getElementById('addPastPaperForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const parentId1 = e.target.querySelector('#paperParentId1').value;
            const parentId2 = e.target.querySelector('#paperParentId2').value;
            const name = document.getElementById('pastPaperName').value;
            const file = document.getElementById('pastPaperFile').files[0];
            let link = document.getElementById('pastPaperLink').value.trim();

            if (!name.trim() || (!file && !link)) {
                return showModal('Input Error', 'Please provide a paper name and either upload a PDF or paste a link.');
            }
            
            const submitBtn = e.target.querySelector('button[type=submit]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            try {
                let downloadURL = link;
                let filePath = '';
                if (file) {
                    filePath = `materials/past-papers/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, filePath);
                    const uploadResult = await uploadBytes(storageRef, file);
                    downloadURL = await getDownloadURL(uploadResult.ref);
                }
                
                const collectionRef = collection(db, getPath('pastPapers', [parentId1, parentId2]));
                await addDoc(collectionRef, { name: name.trim(), link: downloadURL, filePath, timestamp: Date.now() });
                
                document.getElementById('addPastPaperModal').style.display = 'none';
                renderTeacherContent('pastPapers', `container-level3-pastPapers-${parentId2}`, 3, [parentId1, parentId2]);
            } catch (error) { 
                console.error(error);
                showModal('Error', `Could not add paper: ${error.message}`); 
            } finally {
                 submitBtn.disabled = false;
                 submitBtn.textContent = originalText;
            }
        });

        function showEditPastPaperModal(item, parentIds) {
            const modal = document.getElementById('editPastPaperModal');
            modal.style.display = 'flex';
            document.getElementById('editPaperId').value = item.id;
            document.getElementById('editPaperParentId1').value = parentIds[0];
            document.getElementById('editPaperParentId2').value = parentIds[1];
            document.getElementById('editPastPaperName').value = item.name;
            document.getElementById('editPastPaperLink').value = item.link;
        }

        document.getElementById('editPastPaperForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const parentId1 = e.target.querySelector('#editPaperParentId1').value;
            const parentId2 = e.target.querySelector('#editPaperParentId2').value;
            const itemId = document.getElementById('editPaperId').value;
            const name = document.getElementById('editPastPaperName').value.trim();
            const link = document.getElementById('editPastPaperLink').value.trim();

            const submitBtn = e.target.querySelector('button[type=submit]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                const docRef = doc(db, getPath('pastPapers', [parentId1, parentId2]), itemId);
                await updateDoc(docRef, { name, link });
                
                document.getElementById('editPastPaperModal').style.display = 'none';
                // Re-render the level 3 container (papers)
                renderTeacherContent('pastPapers', `container-level3-pastPapers-${parentId2}`, 3, [parentId1, parentId2]);
            } catch (error) {
                console.error(error);
                showModal('Error', `Could not update paper: ${error.message}`); 
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });


        async function handleDeleteItem(type, level, id, parentIds) {
            const levelName = materialsConfig[type][`level${level}`];
            showModal('Confirm Deletion', `<p class="text-gray-300">Are you sure you want to delete this ${levelName.toLowerCase()}? This action cannot be undone and will delete all nested items.</p>`, [
                { text: 'Delete Permanently', className: 'action-btn bg-red-600 hover:bg-red-700', onClick: async () => {
                    const docRef = doc(db, getPath(type, parentIds), id);
                    await deleteDoc(docRef);
                    // Re-render the relevant parent container
                    const containerId = level === 1 ? `level1-container` : `container-level${level}-${type}-${parentIds[parentIds.length - 1]}`;
                    renderTeacherContent(type, containerId, level, parentIds);
                }},
                { text: 'Cancel', className: 'action-btn bg-gray-600 hover:bg-gray-700' }
            ]);
        }
        
        function handlePreview(type, item) {
            if (item.link) {
                showPdfPreviewModal(item.name, item.link);
            } else {
                showModal('Preview Error', 'No download link available for this paper. Please check the file management section.');
            }
        }

        // --- PDF PREVIEW LOGIC (Retained and Enhanced) ---
        let pdfDoc = null, pageNum = 1, pageRendering = false, pageNumPending = null;
        const pdfCanvas = document.getElementById('pdfCanvas');
        const pdfContext = pdfCanvas.getContext('2d');
        const pdfLoader = document.getElementById('pdfLoader');
        const pdfDownloadLink = document.getElementById('pdfDownloadLink');

        async function showPdfPreviewModal(title, pdfUrl) {
            document.getElementById('pdfPreviewTitle').textContent = title;
            document.getElementById('pdfPreviewModal').style.display = 'flex';
            
            pdfDoc = null;
            pdfCanvas.style.display = 'none';
            pdfLoader.style.display = 'block';
            pdfLoader.textContent = 'Loading PDF...';
            pdfDownloadLink.href = pdfUrl;

            try {
                // Use the proxy to avoid CORS issues with certain external links
                const proxiedUrl = `https://corsproxy.io/?${encodeURIComponent(pdfUrl)}`;
                
                const loadingTask = pdfjsLib.getDocument(proxiedUrl);
                pdfDoc = await loadingTask.promise;
                
                document.getElementById('pdfTotalPages').textContent = pdfDoc.numPages;
                pageNum = 1;
                
                pdfLoader.style.display = 'none';
                pdfCanvas.style.display = 'block';
                
                renderPage(pageNum);
            } catch (error) {
                console.error('Error loading PDF:', error);
                pdfLoader.textContent = 'Failed to load PDF preview. Ensure the link is direct to a PDF. You can still use the Download button.';
                pdfCanvas.style.display = 'none';
                document.getElementById('pdfTotalPages').textContent = 0;
                document.getElementById('pdfPageNum').textContent = 0;
            }
        }

        function renderPage(num) {
            pageRendering = true;
            document.getElementById('prevPdfPage').disabled = true;
            document.getElementById('nextPdfPage').disabled = true;

            if (!pdfDoc) return;

            pdfDoc.getPage(num).then(page => {
                const containerWidth = document.getElementById('pdfCanvasContainer').clientWidth;
                // Calculate scale to fit width while maintaining aspect ratio
                const viewport = page.getViewport({ scale: 1.0 });
                const scale = containerWidth / viewport.width;
                const scaledViewport = page.getViewport({ scale: scale });

                pdfCanvas.height = scaledViewport.height;
                pdfCanvas.width = scaledViewport.width;
                
                const renderContext = {
                    canvasContext: pdfContext,
                    viewport: scaledViewport
                };
                
                const renderTask = page.render(renderContext);
                renderTask.promise.then(() => {
                    pageRendering = false;
                    document.getElementById('prevPdfPage').disabled = pageNum <= 1;
                    document.getElementById('nextPdfPage').disabled = pageNum >= pdfDoc.numPages;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });
            document.getElementById('pdfPageNum').textContent = num;
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        document.getElementById('prevPdfPage').addEventListener('click', () => {
            if (!pdfDoc || pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        });

        document.getElementById('nextPdfPage').addEventListener('click', () => {
            if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        });

        // Re-render PDF on window resize to ensure responsiveness
        window.addEventListener('resize', () => {
             if (pdfDoc && document.getElementById('pdfPreviewModal').style.display === 'flex') {
                 queueRenderPage(pageNum);
             }
        });


        // --- UTILITY & HELPER FUNCTIONS ---
        function setupDropZone(dropZoneId, fileInputId, fileNameDisplayId) {
            const dropZone = document.getElementById(dropZoneId), fileInput = document.getElementById(fileInputId), fileNameDisplay = document.getElementById(fileNameDisplayId);
            if (!dropZone || !fileInput || !fileNameDisplay) return;
            dropZone.onclick = () => fileInput.click();
            dropZone.ondragover = dropZone.ondragenter = (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-blue-500/10'); };
            dropZone.ondragleave = dropZone.ondrop = () => dropZone.classList.remove('border-blue-500', 'bg-blue-500/10');
            dropZone.ondrop = (e) => { e.preventDefault(); fileInput.files = e.dataTransfer.files; fileInput.dispatchEvent(new Event('change')); };
            fileInput.onchange = () => { 
                fileNameDisplay.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : 'No file chosen'; 
                // Clear the link input if a file is chosen
                if (fileInput.files.length > 0) {
                    document.getElementById('pastPaperLink').value = '';
                }
            };
            document.getElementById('pastPaperLink').oninput = () => {
                 // Clear the file input if a link is typed
                 if (document.getElementById('pastPaperLink').value.trim() !== '') {
                    fileInput.value = null; // Clears the file input
                    fileNameDisplay.textContent = 'Using external link';
                 } else {
                     fileNameDisplay.textContent = 'No file chosen';
                 }
            }
        }
        setupDropZone('pastPaperDropZone', 'pastPaperFile', 'pastPaperFileName');

        function showModal(title, message, buttons = []) {
            const modal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = '';
            
            if (buttons.length === 0) {
                 const okBtn = document.createElement('button');
                 okBtn.textContent = 'OK';
                 okBtn.className = 'action-btn bg-blue-600 hover:bg-blue-700';
                 okBtn.onclick = () => modal.style.display = 'none';
                 modalButtons.appendChild(okBtn);
            } else {
                 buttons.forEach(c => {
                    const btn = document.createElement('button');
                    btn.textContent = c.text;
                    btn.className = c.className + ' transition duration-200'; 
                    btn.onclick = () => { modal.style.display = 'none'; if (c.onClick) c.onClick(); };
                    modalButtons.appendChild(btn);
                });
            }
            modal.style.display = 'flex';
        }
        
        document.querySelectorAll('.modal .close-button').forEach(btn => btn.onclick = () => btn.closest('.modal').style.display = 'none');

        // General button styling class for consistency
        document.querySelectorAll('.action-btn').forEach(btn => {
            if (!btn.classList.contains('py-1')) {
                btn.classList.add('px-4', 'py-2', 'rounded-lg', 'font-semibold', 'text-white', 'transition', 'duration-200', 'transform', 'hover:scale-[1.03]', 'active:scale-95');
            }
        });


        // Theme Toggle Logic
        const themeToggleButton = document.getElementById('themeToggleButton');
        const themeIcon = document.getElementById('themeIcon');
        
        function applyTheme(theme) { 
            const isLight = theme === 'light';
            document.body.classList.toggle('light-theme', isLight); 
            // Update Icon
            themeIcon.innerHTML = isLight 
                ? '<path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.75l-1.554 1.554M17.25 12h-2.25m4.364 6.364l-1.554-1.554M12 17.25v2.25m-6.364-.75l1.554-1.554M4.5 12h2.25m-4.364-6.364l1.554 1.554" />' 
                : '<path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0115.75 21.75c-4.223 0-7.784-2.148-9.088-5.116M19.349 7.001A9.718 9.718 0 0015.75 2.25c-4.223 0-7.784 2.148-9.088 5.116M12 18V6" />';
        }
        
        function loadTheme() { 
            applyTheme(localStorage.getItem('ai-marker-theme') || 'dark'); 
        }
        
        themeToggleButton.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('ai-marker-theme', newTheme);
        });
        loadTheme();
        
        window.addEventListener('load', () => document.getElementById('authWrapper').style.opacity = '1');
    </script>
</body>
</html>
